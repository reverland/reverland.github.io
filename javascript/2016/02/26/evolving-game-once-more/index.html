<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Evolving Game Once More | Reverland的行知阁</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="canvas,javascript,webgl," />
  

  <meta name="description" content="这里的第一篇文章标示的日期是2012年2月7日，到今天，眨眼间4年多过去了。没想到竟然断断续续写了四年。
感谢vimwiki，感谢jekyll，感谢hexo，感谢开源社区和贡献者们。
感谢bitbucket，感谢github，感谢gitcafe，感谢凤凰君曾经的嗯静态博客托管。
感谢每一个鼓励的朋友。
竟然四年了。去年想就这么算了吧，域名也没续费。结果服务商凤凰君给设置自动续费了，现在域名才继续能">
<meta property="og:type" content="article">
<meta property="og:title" content="Evolving Game Once More">
<meta property="og:url" content="http://reverland.org/javascript/2016/02/26/evolving-game-once-more/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="这里的第一篇文章标示的日期是2012年2月7日，到今天，眨眼间4年多过去了。没想到竟然断断续续写了四年。
感谢vimwiki，感谢jekyll，感谢hexo，感谢开源社区和贡献者们。
感谢bitbucket，感谢github，感谢gitcafe，感谢凤凰君曾经的嗯静态博客托管。
感谢每一个鼓励的朋友。
竟然四年了。去年想就这么算了吧，域名也没续费。结果服务商凤凰君给设置自动续费了，现在域名才继续能">
<meta property="og:image" content="http://img.vim-cn.com/b1/109b70f577066d82883688bef88cdb59d337b1.gif">
<meta property="og:image" content="http://img.vim-cn.com/22/7fc0abccc74290dce1eb72a1bfba4f066f20c4.gif">
<meta property="og:image" content="http://img.vim-cn.com/d1/05a775e6f58573966fa4693d21056d6ce133e6.gif">
<meta property="og:image" content="http://img.vim-cn.com/08/d056d8ad19af2755c9bada138cced2046d69ab.gif">
<meta property="og:image" content="http://img.vim-cn.com/8d/d346f93ee3ad8163e4390bf64c02ada9c768db.gif">
<meta property="og:updated_time" content="2016-03-07T08:22:42.582Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Evolving Game Once More">
<meta name="twitter:description" content="这里的第一篇文章标示的日期是2012年2月7日，到今天，眨眼间4年多过去了。没想到竟然断断续续写了四年。
感谢vimwiki，感谢jekyll，感谢hexo，感谢开源社区和贡献者们。
感谢bitbucket，感谢github，感谢gitcafe，感谢凤凰君曾经的嗯静态博客托管。
感谢每一个鼓励的朋友。
竟然四年了。去年想就这么算了吧，域名也没续费。结果服务商凤凰君给设置自动续费了，现在域名才继续能">

  

  
    <link rel="icon" href="/images/favicon.ico">
  

  

  <link href="/css/styles.css?v=ed12202f" rel="stylesheet">

  

  

</head>

<body>

  
    <a href="#modal-one" class="toolbox-mobile">盒子</a>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/atom.xml"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#A_GAME"><span class="toc-text">A GAME</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图形界面"><span class="toc-text">图形界面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Terminal_Animation"><span class="toc-text">Terminal Animation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM_Animation"><span class="toc-text">DOM Animation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canvas_Animation"><span class="toc-text">Canvas Animation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGL_Animation"><span class="toc-text">WebGL Animation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能与瞎想"><span class="toc-text">性能与瞎想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#More?"><span class="toc-text">More?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Have_Fun_With_it"><span class="toc-text">Have Fun With it</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-evolving-game-once-more" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Evolving Game Once More</h1>

    <div class="article-meta">
      <span>2016-02-26</span>

      <span> | </span>

      <span class="article-author">Liu Yuyang</span>

      <span> | </span>

      
  <span class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </span>


    </div>
  </header>

  <div class="article-content">
    
      <p>这里的第一篇文章标示的日期是2012年2月7日，到今天，眨眼间4年多过去了。没想到竟然断断续续写了四年。</p>
<p>感谢vimwiki，感谢jekyll，感谢hexo，感谢开源社区和贡献者们。</p>
<p>感谢bitbucket，感谢github，感谢gitcafe，感谢凤凰君曾经的嗯静态博客托管。</p>
<p>感谢每一个鼓励的朋友。</p>
<p>竟然四年了。去年想就这么算了吧，域名也没续费。结果服务商凤凰君给设置自动续费了，现在域名才继续能用。。</p>
<p>开始正题吧。</p>
<p>希望在这里写下的每篇文章，简单而快乐。</p>
<h2 id="A_GAME">A GAME</h2><p>我编程的入门从一本叫Land of Lisp的书开始，这里给我揭开了web server的迷雾，揭开了socket的迷雾，揭开了svg的迷雾，甚至揭开了AI的迷雾。</p>
<p>这本书中有一个模拟自然界的小游戏<a href="http://reverland.org/lisp/2012/05/06/using-loop-to-evolve/">使用loop来进化</a>。</p>
<p>一个非常简单但非常有意思的游戏，我还记得为了想要更大的世界，让cpu和io卡顿异常的记忆。</p>
<p>多年以后，看到有本叫eloquent javascript的书中有另外一个类似的例子<a href="http://eloquentjavascript.net/07_elife.html" target="_blank" rel="external">电子生命</a>。</p>
<p>我就想说这个游戏。</p>
<h2 id="图形界面">图形界面</h2><p>感谢Marijn Haverbeke，面向对象带来了非常好的组件化效果，随便加个函数就实现了图形界面的变更。</p>
<p>我这里将实现4种界面：</p>
<ul>
<li>terminal</li>
<li>dom</li>
<li>canvas</li>
<li>webGL</li>
</ul>
<p>首先，world类的constructor需要根据准备画布，如果试canvas或者webgl还要做好调整和准备工作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * class World</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">World</span> </span>&#123;</span><br><span class="line">  constructor(map, legend, canvas, canvasLegend, size, flag) &#123;</span><br><span class="line">    <span class="keyword">this</span>.grid = <span class="keyword">new</span> Grid(map[<span class="number">0</span>].length, map.length);</span><br><span class="line">    <span class="keyword">this</span>.legend = legend;</span><br><span class="line">    <span class="keyword">if</span> (canvas) &#123;</span><br><span class="line">      <span class="comment">//canvas</span></span><br><span class="line">      <span class="keyword">this</span>._canvasLegend = canvasLegend;</span><br><span class="line">      <span class="keyword">this</span>._canvas = canvas;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>._canvas.width = map[<span class="number">0</span>].length * size;</span><br><span class="line">      <span class="keyword">this</span>._canvas.height = map.length * size;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>._size = size;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flag == <span class="string">'dom'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>._canvas.style.width = <span class="keyword">this</span>._canvas.width + <span class="string">'px'</span>;</span><br><span class="line">        <span class="keyword">this</span>._canvas.style.height = <span class="keyword">this</span>._canvas.height + <span class="string">'px'</span>;</span><br><span class="line">        <span class="keyword">this</span>.draw = <span class="keyword">this</span>.drawDom;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flag == <span class="string">'canvas'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>._ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">        <span class="keyword">this</span>.draw = <span class="keyword">this</span>.drawCanvas;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flag == <span class="string">'webgl'</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> gl = canvas.getContext(<span class="string">'webgl'</span>);</span><br><span class="line">        <span class="keyword">this</span>._gl = gl;</span><br><span class="line">        gl.clearColor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1.0</span>);</span><br><span class="line">        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br><span class="line">        gl.viewport(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>._canvas.width, <span class="keyword">this</span>._canvas.height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> v = <span class="string">`</span><br><span class="line">        //这部分是顶点着色器  </span><br><span class="line">        attribute vec2 aVertexPosition;</span><br><span class="line">        void main() &#123;</span><br><span class="line">            gl_Position = vec4(aVertexPosition, 0.0, 1.0);</span><br><span class="line">        &#125;</span><br><span class="line">        `</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> f = <span class="string">`</span><br><span class="line">        //这部分是片段着色器  </span><br><span class="line">        precision highp float;</span><br><span class="line"></span><br><span class="line">        uniform vec4 uColor;</span><br><span class="line"></span><br><span class="line">        void main() &#123;</span><br><span class="line">           gl_FragColor = uColor;</span><br><span class="line">        &#125;</span><br><span class="line">        `</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> vs = gl.createShader(gl.VERTEX_SHADER);</span><br><span class="line">        gl.shaderSource(vs, v);</span><br><span class="line">        gl.compileShader(vs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fs = gl.createShader(gl.FRAGMENT_SHADER);</span><br><span class="line">        gl.shaderSource(fs, f);</span><br><span class="line">        gl.compileShader(fs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.program = gl.createProgram();</span><br><span class="line">        gl.attachShader(<span class="keyword">this</span>.program, vs);</span><br><span class="line">        gl.attachShader(<span class="keyword">this</span>.program, fs);</span><br><span class="line">        gl.linkProgram(<span class="keyword">this</span>.program);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// debugging</span></span><br><span class="line">        <span class="keyword">if</span> (!gl.getShaderParameter(vs, gl.COMPILE_STATUS))</span><br><span class="line">          <span class="built_in">console</span>.log(gl.getShaderInfoLog(vs));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gl.getShaderParameter(fs, gl.COMPILE_STATUS))</span><br><span class="line">          <span class="built_in">console</span>.log(gl.getShaderInfoLog(fs));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gl.getProgramParameter(<span class="keyword">this</span>.program, gl.LINK_STATUS))</span><br><span class="line">          <span class="built_in">console</span>.log(gl.getProgramInfoLog(<span class="keyword">this</span>.program));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.draw = <span class="keyword">this</span>.drawWebGL;</span><br><span class="line"></span><br><span class="line">        gl.useProgram(<span class="keyword">this</span>.program);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (canvasLegend) &#123;</span><br><span class="line">      <span class="keyword">this</span>._canvasLegend = canvasLegend;</span><br><span class="line">      <span class="keyword">this</span>.draw = <span class="keyword">this</span>.drawTerminal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">    map.forEach(((line, y) =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; line.length; x++) &#123;</span><br><span class="line">        <span class="keyword">this</span>.grid.set(<span class="keyword">new</span> Vector(x, y),</span><br><span class="line">                      elementFromChar(legend, line[x]));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).bind(self));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._stastics = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.clearstastics();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Terminal_Animation">Terminal Animation</h3><p>最最早的时候，我当时在nodejs中实现了这个游戏，试图在终端中不断打印刷新来生成动画。</p>
<p>你知道的，终端的IO效率非常低，世界一大，非常之卡，那是第一个UI实现。一个古老的终端动画思路。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drawTerminal() &#123;</span><br><span class="line">    process.stdout.clearScreenDown();</span><br><span class="line">    <span class="keyword">let</span> element</span><br><span class="line">        <span class="keyword">let</span> line = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">            element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">            line += (charFromElement(element) || <span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="keyword">this</span>.grid.width-<span class="number">1</span>) &#123;</span><br><span class="line">                line += <span class="string">'\n'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    process.stdout.write(line);</span><br><span class="line">    process.stdout.cursorTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.vim-cn.com/b1/109b70f577066d82883688bef88cdb59d337b1.gif" alt="Terminal Animation UI"></p>
<p>这不好看，我们希望是色彩鲜艳用户界面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">drawTerminal() &#123;</span><br><span class="line">  process.stdout.clearScreenDown();</span><br><span class="line">  <span class="keyword">let</span> line = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">      <span class="keyword">let</span> element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">      <span class="keyword">let</span> color = <span class="keyword">this</span>._canvasLegend[charFromElement(element)];</span><br><span class="line">      <span class="keyword">if</span> (!color) &#123;</span><br><span class="line">        line += <span class="string">"\x1b[107m \x1b[0m"</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> colorC = terminalColors[color];</span><br><span class="line">        line += (colorC + <span class="string">" "</span> + <span class="string">"\x1b[0m"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    line += <span class="string">'\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  process.stdout.write(line);</span><br><span class="line">  process.stdout.cursorTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.vim-cn.com/22/7fc0abccc74290dce1eb72a1bfba4f066f20c4.gif" alt="Terminal Animation UI colored"></p>
<p>我们能实现的更漂亮，通过字体和颜色的搭配，但，我马上得去滑雪了，不试了。</p>
<p>聪明的我于是就把这个任务交给感兴趣的读者，如果有人实现了请联系我让我膜拜下。</p>
<h3 id="DOM_Animation">DOM Animation</h3><p>然后嘛，就是DOM版本的了，Marijn Haverbeke给出了默认的draw实现。不过既然到了浏览器上，就可以画出些色彩花样。<br>我们可以动态插入一些div并根据legend来附上色彩甚至图像。</p>
<p>实现起来也多样，可以不停操作DOM(下面的代码我没试过哈)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drawDom() &#123;</span><br><span class="line">  <span class="keyword">this</span>._canvas.innerHTML = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">      element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">      <span class="keyword">let</span> color = <span class="keyword">this</span>._canvasLegend[charFromElement(element)];</span><br><span class="line">      <span class="keyword">let</span> e = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">      e.style.width = size + <span class="string">'px'</span>;</span><br><span class="line">      e.style.height = size + <span class="string">'px'</span>;</span><br><span class="line">      e.style.backgroundColor = color;</span><br><span class="line">      <span class="keyword">this</span>._canvas.appendChild(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，也可以生成一堆html然后每次刷新只插入一次。妄图效率能高一些。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drawDom() &#123;</span><br><span class="line">  <span class="keyword">let</span> html = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">let</span> size = <span class="keyword">this</span>._size;</span><br><span class="line">  <span class="keyword">this</span>._canvas.innerHTML = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">      <span class="keyword">let</span> element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">      <span class="keyword">let</span> color = <span class="keyword">this</span>._canvasLegend[charFromElement(element)];</span><br><span class="line">      html += <span class="string">`&lt;div style='background-color:<span class="subst">$&#123;color&#125;</span>;width:<span class="subst">$&#123;size&#125;</span>px;height:<span class="subst">$&#123;size&#125;</span>px;float:left'&gt;&lt;/div&gt;`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._canvas.innerHTML = html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.vim-cn.com/d1/05a775e6f58573966fa4693d21056d6ce133e6.gif" alt="DOM Animation UI"></p>
<p>聪明的我留给读者又一个练习，给每种单位一个图片，让最后渲染效果不是色块而是图片。</p>
<h3 id="Canvas_Animation">Canvas Animation</h3><p>接下来欢迎来到canvas的世界。</p>
<p>使用canvas很简单，准备画布，然后给出js指令告诉canvas如何绘图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drawCanvas() &#123;</span><br><span class="line">  <span class="keyword">let</span> element;</span><br><span class="line">  <span class="keyword">this</span>._ctx.save();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">      element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">      <span class="keyword">this</span>._ctx.fillStyle = <span class="keyword">this</span>._canvasLegend[charFromElement(element)];</span><br><span class="line">      <span class="keyword">this</span>._ctx.fillRect(x * <span class="keyword">this</span>._size, y * <span class="keyword">this</span>._size, <span class="keyword">this</span>._size, <span class="keyword">this</span>._size);</span><br><span class="line">      <span class="comment">// deadly slow if so.</span></span><br><span class="line">      <span class="comment">//this._ctx.beginPath();</span></span><br><span class="line">      <span class="comment">//this._ctx.arc(x * this._size, y * this._size, this.size / 2, 0, Math.PI * 2);</span></span><br><span class="line">      <span class="comment">//this._ctx.fill();</span></span><br><span class="line">      <span class="keyword">this</span>._ctx.fillStyle = <span class="string">'white'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._ctx.restore();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s fucking cool!</p>
<p><img src="http://img.vim-cn.com/08/d056d8ad19af2755c9bada138cced2046d69ab.gif" alt="canvas Animation UI"></p>
<p>当然，如果你尝试试着在每个单位绘制复杂图像，将有意外惊喜。请尝试前保存好当前工作。</p>
<p>聪明的我于是将留给读者又一个练习，给每个单位贴图，给背景贴图。</p>
<h3 id="WebGL_Animation">WebGL Animation</h3><p>最后，webGL，我们把绘制交给gpu来完成。使用webGL相对较复杂一些(当然，特定需求three.js这种封装的很方便，但原生接口对陌生的同学需要学习和理解以下)</p>
<p>webgl暴露了这么一种接口。啊，我不准备讲opengl流水线，一点直观理解就够了。</p>
<ul>
<li>准备画布，调整观察者在空间中的位置。默认情况下，远处和近处物体一样大，画布中心是(0, 0, 0)，空间坐标是右手座标系。</li>
<li>我们使用一种叫GLSL的语言来准备两个shader文件来指导显卡如何渲染数据。其中vertex决定顶点数据，fragment决定如何渲染。</li>
<li>webGL暴露了这么一种接口，你可以创建、编译、链接GLSL语言的程序，而webGL将提供一些接口让你能制定这些程序使用的数据。</li>
<li>webGL也提供了制作让GLSL编译后的程序能理解的数据的接口，这样就能把javascript中的数据传递给显卡。</li>
</ul>
<p>以下只是一种实现，为了实现类似canvas中<code>fillRect</code>效果封装了个<code>_webGLRect</code>函数。<br>聪明的读者将会自己实现更好的。。。</p>
<p>聪明的我将留给读者又一个练习，给每个单位贴图，给背景贴图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">drawWebGL() &#123;</span><br><span class="line">  <span class="keyword">let</span> element;</span><br><span class="line">  <span class="keyword">let</span> colorName;</span><br><span class="line">  <span class="keyword">var</span> wRatio = <span class="number">2</span> / <span class="keyword">this</span>.grid.width ;</span><br><span class="line">  <span class="keyword">var</span> hRatio = <span class="number">2</span> / <span class="keyword">this</span>.grid.height;</span><br><span class="line">  <span class="keyword">this</span>._gl.clearColor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1.0</span>);</span><br><span class="line">  <span class="keyword">this</span>._gl.clear(<span class="keyword">this</span>._gl.COLOR_BUFFER_BIT | <span class="keyword">this</span>._gl.DEPTH_BUFFER_BIT);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.grid.height; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.grid.width; x++) &#123;</span><br><span class="line">      element = <span class="keyword">this</span>.grid.get(<span class="keyword">new</span> Vector(x, y));</span><br><span class="line">      <span class="keyword">if</span> (element) &#123;</span><br><span class="line">        colorName = <span class="keyword">this</span>._canvasLegend[charFromElement(element)];</span><br><span class="line">        <span class="keyword">this</span>._webGLRect(x * wRatio, y * hRatio, wRatio, hRatio, colorName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_webGLRect(x, y, wRatio, hRatio, colorName) &#123;</span><br><span class="line">  <span class="keyword">let</span> gl = <span class="keyword">this</span>._gl;</span><br><span class="line">  <span class="keyword">var</span> vertices = <span class="keyword">new</span> <span class="built_in">Float32Array</span>([</span><br><span class="line">    -<span class="number">1</span> + x, -<span class="number">1</span> + y,</span><br><span class="line">    -<span class="number">1</span> + x + wRatio, -<span class="number">1</span> + y + <span class="number">0</span>,</span><br><span class="line">    -<span class="number">1</span> + x + wRatio, -<span class="number">1</span> + y + hRatio,</span><br><span class="line">    -<span class="number">1</span> + x + <span class="number">0</span>, -<span class="number">1</span> + y + <span class="number">0</span>,</span><br><span class="line">    -<span class="number">1</span> + x + wRatio, -<span class="number">1</span> + y + hRatio,</span><br><span class="line">    -<span class="number">1</span> + x + <span class="number">0</span>, -<span class="number">1</span> + y + hRatio</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> vbuffer = gl.createBuffer();</span><br><span class="line">  gl.bindBuffer(gl.ARRAY_BUFFER, vbuffer);</span><br><span class="line">  gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> itemSize = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">let</span> numItems = vertices.length / itemSize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> uColor = gl.getUniformLocation(<span class="keyword">this</span>.program, <span class="string">"uColor"</span>);</span><br><span class="line">  <span class="keyword">switch</span> (colorName) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"red"</span>:</span><br><span class="line">          gl.uniform4fv(uColor, [<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"green"</span>:</span><br><span class="line">          gl.uniform4fv(uColor, [<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"blue"</span>:</span><br><span class="line">          gl.uniform4fv(uColor, [<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"yellow"</span>:</span><br><span class="line">          gl.uniform4fv(uColor, [<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"black"</span>:</span><br><span class="line">          gl.uniform4fv(uColor, [<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> aVertexPosition = gl.getAttribLocation(<span class="keyword">this</span>.program, <span class="string">"aVertexPosition"</span>);</span><br><span class="line"></span><br><span class="line">  gl.enableVertexAttribArray(aVertexPosition);</span><br><span class="line">  gl.vertexAttribPointer(aVertexPosition, itemSize, gl.FLOAT, <span class="literal">false</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  gl.drawArrays(gl.TRIANGLES, <span class="number">0</span>, numItems);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.vim-cn.com/8d/d346f93ee3ad8163e4390bf64c02ada9c768db.gif" alt="webGL Animation UI"></p>
<h3 id="性能与瞎想">性能与瞎想</h3><p>我本来想给出些科学的探索，然而，我并不能给出谁发热多谁发热少的结论</p>
<p>terminal表现非常好，可惜terminal能画的单位数目有限。</p>
<p>DOM的效率比想象中高很多，能超过canvas很多接近webGL，想想如果用SVG是不是更高2333</p>
<p>canvas，如果需要绘制成千上万次，请使用贴图。。</p>
<p>webGL，可以编辑更复杂的shader文件，一次将要绘制的世界准备好，而不是在循环里不断调用绘图接口。</p>
<h3 id="More?">More?</h3><p>等待您的指教</p>
<h2 id="Have_Fun_With_it">Have Fun With it</h2><p>实际上、通过web技术我们能和这个世界交互。于是，改造成一个伪God Name。</p>
<p>用鼠标在任何位置随时添加的各种单位，随时拆墙建墙。。。如果有谁有兴趣，</p>
<p>聪明的读者会自己玩~</p>
<p>Have fun~,准备滑雪！</p>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal-one" aria-hidden="true">
  <a href="#close" class="cover" aria-hidden="true"></a>
  <div class="modal-dialog">
    <div class="modal-header">
      <a href="#close" class="btn-close" aria-hidden="true">关闭</a>
    </div>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'reverlandblog';
    
    var disqus_url = 'http://reverland.org/javascript/2016/02/26/evolving-game-once-more/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/fastclick.js', function() {
      loadScript('/js/app.js', function() {
        // load success
      });
    });
  }
</script>

</body>
</html>
