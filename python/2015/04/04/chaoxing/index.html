<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Python Spider: 超星图书爬取转换 | Reverland的行知阁</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="python,spider," />
  

  <meta name="description" content="超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)
我忧心忡忡地看待未来，但仍满怀美好的希望。
—— Albert Schweitzer

这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。

几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。
于是我帮他搜索了下，图书馆里">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Spider: 超星图书爬取转换">
<meta property="og:url" content="http://reverland.org/python/2015/04/04/chaoxing/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)
我忧心忡忡地看待未来，但仍满怀美好的希望。
—— Albert Schweitzer

这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。

几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。
于是我帮他搜索了下，图书馆里">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing1.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing2.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing3.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing4.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing6.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing5.png">
<meta property="og:image" content="http://reverland.org/images/spider/chaoxing7.png">
<meta property="og:image" content="http://reverland.org/img=http://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Aaron_Swartz_profile.jpg/220px-Aaron_Swartz_profile.jpg">
<meta property="og:updated_time" content="2015-11-15T06:01:31.555Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python Spider: 超星图书爬取转换">
<meta name="twitter:description" content="超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)
我忧心忡忡地看待未来，但仍满怀美好的希望。
—— Albert Schweitzer

这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。

几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。
于是我帮他搜索了下，图书馆里">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link rel="stylesheet" href="/css/styles.css" type="text/css">

  

  

  

</head>

<body>
  <div class="post-header CENTER">
   
  <div class="toolbox">
    <div class="toolbox-entry">盒子</div>
    <ul class="list-toolbox">
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/archives/">博客</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/category/">分类</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/tag/">标签</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/link/">友链</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/about/">关于</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/atom.xml">RSS</a>
          </li>
        
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#超星数字图书馆(北邮镜像):_在线阅读书籍爬取转换(selenium)"><span class="toc-text">超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</span></a></li></ol>
  </div>


<div class="content-post CENTER">
   <article id="post-chaoxing" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Python Spider: 超星图书爬取转换</h1>

    <div class="article-meta">
      <span>2015-04-04</span>

      <span> | </span>

      <span class="article-author">Liu Yuyang</span>

      <span> | </span>

      
  <span class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>
  </span>


    </div>
  </header>

  <div class="article-content">
    
      <h2 id="超星数字图书馆(北邮镜像):_在线阅读书籍爬取转换(selenium)">超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</h2><blockquote>
<p>我忧心忡忡地看待未来，但仍满怀美好的希望。</p>
<p>—— Albert Schweitzer</p>
</blockquote>
<p>这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。</p>
<hr>
<p>几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。</p>
<p>于是我帮他搜索了下，图书馆里没有这本书。忽然想起来我邮还买了很多电子资源。</p>
<p>于是从图书馆主页选择<code>电子图书</code>-&gt;<code>超星数字电子图书数据</code>，进入如下页面。</p>
<p><img src="/images/spider/chaoxing.png" alt=""></p>
<p>搜索了下这本书，找到了一本。</p>
<p><img src="/images/spider/chaoxing1.png" alt=""></p>
<p>太棒了，下载下来……额……下载需要阅读器……</p>
<p><img src="/images/spider/chaoxing2.png" alt=""></p>
<p>对一个伪geek最讨厌的事情之一就是，某个牛比的企业倚杖其资源绑架用户安装所谓的客户端。比如讨厌的腾讯和讨厌的淘宝。</p>
<p>自然也不会下载什么阅读器，但是，既然可以在线看，那么就可以下载下来。实在在不行我浏览器截图行么。</p>
<p>selenium让一切成为可能(包括截图)。</p>
<p>让我们在线阅读：</p>
<p><img src="/images/spider/chaoxing3.png" alt=""></p>
<p>在线阅读提供了一些功能，包括索引、目录和文字提取，悲剧的是下载下来之后转成的pdf可没有这么多道道。虽然，如果肯花时间解决这些都不是问题……但是，我们又不是想pirate电子书……</p>
<p>对页面按右键发现这是个图片！接着观察对应的源码发现，是一个input标签，仔细观察这个input标签你可以看到很多属性，比如比较重要的class、scr、src、jpgname。</p>
<p>仔细多观察一个，你会发现，class是Jimg的似乎都是书页内容、jpgname属性是页码、scr和src好像都是书页图片地址。</p>
<p><img src="/images/spider/chaoxing4.png" alt=""></p>
<p>你可以试试。说服自己那些就是书页图片地址</p>
<p><img src="/images/spider/chaoxing6.png" alt=""></p>
<p>多看几个发现下面的页面其实src属性都是假的，猜测是书页滚动到某个页面，通过js动态修改src来实现实时加载而不是一下全加载。</p>
<p><img src="/images/spider/chaoxing5.png" alt=""></p>
<p>那么，我们抓取当前网页阅读页面所有class属性是<code>Jimg</code>的input标签的<code>scr</code>标签，就可以获取所有书页的图像了。</p>
<p>接下来，看看selenium是多么丧心病狂……</p>
<p>我们把以上所有从搜索到在线阅读的过程自动化……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># bookname = u'聚酰亚胺新型材料'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bookname = unicode(sys.argv[<span class="number">1</span>], <span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[Usage:] chaoxing.py bookname"</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先搜索</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://sslibbook2.sslibrary.com'</span></span><br><span class="line"></span><br><span class="line">driver.get(url)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入书名</span></span><br><span class="line">driver.find_element_by_id(<span class="string">'sword'</span>).send_keys(bookname)</span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">driver.find_element_by_class_name(<span class="string">"btn-jiansuo"</span>).click()</span><br><span class="line"><span class="comment"># 检索结果</span></span><br><span class="line">driver.switch_to_frame(<span class="string">'book'</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(len(driver.find_elements_by_class_name(<span class="string">'yy'</span>)) &gt; <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 确认书名</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">0</span>].text</span><br><span class="line">       == <span class="string">u"《"</span> + bookname + <span class="string">u"》"</span>)</span><br><span class="line"><span class="comment"># 确认有网页阅读</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].text == <span class="string">u'网页阅读'</span>)</span><br><span class="line"></span><br><span class="line">bookurl = driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].get_attribute(<span class="string">'href'</span>)</span><br><span class="line"></span><br><span class="line">driver.get(bookurl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># where img locate</span></span><br><span class="line">base_url = <span class="string">"http://"</span> + urllib2.urlparse.urlparse(driver.current_url).netloc</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(driver.page_source.find(<span class="string">u'超星'</span>) &gt;= <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pages = driver.find_elements_by_xpath(<span class="string">'//input[@class="Jimg"]'</span>)</span><br><span class="line"></span><br><span class="line">filelist = [e.get_attribute(<span class="string">'jpgname'</span>) <span class="keyword">for</span> e <span class="keyword">in</span> pages]</span><br><span class="line"></span><br><span class="line">imglist = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> pages:</span><br><span class="line">    imglist[e.get_attribute(<span class="string">'jpgname'</span>)] = base_url + e.get_attribute(<span class="string">'scr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> imglist.iteritems():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(k):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib.urlretrieve(v, k)</span><br><span class="line">        <span class="keyword">assert</span>(imghdr.what(k) == <span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">u'convert '</span> + <span class="string">u' '</span>.join(filelist) + <span class="string">' '</span> + bookname + <span class="string">u'.pdf'</span></span><br><span class="line">cmd = cmd.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">os.popen(cmd)</span><br></pre></td></tr></table></figure>
<p>稍微解释下，最后，是用imagemagick把一大堆png格式的书页内容转化成pdf格式。这个过程相当耗内存……如果有空就想想怎么换种方式转pdf，也愿各位看官能指教下。</p>
<p><img src="/images/spider/chaoxing7.png" alt=""></p>
<p>当然，我并没有把pdf传给任何人，我看完之后跟同学讲了讲，没有做任何盗版行径。同学们也要遵守用户守则，不要乱搞。</p>
<p>让我们引以为戒 <a href="http://zh.wikipedia.org/wiki/%E4%BA%9A%E4%BC%A6%C2%B7%E6%96%AF%E6%B2%83%E8%8C%A8" target="_blank" rel="external">Aaron Swartz</a></p>
<p><img src="img=http://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Aaron_Swartz_profile.jpg/220px-Aaron_Swartz_profile.jpg" alt="Aaron Swartz"></p>
<p>非法下载书籍的罪名是非常非常严重的！！！！！</p>
<hr>

    
  </div>
</article>



<section class="disqus-comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>




</div>

  
<script>
  var disqus_shortname = 'reverlandblog';
  
  var disqus_url = 'http://reverland.org/python/2015/04/04/chaoxing/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"undefined"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0]
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- 多说公共JS代码 end -->

</body>
</html>
