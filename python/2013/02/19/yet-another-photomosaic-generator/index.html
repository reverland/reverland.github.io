<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="PIL,python," />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="Yet Another PhotoMosaic GeneratorUpdate: Mon 25 Feb 2013 11:38:47 AM CST add classic style. More refer to github

Python是面向对象的？没有对象面向毛对象。
——Anonymous

Several weeks ago, I saw a poster of presidential">
<meta property="og:type" content="article">
<meta property="og:title" content="Yet Another PhotoMosaic Generator">
<meta property="og:url" content="http://reverland.org/python/2013/02/19/yet-another-photomosaic-generator/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="Yet Another PhotoMosaic GeneratorUpdate: Mon 25 Feb 2013 11:38:47 AM CST add classic style. More refer to github

Python是面向对象的？没有对象面向毛对象。
——Anonymous

Several weeks ago, I saw a poster of presidential">
<meta property="og:image" content="http://www.fmedda.com/sites/default/files/pic/mosaic_chaos.png">
<meta property="og:image" content="https://1a1rrq.sn2.livefilestore.com/y1p7DQkSgKd5dLtkOiUXpx6ACTajjZYAMtiwrPn3jkW3AzQrvwl9Ao76dCvM6bLWoa8nBKIxqQzGlXC1_ARqTVU2XJgVTkOjaCG/xxx.png?psid=1">
<meta property="og:updated_time" content="2015-11-15T06:01:30.279Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yet Another PhotoMosaic Generator">
<meta name="twitter:description" content="Yet Another PhotoMosaic GeneratorUpdate: Mon 25 Feb 2013 11:38:47 AM CST add classic style. More refer to github

Python是面向对象的？没有对象面向毛对象。
——Anonymous

Several weeks ago, I saw a poster of presidential">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Yet Another PhotoMosaic Generator | Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Yet Another PhotoMosaic Generator
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-02-19T00:00:00+08:00" content="2013-02-19">
              2013-02-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2013/02/19/yet-another-photomosaic-generator/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2013/02/19/yet-another-photomosaic-generator/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="Yet_Another_PhotoMosaic_Generator">Yet Another PhotoMosaic Generator</h1><p>Update: Mon 25 Feb 2013 11:38:47 AM CST add classic style. More refer to <a href="https://github.com/reverland/scripts/blob/master/python/yapmg.py" target="_blank" rel="external">github</a></p>
<blockquote>
<p>Python是面向对象的？没有对象面向毛对象。</p>
<p>——Anonymous</p>
</blockquote>
<p>Several weeks ago, I saw a poster of presidential campaign for Obama, in which Obama’s portrait was made up of many voter’s photos. It really attracted me, somedays later, I want to make one myself.</p>
<p>The completed code host <a href="http://github.com/reverland/scripts/blob/master/python/yapmg.py" target="_blank" rel="external">here</a>. It is much more functional than object-oriented…</p>
<h2 id="Search_the_Internet">Search the Internet</h2><p>First of all, I searched the Google to find out how others achieve it, then I found many interesting implement and post on it.Along with them, there are pretty demos around.One of the demo of <a href="http://www.fmedda.com/en/mosaic/chaos" target="_blank" rel="external">Foto-Mosaik-Edda</a> striked me.It declaims as follows in their site:</p>
<blockquote>
<p>The Chaos Mosaic Picture is a new form of photo mosaic which can, at present, only be created by Foto-Mosaik-Edda.</p>
</blockquote>
<p><img src="http://www.fmedda.com/sites/default/files/pic/mosaic_chaos.png" alt="Chaos Mosaic Picture"></p>
<p>Uhm…Foto-Mosaic-Edda is an open-source project that really impressive.But it was an C# project. Linux users don’t like it however.I don’t like <code>mono</code>.</p>
<p>I searched other open-source implement on photomosaic. I get some simple programs only use gray photos, and some complex ones can make beautiful classic photomosaic(like metapixel, even chaos style which it calls collage style), But none has as beautiful demos as Foto-Mosaic-Edda.(metapixel really amazing, it is robust and quickly.)</p>
<p>However, I saw many enthusiastic people write one themselves, it really looks interesting for me. I’ve used PIL for processing images when I tried to decode captchas several days ago, so I believe with the help of PIL, someone can achieve photomosaic simply.</p>
<p>So I just read the documentation of PIL, then start my hack.</p>
<h2 id="Write_My_Own_PhotoMosaic_Generator">Write My Own PhotoMosaic Generator</h2><p>It’s not hard, however, what you should do is clear and simple:</p>
<ul>
<li>analyse the image to be made mosaic, get a dict in which position as key and color as value.</li>
<li>use a bunch of images to get a dict, in which image name as key and colors as value.</li>
<li>thumbnail bunches of images and paste it in the right position, so that the big image looks like it consists of many small one.</li>
</ul>
<p>I’d like to got the chaos style, so some other requirements:</p>
<ul>
<li>frame and shadow for small images</li>
<li>random paste small images onto large one</li>
</ul>
<p>Now, let’s go.</p>
<h3 id="Frame,_Shadow_and_Rotate">Frame, Shadow and Rotate</h3><p>first add frame, shadow to small images</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_frame</span><span class="params">(image)</span>:</span></span><br><span class="line">    <span class="string">'''Add frame for image.'''</span></span><br><span class="line">    im = ImageOps.expand(image, border=int(<span class="number">0.01</span> * max(image.size)), fill=<span class="number">0xffffff</span>)</span><br><span class="line">    <span class="keyword">return</span> im</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_shadow</span><span class="params">(image, offset, border=<span class="number">0</span>, shadow_color=<span class="number">0x444444</span>)</span>:</span></span><br><span class="line">    <span class="string">"""Add shadows for image"""</span></span><br><span class="line">    <span class="comment"># Caclulate size</span></span><br><span class="line">    fullWidth = image.size[<span class="number">0</span>] + abs(offset[<span class="number">0</span>]) + <span class="number">2</span> * border</span><br><span class="line">    fullHeight = image.size[<span class="number">1</span>] + abs(offset[<span class="number">1</span>]) + <span class="number">2</span> * border</span><br><span class="line">    <span class="comment"># Create shadow, hardcode color</span></span><br><span class="line">    shadow = Image.new(<span class="string">'RGBA'</span>, (fullWidth, fullHeight), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="comment"># Place the shadow, with required offset</span></span><br><span class="line">    shadowLeft = border + max(offset[<span class="number">0</span>], <span class="number">0</span>)  <span class="comment"># if &lt;0, push the rest of the image right</span></span><br><span class="line">    shadowTop = border + max(offset[<span class="number">1</span>], <span class="number">0</span>)  <span class="comment"># if &lt;0, push the rest of the image down</span></span><br><span class="line">    shadow.paste(shadow_color, [shadowLeft, shadowTop, shadowLeft + image.size[<span class="number">0</span>], shadowTop + image.size[<span class="number">1</span>]])</span><br><span class="line">    shadow_mask = shadow.convert(<span class="string">"L"</span>)</span><br><span class="line">     <span class="comment"># Paste the original image on top of the shadow</span></span><br><span class="line">    imgLeft = border - min(offset[<span class="number">0</span>], <span class="number">0</span>)  <span class="comment"># if the shadow offset was &lt;0, push right</span></span><br><span class="line">    imgTop = border - min(offset[<span class="number">1</span>], <span class="number">0</span>)  <span class="comment"># if the shadow offset was &lt;0, push down</span></span><br><span class="line">    shadow.putalpha(shadow_mask)</span><br><span class="line">    shadow.paste(image, (imgLeft, imgTop))</span><br><span class="line">    <span class="keyword">return</span> shadow</span><br></pre></td></tr></table></figure>
<p>Then a function to rotate images.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rotate_image</span><span class="params">(image, degree)</span>:</span></span><br><span class="line">    <span class="string">'''Rotate images for specific degree. Expand to show all'''</span></span><br><span class="line">    <span class="keyword">if</span> image.mode != <span class="string">'RGBA'</span>:</span><br><span class="line">        image = image.convert(<span class="string">'RGBA'</span>)</span><br><span class="line">    im = image.rotate(degree, expand=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> im</span><br></pre></td></tr></table></figure>
<p>‘RGBA’ mode is to support transparency. What’s matter here is that jpeg/jpg does not support transparency. So you can’t get transparency shadows and rotate pictures if you just use jpg/jpeg images.So, write a function to process images with jpg/jpeg format, transpose it into png.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_image</span><span class="params">(filename, newname)</span>:</span></span><br><span class="line">    <span class="string">'''convert image to png to support transparency'''</span></span><br><span class="line">    <span class="keyword">if</span> filename.split(<span class="string">'.'</span>)[-<span class="number">1</span>] != <span class="string">'png'</span>:</span><br><span class="line">        im = Image.open(filename)</span><br><span class="line">        im.save(newname + <span class="string">'.png'</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"processing image file %s"</span> % filename</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_directory</span><span class="params">(path)</span>:</span></span><br><span class="line">    os.chdir(path)</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">        ext = filename.split(<span class="string">'.'</span>)[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> ext == <span class="string">'jpeg'</span> <span class="keyword">or</span> ext == <span class="string">'jpg'</span>:</span><br><span class="line">            process_image(filename, str(count))</span><br><span class="line">            os.remove(filename)</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>Really poor work… But it works for me: )</p>
<p>We have to thumnail bunches of images, It’s easy to thumbnail with PIL:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thumbnail</span><span class="params">(im, size)</span>:</span></span><br><span class="line">    <span class="string">"""thumnail the image"""</span></span><br><span class="line">    im.thumbnail(size, Image.ANTIALIAS)</span><br><span class="line">    <span class="keyword">return</span> im</span><br></pre></td></tr></table></figure>
<p>Let’s have a fun with them. To get heaps of images randomly on the desktop, I hardcoded these parameters to get my photos work, you HAVE TO find yours:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Just for fun</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chao_image</span><span class="params">(path, size=<span class="params">(<span class="number">800</span>, <span class="number">800</span>)</span>, thumbnail_size=<span class="params">(<span class="number">50</span>, <span class="number">50</span>)</span>, shadow_offset=<span class="params">(<span class="number">10</span>, <span class="number">10</span>)</span>, backgroud_color=<span class="number">0xffffff</span>)</span>:</span></span><br><span class="line">    image_all = Image.new(<span class="string">'RGB'</span>, size, backgroud_color)</span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">        <span class="keyword">if</span> image.split(<span class="string">'.'</span>)[-<span class="number">1</span>] == <span class="string">'png'</span>:</span><br><span class="line">            im = Image.open(image)</span><br><span class="line">            degree = random.randint(-<span class="number">30</span>, <span class="number">30</span>)</span><br><span class="line">            im = thumbnail(rotate_image(drop_shadow(add_frame(im), shadow_offset), degree), thumbnail_size)</span><br><span class="line">            image_all.paste(im, (random.randint(-thumbnail_size[<span class="number">0</span>], size[<span class="number">0</span>]), random.randint(-thumbnail_size[<span class="number">1</span>], size[<span class="number">1</span>])), im)</span><br><span class="line">    <span class="keyword">return</span> image_all</span><br></pre></td></tr></table></figure>
<h2 id="Calculate_Images_And_Compare">Calculate Images And Compare</h2><p>Get average colors of an image</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_image</span><span class="params">(im)</span>:</span></span><br><span class="line">    <span class="string">"""return average (r,g,b) for image"""</span></span><br><span class="line">    color_vector = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> ImageStat.Stat(im).mean]</span><br><span class="line">    <span class="keyword">return</span> color_vector</span><br></pre></td></tr></table></figure>
<p>to compare images? Compare the (r,g,b) value of them.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_vectors</span><span class="params">(v1, v2)</span>:</span></span><br><span class="line">    <span class="string">"""compare image1 and image2, return relations"""</span></span><br><span class="line">    <span class="keyword">if</span> len(v1) == len(v2):</span><br><span class="line">        distance = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(v1)):</span><br><span class="line">            distance += (v1[i] - v2[i]) ** <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> distance</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"vector not match in dimensions"</span></span><br></pre></td></tr></table></figure>
<p>I just use distance in (R, G, B) space to calculate similarity, someone advice compare in other space, you can change it just like the example in PIL’s documentation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># May not useful</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rgb2xyz</span><span class="params">(im)</span>:</span></span><br><span class="line">    <span class="string">"""rgb to xyz"""</span></span><br><span class="line">    rgb2xyz = (<span class="number">0.412453</span>, <span class="number">0.357580</span>, <span class="number">0.180423</span>, <span class="number">0</span>, <span class="number">0.212671</span>, <span class="number">0.715160</span>, <span class="number">0.072169</span>, <span class="number">0</span>, <span class="number">0.019334</span>, <span class="number">0.119193</span>, <span class="number">0.950227</span>, <span class="number">0</span>)</span><br><span class="line">    out = im.convert(<span class="string">"RGB"</span>, rgb2xyz)</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>
<p>But I find many implements just use R,G,B, and it works well.</p>
<p>Next, get a dict of image in current path, in which filename as key, average (R,G,B) colors as value.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tile_dict</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""Return list of average (R,G,B) for image in this path as dict."""</span></span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">        <span class="keyword">if</span> image.split(<span class="string">'.'</span>)[-<span class="number">1</span>] == <span class="string">'png'</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                im = Image.open(image)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"image file %s cannot open"</span> % image</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> im.mode != <span class="string">'RGB'</span>:</span><br><span class="line">                im = im.convert(<span class="string">'RGB'</span>)</span><br><span class="line">            dic[image] = average_image(im)</span><br><span class="line">    <span class="keyword">return</span> dic</span><br></pre></td></tr></table></figure>
<p>We don’t need to calculate every pixel of the large picture, just thumbnail it to get a nearest color of different regions.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thumbnail_background</span><span class="params">(im, scale)</span>:</span></span><br><span class="line">    <span class="string">"""thumbnail backgroud image"""</span></span><br><span class="line">    newsize = im.size[<span class="number">0</span>] / scale, im.size[<span class="number">1</span>] / scale</span><br><span class="line">    im.thumbnail(newsize)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'thumbnail size and the number of tiles %d X %d'</span> % im.size</span><br><span class="line">    <span class="keyword">return</span> im.size</span><br></pre></td></tr></table></figure>
<p>For every pixel in the thumbnailed large image, find most similar small image filenames.(top ten):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_similar</span><span class="params">(lst, dic)</span>:</span></span><br><span class="line">    <span class="string">"""for lst([R, G, B], Calculate which key-value in dic has the most similarity.Return first 10)"""</span></span><br><span class="line">    similar = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> dic.items():</span><br><span class="line">        similar[k] = compare_vectors(v, lst)</span><br><span class="line">        <span class="comment"># if len(v) != len(lst):</span></span><br><span class="line">        <span class="comment">#     print v, len(v), lst, len(lst)</span></span><br><span class="line">    similar = [(v, k) <span class="keyword">for</span> k, v <span class="keyword">in</span> similar.items()]  <span class="comment"># Not good, lost the same Score</span></span><br><span class="line">    similar.sort()</span><br><span class="line">    <span class="keyword">return</span> similar[:<span class="number">10</span>]</span><br></pre></td></tr></table></figure>
<p>Poor hack, but it really works…</p>
<h2 id="Final_Work">Final Work</h2><p>Now it’s the final magic.</p>
<p>Get the small image in order, the order imply where it should be. Then rotate, add shadows and frames for small images, finally paste it onto the large one randomly in the right position:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_image_list</span><span class="params">(im, dic)</span>:</span></span><br><span class="line">    <span class="string">"""receive a thumbnail image and a dict of image to be mosaic, return tiles(filename) in order(as a list)"""</span></span><br><span class="line">    lst = list(im.getdata())</span><br><span class="line">    tiles = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(lst)):</span><br><span class="line">        <span class="comment">#print find_similar(lst[i], dic)[random.randrange(10)][1]</span></span><br><span class="line">        tiles.append(find_similar(lst[i], dic)[random.randrange(<span class="number">10</span>)][<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> tiles</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paste_chaos</span><span class="params">(image, tiles, size, shadow_off_set=<span class="params">(<span class="number">30</span>, <span class="number">30</span>)</span>)</span>:</span></span><br><span class="line">    <span class="string">"""size is thumbnail of backgroud size that is how many tiles per line and row"""</span></span><br><span class="line">    <span class="comment"># image_all = Image.new('RGB', image.size, 0xffffff)</span></span><br><span class="line">    image_all = image</span><br><span class="line">    lst = range(len(tiles))</span><br><span class="line">    random.shuffle(lst)</span><br><span class="line">    fragment_size = (image.size[<span class="number">0</span>] / size[<span class="number">0</span>], image.size[<span class="number">1</span>] / size[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'tiles size %d X %d'</span> % fragment_size</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'number of tiles one iteration: %d'</span> % len(lst)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> lst:</span><br><span class="line">        im = Image.open(tiles[i])</span><br><span class="line">        degree = random.randint(-<span class="number">20</span>, <span class="number">20</span>)</span><br><span class="line">        im = thumbnail(rotate_image(drop_shadow(add_frame(im), shadow_off_set), degree), (fragment_size[<span class="number">0</span>] * <span class="number">3</span> / <span class="number">2</span>, fragment_size[<span class="number">1</span>] * <span class="number">3</span> / <span class="number">2</span>))</span><br><span class="line">        x = i % size[<span class="number">0</span>] * fragment_size[<span class="number">0</span>] + random.randrange(-fragment_size[<span class="number">0</span>] / <span class="number">2</span>, fragment_size[<span class="number">0</span>] / <span class="number">2</span>)</span><br><span class="line">        y = i / size[<span class="number">0</span>] * fragment_size[<span class="number">1</span>] + random.randrange(-fragment_size[<span class="number">1</span>] / <span class="number">2</span>, fragment_size[<span class="number">1</span>] / <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># print x, y</span></span><br><span class="line">        image_all.paste(im, (x, y), im)</span><br><span class="line">    <span class="keyword">return</span> image_all</span><br></pre></td></tr></table></figure>
<p>I try it like this, I know parameter <code>n</code> is tricky, it was the scale it thumbnail the large image. Maybe I’ll change it to something more clear later…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(filename, n, scale, iteration, path=<span class="string">'./'</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 0. select an big image for mosaic</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"open %s"</span> % filename</span><br><span class="line">    im = Image.open(filename)</span><br><span class="line">    <span class="comment"># 1. process image as png to support transparency</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"process directory %s"</span> % path</span><br><span class="line">    process_directory(path)</span><br><span class="line">    <span class="comment"># 2. get a dict for path</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"get tile dict for path `%s`"</span> % path</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'dic.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            dic = p.load(f)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        dic = tile_dict(path)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'dic.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            p.dump(dic, f)</span><br><span class="line">    <span class="comment"># 3. thumbnail the big image for compare</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"thumbnail background for compare"</span></span><br><span class="line">    <span class="comment"># n = 30  # 原始图片缩为多少分之一</span></span><br><span class="line">    <span class="comment"># scale = 3  # 原始图片放大倍数</span></span><br><span class="line">    big_size = im.size[<span class="number">0</span>] * scale, im.size[<span class="number">1</span>] * scale</span><br><span class="line">    im_chao = Image.new(<span class="string">'RGB'</span>, big_size, <span class="number">0xffffff</span>)</span><br><span class="line">    imb_t_size = thumbnail_background(im, n)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"how may tiles: %d X %d"</span> % imb_t_size</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'number of iterations: %d'</span> % iteration</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(iteration):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'iteration: %d'</span> % (i + <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 4. get a list of smail image for mosaic</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"get pic list"</span></span><br><span class="line">        im_tiles = get_image_list(im, dic)</span><br><span class="line">        <span class="comment"># 5. paste in chaos style</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"generate final image"</span></span><br><span class="line">        im_chao = paste_chaos(im_chao, im_tiles, imb_t_size)</span><br><span class="line">    <span class="keyword">return</span> im_chao</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    im = main(<span class="string">'../mm.jpg'</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">    im.save(<span class="string">'../final3.png'</span>)</span><br><span class="line">    im.show()</span><br></pre></td></tr></table></figure>
<h2 id="Demo">Demo</h2><p>Do you like it?</p>
<p><img src="https://1a1rrq.sn2.livefilestore.com/y1p7DQkSgKd5dLtkOiUXpx6ACTajjZYAMtiwrPn3jkW3AzQrvwl9Ao76dCvM6bLWoa8nBKIxqQzGlXC1_ARqTVU2XJgVTkOjaCG/xxx.png?psid=1" alt="Demo"></p>
<p><strong>Can you see it?</strong></p>
<p><a href="https://lhtlyybox.googlecode.com/files/final3.png" target="_blank" rel="external">Demo Download(45.8M)</a></p>
<p>More examples <a href="http://photo.renren.com/photo/306127150/album-857154918" target="_blank" rel="external">here</a>(Chinese)</p>
<h2 id="Thanks">Thanks</h2><p>My family, It supports me.Never let me down, never pour cold water, never scold for insignificance.</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pil/" rel="tag">#PIL</a>
          
            <a href="/tags/python/" rel="tag">#python</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/python/2013/02/05/visualize-the-friendship-of-renren/" rel="next" title="Python小练习：可视化人人好友关系">
                <i class="fa fa-chevron-left"></i> Python小练习：可视化人人好友关系
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/python/2013/02/25/generate-ascii-images-like-the-matrix/" rel="prev" title="Generate Ascii Images Like the Matrix">
                Generate Ascii Images Like the Matrix <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">178</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">63</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.d0u9.xyz/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lazymind.me/" target="_blank">mapleray</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Yet_Another_PhotoMosaic_Generator"><span class="nav-number">1.</span> <span class="nav-text">Yet Another PhotoMosaic Generator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Search_the_Internet"><span class="nav-number">1.1.</span> <span class="nav-text">Search the Internet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write_My_Own_PhotoMosaic_Generator"><span class="nav-number">1.2.</span> <span class="nav-text">Write My Own PhotoMosaic Generator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Frame,_Shadow_and_Rotate"><span class="nav-number">1.2.1.</span> <span class="nav-text">Frame, Shadow and Rotate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Calculate_Images_And_Compare"><span class="nav-number">1.3.</span> <span class="nav-text">Calculate Images And Compare</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final_Work"><span class="nav-number">1.4.</span> <span class="nav-text">Final Work</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo"><span class="nav-number">1.5.</span> <span class="nav-text">Demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thanks"><span class="nav-number">1.6.</span> <span class="nav-text">Thanks</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'python/2013/02/19/yet-another-photomosaic-generator/';
      var disqus_title = 'Yet Another PhotoMosaic Generator';
      var disqus_url = 'http://reverland.org/python/2013/02/19/yet-another-photomosaic-generator/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
