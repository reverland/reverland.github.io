<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/4/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/art/2015/03/09/" itemprop="url">
                  谈谈色彩空间和混合模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-09T00:00:00+08:00" content="2015-03-09">
              2015-03-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/art/" itemprop="url" rel="index">
                    <span itemprop="name">art</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/art/2015/03/09/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="art/2015/03/09//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>图层模式和色彩空间理论，在寒假的时候就很好奇，找来gimp的文档看了看图层模式还是有些糊里糊涂。关于色彩理论，看到图像处理新闻组(好像很古老的东西了)上推荐这篇文章<a href="http://www.poynton.com/ColorFAQ.html" target="_blank" rel="external">Color FAQ</a>，看上去似乎很不错的样子，但好像不适合入门。</p>
<p>后来看到一本1996年关于gimp的书<a href="http://gimp-savvy.com/BOOK/index.html?node52.html" target="_blank" rel="external">Grokking the GIMP</a>，虽然似乎有些古老的样子，但一目了然，很多东西，十年都未曾变化。</p>
<h2 id="色彩基础">色彩基础</h2><h3 id="RGB空间">RGB空间</h3><p>即通过Red、Green、Blue来表示其它颜色的方法。每种颜色都取0-255之间的值。这样整个色彩空间可以表示在R、G、B为轴的立方体内。</p>
<p>一般看来，越往对角线方向色彩感觉越亮。</p>
<h3 id="HSV空间">HSV空间</h3><p>这里有几个定义：</p>
<p>lightness：L = (MAX(R, G, B) + MIN(R, G, B))/2<br>value: V = MAX(R, G, B)<br>luminance: Y = 0.30R + 0.69G + 0.11B<br>brightness: (R + G + B)/3</p>
<p>luminance更符合人的主观亮度感受。brightness和人的感受差别较大，一般不用而用luminance。</p>
<p>那HSV模型在RGB空间是什么样的呢。</p>
<h3 id="HSV和RGB关系">HSV和RGB关系</h3><p>在RGB空间所在的立方体中，主对角线被成为Neutral line。这条线从原点到(255,255,255)逐渐从黑色过度到灰色到更浅的灰色到白色。</p>
<p>HSV中固定H，则获得过这条线的一面。固定S，则获得以此为轴原点为顶点的圆锥面。固定V，则获得关于此线垂直的面。</p>
<h3 id="CMYK减法模型">CMYK减法模型</h3><p>这是印刷中常用的，RGB用在发光模型中，CMY(K)用在反光模型中。k应该不超过MAX(C, M, Y)</p>
<h3 id="转换为灰度图像">转换为灰度图像</h3><p>有三种方法：</p>
<ol>
<li>Grayscale: 通过计算luminance，这个符合人眼对亮度的感觉</li>
<li>Desaturate: 计算lightness。实际上保留了RGB分量</li>
<li>Decompose HSV:抽取HSV中的V</li>
</ol>
<p>V &gt; L或Y，所以显然V最亮，但人眼会感觉Grayscale效果最好。所以后两种方法常用在分离图像上。</p>
<h2 id="图层模式">图层模式</h2><p>这是关于两个或多个图层的故事，上面的记为F，下面的记为B</p>
<h3 id="Normal,_Dissolve,_Behind模式">Normal, Dissolve, Behind模式</h3><p>Normal没啥特别的，溶解和F图层的透明度有关，透明度越大，B透过的越多。</p>
<p>behind是个特殊的画笔才能用的模式，就像在玻璃背面画图一样</p>
<h3 id="Addition，Substract，_Difference模式">Addition，Substract， Difference模式</h3><p>运算符号表示各个分量独立运算。W为白色</p>
<p>加法：<br>    R = min(F + B, W)</p>
<p>减法：<br>    R = max(B - F, 0)</p>
<p>差分：<br>    R = |F - B|</p>
<p>前两种方法可能会造车个部分额区域变得全白或全黑，丢失部分信息。</p>
<h3 id="multiply(burn),_Divide(Dodge),_Screen,_Overlay模式">multiply(burn), Divide(Dodge), Screen, Overlay模式</h3><p>发现变化也不少，现在又是hard light又是啥的，burn也不是multiply，Divide也不是Dodge了。不过也差不多，burn和dodge只是把相应multiply和divide的F反色了(255-F)</p>
<p>正片叠底：<br>    R = (F x B)/255</p>
<p>得到的结果比F和B都暗</p>
<p>除法：<br>    R = MIN(W, B x 256 / (F + 1))</p>
<p>结果比B亮，有可能变白丢失信息</p>
<p>滤色：<br>    R = 255 - 1/255 x (255- F) x (255 - B)</p>
<p>滤色原理和乘法类似，只是是从W开始向原点计算。结果是图像所有地方都变亮，但并不会出现某些区域全变白色丢失信息。</p>
<p>叠加(不过gimp中的叠加好像就是柔光, <a href="https://bugzilla.gnome.org/show_bug.cgi?id=162395" target="_blank" rel="external">这里看起来让人困惑</a>)：<br>    multiply和screen的结合：<br>    R = 1/255 x (B x R_S + (255 - B) X R_m)</p>
<p>如果先面的图层B很深，就以multiply为主，相反如果B很亮，则以screen为主。结果就是暗的地方更暗，亮的地方更亮。</p>
<h3 id="Darken_Only_和_Lighten_Only模式">Darken Only 和 Lighten Only模式</h3><p>变暗：<br>    R = MIN(F, B)</p>
<p>变亮：<br>    R = MAX(F, B)</p>
<h3 id="Hue,_Saturation,_Value,_Color模式">Hue, Saturation, Value, Color模式</h3><p>色调：<br>    R = [h(F), s(B), v(B)]</p>
<p>取前景的色调</p>
<p>Value和Saturation类似。</p>
<p>Color：<br>    R = [h(F), s(F), l(B)]</p>
<p>使用背景的lightness，一般lightness都比value小些</p>
<p>最后，这里头什么乱七八糟的历史问题，还是这比较清楚：<a href="http://www.pegtop.net/delphi/articles/blendmodes/" target="_blank" rel="external">图层混合模式详解</a></p>
<h2 id="其它">其它</h2><p>最后，完全被北邮求职氛围吓尿拉！！！！！！！！！！！</p>
<p>惶恐万分，心情只能用下面的图形容</p>
<p><img src="/images/ancious.jpg" alt="惶恐万分图" title="希望手绘反映内心"></p>
<p>还有时间这样没事画棵树么？</p>
<p><img src="/images/work-gimp3.jpg" alt="树" title="我的第一个上色唉"></p>
<p>不管怎样，毕业之前有几件特别想做的事：</p>
<ol>
<li>以工作室的名义发布一款自任美工、编剧、程序员等balblabla使用phaser.js制作的“网页游戏”</li>
<li>画给某些人的画</li>
<li>去游泳馆洗三百次澡= =。。。。。。</li>
</ol>
<p>as酱上回来找我玩错过了好遗憾，as酱T T，下次你有空不知啥时候了。</p>
<p>最后奉上工作室logo：</p>
<p><img src="/images/work-gimp5.jpg" alt="半条狗工作室" title="半条狗logo"></p>
<p>欢迎各位一起来玩耍。一起来做ARPG啊！</p>
<p>最后丧心病狂大量图片哈哈哈哈</p>
<p>在aus的推荐下迷上了像素画</p>
<p><img src="/images/work-gimp4.jpg" alt="像素狗，半条狗" title="一条大狗">]</p>
<p><img src="/images/work-gimp2.jpg" alt="anubis" title="anubis"></p>
<p>在<a href="http://www.gimpusers.com" target="_blank" rel="external">gimpusers</a>上看到了很多很棒的教程！</p>
<p><img src="/images/work-gimp.jpg" alt="chrome环" title="chrome">]</p>
<p><img src="/images/work-gimp1.jpg" alt="火焰效果" title="fire"></p>
<p><img src="/images/work-gimp6.jpg" alt="flashy car" title="flashy car"></p>
<p><img src="/images/animated-radar.gif" alt="animated radar" title="动画雷达"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2015/03/02/2015s-first-post/" itemprop="url">
                  2015's First Post
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-02T00:00:00+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2015/03/02/2015s-first-post/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2015/03/02/2015s-first-post/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>好早就想写点什么了，然而犹犹豫豫一直没下笔。一月没有写，二月也没有写，转眼年也过了，三月来了，天气将要转暖，马上要找实习写论文找工作，还有许许多多漫天飞舞不知何去何从的残念。</p>
<p>都快忘记怎么用jekyll的rake新建一个post，怎么使用markdown语法，也迟疑着不知该具体写些什么。</p>
<p>之前的两月没有白过，想说的仅此吧。</p>
<p>游了一个月不到的泳，就第三次把手砸在水线上血染泳池，半夜跑去北医三院打了针破伤风，再游泳就昨天了。</p>
<blockquote>
<p>怎样下水才能表现出经常下水的样子</p>
</blockquote>
<p>跑到深水区救生员小哥说你的装备呢，我才发现什么泳帽泳镜都没拿进去。。。。。。下水后整个人都快动不了了，虚得一塌糊涂。</p>
<p>一个月过年就爬过一次山，算是活动了下。把小伙伴们带到没路的地方，然后强行开路。。。。。。</p>
<p>不扯其它的了。</p>
<p>又做了次LFS，终于明白是在干什么了。然而等所有东西都安装好却懒得去配置了。</p>
<p>玩了下nodeschool系列。把javascripting、learnyounode、git-it、functional-javascript、shader-school、webgl都过了遍。现在还记得些什么呢。。。。。。有道笔记里应该还有些笔记。</p>
<p>于是开始折腾glsl，把shader-school过遍发现难度好大。把中科大黄章进老师的高级计算机图形学的课件拿来看了看，最后也没看多少。</p>
<p>把webgl-workshop过了遍，最后发现<a href="http://www.webglacademy.com/" target="_blank" rel="external">http://www.webglacademy.com/</a>不错却只画了个2D三角形，现在也几乎忘的干净。不过再上手应该就很快了。</p>
<p>查webgl的知识看到<a href="http://html5gamedev.org/" target="_blank" rel="external">http://html5gamedev.org/</a>上webgl的一些效果，再加上一个在线的<a href="http://race.assassinscreedpirates.com/" target="_blank" rel="external">刺客信条游戏</a>便萌生了开发游戏的。。。。。。。呵呵。。。。</p>
<p>然后看到某某的html5游戏引擎制作中设计精灵，竟然开始专注图像处理。。。。。。</p>
<p>学习下基础的图像理论色彩理论等等等，</p>
<p>把gimp和krita重新配置了下。桌面主题和图标折腾了下又回归原来的配色主题，因为好看的主题总会在某些地方让人看不清东西，毕竟好看是次要的。</p>
<p>看到论坛上有人推荐<a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" target="_blank" rel="external"> Operating Systems: Three Easy Pieces </a>，感觉很不错。又看有人推荐<a href="http://littleosbook.github.io/" target="_blank" rel="external">littleOsbook</a>，跟着写了点发现太不详细了，从分段开始我就不知道怎么把一切串到一起。后来看到<a href="http://wiki.osdev.org/Bare_Bones" target="_blank" rel="external">Osdev上的教程</a>，只大致看了看。</p>
<p>发现<a href="http://www.68ps.com/jc/big_ps_tp.asp?id=19958" target="_blank" rel="external">68ps</a>的抠图教程不错，大年三十看着春晚抠图。。。。。。最后也没做好。</p>
<p>照着上面网站另一篇鼠绘教程画了个<a href="http://www.68ps.com/jc/big_ps_sh.asp?id=3044" target="_blank" rel="external">水母</a>。感觉这没有数位板不行啊，于是翻出了尘封多年的绘图板。又把数位板翻出来连上，重新编译内核wacom模块(学会了失传已久的单独模块编译技术…)。</p>
<p>所以，接下来：</p>
<p>准备成立个工作室，做个游戏，发行两个唱片。</p>
<p>先完成工作室logo设计，为此查了一天的anubis。</p>
<p>还顺便在朋友的推荐下学习做做pixel art。在图书馆乱翻到一本什么bibi的photoshop插画私房菜什么的书，竟然也看到里头演示pixel art实例。</p>
<p>把webgl过遍。</p>
<font color="red">好好游泳，锻炼身体。</font>

<p>呵呵呵，还有实验室、论文、实习、工作。。。。。。</p>
<p>渣渣的第一个鼠绘：）</p>
<p><img src="/images/jellyfish.png" alt="照着ps教程用gimp鼠绘的水母" title="照着ps教程用gimp鼠绘的水母"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2014/12/24/" itemprop="url">
                  明天太远，今天太短
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-12-24T00:00:00+08:00" content="2014-12-24">
              2014-12-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2014/12/24/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2014/12/24//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <blockquote>
<p>迷路的鸽子啊。</p>
</blockquote>
<p>一年很短，一年好长。</p>
<p>一年倏忽就晃过去，倏忽间珍存的只在记忆留下余温。</p>
<p>一年的记忆累累，蓊蓊郁郁，如烟似梦，怎么都回忆不完。</p>
<p>觉得变了很多，连早上起来呼吸的空气都变了味道，又觉得什么都没有变，日光之下，并无新事。</p>
<h1 id="算了">算了</h1><p>随便写下，随便回忆下。</p>
<p>几乎每天都去游泳。</p>
<p>春夏秋冬。</p>
<p>寒来暑往。</p>
<p>像一个师妹的话，风雨无阻。</p>
<p>像另一个师妹的话，专情。</p>
<p>如果有什么贯穿始终的话，</p>
<p>游泳是2014年贯穿始终的全部。</p>
<p>我的2014不可磨灭的关键词</p>
<p>三月份之前我不记得了，在家挺不适应，冷，宅。颓得一塌糊涂，唯一似乎做的有意义的事是把python公案给过了遍，twisted的一篇教程和文档看了遍，如今已不记得只言半句。回去过年房间也没收拾，也是遗憾吧。家里变化好大，回去的几天家里漫天白茫茫的雾，所有祥和气氛下的无奈与心酸变故，化作一声叹息，无处寻觅。</p>
<p>年前回家那阵忙着考试，过得忙碌，好久没和家里充分联系。回到家里，我还看着。。。算了，不想多说。</p>
<p>往日祥和一心的氛围一去不返，十几年的情谊一霎那岌岌可危。</p>
<p>这就是2014年的春节寒假。</p>
<p>以前看红楼梦，只是看到里头家人朋友相聚时热闹祥和的气氛深有感触，觉得这些经历跟我没什么关系。当年只是感慨韶华易逝，没想到逝这么快。这才想起来红楼梦中其它种种，都像预言一样，不觉泪下。</p>
<p>开学回学校，似乎有种解脱感。所有种种要面对的问题，都留给独立撑起家里的母亲。</p>
<p>回到学校，工作上也有大变动，地点换了，内容也完全变了。做了些与网络协议相关的工作，不自觉也兴致盎然，饶有兴趣研究了网络层一些协议。</p>
<p>那段日子也算清闲自在，实验室来新师弟师妹了，和室友在实验室打minecraft，在实验室玩xbox推刺客信条和热血无赖，八点钟去游泳池打酱油。</p>
<p>这些日子渐渐和zq、扯旗、彬哥、阿花混得比较熟了，游泳总是碰上，哈哈。不过他们都是在用心游，我就抱着活动活动的心态随便动动。</p>
<p>阿花每次见到我总喜欢拿我开涮，总说，唉，那个是你师姐，唉，又手把手教你师姐不陪我玩。阿花帅气成熟，我这种人能和阿花认识总觉得是生命中的奇迹。阿花曾经在泳池里看到了一个妹子，心生向往之情，在论坛上发帖定向。我之前知道这个人来找过某室友，只寥寥说过几句话。有次在水里听到说到帖子定向的事，我一看，唉，是不是你啊。然后竟然就莫名其妙的熟起来了。那几天一起去学自由泳，游完来碗热腾腾的拉面。后来，阿花和妹子也算搭上谈了谈，终于有缘无份，抱憾而终。有次一起去水立方游泳时，从新奥购物中心巨大的建筑物，来到奥林匹克公园豁然开朗时，阿花轻描淡写但不无遗憾的谈到此事。然而我无法如此坦诚，后来阿花去游泳少了许多，一个是工作忙，一个是职务上的事也多，另外其它事也多。阿花后来喊我去打台球，终于却一次没去一起打过。总之，希望新的一年阿花捉到一只……嗯……妹子。</p>
<p>zq是碧水情深版版主，嘿，真是很少见到这么热情的人。我总是很佩服zq，待人接物，举止言谈都自然坦诚，让人一见了就欢喜。对此，zq的说法是：因为我是个逗比= = zq是我的游泳教练和陪我去看病骑车带我去游泳的好机油，也是我人生的导师。zq教我游泳，开始只有一个理论：不要让自己太舒服，坚持，再坚持一下。在我眼中，zq非常善于与他人交流，总是很虚心地向别人请教各种人生问题。啊，zq好像知道我博客的地址……不多说了。祝愿工作顺利、身体健康、心情愉快！当然，还有妹子哈哈。zq你要看到我想说，你单身纯粹是你自己想单身，随便跟你走几百米能有三四个妹子给打招呼= =</p>
<p>扯旗呢，和扯旗认识算是因为扯旗和阿花认识，扯旗和阿花怎么认识，我怎么知道。大概是某个邪恶的北邮人游泳群。对了，一月份错过了今年，估计也是唯一一次的群聚，也算遗憾吧，考试可能只是借口，我害羞了吧。不扯远，扯旗给我的印象，就是拿着手蹼坑吃坑吃在水里拼命劳动。扯旗说：人生本来就是与大自然抗争的过程。对此，我只能弱弱地点下赞。后来，去人大，算是渐渐和扯旗熟了些。那时候他已经在某互联网公司产品经理实习，渐渐越来越忙。开始还一起去一起回，后来能周二周四见到他和他公司游泳社几个人，再后来……唉？关于扯旗有个传说：从前北邮的游泳池有个游得特别赞的女神，被扯旗拐走了= =。扯旗简直能扯，游泳群里的荔枝都叫他扯淡鱼，说起话一套一套的，救生员lt对扯旗评价甚高：扯旗这个人啊，特别能XX，特别能XX，特别能XX。我会永远记住某君把我黑上论坛十大的仇的，哼。实验室现在还有人因为扯旗嘲笑我，哼。祝工作顺利，身体健康，生活幸福！</p>
<p>彬哥某次版聚教我自由泳：怎么舒服怎么来，就这样，我给你说我们怎么游，哗——哗——哗——……不是很熟，比我高一届似乎又比较忙，只记得群里有次有人出计算所的游泳票，彬哥干脆全买下来请大家去游。虽然最后未能成行= =。</p>
<p>大概四五月份开始，工作又经过大的变动。短短几个月三次大变。开始还好，也过得简简单单随随便便。从八月开始，丧心病狂的日子开始了，甲方催得紧，身体不好，项目管理又比较乱，我觉得在浪费自己和大家的时间，另外身体不好也不愿意加班，反而更拼命游泳去了。那段日子想，干脆退学得了，这日子简直无聊。</p>
<p>还有些别扭，组长师姐、已经毕业的gx湿胸之间情谊放着，不想坑他们。</p>
<p>不过我做的事情已经传递出这么一种态度，让我滚吧= =</p>
<p>那天翔哥来这边签字什么的，下去送他去保卫处，随便谈了下。在学二十九下仰头看天上的流云，直到脖子酸掉。</p>
<p>我终于是没有退学，老师没有赶我走。</p>
<p>老师说生病了就先休息吧，到时候再回来。</p>
<p>我心软了。</p>
<p>但却似乎一下从坑中跳了出来，今后种种手忙脚乱，都与我擦肩而过。这么一档子事过后，说不清福祸。</p>
<p>那段时间，对逆向痴迷了一阵。Reverse engineer for beginner也没有看完，也算2014的一大遗憾吧。</p>
<p>从那段时间起，我开始想放弃做技术了。</p>
<p>不管怎样，我玩命的游泳去。</p>
<p>那段日子是烧钱去游泳。</p>
<p>也是玩命去游泳</p>
<p>我的支气管炎大概一个多月才彻底好。</p>
<p>对我来说，虽然是很乱的日子，也是很难忘的日子。</p>
<p>那段时间，北邮游泳馆修屋顶关闭。</p>
<p>第一天下午，先去了北师，问了下价格和办卡的方案。</p>
<p>感觉简直坑啊，想要么把北京游个遍？上网搜了下人大似乎还不错，可以办300元的十五次卡。</p>
<p>我当时是怎么想的，在群里说我要去人大。第一次认识了丹丹。我不是会表达感谢的人。虽然一直想说，谢谢。刚认识不久的日子就感冒不能下水，热心惦念着给我送了一大袋子梨。我觉得她正如她所说的：做一个温暖的人，爱身边每一个人。大概永远不会忘记狂风暴雨中一起穿越地下通道和天桥，穿过积水和淋漓的雨，穿过帝都电闪雷鸣的夜就为了去游个泳的记忆。不会忘记她在我有次跳水时加油的手势和笑容。她给我的，阳光、温暖和热情，像拨开黑夜的光芒，照亮前行的路与迟疑的心。后来开学了= =……给我发了个满是课的课程表= =……再见得就少了。希望这么温暖阳光的女孩能一直这么下去，and best bless.</p>
<p>这段日子，断断续续认识了些喜欢去游泳的朋友。涂涂、范老师、黄老师、qd等吧。</p>
<p>中途回家一次，直系亲属癌症手术，两位直系血亲罹患癌症，唉。不管怎样，大家都还拼命活着，已经很幸福了。</p>
<p>后来，实验室也不会让我闲着，做起了其它东西，但没什么甲方压力轻松自由多了。简直不想错过一天去游泳的日子，每天都去，大概是被涂涂、丹丹、范老师他们刺激了，大概由于zq的教导和扯旗的理论，终于认真学习游泳了。</p>
<p>看看topswim，问问zq，自己练练。几个救生员说，唉，没白天天来啊，蛙泳游得不错啊。渐渐和救生员熟悉了，每次去总要打个招呼开开玩笑啥的，进深水区从来不拿深水证……= =。特别是某个叫lt的救生员，总是一边用眼神往远处瞄，一边压低声音偷偷对我说，看，那个穿XX的妹子。转眼年底，ho走了，lt走了，tzp走了。祝好。</p>
<p>到此为止吧，再不回去宿舍就锁门了。其它，随风去吧。之前老妈太拼得了个肺炎，吓了一跳。转眼我自己又是毛病，回去早点休息，身体简直差。过两天还得去北医三院。</p>
<p>今天太短，明天太远。</p>
<p>短暂今天的相识相遇是我最宝贵的记忆之一。</p>
<p>2014,再见。</p>
<p>你好，2015</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2014/11/20/account-and-access-control/" itemprop="url">
                  Account and Access Control
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-11-20T00:00:00+08:00" content="2014-11-20">
              2014-11-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2014/11/20/account-and-access-control/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2014/11/20/account-and-access-control/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>传统的Unix中，一旦攻击者获得对应帐号的shell，他就能执行该账户所能行使的任何行为，存取该账户能存取的任何文件。因此，让未授权的人获得指定帐号shell更加困难(特别是对权限账户)，是系统安全重要的部分。本文介绍如何引入限制账户登录的机制。</p>
<h2 id="限制基于密码的登录来保护账户">限制基于密码的登录来保护账户</h2><p>传统Unix账户通过提供用户名和密码登录，这些用户名和密码会和储存在<code>/etc/passwd</code>和<code>/etc/shadow</code>中的内容对比。密码登录可能被被猜测，被嗅探，被中间人截取，无论是从网络还是不安全的控制台中。因此，限制账户密码登录的机制很重要。</p>
<h3 id="限制root只能在系统控制台登录">限制root只能在系统控制台登录</h3><p>编辑<code>/etc/securetty</code>，确保只有以下行：</p>
<ul>
<li><p>基本的系统控制台设备：</p>
<pre><code><span class="built_in">console</span>
</code></pre></li>
<li><p>虚拟控制台设备</p>
<pre><code>tty1
tty2
tty3
tty4
...
</code></pre></li>
<li><p>如果需要，保留这些废弃的控制台接口来保留向后兼容。</p>
<pre><code>vc/<span class="number">1</span>
vc/<span class="number">2</span>
...
</code></pre></li>
<li><p>如果需要，添加串口控制台：</p>
<pre><code><span class="title">ttyS0</span>
ttyS1
</code></pre></li>
</ul>
<p>仅在紧急情况下才允许root直接登录。通常，管理员可以通过唯一的非权限用户使用<code>su</code>或者<code>sudo</code>来执行权限命令。不鼓励管理员直接使用root用户有助于对多管理员系统的审计工作。减少root能直接连接的通道减少了root密码被猜解的几率。</p>
<p><code>login</code>程序使用<code>/etc/securetty</code>确定哪些接口允许root登录。虚拟设备<code>/dev/console</code>和<code>/dev/tty*</code>代表系统控制台(通过<code>Ctrl-Alt-F1</code>等打开)。默认的<code>securetty</code>文件也包含<code>/dev/vc/*</code>，来保留历史兼容性。</p>
<p>root用户也应该禁止通过网络协议登录。本文暂不讨论。</p>
<h3 id="限制su到root账户">限制su到root账户</h3><p>确保组<code>wheel</code>存在，所有持有root权限的管理员用户名作为其中的组员。</p>
<pre><code><span class="keyword">grep</span> ^wheel <span class="regexp">/etc/g</span>roup
</code></pre><p>编辑文件<code>/etc/pam.d/su</code>，添加、注释或者更改该行：</p>
<pre><code>auth    required    pam_wheel<span class="class">.so</span>    use_uid
</code></pre><p><code>su</code>命令允许用户从其它用户通过输入密码获得权限。因此限制已知管理员使用root是必要的。一般<code>wheel</code>用户组包含允许运行权限命令的全部用户。PAM模块<code>pam_wheel.so</code>被用来限制一组用户的接入。</p>
<h3 id="配置sudo改善对root访问的审计">配置sudo改善对root访问的审计</h3><p>确保<code>wheel</code>存在，所有持有root权限的管理员用户名作为其中的组员。</p>
<pre><code><span class="keyword">grep</span> ^wheel <span class="regexp">/etc/g</span>roup
</code></pre><p>编辑<code>/etc/sudoers</code>，添加、取消注释或者更改如下行：</p>
<pre><code>%wheel  <span class="built_in">ALL</span>=(<span class="built_in">ALL</span>)   <span class="built_in">ALL</span>
</code></pre><p><code>sudo</code>能很好的控制哪个用户能用其它账户执行命令。这为每个权限用户执行的命令提供了审计可能。也许恶意管理员会绕过这个限制，但这个机制保证审计更容易。</p>
<p>手工编辑<code>/etc/sudoer</code>很危险，配置错误也许会禁用远程root访问。推荐的方式是用<code>visudo</code>命令编辑这个文件，该命令会在保存前检查文件语法。</p>
<p>权衡sudo带来的审计好处和安全风险。永远不要使用<code>NOPASSWD</code>指令，这会允许任何获取管理员账户的人在不知管理员密码的情况下以root身份执行命令。</p>
<p>更多定制参见<code>sudoers</code> man页面</p>
<h3 id="禁止非root系统账户登录和使用shell">禁止非root系统账户登录和使用shell</h3><p>！！！！！！！！注意：不要对root执行以下配置</p>
<p>使用一下命令查看<code>/etc/passwd</code></p>
<pre><code>awk -F: '{<span class="literal">print</span> <span class="variable">$1</span> <span class="string">":"</span> <span class="variable">$3</span> <span class="string">":"</span> <span class="variable">$7</span>}' /etc/passwd
</code></pre><p>找到那些UID低于500(系统账户)，不是root的账户：</p>
<p>对每个系统账户<code>SYSACCT</code>，锁定：</p>
<pre><code><span class="title">usermod</span> -L SYSACCT
</code></pre><p>禁用它们的shell：</p>
<pre><code>usermod <span class="operator">-s</span> /sbin/nologin SYSACCT
</code></pre><h3 id="确认密码被适当存储和哈希">确认密码被适当存储和哈希</h3><h4 id="确保没有账户有空密码">确保没有账户有空密码</h4><p>使用以下命令查看：</p>
<pre><code>awk -<span class="string">F:</span> <span class="string">'($2 == "") {print}'</span> <span class="regexp">/etc/</span>shadow
</code></pre><p>如果有输出，检查这些账户并设置密码。</p>
<h4 id="确保所有账户密码哈希都被shadow">确保所有账户密码哈希都被shadow</h4><p>确保没有在<code>/etc/passwd</code>中保存密码哈希：</p>
<pre><code>awk -<span class="string">F:</span> <span class="string">'($2 != "x") {print}'</span> <span class="regexp">/etc/</span>passwd
</code></pre><p>这个命令应该没有输出，所有密码哈希应该保存在<code>/etc/shadow</code>而不是所有用户都能读的<code>/etc/passwd</code></p>
<h3 id="确认没有非root用户的UID为0">确认没有非root用户的UID为0</h3><p>列出所有UID为0的用户：</p>
<pre><code>awk -<span class="string">F:</span> <span class="string">'($3 == "0") {print}'</span> <span class="regexp">/etc/</span>passwd
</code></pre><p>通常，最好的审计实践是所有root账户的使用都限制到使用su或这sudo。有些站点使用多个管理员拥有UID 0，这种做法可能有意料外的副作用，并不推荐。</p>
<h3 id="设置密码过期参数">设置密码过期参数</h3><p>编辑<code>/etc/login.defs</code>指定某个新账户的密码过期时间。添加或修改如下行：</p>
<pre><code>PASS_MAX_DAYS <span class="number">60</span>
PASS_MIN_DAYS <span class="number">7</span>
PASS_MIN_LEN <span class="number">14</span>
PASS_WARN_AGE <span class="number">7</span>
</code></pre><p>对已经存在的人类用户<code>USER</code>，更改当前过期设置如下：</p>
<pre><code>chage -M <span class="number">60</span> -m <span class="number">7</span> -W <span class="number">7</span> USER
</code></pre><p>更改密码要在稳定性和安全性之间权衡，90到360天比较推荐。</p>
<h4 id="从libuser-conf移除密码参数">从libuser.conf移除密码参数</h4><p>确保<code>/etc/libuser.conf</code>在<code>[import]</code>节包含：</p>
<pre><code>login_defs = <span class="regexp">/etc/login</span>.defs
</code></pre><p>同时确保在<code>[userdefaults]</code>下没有以下单词开头的行，这些设定会覆盖<code>/etc/log   in.defs</code>的设定：</p>
<pre><code><span class="title">LU_SHADOWMAX</span>
LU_SHADOWMIN
LU_SHADOWWARNING
</code></pre><p><code>/etc/libuser.conf</code>文件包含libuser库的配置选项，这个库提供了一套操作和管理用户和组帐号的标准接口。默认情况下从<code>/etc/login.defs</code>读取密码设置，但是<code>/etc/libuser.conf</code>能覆盖这些参数。查看<code>libuser.conf</code>的man页面获取更多信息。</p>
<h3 id="移除密码文件中遗留的+条目">移除密码文件中遗留的+条目</h3><p>用一下命令找到这些行：</p>
<pre><code><span class="keyword">grep</span> <span class="string">"^+:"</span> <span class="regexp">/etc/</span>passwd <span class="regexp">/etc/</span>shadow <span class="regexp">/etc/g</span>roup
</code></pre><p>确保没有输出。</p>
<p><code>+</code>被用来将来自NIS的数据映射到已知文件。一个<code>/etc/passwd</code>中NIS包含错误，但NIS没有运行会导致任意用户以<code>+</code>用户名免密码访问。</p>
<p>告诉本地系统使用网络数据库，比如LDAP或NIS，来获取用户信息的正确的方式是确保在<code>/etc/nsswitch.conf</code>中适当的配置。</p>
<h2 id="通过Unix组来加强安全">通过Unix组来加强安全</h2><p>通过标准Unix权限的访问控制很弱，但也可以利用。</p>
<h3 id="为每个账户创建一个唯一默认组">为每个账户创建一个唯一默认组</h3><p>当使用<code>useradd</code>命令时，不要使用<code>-g</code>参数覆盖默认组。</p>
<p>RedHat默认为每个用户创建相同名称的唯一所属组。推荐这样，保护组写权限的文件。</p>
<h3 id="创建和维护包含所有人类账户的组">创建和维护包含所有人类账户的组</h3><p>找到系统上所有人类用户，比如UID大于500的，一旦确认，创建一个<code>usergroup</code>组，并且把每个人类账户加进去：</p>
<pre><code>groupadd usergroup
usermod -G usergroup huma<span class="label">n1</span>
usermod -G usergroup huma<span class="label">n2</span>
usermod -G usergroup huma<span class="label">n3</span>
usermod -G usergroup huma<span class="label">n4</span>
</code></pre><p>当用<code>useradd</code>添加新用户时，用<code>-G usergroup</code>将人类账户添加到改组。</p>
<p>这样做便于管理人类用户，比如为<code>/path/to/graphical/command</code>授权用户：</p>
<pre><code>chgrp usergroup /path/<span class="built_in">to</span>/graphical/<span class="command"><span class="keyword">command</span></span>
chmod <span class="number">750</span> /path/<span class="built_in">to</span>/graphical/<span class="command"><span class="keyword">command</span></span>
</code></pre><p>同时，限制非人类系统账户执行命令也非常重要。</p>
<h2 id="通过配置PAM保护帐号">通过配置PAM保护帐号</h2><p>PAM，可插拔认证模块是为linux程序提供认证的模块。PAM是一个框架，提供可配置的系统认证架构来最小化系统所面对的风险。</p>
<p>PAM被作为一套动态共享库实现，在任何应用程序想认证用户的时候被加载和调用。通常为了使用PAM应用程序需要以root运行，传统的权限网络监听比如sshd和SUID程序比如sudo已经满足了这个要求。一个叫做<code>userhelper</code>的SUID root应用被用来为没有SUID或权限的程序提供利用PAM的可能。</p>
<p>PAM在<code>/etc/pam.d/</code>下搜寻应用特异的配置信息。比如对<code>login</code>程序，PAM库会遵循<code>/etc/pam.d/login</code>中的指示。</p>
<p>一个非常重要的文件是<code>/etc/pam.d/system-auth</code>。这个文件被许多其它文件包含(奇怪的是从RHEL6开始sshd只包含<code>/etc/pam.d/password-auth</code>)，作为默认的系统认证措施，更改这个文件能确保全面的更改。</p>
<p>更改PAM的配置要十分小心，语法很复杂，更改可能有意料外的结果。默认配置对大多数用户足够了。</p>
<p>注意！！！！！！！！！！：运行<code>authconfig</code>或者<code>system-config-authentication</code>将覆盖PAM配置文件，摧毁任何手动的更改，将其覆盖成系统默认。</p>
<h3 id="设定密码质量要求">设定密码质量要求</h3><p>默认的PAM模块<code>pam_cracklib</code>提供了加强的密码检查。它可以执行一系列检查包含字典单词的相似，最小长度，不是之前的密码，不是之前密码的简单大小写修改等。也能要求密码包含特定类型的字符。</p>
<p><code>pam_passwdqc</code>模块提供了更严格的密码强度强制要求。可通过RPM包下载。</p>
<h4 id="如果使用pam_cracklib,设置密码质量需求">如果使用pam_cracklib,设置密码质量需求</h4><p>用<code>pam_cracklib</code>配置密码至少包含一个大写、小写、数字和其它字符，定位<code>/etc/pam.d/system-auth</code>中的一下行：</p>
<pre><code>password requisite pam_cracklib<span class="class">.so</span> retry=<span class="number">3</span>
</code></pre><p>更改为(呵呵，required意指即使失败仍然会继续后面required的模块验证，然后在返回错误，让用户不知道哪里出的问题)</p>
<pre><code>password required pam_cracklib.so retry=<span class="number">3</span> minlen=<span class="number">14</span> \
                    dcredit=-<span class="number">1</span>, ucredit=-<span class="number">1</span> ocredit=-<span class="number">1</span> lcredit=-<span class="number">1</span>
</code></pre><p>如果必要，更改为符合你要求的配置。</p>
<h4 id="如果使用pam_passwdqc,设置密码质量需求">如果使用pam_passwdqc,设置密码质量需求</h4><p>如果需要比<code>pam_cracklib</code>保证的密码强度更强，使用<code>pam_passwdqc</code>模块。</p>
<p>更改<code>/etc/pam.d/system-auth</code>中的如下行：</p>
<pre><code>password requisite pam_cracklib<span class="class">.so</span> retry=<span class="number">3</span>
</code></pre><p>为(呵呵，这个直接requisite，只要不符合要求PAM就直接返回错误了)<br>    password requisite pam_passwdqc.so min=disabled,disabled,16,12,8</p>
<p>按自己需要配置。</p>
<h3 id="设置失败密码尝试锁定">设置失败密码尝试锁定</h3><p>使用<code>pam_tally2.so</code>模块来实现一定数量错误登录尝试后锁定账户。在<code>/etc/pam.d/system-auth</code>中添加到第一个auth开头的行上头(呵呵，RHEL6后<code>/etc/pam.d/sshd</code>包含的是<code>/etc/pam.d/password-auth</code>而不是<code>/etc/pam.d/system-auth</code>，所以，对ssh登录尝试锁定应该是对<code>password-auth</code>这个文件更改。)</p>
<pre><code>auth required pam_tally2.so deny=<span class="number">5</span> onerr=fail unlock_time=<span class="number">900</span>
</code></pre><p>在account开头的行上头加上一行：</p>
<pre><code><span class="tag">account</span> <span class="tag">required</span> <span class="tag">pam_tally2</span><span class="class">.so</span>
</code></pre><p>root要单独设置<code>root_unlock_time=900</code></p>
<p>要解锁用户使用<code>pam_tally2</code>命令</p>
<pre><code>/sbin/pam_tally2 --<span class="keyword">user</span> <span class="title">username</span> --reset
</code></pre><p>锁定用户造成潜在的DOS攻击，但能阻止密码猜解。权衡利弊设置<code>unlock_time</code></p>
<h3 id="使用pam_deny-so快速禁止访问服务">使用pam_deny.so快速禁止访问服务</h3><p>通过PAM阻止服务SVCNAME的访问，编辑<code>/etc/pam.d/SVCNAME</code>文件，添加这一行：</p>
<pre><code><span class="tag">auth</span>    <span class="tag">requisite</span>   <span class="tag">pam_deny</span><span class="class">.so</span>
</code></pre><p>这不是啥值得推荐的方法，不过挺方便，呵呵。</p>
<h3 id="仅控制台用户执行userhelper">仅控制台用户执行userhelper</h3><p>如果你的环境定义了一个组<code>usergroup</code>包含所有系统上的人类用户，限制<code>userhelper</code>程序只能由这些用户执行。(4710中的4表示suid/guid)</p>
<pre><code>chgrp usergroup <span class="regexp">/usr/</span>sbin/userhelper
chmod <span class="number">4710</span> <span class="regexp">/usr/</span>sbin/userhelper
</code></pre><p><code>userhelper</code>程序提供必须以root运行的图形服务认证，比如<code>system-config-</code>族图形配置程序。只有登录到系统控制台的人类用户可以运行这些。以上提供了一定对<code>userhelper</code>实现缺陷的保护，防止被侵入的系统账户进一步提权。</p>
<p><code>userhelper</code>程序在<code>/etc/securetty/console.app/</code>下的文件配置。每个文件指定了程序以什么身份运行，成功认证后应该执行什么。</p>
<p>注意：这些配置和PAM的配置<code>/etc/pam.d</code>下的配置相配合才能起作用。首先<code>userhelper</code>决定服务应该以什么身份运行(比如root)，然后<code>userhelper</code>使用PAM API来允许运行程序的用户尝试认证为想要借身份运行的用户。PAM的API交互被封装在GUI中，如果程序配置要求的话。</p>
<h3 id="升级密码哈希算法到SHA-512">升级密码哈希算法到SHA-512</h3><p>需要编辑3个文件：</p>
<p>首先<code>/etc/pam.d/system-auth</code>中确保sha512被<code>pam_unix.so</code>模块在password节使用。而不是使用其它算法：(可能得改password-auth)</p>
<pre><code>password sufficient pam_unix<span class="class">.so</span> sha512 shadow nullok try_first_pass use_authtok
</code></pre><p>其次，编辑文件<code>/etc/login.defs</code>添加或更改以下行(确认下就好)：</p>
<pre><code><span class="title">ENCRYPT_METHOD</span> SHA512
</code></pre><p>最后，编辑<code>/etc/libuser.conf</code>添加或更改以下行：</p>
<pre><code><span class="attribute">crypt_style</span>=<span class="string">sha512</span>
</code></pre><p>其实吧，这是RHEL6的默认配置，呵呵。</p>
<h3 id="限制密码重用">限制密码重用</h3><p><code>pam_unix</code>模块使用<code>remember</code>参数可以防止用户重用最近的密码。为了阻止用户使用最近5次的密码，向<code>/etc/pam.d/system-auth</code>文件中，使用<code>pam_unix</code>模块的<code>password</code>行添加<code>remember=5</code>参数。</p>
<p>旧的密码(禁止重用的)保存在<code>/etc/security/opasswd</code>中。</p>
<h3 id="尽可能移除pam_crreds包">尽可能移除pam_crreds包</h3><p>除非用到认证缓存功能，移除<code>pam_ccreds</code>包：</p>
<pre><code>yum <span class="built_in">erase</span> pam_ccreds
</code></pre><p>该包包含setuid文件<code>/usr/sbin/ccreds_validate</code>。如果系统被入侵，任何系统上缓存的认证信息都会被获取。</p>
<h2 id="对登录用户使用安全会话配置文件">对登录用户使用安全会话配置文件</h2><p>当一个用户登录进Unix账户时，系统通过读取大量文件配置用户会话。许多这些文件在家目录下。错误或者不当的配置都会造成弱权限。攻击者可以修改甚至读取特定类型的账户信息，对受影响的账户获得全面的访问权限。因此，额是和修正账户特别是权限账户的配置文件权限非常重要。</p>
<h3 id="确保Root_PATH不存在危险目录">确保Root PATH不存在危险目录</h3><p>登录一个root shell运行：</p>
<pre><code>echo <span class="variable">$PATH</span>
</code></pre><p>将给出冒号分隔的文件夹路径。</p>
<p>防止root执行未知或者不受信任的程序很重要，这些程序可能带有恶意代码。因此，root不应该运行非权限用户安装的程序。root经常工作在不受信任的目录，比如<code>.</code>代表的当前目录总不该出现在root的PATH中，任何非权限用户或系统用户能写入的目录都是如此。</p>
<p>对系统管理员来说，总是打出命令的绝对路径是个好习惯。</p>
<h4 id="确保Root_PATH不包含相对路径或者空目录">确保Root PATH不包含相对路径或者空目录</h4><p>对每个路径中的目录<code>DIR</code>，确保<code>DIR</code>不是一个单一的<code>.</code>，或者任何可能导致相对路径遍历的符号比如<code>..</code>，或者不是以<code>/</code>开头。同时，确保路径中没有空元素，如下：</p>
<pre><code><span class="constant">PATH=</span><span class="symbol">:/bin</span>
<span class="constant">PATH=</span>/<span class="symbol">bin:</span>
<span class="constant">PATH=</span>/<span class="symbol">bin:</span><span class="symbol">:/sbin</span>
</code></pre><p>这些空元素和一个<code>.</code>有相同效果。</p>
<p>我觉得这样比较方便：</p>
<pre><code>echo <span class="variable">$PATH</span> | awk -F: <span class="string">'{for(i=1;i&lt;NF;i++) print $i}'</span>
</code></pre><h4 id="确保ROOT路径不包含全局可写或组可写的目录">确保ROOT路径不包含全局可写或组可写的目录</h4><p>对PATH中的每一个元素，执行：</p>
<pre><code><span class="keyword">ls</span> -ld <span class="keyword">DIR</span>
</code></pre><p>确保组和其它的写权限被禁用。</p>
<p>我觉得这样比较好：</p>
<pre><code>ls -ld `echo <span class="variable">$PATH</span> | awk -F: <span class="string">'{for(i=1;i&lt;NF;i++) print $i}'</span>`
</code></pre><h3 id="确保用户家目录不是组可写或者全局可读的">确保用户家目录不是组可写或者全局可读的</h3><p>首先通知你的用户。</p>
<p>对每个人类账户<code>USER</code>，查看账户权限：</p>
<pre><code>ls -<span class="keyword">ld</span> /home/USER
</code></pre><p>确保目录不是组可写和全局可读的，必要时修正：</p>
<pre><code>chmod g-w /home/<span class="keyword">USER</span>
<span class="title">chmod</span> o-rwx /home/USER
</code></pre><p>家目录包含许多影响账户行为的配置，其它用户不该有权限写入。组共享目录应该在子目录或者其它什么地方而不是家目录。通常，家目录也不该全局可读。如果有一小撮用户非得读取其它用户目录，通过组来提供权限。</p>
<h3 id="确保用户dot文件不是全局可写">确保用户dot文件不是全局可写</h3><p>确保用户USER家目录下的dot文件不是全局可写：</p>
<pre><code>ls -ld /home/<span class="keyword">USER</span> <span class="title">/.[A-Za-z0-9</span>]*
</code></pre><p>确保任何文件都不是组或全局可写的。通过以下方式修正某个<code>FILE</code>：</p>
<pre><code>chmod go-w /home/USER/<span class="keyword">FILE</span>
</code></pre><p>能更改其它用户配置文件的用户可能以那个用户权限执行命令，窃取数据，摧毁文件或者发起进一步攻击。</p>
<h3 id="确保用户有合理的umask值">确保用户有合理的umask值</h3><p>编辑全局配置<code>/etc/profile</code>,<code>/etc/bashrc</code>和<code>/etc/csh.cshrc</code>.添加或修改以下行:</p>
<pre><code><span class="built_in">umask</span> <span class="number">077</span>
</code></pre><p>其实profile里看是不是uid大于200且有效组名等于用户名,则设为002(目录775，文件644).否则设为022(目录755，文件644).</p>
<p>编辑<code>/etc/login.defs</code>:</p>
<pre><code>UMASK   <span class="number">077</span>
</code></pre><p>查看<code>/etc/csh.login</code>和<code>/etc/profile.d/*</code>中的其它文件，确保没有重定义umask。除非有什么好的理由重定义umask。</p>
<pre><code><span class="keyword">grep</span> -r umask <span class="regexp">/etc/</span>profile <span class="regexp">/etc/</span>csh.* <span class="regexp">/etc/</span>bashrc <span class="regexp">/etc/</span>login.defs
</code></pre><p>编辑root shell的配置文件<code>/root/.bashrc</code>和<code>/root/.bash_profile</code>,<code>/root/.cshrc</code>，<code>/root/.tcshrc</code>。添加或修改以下行：</p>
<pre><code><span class="built_in">umask</span> <span class="number">077</span>
</code></pre><p>这样做确保任何用户创建的文件不会被其它用户读写与执行。如果有特殊需要，则使用<code>chmod</code>命令修改它。单个用户可以通过将umask设为<code>027</code>让其所在组用户能读和执行其文件。用户名和默认组一致，完全可以直接设成<code>007</code>来与组成员共享文件。</p>
<p>另外，暂时更改root 的umask来安装能让其它用户读取的软件或文件，或者修改特定服务帐号的umask默认设定的行为，都是必要的。但严格的默认限制能更好的保护意外泄漏。</p>
<h3 id="确保用户没有-netrc文件">确保用户没有.netrc文件</h3><p>对每个人类用户<code>USER</code>，确保没有用户有<code>.netrc</code>文件。</p>
<pre><code><span class="built_in">find</span> /home -<span class="built_in">name</span> .netrc
</code></pre><p>应该没有返回。如果有联系用户讨论删除事宜。</p>
<p><code>.netrc</code>是用来通过ftp无人登录到其它系统的配置文件。这个文件通常包含攻击其它系统未加密的密码。</p>
<h2 id="保护物理控制台访问">保护物理控制台访问</h2><p>不大可能保护系统免于物理接触攻击。有些步骤能让攻击者更加难以快速和不被发现地从控制台更改系统。</p>
<h3 id="设置BIOS密码">设置BIOS密码</h3><p>x86系统的BIOS是机器首先运行代码的地方，控制着许多非常重要的系统参数，包含系统从哪个设备以什么顺序启动的信息。</p>
<p>为BIOS配置设置密码防止修改。尽管物理接触的攻击者通常很容易清除密码。</p>
<h3 id="设置Boot_Loader密码">设置Boot Loader密码</h3><p>Boot Loader通常负责启动内核并把参数传递给它。boot loader允许选择多个分区或者介质上的不同内核，能传递给内核的参数包括单用户模式(提供无需认证的root访问)，禁用SELinux。阻止本地用户更改启动参数。为防止本地用户更改启动参数危害安全，启动器配置需要用密码保护：</p>
<p>Grub这样保护：</p>
<p>运行<code>grub-md5-crypt</code>得到md5后的哈希<code>password-hash</code></p>
<p>在<code>/etc/grub.conf</code>注释头下第一行添加：</p>
<pre><code>password <span class="comment">--md5 password-hash</span>
</code></pre><p>确保<code>/etc/grub.conf</code>的权限。(指向<code>../boot/grub/grub.conf</code>)</p>
<pre><code>chown <span class="string">root:</span>root <span class="regexp">/etc/</span>grub.conf
chmod <span class="number">600</span> <span class="regexp">/etc/</span>grub.conf
</code></pre><p>其它boot loader有类似的密码保护特性。</p>
<h3 id="要求单用户模式登录认证">要求单用户模式登录认证</h3><p>单用户模式被设计用来回复系统，通过启动选项给单用户root权限。默认情况下不需要认证，这造成了安全隐患。</p>
<p>即使以单用户模式启动，也要求输入root密码。在<code>/etc/sysconfig/init</code>文件中更改：</p>
<pre><code>sed -i 's/SINGLE=<span class="command">\/</span>sbin<span class="command">\/</span>sushell/SINGLE=<span class="command">\/</span>sbin<span class="command">\/</span>sulogin/' /etc/sysconfig/init
</code></pre><h3 id="禁用交互式启动">禁用交互式启动</h3><p>编辑<code>/etc/sysconfig/init</code>。添加或更改设置：</p>
<pre><code>sed -<span class="tag">i</span> <span class="string">'s/^PROMPT.*/PROMPT=no/g'</span> /etc/sysconfig/init
</code></pre><p>交互式启动，用户也许能禁用审计、防火墙和其它服务弱化系统安全。</p>
<h3 id="对登录shell实现不活动超时">对登录shell实现不活动超时</h3><p>如果系统不运行X windows，登录shell可以配置为一段时间不活动自动登出用户。以下指令对运行X Windows的系统不合适，因为这将自动(深有体会！！)关闭X环境下的终端。</p>
<p>针对<code>/bin/bash</code>，实现一个15分钟的空闲超时，在目录<code>/etc/profile.d/</code>下新建文件<code>tmout.sh</code>，写入如下行：</p>
<pre><code>TMOUT=<span class="number">900</span>
<span class="built_in">readonly</span> TMOUT
<span class="built_in">export</span> TMOUT
</code></pre><p>对<code>tcsh</code>，在<code>/etc/profile.d/</code>下新建<code>autologout.sh</code>，添加如下行：</p>
<pre><code><span class="built_in">set</span> -r autologout <span class="number">15</span>
</code></pre><p>其它登录shell应该类似。</p>
<p>仅仅在shell是前台进程时才会自动登录超时。比如，一个<code>vi</code>会话空闲着并不会自动超时登出。</p>
<p>当通过远程连接时，比如SSH，通过该服务设置超时更加有效。</p>
<h3 id="配置锁屏">配置锁屏</h3><p>一个是图形界面的锁屏(比如kde的Lock Screen)，一个是控制台(vlock)。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2014/11/18/file-permissions-and-masks/" itemprop="url">
                  File Permissions and Masks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-11-18T00:00:00+08:00" content="2014-11-18">
              2014-11-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2014/11/18/file-permissions-and-masks/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2014/11/18/file-permissions-and-masks/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>传统Unix安全强烈依赖文件和目录权限来阻止非授权用户读取或更改它们不该存取的文件。根据最小权限原则，配置每个文件，目录和文件系统，只允许必要的存取。</p>
<p>但linux系统有很多文件……本部分适用于系统安全的一些易于更改和测试，且几乎总是适用的权限限制。</p>
<p>注意：以下有些命令搜索文件系统中包含特定字符的文件和目录，这些命令应该在每个<code>ext2</code>或<code>ext3</code>分区上运行。当<code>PART</code>出现在以下某个命令中，表示这个命令应该在每个分区重复运行一次。</p>
<p>以下命令打印给定机器上所有ext2和ext3命令：</p>
<pre><code><span class="title">mount</span> -t ext2,ext3 | awk <span class="string">'{print <span class="variable">$3</span>}'</span>
</code></pre><p>如果用了其它分区类型，更改<code>-t</code>参数。</p>
<h2 id="限制分区挂载参数">限制分区挂载参数</h2><p>系统分区挂载时能指定参数，限制分区上文件能做什么。这些参数在<code>/etc/fstab</code>中设置，这些措施能让特定类型的恶意行为更加困难。</p>
<h3 id="想非Root分区添加nodev选项">想非Root分区添加nodev选项</h3><p>编辑<code>/etc/fstab</code>，我们关注列2(挂载点),3(文件系统类型),4(挂载参数)。给所有满足下列条件的行：</p>
<ul>
<li>文件系统是<code>ext2</code>或<code>ext3</code></li>
<li>挂载点不是<code>/</code></li>
</ul>
<p>在列4添加<code>,nodev</code>。</p>
<p><code>nodev</code>参数防止用户在任何不该挂载设备的分区上挂载设备。只有<code>/dev</code>应该挂载设备，所以不要在<code>/</code>上设置这个参数。</p>
<p>然而，如果系统程序在<code>chroot jail</code>中运行，需要在<code>chroot</code>文件夹内创建设备文件，这个建议就不这么适用。</p>
<h3 id="向可以出存储分区添加nodev，nosuid和noexec选项">向可以出存储分区添加nodev，nosuid和noexec选项</h3><p>编辑<code>/etc/fstab</code>，如果行中包含<code>floppy</code>或者<code>cdrom</code>字样就说明这些是可移除媒体的文件系统。</p>
<p>对其中每个找到的挂载点，在列4添加<code>noexec,nodev,nosuid</code>参数。</p>
<p>挂载到可移除介质的文件系统也为恶意可执行文件提供了潜在的进入系统方式，因此应该用最小权限挂载。用户不能引入任意设备或者suid程序。另外<code>noexec</code>禁止用户直接在可移除介质上运行程序，这能阻止一些特殊蠕虫和恶意代码。</p>
<p><code>/etc/fstab</code>上的挂载点也许在某些典型硬件的现代系统上不存在。动态挂载机制需要通过其它方式控制(也许可以也许不能控制挂载选项)。如果你需要在可移动介质中执行什么，就别加<code>noexec</code>.</p>
<h3 id="向临时存储分区添加nodev，nosuid和noexec参数">向临时存储分区添加nodev，nosuid和noexec参数</h3><p>临时存储分区比如<code>/tmp</code>和<code>/dev/shm</code>为恶意程序执行提供了潜在存储空间。尽管添加这些参数不能防止其它分区的程序解释存储在这些分区的代码，但对某些恶意代码也有作用。</p>
<p>编辑<code>/etc/fstab</code>，向列4添加<code>,nodev,nosuid,noexec</code>。</p>
<h3 id="绑定挂载/var/tmp到/tmp">绑定挂载/var/tmp到/tmp</h3><p>编辑<code>/etc/fstab</code>，添加以下行：</p>
<pre><code>/tmp    /var/tmp    none    rw,noexec,nosuid,nodev,bind <span class="number">0</span> <span class="number">0</span>
</code></pre><p>这一行绑定挂载任何人都可写的<code>/var/tmp</code>目录到<code>/tmp</code>，使用用上文中用的选项。参见mount的man页面获取更多关于绑定挂载的信息。</p>
<h2 id="限制动态挂载和卸载文件系统">限制动态挂载和卸载文件系统</h2><p>linux系统提供了各种措施自动增加和删除运行系统的文件系统，这些措施很方便，也带来了诸如允许非授权用户引入任意文件系统或者，软件自动挂载措施的缺陷允许攻击者侵入系统。</p>
<p>使用这些措施的时候要十分小心，找到更好的配置管理方式和实行用户教育可能减少风险。</p>
<h3 id="限制控制台设备接入">限制控制台设备接入</h3><p>默认系统配置批准控制台用户提升到root用户权限，包括暂时拥有大部分系统设备。如果不必要，禁用这个权限，限制到root。</p>
<p>将设备所有者限定到root</p>
<p>(RHEL6)中并无这些，神奇的消失了。Removed references to 50-default.perms, since this file was removed in Red Hat Enterprise Linux 6, per Bugzilla 630524.</p>
<h3 id="禁用USB设备支持">禁用USB设备支持</h3><p>USB闪存或硬盘可能为攻击者物理接触系统拷贝大量数据提供便利。</p>
<h4 id="禁止内核加载USB存储驱动">禁止内核加载USB存储驱动</h4><p>如果不让用USB设备，<code>modprobe</code>程序应该被设置为不自动加载USB存储驱动。</p>
<pre><code><span class="id">#vi</span> /etc/modprobe.d/no-usb<span class="class">.conf</span>                           <span class="id">#Create</span> this file <span class="keyword">if</span> it doesn’t exist
install usb-storage /bin/true                             <span class="hexcolor">#Add</span> this line
:wq!
</code></pre><p>这可以禁止modprobe加载usb-storage模块，但无法阻止管理员或其它程序使用insmod来加载模块。</p>
<h4 id="移除USB存储驱动">移除USB存储驱动</h4><p>如果根本不需要使用USB存储设备，内核驱动就可以删除。</p>
<pre><code>rm /<span class="class"><span class="keyword">lib</span>/<span class="title">modules</span>/<span class="title">kernelversion</span>(<span class="title">s</span>) /<span class="title">kernel</span>/<span class="title">drivers</span>/<span class="title">usb</span>/<span class="title">storage</span>/<span class="title">usb</span>-<span class="title">storage</span>.<span class="title">ko</span></span>
</code></pre><p>每次更新内核后都要运行这个命令。<code>rpm -q --verify kernel</code>也会失败，不好的副作用。</p>
<p>注意，如果一个带有usb驱动的自制内核被使用，该方法并不能防止USB存储设备被挂载。</p>
<h4 id="在启动时禁用对USB的内核支持">在启动时禁用对USB的内核支持</h4><p>在内核启动参数中加入<code>nousb</code>参数</p>
<p>注意！！！！！！！！！！！：这会让usb外接键盘鼠标打印机等设备无法使用。</p>
<p>在<code>/etc/grub.conf</code>中加入<code>nousb</code>参数：</p>
<pre><code>kernel <span class="regexp">/vmlinuz-version ro vga=ext root=/</span>dev<span class="regexp">/VolGroup00/</span>LogVol00 rhgb quiet nousb
</code></pre><h4 id="禁止从USB设备启动">禁止从USB设备启动</h4><p>配置BIOS禁止从USB启动，设置BIOS或固件密码防止非授权的更改配置。</p>
<h3 id="尽量禁用自动挂载">尽量禁用自动挂载</h3><p>如果<code>autofs</code>服务不是必要的，比如挂载NFS文件系统或可移动介质，禁用该服务。</p>
<pre><code><span class="title">chkconfig</span> autofs <span class="built_in">off</span>
</code></pre><p>其实用autofs自动挂载可移动介质也不常见，如果不用NFS就禁用服务。</p>
<p>就算需要NFS，近乎总是可能在<code>/etc/fstab</code>配置静态文件系统挂载，而不是依靠自动挂载。</p>
<h3 id="尽量禁用gnome自动挂载">尽量禁用gnome自动挂载</h3><p>略</p>
<h3 id="禁止挂载不常见文件系统类型">禁止挂载不常见文件系统类型</h3><p>在<code>/etc/modprobe.d/</code>下随意建个文件比如<code>uncomman_fs.conf</code>:</p>
<pre><code><span class="operator"><span class="keyword">install</span> cramfs /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> freevxfs /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> jffs2 /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> hfs /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> hfsplus /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> squashfs /<span class="keyword">bin</span>/<span class="literal">true</span>
<span class="keyword">install</span> udf /<span class="keyword">bin</span>/<span class="literal">true</span></span>
</code></pre><h3 id="尽可能禁用所有Gnome缩略图">尽可能禁用所有Gnome缩略图</h3><h2 id="确认重要文件和目录权限">确认重要文件和目录权限</h2><p>讨论了需要日常检查以确保没有有害的差异发生。</p>
<h3 id="确认passwd，shadow，group和gshadow文件的权限">确认passwd，shadow，group和gshadow文件的权限</h3><pre><code>cd /etc
chown root:root passwd shadow <span class="keyword">group</span> <span class="title">gshadow</span>
chmod <span class="number">644</span> passwd <span class="keyword">group</span>
<span class="title">chmod</span> <span class="number">400</span> shadow gshadow
</code></pre><p>一般这是默认情况。</p>
<h3 id="确认所有全局可写的目录设置sticky位">确认所有全局可写的目录设置sticky位</h3><p>找到所有本地分区上全局可写但未设置sticky位的文件夹。以下命令可以用来查找，其中<code>PART</code>是指定分区：</p>
<pre><code><span class="built_in">find</span> PART -xdev -<span class="built_in">type</span> d \( -perm -<span class="number">0002</span> -a ! -perm -<span class="number">1000</span> \) -<span class="built_in">print</span>
</code></pre><p>如果有任何输出目录<code>/dir</code>，用以下命令更改：</p>
<pre><code>chmod +t /<span class="built_in">dir</span>
</code></pre><p>sticky位设置后，只有文件夹的所有者可以删除其中的文件。</p>
<h3 id="发现为授权的全局可写文件">发现为授权的全局可写文件</h3><p>以下命令找到全局可写文件(对某一分区<code>PART</code>)：</p>
<pre><code><span class="built_in">find</span> PART -xdev -<span class="built_in">type</span> f -perm -<span class="number">0002</span> -<span class="built_in">print</span>
</code></pre><p>如果发现确实不该设置全局可写，设置：</p>
<pre><code>chmod o-w <span class="type">file</span>
</code></pre><p>几乎不该出现全局可写的文件夹。</p>
<h3 id="找到未授权的SUID/SGID系统可执行文件">找到未授权的SUID/SGID系统可执行文件</h3><p>以下命令找到所有分区<code>PART</code>上的setuid和setgid文件：</p>
<pre><code><span class="built_in">find</span> PART -xdev \( -perm -<span class="number">4000</span> -o -perm -<span class="number">2000</span> \) -<span class="built_in">type</span> f -<span class="built_in">print</span>
</code></pre><p>如果确定有不用设置suid或sgid的程序，设置：</p>
<pre><code>chmod -s <span class="type">file</span>
</code></pre><p>可以参考NSA Guide 32页表格决定。</p>
<h3 id="找到和修复无主文件">找到和修复无主文件</h3><p>找到分区<code>PART</code>不属于任何有效用户组和用户的文件：</p>
<pre><code>find PART -xdev <span class="string">\(</span> -nouser -o -nogroup <span class="string">\)</span> -<span class="built_in">print</span>
</code></pre><p>如果有输出检查下是分配给某个用户和组还是删除文件。</p>
<p>通常无主文件并不可被挖掘漏洞，但是通常意味系统进程出错。也许是一个入侵者造成的，或者不正确的软件安装或者不完整的软件移除，或者移除一个被删除的帐号失败。这些文件应该被修复，以防将来创建用户出现问题，因此这种问题需要重视。</p>
<h3 id="确保所全局可写目录有合适的权限">确保所全局可写目录有合适的权限</h3><p>确保全局可写文件目录的权限是root或者其它系统账户。以下命令将发现和打印这些：</p>
<pre><code><span class="built_in">find</span> PART -xdev -<span class="built_in">type</span> d -perm -<span class="number">0002</span> -uid +<span class="number">500</span> -<span class="built_in">print</span>
</code></pre><p>如果有输出，搞明白为什么这些全局可写目录的拥有者不是root或者系统账户。</p>
<p>允许用户账户拥有全局可写目录不合适，应该这将允许拥有者移除任何其它用户放进去的文件。</p>
<h2 id="限制以危险模式运行的程序">限制以危险模式运行的程序</h2><p>这部分推荐提供广泛的保护，防止信息泄漏或者其它不当行为。这些保护被应用在系统初始化时和内核层，以抵御特定类型的没配置好或被入侵的程序。</p>
<h3 id="设置daemon_umask">设置daemon umask</h3><p>编辑<code>/etc/sysconfig/init</code>，添加或改变以下行。</p>
<pre><code><span class="built_in">umask</span> <span class="number">027</span>
</code></pre><p>该文件包含在启动时应用到所有进程的设置。最起码系统umask是022,不然守护进程就会创建全局可写的文件。更严格的027保护临时文件、日志文件等不被未授权的非授权用户读取。</p>
<p>如果特定daemon需要更宽松的umask，考虑为该守护进程单独设置例外，比如编辑启动脚本或者sysconfig文件</p>
<h3 id="禁用吐核">禁用吐核</h3><p>在<code>/etc/security/limits.conf</code>中添加或更改以下行，限制所有用户吐核。</p>
<pre><code><span class="bullet">*   </span>hard core 0
</code></pre><p>并且，确保setuid程序不吐核，编辑<code>/etc/sysctl.conf</code>添加或改正以下行：</p>
<pre><code>fs<span class="class">.suid_dumpable</span> = <span class="number">0</span>
</code></pre><p>核文件是可执行文件的内存镜像，大多情况下只有开发者需要合法的存取这些文件。核内可能包含敏感信息或者占据大量磁盘空间。</p>
<p>默认情况下，系统设置了软限制(soft limit)，以防止所有用户创建核文件。通过在<code>/etc/profile</code>中以下行实现：</p>
<pre><code>ulimit -S -c <span class="number">0</span> &gt; /dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span>
</code></pre><p>然而这个限制不是强制的。仅能防止对用户会话中恼人的吐核，如果需要吐核，考虑限定到指定用户和组。参见<code>limit.conf</code>的man页面。</p>
<h4 id="确保禁止suid吐核">确保禁止suid吐核</h4><p>使用<code>sysctl</code>检查：</p>
<pre><code><span class="tag">sysctl</span> <span class="tag">fs</span><span class="class">.suid_dumpable</span>
</code></pre><p>使用<code>-n</code>参数更利于写脚本检查这个值。</p>
<h4 id="开启ExecShield">开启ExecShield</h4><p>ExecShield包含一系列内核特性，这些特性提供缓冲区移除攻击保护。这些特性包括随机放置栈和其它内存区域，阻止在应该放数据的区段中执行内存，对字符缓冲区特殊处理。</p>
<p>为了让这些在启动时激活，添加以下行到<code>/etc/sysctl.conf</code>:</p>
<pre><code>kernel<span class="class">.exec-shield</span> = <span class="number">1</span>
kernel<span class="class">.randomize_va_space</span> = <span class="number">2</span>
</code></pre><p>Execshield 使用所有x86平台的段特性来阻止内存中特定地址更高的地址执行。它在代码段描述符中写下一个地址作为限制，来控制代码在哪里能执行(对每一个进程的基础上)。当内核将一个进程的内存区域，比如对或者栈到高于这个地址时，硬件会阻止它执行。然而，不可能对所有不该执行的内存区域做到这点。<code>randomize_va_space</code>值为2一般为默认值，确保随机放置栈,、VDSO页面,、共享内存区域和数据段。</p>
<h4 id="确保ExecShield已经启用">确保ExecShield已经启用</h4><p>使用sysctl确认当前系统中使用了这些特性：</p>
<pre><code><span class="tag">sysctl</span> <span class="tag">kernel</span><span class="class">.exec-shield</span>
<span class="tag">sysctl</span> <span class="tag">kernel</span><span class="class">.randomize_va_space</span>
</code></pre><h3 id="启用32位系统的Execute_Disable(XD)或者No_Execute(NX)支持">启用32位系统的Execute Disable(XD)或者No Execute(NX)支持</h3><p>较新的x86 32位处理器支持在每个内存页面基础上的代码防止执行。通常在AMD处理器上这个特性嗯叫<code>NX</code>，在Intel处理器中叫<code>XD</code>。这个特性有助于防止缓冲区移除攻击。任何时候都该开启。其它处理器比如Itanium、Power和64位x86处理器开始就支持该特性。</p>
<h4 id="检查是否处理器支持">检查是否处理器支持</h4><p>检查是否支持<code>PAE</code>和<code>NX</code>特性：</p>
<pre><code>cat /<span class="keyword">proc</span>/cpuinfo
</code></pre><p>如果支持，<code>flags</code>域内包含<code>pae</code>和<code>nx</code>。</p>
<h4 id="在x86系统安装新内核">在x86系统安装新内核</h4><p>显然64位系统用不着<code>PAE</code>特性。<code>kernel-PAE</code>顺便开启了<code>NX</code>或<code>XD</code>支持。不要在cpu不支持这些特性的机器上装<code>kernel-PAE</code>：</p>
<pre><code>yum <span class="keyword">install</span> kernel-PAE
</code></pre><h4 id="在BIOS中开启NX或XD支持">在BIOS中开启NX或XD支持</h4><p>进入BIOS设置界面，一概在setup菜单，security部分，大概</p>
<h3 id="配置prelink">配置prelink</h3><p>通过加载每个已经链接的必要符号的共享库到相同的位置，Prelink设计来减少进程启动时间。<code>/etc/sysconfig/prelink</code>文件描述了<code>/usr/sbin/prelink</code>程序会改动哪些文件以及更改这些文件的频率。</p>
<p>cron任务可以每天运行来执行<code>prelink</code>程序，有两种类型的预链接：quick和full，full默认每十四天发生一次，重链接所有共享库和那些使用它们的二进制文件。快速模式每天运行，但只对改动的二进制文件和库进行。</p>
<p>一旦二进制文件被预链接了，共享库地址不再会在进程基础上随机防止，就算<code>kernel.randomize_va_space</code>设置成1或2.这可不是我们想要的结果，由于其为攻击者的挖掘尝试提供了稳定的地址。</p>
<h4 id="禁用prelink">禁用prelink</h4><p>配置<code>/etc/sysconfig/prelink</code>:</p>
<pre><code><span class="setting">PRELINKING=<span class="value"><span class="keyword">no</span></span></span>
</code></pre><h4 id="取消已经存在的预链接">取消已经存在的预链接</h4><p>执行以下命令：</p>
<pre><code><span class="regexp">/usr/</span>sbin<span class="regexp">/prelink -ua</span>
</code></pre>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2014/11/17/linux-audit/" itemprop="url">
                  linux安全审计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-11-17T00:00:00+08:00" content="2014-11-17">
              2014-11-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2014/11/17/linux-audit/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2014/11/17/linux-audit/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><a href="https://www.nsa.gov/ia/_files/os/redhat/rhel5-guide-i731.pdf" target="_blank" rel="external">Guide to the Secure Configuration of Red Hat Enterprise Linux 5</a>安全审计部分，章节2.6.2</p>
<p>rhel提供了安全审计服务audit，默认情况下，该服务审计SELinux <a href="https://www.nsa.gov/research/_files/selinux/papers/slinux/node30.shtml" target="_blank" rel="external">AVC</a> denials和一些类型的安全事件。比如程序执行的系统登录、账户修改、和认证事件。</p>
<p>默认情况下，auditd消耗的磁盘空间不影响系统性能。无论你的系统有没有开启SELinux支持，都建议开启auditd的默认配置。</p>
<p>比如美国国防部常见的审计需求有：</p>
<ul>
<li>确保审计确定的系统事件：<ul>
<li>成功和不成功的使用打印机的命令</li>
<li>成功或不成功的启动和关闭事件</li>
</ul>
</li>
<li>确保被审计软件可以被记录以下审计事件：<ul>
<li>事件的日期和时间</li>
<li>执行时间的用户id</li>
<li>时间类型</li>
<li>时间成功或失败</li>
<li>标识和认证事件请求的来源(比如terminal ID)</li>
<li>对向用户地址空间引入对象的事件，对对象删除操作、对象名称和<a href="http://en.wikipedia.org/wiki/Multilevel_security" target="_blank" rel="external">MLS系统</a>中对象的安全级别。</li>
</ul>
</li>
<li>确保至少每周备份到另一个系统或媒介上</li>
<li>确保旧日志被关闭，新的审计日志每天开始。</li>
<li>确保配置不可更改。在audit.rule中<code>-e 2</code>设定更改审计规则需要重启。</li>
<li>确保审计数据文件权限为<code>644</code>或者更严格。</li>
</ul>
<h2 id="开启auditd服务">开启auditd服务</h2><p>enable auditd服务：</p>
<pre><code>chkconfig auditd <span class="function_start"><span class="keyword">on</span></span>
</code></pre><p>默认情况下，auditd只记录SELinux denials，特定安全事件类型比如用户账户更改，登录事件和调用<code>sudo</code></p>
<p>数据保存在<code>/var/log/audit/audit.log</code>。默认情况下<code>auditd</code>rotates 4个5MB日志，总共占据20MB空间。这样减小了系统压力，但可能丢失审计数据。</p>
<h2 id="配置auditd数据存储">配置auditd数据存储</h2><ul>
<li><p>确定当个日志文件的最大大小<code>STOREMB</code>(单位为mb)，增减或更改<code>/etc/audit/auditd.conf</code>的如下行：</p>
<p>  max_log_file = STOREMB</p>
</li>
<li><p>对日志文件使用单独的分区或者逻辑卷。在安装时分区，要比auditd要用的稍微大点(大于<code>max_log_file x num_logs</code>)，确保审计分区挂载在<code>/var/log/audit</code></p>
</li>
<li><p>如果当审计无法执行时需要停机，配置auditd在磁盘空间不足时中止系统。编辑<code>/etc/audit/auditd.conf</code>，增加或修改如下行(磁盘空间不足给管理员发邮件)：</p>
<p>  space_left_action = email<br>  action_mail_act = root<br>  admin_space_left_action= halt</p>
</li>
</ul>
<p>默认的action是当日志达到单个日志的最大大小，循环日志，丢弃最老的。如果保留尽可能多的日志很重要，即使空间耗尽执行<code>admin_space_left_action</code>中定义行为，添加或修改如下行：</p>
<pre><code>max_<span class="built_in">log</span>_file_action = keep_logs
</code></pre><p>需要日志文件的大小和审计的事件类型密切相关。首先配置审计记录所有感兴趣的事件，人工监控一段时间日志大小去做决定。</p>
<p>使用单独的分区<code>/var/log/audit</code>来阻止auditd日志耗尽磁盘空间影响系统功能，最重要的是，阻止其它/var中的程序填满审计日志空间。</p>
<p>有些机器需要不做出action，如果是这样，直接设定成在耗尽磁盘空间时关机就行。</p>
<p>注意：较老的日志会被循环丢弃！</p>
<p>注意！！！！：如果系统配置为不能记录日志时停机，确定正常情况下不会发生这种事！确保<code>/var/log/audit</code>在单独的分区上，并且比auditd需要的保留数据的最大大小要大。</p>
<h2 id="配置使先于audit守护进程启动的进程生效">配置使先于audit守护进程启动的进程生效</h2><p>为了确保先于audit进程启动的进程被审计，在<code>/etc/grub.conf</code>添加内核启动参数<code>audit=1</code>：</p>
<pre><code>kernel <span class="regexp">/vmlinuz-version ro vga=ext root=/</span>dev<span class="regexp">/VolGroup00/</span>LogVol00 rhgb quiet audit=<span class="number">1</span>
</code></pre><p>系统上每个进程都有个<code>auditable</code>标志标识它们是否能被审计。尽管auditd负责使所有它之后被启动的进程被审计，添加内核参数确保在启动时为每个进程设置参数。</p>
<h2 id="配置全面的审计规则">配置全面的审计规则</h2><p>auditd能对系统活动实行全面的审计。这一部分描述了推荐的设置，更全面的请参照其它资源。<code>linux-audit@redhat.com</code>邮件列表是个好的信息来源。</p>
<p>审计子系统支持大量事件类型，包括：</p>
<ul>
<li>追踪任何进入或退出的系统调用(以名称或编号命名)。</li>
<li>以PID，UID，调用成功与否，系统调用参数(有些限制)等等来过滤。</li>
<li>监控特殊文件内容和元数据的更改。</li>
</ul>
<p>审计规则在<code>/etc/audit/audit.rules</code>控制，添加满足你审计需求的规则。该文件中每一行代表一系列传递给<code>auditctl</code>的参数，能用<code>auditctl</code>独立测试。参见<code>/usr/share/doc/audit-version</code>和相关man页面获取更多信息。</p>
<p>推荐的审计规则在<code>/usr/share/doc/audit-version/stig.rules</code>提供，激活这些规则：</p>
<pre><code>cp <span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>audit-version<span class="regexp">/stig.rules /</span>etc<span class="regexp">/audit/</span>audit.rules
</code></pre><p>然后编辑<code>/etc/audit/audit.rules</code>注释掉不适合你的架构的包含<code>arch=</code>的行。然后检查和理解其中的规则，确保需要的规则在合适的架构上被激活。</p>
<p>检查完所有规则后，阅读以下章节，编辑和激活需要的新规则：</p>
<pre><code><span class="title">service</span> auditd restart
</code></pre><h2 id="记录更改日期和时间信息的事件">记录更改日期和时间信息的事件</h2><p>添加以下规则到<code>/etc/audit/audit.rules</code>，设置<code>ARCH</code>为你系统合适的架构，要么是<code>b32</code>，要么是<code>b64</code>:</p>
<pre><code>-a always,exit -F arch=ARCH -S adjtimex -S settimeofday -S stime -k time-<span class="operator"><span class="keyword">change</span>
-a <span class="keyword">always</span>,<span class="keyword">exit</span> -<span class="keyword">F</span> arch=ARCH -S clock_settime -<span class="keyword">k</span> <span class="keyword">time</span>-<span class="keyword">change</span>
-w /etc/<span class="keyword">localtime</span> -<span class="keyword">p</span> wa -<span class="keyword">k</span> <span class="keyword">time</span>-<span class="keyword">change</span></span>
</code></pre><p>(参见<code>man auditctl</code>)</p>
<h2 id="记录更改用户/组信息的事件">记录更改用户/组信息的事件</h2><p>添加以下规则到<code>/etc/audit/audit.rules</code>，为了捕捉更改账户变化的事件：</p>
<pre><code>-w /etc/group -<span class="tag">p</span> wa -k identity
-w /etc/passwd -<span class="tag">p</span> wa -k identity
-w /etc/gshadow -<span class="tag">p</span> wa -k identity
-w /etc/shadow -<span class="tag">p</span> wa -k identity
-w /etc/security/opasswd -<span class="tag">p</span> wa -k identity
</code></pre><h2 id="记录更改系统网络环境的事件">记录更改系统网络环境的事件</h2><p>添加以下规则到<code>/etc/audit/audit.rules</code>，根据系统架构设置<code>ARCH</code>为或者<code>b32</code>或者<code>b64</code>：</p>
<pre><code>-<span class="tag">a</span> exit,always -F arch=ARCH -S sethostname -S setdomainname -k system-locale
-w /etc/issue -<span class="tag">p</span> wa -k system-locale
-w /etc/issue<span class="class">.net</span> -<span class="tag">p</span> wa -k system-locale
-w /etc/hosts -<span class="tag">p</span> wa -k system-locale
-w /etc/sysconfig/network -<span class="tag">p</span> wa -k system-locale
</code></pre><h2 id="记录更改系统强制访问存取(MAC)策略的事件">记录更改系统强制访问存取(MAC)策略的事件</h2><p>添加<code>/etc/audit/audit.rules</code>:</p>
<pre><code>-w /etc/selinux/ -<span class="tag">p</span> wa -k MAC-policy
</code></pre><h2 id="记录登入注销变更事件的尝试">记录登入注销变更事件的尝试</h2><p>审计系统已经收集了所有用户和root的登录信息。去监视尝试手工更改存储登入事件的文件，向<code>/etc/audit.rules</code>添加以下行：</p>
<pre><code>-<span class="ruby">w /var/log/faillog -p wa -k logins <span class="comment"># RHEL6中再无这个，pam_tally不再写入其中</span>
</span>-<span class="ruby">w /var/log/lastlog -p wa -k logins</span>
</code></pre><h2 id="记录更改进程和会话初始化信息的尝试">记录更改进程和会话初始化信息的尝试</h2><pre><code>-w /<span class="keyword">var</span>/<span class="keyword">run</span>/utmp -p wa -k session
-w /<span class="keyword">var</span>/<span class="keyword">log</span>/btmp -p wa -k session
-w /<span class="keyword">var</span>/<span class="keyword">log</span>/wtmp -p wa -k session
</code></pre><h2 id="确保auditd收集任意存取控制权限更改事件">确保auditd收集任意存取控制权限更改事件</h2><p>最起码审计系统会收集所有用户和root的文件权限更改。添加以下到<code>/etc/audit/audit.rules</code>，设置<code>ARCH</code>为系统合适的架构，要么<code>b32</code>或者<code>b64</code>：</p>
<pre><code>-a always,<span class="built_in">exit</span> -F arch=ARCH -S chmod -S fchmod -S fchmodat -F auid&gt;=<span class="number">500</span> \
    -F auid!=<span class="number">4294967295</span> -k perm_mod
-a always,<span class="built_in">exit</span> -F arch=ARCH -S chown -S fchown -S fchownat -S lchown -F auid&gt;=<span class="number">500</span> \
    -F auid!=<span class="number">4294967295</span> -k perm_mod
-a always,<span class="built_in">exit</span> -F arch=ARCH -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S \
    lremovexattr -S fremovexattr -F auid&gt;=<span class="number">500</span> -F auid!=<span class="number">4294967295</span> -k perm_mod <span class="preprocessor"># 红帽的非权限用户起始uid为<span class="number">500</span>, <span class="number">4294967295</span>为最大<span class="number">32</span>位无符号整数</span>
</code></pre><h2 id="使用auditd收集未认证的文件访问尝试(失败)">使用auditd收集未认证的文件访问尝试(失败)</h2><p>最起码审计系统收集所有用户和root的未授权文件访问信息。添加以下行到<code>/etc/audit/audit.rules</code>，设置<code>ARCH</code>：</p>
<pre><code>-a always,exit -F arch=ARCH -S creat -S open -S openat -S <span class="operator"><span class="keyword">truncate</span> -S ftruncate \
    -<span class="keyword">F</span> <span class="keyword">exit</span>=-EACCES -<span class="keyword">F</span> auid&gt;=<span class="number">500</span> -<span class="keyword">F</span> auid!=<span class="number">4294967295</span> -<span class="keyword">k</span> <span class="keyword">access</span>
-a <span class="keyword">always</span>,<span class="keyword">exit</span> -<span class="keyword">F</span> arch=ARCH -S creat -S <span class="keyword">open</span> -S openat -S <span class="keyword">truncate</span> -S ftruncate \
    -<span class="keyword">F</span> <span class="keyword">exit</span>=-EPERM -<span class="keyword">F</span> auid&gt;=<span class="number">500</span> -<span class="keyword">F</span> auid!=<span class="number">4294967295</span> -<span class="keyword">k</span> <span class="keyword">access</span></span>
</code></pre><h2 id="确保auditd收集权限命令使用的信息">确保auditd收集权限命令使用的信息</h2><p>最起码审计系统收集所有用户和root的权限命令执行信息。这需要为每个要监视执行的<code>setuid</code>或者<code>setgid</code>程序添加规则。</p>
<p>首先运行以下命令找到所有本地分区<code>PART</code>来生成规则，每个<code>setuid</code>或<code>setgid</code>程序一个规则：</p>
<pre><code>find PART -xdev \( -perm -<span class="number">4000</span> -o -perm -<span class="number">2000</span> \) -type f | awk {print \
    <span class="string">"-a always,exit -F path="</span> <span class="variable">$1</span> <span class="string">" -F perm=x -F auid&gt;=500 -F auid!=4294967295 \
    -k privileged"</span> }
</code></pre><p>然后添加打印的行到<code>/etc/audit/audit.rules</code>。</p>
<h2 id="确保auditd搜集导出到介质上的信息(成功)">确保auditd搜集导出到介质上的信息(成功)</h2><p>(我不是很明白，看上去似乎是收集非权限用户的挂载信息)</p>
<p>最起码审计系统收集所有用户和root的媒体导出事件。添加以下行到<code>/etc/audit/audit.rules</code>，设置<code>ARCH</code>：</p>
<pre><code>-a always,<span class="built_in">exit</span> -F arch=ARCH -S mount -F auid&gt;=<span class="number">500</span> -F auid!=<span class="number">4294967295</span> -k <span class="keyword">export</span>
</code></pre><h2 id="确保auditd搜集用户的文件删除事件(成功与失败)">确保auditd搜集用户的文件删除事件(成功与失败)</h2><p>最起码审计系统应该收集所有用户和root的文件删除事件。添加以下行到<code>/etc/audit/audit.rules</code>，设置ARCH：</p>
<pre><code>-a always,exit -F arch=ARCH -S unlink -S unlinkat -S <span class="operator"><span class="keyword">rename</span> -S renameat -<span class="keyword">F</span> auid&gt;=<span class="number">500</span> \
    -<span class="keyword">F</span> auid!=<span class="number">4294967295</span> -<span class="keyword">k</span> <span class="keyword">delete</span></span>
</code></pre><h2 id="确保auditd收集系统管理行为">确保auditd收集系统管理行为</h2><p>(其实就是监视sudoer文件)</p>
<p>最起码审计系统应该收集用户和root的管理员行为。添加以下到<code>/etc/audit/audit.rules</code>:</p>
<pre><code>-w /etc/sudoers -<span class="tag">p</span> wa -k actions
</code></pre><h2 id="确保auditd收集内核加载卸载信息">确保auditd收集内核加载卸载信息</h2><p>添加以下到<code>/etc/audit/audit.rules</code>，设置ARCH：</p>
<pre><code>-w /sbin/insmod -<span class="tag">p</span> x -k modules
-w /sbin/rmmod -<span class="tag">p</span> x -k modules
-w /sbin/modprobe -<span class="tag">p</span> x -k modules
-<span class="tag">a</span> always,exit -F arch=ARCH -S init_module -S delete_module -k modules
</code></pre><h2 id="确保auditd配置不可更改">确保auditd配置不可更改</h2><p>添加以下作为<code>/etc/audit/audit.rules</code>的 <em>最后一行</em> ：</p>
<pre><code><span class="operator">-e</span> <span class="number">2</span>
</code></pre><p>通过这个设定，更改审计规则需要重启机器。</p>
<h2 id="通过aureport总结和查看审计日志">通过aureport总结和查看审计日志</h2><p>仔细检查<code>aureport</code>的man页面。然后设计一系列便于日常研究审计日志的命令。这些命令可以通过在合适的命名文件在<code>/etc/crond.daily</code>中被加入到cron job中。(其它章节中有有关如何确保审计系统收集所有需要事件的信息)</p>
<p>例如，为每个登录到机器的用户生成日报，可在<code>cron</code>中运行以下命令：</p>
<pre><code>aureport -<span class="keyword">l</span> -i -ts yesterday -<span class="keyword">te</span> today
</code></pre><p>查看所有异常行为审计活动，通常先从被触发审计规则摘要看起：</p>
<pre><code><span class="comment">aureport</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">key</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">summary</span>
</code></pre><p>如果违规访问很多，检查它们：</p>
<pre><code><span class="comment">ausearch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">key</span> <span class="comment">access</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">raw</span> <span class="comment">|</span> <span class="comment">aureport</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">file</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">summary</span>
</code></pre><p>看看执行了哪些可执行文件：</p>
<pre><code><span class="comment">ausearch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">key</span> <span class="comment">access</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">raw</span> <span class="comment">|</span> <span class="comment">airport</span> <span class="literal">-</span><span class="comment">x</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">summary</span>
</code></pre><p>如果非法访问发生在特定文件上，并且你想看看哪个用户做的：</p>
<pre><code><span class="comment">ausearch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">key</span> <span class="comment">access</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">file</span> <span class="comment">/etc/shadow</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">raw</span> <span class="comment">|</span> <span class="comment">aureport</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">user</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">summary</span> <span class="literal">-</span><span class="comment">i</span>
</code></pre><p>检查异常活动(比如网卡设备更改到混杂模式，进程异常中止，登录失败次数达到上限)</p>
<pre><code>aureport <span class="comment">--anomaly</span>
</code></pre><p>审计分析的基础是使用key来分类事件。有关使用ausearch获取SELinux问题的信息在其它章节讨论</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/reverse/2014/11/15/" itemprop="url">
                  linux下函数参数调用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-11-15T00:00:00+08:00" content="2014-11-15">
              2014-11-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/reverse/" itemprop="url" rel="index">
                    <span itemprop="name">reverse</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/reverse/2014/11/15/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="reverse/2014/11/15//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="x64">x64</h2><p>整型和指针型参数次保存在寄存器:</p>
<ul>
<li><code>rdi</code></li>
<li><code>rsi</code></li>
<li><code>rdx</code></li>
<li><code>rcx</code></li>
<li><code>r8</code></li>
<li>‘r9’</li>
</ul>
<p>浮点型参数依次保存到:</p>
<ul>
<li><code>xmm0</code></li>
<li><code>xmm1</code><br>…</li>
</ul>
<p>其它从右往左依次入栈。</p>
<h2 id="x86">x86</h2><p>从右往左依次入栈，即在栈上从低地址向高地址分布。</p>
<p>一般栈上是这样的，从上到下地址增长：</p>
<pre><code>0 1 2 3
<span class="header">...
--------</span>
<span class="header">上层FP  &lt;----FP
--------</span>
<span class="header">返回地址
--------</span>
<span class="header">参数1
--------</span>
参数2
...
</code></pre><p>如果参数大于四个字节，则占据多个字节，按cpu字节序(endian)入栈</p>
<h3 id="fastcall">fastcall</h3><p>使用寄存器，前三个使用寄存器传递参数：</p>
<ul>
<li><code>eax</code></li>
<li><code>edx</code></li>
<li><code>ecx</code></li>
</ul>
<p>其它按入栈规则入栈。</p>
<h2 id="C++">C++</h2><p>除了参数，对象指针也会被传递。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2014/11/12/some-articles/" itemprop="url">
                  Some articles
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-11-12T00:00:00+08:00" content="2014-11-12">
              2014-11-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2014/11/12/some-articles/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2014/11/12/some-articles/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <ul>
<li><a href="http://phrack.org/issues/68/7.html#article" target="_blank" rel="external">Happy Hacking</a></li>
</ul>
<p>这篇文章探讨了下人不快乐的来源，探讨了安全工业和黑客社区不同的评判标准，探讨了可能的应对方案。</p>
<blockquote>
<p>I hope I brought some understanding to what makes people happier, what you<br>should look into any industry you seek to work in if you want to maximize<br>your happiness, and more importantly how the security industry behaves. </p>
<p>Hopefully some of you will be able to make better decisions, and ultimately<br>the conclusion should be:</p>
<ul>
<li>Hacking will never die, because ultimately we all want happiness, and<br>hacking brings happiness. -</li>
</ul>
<p>HAPPY HACKING!</p>
</blockquote>
<ul>
<li><a href="http://phrack.org/papers/fall_of_groups.html" target="_blank" rel="external"> The Fall of Hacker Groups</a></li>
</ul>
<p>随着社会发展，个人越来越自由，人们越来越个性化，信任越来越难，人与人之间越来越难以合作。</p>
<ul>
<li><a href="http://phrack.org/issues/65/6.html" target="_blank" rel="external">The only laws on the Internet are assembly and RFCs</a></li>
</ul>
<p>提出了一些法律，和一些绕过法律方式。</p>
<p>开坑后忘了还有这篇……</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/linux/2014/10/17/acl-on-linux/" itemprop="url">
                  linux权限控制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-10-17T00:00:00+08:00" content="2014-10-17">
              2014-10-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/linux/2014/10/17/acl-on-linux/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="linux/2014/10/17/acl-on-linux/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>最近工作上要用到加固linux系统，还有各种权限控制。发现<a href="http://vbird.dic.ksu.edu.tw/" target="_blank" rel="external">鸟哥的书</a>简直是相当赞啊。用了这么久linux，其实真是对其中的各种权限控制策略一无所知。</p>
<p>除了传统的基于user-group-others和rwx的权限控制。还有ACL、SELinux。</p>
<h2 id="基本权限控制">基本权限控制</h2><p>对文件所属用户、组、其它分别设置读、写、执行权限。</p>
<p>这里只提下，<code>ls</code>需要目录有执行权限.</p>
<h2 id="PAM模块">PAM模块</h2><p>一个统一权限认证接口，其它程序通过PAM来进行权限认证。</p>
<h2 id="ACL">ACL</h2><p>Acess Control List。可以针对某一用户单一文件、单一目录进行rwx权限控制。ACL来自文件系统支持。</p>
<p>ACL支持需要在挂载时指定挂载参数(<code>mount options</code>)支持，目前流行的ext2,ext3,ext4, xfs, ReiserFS都支持。</p>
<p>这里提下判断顺序，分为两步，先检查ACL条目，再检查基本权限.</p>
<pre><code>If
    <span class="operator">the</span> user ID <span class="operator">of</span> <span class="operator">the</span> <span class="built_in">process</span> is <span class="operator">the</span> owner, <span class="operator">the</span> owner entry determines access

<span class="keyword">else</span> <span class="keyword">if</span>
    <span class="operator">the</span> user ID <span class="operator">of</span> <span class="operator">the</span> <span class="built_in">process</span> matches <span class="operator">the</span> qualifier <span class="operator">in</span> <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> named user entries, this entry determines access

<span class="keyword">else</span> <span class="keyword">if</span>
    <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> group IDs <span class="operator">of</span> <span class="operator">the</span> <span class="built_in">process</span> matches <span class="operator">the</span> owning group <span class="operator">and</span> <span class="operator">the</span> owning group entry <span class="operator">contains</span> <span class="operator">the</span> requested permissions, this entry determines access

<span class="keyword">else</span> <span class="keyword">if</span>
    <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> group IDs <span class="operator">of</span> <span class="operator">the</span> <span class="built_in">process</span> matches <span class="operator">the</span> qualifier <span class="operator">of</span> <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> named group entries <span class="operator">and</span> this entry <span class="operator">contains</span> <span class="operator">the</span> requested permissions, this entry determines access
<span class="keyword">else</span> <span class="keyword">if</span>
    <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> group IDs <span class="operator">of</span> <span class="operator">the</span> <span class="built_in">process</span> matches <span class="operator">the</span> owning group <span class="operator">or</span> <span class="keyword">any</span> <span class="operator">of</span> <span class="operator">the</span> named group entries, but neither <span class="operator">the</span> owning group entry nor <span class="keyword">any</span> <span class="operator">of</span> <span class="operator">the</span> matching named group entries <span class="operator">contains</span> <span class="operator">the</span> requested permissions, this determines that access is denied

<span class="keyword">else</span>
    <span class="operator">the</span> other entry determines access.

If
    <span class="operator">the</span> matching entry resulting <span class="built_in">from</span> this selection is <span class="operator">the</span> owner <span class="operator">or</span> other entry <span class="operator">and</span> <span class="keyword">it</span> <span class="operator">contains</span> <span class="operator">the</span> requested permissions, access is granted

<span class="keyword">else</span> <span class="keyword">if</span>
    <span class="operator">the</span> matching entry is <span class="operator">a</span> named user, owning group, <span class="operator">or</span> named group entry <span class="operator">and</span> this entry <span class="operator">contains</span> <span class="operator">the</span> requested permissions <span class="operator">and</span> <span class="operator">the</span> mask entry also <span class="operator">contains</span> <span class="operator">the</span> requested permissions (<span class="operator">or</span> there is no mask entry), access is granted

<span class="keyword">else</span>
    access is denied.
</code></pre><p>更改和查看acl通过<code>setfacl</code>和<code>getfacl</code>实现。</p>
<h2 id="SELinux">SELinux</h2><p>传统的权限控制是控制使用者的行为，SELinux则是控制程序的行为。SELinux功能实现在内核部分。</p>
<p>程序有什么行为时，SELinux先进行判断，如果有权限再交给传统的权限控制机制判断。</p>
<p>详细请参考鸟哥的<a href="http://vbird.dic.ksu.edu.tw/linux_server/0210network-secure.php#selinux" target="_blank" rel="external">SELinux 管理原则</a></p>
<p>后来看到这个了<a href="https://www.centos.org/docs/5/html/Deployment_Guide-en-US/selg-overview.html" target="_blank" rel="external">https://www.centos.org/docs/5/html/Deployment_Guide-en-US/selg-overview.html</a></p>
<p>还是红帽厉害……<a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/index.html" target="_blank" rel="external">SELinux User’s and Administrator’s Guide</a></p>
<p>还有gentoo的<a href="http://wiki.gentoo.org/wiki/SELinux" target="_blank" rel="external">维基</a></p>
<h2 id="参考资料">参考资料</h2><ul>
<li><a href="http://docs.joomla.org/How_do_UNIX_file_permissions_work%3F" target="_blank" rel="external">How do UNIX file permissions work?</a></li>
<li><a href="http://users.suse.com/~agruen/acl/linux-acls/online/" target="_blank" rel="external">POSIX Access Control Lists on Linux</a></li>
<li><a href="http://vbird.dic.ksu.edu.tw/linux_basic/0440processcontrol_5.php" target="_blank" rel="external"> 第十七章、程序管理与 SELinux 初探</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/game/2014/10/15/dwarf-fortress/" itemprop="url">
                  矮人要塞解释(译)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2014-10-15T00:00:00+08:00" content="2014-10-15">
              2014-10-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/game/" itemprop="url" rel="index">
                    <span itemprop="name">game</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/game/2014/10/15/dwarf-fortress/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="game/2014/10/15/dwarf-fortress/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <blockquote>
<p>Losing is fun.</p>
</blockquote>
<p>原文在<a href="http://df.zweistein.cz/" target="_blank" rel="external">Dwarf Fortress Explained:a medium-length pamphlet about miserable dwarves and a sublime game.</a>，原网页很漂亮，到我这里页面毁了。原文语言也诙谐优美，到我这里就翻译跪了。我翻译给自己看，能看得懂的还是看原文的好。</p>
<h2 id="矮人要塞是什么？">矮人要塞是什么？</h2><p><a href="http://www.bay12games.com/dwarves/" target="_blank" rel="external">Dwarf Fortress</a>不只是一个游戏：你不是在玩一个策略、角色扮演或者模拟游戏：你在玩的是一个血腥中世纪版本的世界。游戏从你生成要玩的世界开始。它的地理、国家、任何东西都呈现给你一个生机勃勃的幻想世界。你从中获取的是自己独有的体验：你游戏的世界完全是独一无二的，在你身上展开的故事未曾也不会发生在任何其它玩家身上。</p>
<blockquote>
<p>一个人类女孩Zega Lukikonu的故事：Zega生于30年，Guki和Gili唯一的孩子。她在Pricebaker乡的一个小村度过了童年，她在12岁时在那里嫁给了来自Bulunesslure乡的Emtha Sensualsparkles。他们都前往荒野探险，结果遭到了伏击。13岁的Zega被女巨人Islas Nutscourage杀死。多年后，她的丈夫Emtha，在69岁时在荒野游荡时被巨人Aran Bristledrives杀死。最终有人帮她复了仇：杀害她的女巨人Islas，在127年终于被来自Purgedmine洞穴的人类Setoc杀死。大伏魔者Setoc在激战中失去了右脚。她最后放弃继续探险，在晚年定居和死亡。她的儿子Uda成为了Bodices神庙的大祭司，她的女儿Iki移居出城市成为了一个农民。</p>
</blockquote>
<p>非常简单的故事，看上去像一个普通的b级幻想小说。也许是一个次要角色的背景？然而你可以真正地见到这些人。作为冒险者到相关城镇旅行，和Uda聊天。也许你会构建一个威武的矮人要塞同人类开战。一旦人类围攻你，也许Iki就在那为客死他乡担惊受怕。</p>
<blockquote>
<p>哦，巨人Aran在173年被矮人Miithkat杀死，所以Emtha和Zega都可以安息了。在激烈对抗中Miithkat失去了左眼。在她的丈夫Uda呆在家中照看两个孩子时，但她仍然在荒野游荡。</p>
</blockquote>
<p>你碰到的每个人都有一个个人历史，生于何处为谁所生。也许你能帮他们打败夺去他们爱人和密友的怪物。又或许他们已经完成复仇。你，作为一个玩家可以极大地影响这个世界。作为探险者血腥扫荡过人类首都看王国崩溃。在合适的地方建造矮人的都城看着他们的王国兴盛。</p>
<blockquote>
<p>你想要一个矮人？这就是你的该死的矮人。你想要更好的画面？去你妈的。矮人能做很多事情，比如挖洞。你能挖洞吗？靠，不行。玩矮人要塞吧。    –4chan匿名网友TG区</p>
</blockquote>
<p>这个游戏的一切都包含了难以置信数量的细节。源于此，复杂的行为也投射入这个虚拟世界的生活。这是一个活生生的世界，一个你能影响的世界，一个你拥有你独有史诗和传说的世界。</p>
<p><a href="http://dwarffortresswiki.org/index.php/v0.31:Stories/Bronzemurder" target="_blank" rel="external">“青铜谋杀”要塞</a>史诗的展示中的一部分，全部请点击前文链接。(译者注：故事大概是这样的，一个叫“青铜谋杀”的要塞中，矮人们建造了一个23层的水泵利用陆地风能把地下水抽上地面，但由于一个工程错误最下面的水泵必须手动启动，结果那地方有只巨大的鬣蜥……于是大蜥蜴一路屠杀过整个要塞。)</p>
<p><img src="http://df.zweistein.cz/screens/bronzemurdered_small.png" alt="“青铜谋杀”要塞史诗的一部分"></p>
<blockquote>
<p>Tholtig在她十二岁时刚可以举起锤子时，就和父母祖父母们一起上了战场。矮人别无选择，他们损失太过惨重，以致于任何能举起锤子的人都被视若珍宝。在她121岁登基时已经杀死了48个精灵和独眼巨人，但是，剩下能拿起武器的矮人已经不足十个。不过，她领导了进攻精灵的突袭取得胜利，但这是个得不偿失的胜利，她亲眼目睹包括她的长子在内的两个孩子的死亡。–<a href="http://www.bay12forums.com/smf/index.php?topic=41896.msg762007#msg762007" target="_blank" rel="external">矮人要塞传说集合</a>,<a href="http://www.bay12forums.com/smf/index.php?topic=42702.msg790500#msg790500" target="_blank" rel="external">流血、绝望和荣耀之诗：女王Tholtig Cryptbrain的传说</a></p>
</blockquote>
<p>我见过矮人要塞世界中的传奇神器Abbokem，和他的创造者Archacted在其失窃几个月后沮丧异常。对Tlakala，一个奇迹般在箭雨中生还的人的追求。某人，在某地可以找到一个不融于水的盐岩打制的项链。这所有听起来是不是在莫名其妙的胡扯？因为这些仅仅发生在我身上。没有其它玩家能够经历这些。</p>
<p>下图是一个生成的世界的图例：</p>
<p><img src="http://df.zweistein.cz/screens/world_small.png" alt="一个生成地图的示例"></p>
<h2 id="那么，我如何才能玩？">那么，我如何才能玩？</h2><p>游戏有两个模式。要塞模式，就像一个城市建设类型的策略游戏。你开始有一队矮人，你的目标是建设要塞。抵御妖精、创造财富、修建大坝等等等等。玩得愉快。</p>
<blockquote>
<p>“就像拿着一堆乐高积木扮演上帝。 –<a href="http://www.bay12forums.com/smf/index.php?topic=45497.msg892430#msg892430" target="_blank" rel="external">They Got Leader(bay12论坛上的一个人)</a></p>
</blockquote>
<p>你该怎么做呢？通常，首先要耕种生产食物，砍树建造木屋，在石山中挖掘矮人们居住的房间，做你迁居到新地方想做的一切。也许生产一些工艺品用来贸易。如果你做的不错会吸引移民，人口会增长，你将有足够的人力来开启工业(比如，<a href="http://www.bay12forums.com/smf/index.php?topic=25967.0" target="_blank" rel="external">收割美人鱼骨头</a>)和军事。很快，<a href="http://df.magmawiki.com/index.php/Goblin_christmas" target="_blank" rel="external">妖精</a>就会获悉你的位置并对你做些什么(就是说，尝试杀掉所有人)。</p>
<p>注意到你建造什么是几乎完全自由的很重要。用石头和齿轮制造大型水力驱动的<a href="http://boingboing.net/2010/04/15/colossal-turing-mach.html" target="_blank" rel="external">巴贝奇样的计算机</a>是<a href="http://mkv25.net/dfma/map-8269" target="_blank" rel="external">可能</a>的，也是受欢迎的消磨时间方法。</p>
<p>事实上，你的单位不仅仅是匿名的大众脸。他们有喜好、有厌恶。他们有人际关系，如果你不介意这些他们会非常不开心。结果就是灾难结局。一个被精灵杀死妻子的矮人不得不连年睡在雨中的地板上，就是因为你懒得为他造个房间……好吧。矮人最终会反抗并杀死他认为应该对此负责的人。又或许他是安静的类型，仅仅是愈来越抑郁最终绝食……饿死。</p>
<p>下图：Ast Sozadmebzuth虽然失去了丈夫，但和七个孩子一起似乎相当开心。她再次很好处理了压力。</p>
<p><img src="http://df.zweistein.cz/screens/detail_large.png" alt="Ast"></p>
<p>目前还是没有展示给你这个游戏的样子。有一个 <code>不幸</code> 的秘密。这个游戏主要通过键盘操作并且没有精美的图形界面。这个游戏没有卓越的图形引擎……</p>
<p>这个游戏不完全看起来像下图这样，它有一些<a href="http://www.bay12forums.com/smf/index.php?topic=43260.msg810621#msg810621" target="_blank" rel="external">美化</a>，而且，注意岩浆。岩浆是许多许多问题非常重要的解决方案。毫无疑问，<a href="http://df.magmawiki.com/index.php/Magma" target="_blank" rel="external">使用岩浆</a>。让我们继续看游戏画面实际如何……</p>
<p><img src="http://df.zweistein.cz/screens/stonesense_small.png" alt="stonesense"></p>
<p>接下来这个<a href="http://www.bay12forums.com/smf/index.php?topic=39541.msg677616#msg677616" target="_blank" rel="external">游戏画面样本</a>。来自一个玩家建造的巨大比例的大坝：30米高。但还是没有展示游戏原本画面是什么样的。</p>
<p><img src="http://df.zweistein.cz/screens/visualiser_small.png" alt="visual fortress"></p>
<p>下图这个更加接近原版了。事实上，你可以<a href="http://goblinart.pl/vg-eng/df.php" target="_blank" rel="external">真的这么玩</a>。在下面的截图中，你可以看到矮人们聚在餐厅，附近用木桶存储着食物和<a href="http://df.magmawiki.com/index.php/Booze" target="_blank" rel="external">酒</a>，还有一些小卧室。</p>
<p><img src="http://df.zweistein.cz/screens/mayday_small.png" alt="ironhand"></p>
<p>下面这个更加接近了。它描述了有马和奶牛的马厩，一个屠夫肉店和厨房。正如你所见，游戏相当容易定制：默认的外观可以是ascii字符，但是相当容易把它变成<a href="http://df.magmawiki.com/index.php/Tileset_repository" target="_blank" rel="external">其它样子</a>。</p>
<p><img src="http://df.zweistein.cz/screens/map_small.png" alt="tileset"></p>
<p>所以，这个游戏该死的样子是什么样的？好吧，他是在字符模式下玩的。Ascii，和键盘操作。嗯……好吧，它看起来是下面这样的，没有图形团队能够跟得上游戏引擎特性和细节程度。最终结果就是仅仅使用符号和图像，来描述玩家身上发生了什么并让他看见什么。就像在玩一本书(就是说这些故事)。</p>
<p><img src="http://df.zweistein.cz/screens/ambush_small.png" alt="origin"></p>
<p>好吧，这就是我们不愿面对的 <code>不幸</code> 秘密。别担心，一切其实很 <code>容易</code>。仅仅<a href="https://www.youtube.com/playlist?list=PL06686270DA5FF439" target="_blank" rel="external">看看教程</a>或者<a href="http://afteractionreporter.com/2009/02/09/the-complete-and-utter-newby-tutorial-for-dwarf-fortress-part-1-wtf/" target="_blank" rel="external">读读教程</a>就够了。如果还有问题，<a href="http://df.magmawiki.com/index.php/Main_Page" target="_blank" rel="external">看看维基</a>。</p>
<p>还有，听说不提及<a href="http://lparchive.org/Dwarf-Fortress-Boatmurdered/" target="_blank" rel="external">boatmurdered</a>的故事是犯罪。我希望之前我提到过使我免于<a href="http://df.magmawiki.com/index.php/Hammerer" target="_blank" rel="external">锤子</a>(矮人要塞中刽子手执行时的工具)。记住，不阅读它也是犯罪。</p>
<h2 id="啊哈，第二个模式？">啊哈，第二个模式？</h2><p>叫做<a href="http://df.magmawiki.com/index.php/Adventurer_mode" target="_blank" rel="external">冒险模式</a>。基本是一个角色扮演类游戏。你控制一个探险者做任何你想做的事情。在树林纵火？屠龙？被大洞穴蜘蛛杀戮？成为神经病？</p>
<blockquote>
<p>当我进入世界时，立马不喜欢精灵起来。每个在我周围闲逛的精灵我都看着不顺眼。谁知道我花了多久伏击并杀害每个我碰到的精灵。在我做这个时，我忽然对给定足够时间能对精灵产生多大生理和心理伤害感兴趣。每次在荒野碰到该死的精灵，它最终发现他和一个人类摔跤手在森林单挑。我会击碎他的每根骨头。这将花费游戏中的好几天。但后来我发现如果你等他们昏厥后醒来，可以避免造成大量的失血。眼睛里会流出黄色而不是红色的液体。这真他妈的丧心病狂。只要你在他们流血时放慢虐杀，你也会成为变态的精灵杀手。–<a href="http://www.bay12games.com/forum/index.php?topic=27591.msg336669#msg336669" target="_blank" rel="external">Zorgn</a></p>
</blockquote>
<p>(译者表示……真是史上最凶残游戏……)我真的不会多说了。你一定要看看这个<a href="http://www.youtube.com/watch?v=Y5mzqfZF1mM" target="_blank" rel="external">视频</a>去看看冒险模式什么样的。我不擅长解释冒险模式，抱歉。</p>
<blockquote>
<p>你是否在荒野中更饿而不是更渴？下次记得在出发进入荒野前填满你的水袋、买上充足的食物。(译者注：下图是问你要吃血腥的呕吐物还是和呕吐出来的血……真凶残……)</p>
</blockquote>
<p><img src="http://df.zweistein.cz/screens/adventurer_small.png" alt="bloody eat and drink"></p>
<h2 id="是的，关于作者">是的，关于作者</h2><p>你可能好奇这个游戏是如何被创造的的。令人惊奇的是，只有一个作者。有人决定写下他想玩的游戏，开始做它并且决定去完成它。矮人要塞作为一个大团队实际上没能做的游戏，变得令人印象深刻。</p>
<p>当然，有<a href="http://www.bay12games.com/dwarves/dev.html" target="_blank" rel="external">宏伟的计划</a>。基本上，这个目标就是为了提供让<a href="http://www.bay12games.com/dwarves/dev_story.html" target="_blank" rel="external">各种故事在游戏中自然而然中真的发生</a>(就是说不是编程编好的)。看看<a href="http://docs.google.com/Doc?docid=0AT8EQVUjrv96ZGc5cnBwOHZfMjgyY3FzZHFtanA&amp;hl=en" target="_blank" rel="external">某个版本的特性列表</a>。</p>
<blockquote>
<p>首要是处理骷髅的断裂问题。问题在于，骷髅一经构建，剔除所有其它可腐烂的组织，头颅完全是空的(像头骨这样的子部件)。这意味着头骨本质上是浮动分离于脊柱(也是浮动的)。正确处理这些比较麻烦，所以我对它们附上一点完全腐烂的肌肉，把一切放在一起处理。唯一的缺点是偶尔你将看到骷髅的战斗描述中出现肌肉。所有问题都需要精确回答骨骼如何运动和如何支持重量，我他妈的不想回答这些。 –<a href="http://www.bay12games.com/dwarves/dev_now.html" target="_blank" rel="external">开发日志</a></p>
</blockquote>
<h2 id="然而，有一个游戏模组社区不是吗？">然而，有一个游戏模组社区不是吗？</h2><p>是的！当然有游戏模组(MOD)。要是没有将是怎样的游戏？从<a href="http://www.bay12games.com/forum/index.php?topic=22554.75" target="_blank" rel="external">Fallout</a>到<a href="http://www.bay12games.com/forum/index.php?topic=48197.0" target="_blank" rel="external">Elder Scrolls</a>，有<a href="http://www.bay12games.com/forum/index.php?topic=28829.0" target="_blank" rel="external">许多</a>有意思的小改变到完全转变。因为创建新的游戏内容的图像不是问题，改组游戏的人经常相当疯狂。</p>
<p>一个用来调戏的巨人。我们创造一个被挖去一个眼睛的独眼巨人怎么样？</p>
<p><img src="http://df.zweistein.cz/screens/giant_small.png" alt="cyclops"></p>
<p>游戏让<a href="http://df.magmawiki.com/index.php/Modding_Guide" target="_blank" rel="external">修改游戏非常容易</a>。大多数数据文件都是明文格式的，易于编辑。它们几乎包含你可能想要改变的所有东西。</p>
<p>你可以极大地改变任何你想改变的：新文明、矿产、物品、建筑、野兽……</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">173</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/4/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
