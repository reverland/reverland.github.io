<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Reverland, Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Reverland的行知阁" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/default_avatar.jpg?v=0.4.5.2" />






<meta name="description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta property="og:type" content="website">
<meta property="og:title" content="Reverland的行知阁">
<meta property="og:url" content="http://reverland.org/page/12/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reverland的行知阁">
<meta name="twitter:description" content="我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Reverland的行知阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Reverland的行知阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">开放、分享、自由与进步</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/12/02/python/" itemprop="url">
                  python小练习：网络视频下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-12-02T00:00:00+08:00" content="2012-12-02">
              2012-12-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/12/02/python/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/12/02/python/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="python小练习：网络视频下载">python小练习：网络视频下载</h1><p>互联网上有很多视频网站，提供大量视频。可是大多都要求你使用它提供的专有软件才能下载，或者根本没提供下载的地方。在linux下怎么办？总是有办法的。浏览器扩展,<a href="https://github.com/soimort/you-get/tree/master/you_get" target="_blank" rel="external">you-get</a>，直接从硕鼠解析出地址自己下载……</p>
<p>这不是重点，重点是：自己动手玩一玩。</p>
<ul>
<li>顺便学习下几个python标准库：<code>urllib</code>、<code>urllib2</code>、<code>re</code>。</li>
<li>初步学习http报头知识<br>Extra bonus:</li>
<li>flv文件结构</li>
</ul>
<p>都是随便看看。</p>
<h2 id="下载视频">下载视频</h2><p>简单起见，直接从<a href="http://www.flvcd.com/index.htm" target="_blank" rel="external">硕鼠</a>抓取地址。</p>
<p>首先我们随便找一个视频地址，比如来自sina的<a href="http://video.sina.com.cn/v/b/56925622-2257301331.html" target="_blank" rel="external">憨豆特工</a>。我们把地址用硕鼠解析出来看看：</p>
<p><img src="http://fmn.rrfmn.com/fmn058/20121202/2100/original_jaVP_5b4d00008fb1125d.jpg" alt="硕鼠"></p>
<p>哇哦，一个电影被分成15个文件了。</p>
<p>我们接下来要做的就是抓取这十五个视频的地址并把他们下载下来。</p>
<p>也许，用正则是个不错的办法。查看该页面源码，可以找到这样的内容：</p>
<pre><code><span class="variable">&lt;input type="hidden" name="inf" value="&lt;R&gt;</span>憨豆特工
<span class="variable">&lt;T&gt;</span>0
<span class="variable">&lt;F&gt;</span>http://video.sina.com.cn/v/b/56925622-2257301331.html
<span class="variable">&lt;QX&gt;</span>normal
<span class="variable">&lt;$&gt;</span>
<span class="variable">&lt;N&gt;</span>憨豆特工-0001
<span class="variable">&lt;P&gt;</span>新浪网
<span class="variable">&lt;U&gt;</span>http://edge.v.iask.com/56926940.hlv?KID=sina,viask&amp;Expires=1354550400&amp;ssig=0G8Acouy32
<span class="variable">&lt;X&gt;</span>0001
<span class="variable">&lt;C&gt;</span>aHR0cDovL3YuaWFzay5jb20vdl9wbGF5LnBocD92aWQ9NTY5MjU2MjItMjI1NzMwMTMzMSZyPXZpZGVvLnNpbmEuY29tLmNu
<span class="variable">&lt;EXPLODEID&gt;</span>1
<span class="variable">&lt;&amp;&gt;</span>
<span class="variable">&lt;$&gt;</span>
<span class="variable">&lt;N&gt;</span>憨豆特工-0002
<span class="variable">&lt;P&gt;</span>新浪网
<span class="variable">&lt;U&gt;</span>http://edge.v.iask.com/56921791.hlv?KID=sina,viask&amp;Expires=1354550400&amp;ssig=aDBPWf%2B2YH
<span class="variable">&lt;X&gt;</span>0001
<span class="variable">&lt;C&gt;</span>aHR0cDovL3YuaWFzay5jb20vdl9wbGF5LnBocD92aWQ9NTY5MjU2MjItMjI1NzMwMTMzMSZyPXZpZGVvLnNpbmEuY29tLmNu
<span class="variable">&lt;EXPLODEID&gt;</span>2
<span class="variable">&lt;&amp;&gt;</span>
<span class="variable">&lt;$&gt;</span>
<span class="variable">&lt;N&gt;</span>憨豆特工-0003
<span class="variable">&lt;P&gt;</span>新浪网
......
</code></pre><p>显然，<code>&lt;N&gt;</code>后面是片名而<code>&lt;U&gt;</code>后面是地址。</p>
<p>另外，我们观察一下硕鼠当前页面的url地址。</p>
<pre><code><span class="keyword">http</span>://www.flvcd.com/parse.php?kw=http<span class="number">%3</span>A<span class="number">%2</span>F<span class="number">%2</span>Fvideo.sina.com.cn<span class="number">%2</span>Fv<span class="number">%2</span>Fb<span class="number">%2</span>F56925622-2257301331.html
</code></pre><p>显然，kw参数后面是之前sina视频页面地址，只不过已经经过转码处理。</p>
<p>至此，足够我们用python来完成这一切了。</p>
<p>打开ipython：</p>
<pre><code>In <span class="attr_selector">[1]</span><span class="value">: import urllib

In [<span class="number">2</span>]: import urllib2

In [<span class="number">3</span>]: videourl = <span class="string">'http://video.sina.com.cn/v/b/56925622-2257301331.html'</span> 

In [<span class="number">4</span>]: url = <span class="string">'http://www.flvcd.com/parse.php?kw='</span> + urllib.<span class="function">quote</span>(videourl)

In [<span class="number">5</span>]: req = urllib2.<span class="function">Request</span>(url);</span>

In <span class="attr_selector">[6]</span><span class="value">: req.<span class="function">add_header</span>(<span class="string">'host'</span>, <span class="string">'www.flvcd.com'</span>);</span>

In <span class="attr_selector">[7]</span><span class="value">: res = urllib2.<span class="function">urlopen</span>(req)

In [<span class="number">8</span>]: html = res.<span class="function">read</span>()

In [<span class="number">9</span>]: print <span class="function">unicode</span>(html,<span class="string">'gbk'</span>) # 注意硕鼠的页面编码是charset=GB2312</span>
</code></pre><p>至此，我们完成了从硕鼠读取整个网页的操作。并把读取的内容保存在html中。</p>
<p>接下来开始抓地址，根据之前的观察，很容易通过正则表达式完成：</p>
<pre><code>In [<span class="number">13</span>]: import re

In [<span class="number">14</span>]: pattern = re.<span class="function"><span class="title">compile</span><span class="params">(<span class="string">'&lt;input\s+type="hidden"\s+name="inf"\s+value="([^"]+)'</span>)</span></span>

In [<span class="number">15</span>]: match = pattern.<span class="function"><span class="title">search</span><span class="params">(html)</span></span>

In [<span class="number">16</span>]: urls = match.<span class="function"><span class="title">group</span><span class="params">(<span class="number">1</span>)</span></span>

In [<span class="number">17</span>]: urls = <span class="function"><span class="title">unicode</span><span class="params">(urls, <span class="string">'gbk'</span>)</span></span>

In [<span class="number">18</span>]: urlpattern = re.<span class="function"><span class="title">compile</span><span class="params">(<span class="string">'&lt;[NU]&gt;(.+)'</span>)</span></span>

In [<span class="number">19</span>]: result = urlpattern.<span class="function"><span class="title">findall</span><span class="params">(urls)</span></span>
</code></pre><p>至此，<code>&lt;N&gt;</code>和<code>&lt;U&gt;</code>后面的文件名和地址都被以列表的形式保存在result中了。我们可以遍历它来完成下载：</p>
<p>先简单处理下，以文件名-地址成对保存：</p>
<pre><code><span class="type">In</span> [<span class="number">28</span>]: data = [<span class="literal">result</span>[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="type">range</span>(<span class="number">0</span>, len(<span class="literal">result</span>), <span class="number">2</span>)]
</code></pre><p>然后遍历下载：</p>
<pre><code><span class="name">In</span> [<span class="number">32</span>]: <span class="atom">for</span> <span class="atom">k</span>, <span class="atom">v</span> <span class="atom">in</span> <span class="atom">enumerate</span>(<span class="atom">data</span>):                   
    <span class="atom">print</span> <span class="string">'  &gt;downloading Block %.2d ...'</span> <span class="comment">% (k+1,) </span>
    <span class="atom">urllib</span>.<span class="atom">urlretrieve</span>(<span class="atom">v</span>[<span class="number">1</span>], <span class="atom">v</span>[<span class="number">0</span>] + <span class="string">'.flv'</span>) 
    <span class="atom">print</span> <span class="string">'  downloaded Block.%.2d completely&lt;'</span> <span class="comment">% (k+1,)</span>
</code></pre><p>然后？等着……目前的下载器相当简陋，木有进度条，木有断点……</p>
<p>之后就是合并flv的问题了。</p>
<h2 id="合并flv文件">合并flv文件</h2><p>简单起见，直接用这里<a href="https://github.com/soimort/you-get/blob/master/you_get/processor/join_flv.py" target="_blank" rel="external">join_flv.py</a>来完成。</p>
<pre><code>python2 join_flv<span class="class">.py</span> -o out<span class="class">.flv</span> flv1<span class="class">.flv</span> flv2<span class="class">.flv</span> ...
</code></pre><p>如果你想深入了解flv文件结构，参考further reading部分和flv文件<a href="http://download.macromedia.com/f4v/video_file_format_spec_v10_1.pdf" target="_blank" rel="external">规范</a>。</p>
<p><img src="http://fmn.rrimg.com/fmn062/20121203/1830/original_yzzH_5943000093b01191.jpg" alt="flash-data"></p>
<h2 id="Practice">Practice</h2><p>抓取这里的视频。并按名称保存他们:</p>
<ul>
<li><a href="https://class.coursera.org/ml/lecture/preview" target="_blank" rel="external">https://class.coursera.org/ml/lecture/preview</a></li>
<li><a href="http://v.163.com/special/opencourse/machinelearning.html" target="_blank" rel="external">http://v.163.com/special/opencourse/machinelearning.html</a></li>
</ul>
<p>作为正则和urllib、urllib2的练习。</p>
<h2 id="Further_Reading">Further Reading</h2><ul>
<li><a href="http://www.cnblogs.com/-Wind/archive/2012/01/30/dov.html" target="_blank" rel="external">在线视频下载(Using Python / Bash / C / Reguar Expressions)</a></li>
<li><a href="https://www.oschina.net/code/snippet_107925_16025" target="_blank" rel="external">flv文件详解</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_48f93b530100eyoe.html" target="_blank" rel="external">FLV文件格式解析</a></li>
<li><a href="https://github.com/soimort/you-get/blob/master/you_get/processor/join_flv.py" target="_blank" rel="external">you-get</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/11/19/flask/" itemprop="url">
                  Flask驱动的静态站点生成器(译)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-11-19T00:00:00+08:00" content="2012-11-19">
              2012-11-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/11/19/flask/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/11/19/flask/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>翻译自：<a href="https://nicolas.perriault.net/code/2012/dead-easy-yet-powerful-static-website-generator-with-flask/" target="_blank" rel="external">Dead easy yet powerful static website generator with Flask</a></p>
<p>纯意译……以下是正文，和jekyll很像的感觉，哈？34行代码完成一个静态站点生成器。</p>
<hr>
<p>我想将我的在线身份统合到一个单独的托管地方很久了，因此有了你现在浏览的这个网站。我也寻找一个静态网站架构有段时间了，尝试了许多但一个也不中意。这真令人沮丧。</p>
<p>然后遇到<a href="https://twitter.com/#!/mitsuhiko/statuses/166570613295689728" target="_blank" rel="external">Armin Ronacher的这个tweet</a>：</p>
<blockquote class="twitter-tweet tw-align-center"><br>    <p>Frozen-Flask is really, really useful. Should have used that earlier.</p>&mdash; Armin Ronacher (@mitsuhiko) <a href="https://twitter.com/mitsuhiko/status/166570613295689728" data-datetime="2012-02-06T17:15:03+00:00" target="_blank" rel="external">February 6, 2012</a><br></blockquote>

<p><a href="http://lucumr.pocoo.org/" target="_blank" rel="external">Armin</a>是<a href="http://flask.pocoo.org/" target="_blank" rel="external">Flask</a>这个Python微框架的作者，我喜欢flask的简洁。所以这个tweet一个机灵，我便开始探索<a href="http://packages.python.org/Frozen-Flask/" target="_blank" rel="external">Frozen-Flask</a>的玩法。</p>
<p>Frozen-Flask将Flask应用<em>冻结</em>成静态文件，这样你能够高速而无痛地部署它们。再佐以<a href="http://packages.python.org/Flask-FlatPages/" target="_blank" rel="external">Flask-FlatPages</a>，你获得了完美的生成静态站点工具集，这个站点将有所以你使用框架能得到的特性。</p>
<ul>
<li>酷的urls和简单的路径管理</li>
<li>强大的模板</li>
<li>本地动态服务</li>
<li>静态版本管理</li>
</ul>
<h2 id="第一轮：项目搭建">第一轮：项目搭建</h2><p>在新文件夹中创建个新的<a href="http://pypi.python.org/pypi/virtualenv" target="_blank" rel="external">virtualenv</a>，使用<a href="http://pypi.python.org/pypi/pip" target="_blank" rel="external">pip</a>安装必要的包：</p>
<pre><code><span class="variable">$ </span>mkdir sample_project &amp;&amp; cd !<span class="variable">$
</span><span class="variable">$ </span>mkvirtualenv --no-site-packages <span class="string">`pwd`</span>/env
<span class="variable">$ </span>source env/bin/activate
<span class="variable">$ </span>pip install <span class="constant">Flask</span> <span class="constant">Frozen</span>-<span class="constant">Flask</span> <span class="constant">Flask</span>-<span class="constant">FlatPages</span>
</code></pre><p>写我们第一个版本的<code>sitebuilder.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>运行它;你应该看到类似：</p>
<pre><code><span class="variable">$ </span>python sitebuilder.py 
 * <span class="constant">Running</span> on <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:8000/</span> 
 * <span class="constant">Restarting</span> <span class="keyword">with</span> reloader
</code></pre><p>用浏览器打开<em><a href="http://:127.0.0.1:8000" target="_blank" rel="external">http://:127.0.0.1:8000</a></em>看是否正常。</p>
<h2 id="又一轮：添加纯文本页面">又一轮：添加纯文本页面</h2><p><a href="http://packages.python.org/Flask-FlatPages/" target="_blank" rel="external">Flask-FlatPages</a>为你的Flask应用提供一套页面。相对动态页面从关系数据库构建，静态页面是从纯文本文件构建。</p>
<p>在你的项目跟文件夹下创建一个<code>pages/</code>目录，新建一个<code>hello-wolrd.md</code>扔进去：</p>
<p>$ mkdir pages<br>$ vi pages/hello-world.md</p>
<p><code>hello-world.md</code>文件：</p>
<pre><code><span class="attribute">title</span>: <span class="string">Hello World</span>
<span class="attribute">date</span>: <span class="string">2012-03-04</span>

<span class="gherkin"><span class="keyword">*</span><span class="keyword">*</span>Hello World<span class="keyword">*</span><span class="keyword">*</span>, from a <span class="keyword">*</span>page<span class="keyword">*</span>!</span>
</code></pre><p>如你所见你可以在页面内容中写入<a href="/404">Markdown</a>。所以让我们重新写我们的应用来为通过文件名为任何纯文本提供服务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_flatpages <span class="keyword">import</span> FlatPages</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="keyword">True</span></span><br><span class="line">FLATPAGES_AUTO_RELOAD = DEBUG</span><br><span class="line">FLATPAGES_EXTENSION = <span class="string">'.md'</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(__name__)</span><br><span class="line">pages = FlatPages(app)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello World"</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/&lt;path:path&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> pages.get_or_404(path).html</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>现在访问<code>http://127.0.0.1:8000/hello-world/</code>将呈现渲染后的纯文本。注意通过page对象获得html属性markdown源码被转换成html。</p>
<h2 id="又一轮：添加模板">又一轮：添加模板</h2><p>flask使用<a href="http://jinja.pocoo.org/docs/" target="_blank" rel="external">jinja2</a>模板引擎，让我们创建一些模板来装饰页面。首先在项目根目录下创建一个<code>templates</code>文件夹：</p>
<pre><code><span class="variable">$ </span>mkdir templates
</code></pre><p>在<code>templates/base.html</code>中创建基本布局：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>My site<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"&#123;&#123; url_for("</span><span class="value">index")</span> &#125;&#125;"&gt;</span>My site<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>Default content to be displayed<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">&#123;% endblock content %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意<code>url_for()</code>这个模板函数，这是我们使用Flask和Jinjia2生成url的方式。</p>
<p>现在用<code>page.html</code>模板来填充页面内容的布局：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="title">h2</span>&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>我们的应用现在应该是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_flatpages <span class="keyword">import</span> FlatPages</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="keyword">True</span></span><br><span class="line">FLATPAGES_AUTO_RELOAD = DEBUG</span><br><span class="line">FLATPAGES_EXTENSION = <span class="string">'.md'</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(__name__)</span><br><span class="line">pages = FlatPages(app)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello World"</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/&lt;path:path&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(path)</span>:</span></span><br><span class="line">    page = pages.get_or_404(path)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'page.html'</span>, page=page)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>见鬼，我们刚刚做了什么？</p>
<ul>
<li>创建了一个应用的模板;一个通用布局(base.html)和一个页面模板(page.html)</li>
<li>我们使用<code>render_template</code>函数对页面用页面模板装饰。</li>
<li>页面模板扩展基本模板来避免在每个页面都复制粘帖相同的内容。</li>
</ul>
<h2 id="又一轮：在主页呈现页面列表">又一轮：在主页呈现页面列表</h2><p>现在我们的主页弱爆了。我们让它列出所有存在的页面。</p>
<p>创建一个<code>templates/index.html</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="title">h2</span>&gt;</span>List of stuff<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">    &#123;% for page in pages %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"&#123;&#123; url_for("</span><span class="value">page",</span> <span class="attribute">path</span>=<span class="value">page.path)</span> &#125;&#125;"&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span>No stuff.<span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>随意地创建更多纯文本页面，就像我们创建<code>hello-world.md</code>一样，将文件保存在<code>pages/</code>目录下，使用<code>.md</code>扩展名。</p>
<p>我们应用中的<code>index()</code>路径现在应该这样：</p>
<p>重载主页，页面列表将呈现。真他妈简单。</p>
<h2 id="又一轮：给页面添加元数据">又一轮：给页面添加元数据</h2><p>Flask-FlatPages允许像我们创建和<code>hello-world.md</code>的标题和日期一样添加元数据，并且通过<code>page.meta</code>来存取它们，获得看上去蠢蠢的python字典。真令人吃惊，不是吗？</p>
<p>让我们假设想要给页面添加标签，我们的<code>hello-world.md</code>将变成：</p>
<pre><code><span class="attribute">title</span>: <span class="string">Hello World</span>
<span class="attribute">date</span>: <span class="string">2012-03-04</span>
<span class="attribute">tags</span>: <span class="string">[general, awesome, stuff]</span>

<span class="gherkin"><span class="keyword">*</span><span class="keyword">*</span>Hello World<span class="keyword">*</span><span class="keyword">*</span>, from a <span class="keyword">*</span>page<span class="keyword">*</span>!</span>
</code></pre><p>元数据用<a href="http://yaml.org/" target="_blank" rel="external">YAML</a>描述，因此你能够使用字符串、布尔、整数、浮点、列表、甚至字典，它们将转换成Python相应的内在等价物。</p>
<p>我们将使用两个包含共享部分的不同的模板来列出普通页面和标签页面，<code>index.html</code>现在应该是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span>&gt;</span>List of stuff<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">    &#123;% with pages=pages  %&#125;</span><br><span class="line">        &#123;% include "_list.html" %&#125;</span><br><span class="line">    &#123;% endwith %&#125;</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>创建<code>tag.html</code>模板，它将用来呈现标签页面列表：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span>&gt;</span>List of stuff tagged <span class="tag">&lt;<span class="title">em</span>&gt;</span>&#123;&#123; tag &#125;&#125;<span class="tag">&lt;/<span class="title">em</span>&gt;</span><span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">    &#123;% with pages=pages  %&#125;</span><br><span class="line">        &#123;% include "_list.html" %&#125;</span><br><span class="line">    &#123;% endwith %&#125;</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>新建的<code>_list.html</code>模板应该包含：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">&#123;% for page in pages %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"&#123;&#123; url_for("</span><span class="value">page",</span> <span class="attribute">path</span>=<span class="value">page.path)</span> &#125;&#125;"&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">    &#123;% if page.meta.tags|length %&#125;</span><br><span class="line">        | Tagged:</span><br><span class="line">        &#123;% for page_tag in page.meta.tags %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"&#123;&#123; url_for("</span><span class="value">tag",</span> <span class="attribute">tag</span>=<span class="value">page_tag)</span> &#125;&#125;"&gt;</span>&#123;&#123; page_tag &#125;&#125;<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span>No page.<span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>向应用中添加新的tag路径，使用新的<code>tag.html</code>模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@app.route('/tag/&lt;string:tag&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tag</span><span class="params">(tag)</span>:</span></span><br><span class="line">    tagged = [p <span class="keyword">for</span> p <span class="keyword">in</span> pages <span class="keyword">if</span> tag <span class="keyword">in</span> p.meta.get(<span class="string">'tags'</span>, [])]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'tag.html'</span>, pages=tagged, tag=tag)</span><br></pre></td></tr></table></figure>
<p>注：若你之前不喜欢python的<a href="http://www.network-theory.co.uk/docs/pytut/ListComprehensions.html" target="_blank" rel="external">列表推导式</a>，现在你会了。</p>
<h2 id="又一轮：生成静态页面">又一轮：生成静态页面</h2><p>好的，现在我们只要有一个动态网站，为存储在文件系统上的纯文本页面提供服务：废话。但是我们当然不是Flask应用而是一堆静态文件，省去了任何应用服务器。</p>
<p>来进入Frozen-Flask。它的使用真他妈简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_flatpages <span class="keyword">import</span> FlatPages</span><br><span class="line"><span class="keyword">from</span> flask_frozen <span class="keyword">import</span> Freezer</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="keyword">True</span></span><br><span class="line">FLATPAGES_AUTO_RELOAD = DEBUG</span><br><span class="line">FLATPAGES_EXTENSION = <span class="string">'.md'</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(__name__)</span><br><span class="line">pages = FlatPages(app)</span><br><span class="line">freezer = Freezer(app)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, pages=pages)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/tag/&lt;string:tag&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tag</span><span class="params">(tag)</span>:</span></span><br><span class="line">    tagged = [p <span class="keyword">for</span> p <span class="keyword">in</span> pages <span class="keyword">if</span> tag <span class="keyword">in</span> p.meta.get(<span class="string">'tags'</span>, [])]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'tag.html'</span>, pages=tagged, tag=tag)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@app.route('/&lt;path:path&gt;/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(path)</span>:</span></span><br><span class="line">    page = pages.get_or_404(path)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'page.html'</span>, page=page)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">"build"</span>:</span><br><span class="line">        freezer.freeze()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        app.run(port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>然后运行：</p>
<pre><code>$ python sitebuilder<span class="class">.py</span> build
</code></pre><p>打开构建文件夹键入如下命令：</p>
<pre><code>$ tree
.
├── hello-world
│   └── index<span class="class">.html</span>
├── index<span class="class">.html</span>
└── tag
    ├── awesome
    │   └── index<span class="class">.html</span>
    ├── general
    │   └── index<span class="class">.html</span>
    └── stuff
        └── index<span class="class">.html</span>

<span class="number">5</span> directories, <span class="number">5</span> files
</code></pre><h2 id="想法：吓坏了">想法：吓坏了</h2><p>你现在能部署<code>build</code>目录下的任何文件到任何能托管静态文件的地方了，而你仅仅用34行Python代码就完成了……不错吧？</p>
<p>当然，现在的版本弱爆了，你能一点一点的为它添加各种特性了。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/11/12/numpyscipy/" itemprop="url">
                  使用Numpy和Scipy处理图像
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-11-12T00:00:00+08:00" content="2012-11-12">
              2012-11-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/11/12/numpyscipy/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/11/12/numpyscipy/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Image_manipulation_and_processing_using_Numpy_and_Scipy">Image manipulation and processing using Numpy and Scipy</h1><p>翻译自：<a href="http://scipy-lectures.github.com/advanced/image_processing/index.html" target="_blank" rel="external">http://scipy-lectures.github.com/advanced/image_processing/index.html</a></p>
<p>作者：Emmanuelle Gouillart, Gaël Varoquaux</p>
<pre><code>图像 = <span class="number">2</span>-D 数值数组

(或者 <span class="number">3</span>-D: CT, MRI, <span class="number">2</span>D + 时间; <span class="number">4</span>-D, ...)

这里 图像 == Numpy数组 np.<span class="built_in">array</span>
</code></pre><p>这个教程中使用的工具：</p>
<ul>
<li>numpy：基本数组操作</li>
<li><p>scipy：<code>scipy.ndimage</code>子模块致力于图像处理(n维图像)。参见<a href="http://docs.scipy.org/doc/scipy/reference/tutorial/ndimage.html" target="_blank" rel="external">http://docs.scipy.org/doc/scipy/reference/tutorial/ndimage.html</a></p>
<pre><code><span class="keyword">from</span> scipy <span class="keyword">import</span> ndimage
</code></pre></li>
<li><p>一些例子用到了使用np.array的特殊的工具箱：</p>
<ul>
<li><a href="http://scikits-image.org/" target="_blank" rel="external">Scikit Image</a></li>
<li><a href="http://scikit-learn.org/" target="_blank" rel="external">scikit-learn</a></li>
</ul>
</li>
</ul>
<p>图像中的常见问题有：</p>
<ul>
<li>输入/输出，呈现图像</li>
<li>基本操作：裁剪、翻转、旋转……</li>
<li>图像滤镜：消噪，锐化</li>
<li>图像分割：不同对应对象的像素标记</li>
</ul>
<p>更有力和完整的模块：</p>
<ul>
<li><a href="http://opencv.willowgarage.com/documentation/python/cookbook.html" target="_blank" rel="external">OpenCV</a> (Python绑定)</li>
<li><a href="http://www.cellprofiler.org/" target="_blank" rel="external">CellProfiler</a></li>
<li><a href="http://www.itk.org/" target="_blank" rel="external">ITK</a>,Python绑定</li>
<li>更多……</li>
</ul>
<p><strong>目录</strong></p>
<ul>
<li>toc<br>{: toc}</li>
</ul>
<h2 id="打开和读写图像文件">打开和读写图像文件</h2><p>将一个数组写入文件：</p>
<pre><code><span class="keyword">In</span> [1]: from scipy import misc

<span class="keyword">In</span> [2]: <span class="keyword">l</span> = misc.lena()

<span class="keyword">In</span> [3]: misc.imsave('lena.png', <span class="keyword">l</span>)  # uses the Image module (PIL)

<span class="keyword">In</span> [4]: import pylab <span class="keyword">as</span> <span class="keyword">pl</span>

<span class="keyword">In</span> [5]: <span class="keyword">pl</span>.imshow(<span class="keyword">l</span>)
<span class="keyword">Out</span>[5]: &lt;matplotlib.image.AxesImage at 0x4118110&gt;
</code></pre><p>从一个图像文件创建数组：</p>
<pre><code>In [<span class="number">7</span>]: lena = misc.<span class="function"><span class="title">imread</span><span class="params">(<span class="string">'lena.png'</span>)</span></span>

In [<span class="number">8</span>]: <span class="function"><span class="title">type</span><span class="params">(lena)</span></span>
Out[<span class="number">8</span>]: numpy<span class="class">.ndarray</span>

In [<span class="number">9</span>]: lena<span class="class">.shape</span>, lena<span class="class">.dtype</span>
Out[<span class="number">9</span>]: ((<span class="number">512</span>, <span class="number">512</span>), <span class="function"><span class="title">dtype</span><span class="params">(<span class="string">'uint8'</span>)</span></span>)
</code></pre><p>8位图像(0-255)的dtype是uint8</p>
<p>打开一个raw文件(相机， 3-D图像)</p>
<pre><code><span class="keyword">In</span> [<span class="number">10</span>]: l.tofile(<span class="string">'lena.raw'</span>)  # 创建一个raw文件

<span class="keyword">In</span> [<span class="number">14</span>]: lena_from_raw = np.fromfile(<span class="string">'lena.raw'</span>, dtype=np.int64)

<span class="keyword">In</span> [<span class="number">15</span>]: lena_from_raw.shape
<span class="keyword">Out</span>[<span class="number">15</span>]: (<span class="number">262144</span>,)

<span class="keyword">In</span> [<span class="number">16</span>]: lena_from_raw.shape = (<span class="number">512</span>, <span class="number">512</span>)

<span class="keyword">In</span> [<span class="number">17</span>]: import os

<span class="keyword">In</span> [<span class="number">18</span>]: os.<span class="keyword">remove</span>(<span class="string">'lena.raw'</span>)
</code></pre><p>需要知道图像的shape和dtype(如何区分隔数据字节)</p>
<p>对于大数据，使用<code>np.memmap</code>进行内存映射：</p>
<pre><code>In [<span class="number">21</span>]: lena_memmap = np.<span class="function"><span class="title">memmap</span><span class="params">(<span class="string">'lena.raw'</span>, dtype=np.int64, shape=(<span class="number">512</span>,<span class="number">512</span>)</span></span>)
</code></pre><p>(数据从文件读取，而不是载入内存)</p>
<p>处理一个列表的图像文件：</p>
<pre><code>In [<span class="number">22</span>]: <span class="keyword">for</span> <span class="tag">i</span> <span class="keyword">in</span> <span class="function"><span class="title">range</span><span class="params">(<span class="number">10</span>)</span></span>:
   ....:     im = np<span class="class">.random</span><span class="class">.random_integers</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">10000</span>).<span class="function"><span class="title">reshape</span><span class="params">((<span class="number">100</span>, <span class="number">100</span>)</span></span>)
   ....:     misc.<span class="function"><span class="title">imsave</span><span class="params">(<span class="string">'random_%02d.png'</span> % i, im)</span></span>
   ....:     

In [<span class="number">23</span>]: from glob import glob

In [<span class="number">24</span>]: filelist = <span class="function"><span class="title">glob</span><span class="params">(<span class="string">'random*.png'</span>)</span></span>

In [<span class="number">25</span>]: filelist.<span class="function"><span class="title">sort</span><span class="params">()</span></span>
</code></pre><h2 id="呈现图像">呈现图像</h2><p>使用<code>matplotlib</code>和<code>imshow</code>将图像呈现在matplotlib图像(figure)中：</p>
<pre><code>In [<span class="number">29</span>]: l = misc.<span class="function"><span class="title">lena</span><span class="params">()</span></span>

In [<span class="number">30</span>]: import matplotlib<span class="class">.pyplot</span> as plt

In [<span class="number">31</span>]: plt.<span class="function"><span class="title">imshow</span><span class="params">(l, cmap=plt.cm.gray)</span></span>
Out[<span class="number">31</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x4964990&gt;
</code></pre><p>通过设置最大最小之增加对比：</p>
<pre><code><span class="keyword">In</span> [<span class="number">33</span>]: plt.imshow(l, cmap=plt.cm.gray, vmin=<span class="number">30</span>, vmax=<span class="number">200</span>)
<span class="keyword">Out</span>[<span class="number">33</span>]: &lt;matplotlib.image.AxesImage <span class="preprocessor">at</span> <span class="number">0x50cb790</span>&gt;

<span class="keyword">In</span> [<span class="number">34</span>]: plt.axis(<span class="string">'off'</span>)  # 移除axes和ticks
<span class="keyword">Out</span>[<span class="number">34</span>]: (-<span class="number">0.5</span>, <span class="number">511.5</span>, <span class="number">511.5</span>, -<span class="number">0.5</span>)
</code></pre><p>绘制等高线：<a href="占位">^1</a></p>
<pre><code>ln[<span class="number">7</span>]: plt.contour(l, [<span class="number">60</span>, <span class="number">211</span>])
</code></pre><p>更好地观察强度变化，使用<code>interpolate=‘nearest’</code>：</p>
<pre><code>In [<span class="number">7</span>]: plt.<span class="function"><span class="title">imshow</span><span class="params">(l[<span class="number">200</span>:<span class="number">220</span>, <span class="number">200</span>:<span class="number">220</span>], cmap=plt.cm.gray)</span></span>
Out[<span class="number">7</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x3bbe610&gt;

In [<span class="number">8</span>]: plt.<span class="function"><span class="title">imshow</span><span class="params">(l[<span class="number">200</span>:<span class="number">220</span>, <span class="number">200</span>:<span class="number">220</span>], cmap=plt.cm.gray, interpolation=<span class="string">'nearest'</span>)</span></span>
Out[<span class="number">8</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x3ed3250&gt;
</code></pre><p>其它包有时使用图形工具箱来可视化(GTK，Qt)：[^2]</p>
<pre><code>In [<span class="number">9</span>]: import skimage<span class="class">.io</span> as im_io

In [<span class="number">21</span>]: im_io.<span class="function"><span class="title">use_plugin</span><span class="params">(<span class="string">'gtk'</span>, <span class="string">'imshow'</span>)</span></span>

In [<span class="number">22</span>]: im_io.<span class="function"><span class="title">imshow</span><span class="params">(l)</span></span>
</code></pre><p><strong>3-D可视化：Mayavi</strong></p>
<p>参见<a href="http://scipy-lectures.github.com/advanced/3d_plotting/index.html#mayavi-label" target="_blank" rel="external">可用Mayavi进行3-D绘图</a>和<a href="http://scipy-lectures.github.com/advanced/3d_plotting/3d_plotting_functions.html#mayavi-voldata-label" target="_blank" rel="external">体积数据</a></p>
<ul>
<li>图形平面工具</li>
<li>等值面</li>
<li>……</li>
</ul>
<h2 id="基本操作">基本操作</h2><p>图像是数组：使用整个<code>numpy</code>机理。</p>
<p><img src="http://scipy-lectures.github.com/_images/axis_convention.png" alt="basic"></p>
<pre><code>&gt;&gt;&gt; lena = misc.lena()
&gt;&gt;&gt; lena[<span class="number">0</span>, <span class="number">40</span>]
<span class="number">166</span>
&gt;&gt;&gt; <span class="preprocessor"># Slicing</span>
&gt;&gt;&gt; lena[<span class="number">10</span>:<span class="number">13</span>, <span class="number">20</span>:<span class="number">23</span>]
<span class="built_in">array</span>([[<span class="number">158</span>, <span class="number">156</span>, <span class="number">157</span>],
[<span class="number">157</span>, <span class="number">155</span>, <span class="number">155</span>],
[<span class="number">157</span>, <span class="number">157</span>, <span class="number">158</span>]])
&gt;&gt;&gt; lena[<span class="number">100</span>:<span class="number">120</span>] = <span class="number">255</span>
&gt;&gt;&gt;
&gt;&gt;&gt; lx, ly = lena.shape
&gt;&gt;&gt; X, Y = np.ogrid[<span class="number">0</span>:lx, <span class="number">0</span>:ly]
&gt;&gt;&gt; mask = (X - lx/<span class="number">2</span>)**<span class="number">2</span> + (Y - ly/<span class="number">2</span>)**<span class="number">2</span> &gt; lx*ly/<span class="number">4</span>
&gt;&gt;&gt; <span class="preprocessor"># Masks</span>
&gt;&gt;&gt; lena[mask] = <span class="number">0</span>
&gt;&gt;&gt; <span class="preprocessor"># Fancy indexing</span>
&gt;&gt;&gt; lena[range(<span class="number">400</span>), range(<span class="number">400</span>)] = <span class="number">255</span>
</code></pre><h3 id="统计信息">统计信息</h3><pre><code>&gt;&gt;&gt; lena = scipy.<span class="function"><span class="title">lena</span><span class="params">()</span></span>
&gt;&gt;&gt; lena.<span class="function"><span class="title">mean</span><span class="params">()</span></span>
<span class="number">124.04678344726562</span>
&gt;&gt;&gt; lena.<span class="function"><span class="title">max</span><span class="params">()</span></span>, lena.<span class="function"><span class="title">min</span><span class="params">()</span></span>
(<span class="number">245</span>, <span class="number">25</span>)
</code></pre><p><code>np.histogram</code></p>
<h3 id="几何转换">几何转换</h3><pre><code><span class="prompt">&gt;&gt;</span>&gt; lena = scipy.lena()
<span class="prompt">&gt;&gt;</span>&gt; lx, ly = lena.shape
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># Cropping</span>
<span class="prompt">&gt;&gt;</span>&gt; crop_lena = lena[lx/<span class="number">4</span><span class="symbol">:-lx/</span><span class="number">4</span>, ly/<span class="number">4</span><span class="symbol">:-ly/</span><span class="number">4</span>]
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># up &lt;-&gt; down flip</span>
<span class="prompt">&gt;&gt;</span>&gt; flip_ud_lena = np.flipud(lena)
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># rotation</span>
<span class="prompt">&gt;&gt;</span>&gt; rotate_lena = ndimage.rotate(lena, <span class="number">45</span>)
<span class="prompt">&gt;&gt;</span>&gt; rotate_lena_noreshape = ndimage.rotate(lena, <span class="number">45</span>, reshape=<span class="constant">False</span>)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_geom_lena_1.png" alt="Geometrical transformations"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_geom_lena.html#example-plot-geom-lena-py" target="_blank" rel="external">示例源码</a></p>
<h2 id="图像滤镜">图像滤镜</h2><p><strong>局部滤镜</strong>：用相邻像素值的函数替代当前像素的值。</p>
<p>相邻：方形(指定大小)，圆形， 或者更多复杂的<em>结构元素</em>。</p>
<h3 id="模糊/平滑">模糊/平滑</h3><p><code>scipy.ndimage</code>中的<em>高斯滤镜</em>：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; from scipy import misc
<span class="prompt">&gt;&gt;</span>&gt; from scipy import ndimage
<span class="prompt">&gt;&gt;</span>&gt; lena = misc.lena()
<span class="prompt">&gt;&gt;</span>&gt; blurred_lena = ndimage.gaussian_filter(lena, sigma=<span class="number">3</span>)
<span class="prompt">&gt;&gt;</span>&gt; very_blurred = ndimage.gaussian_filter(lena, sigma=<span class="number">5</span>)
</code></pre><p><em>均匀滤镜</em></p>
<pre><code>&gt;&gt;&gt; local_mean = ndimage.<span class="function"><span class="title">uniform_filter</span><span class="params">(lena, size=<span class="number">11</span>)</span></span>
</code></pre><p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_blur.html#example-plot-blur-py" target="_blank" rel="external">示例源码</a></p>
<h3 id="锐化">锐化</h3><p>锐化模糊图像：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; from scipy import misc
<span class="prompt">&gt;&gt;</span>&gt; lena = misc.lena()
<span class="prompt">&gt;&gt;</span>&gt; blurred_l = ndimage.gaussian_filter(lena, <span class="number">3</span>)
</code></pre><p>通过增加拉普拉斯近似增加边缘权重：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; filter_blurred_l = ndimage.gaussian_filter(blurred_l, <span class="number">1</span>)
<span class="prompt">&gt;&gt;</span>&gt; alpha = <span class="number">30</span>
<span class="prompt">&gt;&gt;</span>&gt; sharpened = blurred_l + alpha * (blurred_l - filter_blurred_l)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_sharpen_1.png" alt="sharpen"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_sharpen.html#example-plot-sharpen-py" target="_blank" rel="external">示例源码</a></p>
<h3 id="消噪">消噪</h3><p>向lena增加噪声：</p>
<pre><code>&gt;&gt;&gt; from scipy import misc
&gt;&gt;&gt; l = misc.<span class="function"><span class="title">lena</span><span class="params">()</span></span>
&gt;&gt;&gt; l = l[<span class="number">230</span>:<span class="number">310</span>, <span class="number">210</span>:<span class="number">350</span>]
&gt;&gt;&gt; noisy = l + <span class="number">0.4</span>*l.<span class="function"><span class="title">std</span><span class="params">()</span></span>*np<span class="class">.random</span><span class="class">.random</span>(l.shape)
</code></pre><p><em>高斯滤镜</em>平滑掉噪声……还有边缘：</p>
<pre><code>&gt;&gt;&gt; gauss_denoised = ndimage.<span class="function"><span class="title">gaussian_filter</span><span class="params">(noisy, <span class="number">2</span>)</span></span>
</code></pre><p>大多局部线性各向同性滤镜都模糊图像(<code>ndimage.uniform_filter</code>)</p>
<p><em>中值滤镜</em>更好地保留边缘：</p>
<pre><code>&gt;&gt;&gt; med_denoised = ndimage.<span class="function"><span class="title">median_filter</span><span class="params">(noisy, <span class="number">3</span>)</span></span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_lena_denoise_1.png" alt="guassian&amp;median"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_lena_denoise.html#example-plot-lena-denoise-py" target="_blank" rel="external">示例源码</a></p>
<p>中值滤镜：对直边界效果更好(低曲率)：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; im = np.zeros((<span class="number">20</span>, <span class="number">20</span>))
<span class="prompt">&gt;&gt;</span>&gt; im[<span class="number">5</span><span class="symbol">:-</span><span class="number">5</span>, <span class="number">5</span><span class="symbol">:-</span><span class="number">5</span>] = <span class="number">1</span>
<span class="prompt">&gt;&gt;</span>&gt; im = ndimage.distance_transform_bf(im)
<span class="prompt">&gt;&gt;</span>&gt; im_noise = im + <span class="number">0</span>.<span class="number">2</span>*np.random.randn(*im.shape)
<span class="prompt">&gt;&gt;</span>&gt; im_med = ndimage.median_filter(im_noise, <span class="number">3</span>)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_denoising_1.png" alt="median"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_denoising.html#example-plot-denoising-py" target="_blank" rel="external">示例源码</a></p>
<p>其它排序滤波器：<code>ndimage.maximum_filter</code>,<code>ndimage.percentile_filter</code></p>
<p>其它局部非线性滤波器：维纳滤波器(<code>scipy.signal.wiener</code>)等</p>
<p><strong>非局部滤波器</strong></p>
<p><em>总变差(TV)</em>消噪。找到新的图像让图像的总变差(正态L1梯度的积分)变得最小，当接近测量图像时：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># from skimage.filter import tv_denoise</span>
<span class="prompt">&gt;&gt;</span>&gt; from tv_denoise import tv_denoise
<span class="prompt">&gt;&gt;</span>&gt; tv_denoised = tv_denoise(noisy, weight=<span class="number">10</span>)
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># More denoising (to the expense of fidelity to data)</span>
<span class="prompt">&gt;&gt;</span>&gt; tv_denoised = tv_denoise(noisy, weight=<span class="number">50</span>)
</code></pre><p>总变差滤镜<code>tv_denoise</code>可以从<code>skimage</code>中获得，(文档:<a href="http://scikit-image.org/docs/dev/api/skimage.filter.html#denoise-tv" target="_blank" rel="external">http://scikit-image.org/docs/dev/api/skimage.filter.html#denoise-tv</a>)，但是为了方便我们在这个教程中作为一个<em>单独模块</em>导入。</p>
<p><img src="http://scipy-lectures.github.com/_images/plot_lena_tv_denoise_1.png" alt="tv"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_lena_tv_denoise.html#example-plot-lena-tv-denoise-py" target="_blank" rel="external">示例源码</a></p>
<h3 id="数学形态学">数学形态学</h3><p>参见：<a href="http://en.wikipedia.org/wiki/Mathematical_morphology" target="_blank" rel="external">http://en.wikipedia.org/wiki/Mathematical_morphology</a></p>
<p><em>结构元素</em>：</p>
<pre><code>&gt;&gt;&gt; el = ndimage.generate_binary_structure(<span class="number">2</span>, <span class="number">1</span>)
&gt;&gt;&gt; el
<span class="keyword">array</span>([[<span class="keyword">False</span>,  <span class="keyword">True</span>, <span class="keyword">False</span>],
       [ <span class="keyword">True</span>,  <span class="keyword">True</span>,  <span class="keyword">True</span>],
       [<span class="keyword">False</span>,  <span class="keyword">True</span>, <span class="keyword">False</span>]], dtype=<span class="keyword">bool</span>)
&gt;&gt;&gt; el.astype(np.<span class="keyword">int</span>)
<span class="keyword">array</span>([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]])
</code></pre><p><em>腐蚀</em> = 最小化滤镜。用结构元素覆盖的像素的最小值替代一个像素值：</p>
<pre><code>&gt;&gt;&gt; a = np.zeros((7,7), dtype=np.int)
&gt;&gt;&gt; a<span class="comment">[1:6, 2:5]</span> = 1
&gt;&gt;&gt; a
array(<span class="comment">[<span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 1, 1, 1, 0, 0]</span>,
       <span class="comment">[0, 0, 1, 1, 1, 0, 0]</span>,
       <span class="comment">[0, 0, 1, 1, 1, 0, 0]</span>,
       <span class="comment">[0, 0, 1, 1, 1, 0, 0]</span>,
       <span class="comment">[0, 0, 1, 1, 1, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>]</span>)
&gt;&gt;&gt; ndimage.binary_erosion(a).astype(a.dtype)
array(<span class="comment">[<span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 1, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 1, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 1, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>]</span>)
&gt;&gt;&gt; #Erosion removes objects smaller than the structure
&gt;&gt;&gt; ndimage.binary_erosion(a, structure=np.ones((5,5))).astype(a.dtype)
array(<span class="comment">[<span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>,
       <span class="comment">[0, 0, 0, 0, 0, 0, 0]</span>]</span>)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/morpho_mat.png" alt="erosion"></p>
<p><em>膨胀</em>：最大化滤镜:</p>
<pre><code>&gt;&gt;&gt; <span class="tag">a</span> = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">5</span>, <span class="number">5</span>)</span></span>)
&gt;&gt;&gt; <span class="tag">a</span>[<span class="number">2</span>, <span class="number">2</span>] = <span class="number">1</span>
&gt;&gt;&gt; <span class="tag">a</span>
array([[ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">1</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.]])
&gt;&gt;&gt; ndimage.<span class="function"><span class="title">binary_dilation</span><span class="params">(a)</span></span>.<span class="function"><span class="title">astype</span><span class="params">(a.dtype)</span></span>
array([[ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">1</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">1</span>.,  <span class="number">1</span>.,  <span class="number">1</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">1</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.],
       [ <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.,  <span class="number">0</span>.]])
</code></pre><p>对灰度值图像也有效：</p>
<pre><code>&gt;&gt;&gt; np<span class="class">.random</span><span class="class">.seed</span>(<span class="number">2</span>)
&gt;&gt;&gt; x, y = (<span class="number">63</span>*np<span class="class">.random</span><span class="class">.random</span>((<span class="number">2</span>, <span class="number">8</span>))).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>
&gt;&gt;&gt; im[x, y] = np.<span class="function"><span class="title">arange</span><span class="params">(<span class="number">8</span>)</span></span>

&gt;&gt;&gt; bigger_points = ndimage.<span class="function"><span class="title">grey_dilation</span><span class="params">(im, size=(<span class="number">5</span>, <span class="number">5</span>)</span></span>, structure=np.<span class="function"><span class="title">ones</span><span class="params">((<span class="number">5</span>, <span class="number">5</span>)</span></span>))

&gt;&gt;&gt; square = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">16</span>, <span class="number">16</span>)</span></span>)
&gt;&gt;&gt; square[<span class="number">4</span>:-<span class="number">4</span>, <span class="number">4</span>:-<span class="number">4</span>] = <span class="number">1</span>
&gt;&gt;&gt; dist = ndimage.<span class="function"><span class="title">distance_transform_bf</span><span class="params">(square)</span></span>
&gt;&gt;&gt; dilate_dist = ndimage.<span class="function"><span class="title">grey_dilation</span><span class="params">(dist, size=(<span class="number">3</span>, <span class="number">3</span>)</span></span>, \
...         structure=np.<span class="function"><span class="title">ones</span><span class="params">((<span class="number">3</span>, <span class="number">3</span>)</span></span>))
</code></pre><p><img src="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_greyscale_dilation.html" alt="gray-delation"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_greyscale_dilation.html#example-plot-greyscale-dilation-py" target="_blank" rel="external">示例源码</a></p>
<p><em>开操作</em>：腐蚀+膨胀：</p>
<p><em>应用</em>：移除噪声</p>
<pre><code>&gt;&gt;&gt; square = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">32</span>, <span class="number">32</span>)</span></span>)
&gt;&gt;&gt; square[<span class="number">10</span>:-<span class="number">10</span>, <span class="number">10</span>:-<span class="number">10</span>] = <span class="number">1</span>
&gt;&gt;&gt; np<span class="class">.random</span><span class="class">.seed</span>(<span class="number">2</span>)
&gt;&gt;&gt; x, y = (<span class="number">32</span>*np<span class="class">.random</span><span class="class">.random</span>((<span class="number">2</span>, <span class="number">20</span>))).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>
&gt;&gt;&gt; square[x, y] = <span class="number">1</span>

&gt;&gt;&gt; open_square = ndimage.<span class="function"><span class="title">binary_opening</span><span class="params">(square)</span></span>

&gt;&gt;&gt; eroded_square = ndimage.<span class="function"><span class="title">binary_erosion</span><span class="params">(square)</span></span>
&gt;&gt;&gt; reconstruction = ndimage.<span class="function"><span class="title">binary_propagation</span><span class="params">(eroded_square, mask=square)</span></span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_propagation_1.png" alt="application"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_propagation.html#example-plot-propagation-py" target="_blank" rel="external">示例源码</a></p>
<p><em>闭操作</em>：膨胀+腐蚀</p>
<p>许多其它数学分形：击中(hit)和击不中(miss)变换，tophat等等。</p>
<h2 id="特征提取">特征提取</h2><h3 id="边缘检测">边缘检测</h3><p>合成数据：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; im = np.zeros((<span class="number">256</span>, <span class="number">256</span>))
<span class="prompt">&gt;&gt;</span>&gt; im[<span class="number">64</span><span class="symbol">:-</span><span class="number">64</span>, <span class="number">64</span><span class="symbol">:-</span><span class="number">64</span>] = <span class="number">1</span>
<span class="prompt">&gt;&gt;</span>&gt;
&gt;&gt;&gt; im = ndimage.rotate(im, <span class="number">15</span>, mode=<span class="string">'constant'</span>)
<span class="prompt">&gt;&gt;</span>&gt; im = ndimage.gaussian_filter(im, <span class="number">8</span>)
</code></pre><p>使用<em>梯度操作(Sobel)</em>来找到搞强度的变化：</p>
<pre><code>&gt;&gt;&gt; sx = ndimage.<span class="function"><span class="title">sobel</span><span class="params">(im, axis=<span class="number">0</span>, mode=<span class="string">'constant'</span>)</span></span>
&gt;&gt;&gt; sy = ndimage.<span class="function"><span class="title">sobel</span><span class="params">(im, axis=<span class="number">1</span>, mode=<span class="string">'constant'</span>)</span></span>
&gt;&gt;&gt; sob = np.<span class="function"><span class="title">hypot</span><span class="params">(sx, sy)</span></span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_find_edges_1.png" alt="sob"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_find_edges.html#example-plot-find-edges-py" target="_blank" rel="external">示例源码</a></p>
<p><em>canny滤镜</em></p>
<p>Canny滤镜可以从<code>skimage</code>中获取(<a href="http://scikit-image.org/docs/dev/api/skimage.filter.html#canny" target="_blank" rel="external">文档</a>)，但是为了方便我们在这个教程中作为一个<em>单独模块</em>导入：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; <span class="comment">#from skimage.filter import canny</span>
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment">#or use module shipped with tutorial</span>
<span class="prompt">&gt;&gt;</span>&gt; im += <span class="number">0</span>.<span class="number">1</span>*np.random.random(im.shape)
<span class="prompt">&gt;&gt;</span>&gt; edges = canny(im, <span class="number">1</span>, <span class="number">0</span>.<span class="number">4</span>, <span class="number">0</span>.<span class="number">2</span>) <span class="comment"># not enough smoothing</span>
<span class="prompt">&gt;&gt;</span>&gt; edges = canny(im, <span class="number">3</span>, <span class="number">0</span>.<span class="number">3</span>, <span class="number">0</span>.<span class="number">2</span>) <span class="comment"># better parameters</span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_canny_1.png" alt="edge"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_canny.html#example-plot-canny-py" target="_blank" rel="external">示例源码</a></p>
<p>需要调整几个参数……过度拟合的风险</p>
<h3 id="分割">分割</h3><ul>
<li><p>基于<em>直方图</em>的分割(没有空间信息)</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; n = <span class="number">10</span>
<span class="prompt">&gt;&gt;</span>&gt; l = <span class="number">256</span>
<span class="prompt">&gt;&gt;</span>&gt; im = np.zeros((l, l))
<span class="prompt">&gt;&gt;</span>&gt; np.random.seed(<span class="number">1</span>)
<span class="prompt">&gt;&gt;</span>&gt; points = l*np.random.random((<span class="number">2</span>, n**<span class="number">2</span>))
<span class="prompt">&gt;&gt;</span>&gt; im[(points[<span class="number">0</span>]).astype(np.int), (points[<span class="number">1</span>]).astype(np.int)] = <span class="number">1</span>
<span class="prompt">&gt;&gt;</span>&gt; im = ndimage.gaussian_filter(im, sigma=l/(<span class="number">4</span>.*n))

<span class="prompt">&gt;&gt;</span>&gt; mask = (im &gt; im.mean()).astype(np.float)
<span class="prompt">&gt;&gt;</span>&gt; mask += <span class="number">0</span>.<span class="number">1</span> * im
<span class="prompt">&gt;&gt;</span>&gt; img = mask + <span class="number">0</span>.<span class="number">2</span>*np.random.randn(*mask.shape)

<span class="prompt">&gt;&gt;</span>&gt; hist, bin_edges = np.histogram(img, bins=<span class="number">60</span>)
<span class="prompt">&gt;&gt;</span>&gt; bin_centers = <span class="number">0</span>.<span class="number">5</span>*(bin_edges[<span class="symbol">:-</span><span class="number">1</span>] + bin_edges[<span class="number">1</span><span class="symbol">:</span>])

<span class="prompt">&gt;&gt;</span>&gt; binary_img = img &gt; <span class="number">0</span>.<span class="number">5</span>
</code></pre></li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/plot_histo_segmentation_1.png" alt="segmente"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_histo_segmentation.html#example-plot-histo-segmentation-py" target="_blank" rel="external">示例源码</a></p>
<p>自动阈值：使用高斯混合模型：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; mask = (im &gt; im.mean()).astype(np.float)
<span class="prompt">&gt;&gt;</span>&gt; mask += <span class="number">0</span>.<span class="number">1</span> * im
<span class="prompt">&gt;&gt;</span>&gt; img = mask + <span class="number">0</span>.<span class="number">3</span>*np.random.randn(*mask.shape)

<span class="prompt">&gt;&gt;</span>&gt; from sklearn.mixture import <span class="constant">GMM</span>
<span class="prompt">&gt;&gt;</span>&gt; classif = <span class="constant">GMM</span>(n_components=<span class="number">2</span>)
<span class="prompt">&gt;&gt;</span>&gt; classif.fit(img.reshape((img.size, <span class="number">1</span>))) 
<span class="constant">GMM</span>(...)

<span class="prompt">&gt;&gt;</span>&gt; classif.means<span class="number">_</span>
array([[ <span class="number">0</span>.<span class="number">9353155</span> ],
       [-<span class="number">0</span>.<span class="number">02</span>966039]])
<span class="prompt">&gt;&gt;</span>&gt; np.sqrt(classif.covars<span class="number">_</span>).ravel()
array([ <span class="number">0</span>.<span class="number">35074631</span>,  <span class="number">0</span>.<span class="number">28225327</span>])
<span class="prompt">&gt;&gt;</span>&gt; classif.weights<span class="number">_</span>
array([ <span class="number">0</span>.<span class="number">40989799</span>,  <span class="number">0</span>.<span class="number">59010201</span>])
<span class="prompt">&gt;&gt;</span>&gt; threshold = np.mean(classif.means<span class="number">_</span>)
<span class="prompt">&gt;&gt;</span>&gt; binary_img = img &gt; threshold
</code></pre><p><img src="http://scipy-lectures.github.com/_images/image_GMM.png" alt="gauss-mixture"></p>
<p>使用数学形态学来清理结果：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># Remove small white regions</span>
<span class="prompt">&gt;&gt;</span>&gt; open_img = ndimage.binary_opening(binary_img)
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># Remove small black hole</span>
<span class="prompt">&gt;&gt;</span>&gt; close_img = ndimage.binary_closing(open_img)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_clean_morpho_1.png" alt="cleanup"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_clean_morpho.html#example-plot-clean-morpho-py" target="_blank" rel="external">示例源码</a></p>
<p><strong>练习</strong></p>
<p>参看重建(reconstruction)操作(腐蚀+传播(propagation))产生比开/闭操作更好的结果：</p>
<pre><code>&gt;&gt;&gt; eroded_img = ndimage.<span class="function"><span class="title">binary_erosion</span><span class="params">(binary_img)</span></span>
&gt;&gt;&gt; reconstruct_img = ndimage.<span class="function"><span class="title">binary_propagation</span><span class="params">(eroded_img, mask=binary_img)</span></span>
&gt;&gt;&gt; tmp = np.<span class="function"><span class="title">logical_not</span><span class="params">(reconstruct_img)</span></span>
&gt;&gt;&gt; eroded_tmp = ndimage.<span class="function"><span class="title">binary_erosion</span><span class="params">(tmp)</span></span>
&gt;&gt;&gt; reconstruct_final = np.<span class="function"><span class="title">logical_not</span><span class="params">(ndimage.binary_propagation(eroded_tmp, mask=tmp)</span></span>)
&gt;&gt;&gt; np.<span class="function"><span class="title">abs</span><span class="params">(mask - close_img)</span></span>.<span class="function"><span class="title">mean</span><span class="params">()</span></span>
<span class="number">0.014678955078125</span>
&gt;&gt;&gt; np.<span class="function"><span class="title">abs</span><span class="params">(mask - reconstruct_final)</span></span>.<span class="function"><span class="title">mean</span><span class="params">()</span></span>
<span class="number">0.0042572021484375</span>
</code></pre><p><strong>练习</strong></p>
<p>检查首次消噪步骤(中值滤波，总变差)如何更改直方图，并且查看是否基于直方图的分割更加精准了。</p>
<ul>
<li><p><em>基于图像</em>的分割：使用空间信息</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; from sklearn.feature_extraction import image
<span class="prompt">&gt;&gt;</span>&gt; from sklearn.cluster import spectral_clustering

<span class="prompt">&gt;&gt;</span>&gt; l = <span class="number">100</span>
<span class="prompt">&gt;&gt;</span>&gt; x, y = np.indices((l, l))

<span class="prompt">&gt;&gt;</span>&gt; center1 = (<span class="number">28</span>, <span class="number">24</span>)
<span class="prompt">&gt;&gt;</span>&gt; center2 = (<span class="number">40</span>, <span class="number">50</span>)
<span class="prompt">&gt;&gt;</span>&gt; center3 = (<span class="number">67</span>, <span class="number">58</span>)
<span class="prompt">&gt;&gt;</span>&gt; center4 = (<span class="number">24</span>, <span class="number">70</span>)
<span class="prompt">&gt;&gt;</span>&gt; radius1, radius2, radius3, radius4 = <span class="number">16</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">14</span>

<span class="prompt">&gt;&gt;</span>&gt; circle1 = (x - center1[<span class="number">0</span>])**<span class="number">2</span> + (y - center1[<span class="number">1</span>])**<span class="number">2</span> &lt; radius1**<span class="number">2</span>
<span class="prompt">&gt;&gt;</span>&gt; circle2 = (x - center2[<span class="number">0</span>])**<span class="number">2</span> + (y - center2[<span class="number">1</span>])**<span class="number">2</span> &lt; radius2**<span class="number">2</span>
<span class="prompt">&gt;&gt;</span>&gt; circle3 = (x - center3[<span class="number">0</span>])**<span class="number">2</span> + (y - center3[<span class="number">1</span>])**<span class="number">2</span> &lt; radius3**<span class="number">2</span>
<span class="prompt">&gt;&gt;</span>&gt; circle4 = (x - center4[<span class="number">0</span>])**<span class="number">2</span> + (y - center4[<span class="number">1</span>])**<span class="number">2</span> &lt; radius4**<span class="number">2</span>

<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># 4 circles</span>
<span class="prompt">&gt;&gt;</span>&gt; img = circle1 + circle2 + circle3 + circle4
<span class="prompt">&gt;&gt;</span>&gt; mask = img.astype(bool)
<span class="prompt">&gt;&gt;</span>&gt; img = img.astype(float)

<span class="prompt">&gt;&gt;</span>&gt; img += <span class="number">1</span> + <span class="number">0</span>.<span class="number">2</span>*np.random.randn(*img.shape)
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># Convert the image into a graph with the value of the gradient on</span>
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># the edges.</span>
<span class="prompt">&gt;&gt;</span>&gt; graph = image.img_to_graph(img, mask=mask)

<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># Take a decreasing function of the gradient: we take it weakly</span>
<span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># dependant from the gradient the segmentation is close to a voronoi</span>
<span class="prompt">&gt;&gt;</span>&gt; graph.data = np.exp(-graph.data/graph.data.std())

<span class="prompt">&gt;&gt;</span>&gt; labels = spectral_clustering(graph, k=<span class="number">4</span>, mode=<span class="string">'arpack'</span>)
<span class="prompt">&gt;&gt;</span>&gt; label_im = -np.ones(mask.shape)
<span class="prompt">&gt;&gt;</span>&gt; label_im[mask] = labels
</code></pre></li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/image_spectral_clustering.png" alt="graph-base"></p>
<hr>
<h2 id="测量对象属性：ndimage-measurements">测量对象属性：ndimage.measurements</h2><p>合成数据：</p>
<pre><code>&gt;&gt;&gt; n = <span class="number">10</span>
&gt;&gt;&gt; l = <span class="number">256</span>
&gt;&gt;&gt; im = np.<span class="function"><span class="title">zeros</span><span class="params">((l, l)</span></span>)
&gt;&gt;&gt; points = l*np<span class="class">.random</span><span class="class">.random</span>((<span class="number">2</span>, n**<span class="number">2</span>))
&gt;&gt;&gt; im[(points[<span class="number">0</span>]).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>, (points[<span class="number">1</span>]).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>] = <span class="number">1</span>
&gt;&gt;&gt; im = ndimage.<span class="function"><span class="title">gaussian_filter</span><span class="params">(im, sigma=l/(<span class="number">4</span>.*n)</span></span>)
&gt;&gt;&gt; <span class="attribute">mask</span> = im &gt; im.<span class="function"><span class="title">mean</span><span class="params">()</span></span>
</code></pre><ul>
<li><p><em>连接成分分析</em></p>
<p>  标记连接成分：<code>ndimage.label</code></p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; label_im, nb_labels = ndimage.label(mask)
<span class="prompt">&gt;&gt;</span>&gt; nb_labels <span class="comment"># how many regions?</span>
<span class="number">23</span>
<span class="prompt">&gt;&gt;</span>&gt; plt.imshow(label_im)        
&lt;matplotlib.image.<span class="constant">AxesImage</span> object at ...&gt;
</code></pre></li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/plot_synthetic_data_1.png" alt="label"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_synthetic_data.html#example-plot-synthetic-data-py" target="_blank" rel="external">示例源码</a></p>
<p>计算每个区域的尺寸，均值等等：</p>
<pre><code>&gt;&gt;&gt; sizes = ndimage.<span class="function"><span class="title">sum</span><span class="params">(mask, label_im, range(nb_labels + <span class="number">1</span>)</span></span>)
&gt;&gt;&gt; mean_vals = ndimage.<span class="function"><span class="title">sum</span><span class="params">(im, label_im, range(<span class="number">1</span>, nb_labels + <span class="number">1</span>)</span></span>)
</code></pre><p>计算小的连接成分：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; mask_size = sizes &lt; <span class="number">1000</span>
<span class="prompt">&gt;&gt;</span>&gt; remove_pixel = mask_size[label_im]
<span class="prompt">&gt;&gt;</span>&gt; remove_pixel.shape
(<span class="number">256</span>, <span class="number">256</span>)
<span class="prompt">&gt;&gt;</span>&gt; label_im[remove_pixel] = <span class="number">0</span>
<span class="prompt">&gt;&gt;</span>&gt; plt.imshow(label_im)        
&lt;matplotlib.image.<span class="constant">AxesImage</span> object at ...&gt;
</code></pre><p>现在使用<code>np.searchsorted</code>重新分配标签：</p>
<pre><code>&gt;&gt;&gt; labels = np.<span class="function"><span class="title">unique</span><span class="params">(label_im)</span></span>
&gt;&gt;&gt; label_im = np.<span class="function"><span class="title">searchsorted</span><span class="params">(labels, label_im)</span></span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_measure_data_1.png" alt="reassign"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_measure_data.html#example-plot-measure-data-py" target="_blank" rel="external">示例源码</a></p>
<p>找到关注的封闭对象区域：<a href="根据以上操作剩下的区域选择区域，因为是随机生成可能结果不通，label_im==4未必留下来了。">^3</a></p>
<pre><code>&gt;&gt;&gt; slice_x, slice_y = ndimage.<span class="function"><span class="title">find_objects</span><span class="params">(label_im==<span class="number">4</span>)</span></span>[<span class="number">0</span>]
&gt;&gt;&gt; roi = im[slice_x, slice_y]
&gt;&gt;&gt; plt.<span class="function"><span class="title">imshow</span><span class="params">(roi)</span></span>     
&lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> <span class="tag">object</span> at ...&gt;
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_find_object_1.png" alt="find"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_find_object.html#example-plot-find-object-py" target="_blank" rel="external">示例源码</a></p>
<p>其它空间测量：<code>ndiamge.center_of_mass</code>,<code>ndimage.maximum_position</code>等等。</p>
<p>可以在分割应用限制范围之外使用。</p>
<p>示例：块平均(block mean)：</p>
<pre><code>m scipy import misc
<span class="prompt">&gt;&gt;</span>&gt; l = misc.lena()
<span class="prompt">&gt;&gt;</span>&gt; sx, sy = l.shape
<span class="prompt">&gt;&gt;</span>&gt; <span class="constant">X</span>, <span class="constant">Y</span> = np.ogrid[<span class="number">0</span><span class="symbol">:sx</span>, <span class="number">0</span><span class="symbol">:sy</span>]
<span class="prompt">&gt;&gt;</span>&gt; regions = sy/<span class="number">6</span> * (<span class="constant">X</span>/<span class="number">4</span>) + <span class="constant">Y</span>/<span class="number">6</span>  <span class="comment"># note that we use broadcasting</span>
<span class="prompt">&gt;&gt;</span>&gt; block_mean = ndimage.mean(l, labels=regions, index=np.arange(<span class="number">1</span>,
...     regions.max() +<span class="number">1</span>))
<span class="prompt">&gt;&gt;</span>&gt; block_mean.shape = (sx/<span class="number">4</span>, sy/<span class="number">6</span>)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_block_mean_1.png" alt="block mean"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_block_mean.html#example-plot-block-mean-py" target="_blank" rel="external">示例源码</a></p>
<p>当区域不是正则的<a href="[正则空间](https://en.wikipedia.org/wiki/Regular_space)">^4</a>块状时，使用stride技巧更有效(<a href="http://scipy-lectures.github.com/advanced/advanced_numpy/index.html#stride-manipulation-label" target="_blank" rel="external">示例：fake dimensions with strides</a>)</p>
<p>非正则空间(Non-regular-spaced)区块：径向平均：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt; sx, sy = l.shape
<span class="prompt">&gt;&gt;</span>&gt; <span class="constant">X</span>, <span class="constant">Y</span> = np.ogrid[<span class="number">0</span><span class="symbol">:sx</span>, <span class="number">0</span><span class="symbol">:sy</span>]
<span class="prompt">&gt;&gt;</span>&gt; r = np.hypot(<span class="constant">X</span> - sx/<span class="number">2</span>, <span class="constant">Y</span> - sy/<span class="number">2</span>)
<span class="prompt">&gt;&gt;</span>&gt; rbin = (<span class="number">20</span>* r/r.max()).astype(np.int)
<span class="prompt">&gt;&gt;</span>&gt; radial_mean = ndimage.mean(l, labels=rbin, index=np.arange(<span class="number">1</span>, rbin.max() +<span class="number">1</span>))
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_radial_mean_1.png" alt="radial"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_radial_mean.html#example-plot-radial-mean-py" target="_blank" rel="external">示例源码</a></p>
<ul>
<li><em>其它测量</em></li>
</ul>
<p>相关函数，傅里叶/小波谱等。</p>
<p>一个使用数学形态学的例子：<em>粒度</em>(<a href="http://en.wikipedia.org/wiki/Granulometry_%28morphology%29" target="_blank" rel="external">http://en.wikipedia.org/wiki/Granulometry_%28morphology%29</a>)</p>
<pre><code>&gt;&gt;&gt; def <span class="function"><span class="title">disk_structure</span><span class="params">(n)</span></span>:
...     struct = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">2</span> * n + <span class="number">1</span>, <span class="number">2</span> * n + <span class="number">1</span>)</span></span>)
...     x, y = np.<span class="function"><span class="title">indices</span><span class="params">((<span class="number">2</span> * n + <span class="number">1</span>, <span class="number">2</span> * n + <span class="number">1</span>)</span></span>)
...     <span class="attribute">mask</span> = (x - n)**<span class="number">2</span> + (y - n)**<span class="number">2</span> &lt;= n**<span class="number">2</span>
...     struct[<span class="attribute">mask</span>] = <span class="number">1</span>
...     return struct.<span class="function"><span class="title">astype</span><span class="params">(np.bool)</span></span>
...
&gt;&gt;&gt;
&gt;&gt;&gt; def <span class="function"><span class="title">granulometry</span><span class="params">(data, sizes=None)</span></span>:
...     s = <span class="function"><span class="title">max</span><span class="params">(data.shape)</span></span>
...     <span class="keyword">if</span> sizes == None:
...         sizes = <span class="function"><span class="title">range</span><span class="params">(<span class="number">1</span>, s/<span class="number">2</span>, <span class="number">2</span>)</span></span>
...     granulo = [ndimage.binary_opening(data, \
...         structure=<span class="function"><span class="title">disk_structure</span><span class="params">(n)</span></span>).<span class="function"><span class="title">sum</span><span class="params">()</span></span> <span class="keyword">for</span> n <span class="keyword">in</span> sizes]
...     return granulo
...
&gt;&gt;&gt;
&gt;&gt;&gt; np<span class="class">.random</span><span class="class">.seed</span>(<span class="number">1</span>)
&gt;&gt;&gt; n = <span class="number">10</span>
&gt;&gt;&gt; l = <span class="number">256</span>
&gt;&gt;&gt; im = np.<span class="function"><span class="title">zeros</span><span class="params">((l, l)</span></span>)
&gt;&gt;&gt; points = l*np<span class="class">.random</span><span class="class">.random</span>((<span class="number">2</span>, n**<span class="number">2</span>))
&gt;&gt;&gt; im[(points[<span class="number">0</span>]).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>, (points[<span class="number">1</span>]).<span class="function"><span class="title">astype</span><span class="params">(np.int)</span></span>] = <span class="number">1</span>
&gt;&gt;&gt; im = ndimage.<span class="function"><span class="title">gaussian_filter</span><span class="params">(im, sigma=l/(<span class="number">4</span>.*n)</span></span>)
&gt;&gt;&gt;
&gt;&gt;&gt; <span class="attribute">mask</span> = im &gt; im.<span class="function"><span class="title">mean</span><span class="params">()</span></span>
&gt;&gt;&gt;
&gt;&gt;&gt; granulo = <span class="function"><span class="title">granulometry</span><span class="params">(mask, sizes=np.arange(<span class="number">2</span>, <span class="number">19</span>, <span class="number">4</span>)</span></span>)
</code></pre><p><img src="http://scipy-lectures.github.com/_images/plot_granulo_1.png" alt="granulometry"></p>
<p><a href="http://scipy-lectures.github.com/advanced/image_processing/auto_examples/plot_granulo.html#example-plot-granulo-py" target="_blank" rel="external">示例源码</a></p>
<h2 id="Footnotes">Footnotes</h2><p>[^2]:ValueError: can not convert int64 to uint8.</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/10/31/python/" itemprop="url">
                  调试代码(Python)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-31T00:00:00+08:00" content="2012-10-31">
              2012-10-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/10/31/python/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/10/31/python/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="调试代码">调试代码</h1><p>翻译自：<a href="http://scipy-lectures.github.com/advanced/debugging/index.html" target="_blank" rel="external">http://scipy-lectures.github.com/advanced/debugging/index.html</a></p>
<p>作者：Gaël Varoquaux</p>
<p>本教程探索工具，以更好地理解你的编程基础：调试，找到并修复错误。</p>
<p>这并不特定适合Python科学计算社区，但是我们采取的策略量身定制。</p>
<p><strong>先决条件</strong></p>
<ul>
<li>Numpy</li>
<li>IPython</li>
<li>nosetests (<a href="http://readthedocs.org/docs/nose/en/latest/" target="_blank" rel="external">http://readthedocs.org/docs/nose/en/latest/</a>)</li>
<li>line_profiler (<a href="http://packages.python.org/line_profiler/" target="_blank" rel="external">http://packages.python.org/line_profiler/</a>)</li>
<li>pyflakes (<a href="http://pypi.python.org/pypi/pyflakes" target="_blank" rel="external">http://pypi.python.org/pypi/pyflakes</a>)</li>
<li>gdb 用于C调试部分</li>
</ul>
<p><strong>目录</strong></p>
<ul>
<li>toc<br>{: toc}</li>
</ul>
<h2 id="避免错误">避免错误</h2><h3 id="避免麻烦最佳编码法">避免麻烦最佳编码法</h3><ul>
<li>我们都写有bug的代码。接受它，解决它。</li>
<li>写程序时，在心里测试和调试。</li>
<li>Keep it Simple, Stupid(KISS).<ul>
<li>可能有效的最简单方法</li>
</ul>
</li>
<li>Don‘t Repeat Yourself (DRY).<ul>
<li>每个知识都必须有个单独、明确、在一个系统中的正式表示</li>
<li>常量、算法，等等。</li>
</ul>
</li>
<li>尝试限制你的代码间的相互关系(松耦合)</li>
<li>赋予你的变量、函数和模块有意义的名字(不是数学名称)</li>
</ul>
<h3 id="pyflakes:快速静态分析">pyflakes:快速静态分析</h3><p>这些是几个Python中的静态分析工具：<a href="http://www.logilab.org/857" target="_blank" rel="external">pylint</a>、<a href="http://pychecker.sourceforge.net/" target="_blank" rel="external">pychecker</a>和<a href="http://pypi.python.org/pypi/pyflakes" target="_blank" rel="external">pyflakes</a>。这里我们重点放在pyflakes上，这是最简单的工具。</p>
<ul>
<li><em>快速，简单</em></li>
<li>探测语法错误，漏掉的导入，名称的拼写错误。</li>
</ul>
<p>高度推荐在你的编辑器中集成pyflakes，它<em>确实产生巨大生产力</em>。</p>
<h4 id="在当前编辑文件运行pyflakes">在当前编辑文件运行pyflakes</h4><p>你可以绑定一个键来在当前缓冲区运行pyflakes。</p>
<ul>
<li><p>kate中 菜单：<code>设置 -&gt; 配置kate</code></p>
<ul>
<li>在插件中勾选’外部工具’<a href="我是没找到">^1</a></li>
<li><p>在外部工具中，添加<code>pyflakes</code>:</p>
<pre><code>kdialog --title <span class="string">"pyflakes <span class="variable">%filename</span>"</span> --msgbox <span class="string">"<span class="variable">$(</span>pyflakes <span class="variable">%filename</span>)"</span>
</code></pre></li>
</ul>
</li>
<li><p>在TextMate中<br>菜单：TextMate -&gt; 首选项 -&gt; 高级 -&gt; Shell变量，添加一个shell变量：</p>
<pre><code>TM_PYCHECKER=<span class="regexp">/Library/</span>Frameworks<span class="regexp">/Python.framework/</span>Versions<span class="regexp">/Current/</span>bin<span class="regexp">/pyflakes</span>
</code></pre><p>  然后<code>Ctrl-Shift-V</code>被绑定到pyflakes报告上。</p>
</li>
<li><p>在<em>Vim</em>中，在你的vimrc中(将F5绑定到pyflakes上)：</p>
<pre><code>autocmd <span class="constant">FileType </span>python let &amp;mp = <span class="string">'echo "*** running % ***" ; pyflakes %'</span>
autocmd <span class="constant">FileType </span>tex,mp,rst,python imap &lt;<span class="constant">Esc&gt;</span>[<span class="number">15</span>~ &lt;<span class="constant">C-O&gt;</span><span class="symbol">:make!^M</span>
autocmd <span class="constant">FileType </span>tex,mp,rst,python map  &lt;<span class="constant">Esc&gt;</span>[<span class="number">15</span>~ <span class="symbol">:make!^M</span>
autocmd <span class="constant">FileType </span>tex,mp,rst,python set autowrite]]    
</code></pre></li>
<li><p>在emacs中，在你的.emacs中(绑定F5到pyflakes)：</p>
<pre><code><span class="list">(<span class="keyword">defun</span> pyflakes-thisfile <span class="list">()</span> <span class="list">(<span class="keyword">interactive</span>)</span>
   <span class="list">(<span class="keyword"><span class="built_in">compile</span></span> <span class="list">(<span class="keyword"><span class="built_in">format</span></span> <span class="string">"pyflakes %s"</span> <span class="list">(<span class="keyword">buffer-file-name</span>)</span>)</span>)</span>
)</span>

<span class="list">(<span class="keyword">define-minor-mode</span> pyflakes-mode
    <span class="string">"Toggle pyflakes mode.
    With no argument, this command toggles the mode.
    Non-null prefix argument turns on the mode.
    Null prefix argument turns off the mode."</span>
    <span class="comment">;; The initial value.</span>
    <span class="literal">nil</span>
    <span class="comment">;; The indicator for the mode line.</span>
    <span class="string">" Pyflakes"</span>
    <span class="comment">;; The minor mode bindings.</span>
    '<span class="list">( <span class="list">(<span class="collection">[f5]</span> . pyflakes-thisfile)</span> )</span>
)</span>

<span class="list">(<span class="keyword">add-hook</span> 'python-mode-hook <span class="list">(<span class="keyword">lambda</span> <span class="list">()</span> <span class="list">(<span class="keyword">pyflakes-mode</span> t)</span>)</span>)</span>
</code></pre></li>
</ul>
<h4 id="一个在线拼写检查集成">一个在线拼写检查集成</h4><ul>
<li>在vim中使用vim.pyflakes插件：<ol>
<li>从<a href="http://www.vim.org/scripts/script.php?script_id=2441" target="_blank" rel="external">http://www.vim.org/scripts/script.php?script_id=2441</a>下载zip文件<a href="关于插件的安装，我更倾向于pathogen">^2</a></li>
<li>将文件解压到<code>.vim/ftplugin/python</code></li>
<li>确定你的vimrc中有’filetype plugin indent on’</li>
</ol>
</li>
<li><p>在emacs中在flymake模式中使用pyflakes，文档在<a href="http://www.plope.com/Members/chrism/flymake-mode" target="_blank" rel="external">http://www.plope.com/Members/chrism/flymake-mode</a>:添加以下内容到你的.emacs文件：</p>
<pre><code><span class="list">(<span class="keyword"><span class="built_in">when</span></span> <span class="list">(<span class="keyword"><span class="built_in">load</span></span> <span class="string">"flymake"</span> t)</span>
        <span class="list">(<span class="keyword">defun</span> flymake-pyflakes-init <span class="list">()</span>
        <span class="list">(<span class="keyword"><span class="built_in">let*</span></span> <span class="list">(<span class="list">(<span class="keyword">temp-file</span> <span class="list">(<span class="keyword">flymake-init-create-temp-buffer-copy</span>
                            <span class="variable">'flymake-create-temp-inplace</span>)</span>)</span>
            <span class="list">(<span class="keyword">local-file</span> <span class="list">(<span class="keyword">file-relative-name</span>
                        temp-file
                        <span class="list">(<span class="keyword">file-name-directory</span> buffer-file-name)</span>)</span>)</span>)</span>
            <span class="list">(<span class="keyword"><span class="built_in">list</span></span> <span class="string">"pyflakes"</span> <span class="list">(<span class="keyword"><span class="built_in">list</span></span> local-file)</span>)</span>)</span>)</span>

        <span class="list">(<span class="keyword">add-to-list</span> <span class="variable">'flymake-allowed-file-name-masks</span>
                '<span class="list">(<span class="string">"\\.py\\'"</span> flymake-pyflakes-init)</span>)</span>)</span>

<span class="list">(<span class="keyword">add-hook</span> <span class="variable">'find-file-hook</span> <span class="variable">'flymake-find-file-hook</span>)</span>
</code></pre></li>
</ul>
<h2 id="调试工作流">调试工作流</h2><p>你确实有个并不微不足道的bug，这时调试策略就关键了。这没有银色子弹。然而，策略有帮助：</p>
<blockquote>
<p>对调试一个给定的问题，最受欢迎的情况是当问题被隔离成少量几行的代码，在框架和应用之外，伴随的更改-运行-失败循环</p>
</blockquote>
<ol>
<li>让出错可靠。找到一个测试实例让代码每次都出错(fail)</li>
<li>分解并且克服。一旦你有了一个失败测试实例，隔绝出错代码 。<ul>
<li>哪个模块</li>
<li>哪个函数</li>
<li>哪行代码<br>= &gt; 隔离小块可再生错误：测试样例。</li>
</ul>
</li>
<li>一次更改一样东西，并且重新运行错误测试样例</li>
<li>使用调试器来理解哪里出错了</li>
<li>记笔记，保持耐心。这将花很久。</li>
</ol>
<p><strong>注意：</strong>一旦你已经完成这个过程：严格隔离一片再生bug的代码并使用这片代码修复它，向你的测试套件中添加相应的代码。</p>
<h2 id="使用Python调试器">使用Python调试器</h2><p>Python调试器，<code>pdb</code>：<a href="http://docs.python.org/library/pdb.html" target="_blank" rel="external">http://docs.python.org/library/pdb.html</a>，允许你交互地检查你的代码。</p>
<p>具体来说它允许你：</p>
<ul>
<li>查看源代码</li>
<li>向上或向下查看调用堆栈</li>
<li>检查变量值</li>
<li>更改变量值</li>
<li>设置断点</li>
</ul>
<p><strong>print</strong></p>
<p>是的，print确实可以作为一个调试工具。然而在运行时检查的话，使用调试器通常更有效率。</p>
<h3 id="调用调试器">调用调试器</h3><p>开启调试器的方法：</p>
<ol>
<li>尸检(post-mortem)，在模块错误后开启调试器</li>
<li>用调试器运行模块</li>
<li>在模块中调用调试器</li>
</ol>
<h4 id="尸检">尸检</h4><p><strong>情形：</strong>你使用ipython并且你获得一个回溯(traceback)。</p>
<p>现在让我们调试文件<a href="http://scipy-lectures.github.com/_downloads/index_error.py" target="_blank" rel="external">index_error.py</a>。当运行它时，一个<code>IndexError</code>被引发。键入<code>%debug</code>将进入调试器：</p>
<pre><code>In [1]: %run index_error.py
<span class="comment">---------------------------------------------------------------------------</span>
IndexError                                Traceback (most recent <span class="operator"><span class="keyword">call</span> <span class="keyword">last</span>)
/usr/lib/python2<span class="number">.7</span>/site-packages/IPython/utils/py3compat.py <span class="keyword">in</span> execfile(fname, *<span class="keyword">where</span>)
    <span class="number">176</span>             <span class="keyword">else</span>:
    <span class="number">177</span>                 filename = fname
<span class="comment">--&gt; 178             __builtin__.execfile(filename, *where)</span>

/home/lyy/index_error.py <span class="keyword">in</span> &lt;<span class="keyword">module</span>&gt;()
      <span class="number">6</span> 
      <span class="number">7</span> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
<span class="comment">----&gt; 8     index_error()</span>
      <span class="number">9</span> 

/home/lyy/index_error.py <span class="keyword">in</span> index_error()
      <span class="number">3</span> <span class="keyword">def</span> index_error():
      <span class="number">4</span>     lst = <span class="keyword">list</span>(<span class="string">'foobar'</span>)
<span class="comment">----&gt; 5     print lst[len(lst)]</span>
      <span class="number">6</span> 
      <span class="number">7</span> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:

IndexError: <span class="keyword">list</span> <span class="keyword">index</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="keyword">range</span>

<span class="keyword">In</span> [<span class="number">2</span>]: %debug
&gt; /home/lyy/index_error.py(<span class="number">5</span>)index_error()
      <span class="number">4</span>     lst = <span class="keyword">list</span>(<span class="string">'foobar'</span>)
<span class="comment">----&gt; 5     print lst[len(lst)]</span>
      <span class="number">6</span> 

ipdb&gt; <span class="keyword">list</span>
      <span class="number">1</span> <span class="string">"""Small snippet to raise an IndexError."""</span>
      <span class="number">2</span> 
      <span class="number">3</span> <span class="keyword">def</span> index_error():
      <span class="number">4</span>     lst = <span class="keyword">list</span>(<span class="string">'foobar'</span>)
<span class="comment">----&gt; 5     print lst[len(lst)]</span>
      <span class="number">6</span> 
      <span class="number">7</span> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
      <span class="number">8</span>     index_error()
      <span class="number">9</span> 

ipdb&gt; <span class="keyword">len</span>(lst)
<span class="number">6</span>
ipdb&gt; print lst[<span class="keyword">len</span>(lst)-<span class="number">1</span>]
r
ipdb&gt; quit

<span class="keyword">In</span> [<span class="number">3</span>]: </span>
</code></pre><p><strong>在IPython之外尸检<a href="这词……">^3</a>调试</strong></p>
<p>在一些情形下你无法使用IPython，例如调试一个想要从命令行调用的脚本。这中情况下，你可以使用<code>python -m pdb script.py</code>来调用脚本：</p>
<pre><code>lyy@<span class="keyword">arch</span> ~ % python2 -<span class="keyword">m</span> pdb index_error.py
&gt; /home/lyy/index_error.py(1)&lt;module&gt;()
-&gt; <span class="string">""</span><span class="string">"Small snippet to raise an IndexError."</span><span class="string">""</span>
(Pdb) <span class="keyword">continue</span>
Traceback (most recent call last):
  <span class="keyword">File</span> <span class="string">"/usr/lib/python2.7/pdb.py"</span>, <span class="keyword">line</span> 1314, <span class="keyword">in</span> main
    pdb._runscript(mainpyfile)
  <span class="keyword">File</span> <span class="string">"/usr/lib/python2.7/pdb.py"</span>, <span class="keyword">line</span> 1233, <span class="keyword">in</span> _runscript
    self.<span class="keyword">run</span>(statement)
  <span class="keyword">File</span> <span class="string">"/usr/lib/python2.7/bdb.py"</span>, <span class="keyword">line</span> 387, <span class="keyword">in</span> <span class="keyword">run</span>
    exec cmd <span class="keyword">in</span> globals, locals
  <span class="keyword">File</span> <span class="string">"&lt;string&gt;"</span>, <span class="keyword">line</span> 1, <span class="keyword">in</span> &lt;module&gt;
  <span class="keyword">File</span> <span class="string">"index_error.py"</span>, <span class="keyword">line</span> 1, <span class="keyword">in</span> &lt;module&gt;
    <span class="string">""</span><span class="string">"Small snippet to raise an IndexError."</span><span class="string">""</span>
  <span class="keyword">File</span> <span class="string">"index_error.py"</span>, <span class="keyword">line</span> 5, <span class="keyword">in</span> index_error
    <span class="keyword">print</span> lst[len(lst)]
IndexError: <span class="keyword">list</span> index <span class="keyword">out</span> of <span class="keyword">range</span>
Uncaught exception. Entering <span class="keyword">post</span> mortem debugging
Running 'cont' or 'step' will restart the <span class="keyword">program</span>
&gt; /home/lyy/index_error.py(5)index_error()
-&gt; <span class="keyword">print</span> lst[len(lst)]
(Pdb) <span class="keyword">print</span> lst[len(lst)]
<span class="comment">*** IndexError: list index out of range</span>
</code></pre><h4 id="单步执行">单步执行</h4><p><strong>情形：</strong>你相信在模块中存在一个bug但不确定在哪里。</p>
<p>例如我们尝试调试<a href="http://scipy-lectures.github.com/_downloads/wiener_filtering.py" target="_blank" rel="external">wiener_filtering.py</a>。确实代码运行了，但是滤波效果并不好。</p>
<ul>
<li><p>用调试器运行脚本：</p>
<pre><code>In [1]: %run -d wiener_filtering.py
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> Blank or comment
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> Blank or comment
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> Blank or comment
Breakpoint 1 at /home/lyy/wiener_filtering.py:4
NOTE: Enter 'c' at the ipdb&gt;  prompt to start your script.
&gt; <span class="variable">&lt;string&gt;</span>(1)<span class="variable">&lt;module&gt;</span>()
</code></pre></li>
<li><p>进入<a href="http://scipy-lectures.github.com/_downloads/wiener_filtering.py" target="_blank" rel="external">wiener_filtering.py</a>并且在34行设置断点：</p>
<pre><code>ipdb&gt; n
&gt; /home/lyy/wiener_filtering.py(<span class="number">4</span>)&lt;module&gt;()
      <span class="number">3</span> 
<span class="number">1</span>---&gt; <span class="number">4</span> import numpy as np
      <span class="number">5</span> import scipy as sp

ipdb&gt; b <span class="number">34</span>
Breakpoint <span class="number">2</span> at /home/lyy/wiener_filtering.py:<span class="number">34</span>
</code></pre></li>
<li><p>用<code>c(out(inue))</code>继续执行到下一个断点:</p>
<pre><code>ipdb&gt; <span class="keyword">c</span>
&gt; /home/lyy/wiener_filtering.<span class="keyword">py</span>(<span class="number">34</span>)iterated_wiener()
     <span class="number">33</span>     <span class="string">""</span><span class="string">"
</span><span class="number">2</span>--&gt; <span class="number">34</span>     noisy_img = noisy_img
     <span class="number">35</span>     denoised_img = local_mean(noisy_img, size=size)
</code></pre></li>
<li><p>用<code>n(ext)</code>和<code>s(tep)</code>回到代码：<code>next</code>跳到当前执行文本的下一个语句，而<code>step</code>将穿越执行文本，也就是，可以深入探索函数调用：<a href="区别在于step停在函数调用，next立即执行函数调用">^4</a></p>
<pre><code>ipdb&gt; s
&gt; /home/lyy/wiener_filtering.<span class="function"><span class="title">py</span><span class="params">(<span class="number">35</span>)</span><span class="title">iterated_wiener</span><span class="params">()</span></span>
<span class="number">2</span>    <span class="number">34</span>     noisy_img = noisy_img
---&gt; <span class="number">35</span>     denoised_img = <span class="function"><span class="title">local_mean</span><span class="params">(noisy_img, size=size)</span></span>
     <span class="number">36</span>     l_var = <span class="function"><span class="title">local_var</span><span class="params">(noisy_img, size=size)</span></span>

ipdb&gt; n
&gt; /home/lyy/wiener_filtering.<span class="function"><span class="title">py</span><span class="params">(<span class="number">36</span>)</span><span class="title">iterated_wiener</span><span class="params">()</span></span>
     <span class="number">35</span>     denoised_img = <span class="function"><span class="title">local_mean</span><span class="params">(noisy_img, size=size)</span></span>
---&gt; <span class="number">36</span>     l_var = <span class="function"><span class="title">local_var</span><span class="params">(noisy_img, size=size)</span></span>
     <span class="number">37</span>     <span class="keyword">for</span> <span class="tag">i</span> <span class="keyword">in</span> <span class="function"><span class="title">range</span><span class="params">(<span class="number">3</span>)</span></span>:
</code></pre></li>
<li><p>执行几行然后探索局部变量：</p>
<pre><code>ipdb&gt; n
&gt; /home/lyy/wiener_filtering.<span class="function"><span class="title">py</span><span class="params">(<span class="number">37</span>)</span><span class="title">iterated_wiener</span><span class="params">()</span></span>
     <span class="number">36</span>     l_var = <span class="function"><span class="title">local_var</span><span class="params">(noisy_img, size=size)</span></span>
---&gt; <span class="number">37</span>     <span class="keyword">for</span> <span class="tag">i</span> <span class="keyword">in</span> <span class="function"><span class="title">range</span><span class="params">(<span class="number">3</span>)</span></span>:
     <span class="number">38</span>         res = noisy_img - denoised_img

ipdb&gt; print l_var
[[<span class="number">5868</span> <span class="number">5379</span> <span class="number">5316</span> ..., <span class="number">5071</span> <span class="number">4799</span> <span class="number">5149</span>]
 [<span class="number">5013</span>  <span class="number">363</span>  <span class="number">437</span> ...,  <span class="number">346</span>  <span class="number">262</span> <span class="number">4355</span>]
 [<span class="number">5379</span>  <span class="number">410</span>  <span class="number">344</span> ...,  <span class="number">392</span>  <span class="number">604</span> <span class="number">3377</span>]
 ..., 
 [ <span class="number">435</span>  <span class="number">362</span>  <span class="number">308</span> ...,  <span class="number">275</span>  <span class="number">198</span> <span class="number">1632</span>]
 [ <span class="number">548</span>  <span class="number">392</span>  <span class="number">290</span> ...,  <span class="number">248</span>  <span class="number">263</span> <span class="number">1653</span>]
 [ <span class="number">466</span>  <span class="number">789</span>  <span class="number">736</span> ..., <span class="number">1835</span> <span class="number">1725</span> <span class="number">1940</span>]]
ipdb&gt; print l_var.<span class="function"><span class="title">min</span><span class="params">()</span></span>
<span class="number">0</span>
</code></pre></li>
</ul>
<p>Oh,亲爱的，除了整数什么也没有，还有0变动。这就是我们的bug所在，我们在做整数算术。</p>
<p><strong>引发数值错误例外</strong></p>
<p>当我们运行<a href="http://scipy-lectures.github.com/_downloads/wiener_filtering.py" target="_blank" rel="external">wiener_filtering.py</a>文件时，以下警告被引发(raise)：</p>
<pre><code>In [<span class="number">1</span>]: %run wiener_filtering.py
wiener_filtering.py:<span class="number">40</span>: RuntimeWarning: <span class="built_in">divide</span> <span class="keyword">by</span> <span class="constant">zero</span> encountered <span class="operator">in</span> <span class="built_in">divide</span>
  noise_level = (<span class="number">1</span> - noise/l_var )
</code></pre><p>我们可以将这些警告转化为例外(exception)，这让我们能对它们尸检调试，并且迅速找到我们的问题：</p>
<pre><code><span class="name">In</span> [<span class="number">2</span>]: <span class="atom">np</span>.<span class="atom">seterr</span>(<span class="atom">all</span>=<span class="string">'raise'</span>)
<span class="name">Out</span>[<span class="number">2</span>]: {<span class="string">'divide'</span>: <span class="string">'warn'</span>, <span class="string">'invalid'</span>: <span class="string">'warn'</span>, <span class="string">'over'</span>: <span class="string">'warn'</span>, <span class="string">'under'</span>: <span class="string">'ignore'</span>}
</code></pre><h4 id="其它开始调试的方法">其它开始调试的方法</h4><ul>
<li><p><strong>引发一个例外作为”可怜的”断点</strong></p>
<p>如果你发现几下行号设置断点很无聊，你可以简单地在你想要检查的地方引发一个例外，使用ipython的<code>%debug</code>。注意在这种情况下你不能step和continue执行。</p>
</li>
<li><p>使用nosetests调试测试失败</p>
<p>你可以运行<code>nosetests --pdb</code>对例外(exception)尸检调试，并且<code>nosetests --pdb-failure</code>使用调试器来检查测试失败。</p>
<p>另外，你可以通过安装nose插件<a href="http://pypi.python.org/pypi/ipdbplugin" target="_blank" rel="external">ipdbplugin</a>，在nose中使用IPython调试接口。你可以传递<code>--ipdb</code>和<code>--ipdb-failure</code>选项给nosetests。</p>
</li>
<li><p>显式调用调试器</p>
<p>  在你想要调试的地方放入以下一行：</p>
<pre><code><span class="preprocessor"><span class="keyword">import</span> pdb;</span> pdb.set_trace()
</code></pre></li>
</ul>
<font color="red">警告：当运行<code>nosetests</code>时，输出被捕捉，并且因此似乎调试器不工作了。只要加上<code>-s</code>标志运行nosetests</font>

<p><strong>图形化调试器</strong></p>
<p>为了单步执行和检查变量，你也许觉得用图形化的调试器如<a href="http://winpdb.org/" target="_blank" rel="external">winpdb</a>更加方便。</p>
<p>另外，<a href="http://pypi.python.org/pypi/pudb" target="_blank" rel="external">pudb</a>是一个很棒的半图形化调试器，它在终端里有一个文字用户界面。</p>
<h3 id="调试器命令和交互">调试器命令和交互</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>l(list)</td>
<td>列出当前运行的代码</td>
</tr>
<tr>
<td>u(p)</td>
<td>上一个调用堆栈</td>
</tr>
<tr>
<td>d(own)</td>
<td>下一个调用堆栈</td>
</tr>
<tr>
<td>n(ext)</td>
<td>执行下一行(不到新的函数)</td>
</tr>
<tr>
<td>s(tep)</td>
<td>执行下一个语句(到新的函数)</td>
</tr>
<tr>
<td>bt</td>
<td>打印调用堆栈</td>
</tr>
<tr>
<td>a</td>
<td>打印局部变量</td>
</tr>
<tr>
<td>!command</td>
<td>执行特定的<em>Python</em>命令(相对于pdb命令)</td>
</tr>
</tbody>
</table>
<p><strong>警告：Debugger 命令不是Python代码</strong></p>
<p>你不能想当然的命名一个变量。例如，例如，如果在其中，你不能在当前情形下覆盖用同名变量:<em>当在调试器中敲代码时，使用不同的名字而不是你的局部变量</em>。</p>
<h2 id="使用gdb调试段错误">使用gdb调试段错误</h2><p>如果你有一个段错误，你不能通过pdb调试它，因为它会让Python解释器在进入调试器之前崩溃。同样，如果你在Python中嵌入的C代码有bug，pdb也没用。对这种情况我们使用在linux上可用的gnu调试器<a href="http://www.gnu.org/s/gdb/" target="_blank" rel="external">gdb</a>。</p>
<p>在我们用gdb之前，让我们向它添加一些Python特有的工具。对此我们向我们的<em>gdbinit</em>添加一些宏。宏优化的选择依赖于你的Python版本和gdb版本。我已经在<a href="http://scipy-lectures.github.com/_downloads/gdbinit" target="_blank" rel="external">gdbinit</a>里添加了一个简化的版本，但是请自由地阅读<a href="http://wiki.python.org/moin/DebuggingWithGdb" target="_blank" rel="external">DebuggingWithGdb</a>。</p>
<p>为用gdb调试脚本<a href="http://scipy-lectures.github.com/_downloads/segfault.py" target="_blank" rel="external">segfault.py</a>，我们可以在gdb中如下运行：</p>
<pre><code>$ gdb python
...
(gdb) run segfault.py
Starting program: /usr/bin/python segfault.py
[Thread debugging <span class="keyword">using</span> libthread_db enabled]

Program received signal SIGSEGV, Segmentation fault.
_strided_byte_copy (dst=<span class="number">0x8537478</span> <span class="string">"\360\343G"</span>, outstrides=<span class="number">4</span>, src=
    <span class="number">0x86c0690</span> &lt;Address <span class="number">0x86c0690</span> out of bounds&gt;, instrides=<span class="number">32</span>, N=<span class="number">3</span>,
    elsize=<span class="number">4</span>)
        at numpy/core/src/multiarray/ctors.c:<span class="number">365</span>
<span class="number">365</span>            _FAST_MOVE(Int32);
(gdb)
</code></pre><p>我们得到一个段错误，并且gdb事后在C级别的堆栈中(不是python调用堆栈)捕捉到了它。我们可以使用使用gdb的命令调试C调用堆栈：</p>
<pre><code>(gdb) up
<span class="preprocessor">#<span class="number">1</span>  <span class="number">0x004af4f5</span> in _copy_from_same_shape (dest=&lt;value optimized out&gt;,</span>
    src=&lt;value optimized out&gt;, myfunc=<span class="number">0x496780</span> &lt;_strided_byte_copy&gt;,
    swap=<span class="number">0</span>)
at numpy/core/src/multiarray/ctors.c:<span class="number">748</span>
<span class="number">748</span>         myfunc(dit-&gt;dataptr, dest-&gt;strides[maxaxis],
</code></pre><p>如你所见，现在我们在numpy的C代码中。我们想要知道什么Python代码触发了这个段错误，因此我们向上查看堆栈直到我们发现Python执行循环：</p>
<pre><code>(gdb) up
#<span class="number">8</span>  <span class="number">0</span>x080ddd23 <span class="keyword">in</span> call_function (f=
    Frame <span class="number">0</span>x85371ec, <span class="keyword">for</span> file /home/varoquau/usr/lib/python2.<span class="number">6</span>/site-packages/numpy/core/arrayprint<span class="class">.py</span>, line <span class="number">156</span>, <span class="keyword">in</span> _leading_trailing (a=&lt;numpy<span class="class">.ndarray</span> at remote <span class="number">0</span>x85371b0&gt;, _nc=&lt;module at remote <span class="number">0</span>xb7f93a64&gt;), throwflag=<span class="number">0</span>)
    at ../Python/ceval<span class="class">.c</span>:<span class="number">3750</span>
<span class="number">3750</span>    ../Python/ceval<span class="class">.c</span>: No such file or directory.
        <span class="keyword">in</span> ../Python/ceval<span class="class">.c</span>

(gdb) up
#<span class="number">9</span>  PyEval_EvalFrameEx (f=
    Frame <span class="number">0</span>x85371ec, <span class="keyword">for</span> file /home/varoquau/usr/lib/python2.<span class="number">6</span>/site-packages/numpy/core/arrayprint<span class="class">.py</span>, line <span class="number">156</span>, <span class="keyword">in</span> _leading_trailing (a=&lt;numpy<span class="class">.ndarray</span> at remote <span class="number">0</span>x85371b0&gt;, _nc=&lt;module at remote <span class="number">0</span>xb7f93a64&gt;), throwflag=<span class="number">0</span>)
    at ../Python/ceval<span class="class">.c</span>:<span class="number">2412</span>
<span class="number">2412</span>    <span class="keyword">in</span> ../Python/ceval<span class="class">.c</span>
(gdb)
</code></pre><p>一旦我们在python执行循环中时，我们可以使用特殊的python帮助函数。例如我们找到相应的Python代码：</p>
<pre><code>(gdb) pyframe
/home/varoquau/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">python2</span>.6/<span class="title">site</span>-<span class="title">packages</span>/<span class="title">numpy</span>/<span class="title">core</span>/<span class="title">arrayprint</span>.<span class="title">py</span> (158): <span class="title">_leading_trailing</span></span>
(gdb)
</code></pre><p>这是numpy的代码，我们需要向上直到找到我们自己写的代码：</p>
<pre><code>(gdb) up
...
(gdb) up
#<span class="number">34</span> <span class="number">0</span>x080dc97a <span class="keyword">in</span> PyEval_EvalFrameEx (f=
    Frame <span class="number">0</span>x82f064c, <span class="keyword">for</span> file segfault<span class="class">.py</span>, line <span class="number">11</span>, <span class="keyword">in</span> print_big_array (small_array=&lt;numpy<span class="class">.ndarray</span> at remote <span class="number">0</span>x853ecf0&gt;, big_array=&lt;numpy<span class="class">.ndarray</span> at remote <span class="number">0</span>x853ed20&gt;), throwflag=<span class="number">0</span>) at ../Python/ceval<span class="class">.c</span>:<span class="number">1630</span>
<span class="number">1630</span>    ../Python/ceval<span class="class">.c</span>: No such file or directory.
        <span class="keyword">in</span> ../Python/ceval<span class="class">.c</span>
(gdb) pyframe
segfault<span class="class">.py</span> (<span class="number">12</span>): print_big_array
</code></pre><p>相应的代码是：</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">print_big_array</span><span class="params">(small_array)</span>:</span>
    big_array = make_big_array(small_array)
    <span class="keyword">print</span> big_array[-<span class="number">10</span>:]
    <span class="keyword">return</span> big_array
</code></pre><p>所以当打印<code>big_array[-10:]</code>时发生段错误。原因很简单，<code>big-array</code>的末尾被分配到程序内存之外了。<a href="也许你得将shape从20000改的大点，2e5或更大。">^5</a></p>
<p><strong>注意：</strong>在gdbinit中定义的专用于python的命令，请阅读这个文件。<a href="提醒下，在gdb7或更高版本中，不再单独需要gdbinit文件。另外，要完成用gdb对python程序的调试，我想你的python程序都应该用`-g`来编译。">^6</a></p>
<h2 id="总结练习">总结练习</h2><p>以下脚本清晰易读，它致力于解决数值计算感兴趣的实际问题。但是它不能工作。你能调试它吗？</p>
<p>Python源码<a href="http://scipy-lectures.github.com/_downloads/to_debug.py" target="_blank" rel="external">to_debug.py</a></p>
<pre><code><span class="string">"""
A script to compare different root-finding algorithms.

This version of the script is buggy and does not execute. It is your task
to find an fix these bugs.

The output of the script sould look like:

    Benching 1D root-finder optimizers from scipy.optimize:
                brenth:   604678 total function calls
                brentq:   594454 total function calls
                ridder:   778394 total function calls
                bisect:  2148380 total function calls
"""</span>
<span class="keyword">from</span> itertools <span class="keyword">import</span> product

<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> scipy <span class="keyword">import</span> optimize

FUNCTIONS = (np.tan,  <span class="comment"># Dilating map</span>
             np.tanh, <span class="comment"># Contracting map</span>
             <span class="keyword">lambda</span> x: x**<span class="number">3</span> + <span class="number">1e-4</span>*x, <span class="comment"># Almost null gradient at the root</span>
             <span class="keyword">lambda</span> x: x+np.sin(<span class="number">2</span>*x), <span class="comment"># Non monotonous function</span>
             <span class="keyword">lambda</span> x: <span class="number">1.1</span>*x+np.sin(<span class="number">4</span>*x), <span class="comment"># Fonction with several local maxima</span>
            )

OPTIMIZERS = (optimize.brenth, optimize.brentq, optimize.ridder,
              optimize.bisect)


<span class="function"><span class="keyword">def</span> <span class="title">apply_optimizer</span><span class="params">(optimizer, func, a, b)</span>:</span>
    <span class="string">""" Return the number of function calls given an root-finding optimizer, 
        a function and upper and lower bounds.
    """</span>
    <span class="keyword">return</span> optimizer(func, a, b, full_output=<span class="keyword">True</span>)[<span class="number">1</span>].function_calls,


<span class="function"><span class="keyword">def</span> <span class="title">bench_optimizer</span><span class="params">(optimizer, param_grid)</span>:</span>
    <span class="string">""" Find roots for all the functions, and upper and lower bounds
        given and return the total number of function calls.
    """</span>
    <span class="keyword">return</span> sum(apply_optimizer(optimizer, func, a, b)
               <span class="keyword">for</span> func, a, b <span class="keyword">in</span> param_grid)


<span class="function"><span class="keyword">def</span> <span class="title">compare_optimizers</span><span class="params">(optimizers)</span>:</span>
    <span class="string">""" Compare all the optimizers given on a grid of a few different
        functions all admitting a signle root in zero and a upper and
        lower bounds.
    """</span>
    random_a = -<span class="number">1.3</span> + np.random.random(size=<span class="number">100</span>)
    random_b =   <span class="number">.3</span> + np.random.random(size=<span class="number">100</span>)
    param_grid = product(FUNCTIONS, random_a, random_b)
    <span class="keyword">print</span> <span class="string">"Benching 1D root-finder optimizers from scipy.optimize:"</span>
    <span class="keyword">for</span> optimizer <span class="keyword">in</span> OPTIMIZERS:
        <span class="keyword">print</span> <span class="string">'% 20s: % 8i total function calls'</span> % (
                    optimizer.__name__, 
                    bench_optimizer(optimizer, param_grid)
                )


<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    compare_optimizers(OPTIMIZERS)
</code></pre><h2 id="Footnotes">Footnotes</h2>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/10/30/" itemprop="url">
                  斯普罗站最大风力预测
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-30T00:00:00+08:00" content="2012-10-30">
              2012-10-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/10/30/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/10/30//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="斯普罗岛最大风速预测">斯普罗岛最大风速预测</h1><p>翻译自：<a href="http://scipy-lectures.github.com/intro/summary-exercises/stats-interpolate.html" target="_blank" rel="external">http://scipy-lectures.github.com/intro/summary-exercises/stats-interpolate.html</a></p>
<p>这个练习目的在于预测每50年的最大风速，如果没有测量的话。可以获得的数据仅仅由位于丹麦的斯普罗气象站测量了21年。首先，统计步骤将给出，然后通过从scipy.interpolate模块中的函数演示。最后有兴趣的读者将被邀请用稍微不同的方法从原始数据计算结果。</p>
<h2 id="统计方法">统计方法</h2><p>每年最大风速应该符合正态概率密度函数。然而，这个函数将并不会被估计，因为它从最大风速给出概率。这将是分位函数的角色，这个练习的目标将会是找到它。在当前模型，每五十年发生的最大风速被定义为%2上分位。</p>
<p>根据定义，这个分位函数是累积分布函数的反函数，后者描述了一年的最大风速概率分布。在这个练习中。给定年<code>i</code>累积概率<code>p_i</code>被定义为<code>p_i = i/(N+1)</code>,其中N=21，有测量的年数。因此计算每年最大风速的累积概率将是可能的。从这些实验点，scipy.interpolate模块将在拟合分位函数时非常有用。最后这五十年的最大值将被从上%2分位数的累积概率函数中求得。</p>
<h2 id="计算累积概率">计算累积概率</h2><p>每年的最大风力已经被计算并以numpy格式保存在文件<a href="http://scipy-lectures.github.com/_downloads/max-speeds.npy" target="_blank" rel="external">examples/max-speeds.npy</a>中，因此它们将通过numpy载入：</p>
<pre><code>In [<span class="number">1</span>]: import numpy as np

In [<span class="number">2</span>]: max_speeds = np.<span class="function"><span class="title">load</span><span class="params">(<span class="string">'max-speeds.npy'</span>)</span></span>

In [<span class="number">3</span>]: years_nb = max_speeds<span class="class">.shape</span>[<span class="number">0</span>]
</code></pre><p>从上一部分累积概率定义<code>p_i</code>，相应的值将是：</p>
<pre><code>In [<span class="number">5</span>]: cprob = (np.arange(years_nb, dtype=np.float32) + <span class="number">1</span>) / (years_nb + <span class="number">1</span>)
</code></pre><p>它们被假定用来拟合给定风速：</p>
<h2 id="一元样条预测">一元样条预测</h2><p>本章中分位函数将通过使用<code>UnivariateSpline</code>类来估计，这个类可以代表源于数据点的样条。默认的行为是构建一个3级(degree)的样条，数据点可以根据它们的可靠性有不同的权重。变体有<code>InterpolateUnivariateSpline</code>和<code>LSQUnivariateSpline</code>，它们的误差检查将会改变。在需要二维样条的时候，<code>BivariateSpline</code>类一族被提供。所有这些一维和二维样条使用FITPACK Fortran子程序，这就是为何通过分别代表和估值样条的<code>splrep</code>和<code>splev</code>函数，一个低等的库存取可以使用。而且没有使用FITPACK参数的插值函数也被提供给更简单的使用(参见’interp1d’,<code>interp2d</code>,<code>barycentric_interpolate</code>等等)。</p>
<p>对斯普罗最大风速，<code>UnivariateSpline</code>将被使用，因为3级的样条似乎拟合很正确：</p>
<pre><code>In [<span class="number">7</span>]: from scipy<span class="class">.interpolate</span> import UnivariateSpline

In [<span class="number">8</span>]: quantile_func =  <span class="function"><span class="title">UnivariateSpline</span><span class="params">(cprob,sorted_max_speeds)</span></span>
</code></pre><p>分位函数想在将从整个概率范围求值：</p>
<pre><code>In [<span class="number">9</span>]: nprob = np.<span class="function"><span class="title">linspace</span><span class="params">(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>e2)</span></span>

In [<span class="number">10</span>]: fitted_max_speeds = <span class="function"><span class="title">quantile_func</span><span class="params">(nprob)</span></span>
</code></pre><p>%2</p>
<p>在目前的模型中，每五十年发生的最大风速被定义为上%2分位。结果，累积概率值将是：</p>
<pre><code>In [<span class="number">11</span>]: fifty_prob = <span class="number">1.</span> - <span class="number">0.02</span>
</code></pre><p>所以每五十年发生的暴风风速可被猜测，通过：</p>
<pre><code>In [<span class="number">12</span>]: fifty_wind = <span class="function"><span class="title">quantile_func</span><span class="params">(fifty_prob)</span></span>

In [<span class="number">13</span>]: fifty_wind
Out[<span class="number">13</span>]: <span class="function"><span class="title">array</span><span class="params">(<span class="number">32.97989825386221</span>)</span></span>
</code></pre><p>结果现在集中在一个Matplotlib图像上：</p>
<p><img src="http://scipy-lectures.github.com/_images/plot_cumulative_wind_speed_prediction_1.png" alt="fifty-wind"></p>
<p><a href="http://scipy-lectures.github.com/_downloads/plot_cumulative_wind_speed_prediction.py" target="_blank" rel="external">source code</a></p>
<h2 id="Gumbell分布练习">Gumbell分布练习</h2><p>感兴趣的读者现在被邀请通过使用二十一年测量的风速来做个练习。这个测量周期是大约90分钟(原始周期大约10分钟，但是文件大小为了让练习更简单已经被减小)。数据以numpy格式存储在文件<a href="http://scipy-lectures.github.com/_downloads/sprog-windspeeds.npy" target="_blank" rel="external">sprog-windspeeds.npy</a>中。在你完成练习之前，不要看绘图源码。</p>
<ul>
<li>第一步将是使用numpy并绘制matplotlib条形图，找到每年最大值。</li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/plot_sprog_annual_maxima_1.png" alt="bar"></p>
<p><a href="http://scipy-lectures.github.com/_downloads/plot_sprog_annual_maxima.py" target="_blank" rel="external">source code</a></p>
<ul>
<li>第二步是使用Gumble分布——其累积概率<code>p_i</code>被定义为<code>-log(-log(p_i))</code>，来拟合一个线性分位函数(记住你可以定义<code>UnivariateSpline</code>的级数(degree))。绘制每年最大风速与Gumble分布应该给出以下图像：</li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/plot_gumbell_wind_speed_prediction_1.png" alt="http://scipy-lectures.github.com/_images/plot_gumbell_wind_speed_prediction_1.png"></p>
<p><a href="http://scipy-lectures.github.com/_downloads/plot_gumbell_wind_speed_prediction.py" target="_blank" rel="external">source code</a></p>
<ul>
<li>最后一步是找到每五十年发生的最大风速34.23m/s</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/10/22/scipy/" itemprop="url">
                  Scipy:高端科学计算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-22T00:00:00+08:00" content="2012-10-22">
              2012-10-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/10/22/scipy/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/10/22/scipy/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Scipy:高端科学计算">Scipy:高端科学计算</h1><p>作者：Adrien Chauve, Andre Espaze, Emmanuelle Gouillart, Gaël Varoquaux, Ralf Gommers</p>
<p>翻译自：<a href="scipy-lectures.github.com/intro/scipy.html">scipy lecture notes</a></p>
<font color="red">译者表示最后部分没怎么看懂，此文档维护中……</font>

<hr>
<p><strong>Scipy</strong></p>
<p>scipy包包含致力于科学计算中常见问题的各个工具箱。它的不同子模块相应于不同的应用。像插值，积分，优化，图像处理，，特殊函数等等。</p>
<p>scipy可以与其它标准科学计算程序库进行比较，比如GSL(GNU C或C++科学计算库)，或者Matlab工具箱。scipy是Python中科学计算程序的核心包;它用于有效地计算numpy矩阵，来让numpy和scipy协同工作。</p>
<p>在实现一个程序之前，值得检查下所需的数据处理方式是否已经在scipy中存在了。作为非专业程序员，科学家总是喜欢<em>重新发明造轮子</em>，导致了充满漏洞的，未经优化的，很难分享和维护的代码。相反，Scipy程序经过优化和测试，因此应该尽可能使用。</p>
<hr>
<p><strong>目录</strong></p>
<ul>
<li>toc<br>{: toc}</li>
</ul>
<hr>
<font color="red">警告：这个教程离真正的数值计算介绍很远。因为枚举scipy中不同的子模块和函数非常无聊，我们集中精力代之以几个例子来给出如何使用<code>scipy</code>进行计算的大致思想。</font>

<p>scipy 由一些特定功能的子模块组成：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>scipy.cluster</td>
<td>矢量量化 / K-均值</td>
</tr>
<tr>
<td>scipy.constants</td>
<td>物理和数学常数</td>
</tr>
<tr>
<td>scipy.fftpack</td>
<td>傅里叶变换</td>
</tr>
<tr>
<td>scipy.integrate</td>
<td>积分程序</td>
</tr>
<tr>
<td>scipy.interpolate</td>
<td>插值</td>
</tr>
<tr>
<td>scipy.io</td>
<td>数据输入输出</td>
</tr>
<tr>
<td>scipy.linalg</td>
<td>线性代数程序</td>
</tr>
<tr>
<td>scipy.ndimage</td>
<td>n维图像包</td>
</tr>
<tr>
<td>scipy.odr</td>
<td>正交距离回归</td>
</tr>
<tr>
<td>scipy.optimize</td>
<td>优化</td>
</tr>
<tr>
<td>scipy.signal</td>
<td>信号处理</td>
</tr>
<tr>
<td>scipy.sparse</td>
<td>稀疏矩阵</td>
</tr>
<tr>
<td>scipy.spatial</td>
<td>空间数据结构和算法</td>
</tr>
<tr>
<td>scipy.special</td>
<td>任何特殊数学函数</td>
</tr>
<tr>
<td>scipy.stats</td>
<td>统计</td>
</tr>
</tbody>
</table>
<p>它们全依赖<a href="http://docs.scipy.org/doc/numpy/reference/index.html#numpy" target="_blank" rel="external">numpy</a>,但是每个之间基本独立。导入Numpy和这些scipy模块的标准方式是：</p>
<pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> scipy <span class="keyword">import</span> stats  <span class="comment"># 其它子模块相同</span>
</code></pre><p>主<code>scipy</code>命名空间大多包含真正的numpy函数(尝试 scipy.cos 就是 np.cos)。这些仅仅是由于历史原因，通常没有理由在你的代码中使用<code>import scipy</code></p>
<h2 id="文件输入/输出：scipy-io">文件输入/输出：scipy.io</h2><ul>
<li><p>导入和保存matlab文件:</p>
<pre><code><span class="keyword">In</span> [<span class="number">1</span>]: <span class="keyword">from</span> scipy import io <span class="keyword">as</span> spio

<span class="keyword">In</span> [<span class="number">3</span>]: import numpy <span class="keyword">as</span> np

<span class="keyword">In</span> [<span class="number">4</span>]: a = np.ones((<span class="number">3</span>, <span class="number">3</span>))

<span class="keyword">In</span> [<span class="number">5</span>]: spio.savemat(<span class="string">'file.mat'</span>, <span class="comment">{'a': a}</span>) # savemat expects a dictionary
/usr/lib/python2.<span class="number">7</span>/site-packages/scipy/io/matlab/mio.py:<span class="number">266</span>: FutureWarning: <span class="keyword">Using</span> oned_as <span class="keyword">default</span> value (<span class="string">'column'</span>) This will change <span class="keyword">to</span> <span class="string">'row'</span> <span class="keyword">in</span> <span class="keyword">future</span> versions
  oned_as=oned_as)

<span class="keyword">In</span> [<span class="number">6</span>]: data = spio.loadmat(<span class="string">'file.mat'</span>, struct_as_record=<span class="keyword">True</span>)

<span class="keyword">In</span> [<span class="number">7</span>]: data[<span class="string">'a'</span>]
<span class="keyword">Out</span>[<span class="number">7</span>]: 
<span class="keyword">array</span>([[ <span class="number">1</span>.,  <span class="number">1</span>.,  <span class="number">1</span>.],
       [ <span class="number">1</span>.,  <span class="number">1</span>.,  <span class="number">1</span>.],
       [ <span class="number">1</span>.,  <span class="number">1</span>.,  <span class="number">1</span>.]])
</code></pre></li>
<li><p>读取图片：</p>
<pre><code><span class="name">In</span> [<span class="number">16</span>]: <span class="atom">from</span> <span class="atom">scipy</span> <span class="atom">import</span> <span class="atom">misc</span>

<span class="name">In</span> [<span class="number">17</span>]: <span class="atom">misc</span>.<span class="atom">imread</span>(<span class="string">'scikit.png'</span>)
<span class="name">Out</span>[<span class="number">17</span>]: 
<span class="atom">array</span>([[[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]],

       [[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]],

       [[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]],

       ..., 
       [[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]],

       [[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]],

       [[<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        ..., 
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>],
        [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>]]], <span class="atom">dtype</span>=<span class="atom">uint8</span>)

<span class="name">In</span> [<span class="number">18</span>]: <span class="atom">import</span> <span class="atom">matplotlib</span>.<span class="atom">pyplot</span> <span class="atom">as</span> <span class="atom">plt</span>

<span class="name">In</span> [<span class="number">19</span>]: <span class="atom">plt</span>.<span class="atom">imread</span>(<span class="string">'scikit.png'</span>)
<span class="name">Out</span>[<span class="number">19</span>]: 
<span class="atom">array</span>([[[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]],

       [[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]],

       [[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]],

       ..., 
       [[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]],

       [[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]],

       [[ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        ..., 
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>],
        [ <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>]]], <span class="atom">dtype</span>=<span class="atom">float32</span>)
</code></pre></li>
</ul>
<p>参见：</p>
<ul>
<li>载入txt文件：numpy.loadtxt()/numpy.savetxt()</li>
<li>智能导入文本/csv文件：numpy.genfromtxt()/numpy.recfromcsv()</li>
<li>高速，有效率但numpy特有的二进制格式：numpy.save()/numpy.load()</li>
</ul>
<h2 id="特殊函数：scipy-special">特殊函数：scipy.special</h2><p>特殊函数是先验函数。<a href="http://docs.scipy.org/doc/scipy/reference/special.html#scipy.special" target="_blank" rel="external">scipy.special</a>的文档字符串写得非常好，所以我们不在这里列出所有函数。常用的有：</p>
<ul>
<li>贝塞尔函数，如<code>scipy.special.jn()</code>(整数n阶贝塞尔函数)</li>
<li>椭圆函数(<code>scipy.special.ellipj()</code>雅可比椭圆函数，……)</li>
<li>伽马函数：<code>scipy.special.gamma()</code>，还要注意<code>scipy.special.gammaln</code>,这个函数给出对数坐标的伽马函数，因此有更高的数值精度。</li>
</ul>
<h2 id="线性代数运算：scipy-linalg">线性代数运算：scipy.linalg</h2><p><a href="http://docs.scipy.org/doc/scipy/reference/linalg.html#scipy.linalg" target="_blank" rel="external">scipy.linalg</a>模块提供标准线性代数运算，依赖于底层有效率的实现(BLAS，LAPACK)。</p>
<ul>
<li><p><a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.det.html#scipy.linalg.det" target="_blank" rel="external">scipy.linalg.det()</a>函数计算方阵的行列式：</p>
<pre><code>In [<span class="number">22</span>]: from scipy import linalg

In [<span class="number">23</span>]: arr = np.array([[<span class="number">1</span>, <span class="number">2</span>],
   ....:                [<span class="number">3</span>, <span class="number">4</span>]])

In [<span class="number">24</span>]: linalg.<span class="function"><span class="title">det</span><span class="params">(arr)</span></span>
Out[<span class="number">24</span>]: -<span class="number">2.0</span>

In [<span class="number">25</span>]: linalg.<span class="function"><span class="title">det</span><span class="params">(np.ones((<span class="number">3</span>,<span class="number">4</span>)</span></span>))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
&lt;ipython-input-<span class="number">25</span>-<span class="number">375</span>ad1d49940&gt; <span class="keyword">in</span> &lt;module&gt;()
----&gt; <span class="number">1</span> linalg.<span class="function"><span class="title">det</span><span class="params">(np.ones((<span class="number">3</span>,<span class="number">4</span>)</span></span>))

/usr/lib/python2.<span class="number">7</span>/site-packages/scipy/linalg/basic<span class="class">.pyc</span> <span class="keyword">in</span> <span class="function"><span class="title">det</span><span class="params">(a, overwrite_a)</span></span>
    <span class="number">398</span>     a1 = np.<span class="function"><span class="title">asarray_chkfinite</span><span class="params">(a)</span></span>
    <span class="number">399</span>     <span class="keyword">if</span> <span class="function"><span class="title">len</span><span class="params">(a1.shape)</span></span> != <span class="number">2</span> or a1<span class="class">.shape</span>[<span class="number">0</span>] != a1<span class="class">.shape</span>[<span class="number">1</span>]:
--&gt; <span class="number">400</span>         raise <span class="function"><span class="title">ValueError</span><span class="params">(<span class="string">'expected square matrix'</span>)</span></span>
    <span class="number">401</span>     overwrite_a = overwrite_a or _datacopied(a1, a)
    <span class="number">402</span>     fdet, = <span class="function"><span class="title">get_flinalg_funcs</span><span class="params">((<span class="string">'det'</span>,)</span></span>, (a1,))

ValueError: expected square matrix
</code></pre></li>
</ul>
<p>py.linalg.inv()`函数计算方阵的逆：</p>
<pre><code>In [<span class="number">26</span>]: arr = np.<span class="built_in">array</span>([[<span class="number">1</span>, <span class="number">2</span>],
                [<span class="number">3</span>, <span class="number">4</span>]])

In [<span class="number">27</span>]: iarr = linalg.inv(arr)

In [<span class="number">28</span>]: iarr
Out[<span class="number">28</span>]: 
<span class="built_in">array</span>([[-<span class="number">2.</span> ,  <span class="number">1.</span> ],
       [ <span class="number">1.5</span>, -<span class="number">0.5</span>]])

In [<span class="number">29</span>]: np.allclose(np.dot(arr, iarr), np.eye(<span class="number">2</span>))
Out[<span class="number">29</span>]: True
</code></pre><p>最后计算奇异阵的逆(它的行列式为0)将会引发(raise)<code>LinAlgError</code>：</p>
<pre><code>In [<span class="number">32</span>]: arr = np.array([[<span class="number">3</span>, <span class="number">2</span>],
                [<span class="number">6</span>, <span class="number">4</span>]])

In [<span class="number">33</span>]: linalg.<span class="function"><span class="title">inv</span><span class="params">(arr)</span></span>
---------------------------------------------------------------------------
LinAlgError                               Traceback (most recent call last)
&lt;ipython-input-<span class="number">33</span>-<span class="number">52</span>c04c854a80&gt; <span class="keyword">in</span> &lt;module&gt;()
----&gt; <span class="number">1</span> linalg.<span class="function"><span class="title">inv</span><span class="params">(arr)</span></span>

/usr/lib/python2.<span class="number">7</span>/site-packages/scipy/linalg/basic<span class="class">.pyc</span> <span class="keyword">in</span> <span class="function"><span class="title">inv</span><span class="params">(a, overwrite_a)</span></span>
    <span class="number">346</span>             inv_a, info = <span class="function"><span class="title">getri</span><span class="params">(lu, piv, overwrite_lu=<span class="number">1</span>)</span></span>
    <span class="number">347</span>     <span class="keyword">if</span> info &gt; <span class="number">0</span>:
--&gt; <span class="number">348</span>         raise <span class="function"><span class="title">LinAlgError</span><span class="params">(<span class="string">"singular matrix"</span>)</span></span>
    <span class="number">349</span>     <span class="keyword">if</span> info &lt; <span class="number">0</span>:
    <span class="number">350</span>         raise ValueError(<span class="string">'illegal value in %d-th argument of internal '</span>

LinAlgError: singular matrix
</code></pre><ul>
<li><p>还有更多高级运算，如奇异值分解(SVD):</p>
<pre><code>In [<span class="number">34</span>]: arr = np.<span class="function"><span class="title">arange</span><span class="params">(<span class="number">9</span>)</span></span>.<span class="function"><span class="title">reshape</span><span class="params">((<span class="number">3</span>, <span class="number">3</span>)</span></span>) + np.<span class="function"><span class="title">diag</span><span class="params">([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>])</span></span>

In [<span class="number">35</span>]: uarr, spec, vharr = linalg.<span class="function"><span class="title">svd</span><span class="params">(arr)</span></span>
</code></pre><p>它的结果数组谱是：</p>
<pre><code>In [<span class="number">36</span>]: spec
Out[<span class="number">36</span>]: <span class="built_in">array</span>([ <span class="number">14.88982544</span>,   <span class="number">0.45294236</span>,   <span class="number">0.29654967</span>])
</code></pre><p>原始矩阵可以由svd的输出用<code>np.dot</code>点乘重新组合得到：</p>
<pre><code>In [<span class="number">37</span>]: sarr = np.<span class="function"><span class="title">diag</span><span class="params">(spec)</span></span>

In [<span class="number">38</span>]: svd_mat = uarr.<span class="function"><span class="title">dot</span><span class="params">(sarr)</span></span>.<span class="function"><span class="title">dot</span><span class="params">(vharr)</span></span>

In [<span class="number">39</span>]: np.<span class="function"><span class="title">allclose</span><span class="params">(svd_mat, arr)</span></span>
Out[<span class="number">39</span>]: True
</code></pre></li>
</ul>
<p>SVD在信号处理和统计中运用很广。许多其它标准分解(QR,LU,Cholesky,Schur)，还有线性系统的解也可以从<a href="http://docs.scipy.org/doc/scipy/reference/linalg.html#scipy.linalg" target="_blank" rel="external">scipy.linalg</a>中获得。</p>
<h2 id="快速傅里叶变换：scipy-fftpack">快速傅里叶变换：scipy.fftpack</h2><p><a href="http://docs.scipy.org/doc/scipy/reference/fftpack.html#scipy.fftpack" target="_blank" rel="external">scipy.fftpack</a>模块用来计算快速傅里叶变换。作为示例，一个(噪声)输入信号可能像这样：</p>
<pre><code>In [<span class="number">40</span>]: time_step = <span class="number">0.02</span>

In [<span class="number">41</span>]: period = <span class="number">5</span>

In [<span class="number">42</span>]: time_vec = np.arange(<span class="number">0</span>, <span class="number">20</span>, time_step)

In [<span class="number">43</span>]: sig = np.<span class="built_in">sin</span>(<span class="number">2</span> * np.pi / period * time_vec) + \
   ....: <span class="number">0.5</span> * np.random.randn(time_vec.size)
</code></pre><p>观测者并不指导信号频率，仅仅等间隔取样信号sig。信号应该来自一个真实的函数所以傅里叶变换将是对称的。<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.fftpack.fftfreq.html#scipy.fftpack.fftfreq" target="_blank" rel="external">scipy.fftpack.fftfreq()</a>函数将生成取样频率，<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.fftpack.fft.html#scipy.fftpack.fft" target="_blank" rel="external">scipy.fftpack.fft()</a>将计算快速傅里叶变换：</p>
<p>因为功率结果是对称的，仅仅需要使用谱的正值部分来找出频率：</p>
<pre><code>In [<span class="number">48</span>]: pidxs = np.where(sample_freq &gt; <span class="number">0</span>)

In [<span class="number">49</span>]: freqs = sample_fre<span class="string">q[pidxs]</span>

In [<span class="number">50</span>]: power = np.<span class="keyword">abs</span>(sig_fft)[pidxs]
</code></pre><p>信号频率可以这样被找到：</p>
<pre><code>In [<span class="number">51</span>]: freq = freqs[power.<span class="function"><span class="title">argmax</span><span class="params">()</span></span>]

In [<span class="number">52</span>]: np.<span class="function"><span class="title">allclose</span><span class="params">(freq, <span class="number">1</span>./period)</span></span>
Out[<span class="number">52</span>]: True
</code></pre><p>现在高频噪声将被从傅里叶变换信号中移除：</p>
<pre><code>In [<span class="number">53</span>]: sig_fft[np.<span class="built_in">abs</span>(sample_freq) &gt; freq] = <span class="number">0</span>
</code></pre><p>得到滤波信号，可以用<code>scipy.fftpack.ifft</code>函数计算：</p>
<pre><code>In [<span class="number">54</span>]: main_sig = fftpack.<span class="function"><span class="title">ifft</span><span class="params">(sig_fft)</span></span>
</code></pre><p>结果可以这样可视化：</p>
<pre><code>In [<span class="number">55</span>]: plt.<span class="function"><span class="title">figure</span><span class="params">()</span></span>
Out[<span class="number">55</span>]: &lt;matplotlib<span class="class">.figure</span><span class="class">.Figure</span> at <span class="number">0</span>x4a9fb50&gt;

In [<span class="number">56</span>]: plt.<span class="function"><span class="title">plot</span><span class="params">(time_vec, sig)</span></span>
Out[<span class="number">56</span>]: [&lt;matplotlib<span class="class">.lines</span><span class="class">.Line2D</span> at <span class="number">0</span>x4ad3790&gt;]

In [<span class="number">57</span>]: plt.<span class="function"><span class="title">plot</span><span class="params">(time_vec, main_sig, linewidth=<span class="number">3</span>)</span></span>
/usr/lib/python2.<span class="number">7</span>/site-packages/numpy/core/numeric<span class="class">.py</span>:<span class="number">320</span>: ComplexWarning: Casting complex values to real discards the imaginary part
  return <span class="function"><span class="title">array</span><span class="params">(a, dtype, copy=False, order=order)</span></span>
Out[<span class="number">57</span>]: [&lt;matplotlib<span class="class">.lines</span><span class="class">.Line2D</span> at <span class="number">0</span>x4ad3dd0&gt;]

In [<span class="number">58</span>]: plt.<span class="function"><span class="title">xlabel</span><span class="params">(<span class="string">'Time [s]'</span>)</span></span>
Out[<span class="number">58</span>]: &lt;matplotlib<span class="class">.text</span><span class="class">.Text</span> at <span class="number">0</span>x4aad050&gt;

In [<span class="number">59</span>]: plt.<span class="function"><span class="title">ylabel</span><span class="params">(<span class="string">'Amplitude'</span>)</span></span>
Out[<span class="number">59</span>]: &lt;matplotlib<span class="class">.text</span><span class="class">.Text</span> at <span class="number">0</span>x4aadbd0&gt;

In [<span class="number">60</span>]: plt.<span class="function"><span class="title">show</span><span class="params">()</span></span>
</code></pre><p><strong><a href="http://docs.scipy.org/doc/numpy/reference/routines.fft.html#numpy.fft" target="_blank" rel="external">numpy.fft</a></strong></p>
<p>Numpy也有一个FFT实现(numpy.fft)。然而，通常scipy的应该优先使用，因为它使用了更有效率的底层实现。</p>
<h3 id="工作示例：找到原始周期">工作示例：找到原始周期</h3><p><a href="http://scipy-lectures.github.com/plot_directive/intro/solutions/periodicity_finder.py" target="_blank" rel="external">source code</a></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/intro/solutions/periodicity_finder.py" target="_blank" rel="external">source code</a></p>
<h3 id="工作示例：高斯图像模糊">工作示例：高斯图像模糊</h3><p>卷积：</p>
<p>$$<br>f_1(t) = \int dt’K(t-t’)f_0(t’)<br>$$</p>
<p>$$<br>\tilde{f_1}(\omega)=\tilde{K}(\omega)\tilde{f_0}(\omega)<br>$$</p>
<p><strong>练习：登月图片消噪</strong></p>
<p><img src="http://scipy-lectures.github.com/_images/moonlanding.png" alt="moonlanding.png"></p>
<ol>
<li>检查提供的图像moonlanding.png，该图像被周期噪声严重污染了。在这个练习中，我们旨在使用快速傅里叶变换清除噪声。</li>
<li>用<code>plt.imread</code>加载图像。</li>
<li>使用<code>scipy.fftpack</code>中的2-D傅里叶函数找到并绘制图像的谱线(傅里叶变换)。可视化这个谱线对你有问题吗？如果有，为什么？</li>
<li>这个谱包含高频和低频成分。噪声是在谱线的高频部分中，所以设置一些成分为0(使用数组切片)。</li>
<li>应用逆傅里叶变换来看最后的图像。</li>
</ol>
<p><img src="http://fmn.rrimg.com/fmn056/20121022/2330/p_large_PyL8_4bee00000f241263.jpg" alt="我的消除噪声实例……"></p>
<h2 id="优化和拟合：scipy-optimize">优化和拟合：scipy.optimize</h2><p>优化是找到最小值或等式的数值解的问题。</p>
<p><code>scipy.optimization</code>子模块提供了函数最小值(标量或多维)、曲线拟合和寻找等式的根的有用算法。</p>
<pre><code><span class="keyword">from</span> scipy <span class="keyword">import</span> optimize
</code></pre><p><strong>找到标量函数的最小值</strong></p>
<p>让我们定义以下函数</p>
<pre><code>In [<span class="number">2</span>]: <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span>
   ...:     <span class="keyword">return</span> x**<span class="number">2</span> + <span class="number">10</span> * np.sin(x)
</code></pre><p>然后绘制它：</p>
<pre><code>In [<span class="number">3</span>]: x = np.<span class="function"><span class="title">arange</span><span class="params">(-<span class="number">10</span>, <span class="number">10</span>, <span class="number">0.1</span>)</span></span>

In [<span class="number">4</span>]: plt.<span class="function"><span class="title">plot</span><span class="params">(x, f(x)</span></span>)
Out[<span class="number">4</span>]: [&lt;matplotlib<span class="class">.lines</span><span class="class">.Line2D</span> at <span class="number">0</span>x3e2a4d0&gt;]

In [<span class="number">5</span>]: plt.<span class="function"><span class="title">show</span><span class="params">()</span></span>
</code></pre><p><img src="http://scipy-lectures.github.com/_images/scipy_optimize_example1.png" alt="optimization"></p>
<p>该函数在大约-1.3有个全局最小值,在3.8有个局部最小值。</p>
<p>找到这个函数最小值一般而有效的方法是从初始点使用梯度下降法。BFGS算法<a href="[BFGS算法](http://en.wikipedia.org/wiki/BFGS_method)">^1</a>是做这个的好方法：</p>
<pre><code>In [<span class="number">6</span>]: optimize.fmin_bfgs(f, <span class="number">0</span>)
Optimization terminated successfully.
         Current function value: -<span class="number">7.945823</span>
         Iterations: <span class="number">5</span>
         Function evaluations: <span class="number">24</span>
         Gradient evaluations: <span class="number">8</span>
Out[<span class="number">6</span>]: <span class="built_in">array</span>([-<span class="number">1.30644003</span>])
</code></pre><p>这个方法一个可能的问题在于，如果函数有局部最小值，算法会因初始点不同找到这些局部最小而不是全局最小:</p>
<pre><code>In [<span class="number">7</span>]: optimize.fmin_bfgs(f, <span class="number">3</span>, disp=<span class="number">0</span>)
Out[<span class="number">7</span>]: <span class="built_in">array</span>([ <span class="number">3.83746663</span>])
</code></pre><p>如果我们不知道全局最小值的邻近值来选定初始点，我们需要借助于耗费资源些的全局优化。为了找到全局最小点，最简单的算法是蛮力算法<a href="[Brute-Force方法](http://en.wikipedia.org/wiki/Brute-force_search)">^2</a>，该算法求出给定格点的每个函数值。</p>
<pre><code>In [<span class="number">10</span>]: grid = (-<span class="number">10</span>, <span class="number">10</span>, <span class="number">0.1</span>)

In [<span class="number">11</span>]: xmin_global = optimize.brute(f, (grid,))

In [<span class="number">12</span>]: xmin_global
Out[<span class="number">12</span>]: <span class="built_in">array</span>([-<span class="number">1.30641113</span>])
</code></pre><p>对于大点的格点，<code>scipy.optimize.brute()</code>变得非常慢。<code>scipy.optimize.anneal()</code>提供了使用模拟退火的替代函数。对已知的不同类别全局优化问题存在更有效率的算法，但这已经超出scipy的范围。一些有用全局优化软件包是<a href="http://openopt.org/Welcome" target="_blank" rel="external">OpenOpt</a>、<a href="https://github.com/xuy/pyipopt" target="_blank" rel="external">IPOPT</a>、<a href="http://pagmo.sourceforge.net/pygmo/index.html" target="_blank" rel="external">PyGMO</a>和<a href="http://pyevolve.sourceforge.net/" target="_blank" rel="external">PyEvolve</a>。</p>
<p>为了找到局部最小，我们把变量限制在<code>(0, 10)</code>之间，使用<code>scipy.optimize.fminbound()</code>:</p>
<pre><code>In [<span class="number">13</span>]: xmin_local = optimize.fminbound(f, <span class="number">0</span>, <span class="number">10</span>)

In [<span class="number">14</span>]: xmin_local
Out[<span class="number">14</span>]: <span class="number">3.8374671194983834</span>
</code></pre><p><strong>注意：</strong>在高级章节部分<a href="http://scipy-lectures.github.com/advanced/mathematical_optimization/index.html#mathematical-optimization" target="_blank" rel="external">数学优化：找到函数最小值</a>中有关于寻找函数最小值更详细的讨论。</p>
<p><strong>找到标量函数的根</strong></p>
<p>为了寻找根，例如令<code>f(x)=0</code>的点，对以上的用来示例的函数<code>f</code>我们可以使用<code>scipy.optimize.fsolve()</code>:</p>
<pre><code>In [<span class="number">17</span>]: root = optimize.fsolve(f, <span class="number">1</span>)  <span class="preprocessor"># 我们的初始猜测是<span class="number">1</span></span>

In [<span class="number">18</span>]: root
Out[<span class="number">18</span>]: <span class="built_in">array</span>([ <span class="number">0.</span>])
</code></pre><p>注意仅仅一个根被找到。检查f的图像在-2.5附近有第二个根。我们可以通过调整我们的初始猜测找到这一确切值：</p>
<pre><code>In [<span class="number">19</span>]: root = optimize.fsolve(f, -<span class="number">2.5</span>)

In [<span class="number">20</span>]: root
Out[<span class="number">20</span>]: <span class="built_in">array</span>([-<span class="number">2.47948183</span>])
</code></pre><p><strong>曲线拟合</strong></p>
<p>假设我们有从被噪声污染的f中抽样到的数据：</p>
<pre><code>In [<span class="number">21</span>]: xdata = np.<span class="function"><span class="title">linspace</span><span class="params">(-<span class="number">10</span>, <span class="number">10</span>, num=<span class="number">20</span>)</span></span>

In [<span class="number">22</span>]: ydata = <span class="function"><span class="title">f</span><span class="params">(xdata)</span></span> + np<span class="class">.random</span><span class="class">.randn</span>(xdata.size)
</code></pre><p>如果我们知道函数形式(当前情况是<code>x^2 + sin(x)</code>)，但是不知道幅度。我们可以通过最小二乘拟合拟合来找到幅度。首先我们定义一个用来拟合的函数：</p>
<pre><code>In [<span class="number">23</span>]: <span class="function"><span class="keyword">def</span> <span class="title">f2</span><span class="params">(x, a, b)</span>:</span>
   ....:     <span class="keyword">return</span> a*x**<span class="number">2</span> + b*np.sin(x)
</code></pre><p>然后我们可以使用<code>scipy.optimize.curve_fit()</code>来找到a和b：</p>
<pre><code>In [<span class="number">24</span>]: guess = [<span class="number">2</span>, <span class="number">2</span>]

In [<span class="number">25</span>]: params, params_covariance = optimize.curve_fit(f2, xdata, ydata, guess)

In [<span class="number">26</span>]: params
Out[<span class="number">26</span>]: <span class="built_in">array</span>([  <span class="number">1.00439471</span>,  <span class="number">10.04911441</span>])
</code></pre><p>现在我们找到了f的最小值和根并且对它使用了曲线拟合。我们将一切放在一个单独的图像中:</p>
<p><img src="http://scipy-lectures.github.com/_images/scipy_optimize_example2.png" alt="function"></p>
<p><strong>注意：</strong>Scipy>=0.11中提供所有最小化和根寻找算法的统一接口<code>scipy.optimize.minimize()</code>,<code>scipy.optimize.minimize_scalar()</code>和<code>scipy.optimize.root()</code>。它们允许通过method关键字方便地比较不同算法。</p>
<p>你可以在<code>scipy.optimize</code>中找到用来解决多维问题的相同功能的算法。</p>
<p><strong>练习：曲线拟合温度数据</strong></p>
<p>在阿拉斯加每个月的温度上下限，从一月开始，以摄氏单位给出。</p>
<table>
<thead>
<tr>
<th>max:</th>
<th>17,  19,  21,  28,  33,  38, 37,  37,  31,  23,  19,  18</th>
</tr>
</thead>
<tbody>
<tr>
<td>min:</td>
<td>-62, -59, -56, -46, -32, -18, -9, -13, -25, -46, -52, -58</td>
</tr>
</tbody>
</table>
<ol>
<li>绘制这些温度限</li>
<li>定义函数来描述最小和最大温度。提示：这个函数以一年为周期。提示：包括时间偏移。</li>
<li>对数据使用这个函数<code>scipy.optimize.curve_fit()</code></li>
<li>绘制结果。是否拟合合理？如果不合理，为什么？</li>
<li>拟合精度的最大最小温度的时间偏移是否一样？</li>
</ol>
<p><strong>练习：2维最小化</strong></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/scipy_optimize_sixhump.py" target="_blank" rel="external">source code</a></p>
<p>六峰值驼背函数：</p>
<p>$$<br>f(x,y) = (4 - 2.1x^2 + \frac{x^4}{3})x^2 + xy + (4y^2 - 4)y^2<br>$$</p>
<p>有全局和多个局部最小。找到这个函数的全局最小。</p>
<p>提示：</p>
<ul>
<li>变量应该限制在<code>-2 &lt; x &lt; 2 , -1 &lt; y &lt; 1</code>.</li>
<li>使用<code>numpy.meshgrid()</code>和<code>plt.imshow</code>来可视地搜寻区域。</li>
<li>使用<code>scipy.optimize.fmin_bfgs()</code>或其它多维极小化器。</li>
</ul>
<p>这里有多少极小值？这些点上的函数值是多少？如果初始猜测是<code>(x, y) = (0, 0)</code>会发生什么？</p>
<p>参见总结练习<a href="http://scipy-lectures.github.com/intro/summary-exercises/optimize-fit.html#summary-exercise-optimize" target="_blank" rel="external">非线性最小二乘拟合：在点抽取地形激光雷达数据上的应用</a>，来看另一个，更高级的例子。</p>
<h2 id="统计和随机数：_scipy-stats">统计和随机数： scipy.stats</h2><p><code>scipy.stats</code>包括统计工具和随机过程的概率过程。各个随机过程的随机数生成器可以从<code>numpy.random</code>中找到。</p>
<h3 id="直方图和概率密度函数">直方图和概率密度函数</h3><p>给定一个随机过程的观察值，它们的直方图是随机过程的pdf(概率密度函数)的估计器：</p>
<pre><code>In [<span class="number">1</span>]: import numpy as np

In [<span class="number">2</span>]: a = np.random.normal(size=<span class="number">1000</span>)

In [<span class="number">3</span>]: bins = np.arange(-<span class="number">4</span>, <span class="number">5</span>)

In [<span class="number">4</span>]: bins
Out[<span class="number">4</span>]: <span class="built_in">array</span>([-<span class="number">4</span>, -<span class="number">3</span>, -<span class="number">2</span>, -<span class="number">1</span>,  <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>])

In [<span class="number">5</span>]: histogram = np.histogram(a, bins=bins, normed=True)[<span class="number">0</span>]

In [<span class="number">6</span>]: bins = <span class="number">0.5</span>*(bins[<span class="number">1</span>:] + bins[:-<span class="number">1</span>])

In [<span class="number">7</span>]: bins
Out[<span class="number">7</span>]: <span class="built_in">array</span>([-<span class="number">3.5</span>, -<span class="number">2.5</span>, -<span class="number">1.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.5</span>,  <span class="number">2.5</span>,  <span class="number">3.5</span>])

In [<span class="number">8</span>]: from scipy import stats

In [<span class="number">9</span>]: b = stats.norm.pdf(bins)  <span class="preprocessor"># norm是正态分布</span>

In [<span class="number">10</span>]: import matplotlib.pyplot as plt

In [<span class="number">11</span>]: plt.plot(bins, histogram)
Out[<span class="number">11</span>]: [&lt;matplotlib.lines.Line2D at <span class="number">0x3378b10</span>&gt;]

In [<span class="number">12</span>]: plt.plot(bins, b)
Out[<span class="number">12</span>]: [&lt;matplotlib.lines.Line2D at <span class="number">0x3378fd0</span>&gt;]

In [<span class="number">13</span>]: plt.show()
</code></pre><p>如果我们知道随机过程属于给定的随机过程族，比如正态过程。我们可以对观测值进行最大似然拟合来估计基本分布参数。这里我们对观测值拟合一个正态过程：</p>
<pre><code>In [<span class="number">14</span>]: loc, <span class="built_in">std</span> = stats.norm.fit(a)

In [<span class="number">15</span>]: loc
Out[<span class="number">15</span>]: <span class="number">0.0052651057415999758</span>

In [<span class="number">16</span>]: <span class="built_in">std</span>
Out[<span class="number">16</span>]: <span class="number">0.97945439802779732</span>
</code></pre><p><strong>练习：概率分布</strong></p>
<p>从参数为1的伽马分布生成1000个随机数,然后绘制这些样点的直方图。你能够在其上绘制pdf吗(应该匹配)？</p>
<p>另外：这些分布有些有用的方法。通过阅读它们的文档字符串或使用IPython的tab补全来探索它们。你能够通过对你的随机变量使用拟合找到形状参数1吗？</p>
<h3 id="百分位">百分位</h3><p>中位数是来观测值之下一半之上一半的值。</p>
<pre><code><span class="tag">In</span> <span class="attr_selector">[3]</span>: <span class="tag">np</span><span class="class">.median</span>(<span class="tag">a</span>)
<span class="tag">Out</span><span class="attr_selector">[3]</span>: <span class="tag">-0</span><span class="class">.047679175711778043</span>
</code></pre><p>它也被叫作50百分位点，因为有50%的观测值在它之下：</p>
<pre><code>In [<span class="number">6</span>]: stats.scoreatpercentile(a, <span class="number">50</span>)
Out[<span class="number">6</span>]: -<span class="number">0.047679175711778043</span>
</code></pre><p>同样我们可以计算百分之九十百分点：</p>
<pre><code>In [<span class="number">7</span>]: stats.scoreatpercentile(a, <span class="number">90</span>)
Out[<span class="number">7</span>]: <span class="number">1.2541592439997036</span>
</code></pre><p>百分位是CDF的一个估计器(累积分布函数)。</p>
<h3 id="统计检测">统计检测</h3><p>统计检测是决策指示。例如，我们有两个样本集，我们假设它们由高斯过程生成。我们可以使用<a href="http://en.wikipedia.org/wiki/Student%27s_t-test" target="_blank" rel="external">T检验</a>来决定是否两个样本值显著不同：</p>
<pre><code>In [<span class="number">8</span>]: <span class="tag">a</span> = np<span class="class">.random</span><span class="class">.normal</span>(<span class="number">0</span>, <span class="number">1</span>, size=<span class="number">100</span>)

In [<span class="number">9</span>]: <span class="tag">b</span> = np<span class="class">.random</span><span class="class">.normal</span>(<span class="number">1</span>, <span class="number">1</span>, size=<span class="number">10</span>)

In [<span class="number">10</span>]: stats.<span class="function"><span class="title">ttest_ind</span><span class="params">(a, b)</span></span>
Out[<span class="number">10</span>]: (<span class="function"><span class="title">array</span><span class="params">(-<span class="number">2.4119199601156796</span>)</span></span>, <span class="number">0.01755485116571583</span>)
</code></pre><p>输出结果由以下部分组成：</p>
<ul>
<li>T统计量：它是这么一种标志，与不同两个随机过程之间成比例并且幅度和差异的显著程度有关<a href="……这解释，我真不懂。但t统计量是什么我知道……">^3</a>。</li>
<li>p值：两个过程相同的概率。如果接近1,这两个过程是几乎完全相同的。越靠近零，两个过程越可能有不同的均值。</li>
</ul>
<h2 id="插值：scipy-interpolate">插值：scipy.interpolate</h2><p><code>scipy.interpolate</code>对从实验数据拟合函数来求值没有测量值存在的点非常有用。这个模块基于来自<a href="http://www.netlib.org/" target="_blank" rel="external">netlib</a>项目的<a href="http://www.netlib.org/dierckx/index.html" target="_blank" rel="external">FITPACK Fortran 子程序</a>。</p>
<p>通过想象接近正弦函数的实验数据：</p>
<pre><code>In [<span class="number">1</span>]: measured_time = np.linspace(<span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>)

In [<span class="number">2</span>]: noise = (np.random.random(<span class="number">10</span>)*<span class="number">2</span> - <span class="number">1</span>) * <span class="number">1e-1</span>

In [<span class="number">3</span>]: measures = np.<span class="built_in">sin</span>(<span class="number">2</span> * np.pi * measured_time) + noise
</code></pre><p><code>scipy.interpolate.interp1d</code>类会构建线性插值函数：</p>
<pre><code>In [<span class="number">4</span>]: from scipy<span class="class">.interpolate</span> import interp1d

In [<span class="number">5</span>]: linear_interp = <span class="function"><span class="title">interp1d</span><span class="params">(measured_time, measures)</span></span>
</code></pre><p>然后<code>scipy.interpolate.linear_interp</code>实例需要被用来求得感兴趣时间点的值：</p>
<pre><code>In [<span class="number">6</span>]: computed_time = np.<span class="function"><span class="title">linspace</span><span class="params">(<span class="number">0</span>, <span class="number">1</span>, <span class="number">50</span>)</span></span>

In [<span class="number">7</span>]: linear_results = <span class="function"><span class="title">linear_interp</span><span class="params">(computed_time)</span></span>
</code></pre><p>三次插值也能通过提供可选关键字参数<code>kind</code>来选择：[^4]</p>
<pre><code>In [<span class="number">8</span>]: cubic_interp = <span class="function"><span class="title">interp1d</span><span class="params">(measured_time, measures, kind=<span class="string">'cubic'</span>)</span></span>

In [<span class="number">9</span>]: cubic_results = <span class="function"><span class="title">cubic_interp</span><span class="params">(computed_time)</span></span>
</code></pre><p>结果现在被集合在以下Matplotlib图像中：</p>
<p><img src="http://scipy-lectures.github.com/_images/scipy_interpolation.png" alt="interpolate"></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/scipy_interpolation.py" target="_blank" rel="external">source code</a></p>
<p><code>scipy.interpolate.interp2d</code>与<code>scipy.interpolate.interp1d</code>相似，但是面向二维数组。注意，对<em>interp</em>族，计算时间必须在测量时间范围内。参见<a href="http://scipy-lectures.github.com/intro/summary-exercises/stats-interpolate.html#summary-exercise-stat-interp" target="_blank" rel="external">Maximum wind speed prediction at the Sprogø station</a>的总结练习获得更高级的插值示例。</p>
<h2 id="数值积分：scipy-integrate_Fusy,">数值积分：scipy.integrate <strong>Fusy,</strong></h2><p>最通用的积分程序是<code>scipy.integrate.quad()</code>:</p>
<pre><code>In [<span class="number">10</span>]: from scipy.integrate import quad

In [<span class="number">11</span>]: res, err = quad(np.<span class="built_in">sin</span>, <span class="number">0</span>, np.pi/<span class="number">2</span>)

In [<span class="number">12</span>]: np.allclose(res, <span class="number">1</span>)
Out[<span class="number">12</span>]: True

In [<span class="number">13</span>]: np.allclose(err, <span class="number">1</span> - res)
Out[<span class="number">13</span>]: True
</code></pre><p>其它可用的积分方案有<code>fixed_quad</code>,<code>quadrature</code>,<code>romberg</code>。</p>
<p><code>scipy.integrate</code>也是用来积分常微分方程(ODE)的功能程序。特别是，<code>scipy.integrate.odeint()</code>是个使用LSODA(Livermore Solver for Ordinary Differential equations with Automatic method switching for stiff and non-stiff problems)通用积分器。参见<a href="http://people.sc.fsu.edu/~jburkardt/f77_src/odepack/odepack.html" target="_blank" rel="external">ODEPACK Fortran library</a>获得更多细节。</p>
<p><code>odeint</code>解决这种形式的一阶ODE系统：</p>
<pre><code>``dy/<span class="tag">dt</span> = <span class="function"><span class="title">rhs</span><span class="params">(y1, y2, .., t0,...)</span></span>``
</code></pre><p>作为简介，让我们解决ODE<code>dy/dt = -2y</code>,区间<code>t = 0..4</code>,初始条件<code>y(t=0) = 1</code>。首先函数计算导数的位置需要被定义：</p>
<pre><code>In [<span class="number">17</span>]: <span class="function"><span class="keyword">def</span> <span class="title">calc_derivative</span><span class="params">(ypos, time, counter_arr)</span>:</span>
   ....:     counter_arr += <span class="number">1</span>
   ....:     <span class="keyword">return</span> -<span class="number">2</span> * ypos                                               
   ....:     
</code></pre><p>一个额外的参数<code>counter_arr</code>被添加，用来说明函数可能在单个时间步中被多次调用，直到解收敛。计数数组被定义成：</p>
<pre><code>In [<span class="number">18</span>]: counter = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">1</span>,)</span></span>, dtype=np.uint16)            
</code></pre><p>弹道将被计算：</p>
<pre><code>In [<span class="number">19</span>]: from scipy.integrate import odeint                                 
In [<span class="number">20</span>]: time_vec = np.linspace(<span class="number">0</span>, <span class="number">4</span>, <span class="number">40</span>)                                   
In [<span class="number">21</span>]: yvec, info = odeint(calc_derivative, <span class="number">1</span>, time_vec,
   ....: args=(counter,), full_output=Tru)
</code></pre><p>因此导函数可以被调用40次(即时间步长数)，</p>
<pre><code>In [<span class="number">22</span>]: counter
Out[<span class="number">22</span>]: <span class="built_in">array</span>([<span class="number">129</span>], dtype=uint16)
</code></pre><p>十个最初的时间点(time step)每个的累积迭代次数，可以这样获得：</p>
<pre><code>In [<span class="link_label">23</span>]: info[<span class="link_label">'nfe'</span>][<span class="link_reference">:10</span>]
Out[23]: array([31, 35, 43, 49, 53, 57, 59, 63, 65, 69], dtype=int32)
</code></pre><p>注意到在第一个时间步的解需要更多的迭代。解<code>yvec</code>的轨道现在可以被画出：</p>
<p><img src="http://scipy-lectures.github.com/_images/odeint_introduction.png" alt="ODE"></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/odeint_introduction.py" target="_blank" rel="external">source code</a></p>
<p>另一个使用<code>scipy.integrate.odeint()</code>的例子是一个阻尼弹簧-质点振荡器(二阶振荡)。附加在弹簧上质点的位置服从二阶常微分方程<code>y&#39;&#39; + eps wo y&#39; + wo^2 y= 0</code>。其中<code>wo^2 = k/m</code>,k是弹簧常数，m是质量，<code>eps=c/(2 m wo)</code>，c是阻尼系数。(译者：为什么不用latex……)对于这个例子，我们选择如下参数：</p>
<pre><code>In [<span class="number">24</span>]: mass = <span class="number">0.5</span>  <span class="preprocessor"># kg</span>

In [<span class="number">25</span>]: kspring = <span class="number">4</span>  <span class="preprocessor"># N/m</span>

In [<span class="number">26</span>]: cviscous = <span class="number">0.4</span>  <span class="preprocessor"># N s/m</span>
</code></pre><p>所以系统将是阻尼振荡，因为：</p>
<pre><code>In [<span class="number">27</span>]: eps = cviscous / (<span class="number">2</span> * mass * np.<span class="built_in">sqrt</span>(kspring/mass))

In [<span class="number">28</span>]: eps &lt; <span class="number">1</span>
Out[<span class="number">28</span>]: True
</code></pre><p>对于<code>scipy,integrate.odeint()</code>求解器，二阶方程需要被转化成一个包含向量<code>Y =y,y&#39;</code>的两个一阶方程的系统。定义<code>nu = 2 eps * wo = c / m</code>和<code>om = wo^2 = k/m</code>很方便：</p>
<pre><code>In <span class="string">[29]</span>: nu_coef = cviscous /mass

In <span class="string">[30]</span>: om_coef = kspring / mass
</code></pre><p>因此函数将计算速度和加速度通过：</p>
<pre><code>In [<span class="number">31</span>]: <span class="function"><span class="keyword">def</span> <span class="title">calc_deri</span><span class="params">(yvec, time, nuc, omc)</span>:</span>
   ....:     <span class="keyword">return</span> (yvec[<span class="number">1</span>], -nuc * yvec[<span class="number">1</span>] - omc * yvec[<span class="number">0</span>])
   ....: 

In [<span class="number">32</span>]: time_vec = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)

In [<span class="number">33</span>]: yarr = odeint(calc_deri, (<span class="number">1</span>, <span class="number">0</span>), time_vec, args=(nu_coef, om_coef))
</code></pre><p>最终的位置和速度在如下Matplotlib图像中显示：</p>
<p><img src="http://scipy-lectures.github.com/_images/odeint_damped_spring_mass.png" alt="ode2"></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/odeint_damped_spring_mass.py" target="_blank" rel="external">source code</a></p>
<p>Scipy中不存在偏微分方程(PDE)求解器,一些解决PDE问题的Python软件包可以得到，像<a href="http://www.ctcms.nist.gov/fipy/" target="_blank" rel="external">fipy</a>和<a href="http://code.google.com/p/sfepy/" target="_blank" rel="external">SfePy</a></p>
<p>(译者注:<a href="http://hyry.dip.jp:8000/pydoc/scipy_intro.html#id5" target="_blank" rel="external">Python科学计算中洛伦兹吸引子微分方程的求解</a></p>
<h2 id="信号处理：scipy-signal">信号处理：scipy.signal</h2><pre><code>In [<span class="number">34</span>]: <span class="keyword">from</span> scipy <span class="keyword">import</span> signal
</code></pre><ul>
<li><p><code>scipy.signal.detrend()</code>：移除信号的线性趋势：</p>
<pre><code>In [<span class="number">35</span>]: t = np.linspace(<span class="number">0</span>, <span class="number">5</span>, <span class="number">100</span>)

In [<span class="number">36</span>]: x = t + np.random.normal(size=<span class="number">100</span>)

In [<span class="number">39</span>]: import pylab <span class="keyword">as</span> pl

In [<span class="number">40</span>]: pl.plot(t, x, linewidth=<span class="number">3</span>)
Out[<span class="number">40</span>]: <span class="annotation">[&lt;matplotlib.lines.Line2D at 0x3903c90&gt;]</span>

In [<span class="number">41</span>]: pl.plot(t, signal.detrend(x), linewidth=<span class="number">3</span>)
Out[<span class="number">41</span>]: <span class="annotation">[&lt;matplotlib.lines.Line2D at 0x3b38810&gt;]</span>
</code></pre></li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/demo_detrend.png" alt="detrend"></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/demo_detrend.py" target="_blank" rel="external">source code</a></p>
<ul>
<li><p><code>scipy.signal.resample()</code>:使用FFT重采样n个点。</p>
<pre><code>In [<span class="number">42</span>]: t = np.linspace(<span class="number">0</span>, <span class="number">5</span>, <span class="number">100</span>)

In [<span class="number">43</span>]: x = np.sin(t)

In [<span class="number">44</span>]: pl.plot(t, x, linewidth=<span class="number">3</span>)
Out[<span class="number">44</span>]: <span class="annotation">[&lt;matplotlib.lines.Line2D at 0x3f08a90&gt;]</span>

In [<span class="number">45</span>]: pl.plot(t[::<span class="number">2</span>], signal.resample(x, <span class="number">50</span>), 'ko')
Out[<span class="number">45</span>]: <span class="annotation">[&lt;matplotlib.lines.Line2D at 0x3f12950&gt;]</span>
</code></pre></li>
</ul>
<p><img src="http://scipy-lectures.github.com/_images/demo_resample.png" alt="resample"></p>
<p><a href="http://scipy-lectures.github.com/plot_directive/pyplots/demo_resample.py" target="_blank" rel="external">source code</a></p>
<ul>
<li><p>Signal中有许多窗函数：scipy.signal.hamming(), scipy.signal.bartlett(), scipy.signal.blackman()…</p>
</li>
<li><p>Signal中有滤波器(中值滤波scipy.signal.medfilt(), 维纳滤波scipy.signal.wiener())，但是我们将在图像部分讨论。</p>
</li>
</ul>
<h2 id="图像处理：scipy-ndimage">图像处理：scipy.ndimage</h2><p>scipy中致力于图像处理的子模块是<code>scipy,ndimage</code>。</p>
<pre><code>In [<span class="number">49</span>]: <span class="keyword">from</span> scipy <span class="keyword">import</span> ndimage
</code></pre><p>图像处理程序可以根据它们执行的操作类别来分类。</p>
<h3 id="图像的几何变换">图像的几何变换</h3><p>改变方向，分辨率……</p>
<pre><code>In [<span class="number">50</span>]: from scipy import misc

In [<span class="number">51</span>]: lena = misc.<span class="function"><span class="title">lena</span><span class="params">()</span></span>

In [<span class="number">52</span>]: shifted_lena = ndimage.<span class="function"><span class="title">shift</span><span class="params">(lena, (<span class="number">50</span>, <span class="number">50</span>)</span></span>)

In [<span class="number">53</span>]: shifted_lena2 = ndimage.<span class="function"><span class="title">shift</span><span class="params">(lena, (<span class="number">50</span>, <span class="number">50</span>)</span></span>, mode=<span class="string">'nearest'</span>)

In [<span class="number">54</span>]: rotated_lena = ndimage.<span class="function"><span class="title">rotate</span><span class="params">(lena, <span class="number">30</span>)</span></span>

In [<span class="number">55</span>]: cropped_lena = lena[<span class="number">50</span>:-<span class="number">50</span>, <span class="number">50</span>:-<span class="number">50</span>]

In [<span class="number">56</span>]: zoomed_lena = ndimage.<span class="function"><span class="title">zoom</span><span class="params">(lena, <span class="number">2</span>)</span></span>

In [<span class="number">57</span>]: zoomed_lena<span class="class">.shape</span>
Out[<span class="number">57</span>]: (<span class="number">1024</span>, <span class="number">1024</span>)

In [<span class="number">63</span>]: pl.<span class="function"><span class="title">subplot</span><span class="params">(<span class="number">321</span>)</span></span>
Out[<span class="number">63</span>]: &lt;matplotlib<span class="class">.axes</span><span class="class">.AxesSubplot</span> at <span class="number">0</span>x4c00d90&gt;

In [<span class="number">64</span>]: pl.<span class="function"><span class="title">imshow</span><span class="params">(lena, cmap=cm.gray)</span></span>
Out[<span class="number">64</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x493aad0&gt;

In [<span class="number">65</span>]: pl.<span class="function"><span class="title">subplot</span><span class="params">(<span class="number">322</span>)</span></span>
Out[<span class="number">65</span>]: &lt;matplotlib<span class="class">.axes</span><span class="class">.AxesSubplot</span> at <span class="number">0</span>x4941a10&gt;

In [<span class="number">66</span>]: #等等
</code></pre><h3 id="图像滤镜">图像滤镜</h3><pre><code>In [<span class="number">76</span>]: from scipy import misc

In [<span class="number">77</span>]: lena = misc.<span class="function"><span class="title">lena</span><span class="params">()</span></span>

In [<span class="number">78</span>]: import numpy as np

In [<span class="number">79</span>]: noisy_lena = np.<span class="function"><span class="title">copy</span><span class="params">(lena)</span></span>.<span class="function"><span class="title">astype</span><span class="params">(np.float)</span></span>

In [<span class="number">80</span>]: noisy_lena += lena.<span class="function"><span class="title">std</span><span class="params">()</span></span>*<span class="number">0.5</span>*np<span class="class">.random</span><span class="class">.standard_normal</span>(lena.shape)

In [<span class="number">81</span>]: blurred_lena = ndimage.<span class="function"><span class="title">gaussian_filter</span><span class="params">(noisy_lena, sigma=<span class="number">3</span>)</span></span>

In [<span class="number">82</span>]: median_lena = ndimage.<span class="function"><span class="title">median_filter</span><span class="params">(blurred_lena, size=<span class="number">5</span>)</span></span>

In [<span class="number">83</span>]: from scipy import signal

In [<span class="number">84</span>]: wiener_lena = signal.<span class="function"><span class="title">wiener</span><span class="params">(blurred_lena, (<span class="number">5</span>,<span class="number">5</span>)</span></span>)
</code></pre><p>许多其它<code>scipy.ndimage.filters</code>和<code>scipy.signal</code>中的滤镜可以被应用到图像中。</p>
<p><strong>练习</strong></p>
<p>比较不同滤镜图像的直方图</p>
<h3 id="数学形态学">数学形态学</h3><p>数学形态学是源于几何论的数学形态学。它具有结合结构的特点并变换几何结构。二值图(黑白图)，特别能被用该理论转换：要转换的集合是邻近的非零值像素。这个理论也被拓展到灰度图中。</p>
<p>基本的数学形态操作使用一个<em>结构元素(structuring element)</em>来改变其它几何结构。</p>
<p>让我们首先生成一个结构元素：</p>
<pre><code>In [<span class="number">129</span>]: el = ndimage.generate_binary_structure(<span class="number">2</span>, <span class="number">1</span>)

In [<span class="number">130</span>]: el
Out[<span class="number">130</span>]: 
<span class="built_in">array</span>([[False,  True, False],
       [ True,  True,  True],
       [False,  True, False]], dtype=<span class="keyword">bool</span>)

In [<span class="number">131</span>]: el.astype(np.<span class="keyword">int</span>)
Out[<span class="number">131</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]])
</code></pre><ul>
<li><p>腐蚀</p>
<pre><code>In [<span class="number">132</span>]: a = np.zeros((<span class="number">7</span>,<span class="number">7</span>), dtype=<span class="keyword">int</span>)

In [<span class="number">133</span>]: a[<span class="number">1</span>:<span class="number">6</span>, <span class="number">2</span>:<span class="number">5</span>] = <span class="number">1</span>

In [<span class="number">134</span>]: a
Out[<span class="number">134</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])

In [<span class="number">135</span>]: ndimage.binary_erosion(a).astype(a.dtype)
Out[<span class="number">135</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])

In [xxx]:<span class="preprocessor"># 腐蚀移除对象使结构更小</span>

In [<span class="number">136</span>]: ndimage.binary_erosion(a, structure=np.ones((<span class="number">5</span>,<span class="number">5</span>))).astype(a.dtype)
Out[<span class="number">136</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])
</code></pre></li>
<li><p>膨胀</p>
<pre><code>In [<span class="number">137</span>]: a = np.zeros((<span class="number">5</span>,<span class="number">5</span>))

In [<span class="number">138</span>]: a[<span class="number">2</span>, <span class="number">2</span>] = <span class="number">1</span>

In [<span class="number">139</span>]: a
Out[<span class="number">139</span>]: 
<span class="built_in">array</span>([[ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">1.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>]])

In [<span class="number">140</span>]: ndimage.binary_dilation(a).astype(a.dtype)
Out[<span class="number">140</span>]: 
<span class="built_in">array</span>([[ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">1.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">1.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">1.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],
       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>]])
</code></pre></li>
<li><p>开操作(opening)</p>
<pre><code>In [<span class="number">141</span>]: a = np.zeros((<span class="number">5</span>,<span class="number">5</span>), dtype=np.<span class="keyword">int</span>)

In [<span class="number">142</span>]: a[<span class="number">1</span>:<span class="number">4</span>, <span class="number">1</span>:<span class="number">4</span>] = <span class="number">1</span>; a[<span class="number">4</span>, <span class="number">4</span>] = <span class="number">1</span>

In [<span class="number">143</span>]: a
Out[<span class="number">143</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])

In [<span class="number">144</span>]: <span class="preprocessor"># 开操作可以移除小的对象</span>

In [<span class="number">145</span>]: ndimage.binary_opening(a, structure=np.ones((<span class="number">3</span>,<span class="number">3</span>))).astype(np.<span class="keyword">int</span>)Out[<span class="number">145</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])

In [<span class="number">146</span>]: <span class="preprocessor"># 开操作也能平滑边角</span>

In [<span class="number">147</span>]: ndimage.binary_opening(a).astype(np.<span class="keyword">int</span>)
Out[<span class="number">147</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])
</code></pre></li>
<li><p>闭操作(closing): <code>ndimage.binary_closing</code></p>
</li>
</ul>
<p><strong>练习</strong></p>
<p>查看开操作腐蚀，然后膨胀的量</p>
<p>一个开操作移除小的结构，而一个闭操作填补小的空洞。这种操作因此可被用来“清理”图像。</p>
<pre><code>In [<span class="number">149</span>]: <span class="tag">a</span> = np.<span class="function"><span class="title">zeros</span><span class="params">((<span class="number">50</span>, <span class="number">50</span>)</span></span>)

In [<span class="number">150</span>]: <span class="tag">a</span>[<span class="number">10</span>:-<span class="number">10</span>, <span class="number">10</span>:-<span class="number">10</span>] = <span class="number">1</span>

In [<span class="number">151</span>]: <span class="tag">a</span> += <span class="number">0.25</span>*np<span class="class">.random</span><span class="class">.standard_normal</span>(<span class="tag">a</span>.shape)

In [<span class="number">152</span>]: <span class="attribute">mask</span> = a&gt;=<span class="number">0.5</span>

In [<span class="number">153</span>]: opened_mask = ndimage.<span class="function"><span class="title">binary_opening</span><span class="params">(mask)</span></span>

In [<span class="number">154</span>]: closed_mask = ndimage.<span class="function"><span class="title">binary_closing</span><span class="params">(opened_mask)</span></span>
</code></pre><p><strong>练习</strong></p>
<p>验证重构区域比初始区域更小。(如果闭操作在开操作之前则相反)</p>
<p>对灰度值图像，腐蚀(或者是膨胀)相当于用被集中在所关心像素点的结构元素所覆盖像素的最小(或最大)值替代当前像素点。</p>
<pre><code>In [<span class="number">173</span>]: a = np.zeros((<span class="number">7</span>,<span class="number">7</span>), dtype=np.<span class="keyword">int</span>)

In [<span class="number">174</span>]: a[<span class="number">1</span>:<span class="number">6</span>, <span class="number">1</span>:<span class="number">6</span>] = <span class="number">3</span>

In [<span class="number">175</span>]: a[<span class="number">4</span>,<span class="number">4</span>] = <span class="number">2</span>; a[<span class="number">2</span>,<span class="number">3</span>] = <span class="number">1</span>

In [<span class="number">176</span>]: a
Out[<span class="number">176</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])

In [<span class="number">177</span>]: ndimage.grey_erosion(a, size=(<span class="number">3</span>,<span class="number">3</span>))
Out[<span class="number">177</span>]: 
<span class="built_in">array</span>([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])
</code></pre><h3 id="图像测量">图像测量</h3><p>让我们首先生成一个漂亮的合成图像：</p>
<pre><code>In [<span class="number">178</span>]: x, y = np.indices((<span class="number">100</span>, <span class="number">100</span>))

In [<span class="number">179</span>]: sig = np.<span class="built_in">sin</span>(<span class="number">2</span>*np.pi*x/<span class="number">50.</span>)*np.<span class="built_in">sin</span>(<span class="number">2</span>*np.pi*y/<span class="number">50.</span>)*(<span class="number">1</span>+x*y/<span class="number">50.</span>**<span class="number">2</span>)**<span class="number">2</span>

In [<span class="number">180</span>]: mask = sig &gt; <span class="number">1</span>
</code></pre><p>现在我们查找图像中对象的各种信息：</p>
<pre><code>In [<span class="number">181</span>]: labels, nb = ndimage.label(mask)

In [<span class="number">182</span>]: nb
Out[<span class="number">182</span>]: <span class="number">8</span>

In [<span class="number">183</span>]: areas = ndimage.sum(mask, labels, xrange(<span class="number">1</span>, labels.max()+<span class="number">1</span>))

In [<span class="number">184</span>]: areas
Out[<span class="number">184</span>]: <span class="built_in">array</span>([ <span class="number">190.</span>,   <span class="number">45.</span>,  <span class="number">424.</span>,  <span class="number">278.</span>,  <span class="number">459.</span>,  <span class="number">190.</span>,  <span class="number">549.</span>,  <span class="number">424.</span>])

In [<span class="number">185</span>]: maxima = ndimage.maximum(sig, labels, xrange(<span class="number">1</span>, labels.max()+<span class="number">1</span>))
In [<span class="number">186</span>]: maxima
Out[<span class="number">186</span>]: 
<span class="built_in">array</span>([  <span class="number">1.80238238</span>,   <span class="number">1.13527605</span>,   <span class="number">5.51954079</span>,   <span class="number">2.49611818</span>,
         <span class="number">6.71673619</span>,   <span class="number">1.80238238</span>,  <span class="number">16.76547217</span>,   <span class="number">5.51954079</span>])

In [<span class="number">187</span>]: ndimage.find_objects(labels==<span class="number">4</span>)
Out[<span class="number">187</span>]: [(slice(<span class="number">30L</span>, <span class="number">48L</span>, None), slice(<span class="number">30L</span>, <span class="number">48L</span>, None))]

In [<span class="number">188</span>]: sl = ndimage.find_objects(labels==<span class="number">4</span>)

In [<span class="number">189</span>]: import pylab as pl

In [<span class="number">190</span>]: pl.imshow(sig[sl[<span class="number">0</span>]])  
Out[<span class="number">190</span>]: &lt;matplotlib.image.AxesImage at <span class="number">0xb2fdcd0</span>&gt;
</code></pre><p>参见总结练习<a href="http://scipy-lectures.github.com/intro/summary-exercises/image-processing.html#summary-exercise-image-processing" target="_blank" rel="external">Image processing application: counting bubbles and unmolten grains</a>获取更多高级示例。</p>
<h2 id="总结练习">总结练习</h2><p>(译者：我不是很懂……)</p>
<p>总结练习主要使用Numpy，Scipy和Matplotlib。它们提供一些现实生活中用Python计算的示例。既然基本的Numpy和scipy使用已经被介绍了，欢迎有兴趣的用户尝试这些练习。</p>
<p>练习：</p>
<p><a href="http://scipy-lectures.github.com/intro/summary-exercises/stats-interpolate.html" target="_blank" rel="external">斯普罗站最大风速预测</a></p>
<p><a href="http://scipy-lectures.github.com/intro/summary-exercises/optimize-fit.html" target="_blank" rel="external">非线性最小二乘拟合：地形雷达数据的点提取</a></p>
<p><a href="http://scipy-lectures.github.com/intro/summary-exercises/image-processing.html" target="_blank" rel="external">图像处理应用：计数气泡和未融颗粒</a></p>
<p>建议的解：</p>
<p><a href="http://scipy-lectures.github.com/intro/summary-exercises/answers_image_processing.html" target="_blank" rel="external">图像处理练习解的示例:玻璃中的未融颗粒</a></p>
<h2 id="Footnotes">Footnotes</h2><p>[^4]:numpy 0.17可能会有bug</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/10/19/python/" itemprop="url">
                  优化代码(Python)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-19T00:00:00+08:00" content="2012-10-19">
              2012-10-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/10/19/python/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/10/19/python/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="优化代码">优化代码</h1><p>翻译自：<a href="http://scipy-lectures.github.com/advanced/optimizing/index.html" target="_blank" rel="external">http://scipy-lectures.github.com/advanced/optimizing/index.html</a></p>
<p>作者:Gaël Varoquaux</p>
<p>License:Creative Commons Attribution 3.0 United States License (CC-by) <a href="http://creativecommons.org/licenses/by/3.0/us" target="_blank" rel="external">http://creativecommons.org/licenses/by/3.0/us</a></p>
<blockquote>
<p>过早的优化是罪恶的根源。</p>
<p>——Donald. Knuth</p>
</blockquote>
<p>这个章节涉及使Python代码运行更快的策略。</p>
<p><strong>先决条件</strong></p>
<ul>
<li>line_profiler(<a href="http://packages.python.org/line_profiler/" target="_blank" rel="external">http://packages.python.org/line_profiler/</a>)</li>
</ul>
<p><strong>目录</strong></p>
<ul>
<li>toc<br>{: toc}</li>
</ul>
<h2 id="优化工作流">优化工作流</h2><ol>
<li>让它工作：以简单<em>清晰</em>的方式书写代码。</li>
<li>让它可靠的动作：书写自动化的测试实例，确认你的算法是正确的。如果你中止它，测试将捕捉到中断。</li>
<li>优化代码：通过剖析(profile)简单的用例来发现瓶颈，并且加速这些瓶颈，找到更好的算法或实现。记住在剖析一个现实的实例和代码的简洁与执行速度之间权衡。对于有效率的工作，最好让剖析运行约十秒。</li>
</ol>
<h2 id="剖析(profile)Python代码">剖析(profile)Python代码</h2><p><strong>非测量，不优化</strong></p>
<ul>
<li><em>测量</em>：剖析(profiling)， 计时(timing)</li>
</ul>
<h3 id="Timeit">Timeit</h3><p>在Ipython中，使用<code>timeit</code>(<a href="http://docs.python.org/library/timeit.html" target="_blank" rel="external">http://docs.python.org/library/timeit.html</a>)来计算基本运算时间。</p>
<pre><code>In [<span class="number">1</span>]: import numpy as np

In [<span class="number">2</span>]: a = np.arange(<span class="number">1000</span>)

In [<span class="number">3</span>]: %timeit a ** <span class="number">2</span>
<span class="number">100000</span> loops, best of <span class="number">3</span>: <span class="number">3.55</span> us per loop

In [<span class="number">4</span>]: %timeit a ** <span class="number">2.1</span>
<span class="number">10000</span> loops, best of <span class="number">3</span>: <span class="number">105</span> us per loop

In [<span class="number">5</span>]: %timeit a * a
<span class="number">100000</span> loops, best of <span class="number">3</span>: <span class="number">3.5</span> us per loop
</code></pre><p>使用这个指引你的策略选择。</p>
<p><strong>注意：</strong>对于长时间运行的调用，使用<code>%time</code>代替<code>%timeit</code>;虽然精确度降低但运行更快。</p>
<h3 id="分析器(Profiler)">分析器(Profiler)</h3><p>当你有个很大的程序去分析时会有用，例如以下文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mport numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> linalg</span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> fastica</span><br><span class="line"><span class="comment"># from mdp import fastica</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    data = np.random.random((<span class="number">5000</span>, <span class="number">100</span>))</span><br><span class="line">    u, s, v = linalg.svd(data)</span><br><span class="line">    pca = np.dot(u[:<span class="number">10</span>, :], data) </span><br><span class="line">    results = fastica(pca.T, whiten=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>在IPython中我们可以测量脚本运行时间：</p>
<pre><code><span class="tag">In</span> <span class="attr_selector">[6]</span>: %<span class="tag">run</span> <span class="tag">-t</span> <span class="tag">demo</span><span class="class">.py</span>

<span class="tag">IPython</span> <span class="tag">CPU</span> <span class="tag">timings</span> (<span class="tag">estimated</span>):
  <span class="tag">User</span>   :      11<span class="class">.03</span> <span class="tag">s</span>.
  <span class="tag">System</span> :       0<span class="class">.43</span> <span class="tag">s</span>.
<span class="tag">Wall</span> <span class="tag">time</span>:      13<span class="class">.12</span> <span class="tag">s</span>.
</code></pre><p>然后分析(profile)它：</p>
<pre><code>In [<span class="number">7</span>]: %run -p <span class="filename">demo.py

1169 function calls in 10.765 seconds

   Ordered by</span>: internal time

   <span class="header"><span class="keyword">ncalls</span>  <span class="keyword">tottime</span>  percall  <span class="keyword">cumtime</span>  percall <span class="keyword">filename</span>:lineno(function)</span>
        <span class="number">2</span>   <span class="number">10.693</span>    <span class="number">5.346</span>   <span class="number">10.699</span>    <span class="number">5.350</span> <span class="filename">decomp_svd.py</span>:<span class="number">14</span><span class="function">(<span class="title">svd</span>)</span>
      <span class="number">144</span>    <span class="number">0.040</span>    <span class="number">0.000</span>    <span class="number">0.040</span>    <span class="number">0.000</span> {<span class="built_in">numpy.core.multiarray.dot</span>}
        <span class="number">1</span>    <span class="number">0.015</span>    <span class="number">0.015</span>    <span class="number">0.015</span>    <span class="number">0.015</span> {<span class="built_in">method <span class="string">'random_sample'</span> of <span class="string">'mtrand.RandomState'</span> objects</span>}
       <span class="number">20</span>    <span class="number">0.005</span>    <span class="number">0.000</span>    <span class="number">0.007</span>    <span class="number">0.000</span> <span class="filename">function_base.py</span>:<span class="number">526</span><span class="function">(<span class="title">asarray_chkfinite</span>)</span>
        <span class="number">1</span>    <span class="number">0.003</span>    <span class="number">0.003</span>   <span class="number">10.764</span>   <span class="number">10.764</span> <span class="filename">demo.py</span>:<span class="number">1</span><span class="function">(&lt;<span class="title">module</span>&gt;)</span>
       <span class="number">18</span>    <span class="number">0.002</span>    <span class="number">0.000</span>    <span class="number">0.002</span>    <span class="number">0.000</span> <span class="filename">decomp.py</span>:<span class="number">197</span><span class="function">(<span class="title">eigh</span>)</span>
       <span class="number">17</span>    <span class="number">0.001</span>    <span class="number">0.000</span>    <span class="number">0.001</span>    <span class="number">0.000</span> <span class="filename">fastica_.py</span>:<span class="number">219</span><span class="function">(<span class="title">gprime</span>)</span>
       <span class="number">40</span>    <span class="number">0.001</span>    <span class="number">0.000</span>    <span class="number">0.001</span>    <span class="number">0.000</span> {<span class="built_in">method <span class="string">'any'</span> of <span class="string">'numpy.ndarray'</span> objects</span>}
       <span class="number">17</span>    <span class="number">0.001</span>    <span class="number">0.000</span>    <span class="number">0.001</span>    <span class="number">0.000</span> <span class="filename">fastica_.py</span>:<span class="number">215</span><span class="function">(<span class="title">g</span>)</span>
        <span class="number">1</span>    <span class="number">0.001</span>    <span class="number">0.001</span>    <span class="number">0.008</span>    <span class="number">0.008</span> <span class="filename">fastica_.py</span>:<span class="number">88</span><span class="function">(<span class="title">_ica_par</span>)</span>
        <span class="number">1</span>    <span class="number">0.001</span>    <span class="number">0.001</span>   <span class="number">10.764</span>   <span class="number">10.764</span> {<span class="built_in">execfile</span>}
       <span class="number">52</span>    <span class="number">0.000</span>    <span class="number">0.000</span>    <span class="number">0.001</span>    <span class="number">0.000</span> <span class="filename">twodim_base.py</span>:<span class="number">220</span><span class="function">(<span class="title">diag</span>)</span>
       <span class="number">18</span>    <span class="number">0.000</span>    <span class="number">0.000</span>    <span class="number">0.003</span>    <span class="number">0.000</span> <span class="filename">fastica_.py</span>:<span class="number">40</span><span class="function">(<span class="title">_sym_decorrelation</span>)</span>
       <span class="number">18</span>    <span class="number">0.000</span>    <span class="number">0.000</span>    <span class="number">0.000</span>    <span class="number">0.000</span> {<span class="built_in">method <span class="string">'mean'</span> of <span class="string">'numpy.ndarray'</span> objects</span>}
</code></pre><p>显然<code>svd</code>(在<em>decomp.py</em>中)是占用我们时间最多的东西，即瓶颈。我们得找到一种方法来让这一步运行更快，或者避免这一步(算法优化)。加速代码剩下的部分并无益处。</p>
<h3 id="Line-profiler">Line-profiler</h3><p>分析器(profiler)很棒：它告诉我们那个函数费时最多，但并不是它在哪里调用。</p>
<p>对此，我们使用<a href="http://packages.python.org/line_profiler/" target="_blank" rel="external">line_profiler</a>：在原文件中，我们用<code>@profile</code>修饰一些我们想要检查的函数(不用导入它)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@profile</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    data = np.random.random((<span class="number">5000</span>, <span class="number">100</span>))</span><br><span class="line">    u, s, v = linalg.svd(data)</span><br><span class="line">    pca = np.dot(u[:<span class="number">10</span>, :], data)</span><br><span class="line">    results = fastica(pca.T, whiten=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<p>然后我们使用<a href="packages.python.org/line_profiler/kernprof.py">kernprof.py</a>程序，用-l和-v：</p>
<pre><code>lyy@<span class="keyword">arch</span> ~ % kernprof.py -<span class="keyword">l</span> -v demo.py
Wrote profile results to demo.py.lprof
<span class="keyword">Timer</span> unit: 1e-06 <span class="literal">s</span>

<span class="keyword">File</span>: demo.py
Function: <span class="keyword">test</span> at <span class="keyword">line</span> 6
<span class="keyword">Total</span> time: 10.5932 <span class="literal">s</span>

<span class="keyword">Line</span> #      Hits         Time  Per Hit   % Time  <span class="keyword">Line</span> Contents
==============================================================
     6                                           @profile
     7                                           def <span class="keyword">test</span>():
     8         1        11070  11070.0      0.1          data = np.random.random((5000, 100))
     9         1     10530291 10530291.0     99.4          <span class="keyword">u</span>, s, v = linalg.svd(data)
    10         1        31026  31026.0      0.3          <span class="keyword">pca</span> = np.dot(<span class="keyword">u</span>[:10, :], data)
    11         1        20766  20766.0      0.2          results = fastica(<span class="keyword">pca</span>.T)

kernprof.py -<span class="keyword">l</span> -v demo.py  12.57s user 0.25s system 99% cpu 12.891 <span class="keyword">total</span>
</code></pre><p><em>SVD占用了大部分时间</em>。我们需要优化这行。</p>
<h2 id="让代码更快">让代码更快</h2><p>一旦我们确认了瓶颈，我们需要让相应的代码运行更快。</p>
<h3 id="算法优化">算法优化</h3><p>首先寻找算法优化：有没有运算更少或更好的方式？</p>
<p>对于更高层次地看待问题，充分理解算法后的数学很有帮助。然而，寻找简单的改变并不寻常，像<em>移动计算<a href="存疑">^1</a>和在循环外分配内存<a href="我不懂">^2</a></em>,会带来很大益处。</p>
<p>####SVD的示例</p>
<p>在以上每个例子中，SVD——<a href="http://en.wikipedia.org/wiki/Singular_value_decomposition" target="_blank" rel="external">奇异值分解</a>——是占用时间最多的。确实，当输入矩阵大小为n时算法计算代价大约是$n^3$。</p>
<p>然而，这些例子中，我们都没有使用SVD的输出，但是仅仅使用它最开始返回的参数最初很少的几行。如果我们使用scipy的<code>svd</code>实现，我们可以获得一个不完整的SVD版本。注意这个在scipy中的线性代数实现比numpy中的更加丰富，应该优先使用。</p>
<pre><code>In [<span class="number">4</span>]: %timeit np.linalg.svd(data)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">10.8</span> s per loop

In [<span class="number">5</span>]: from scipy import linalg

In [<span class="number">6</span>]: %timeit linalg.svd(data)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">10.4</span> s per loop

In [<span class="number">7</span>]: %timeit linalg.svd(data, full_matrices=False)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">278</span> ms per loop

In [<span class="number">8</span>]: %timeit np.linalg.svd(data, full_matrices=False)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">276</span> ms per loop
</code></pre><p>真正的不完全SVD，例如仅仅计算前十个特征向量，可以用arpack<a href="[Arpack——fortran数值计算库](http://en.wikipedia.org/wiki/ARPACK)">^3</a>计算，可以在<code>scipy.sparse.linalg.eigsh</code>获得。</p>
<p><strong>计算线性代数</strong></p>
<p>对于确定的算法，许多瓶颈将是线性代数计算。在本例中，使用正确的函数解决正确的问题是关键。例如，一个对称矩阵的本征值问题比一个普通矩阵更容易解决。同样的，很多时候，你可以避免反转矩阵，并且使用代价更小(并更数值稳定)的运算。</p>
<p>了解你的线性代数计算。当有疑问时，探索scipy.linalg，并且用%timeit 来对你的数据尝试不同的选择。</p>
<h2 id="写更快的数值代码">写更快的数值代码</h2><p>一个完整的关于使用numpy的讨论可以在<a href="http://scipy-lectures.github.com/advanced/advanced_numpy/index.html#advanced-numpy" target="_blank" rel="external">Advanced Numpy</a>章节中找到，或者在van der Walt等人的文章<a href="http://hal.inria.fr/inria-00564007/en" target="_blank" rel="external">The NumPy array: a structure for efficient numerical computation</a>中。这里我们仅仅讨论加速代码运行速度常见的技巧。</p>
<ul>
<li><p>向量化循环</p>
<p>找到技巧来避免使用numpy数组循环。对此，掩码(masks)数组和索引(indices)数组会更有用。</p>
</li>
<li><p>广播</p>
<p>使用<a href="http://scipy-lectures.github.com/intro/numpy/operations.html#broadcasting" target="_blank" rel="external">广播(broadcasting)</a>来在结合它们之前对数组尽可能少的运算。</p>
</li>
<li><p>在适当的位置运算</p>
<pre><code>In [<span class="number">9</span>]: a = np.zeros(<span class="number">1e7</span>)
In [<span class="number">11</span>]: %timeit global a ; a *= <span class="number">0</span>
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">29.1</span> ms per loop

in [<span class="number">12</span>]: %timeit global a ; a = <span class="number">0</span>*a
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">54.3</span> ms per loop
</code></pre><p> <strong>注意：</strong>我们需要个<code>global a</code>让timeit工作，因为它被赋给a，因此将它视作一个局部变量。</p>
</li>
<li><p>善待内存：使用视图(views)而非拷贝(copies)</p>
<p>拷贝一个大数组就像对它们进行简单的数值计算一样耗费资源</p>
<pre><code>In [<span class="number">18</span>]: a = np.zeros(<span class="number">1e7</span>)

In [<span class="number">19</span>]: %timeit a.copy()
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">69</span> ms per loop

In [<span class="number">20</span>]: %timeit a + <span class="number">1</span>
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">56.2</span> ms per loop
</code></pre></li>
<li><p>小心缓存影响(cache effects)</p>
<p>内存存取当是成组时是省资源的：以连续的方式存取一个大数组比随机存取更快。这意味着除其它事项外更小的元素间距更快(参见<a href="http://scipy-lectures.github.com/advanced/advanced_numpy/index.html#cache-effects" target="_blank" rel="external">CPU cache effects</a>)<a href="python科学计算里numpy部分讲得非常清楚，第二种间距小的明显快了很多。">^4</a></p>
<p>  In [21]: c = np.zeros((1e4, 1e4), order=’C’)</p>
<pre><code>In [<span class="number">22</span>]: %timeit c.sum(axis=<span class="number">0</span>)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">3.62</span> s per loop

In [<span class="number">23</span>]: %timeit c.sum(axis=<span class="number">1</span>)
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">171</span> ms per loop

In [<span class="number">24</span>]: c.strides
Out[<span class="number">24</span>]: (<span class="number">80000</span>, <span class="number">8</span>)

In [<span class="number">25</span>]: c = np.zeros((<span class="number">1e4</span>, <span class="number">1e4</span>), order=<span class="string">'F'</span>)

In [<span class="number">26</span>]: %timeit c.sum(axis=<span class="number">0</span>)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">166</span> ms per loop

In [<span class="number">27</span>]: %timeit c.sum(axis=<span class="number">1</span>)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">3.63</span> s per loop
</code></pre><p>这就是为何Fortran顺序或C顺序可能对运算的影响很大：</p>
<pre><code>in [<span class="number">28</span>]: a = np.random.rand(<span class="number">20</span>, <span class="number">2</span>**<span class="number">18</span>)

in [<span class="number">29</span>]: b = np.random.rand(<span class="number">20</span>, <span class="number">2</span>**<span class="number">18</span>)

in [<span class="number">30</span>]: %timeit np.dot(b, a.T)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">278</span> ms per loop

in [<span class="number">31</span>]: c = np.ascontiguousarray(a.T)

in [<span class="number">32</span>]: %timeit np.dot(b, c)
<span class="number">1</span> loops, best of <span class="number">3</span>: <span class="number">1.94</span> s per loop
</code></pre></li>
</ul>
<p>  注意拷贝数据来解决这个影响不值得：</p>
<pre><code>In [<span class="number">34</span>]: %timeit c = np.ascontiguousarray(a.T)
<span class="number">10</span> loops, best of <span class="number">3</span>: <span class="number">45.4</span> ms per loop
</code></pre><p>  使用numexpr来自动为这种效应优化会很有用。</p>
<ul>
<li><p>使用编译好的代码</p>
<p>一旦你确定所有高层次的优化都已经摸索过了，最后手段是将热点，也就是耗费时间最多的代码或函数，变成编译好的代码。对于编译代码，最优的选择是使用<a href="http://www.cython.org/" target="_blank" rel="external">Cython</a>:它很轻松地让你将已知的Python代码转换成编译好的代码，并且对numpy数组很好利用<a href="http://docs.cython.org/src/tutorial/numpy.html" target="_blank" rel="external">numpy支持</a>产生有效率的代码，例如通过循环展开(unrolling loops)。</p>
</li>
</ul>
<p><strong>Waring:</strong>对上述所有流程，分析(profile)并且计时(time)你的选择。不要以理论为依据来进行优化。<br>{: alert }</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/python/2012/10/14/scikit-learn-machine-learning-in-python/" itemprop="url">
                  Scikit Learn: 在python中机器学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-14T00:00:00+08:00" content="2012-10-14">
              2012-10-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/2012/10/14/scikit-learn-machine-learning-in-python/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="python/2012/10/14/scikit-learn-machine-learning-in-python/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Scikit_Learn:_在python中机器学习">Scikit Learn: 在python中机器学习</h1><p><div markdown="1"><br><strong><em>Warning</em></strong></div></p>
<p>警告：渣翻译，很多我自己都没看懂.但我会慢慢看慢慢修改，此文档维护中……</p>
<p><br>{:.alert .alert-danger}</p>
<p>翻译自：<a href="http://scipy-lectures.github.com/advanced/scikit-learn/index.html" target="_blank" rel="external">Scikit Learn:Machine Learning in Python</a></p>
<p>作者:    Fabian Pedregosa, Gael Varoquaux</p>
<p><strong>先决条件</strong></p>
<ul>
<li>Numpy, Scipy</li>
<li>IPython</li>
<li>matplotlib</li>
<li><a href="http://scikit-learn.org" target="_blank" rel="external">scikit-learn</a></li>
</ul>
<hr>
<p><strong>目录</strong></p>
<ul>
<li>toc<br>{: toc }</li>
</ul>
<hr>
<blockquote>
<p>警告：在0.9版中(2011年9月发行)，scikit-learn的导入路径从<code>scikits.learn</code>更改为<code>sklearn</code></p>
</blockquote>
<h2 id="载入示例数据">载入示例数据</h2><p>首先我们载入一些用来玩耍的数据。我们将使用的数据是非常简单的著名的花朵数据——安德森鸢尾花卉数据集。</p>
<p>我们有一百五十个鸢尾花的一些尺寸的观测值：萼片长度、宽度，花瓣长度和宽度。还有它们的亚属：山鸢尾（Iris setosa）、变色鸢尾（Iris versicolor）和维吉尼亚鸢尾（Iris virginica）</p>
<p>向python对象载入数据：</p>
<pre><code><span class="type">In</span> [<span class="number">1</span>]: from sklearn <span class="keyword">import</span> datasets
<span class="type">In</span> [<span class="number">2</span>]: iris = datasets.load_iris()
</code></pre><p>数据存储在<code>.data</code>项中，是一个<code>(n_samples, n_features)</code>数组。</p>
<pre><code>In [<span class="number">3</span>]: iris.data.shape
Out[<span class="number">3</span>]: (<span class="number">150</span>, <span class="number">4</span>)
</code></pre><p>每个观察对象的种类存贮在数据集的<code>.target</code>属性中。这是一个长度为<code>n_samples</code>的整数一维数组:</p>
<pre><code>In [<span class="number">5</span>]: iris.target.shape
Out[<span class="number">5</span>]: (<span class="number">150</span>,)

In [<span class="number">6</span>]: import numpy as np

In [<span class="number">7</span>]: np.unique(iris.target)
Out[<span class="number">7</span>]: <span class="built_in">array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])
</code></pre><h4 id="一个改变数据集大小的示例：数码数据集(digits_datasets)">一个改变数据集大小的示例：数码数据集(digits datasets)</h4><p>数码数据集<a href="[什么手写数字数据集](http://scikit-learn.org/0.11/auto_examples/datasets/plot_digits_last_image.html)">^1</a>包括1797个图像，每一个都是个代表手写数字的8x8像素图像</p>
<pre><code>In [<span class="number">8</span>]: digits = datasets.<span class="function"><span class="title">load_digits</span><span class="params">()</span></span>

In [<span class="number">9</span>]: digits<span class="class">.images</span><span class="class">.shape</span>
Out[<span class="number">9</span>]: (<span class="number">1797</span>, <span class="number">8</span>, <span class="number">8</span>)

In [<span class="number">10</span>]: import pylab as pl

In [<span class="number">11</span>]: pl.<span class="function"><span class="title">imshow</span><span class="params">(digits.images[<span class="number">0</span>], cmap=pl.cm.gray_r)</span></span> 
Out[<span class="number">11</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x3285b90&gt;

In [<span class="number">13</span>]: pl.<span class="function"><span class="title">show</span><span class="params">()</span></span>
</code></pre><p>为了在scikit中使用这个数据集，我们把每个8x8图像转换成长度为64的矢量。(译者注：或者直接用<code>digits.data</code>)</p>
<pre><code><span class="type">In</span> [<span class="number">12</span>]: <span class="type">data</span> = <span class="built_in">digits</span>.images.<span class="built_in">reshape</span>((<span class="built_in">digits</span>.images.<span class="built_in">shape</span>[<span class="number">0</span>], -<span class="number">1</span>))
</code></pre><h3 id="学习和预测">学习和预测</h3><p>现在我们已经获得一些数据，我们想要从中学习和预测一个新的数据。在<code>scikit-learn</code>中，我们通过创建一个<code>估计器(estimator)</code>从已经存在的数据学习，并且调用它的<code>fit(X,Y)</code>方法。</p>
<pre><code><span class="keyword">In</span> [<span class="number">14</span>]: from sklearn import svm

<span class="keyword">In</span> [<span class="number">15</span>]: clf = svm.LinearSVC()

<span class="keyword">In</span> [<span class="number">16</span>]: clf.fit(iris.data, iris.target) # learn from the data 
<span class="keyword">Out</span>[<span class="number">16</span>]: 
LinearSVC(<span class="keyword">C</span>=<span class="number">1.0</span>, class_weight=<span class="keyword">None</span>, dual=<span class="keyword">True</span>, fit_intercept=<span class="keyword">True</span>,
     intercept_scaling=<span class="number">1</span>, loss=<span class="string">'l2'</span>, multi_class=<span class="string">'ovr'</span>, penalty=<span class="string">'l2'</span>,
     tol=<span class="number">0.0001</span>, verbose=<span class="number">0</span>)
</code></pre><p>一旦我们已经从数据学习，我们可以使用我们的模型来预测未观测数据最可能的结果。</p>
<pre><code>In [<span class="number">17</span>]: clf.predict([[ <span class="number">5.0</span>,  <span class="number">3.6</span>,  <span class="number">1.3</span>,  <span class="number">0.25</span>]])
Out[<span class="number">17</span>]: <span class="built_in">array</span>([<span class="number">0</span>], dtype=int32)
</code></pre><p><strong>注意：</strong>我们可以通过它以下划线结束的属性存取模型的参数：</p>
<pre><code>In [<span class="number">18</span>]: clf.coef_  
Out[<span class="number">18</span>]: 
<span class="built_in">array</span>([[ <span class="number">0.18424352</span>,  <span class="number">0.45122644</span>, -<span class="number">0.8079467</span> , -<span class="number">0.45071302</span>],
       [ <span class="number">0.05190619</span>, -<span class="number">0.89423619</span>,  <span class="number">0.40519245</span>, -<span class="number">0.93781587</span>],
       [-<span class="number">0.85087844</span>, -<span class="number">0.98667529</span>,  <span class="number">1.38088883</span>,  <span class="number">1.86538111</span>]])
</code></pre><h2 id="分类">分类</h2><h3 id="K最近邻(KNN)分类器">K最近邻(KNN)分类器</h3><p>最简单的可能的分类器是最近邻：给定一个新的观测值，将n维空间中最靠近它的训练样本标签给它。其中n是每个样本中特性(features)数。</p>
<p>k最近邻<a href="[KNN分类算法](http://en.wikipedia.org/wiki/K-nearest_neighbor_algorithm)">^2</a>分类器内部使用基于球树(ball tree)[^3]来代表它训练的样本。</p>
<p><strong>KNN分类示例</strong>：</p>
<pre><code>In [19]: # <span class="operator"><span class="keyword">Create</span> <span class="keyword">and</span> fit a nearest-neighbor classifier

<span class="keyword">In</span> [<span class="number">20</span>]: <span class="keyword">from</span> sklearn <span class="keyword">import</span> neighbors

<span class="keyword">In</span> [<span class="number">21</span>]: knn = neighbors.KNeighborsClassifier()

<span class="keyword">In</span> [<span class="number">22</span>]: knn.fit(iris.<span class="keyword">data</span>, iris.target) 
<span class="keyword">Out</span>[<span class="number">22</span>]: 
KNeighborsClassifier(algorithm=<span class="string">'auto'</span>, leaf_size=<span class="number">30</span>, n_neighbors=<span class="number">5</span>, <span class="keyword">p</span>=<span class="number">2</span>,
           warn_on_equidistant=<span class="literal">True</span>, weights=<span class="string">'uniform'</span>)

<span class="keyword">In</span> [<span class="number">23</span>]: knn.predict([[<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, <span class="number">0.4</span>]])
<span class="keyword">Out</span>[<span class="number">23</span>]: <span class="built_in">array</span>([<span class="number">0</span>])</span>
</code></pre><h4 id="训练集和测试集">训练集和测试集</h4><p>当验证学习算法时，不要用一个用来拟合估计器的数据来验证估计器的预测非常重要。确实，通过kNN估计器，我们将总是获得关于训练集完美的预测。</p>
<pre><code>In [<span class="number">24</span>]: perm = np<span class="class">.random</span><span class="class">.permutation</span>(iris<span class="class">.target</span><span class="class">.size</span>)

In [<span class="number">25</span>]: iris<span class="class">.data</span> = iris<span class="class">.data</span>[perm]

In [<span class="number">26</span>]: iris<span class="class">.target</span> = iris<span class="class">.target</span>[perm]

In [<span class="number">27</span>]: knn.<span class="function"><span class="title">fit</span><span class="params">(iris.data[:<span class="number">100</span>], iris.target[:<span class="number">100</span>])</span></span> 
Out[<span class="number">27</span>]: 
KNeighborsClassifier(algorithm=<span class="string">'auto'</span>, leaf_size=<span class="number">30</span>, n_neighbors=<span class="number">5</span>, p=<span class="number">2</span>,
           warn_on_equidistant=True, weights=<span class="string">'uniform'</span>)

In [<span class="number">28</span>]: knn.<span class="function"><span class="title">score</span><span class="params">(iris.data[<span class="number">100</span>:], iris.target[<span class="number">100</span>:])</span></span> 
/usr/lib/python2.<span class="number">7</span>/site-packages/sklearn/neighbors/classification<span class="class">.py</span>:<span class="number">129</span>: NeighborsWarning: kneighbors: neighbor k+<span class="number">1</span> and neighbor k have the same distance: results will be dependent on data <span class="attribute">order</span>.
  neigh_dist, neigh_ind = self.<span class="function"><span class="title">kneighbors</span><span class="params">(X)</span></span>
Out[<span class="number">28</span>]: <span class="number">0.95999999999999996</span>
</code></pre><p>Bonus的问题：为什么我们使用随机的排列？</p>
<h3 id="分类支持向量机(SVMs)">分类支持向量机(SVMs)</h3><h4 id="线性支持向量机">线性支持向量机</h4><p>SVMs<a href="[支持向量机](http://zh.wikipedia.org/wiki/%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA)">^4</a>尝试构建一个两个类别的最大间隔超平面。它选择输入的子集，调用支持向量即离分离的超平面最近的样本点。</p>
<pre><code><span class="keyword">In</span> [<span class="number">60</span>]: from sklearn import svm

<span class="keyword">In</span> [<span class="number">61</span>]: svc = svm.SVC(kernel=<span class="string">'linear'</span>)

<span class="keyword">In</span> [<span class="number">62</span>]: svc.fit(iris.data, iris.target)
<span class="keyword">Out</span>[<span class="number">62</span>]: 
SVC(<span class="keyword">C</span>=<span class="number">1.0</span>, cache_size=<span class="number">200</span>, class_weight=<span class="keyword">None</span>, coef0=<span class="number">0.0</span>, degree=<span class="number">3</span>, gamma=<span class="number">0.0</span>,
  kernel=<span class="string">'linear'</span>, probability=<span class="keyword">False</span>, shrinking=<span class="keyword">True</span>, tol=<span class="number">0.001</span>,
  verbose=<span class="keyword">False</span>)
</code></pre><p><code>scikit-learn</code>中有好几种支持向量机实现。最普遍使用的是<code>svm.SVC</code>，<code>svm.NuSVC</code>和<code>svm.LinearSVC</code>;“SVC”代表支持向量分类器(Support Vector Classifier)(也存在回归SVMs，在<code>scikit-learn</code>中叫作“SVR”)。</p>
<p><strong>练习</strong></p>
<p>训练一个数字数据集的<code>svm.SVC</code>。省略最后10%并且检验观测值的预测表现。</p>
<h4 id="使用核">使用核</h4><p>类别不总是可以用超平面分离，所以人们指望有些可能是多项式或指数实例的非线性决策函数：</p>
<ul>
<li><p>线性核</p>
<pre><code>svc = svm.<span class="function"><span class="title">SVC</span><span class="params">(kernel=<span class="string">'linear'</span>)</span></span>
</code></pre></li>
<li><p>多项式核</p>
<pre><code>svc = svm.SVC(kernel=<span class="string">'poly'</span>,
...               <span class="built_in">degree</span>=<span class="number">3</span>)
<span class="preprocessor"># degree: polynomial degree</span>
</code></pre></li>
<li><p>RBF核(径向基函数)<a href="[径向基函数](http://en.wikipedia.org/wiki/Radial_basis_function)">^5</a></p>
<pre><code>svc = svm.SVC(kernel=<span class="string">'rbf'</span>)
<span class="preprocessor"># gamma: inverse of size of</span>
<span class="preprocessor"># radial kernel</span>
</code></pre></li>
</ul>
<p><strong>练习</strong></p>
<p>以上提到的哪些核对数字数据集有更好的预测性能？(译者：前两个)</p>
<h2 id="聚类：将观测值聚合">聚类：将观测值聚合</h2><p>给定鸢尾花数据集，如果我们知道这有三种鸢尾花，但是无法得到它们的标签，我们可以尝试<em>非监督学习</em>：我们可以通过某些标准<em>聚类</em>观测值到几个组别里。</p>
<h3 id="k均值聚类">k均值聚类</h3><p>最简答的聚类算法是k均值算法。这将一个数据分成k个集群，以最小化观测值(n维空间中)到聚类中心的均值来分配每个观测点到集群;然后均值重新被计算。这个操作递归运行直到聚类收敛，在<code>max_iter</code>回合内到最大值。<a href="[看看wikipedia吧](http://en.wikipedia.org/wiki/K-means_clustering)">^7</a></p>
<p>(一个替代的k均值算法实现在scipy中的<code>cluster</code>包中。这个<code>scikit-learn</code>实现与之不同，通过提供对象API和几个额外的特性，包括智能初始化。)</p>
<pre><code>In [<span class="number">82</span>]: from sklearn import cluster, datasets

In [<span class="number">83</span>]: iris = datasets.<span class="function"><span class="title">load_iris</span><span class="params">()</span></span>

In [<span class="number">84</span>]: k_means = cluster.<span class="function"><span class="title">KMeans</span><span class="params">(k=<span class="number">3</span>)</span></span>

In [<span class="number">85</span>]: k_means.<span class="function"><span class="title">fit</span><span class="params">(iris.data)</span></span> 
Out[<span class="number">85</span>]: 
KMeans(copy_x=True, init=<span class="string">'k-means++'</span>, k=<span class="number">3</span>, max_iter=<span class="number">300</span>, n_init=<span class="number">10</span>, n_jobs=<span class="number">1</span>,
    precompute_distances=True,
    random_state=&lt;mtrand<span class="class">.RandomState</span> <span class="tag">object</span> at <span class="number">0</span>x7f4d860642d0&gt;, tol=<span class="number">0.0001</span>,
    verbose=<span class="number">0</span>)

In [<span class="number">86</span>]: print k_means<span class="class">.labels_</span>[::<span class="number">10</span>]
[<span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]

In [<span class="number">87</span>]: print iris<span class="class">.target</span>[::<span class="number">10</span>]
[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]
</code></pre><h4 id="应用到图像压缩">应用到图像压缩</h4><p>译者注：Lena是经典的图像处理实例图像, 8位灰度色深, 尺寸512 x 512</p>
<p>聚类可以被看作是一种从信息中选择一小部分观测值。例如，这个可以被用来海报化一个图像(将连续变化的色调转换成更少几个色调)：</p>
<pre><code><span class="keyword">In</span> [<span class="number">95</span>]: <span class="keyword">from</span> scipy import misc

<span class="keyword">In</span> [<span class="number">96</span>]: lena = misc.lena().astype(np.float32)

<span class="keyword">In</span> [<span class="number">97</span>]: X = lena.reshape((-<span class="number">1</span>, <span class="number">1</span>)) # We need an (n_sample, n_feature) <span class="keyword">array</span>

<span class="keyword">In</span> [<span class="number">98</span>]: k_means = cluster.KMeans(<span class="number">5</span>)

<span class="keyword">In</span> [<span class="number">99</span>]: k_means.fit(X)
<span class="keyword">Out</span>[<span class="number">99</span>]: 
KMeans(copy_x=<span class="keyword">True</span>, init=<span class="string">'k-means++'</span>, k=<span class="number">5</span>, max_iter=<span class="number">300</span>, n_init=<span class="number">10</span>, n_jobs=<span class="number">1</span>,
    precompute_distances=<span class="keyword">True</span>,
    random_state=&lt;mtrand.RandomState object at <span class="number">0</span>x7f4d860642d0&gt;, tol=<span class="number">0.0001</span>,
    verbose=<span class="number">0</span>)

<span class="keyword">In</span> [<span class="number">100</span>]: values = k_means.cluster_centers_.squeeze()

<span class="keyword">In</span> [<span class="number">101</span>]: labels = k_means.labels_

<span class="keyword">In</span> [<span class="number">102</span>]: lena_compressed = np.choose(labels, values)

<span class="keyword">In</span> [<span class="number">103</span>]: lena_compressed.shape = lena.shape
</code></pre><p>译者注：想看效果？</p>
<pre><code>In [<span class="number">31</span>]: import matplotlib<span class="class">.pyplot</span> as plt

In [<span class="number">32</span>]: plt.<span class="function"><span class="title">gray</span><span class="params">()</span></span>

In [<span class="number">33</span>]: plt.<span class="function"><span class="title">imshow</span><span class="params">(lena_compressed)</span></span>
Out[<span class="number">33</span>]: &lt;matplotlib<span class="class">.image</span><span class="class">.AxesImage</span> at <span class="number">0</span>x4b2c510&gt;

In [<span class="number">34</span>]: plt.<span class="function"><span class="title">show</span><span class="params">()</span></span>
</code></pre><p>原图类似。</p>
<p>![Image]</p>
<h2 id="用主成分分析降维">用主成分分析降维</h2><p>以上根据观测值标记的点云在一个方向非常平坦，所以一个特性几乎可以用其它两个确切地计算。PCA发现哪个方向的数据不是平的并且它可以通过在一个子空间投影来降维。</p>
<p><strong>警告：</strong>PCA将在模块<code>decomposition</code>或<code>pca</code>中，这取决于你scikit-learn的版本。</p>
<pre><code><span class="keyword">In</span> [75]: from sklearn import decomposition

<span class="keyword">In</span> [76]: <span class="keyword">pca</span> = decomposition.<span class="keyword">PCA</span>(n_components=2)

<span class="keyword">In</span> [77]: <span class="keyword">pca</span>.<span class="keyword">fit</span>(iris.data)
<span class="keyword">Out</span>[77]: <span class="keyword">PCA</span>(<span class="keyword">copy</span>=True, n_components=2, whiten=False)

<span class="keyword">In</span> [78]: X = <span class="keyword">pca</span>.transform(iris.data)
</code></pre><p>现在我们可以可视化(降维过的)鸢尾花数据集：</p>
<pre><code><span class="keyword">In</span> [79]: import pylab <span class="keyword">as</span> <span class="keyword">pl</span>

<span class="keyword">In</span> [80]: <span class="keyword">pl</span>.<span class="keyword">scatter</span>(X[:, 0], X[:, 1], c=iris.target)
<span class="keyword">Out</span>[80]: &lt;matplotlib.collections.PathCollection at 0x4104310&gt;
</code></pre><p>PCA不仅在可视化高维数据集时非常有用。它可以用来作为帮助加速对高维数据不那么有效率的监督方法<a href="[监督学习](http://en.wikipedia.org/wiki/Supervised_learning)">^6</a>的预处理步骤。</p>
<h2 id="将一切放在一起：人脸识别">将一切放在一起：人脸识别</h2><p>一个实例使用主成分分析来降维和支持向量机来分类进行人脸识别。</p>
<p>译者注：让程序自动下载(确保联网，文件较大，要等待很久)或者手动下载<a href="http://vis-www.cs.umass.edu/lfw/lfw-funneled.tgz" target="_blank" rel="external">数据</a>并放到<code>./scikit_learn_data/lfw_home/</code>下。</p>
<pre><code><span class="string">""</span>"
Stripped-down <span class="keyword">version</span> of the face recognition example <span class="keyword">by</span> Olivier Grisel

http:<span class="comment">//scikit-learn.org/dev/auto_examples/applications/face_recognition.html</span>

## original shape of images: 50, 37
<span class="string">""</span>"
import numpy <span class="keyword">as</span> np
import pylab <span class="keyword">as</span> <span class="keyword">pl</span>
from sklearn import cross_validation, datasets, decomposition, svm

# ..
# .. load data ..
lfw_people = datasets.fetch_lfw_people(min_faces_per_person=70, resize=0.4)
perm = np.random.permutation(lfw_people.target.size)
lfw_people.data = lfw_people.data[perm]
lfw_people.target = lfw_people.target[perm]
faces = np.<span class="keyword">reshape</span>(lfw_people.data, (lfw_people.target.shape[0], -1))
train, <span class="keyword">test</span> = iter(cross_validation.StratifiedKFold(lfw_people.target, k=4)).next()
X_train, X_test = faces[train], faces[<span class="keyword">test</span>]
y_train, y_test = lfw_people.target[train], lfw_people.target[<span class="keyword">test</span>]

# ..
# .. dimension reduction ..
<span class="keyword">pca</span> = decomposition.RandomizedPCA(n_components=150, whiten=True)
<span class="keyword">pca</span>.<span class="keyword">fit</span>(X_train)
X_train_pca = <span class="keyword">pca</span>.transform(X_train)
X_test_pca = <span class="keyword">pca</span>.transform(X_test)

# ..
# .. classification ..
clf = svm.SVC(C=5., <span class="keyword">gamma</span>=0.001)
clf.<span class="keyword">fit</span>(X_train_pca, y_train)

# ..
# .. <span class="keyword">predict</span> <span class="keyword">on</span> new images ..
<span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(10):
    <span class="keyword">print</span> lfw_people.target_names[clf.<span class="keyword">predict</span>(X_test_pca[i])[0]]
    _ = <span class="keyword">pl</span>.imshow(X_test[i].<span class="keyword">reshape</span>(50, 37), cmap=<span class="keyword">pl</span>.cm.gray)
    _ = raw_input()
</code></pre><p>全部代码：<a href="http://scipy-lectures.github.com/_downloads/faces.py" target="_blank" rel="external">face.py</a></p>
<h2 id="线性模型：从回归到稀疏">线性模型：从回归到稀疏</h2><p><strong>糖尿病数据集</strong></p>
<p>糖尿病数据集包含442个病人的测量而得的10项生理指标(年龄，性别，体重，血压)，和一年后疾病进展的指示：</p>
<pre><code><span class="name">In</span> [<span class="number">104</span>]: <span class="atom">diabetes</span> = <span class="atom">datasets</span>.<span class="atom">load_diabetes</span>()

<span class="name">In</span> [<span class="number">105</span>]: <span class="atom">diabetes_X_train</span> = <span class="atom">diabetes</span>.<span class="atom">data</span>[:-<span class="number">20</span>]

<span class="name">In</span> [<span class="number">106</span>]: <span class="atom">diabetes_X_test</span>  = <span class="atom">diabetes</span>.<span class="atom">data</span>[-<span class="number">20</span>:]

<span class="name">In</span> [<span class="number">107</span>]: <span class="atom">diabetes_y_train</span> = <span class="atom">diabetes</span>.<span class="atom">target</span>[:-<span class="number">20</span>]

<span class="name">In</span> [<span class="number">108</span>]: <span class="atom">diabetes_y_test</span>  = <span class="atom">diabetes</span>.<span class="atom">target</span>[-<span class="number">20</span>:]
</code></pre><p>这个手头的任务是用来从生理指标预测疾病。</p>
<h3 id="稀疏模型">稀疏模型</h3><p>为了改善问题的条件(无信息变量，减少维度的不利影响，作为一个特性(feature)选择的预处理，等等)，我们只关注有信息的特性将没有信息的特性设置为0.这个罚则函数法[^8],叫作<em>套索(Lasso)</em>[^9]，可以将一些系数设置为0.这些方法叫作<em>稀疏方法(sparse method)</em>，稀疏化可以被视作奥卡姆剃刀：相对于复杂模型更倾向于简单的。</p>
<pre><code><span class="keyword">In</span> [<span class="number">109</span>]: <span class="keyword">from</span> sklearn import linear_model

<span class="keyword">In</span> [<span class="number">110</span>]: regr = linear_model.Lasso(alpha=.<span class="number">3</span>)

<span class="keyword">In</span> [<span class="number">111</span>]: regr.fit(diabetes_X_train, diabetes_y_train)
<span class="keyword">Out</span>[<span class="number">111</span>]: 
Lasso(alpha=<span class="number">0.3</span>, copy_X=<span class="keyword">True</span>, fit_intercept=<span class="keyword">True</span>, max_iter=<span class="number">1000</span>,
   normalize=<span class="keyword">False</span>, positive=<span class="keyword">False</span>, precompute=<span class="string">'auto'</span>, tol=<span class="number">0.0001</span>,
   warm_start=<span class="keyword">False</span>)

<span class="keyword">In</span> [<span class="number">112</span>]: regr.coef_ # very sparse coefficients
<span class="keyword">Out</span>[<span class="number">112</span>]: 
<span class="keyword">array</span>([   <span class="number">0</span>.        ,   -<span class="number">0</span>.        ,  <span class="number">497.34075682</span>,  <span class="number">199.17441034</span>,
         -<span class="number">0</span>.        ,   -<span class="number">0</span>.        , -<span class="number">118.89291545</span>,    <span class="number">0</span>.        ,
        <span class="number">430.9379595</span> ,    <span class="number">0</span>.        ])

<span class="keyword">In</span> [<span class="number">113</span>]: regr.score(diabetes_X_test, diabetes_y_test) 
<span class="keyword">Out</span>[<span class="number">113</span>]: <span class="number">0.55108354530029791</span>
</code></pre><p>这个分数和线性回归(最小二乘法)非常相似：</p>
<pre><code>In [<span class="number">114</span>]: lin = linear_model.<span class="function"><span class="title">LinearRegression</span><span class="params">()</span></span>

In [<span class="number">115</span>]: lin.<span class="function"><span class="title">fit</span><span class="params">(diabetes_X_train, diabetes_y_train)</span></span> 
Out[<span class="number">115</span>]: <span class="function"><span class="title">LinearRegression</span><span class="params">(copy_X=True, fit_intercept=True, normalize=False)</span></span>

In [<span class="number">116</span>]: lin.<span class="function"><span class="title">score</span><span class="params">(diabetes_X_test, diabetes_y_test)</span></span> 
Out[<span class="number">116</span>]: <span class="number">0.58507530226905713</span>
</code></pre><h4 id="同一问题的不同算法">同一问题的不同算法</h4><p>同一数学问题可以用不同算法解决。例如,sklearn中的<em>Lasso</em>对象使用坐标下降(coordinate descent)方法[^10]解决套索回归，这在大数据集时非常有效率。然而，sklearn也提供了<em>LassoLARS</em>对象，使用LARS这种在解决权重向量估计非常稀疏，观测值很少的问题很有效率的方法。</p>
<h2 id="模型选择：选择估计器和它们的参数">模型选择：选择估计器和它们的参数</h2><h3 id="格点搜索和交叉验证估计器">格点搜索和交叉验证估计器</h3><h4 id="格点搜索">格点搜索</h4><p>scikit-learn提供了一个对象，该对象给定数据，在拟合一个参数网格的估计器时计算分数，并且选择参数最大化交叉验证分数。这个对象在构建时采用一个估计器并且暴露一个估计器API：</p>
<pre><code><span class="type">In</span> [<span class="number">117</span>]: from sklearn <span class="keyword">import</span> svm, grid_search

<span class="type">In</span> [<span class="number">118</span>]: gammas = np.logspace(-<span class="number">6</span>, -<span class="number">1</span>, <span class="number">10</span>)

<span class="type">In</span> [<span class="number">119</span>]: svc = svm.SVC()

<span class="type">In</span> [<span class="number">120</span>]: clf = grid_search.GridSearchCV(estimator=svc, param_grid=dict(<span class="built_in">gamma</span>=gammas),n_jobs=-<span class="number">1</span>)

<span class="type">In</span> [<span class="number">121</span>]: clf.fit(<span class="built_in">digits</span>.<span class="type">data</span>[:<span class="number">1000</span>], <span class="built_in">digits</span>.<span class="type">target</span>[:<span class="number">1000</span>]) 
<span class="type">Out</span>[<span class="number">121</span>]: 
GridSearchCV(cv=<span class="type">None</span>,
       estimator=SVC(C=<span class="number">1.0</span>, cache_size=<span class="number">200</span>, class_weight=<span class="type">None</span>, coef0=<span class="number">0.0</span>, degree=<span class="number">3</span>, <span class="built_in">gamma</span>=<span class="number">0.0</span>,
  kernel=<span class="string">'rbf'</span>, probability=False, shrinking=True, tol=<span class="number">0.001</span>,
  verbose=False),
       fit_params={}, iid=True, loss_func=<span class="type">None</span>, n_jobs=-<span class="number">1</span>,
       param_grid={<span class="string">'gamma'</span>: array([  <span class="number">1.00000e-06</span>,   <span class="number">3.59381e-06</span>,   <span class="number">1.29155e-05</span>,   <span class="number">4.64159e-05</span>,
         <span class="number">1.66810e-04</span>,   <span class="number">5.99484e-04</span>,   <span class="number">2.15443e-03</span>,   <span class="number">7.74264e-03</span>,
         <span class="number">2.78256e-02</span>,   <span class="number">1.00000e-01</span>])},
       pre_dispatch=<span class="string">'2*n_jobs'</span>, refit=True, score_func=<span class="type">None</span>, verbose=<span class="number">0</span>)

<span class="type">In</span> [<span class="number">122</span>]: clf.best_score
/usr/lib/python2<span class="number">.7</span>/site-packages/sklearn/utils/__init__.py:<span class="number">79</span>: DeprecationWarning: <span class="function"><span class="keyword">Function</span></span> best_score is deprecated; GridSearchCV.best_score is deprecated and will be removed <span class="type">in</span> version <span class="number">0.12.</span> Please <span class="keyword">use</span> ``GridSearchCV.best_score_`` instead.
  warnings.warn(msg, category=DeprecationWarning)
<span class="type">Out</span>[<span class="number">122</span>]: <span class="number">0.98600097103091122</span>

<span class="type">In</span> [<span class="number">123</span>]: clf.best_estimator.<span class="built_in">gamma</span>
/usr/lib/python2<span class="number">.7</span>/site-packages/sklearn/utils/__init__.py:<span class="number">79</span>: DeprecationWarning: <span class="function"><span class="keyword">Function</span></span> best_estimator is deprecated; GridSearchCV.best_estimator is deprecated and will be removed <span class="type">in</span> version <span class="number">0.12.</span> Please <span class="keyword">use</span> ``GridSearchCV.best_estimator_`` instead.
  warnings.warn(msg, category=DeprecationWarning)
<span class="type">Out</span>[<span class="number">123</span>]: <span class="number">0.0021544346900318843</span>
</code></pre><p>默认<code>GridSearchCV</code>使用三次(3-fold)交叉验证。然而，如果它探测到一个分类器被传递，而不是一个回归量，它使用分层的3次。</p>
<h4 id="交叉验证估计器">交叉验证估计器</h4><p>交叉验证在一个algorithm by algorithm基础上可以更有效地设定参数。这就是为何，对给定的估计器，scikit-learn使用“CV”估计器，通过交叉验证自动设定参数。</p>
<pre><code><span class="keyword">In</span> [<span class="number">125</span>]: <span class="keyword">from</span> sklearn import linear_model, datasets

<span class="keyword">In</span> [<span class="number">126</span>]: lasso = linear_model.LassoCV()

<span class="keyword">In</span> [<span class="number">127</span>]: diabetes = datasets.load_diabetes()

<span class="keyword">In</span> [<span class="number">128</span>]: X_diabetes = diabetes.data

<span class="keyword">In</span> [<span class="number">129</span>]: y_diabetes = diabetes.target

<span class="keyword">In</span> [<span class="number">130</span>]: lasso.fit(X_diabetes, y_diabetes)
<span class="keyword">Out</span>[<span class="number">130</span>]: 
LassoCV(alphas=<span class="keyword">array</span>([ <span class="number">2.14804</span>,  <span class="number">2.00327</span>, ...,  <span class="number">0.0023</span> ,  <span class="number">0.00215</span>]),
    copy_X=<span class="keyword">True</span>, cv=None, eps=<span class="number">0.001</span>, fit_intercept=<span class="keyword">True</span>, max_iter=<span class="number">1000</span>,
    n_alphas=<span class="number">100</span>, normalize=<span class="keyword">False</span>, precompute=<span class="string">'auto'</span>, tol=<span class="number">0.0001</span>,
    verbose=<span class="keyword">False</span>)

<span class="keyword">In</span> [<span class="number">131</span>]: # The estimator chose automatically its lambda:

<span class="keyword">In</span> [<span class="number">132</span>]: lasso.alpha 
<span class="keyword">Out</span>[<span class="number">132</span>]: <span class="number">0.013180196198701137</span>
</code></pre><p>这些估计器是相似的，以‘CV’为它们名字的后缀。</p>
<p><strong>练习</strong></p>
<p>对糖尿病数据集，找到最优的正则化参数alpha。(0.016249161908773888)</p>
<hr>
<h2 id="Footnotes">Footnotes</h2><p>[^3]:<a href="http://en.wikipedia.org/wiki/Ball_tree" target="_blank" rel="external">Ball tree数据结构</a></p>
<p>[^8]:<a href="http://en.wikipedia.org/wiki/Penalty_method" target="_blank" rel="external">Penalty methods</a><br>[^9]:<a href="http://en.wikipedia.org/wiki/Least_squares#LASSO_method" target="_blank" rel="external">LASSO method</a><br>[^10]:<a href="http://en.wikipedia.org/wiki/Coordinate_descent" target="_blank" rel="external">Coordinate descent</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2012/10/14/always-look-on-the-bright-side-of-life/" itemprop="url">
                  Always Look on the Bright Side of life
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-10-14T00:00:00+08:00" content="2012-10-14">
              2012-10-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2012/10/14/always-look-on-the-bright-side-of-life/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2012/10/14/always-look-on-the-bright-side-of-life/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>blahblahblah,这几天看了三部电影，随便感慨下。</p>
<h2 id="Always_Look_on_the_Bright_Side_of_life">Always Look on the Bright Side of life</h2><p>也许执念太深，从一年前开始看到无所事事的人就极度不爽，也无法忍受自己浪费一分一秒，然而事情总是这样：你越想抓住什么，什么就越从你的指缝间溜走得越快。</p>
<p>一年来总是给自己一些莫名奇妙的压力，天天为各种各样的琐事烦得一塌糊涂。结果身体一直也不好，要不要感冒每个月就像大姨妈一样来一次？[^1]有很多人和事，只觉得他们二逼，然而搅扰的自己也无法静下心。也许只是我自己太在意。</p>
<p>我想黑我们学校，黑自己专业，黑这学校很多人很久了。然而最终还是忍住，也许世界就该这样，或者你爱怎样就怎样。没必要因此搅扰得自己不安。</p>
<p>也许我就该笑笑，依旧回头走我的路，如果路被人堵上，换另一条继续走，条条大路通罗马。</p>
<p>也许我就该放下许多执念，在心灵上解放自我，在行动上自我解放。</p>
<p>也许我就该随波逐流，无所谓得失，让该来的来，让该去的去，万事随缘。</p>
<p>每天入夜，当我怨恨时，我不断暗示自己，神赐你一颗平和的心，不要怨恨。</p>
<p>当我为周围的风吹草动胆颤心惊时，不断鼓舞自己，神赐给你的是一个刚强的心，无所畏惧。</p>
<p>让心平和下来吧，</p>
<p>一直想考研，跨掉自己的专业，离开熟悉的学校，寻找更好的环境和人<a href="希望不要误解，对每个人好坏都是不同的，我不想黑任何人。">^2</a>。</p>
<p>但没必要逼自己，让心平和下来吧</p>
<p>好好锻炼身体，考不上明年再来。</p>
<p>再考不上再做打算。</p>
<p>留得青山在，不怕没柴烧。</p>
<p>总是看见生活光明的一面。</p>
<embed src="http://www.xiami.com/widget/0_2018536/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent">


<blockquote>
<p>some things in life are bad,生命中总有些不如意</p>
<p>they can really make you mad, 它们真的能让你抓狂</p>
<p>other things just make you swear and curse.还有些使你诅咒和咒骂</p>
<p>when you’re chewing on life’s gristle 当你咀嚼生活的乏味</p>
<p>don’t grumble, give a whistle. 别抱怨 ,吹个口哨</p>
<p>and this’ll help things turn out for the best.这能帮事情变好 </p>
<p>and…. 还有</p>
<p>always look on the bright side of life,(whistle) 总是看到好的一面</p>
<p>always look on the bright side of life,(whistle) 总是看到好的一面</p>
<p>if life seems jolly rotten, 如果生活看起来非常糟糕</p>
<p>there’s something you’ve forgotten, 肯定有什么事你忘了</p>
<p>and that’s to laugh and smile and dance and sing.那些关于高兴、微笑、舞蹈和歌唱的事情 </p>
<p>when you’re feeling in the dumps,当你觉得一团糟 </p>
<p>don’t be silly chumps. 别象个榆木疙瘩</p>
<p>just purse your lips and whistle, that’s the thing.缩起你的嘴，吹个口哨，就这样</p>
<p>and… 还有</p>
<p>always look on the bright side of life.(whistle) 总是看到好的一面</p>
<p>come on… 来吧</p>
<p>always look on the bright side of life…总是看到好的一面 </p>
<p>for life is quite absurd, 因为生活如此荒诞</p>
<p>and death’s the final word, 死亡是最终的结局</p>
<p>you must always face the curtain with a bow. 你总得鞠躬谢幕</p>
<p>forget about your sin, 忘了你的罪</p>
<p>give the audience a grin, 给观众一个开怀的笑</p>
<p>enjoy it - it’s your last chance anyhow.享受它，不管怎么说这是你最后的机会 </p>
<p>so always look on the bright side of death, 所以总是看到好的一面</p>
<p>just before you draw your terminal breath, 就在你最后一次呼吸之前</p>
<p>life’s a piece of shit, 生活是坨屎</p>
<p>when you look at it, 当你看着它的时候</p>
<p>life’s a laugh and death’s a joke, it’s true. 生活是一次大笑，死亡是个玩笑，真的</p>
<p>you’ll see it’s all a show,你会看到这都是一场戏 </p>
<p>keep ‘em laughing as you go. 当你上演时保持是喜剧</p>
<p>just remember that the last laugh is on you.记住要笑到最后 </p>
<p>and always look on the bright side of life, 总是看到好的一面</p>
<p>always look on the right side of life, 看生活好的一面</p>
<p>come on guys, cheer up. 来吧伙伴，庆祝一下</p>
<p>always look on the bright side of life. 总看到好的一面</p>
<p>worse things happen at sea, you know. 世界末日离你还远，知道吗？</p>
<p>always look on the bright side of life. 总是看到好的一面</p>
<p>i mean - what have you got to lose? 我是说——你将会失去什么？</p>
<p>you know, you come from nothing, 你知道，你本来就一无所有</p>
<p>you’re going back to nothing. 你会再回到虚无</p>
<p>what have you lost? nothing 你将会失去什么？什么也没有</p>
</blockquote>
<h2 id="Aal_izz_well">Aal izz well</h2><p>你在做自己不喜欢的事情吗？</p>
<p>你总是担心太多吗？</p>
<p>兰彻导师说：追随自己的心，不断追求卓越，其它的都会追随而来的。</p>
<p>兰彻导师说：我们心很怯懦，需要我们“欺骗”，Aal izz well(一切都好)。</p>
<p>三年前和玩伴在他的mp4上看了一半，只是觉的好笑，如今看着确是完全不同的感觉。</p>
<p>一切都好，一语胜千言。</p>
<h2 id="纵使抛弃一切终归还有执着">纵使抛弃一切终归还有执着</h2><p>“人人都愿意相信自已愿意相信的东西。”</p>
<p>不断想起大一在图书馆的日日夜夜</p>
<p>翻看那些心理学、社会科学的书籍，</p>
<p>甚至很多成功学的书(我现在依然非常喜欢卡耐基的书)。</p>
<p>里头很多观点、看法、假说，深深植入我的心里。</p>
<p>我会怀念，整个学校我最喜欢的地方。</p>
<p>怀念那里的光影，味道，声音。</p>
<p>还有无法忘怀的记忆。</p>
<p>有些执着我永远不愿放弃，</p>
<p>不过是想让自己的心冷静下来，</p>
<p>该来的终将到来。</p>
<p>有意思的喜剧。</p>
<h2 id="Footnotes">Footnotes</h2><p>[^1]:<del>真尼玛扯淡，几次跑步回去就觉的嗓子疼，然后他妈的就生病来着。我他妈的每次保持一个月一晚一小时的习惯都被一场接一场莫名奇妙的感冒什么的给毁了。我还记得冬天跑步手被冻伤过，还记得从没什么人到天气转暖到处是人的操场，然而现实的冷水泼的比谁都厉害。</del></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/life/2012/09/20/" itemprop="url">
                  创新项目要结束了
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2012-09-20T00:00:00+08:00" content="2012-09-20">
              2012-09-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/life/2012/09/20/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="life/2012/09/20//" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="序">序</h2><p>最近室友在忙着写简历找工作(其实也没忙着，该dota还dota，该看电视剧的还是电视剧，总之貌似很闲，难道我大江大……)，我想很久怎么写自己简历了，可是愈发感觉自己碌碌无为，啥也不会。也从各路大牛网站看过好几份Resume或者CV来着，更加感到自己弱爆了，真应了fengya90之前说的，出去就是被秒的份。今天还看了同学的浙大同级同学简历，算了，我真是弱爆了。</p>
<p>大概大多数人看来，我就是混了三年，保研什么都扯淡了，成绩垃圾得一塌糊，学术完全无力，工作兼职更是扯淡，也没担过当啥重任。不管从哪里看，大概都是彻头彻尾的loser。</p>
<p>但不说了，目测创新项目要结题了。</p>
<h2 id="创新项目之大坑">创新项目之大坑</h2><p>大学生创新项目逐渐变成了一个大坑……，如何从一个国家级项目沦落到校级项目又如何立项之后导师也被换了就不细说了。话说新导师不错啊，可是他中途接手别人的项目也很蛋疼……</p>
<p>总之，五个人开始填这个大坑。嘛，这dota[^1]阵容，我怎么评价么。</p>
<p>总之，我就是苦逼的技术支持。一出问题就被召唤……</p>
<p>开始技术支持的时候我刚接触linux不久<a href="其实也两三个月了，大概我换archlinux单系统那段时间吧">^2</a>，实际上想做另一个偏计算机的项目，不过无所谓了，于是开始了这个NdFeB磁特性的项目。</p>
<p>本来我没什么热情的，但竟然是在理学院数学实验室机房，做计算。关键是几台linux机器，嘛，真棒。我以前只在我的计算机上和化工学院研究生实验室看到过，没想到自己做的项目和linux有关。虽然是学校的机器上都是古老而难懂的RHEL5。<a href="我是相对与arch说的新旧……莫喷。">^3</a></p>
<p>竟然还有幸使用学院十八万一年购入的NB软件——<a href="http://www.quantumwise.com/" target="_blank" rel="external">Atomistix ToolKit (ATK)</a>,顺便说下使用了一年，我只想说真尼玛感觉没开源软件好用，不过技术支持不错。</p>
<p>紧接着，我们就发现这多大一个坑了：</p>
<ul>
<li>学长对计算机及软件一知半解，多靠学长的学长或学姐(没见到过)留下的笔记和口口相传来进行计算。但他们理论比我们好多了，帮助我们解决了一些问题。但还是有很多坑……</li>
<li>老师中途接手项目，完全不熟悉这个软件，也不很熟悉这个项目</li>
<li>我们接着换导师前的导师的研究生的项目继续往下做，直接使用前辈建好的模型再根据自己需要修改。可是这个模型太大了，几百个原子……计算机吃不消，经常内存都不够，有次半个月没算出来。</li>
<li>一堆参数不知道怎么设定，发现前辈留下的log都是各种不收敛……</li>
<li>有买来的atk的REHL那台机器上的atk/vnl经常出错，学院一堆机器经常有些莫名奇妙的问题</li>
<li>有atk那台的机器卡爆了……</li>
<li>各种因为不了解软件及原理本身的而造成的错误</li>
<li>各种手误，还有不良的管理习惯，比如说新建的那一堆文件夹，结果我现在都不知道各个文件夹都放的什么东西了。</li>
<li>软件自身问题，比如算法bug</li>
</ul>
<h2 id="但我学到了很多">但我学到了很多</h2><p>不像有的导师直接帮学生都发好文章了，我组的同学，特别那些要出国要考研要论文的同志们就苦逼了……</p>
<p>像我这种苦逼考研党倒不在乎，可是作为技术支持永远也别想闲下来不管……</p>
<p>我们的项目在各种坑中颠簸了一年现在还没出论文，从老师开始口口声声的发国外到先发JNU学报上，到某写论文的出国党主力dps差点放弃不搞。</p>
<p>现在快结束了，跳过一个软件算法bug，希望明天算出来有个好结果。</p>
<p>一年，我还是学到了很多哦，收获不浅。</p>
<p>我学到的很多也用上了，这真让我惊奇，<strong>我从来没想过自己在折腾中学到的很多东西，竟然真的用上了。</strong></p>
<ul>
<li>将学院几台linux机器几乎和自己机器集成起来了。</li>
<li>配置好ssh和vnc，在寝室我可以通过ssh，vnc很方便的查看计算进度，结果，和其它任何操作。</li>
<li>利用dolphin的fish特性可视化ssh，这玩意太好用了。远端就像本地一样。</li>
<li>打开了vnc服务教他们怎么用浏览器使用远程桌面，可是windows用户还是更习惯去实验室用windows……</li>
<li>建立了ftp服务方便几台机器的文件共享。</li>
<li>熟悉了怎么在linux下编译软件，怎么使用软件<a href="当然第一件是看文档看教程了，然后才是google搜索(baidu弱爆了)">^4</a>。编译配置mpich尝试集群并行计算，最后发现专有软件真尼玛坑，要集群还要付钱……</li>
<li>在自己机器archlinux上装上了atk/vnl……然后半个月不到尼玛就过期不让用了……</li>
<li>熟悉了vim各种高效操作，改各种文件改的真欢，连vimdiff都用上了……</li>
<li>脚本化计算，让计算能够排队……</li>
<li>完全习惯用终端或者从其它linux或windows机器上ssh上去用cli操作，因为内存被atk吃空的那台机器卡爆了</li>
<li>最后因为atk/vnl什么莫名奇妙不能可视化图形的毛病，发现atkpython中已经集成了matplotlib和numpy，自己手动可视化。不过windows用户还是更习惯用Origin……</li>
<li>正好学了点python，然后竟然在一些关键问题上比如win和linux在python中路径，序列切片的问题用上了。</li>
<li>很多问题简直凭借常年在linux系统下的经验和直觉解决的。</li>
<li>忽然想到有次帮别人制作presentation的图连gimp都用上了。不过当时对gimp比较熟悉，完全无压力。</li>
</ul>
<h2 id="创新项目对我的影响">创新项目对我的影响</h2><p>我想说，我没有打酱油，这就很满意了。事实上要是像有的同学创新项目一样都没做什么老师都帮忙发论文什么的我反而感觉可惜了，也很庆幸竟然做了这么个大坑项目。</p>
<p>我还想说，我努力不让别人失望，希望我做到了。</p>
<p>因为<a href="http://www.quantumwise.com/" target="_blank" rel="external">Atomistix ToolKit (ATK)</a>这个大坑，还有其它一些莫名奇妙的原因我变成pythoner了，而且将来想用python作为工具从事数据挖掘和机器学习的工作。</p>
<p>更加熟悉了linux系统，竟然还把某台上的REHL偷天换日更新成CentOS了，vim和各种终端操作更加熟练。</p>
<p>ssh/vnc配置使用自不必说。</p>
<p><a href="http://www.quantumwise.com/" target="_blank" rel="external">Atomistix ToolKit (ATK)</a>基于某python的DFT(密度泛函理论)实现反过来促进了我对物理的兴趣，我本身是学物理的嘛，不过貌似被大学教育把兴趣几乎抹杀了。</p>
<p>还有其它一些关于团队和做事的思考，不写。</p>
<hr>
<h2 id="一些纪念截图">一些纪念截图</h2><p>在archlinux装的atk/vnl</p>
<p><img src="http://fmn.rrimg.com/fmn065/20120306/1650/p_large_kKj5_1476000000551260.jpg" alt="在archlinux装的atk/vnl"></p>
<p>经常内存就这么满了</p>
<p><img src="http://fmn.rrfmn.com/fmn058/20120625/1850/p_large_l0Vh_0cab00011abb1261.jpg" alt="经常内存就这么满了"></p>
<p>我用python画出来的自旋平行态密度,和下图一样因算法问题算得根本就不对……</p>
<p><img src="http://fmn.rrimg.com/fmn057/20120919/2245/p_large_C5Mt_608a00001d3b1262.jpg" alt="我用python画出来的自旋平行态密度"></p>
<p>我用python画出来的自旋反平行态密度</p>
<p><img src="http://fmn.rrimg.com/fmn056/20120919/2245/p_large_b12B_608a00001d3c1262.jpg" alt="我用python画出来的自旋反平行态密度"></p>
<p>我们的模型,我用gimp处理的，还有个彩版的。</p>
<p><img src="http://fmn.rrimg.com/fmn061/20120921/0725/p_large_BcP2_109300000ba71262.jpg" alt="模型"></p>
<h2 id="鸣谢">鸣谢</h2><p>感谢指导老师的支持，各位组员的共同努力，特别感谢某出国党的坚持，希望明天有个不错的结果，最后写论文什么就没我什么事了<a href="要是用latex或者markdown写我会不会抢着写……">^5</a>。</p>
<hr>
<p>2012年09月21日 星期五 18时23分32秒</p>
<p>还好，大家争取两天把论文写完。</p>
<hr>
<h2 id="FootNotes">FootNotes</h2><p>[^1]:I hate Dota</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Liu Yuyang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Liu Yuyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">我希望生活是诗的，是画的，是无数动听的音符。我希望我是自由的，摇滚的，有一颗黑客的心。</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">173</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/reverland" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://reverland.bitbucket.org/" target="_blank">曾经的的vimwiki</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://liutos.github.com/" target="_blank">Liutos</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.phoenixlzx.com/" target="_blank">凤凰君</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gndrive.org/" target="_blank">高达数字实验室</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cherrot.com/" target="_blank">Cherrot</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://xwyam.github.com/" target="_blank">xw_y_am</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ishell.me" target="_blank">小东</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.kochiya.me/" target="_blank">AS酱</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.skydark.info/" target="_blank">skydark</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://thorb.cn/" target="_blank">thorb</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.suzibin.cn/" target="_blank">doug</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://armsword.com/" target="_blank">armsword</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://zhangwenli.com/blog" target="_blank">Ovilia</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://lilydjwg.is-programmer.com/" target="_blank">仙子</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://gaohaoyang.github.io" target="_blank">HYG</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://simmer-jun.github.io" target="_blank">Simmer</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Yuyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'reverlandblog';
      var disqus_identifier = 'page/12/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
