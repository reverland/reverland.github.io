<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hacking: The Art of Exploitation | Reverland的行知阁</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="books,c," />
  

  <meta name="description" content="This book’s C part is very fascinating. Along with the author, you can actually achieve a set of note take and search tools for multiuser, and an interesting game. What’s more, some linux/unix knowled">
<meta property="og:type" content="article">
<meta property="og:title" content="Hacking: The Art of Exploitation">
<meta property="og:url" content="http://reverland.org/reviews/2013/06/09/hacking-the-art-of-exploitation/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="This book’s C part is very fascinating. Along with the author, you can actually achieve a set of note take and search tools for multiuser, and an interesting game. What’s more, some linux/unix knowled">
<meta property="og:updated_time" content="2015-11-15T06:01:31.503Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hacking: The Art of Exploitation">
<meta name="twitter:description" content="This book’s C part is very fascinating. Along with the author, you can actually achieve a set of note take and search tools for multiuser, and an interesting game. What’s more, some linux/unix knowled">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link rel="stylesheet" href="/css/styles.css" type="text/css">

  

  

  

</head>

<body>
  <div class="post-header CENTER">
   
  <div class="toolbox">
    <div class="toolbox-entry">盒子</div>
    <ul class="list-toolbox">
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/archives/">博客</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/category/">分类</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/tag/">标签</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/link/">友链</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/about/">关于</a>
          </li>
        
      
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/atom.xml">RSS</a>
          </li>
        
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Experiment_Notes_on_A_64-bit_Machine"><span class="toc-text">Experiment Notes on A 64-bit Machine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Format_for_Pointer"><span class="toc-text">Format for Pointer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile_32-bit_Programs_on_a_x86_64_Machine"><span class="toc-text">Compile 32-bit Programs on a x86_64 Machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Built-in_Functions_in_Gcc"><span class="toc-text">Built-in Functions in Gcc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable_SSP"><span class="toc-text">Disable SSP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable_Executable_Space_Protection"><span class="toc-text">Disable Executable Space Protection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable_ASLR"><span class="toc-text">Disable ASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The_virtual_Memory"><span class="toc-text">The virtual Memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#About_dtors_section"><span class="toc-text">About dtors section</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libnet-1-0_on_amd64"><span class="toc-text">libnet-1.0 on amd64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable_IP_Forward"><span class="toc-text">Enable IP Forward</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#drop_previledge"><span class="toc-text">drop previledge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some_other_things"><span class="toc-text">Some other things</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Some_Other_Thoughts_on_This_Book"><span class="toc-text">Some Other Thoughts on This Book</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hacker’s_Tools"><span class="toc-text">Hacker’s Tools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Some_References"><span class="toc-text">Some References</span></a></li></ol>
  </div>


<div class="content-post CENTER">
   <article id="post-hacking-the-art-of-exploitation" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Hacking: The Art of Exploitation</h1>

    <div class="article-meta">
      <span>2013-06-09</span>

      <span> | </span>

      <span class="article-author">Liu Yuyang</span>

      <span> | </span>

      
  <span class="article-category">
    <a class="article-category-link" href="/categories/reviews/">reviews</a>
  </span>


    </div>
  </header>

  <div class="article-content">
    
      <p>This book’s C part is very fascinating. Along with the author, you can actually achieve a set of note take and search tools for multiuser, and an interesting game. What’s more, some linux/unix knowledge will be learned.</p>
<p>So I tried it.</p>
<p>To try these interesting things written in five years ago is not easy on my x86_64 gentoo linux. There are tons of difference and I’m always confused by what I don’t know. However, I was so happy with such interesting things after so much pains.</p>
<p>This book makes C fascinating to me! I’m so desired to be a C hacker!</p>
<p>Thanks to the author–Jon Erickson! Even too simple and fundamental, the book open the door to a interesting world for me.</p>
<hr>
<p><strong>TOC</strong></p>
<ul>
<li>toc<br>{: toc}</li>
</ul>
<hr>
<h2 id="Experiment_Notes_on_A_64-bit_Machine">Experiment Notes on A 64-bit Machine</h2><h3 id="Format_for_Pointer">Format for Pointer</h3><p>pointer/address to be <code>%p</code> not <code>0x%08x</code>.</p>
<h3 id="Compile_32-bit_Programs_on_a_x86_64_Machine">Compile 32-bit Programs on a x86_64 Machine</h3><p>By default, gentoo linux amd64 will set <code>multilib</code> USE flag. You’ll have a multilib glibc and gcc. Then to compile and link a program with gcc, just add <code>-m32</code> parameter to gcc.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 test.c</span><br></pre></td></tr></table></figure>
<h3 id="Built-in_Functions_in_Gcc">Built-in Functions in Gcc</h3><p>gcc actually have some functions built into it. It will use its built in version for some functions like <code>printf</code>. Even if you forget include header files, it will be compiled but give out a warning.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/Work/project/hack ⮀ gcc -g -m32 -o firstprog firstprog.c</span><br><span class="line">firstprog.c: In <span class="keyword">function</span> ‘main’:</span><br><span class="line">firstprog.c:<span class="number">7</span>:<span class="number">5</span>: warning: incompatible implicit declaration of built-in <span class="keyword">function</span> ‘<span class="built_in">printf</span>’ [enabled by default]</span><br></pre></td></tr></table></figure>
<h3 id="Disable_SSP">Disable SSP</h3><p>To test hacking skills like stack overflow and so on on a modern x86_64 machine. You have to cheat.To disable the stack smashing prevention(SSP) by gcc, you can simply specify a parameter <code>-fno-stack-protector</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector test.c</span><br></pre></td></tr></table></figure>
<h3 id="Disable_Executable_Space_Protection">Disable Executable Space Protection</h3><p>To let the stack be executable, you have two choices:</p>
<ol>
<li>add <code>-z execstack</code> parameter to gcc when compiling.</li>
<li>Using <code>execstack</code> to set executable stack flag of ELF binaries and shared libraries</li>
</ol>
<p>Both will work, It depend on you which to choose.</p>
<h3 id="Disable_ASLR">Disable ASLR</h3><p>If you check the book carefully later, you’ll find some technics to prevent exploitation. One of them is ASLR.</p>
<p>To disable (Address space layout randomization)ASLR globally:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure>
<p>Or just run the binary file using <code>setarch</code>.</p>
<p>Please refer to the References and <code>man setarch</code>.</p>
<h3 id="The_virtual_Memory">The virtual Memory</h3><p>One of my observation is that if you run a 32-bit program on 64-bit system, the address in the memory will differ a lot from just 32-bit system.</p>
<p>According to my experience, the memory address ranges from about <code>0x804a014</code> to <code>0xffffdff8</code>, <code>.data</code> and <code>.bss</code> will locate at around <code>0x804axxx</code>. But the stack bottom will be at around <code>0xff7fcxxx</code>. What’s important is that environment variables will be at the bottom of memory until <code>0xffffdff8</code>. <code>0xffffdff8</code> will be the <code>filename</code> of the execute file.</p>
<p>There are some other differences from the book. One of these is the length of file change 1, the address of environment variable for shellcode will change 1 byte.</p>
<p>I don’t know why things like this, I’ll try to find more about it and ask it at StackOverflow. But that’s what I get after several tests, your machine may differ.</p>
<h3 id="About_dtors_section">About dtors section</h3><p>I find I can’t success on the exploitation about dtors. The destruction function address will be in <code>.fini_array</code> section. Note: objdump will show addresses in little endian. So address <code>0x08048473</code> will looks like that:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .fini_array:</span><br><span class="line"> <span class="number">8049</span>ef8 <span class="number">73840408</span>                             s...</span><br></pre></td></tr></table></figure>
<p>Furthermore, because of cpu’s NX feature, when you try to modify <code>.dtors</code> or <code>fini_array</code> section, you’ll just get a segfault.</p>
<h3 id="libnet-1-0_on_amd64">libnet-1.0 on amd64</h3><p>Last thing I have to mentioned is that libnet-1.0 use too much <code>u_long</code>. <code>u_long</code> will take 8 bytes on a 64-bit machine but 4 bytes on a 32-bit one.</p>
<p>You have to care about that because it will build tcp header with incorrect length of source address and destination address.</p>
<p>I don’t know how nemesis(which depends on libnet-1.0) works well on amd64 machines…</p>
<p>To compile and link with libnet-1.0 on gentoo amd64 architecture, try something like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc `libnet-<span class="number">1.0</span>-config --defines` -o rst_hijack rst_hijack.c -lnet-<span class="number">1.0</span> -lpcap</span><br></pre></td></tr></table></figure>
<h3 id="Enable_IP_Forward">Enable IP Forward</h3><p>When you want to try arp sproofing or arp poisoning, enable the ip forward for the kernel:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="number">1</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<h3 id="drop_previledge">drop previledge</h3><p>bash version 2 will drop previlege when run with setuid. So lots of root shell will falls to normal user without <code>setresuid</code>.</p>
<h3 id="Some_other_things">Some other things</h3><p>Examine by <code>man</code> before you try the program in this book. </p>
<p>For example, in <code>update_info</code>, add <code>(void *)</code> in to avoid warning. In <code>connectback_shell.s</code> the <code>connect</code> syscall won’t save file descriptor in eax. Lots of <code>include</code> was lost in this book…</p>
<h2 id="Some_Other_Thoughts_on_This_Book">Some Other Thoughts on This Book</h2><p>Amazing！！When You first get a root shell in an exploitation, you can’t stop jumping out of the chair! The book is simple and introductory, but both interesting and insight. I really like it.</p>
<h2 id="Hacker’s_Tools">Hacker’s Tools</h2><blockquote>
<p>Man is most important, Google is the second.</p>
<p>Prof. Li Yinong</p>
</blockquote>
<p>Consult to <code>man</code> if you are stuck, then search in google(NOT BAIDU).</p>
<ul>
<li>gcc to compile</li>
<li>gdb to debug/attach, use as calculation and so on.</li>
<li>objdump to be used as a disassembler to view executable in assembly form</li>
<li>nm to list symbols in many kinds of files</li>
<li>perl for one line exploitation</li>
<li>python for one line exploitation</li>
<li>hexdump to dump binary files into hex</li>
<li>shell to facilitate with exploitation.</li>
<li>many unix tools like od/sed/awk/bc and so on may be useful.</li>
</ul>
<p>About net hack, You may like to use:</p>
<ul>
<li>libnet to inject packets</li>
<li>libpcap to capture packets</li>
<li>tcpdump to capture and show packets</li>
<li>dsniff to sniff the net and arp poison</li>
<li>netcat, wow, swiss knife</li>
<li>telnet, a good client to use</li>
<li>ettercap/nessus/metasploit and so on.</li>
</ul>
<h2 id="Some_References">Some References</h2><p>About exploitation:</p>
<ul>
<li><a href="https://crypto.stanford.edu/~blynn/rop/" target="_blank" rel="external">Return-oriented programming on 64-bit Linux</a></li>
<li><a href="http://www.exploit-db.com/papers/24085/" target="_blank" rel="external">Stack Smashing On A Modern Linux System</a></li>
<li><a href="http://www.tenouk.com/Bufferoverflowc/" target="_blank" rel="external">The Stack-based Buffer Overflow Hands-on Tutorials</a></li>
<li><a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory" target="_blank" rel="external">Anatomy of a Program in Memory</a></li>
<li><a href="http://www.tenouk.com/ModuleW.html" target="_blank" rel="external">COMPILER, ASSEMBLER, LINKER AND LOADER: A BRIEF STORY</a></li>
<li><a href="http://security.stackexchange.com/questions/20497/stack-overflows-defeating-canaries-aslr-dep-nx" target="_blank" rel="external">Discuss on stack exchange</a></li>
<li><a href="https://www.cs.umd.edu/class/fall2012/cmsc498L/materials/vuln-lab.shtml" target="_blank" rel="external">Shellcode/buffer overflow lab</a></li>
<li><a href="http://www.csee.umbc.edu/~chang/cs313.s02/stack.shtml" target="_blank" rel="external">C Function Call Conventions and the Stack</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-overflow/" target="_blank" rel="external">Linux下缓冲区溢出攻击的原理及对策(中文)</a></li>
</ul>
<p>About packet capture and injection:</p>
<ul>
<li><a href="http://networksecurity.org.ua/0596007949/toc.html" target="_blank" rel="external">Network Security Tools(chapter 10 and 11 are about libnet/libpcap)</a></li>
<li><a href="http://www.tcpdump.org/pcap.html" target="_blank" rel="external">Programming with pcap</a></li>
<li><a href="http://yuba.stanford.edu/~casado/pcap/section1.html" target="_blank" rel="external">The Sniffer’s Guide to Raw Traffic</a></li>
</ul>
<p>About arpspoofing:</p>
<ul>
<li><a href="http://www.irongeek.com/i.php?page=security/arpspoof" target="_blank" rel="external">The Basics of Arpspoofing/Arppoisoning</a></li>
</ul>
<p>About shellcode</p>
<ul>
<li><a href="http://www.vividmachines.com/shellcode/shellcode.html" target="_blank" rel="external">Shellcoding for Linux and Windows Tutorial</a></li>
</ul>

    
  </div>
</article>



<section class="disqus-comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>




</div>

  
<script>
  var disqus_shortname = 'reverlandblog';
  
  var disqus_url = 'http://reverland.org/reviews/2013/06/09/hacking-the-art-of-exploitation/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"undefined"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0]
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- 多说公共JS代码 end -->

</body>
</html>
